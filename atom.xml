<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[å®‰è·¯çš„æŠ€æœ¯åšå®¢]]></title>
  <link href="http://andrew-anlu.github.io/atom.xml" rel="self"/>
  <link href="http://andrew-anlu.github.io/"/>
  <updated>2016-04-22T21:06:14+08:00</updated>
  <id>http://andrew-anlu.github.io/</id>
  <author>
    <name><![CDATA[å®‰è·¯]]></name>
    <email><![CDATA[andrewswift1987@gamil.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[OHHTTPStubsä»‹ç»]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/22/ohhttpstubsjie-shao/"/>
    <updated>2016-04-22T17:18:29+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/22/ohhttpstubsjie-shao</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/AliSoftware/OHHTTPStubs">OHHTTPStubs</a>æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚çš„ä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿å’Œå¼ºå¤§ï¼Œå®ƒèƒ½å¸®ä½ </p>

<ol>
<li>æµ‹è¯•ä½ çš„appä»¿çœŸä¸€ä¸ªæœåŠ¡å™¨ï¼ˆæ¯”å¦‚åŠ è½½ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ï¼‰,æ¨¡æ‹Ÿç½‘ç»œæ…¢çš„æƒ…å†µç­‰</li>
<li>ä½¿ç”¨ä¼ªé€ çš„ç½‘ç»œæ•°æ®ç¼–å†™å•å…ƒæµ‹è¯•</li>
</ol>


<!--more-->


<h2>ç®€å•ç”¨æ³•</h2>

<h2>åœ¨Objcä¸­</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest *request) {
</span><span class='line'>  return [request.URL.host isEqualToString:@"mywebservice.com"];
</span><span class='line'>} withStubResponse:^OHHTTPStubsResponse*(NSURLRequest *request) {
</span><span class='line'>  // Stub it with our "wsresponse.json" stub file (which is in same bundle as self)
</span><span class='line'>  NSString* fixture = OHPathForFile(@"wsresponse.json", self.class);
</span><span class='line'>  return [OHHTTPStubsResponse responseWithFileAtPath:fixture
</span><span class='line'>            statusCode:200 headers:@{@"Content-Type":@"application/json"}];
</span><span class='line'>}];</span></code></pre></td></tr></table></div></figure>


<h2>åœ¨swiftä¸­</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>stub(isHost("mywebservice.com")) { _ in
</span><span class='line'>  // Stub it with our "wsresponse.json" stub file (which is in same bundle as self)
</span><span class='line'>  let stubPath = OHPathForFile("wsresponse.json", self.dynamicType)
</span><span class='line'>  return fixture(stubPath!, headers: ["Content-Type":"application/json"])
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>è¯­æ³•è®²è§£</h2>

<p><code>OHHTTPStubs stubRequestsPassingTest:</code>æ–¹æ³•åˆ›å»ºäº†æ¨¡æ‹ŸæœåŠ¡å™¨ï¼Œ<code>request</code>æ˜¯è¯·æ±‚çš„æ ‡å‡†åˆ¤æ–­ï¼Œæ¯”å¦‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[request.URL.host isEqualToString:@"mywebservice.com"]</span></code></pre></td></tr></table></div></figure>


<p>æ„æ€å°±æ˜¯å¦‚æœè¯·æ±‚çš„urlæ˜¯<code>mywebservice.com</code>ï¼Œæˆ‘ä»¬å°±è¿”å›response,è¦ä¸ç„¶ä¸æ‰§è¡Œ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> NSString* fixture = OHPathForFile(@"wsresponse.json", self.class);
</span><span class='line'>  return [OHHTTPStubsResponse responseWithFileAtPath:fixture
</span><span class='line'>            statusCode:200 headers:@{@"Content-Type":@"application/json"}];</span></code></pre></td></tr></table></div></figure>


<p>è¿”å›ä¸€ä¸ªrespoinse,å…¶ä¸­åŒ…å«äº†è¿”å›çš„æ•°æ®ï¼Œ</p>

<ol>
<li>è·å–çš„ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶</li>
<li>è¿”å›çš„çŠ¶æ€ç  200  (200è¡¨ç¤ºæ­£ç¡®è¿”å›)</li>
<li>headersï¼šè¿”å›çš„å¤´,å¦‚æœæ˜¯jsonä¸€èˆ¬æ˜¯:@{@&ldquo;Content-Type&rdquo;:@&ldquo;application/json&rdquo;}</li>
</ol>


<h1>å¿«é€Ÿå¼€å§‹ä¸€ä¸ªDemo</h1>

<h2>åˆ›å»ºä¸€ä¸ªç©ºå·¥ç¨‹</h2>

<p>ç”¨xcodeåˆ›å»ºä¸€ä¸ªå·¥ç¨‹ï¼Œç”¨podsåˆ›å»ºä¸€ä¸ªPodfile</p>

<p>å†…å®¹å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pod 'OHHTTPStubs', '~&gt; 5.0.0'
</span><span class='line'>
</span><span class='line'>target :OHHTTPStubsDemoTests, :exclusive =&gt; true do
</span><span class='line'>    link_with 'OHHTTPStubsDemoTests'
</span><span class='line'>    
</span><span class='line'>    pod 'OHHTTPStubs'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>æ‰§è¡Œ <code>pod install</code></p>

<p>æˆåŠŸå®‰è£…OHHTTPStubsåï¼Œåœ¨OHHTTPStubsDemoTestsç›®å½•ä¸­ç¼–å†™æµ‹è¯•ç±»:</p>

<h3>åˆ›å»ºsession</h3>

<p>åœ¨é¡¶éƒ¨å£°æ˜ä¸€ä¸ªå˜é‡session</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@property (nonatomic,strong) NSURLSession *session;</span></code></pre></td></tr></table></div></figure>


<p>åœ¨setUpæ–¹æ³•ä¸­ï¼Œåˆ›å»ºè¯¥å˜é‡å®ä¾‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>self.session=[NSURLSession sharedSession];</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ testExample()æ–¹æ³•ä¸­ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> *  è¿”å›è‡ªå®šä¹‰çš„æ™®é€šæ–‡æœ¬
</span><span class='line'> */
</span><span class='line'>- (void)testExample {
</span><span class='line'>    
</span><span class='line'>    //å¼€å§‹æ¨¡æ‹ŸæœåŠ¡å™¨
</span><span class='line'>    [OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest * _Nonnull request) {
</span><span class='line'>        //å‘é€è¯·æ±‚çš„urlåç¼€å¿…é¡»æ˜¯.comç»“å°¾çš„
</span><span class='line'>        return [request.URL.pathExtension isEqualToString:@"com"];
</span><span class='line'>    } withStubResponse:^OHHTTPStubsResponse * _Nonnull(NSURLRequest * _Nonnull request) {
</span><span class='line'>        //åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²
</span><span class='line'>        NSData * stubData = [@"hello world" dataUsingEncoding:NSUTF8StringEncoding];
</span><span class='line'>        //å“åº”æ•°æ®
</span><span class='line'>        /**
</span><span class='line'>         *  responseWithData:è¿”å›çš„æ•°æ®
</span><span class='line'>            statusCode:çŠ¶æ€ç ,200è¡¨ç¤ºæˆåŠŸ
</span><span class='line'>            headers:httpçš„header
</span><span class='line'>         */
</span><span class='line'>        return [OHHTTPStubsResponse responseWithData:stubData statusCode:200 headers:@{@"Content-Type":@"text/plain"}];
</span><span class='line'>    }];
</span><span class='line'>    
</span><span class='line'>    
</span><span class='line'>    //åœ¨XCTæµ‹è¯•æ¡†æ¶ä¸­ï¼Œè¿™ä¸ªè¡¨ç¤ºæœŸæœ›å€¼ï¼Œå› ä¸ºè¿™ä¸ªæœŸæœ›å€¼æ˜¯æ”¯æŒå¼‚æ­¥æµ‹è¯•çš„ï¼Œæˆ‘ä»¬æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæ‰€ä»¥ä¸€å®šè¦æ˜¯ä½¿ç”¨XCTestExpectationè¿™ä¸ªç‰¹æ€§
</span><span class='line'>     XCTestExpectation *expectation=[self expectationWithDescription:@"sessionDataTask expectation"];
</span><span class='line'>    
</span><span class='line'>    //åˆ›å»ºsessionä»»åŠ¡
</span><span class='line'>    NSURLSessionDataTask *dataTask=[self.session dataTaskWithURL:[NSURL URLWithString:@"hello.com"] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
</span><span class='line'>        
</span><span class='line'>        //è§£æè¿”å›çš„å­—ç¬¦ä¸²
</span><span class='line'>        NSString *resultStr=[[NSString alloc]initWithData:data encoding:NSUTF8StringEncoding];
</span><span class='line'>        
</span><span class='line'>        NSLog(@"è¿”å›çš„æ•°æ®:%@",resultStr);
</span><span class='line'>        
</span><span class='line'>        XCTAssert(resultStr!=nil);
</span><span class='line'>        
</span><span class='line'>        //æ–­è¨€è¿”å›çš„å­—ç¬¦ä¸²æ˜¯hello world,å¦‚æœä¸æ˜¯ï¼Œåˆ™æ–­è¨€å¤±è´¥
</span><span class='line'>        XCTAssertTrue([resultStr isEqualToString:@"hello world"]);
</span><span class='line'>        
</span><span class='line'>        //åœ¨æƒ³å¼‚æ­¥æµ‹è¯•çš„åœ°æ–¹åŠ ä¸Šä¸‹é¢è¿™è¡Œä»£ç 
</span><span class='line'>        [expectation fulfill];
</span><span class='line'>    }];
</span><span class='line'>    //å¯åŠ¨ä»»åŠ¡
</span><span class='line'>    [dataTask resume];
</span><span class='line'>    
</span><span class='line'>    
</span><span class='line'>    //ä½¿ç”¨XCTestExpectation,å¿…é¡»è®¾ç½®å¦‚ä¸‹çš„waitForExpectationsWithTimeoutæ–¹æ³•ï¼Œå¦‚æœè¶…æ—¶åˆ™å¤±è´¥
</span><span class='line'>    [self waitForExpectationsWithTimeout:4 handler:^(NSError * _Nullable error) {
</span><span class='line'>        if(error){
</span><span class='line'>            NSLog(@"å‡ºé”™äº†:%s",__FUNCTION__);
</span><span class='line'>        }
</span><span class='line'>    }];
</span><span class='line'>   
</span><span class='line'>    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œé¢ä½¿ç”¨åˆ°äº† <code>XCTestExpectation</code>ï¼Œè¿™æ˜¯ç‰¹æ€§æ˜¯ç”¨æ¥æµ‹è¯•å¼‚æ­¥ç¨‹åºä»£ç çš„ã€‚åœ¨æƒ³æµ‹è¯•å¼‚æ­¥ä»£ç çš„åœ°æ–¹åŠ ä¸Š<code>[expectation fulfill];</code>,
æœ€åï¼Œè¦åŠ ä¸Š<code>waitForExpectationsWithTimeout</code>æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯é…å¯¹å‡ºç°çš„ã€‚</p>

<p>OHHTTPStubsåˆ›å»ºäº†æ¨¡æ‹ŸæœåŠ¡å™¨åï¼Œä¸‹é¢å‘çš„ä»»ä½•ç½‘ç»œè¯·æ±‚éƒ½ä¼šè¢«æ¨¡æ‹ŸæœåŠ¡å™¨è¿”å›ï¼Œæ­£å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œæµ‹è¯•ç»“æœ:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160422-3.png" alt="test" />
æ–­è¨€æˆåŠŸï¼</p>

<h2>æ·»åŠ æœ¬åœ°æ–‡ä»¶</h2>

<ol>
<li>åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªstub.txtçš„æ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹è‡ªå®š</li>
<li>åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªstub.jpgçš„å›¾ç‰‡ï¼Œå›¾ç‰‡è‡ªå®š</li>
</ol>


<p>å›¾ç‰‡
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160422-5.png" alt="1" /></p>

<p>æ–‡æœ¬
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160422-4.png" alt="2" /></p>

<h3>åˆ›å»ºæ–‡æœ¬çš„TextStub</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> *  åˆ›å»ºæ–‡æœ¬çš„TextStub
</span><span class='line'> */
</span><span class='line'>-(void)createTextStub{
</span><span class='line'>    // #1
</span><span class='line'>    static id&lt;OHHTTPStubsDescriptor&gt; textStub = nil;
</span><span class='line'>    
</span><span class='line'>    // #2
</span><span class='line'>    textStub= [OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest * _Nonnull request) {
</span><span class='line'>        return [request.URL.pathExtension isEqualToString:@"txt"];
</span><span class='line'>    } withStubResponse:^OHHTTPStubsResponse * _Nonnull(NSURLRequest * _Nonnull request) {
</span><span class='line'>        
</span><span class='line'>        NSString *path = OHPathForFile(@"stub.txt",self.class);
</span><span class='line'>        
</span><span class='line'>       //#3
</span><span class='line'>        return [[OHHTTPStubsResponse responseWithFileAtPath:path
</span><span class='line'>                                                 statusCode:200 headers:@{@"Content-Type":@"text/plain"}]
</span><span class='line'>                requestTime:1.0f
</span><span class='line'>                responseTime:OHHTTPStubsDownloadSpeedWifi];
</span><span class='line'>        
</span><span class='line'>    }];
</span><span class='line'>    //#4
</span><span class='line'>    textStub.name = @"text stub";
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢ä»£ç æ„ä¹‰å¦‚ä¸‹:</p>

<ol>
<li>å£°æ˜ä¸€ä¸ªè¿”å›çš„OHHTTPStubsDescriptor,è¿™æ˜¯åˆ›å»ºæ¨¡æ‹ŸæœåŠ¡å™¨çš„è¿”å›ç»“æœæè¿°</li>
<li>å¼€å§‹åˆ›å»ºæ¨¡æ‹ŸæœåŠ¡å™¨</li>
<li>è¿”å›responseï¼Œå…¶ä¸­è®¾ç½®äº†è¿”å›æ•°æ®ï¼ŒçŠ¶æ€ç ï¼Œè¯·æ±‚æ—¶é—´ç­‰</li>
<li>ç»™textStubèµ·ä¸ªåå­—</li>
</ol>


<h2>æµ‹è¯•æ–‡æœ¬çš„æ¨¡æ‹ŸæœåŠ¡å™¨</h2>

<p>åˆ›å»ºä¸€ä¸ªtestStubTextTaskæ–¹æ³•:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> *  æµ‹è¯•æ–‡æœ¬çš„Stubä»»åŠ¡
</span><span class='line'> */
</span><span class='line'>-(void)testStubTextTask{
</span><span class='line'>    //åˆ›å»ºæ–‡æœ¬çš„æ¨¡æ‹ŸæœåŠ¡å™¨
</span><span class='line'>    [self createTextStub];
</span><span class='line'>    //åˆ›å»ºä¸€ä¸ªæœŸæœ›å€¼
</span><span class='line'>    XCTestExpectation *expection=[self expectationWithDescription:@"high expection"];
</span><span class='line'>    
</span><span class='line'>    NSURLSession *session=[NSURLSession sharedSession];
</span><span class='line'>    
</span><span class='line'>    NSString *urlString=@"stub.txt";
</span><span class='line'>    NSURLSessionDataTask *dataTask = [session dataTaskWithURL:[NSURL URLWithString:urlString] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
</span><span class='line'>        
</span><span class='line'>        NSString* receivedText = [[NSString alloc] initWithData:data encoding:NSASCIIStringEncoding];
</span><span class='line'>        NSLog(@"è¿”å›çš„ç»“æœ:%@",receivedText);
</span><span class='line'>        
</span><span class='line'>        XCTAssert(receivedText!=nil);
</span><span class='line'>        
</span><span class='line'>        [expection fulfill];
</span><span class='line'>    }];
</span><span class='line'>    
</span><span class='line'>    [dataTask resume];
</span><span class='line'>    
</span><span class='line'>    [self waitForExpectationsWithTimeout:5 handler:^(NSError * _Nullable error) {
</span><span class='line'>        if(error){
</span><span class='line'>            NSLog(@"å‡ºé”™äº†:%@",error.description);
</span><span class='line'>        }
</span><span class='line'>    }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>åˆ›å»ºå›¾ç‰‡çš„stub</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> *  åˆ›å»ºImageçš„stub
</span><span class='line'> */
</span><span class='line'>-(void)createImageStub{
</span><span class='line'>    static id&lt;OHHTTPStubsDescriptor&gt; imageStub = nil;
</span><span class='line'>    
</span><span class='line'>    imageStub=[OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest * _Nonnull request) {
</span><span class='line'>        return [request.URL.pathExtension isEqualToString:@"png"];
</span><span class='line'>    } withStubResponse:^OHHTTPStubsResponse * _Nonnull(NSURLRequest * _Nonnull request) {
</span><span class='line'>        return [OHHTTPStubsResponse responseWithFileAtPath:OHPathForFile(@"stub.jpg", self.class) statusCode:200 headers:@{@"Content-Type":@"image/jpeg"}];
</span><span class='line'>    }];
</span><span class='line'>    
</span><span class='line'>    imageStub.name=@"Image stub";
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>æµ‹è¯•Imageçš„æ¨¡æ‹ŸæœåŠ¡å™¨</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> *  æµ‹è¯•Imageçš„æ¨¡æ‹ŸæœåŠ¡å™¨
</span><span class='line'> */
</span><span class='line'>- (void)testImageStubTask{
</span><span class='line'>    
</span><span class='line'>    [self createImageStub];
</span><span class='line'>    
</span><span class='line'>    XCTestExpectation *expection=[self expectationWithDescription:@"Image Expection"];
</span><span class='line'>    
</span><span class='line'>    NSURLSessionDataTask *dataStask=[self.session dataTaskWithURL:[NSURL URLWithString:@"test.png" relativeToURL:nil] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
</span><span class='line'>        
</span><span class='line'>        UIImage *image=[UIImage imageWithData:data];
</span><span class='line'>        
</span><span class='line'>        NSLog(@"è¿”å›çš„image:%@",image.description);
</span><span class='line'>        
</span><span class='line'>        XCTAssert(image!=nil);
</span><span class='line'>        
</span><span class='line'>        [expection fulfill];
</span><span class='line'>        
</span><span class='line'>    }];
</span><span class='line'>    
</span><span class='line'>    [dataStask resume];
</span><span class='line'>    
</span><span class='line'>    [self waitForExpectationsWithTimeout:3 handler:^(NSError * _Nullable error) {
</span><span class='line'>        if(error){
</span><span class='line'>            NSLog(@"å‡ºé”™äº†:%@",error.description);
</span><span class='line'>        }
</span><span class='line'>    }];
</span><span class='line'>    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>å®Œæ•´å·¥ç¨‹</h2>

<p><a href="https://github.com/TLOpenSpring/OHHTTPStubsDemo/archive/master.zip">å®Œæ•´å·¥ç¨‹åœ¨è¿™é‡Œä¸‹è½½</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Xcodeæ›´æ–°åæ’ä»¶å¤±æ•ˆçš„è§£å†³æ–¹æ¡ˆ]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/22/xcodegeng-xin-hou-cha-jian-shi-xiao-de-jie-jue-fang-an/"/>
    <updated>2016-04-22T16:17:45+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/22/xcodegeng-xin-hou-cha-jian-shi-xiao-de-jie-jue-fang-an</id>
    <content type="html"><![CDATA[<p>Xcodeçš„æ’ä»¶å¯¹äºå¼€å‘è€…æ¥è¯´æ— ç–‘æ˜¯ä¸€æŠŠåˆ©å™¨ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿå°†æ›´å¤šçš„æ—¶é—´å’Œç²¾åŠ›æ”¾åœ¨ä»£ç ä¸Šé¢ã€‚ä½†æ˜¯å¼€å‘è€…éƒ½ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ¯æ¬¡Xcodeæ›´æ–°åˆ°æœ€æ–°çš„ç‰ˆæœ¬ï¼Œä¹‹å‰çš„æ’ä»¶å…¨éƒ¨éƒ½å¤±æ•ˆäº†ï¼Œéœ€è¦é‡æ–°å®‰è£…ä¸€éå¾ˆæ˜¯éº»çƒ¦ã€‚</p>

<!--more-->


<p>æ’ä»¶å¤±æ•ˆçš„åŸå› :</p>

<blockquote><blockquote><ul>
<li>ç³»ç»Ÿå®‰è£…äº†ä¸€ä¸ªXcode</li>
<li>å¼€å‘è€…æœªæ­£ç¡®çš„å°†è‡ªå·±çš„DVTPlugInCompatibilityUUIDæ·»åŠ åˆ°æ’ä»¶ä¸­</li>
<li>æˆåŠŸå®‰è£…äº†æ’ä»¶ï¼Œä½†æ˜¯å´åœ¨Xcodeè¯†åˆ«æ’ä»¶çš„æ—¶å€™ï¼Œé€‰äº† Skip Bundle</li>
</ul>
</blockquote></blockquote>

<h2>ç»ˆç«¯æŒ‡ä»¤å®ç°</h2>

<p>//è·å–DVTPlugInCompatibilityUUIDå­—æ®µ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>defaults read /Applications/Xcode.app/Contents/Info DVTPlugInCompatibilityUUID
</span></code></pre></td></tr></table></div></figure>


<h2>æ‰¾åˆ°æ’ä»¶çš„ç›®å½•</h2>

<ol>
<li>æ‰“å¼€xcodeæ’ä»¶æ‰€åœ¨çš„ç›®å½•:<code>~/Library/Application Support/Developer/Shared/Xcode/Plug-ins</code>,æ‰“å¼€è·¯å¾„çš„å¿«æ·é”®æ˜¯shiftï¼‹commandï¼‹g ç„¶åè¾“å…¥ä¸Šé¢çš„åœ°å€</li>
<li>é€‰æ‹©å·²ç»å®‰è£…çš„æ’ä»¶ï¼Œä¾‹å¦‚:VVDocumenter-Xcodeï¼Œå³é”®æ˜¾ç¤ºåŒ…å†…å®¹</li>
<li>æ‰¾åˆ°info.plistæ–‡ä»¶ï¼Œæ‰¾åˆ°DVTPlugInCompatibilityUUIDsçš„é¡¹ç›®ï¼Œæ·»åŠ ä¸€ä¸ªItem,valueçš„å€¼ä¸ºä¹‹å‰çš„Xcodeçš„UUID,(æˆ–è€…ç›´æ¥åœ¨item0ä¸­valueä¿®æ”¹ä¹Ÿå¯ä»¥)ä¿å­˜</li>
</ol>


<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160422-1.png" alt="step2" /></p>

<h2>é‡å¯xcode</h2>

<p>é‡å¯Xcodeæ—¶ä¼šæç¤ºâ€œLoad bundleâ€ã€ â€œSkip Bundleâ€ï¼Œè¿™é‡Œå¿…é¡»é€‰æ‹©â€œLoad bundleâ€ï¼Œä¸ç„¶æ’ä»¶æ— æ³•ä½¿ç”¨</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160422-0.png" alt="step1" /></p>

<h2>æ•ˆæœå¦‚ä¸‹</h2>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160422-2.png" alt="s" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æµ‹è¯•å¹¶å‘ç¨‹åº]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/21/ce-shi-bing-fa-cheng-xu/"/>
    <updated>2016-04-21T17:38:05+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/21/ce-shi-bing-fa-cheng-xu</id>
    <content type="html"><![CDATA[<p>åœ¨å¼€å‘é«˜è´¨é‡åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œæµ‹è¯•æ—¶ä¸€ä¸ªå¾ˆé‡è¦çš„å·¥å…·ã€‚åœ¨è¿‡å»ï¼Œå½“å¹¶å‘ä¸æ˜¯åº”ç”¨ç¨‹åºæ¶æ„ä¸­é‡è¦ç»„æˆéƒ¨åˆ†çš„æ—¶å€™ï¼Œæµ‹è¯•å°±æƒ³å•ç®€å•ã€‚éšç€è¿™å‡ å¹´çš„å‘å±•ï¼Œä½¿ç”¨å¹¶å‘è®¾è®¡æ¨¡å¼å˜å¾—è¶Šæ¥è¶Šé‡è¦äº†ï¼Œæƒ³è¦æµ‹è¯•å¥½å¹¶å‘åº”ç”¨ç¨‹åºï¼Œå·²æˆäº†ä¸€ä¸ªä¸å°çš„æŒ‘æˆ˜.</p>

<!--more-->


<p>æµ‹è¯•å¹¶å‘ä»£ç æœ€ä¸»è¦çš„å›°éš¾åœ¨äºç¨‹åºæˆ–ä¿¡æ¯æµä¸æ˜¯ååº”åœ¨è°ƒç”¨å †æ ˆä¸Šã€‚å‡½æ•°å¹¶ä¸ä¼šç«‹å³è¿”å›ç»™è°ƒç”¨è€…ï¼Œè€Œæ˜¯é€šè¿‡å›è°ƒå‡½æ•°blockï¼Œé€šçŸ¥æˆ–è€…ä¸€äº›ç±»ä¼¼çš„æœºåˆ¶ï¼Œè¿™äº›ä½¿å¾—æµ‹è¯•å˜å¾—æ›´åŠ å›°éš¾ã€‚</p>

<p>ç„¶åï¼Œæµ‹è¯•å¼‚æ­¥ä»£ç ä¹Ÿä¼šå¸¦æ¥ä¸€äº›å¥½å¤„ï¼Œæ¯”å¦‚å¯ä»¥æ­éœ²è¾ƒå·®çš„ç¨‹åºè®¾è®¡ï¼Œè®©æœ€ç»ˆçš„å®ç°å˜å¾—æ›´åŠ æ¸…æ™°ã€‚</p>

<h1>å¼‚æ­¥æµ‹è¯•çš„é—®é¢˜</h1>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•åœ°åŒæ­¥å•å…ƒæµ‹è¯•çš„ä¾‹å­ï¼Œä¸¤ä¸ªæ•°æ±‚å’Œçš„æ–¹æ³•.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (int)add:(int)a to:(int)b {
</span><span class='line'>    return a + b;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æµ‹è¯•è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦æ¯”è¾ƒè¯¥æ–¹æ³•è¿”å›å€¼æ˜¯å¦å’ŒæœŸæœ›å€¼ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒï¼Œåˆ™æµ‹è¯•å¤±è´¥ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)testAddition {
</span><span class='line'>    int result = [Calculator add:2 to:2];
</span><span class='line'>    STAssertEquals(result, 4, nil);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ©ç”¨blockå°†è¯¥æ–¹æ³•æ”¹æˆå¼‚æ­¥è¿”å›ç»“æœï¼Œä¸ºäº†æ¨¡æ‹Ÿæµ‹è¯•å¤±è´¥ï¼Œæˆ‘ä»¬ä¼šåœ¨æ–¹æ³•å®ç°ä¸­æ•…æ„æ·»åŠ ä¸€ä¸ªbug.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (int)add:(int)a to:(int)b block:(void(^)(int))block {
</span><span class='line'>    [[NSOperationQueue mainQueue] addOperationWithBlock:^{
</span><span class='line'>        block(a - b); // å¸¦æœ‰bugçš„å®ç°
</span><span class='line'>    }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è™½ç„¶è¿™æ˜¯ä¸€ä¸ªäººä¸ºçš„ä¾‹å­ï¼Œä½†æ˜¯å®ƒå´çœŸå®çš„åæ˜ äº†ç¼–ç¨‹ä¸­å¯èƒ½ç»å¸¸é‡åˆ°çš„é—®é¢˜ï¼Œåªä¸è¿‡å®é™…è¿‡ç¨‹æ›´åŠ å¤æ‚ç½¢äº†ã€‚</p>

<p>æµ‹è¯•ä¸Šé¢çš„æ–¹æ³•æœ€ç®€å•çš„åšæ³•å°±æ˜¯æŠŠæ–­è¨€æ”¾åˆ°Blockä¸­ã€‚å°½ç®¡æˆ‘ä»¬çš„æ–¹æ³•å®ç°ä¸­å­˜åœ¨bug,ä½†æ˜¯è¿™ç§æµ‹è¯•æ°¸è¿œä¸æ˜¯å¤±è´¥çš„ï¼›</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// åƒä¸‡ä¸è¦ä½¿ç”¨è¿™äº›ä»£ç ï¼
</span><span class='line'>- (void)testAdditionAsync {
</span><span class='line'>    [Calculator add:2 to:2 block:^(int result) {
</span><span class='line'>        STAssertEquals(result, 4, nil); // æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨åˆ°
</span><span class='line'>    }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œçš„æ–­è¨€ä¸ºä»€ä¹ˆæ²¡å¤±è´¥å‘¢ï¼Ÿ</p>

<h1>å…³äºSenTestingKit</h1>

<p>åœ¨è€ç‰ˆæœ¬çš„xcodeä¸­æ‰€ä½¿ç”¨çš„æµ‹è¯•æ¡†æ¶æ˜¯åŸºäº <a href="http://www.sente.ch/software/ocunit/">OCUnit</a>ã€‚ä¸ºäº†ç†è§£ä¹‹å‰æ‰€æåˆ°çš„å¼‚æ­¥æµ‹è¯•é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹æµ‹è¯•åŒ…ä¸­çš„å„ä¸ªéƒ¨åˆ†ä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªç®€åŒ–çš„æµç¨‹ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/SenTestingKit-call-stack.png" alt="test" /></p>

<p>åœ¨æµ‹è¯•æ¡†æ¶åœ¨ä¸»run loopå¼€å§‹è¿è¡Œä¹‹åï¼Œä¸»è¦æ‰§è¡Œäº†ä¸€ä¸‹å‡ ä¸ªæ­¥éª¤:</p>

<ol>
<li>é…ç½®ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³æµ‹è¯•çš„æµ‹è¯•åŒ…</li>
<li>è¿è¡Œæµ‹è¯•åŒ…ï¼Œå†…éƒ¨ä¼šè°ƒç”¨æ‰€æœ‰ä»¥testå¼€å¤´æµ‹è¯•ç”¨ä¾‹çš„æ–¹æ³•ã€‚è¿è¡Œç»“æŸåä¼šè¿”å›ä¸€ä¸ªåŒ…å«å•ä¸ªæµ‹è¯•ç»“æœçš„å¯¹è±¡ã€‚</li>
<li>è°ƒç”¨exit()é€€å‡ºæµ‹è¯•</li>
</ol>


<p>è¿™å…¶ä¸­æˆ‘ä»¬æœ€æ„Ÿå…´è¶£çš„æ˜¯å•ä¸ªæµ‹è¯•æ—¶å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚åœ¨å¼‚æ­¥æµ‹è¯•ä¸­ï¼ŒåŒ…å«æ–­è¨€çš„Blockä¼šè¢«åŠ åˆ°run loopã€‚å½“æ‰€æœ‰çš„æµ‹è¯•æ‰§è¡Œå®Œæ¯•åï¼Œæµ‹è¯•æ¡†æ¶å°±ä¼šé€€å‡ºï¼Œè€Œblockå´ä»æ¥æ²¡æœ‰è¢«æ‰§è¡Œï¼Œå› æ­¤ä¸ä¼šå¼•èµ·æµ‹è¯•å¤±è´¥ã€‚</p>

<p>å½“ç„¶æˆ‘ä»¬æœ‰å¾ˆå¤šç§æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½†æ˜¯ç´ æœ‰çš„æ–¹æ³•éƒ½å¿…é¡»åœ¨ä½run loopä¸­è¿è¡Œï¼Œè€Œä¸”åœ¨æµ‹è¯•æ–¹æ³•è¿”å›å’Œæ¯”è¾ƒç»“æœä¹‹å‰éœ€è¦å¤„ç†å·²å…¥é˜Ÿçš„æ‰€æœ‰æ“ä½œã€‚</p>

<p><a href="https://github.com/allending/Kiwi">kiwi</a>ä½¿ç”¨æµ‹è¯•è½®è¯¢ï¼Œå®ƒå¯ä»¥åœ¨æµ‹è¯•æ–¹æ³•ä¸­è¢«æ»´å•Šç”¨ã€‚<a href="https://github.com/gabriel/gh-unit/">GHUnit</a>ç¼–å†™äº†ä¸€ä¸ªå•ç‹¬çš„æµ‹è¯•ç±»ï¼Œå®ƒå¿…é¡»åœ¨æµ‹è¯•çš„æ–¹æ³•å†…åˆå§‹åŒ–ï¼Œå¹¶åœ¨ç»“æŸæ—¶æ¥å—ä¸€ä¸ªé€šçŸ¥ã€‚ä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ½æ˜¯é€šè¿‡ç¼–å†™ç›¸åº”çš„ä»£ç æ¥ç¡®ä¿å¼‚æ­¥å¼‚æ­¥æµ‹è¯•æ–¹æ³•åœ¨æµ‹è¯•ç»“æŸä¹‹å‰éƒ½ä¸ä¼šè¿”å›ã€‚</p>

<h1>SenTesgingKitçš„å¼‚æ­¥æ‰©å±•</h1>

<p>æˆ‘ä»¬å¯¹è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯å¯¹SenTestingKitæ·»åŠ ä¸€ä¸ªæ‰©å±•ï¼Œå®ƒåœ¨æ ˆä¸Šä½¿ç”¨åŒæ­¥æ‰§è¡Œï¼Œå¹¶æŠŠæ¯ä¸ªéƒ¨åˆ†åŠ å…¥åˆ°ä¸»é˜Ÿåˆ—ä¸­ã€‚æ­£å¦‚ä¸‹å›¾æ‰€è§ï¼Œåœ¨éªŒè¯æ•´ä¸ªæµ‹è¯•æ¡†æ¶ç»“æœä¹‹å‰ï¼ŒæŠ¥å‘Šå¼‚æ­¥æµ‹è¯•æˆåŠŸæˆ–å¤±è´¥çš„Blockå°±è¢«åŠ å…¥åˆ°é˜Ÿåˆ—ã€‚è¿™ç§æ‰§è¡Œé¡ºåºå…è®¸æˆ‘ä»¬å¼€å¯ä¸€ä¸ªæµ‹è¯•å¹¶ç­‰å¾…å®ƒçš„æµ‹è¯•ç»“æœã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/SenTestingKitAsync-call-stack.png" alt="test" /></p>

<p>å¦‚æœæµ‹è¯•æ–¹æ³•ä»¥Asyncç»“å°¾ï¼Œæ¡†æ¶å°±ç¡è®¤ä¸ºè¯¥æ–¹æ³•æ˜¯å¼‚æ­¥æµ‹è¯•ã€‚æ­¤å¤–ï¼Œåœ¨å¼‚æ­¥æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨çš„æŠ¥å‘Šæµ‹è¯•æˆåŠŸï¼ŒåŒæ—¶ä¸ºäº†é˜²æ­¢Blockæ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ·»åŠ äº†ä¸€ä¸ªè¶…æ—¶æ–¹æ³•ï¼Œä¹‹å‰çš„é”™è¯¯çš„æµ‹è¯•æ–¹æ³•ä¿®æ”¹å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)testAdditionAsync {
</span><span class='line'>    [Calculator add:2 to:2 block^(int result) {
</span><span class='line'>        STAssertEquals(result, 4, nil);
</span><span class='line'>        STSuccess(); // é€šè¿‡è°ƒç”¨è¿™ä¸ªå®æ¥åˆ¤æ–­æ˜¯å¦æµ‹è¯•æˆåŠŸ
</span><span class='line'>    }];
</span><span class='line'>    STFailAfter(2.0, @"Timeout");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>è®¾è®¡å¼‚æ­¥æµ‹è¯•</h1>

<p>å°±åƒåŒæ­¥æµ‹è¯•ä¸€æ ·ï¼Œå¼‚æ­¥æµ‹è¯•ä¹Ÿåº”è¯¥æ¯”è¢«æµ‹è¯•çš„åŠŸèƒ½ç®€å•è®¸å¤šã€‚å¤æ‚çš„æµ‹è¯•å¹¶ä¸ä¼šæ”¹è¿›ä»£ç çš„è´¨é‡ï¼Œåè€Œä¼šç»™æµ‹è¯•æœ¬èº«å¸¦æ¥æ›´å¤šçš„Bug,åœ¨ä»¥æµ‹è¯•é©±åŠ¨å¼€å‘çš„æƒ…å†µä¸‹ï¼Œç®€å•çš„æµ‹è¯•ä¼šè®©æˆ‘ä»¬å¯¹ç»„ä»¶ï¼Œæ¥å£ä»¥åŠæ¶æ„çš„è¡Œä¸ºæœ‰æ›´æ¸…é†’çš„è®¤è¯†.</p>

<p>ä¸ºäº†è¿è¡Œåˆ°å®é™…ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹æ¡†æ¶: <a href="sd">AsyncTestDemo</a>,å®ƒä»ä¸€ä¸ªè™šæ‹Ÿçš„æœåŠ¡å™¨è·å–å›¾åƒä¿¡æ¯ï¼Œæ¡†æ¶ä¸­åŒ…å«äº†ä¸€ä¸ªèµ„æºç®¡ç†å™¨ï¼Œå®ƒå¯¹å¤–æä¾›äº†ä¸€ä¸ªå¯ä»¥æ ¹æ®å›¾åƒIdè·å–å›¾åƒå¯¹è±¡çš„æ¥å£ã€‚è¯¥æ¥å£çš„å·¥ä½œåŸç†æ˜¯èµ„æºç®¡ç†å™¨ä»è™šæ‹ŸæœåŠ¡å™¨è·å–å›¾ç‰‡å¯¹è±¡ä¿¡æ¯ï¼Œå¹¶æ›´æ–°åˆ°æ•°æ®åº“ã€‚</p>

<p>è™½ç„¶è¿™ä¸ªç¤ºä¾‹æ¡†æ¶åªæ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œä½†åœ¨æˆ‘ä»¬è‡ªå·±å¼€å‘çš„è®¸å¤šåº”ç”¨ä¸­ä¹Ÿä½¿ç”¨äº†è¿™ç§æ¨¡å¼ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/PinacotecaCore.png" alt="test" /></p>

<p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œç¤ºä¾‹æ¡†æ¶æœ‰ä¸‰ä¸ªç»„ä»¶æˆ‘ä»¬éœ€è¦æµ‹è¯•:</p>

<ol>
<li>æ¨¡å‹å±‚</li>
<li>æ¨¡æ‹ŸæœåŠ¡å™¨è¯·æ±‚çš„æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨(API Controller)</li>
<li>ç®¡ç†Core dataå †æ ˆä»¥åŠè¿æ¥æ¨¡å‹å±‚å’ŒæœåŠ¡æ¥å£æ§åˆ¶å™¨çš„èµ„æºç®¡ç†å™¨</li>
</ol>


<h2>æ¨¡å‹å±‚</h2>

<p>æµ‹è¯•åº”è¯¥å°½é‡ä½¿ç”¨åŒæ­¥çš„æ–¹å¼è¿›è¡Œï¼Œè€Œæ¨¡å‹å±‚å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®ä¾‹ã€‚åªè¦ä¸åŒçš„è¢«æ‰˜ç®¡å¯¹è±¡ä¸Šä¸‹æ–‡ä¹‹é—´æ²¡æœ‰å¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œæµ‹è¯•ç”¨ä¾‹éƒ½åº”è¯¥æ ¹æ®ä¸Šä¸‹æ–‡åœ¨ä¸»çº¿ç¨‹ä¸Šè®¾ç½®å®ƒè‡ªå·±çš„core dataå †æ ˆï¼Œå¹¶åœ¨å…¶ä¸­æ‰§è¡Œå„è‡ªçš„æ“ä½œã€‚</p>

<p>åœ¨è¿™ä¸ªæµ‹è¯•å®ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°±æ˜¯åœ¨ setup æ–¹æ³•ä¸­è®¾ç½®core dataå †æ ˆï¼Œç„¶åæ£€æŸ¥ PCImageå®ä½“çš„æè¿°æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±æ„é€ ä¸€ä¸ªï¼Œå¹¶æ›´æ–°å®ƒçš„å€¼ï¼Œå½“ç„¶è¿™å’Œå¼‚æ­¥æµ‹è¯•æ²¡æœ‰å…³ç³»ï¼Œæˆ‘ä»¬å°±ä¸æ·±å…¥ç»†è¯´äº†ã€‚</p>

<h2>æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨</h2>

<p>æ¡†æ¶ä¸­çš„ç¬¬äºŒä¸ªç»„ä»¶å°±æ˜¯æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨ï¼Œå®ƒä¸»è¦å¤„ç†æœåŠ¡å™¨è¯·æ±‚ä»¥åŠæœåŠ¡å™¨APIåˆ°æ¨¡å‹çš„æ˜ å°„å…³ç³»ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªæ–¹æ³•:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- [PCServerAPIController fetchImageWithId:queue:completionHandler:]</span></code></pre></td></tr></table></div></figure>


<p>è°ƒç”¨å®ƒéœ€è¦ä¸‰ä¸ªå½¢å‚ï¼šä¸€ä¸ªå›¾ç‰‡å¯¹è±¡Idï¼Œæ‰€åœ¨çš„æ‰§è¡Œé˜Ÿåˆ—ï¼Œä»¥åŠä¸€ä¸ªå®Œæˆåçš„å›è°ƒæ–¹æ³•ã€‚</p>

<p>å› ä¸ºæœåŠ¡å™¨æ ¹æœ¬ä¸å­˜åœ¨ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„åšæ³•å°±æ˜¯ä¼ªé€ ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œæ­£å¥½<a href="https://github.com/AliSoftware/OHHTTPStubs">OHHTTPStubs</a>å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åœ¨å®ƒçš„æœ€æ–°ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥åœ¨ç¤ºä¾‹çš„è¯·æ±‚å“åº”ä¸­åŒ…å«ä¸€ä¸ªbundle,å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>

<p>ä¸ºäº†èƒ½stubè¯·æ±‚ï¼ŒOHHTTPStubséœ€è¦åœ¨æµ‹è¯•ç±»åˆå§‹åŒ–æ—¶æˆ–è€… setupæ–¹æ³•ä¸­è¿›è¡Œé…ç½®ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦åŠ è½½ä¸€ä¸ªåŒ…å«è¯·æ±‚å“åº”å¯¹è±¡(response)çš„bundle:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSURL *url = [[NSBundle bundleForClass:[self class]]
</span><span class='line'>                        URLForResource:@"ServerAPIResponses"
</span><span class='line'>                         withExtension:@"bundle"];
</span><span class='line'>
</span><span class='line'>NSBundle *bundle = [NSBundle url];</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åæˆ‘ä»¬ä»bundleåŠ è½½responseå¯¹è±¡ï¼Œä½œä¸ºè¯·æ±‚çš„å“åº”å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>OHHTTPStubsResponse *response;
</span><span class='line'>response = [OHHTTPStubsResponse responseNamed:@"images/123"
</span><span class='line'>                                   fromBundle:responsesBundle
</span><span class='line'>                                 responseTime:0.1];
</span><span class='line'>
</span><span class='line'>[OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest *request) {
</span><span class='line'>    return YES /* å¦‚æœæ‰€è¿”å›çš„requestæ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ï¼Œå°±è¿”å›YES */;
</span><span class='line'>} withStubResponse:^OHHTTPStubsResponse *(NSURLRequest *request) {
</span><span class='line'>    return response;
</span><span class='line'>}];</span></code></pre></td></tr></table></div></figure>


<p>é€šè¿‡å¦‚ä¸Šçš„è®¾ç½®ä¹‹åï¼Œç®€åŒ–ç‰ˆçš„<a href="https://github.com/objcio/issue-2-async-testing/blob/master/PinacotecaCore/PinacotecaCoreTests/PCServerAPIControllerTests.m">æµ‹è¯•æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨</a>å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)testFetchImageAsync
</span><span class='line'>{
</span><span class='line'>    [self.server
</span><span class='line'>        fetchImageWithId:@"123"
</span><span class='line'>                   queue:[NSOperationQueue mainQueue]
</span><span class='line'>       completionHandler:^(id imageData, NSError *error) {
</span><span class='line'>          STAssertEqualObjects([NSOperationQueue currentQueue], queue, nil);
</span><span class='line'>          STAssertNil(error, [error localizedDescription]);
</span><span class='line'>          STAssertTrue([imageData isKindOfClass:[NSDictionary class]], nil);
</span><span class='line'>
</span><span class='line'>          // æ£€æŸ¥è¿”å›çš„å­—å…¸ä¸­çš„å€¼.
</span><span class='line'>
</span><span class='line'>          STSuccess();
</span><span class='line'>       }];
</span><span class='line'>    STFailAfter(2.0, nil);    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>èµ„æºç®¡ç†å™¨</h2>

<p>æœ€åä¸€ä¸ªéƒ¨åˆ†æ˜¯èµ„æºç®¡ç†å™¨ï¼Œå®ƒä¸ä½†æŠŠæœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨å’Œè†œå½¢æˆå‘¢ä¸ªè”ç³»èµ·æ¥ï¼Œè¿˜ç®¡ç†ç€core dataå †æ ˆã€‚ä¸‹é¢æˆ‘ä»¬æƒ³æµ‹è¯•è·å–ä¸€ä¸ªå›¾ç‰‡å¯¹è±¡çš„æ–¹æ³•:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-[PCResourceManager imageWithId:usingManagedObjectContext:queue:updateHandler:]</span></code></pre></td></tr></table></div></figure>


<p>è¯¥æ–¹æ³•æ ¹æ®Idè¿”å›ä¸€ä¸ªå›¾ç‰‡å¯¹è±¡ã€‚å¦‚æœå›¾ç‰‡åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«Idçš„æ–°å¯¹è±¡ï¼Œç„¶åé€šè¿‡æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨è·å–å›¾ç‰‡å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>

<p>ç”±äºèµ„æºç®¡ç†å™¨çš„æµ‹è¯•ä¸åº”è¯¥ä¾èµ–äºæœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨<a href="http://ocmock.org/">OCMock</a>æ¥æ¨¡æ‹Ÿï¼Œå¦‚æœè¦åšæ–¹æ³•çš„éƒ¨åˆ†stub,å®ƒæ˜¯ä¸€ä¸ªç†æƒ³çš„æ¡†æ¶.å¦‚ä»¥ä¸‹çš„ <a href="https://github.com/objcio/issue-2-async-testing/blob/master/PinacotecaCore/PinacotecaCoreTests/PCResourceManagerTests.m">èµ„æºç®¡ç†å™¨æµ‹è¯•</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>OCMockObject *mo;
</span><span class='line'>mo = [OCMockObject partialMockForObject:self.resourceManager.server];
</span><span class='line'>
</span><span class='line'>id exp = [[serverMock expect] 
</span><span class='line'>             andCall:@selector(fetchImageWithId:queue:completionHandler:)
</span><span class='line'>            onObject:self];
</span><span class='line'>[exp fetchImageWithId:OCMOCK_ANY queue:OCMOCK_ANY completionHandler:OCMOCK_ANY];</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä»£ç å®é™…ä¸Šå®ƒå¹¶æ²¡æœ‰çœŸæ­£è°ƒç”¨æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨çš„æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨æˆ‘ä»¬å¸è½½æµ‹è¯•ç±»ä¸­çš„æ–¹æ³•ã€‚</p>

<p>ç”¨ä¸Šé¢çš„ä½œåŠï¼Œå¯¹èµ„æºç®¡ç†çš„æµ‹è¯•å°±å˜å¾—å¾ˆç›´è§‚ã€‚å½“æˆ‘ä»¬è°ƒç”¨èµ„æºç®¡ç†å™¨è·å–èµ„æºæ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„ä½¿æˆ‘ä»¬æ¨¡æ‹Ÿçš„æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨çš„æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬ä¹Ÿèƒ½æ£€æŸ¥è°ƒç”¨æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨æ—¶å‚æ•°æ˜¯å¦æ­£ç¡®ã€‚åœ¨è°ƒç”¨äº†è·å–å›¾åƒå¯¹è±¡çš„æ–¹æ³•åï¼Œèµ„æºç®¡ç†å™¨ä¼šæ›´æ–°æ¨¡å‹ï¼Œç„¶åè°ƒç”¨éªŒè¯æµ‹è¯•æˆåŠŸä¸å¦çš„å®ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)testGetImageAsync
</span><span class='line'>{
</span><span class='line'>    NSManagedObjectContext *ctx = self.resourceManager.mainManagedObjectContext;
</span><span class='line'>    __block PCImage *img;
</span><span class='line'>    img = [self.resourceManager imageWithId:@"123"
</span><span class='line'>                  usingManagedObjectContext:ctx
</span><span class='line'>                                      queue:[NSOperationQueue mainQueue]
</span><span class='line'>                              updateHandler:^(NSError *error) {
</span><span class='line'>                                       // æ£€æŸ¥erroræ˜¯å¦ä¸ºç©ºä»¥åŠimageæ˜¯å¦å·²ç»è¢«æ›´æ–° 
</span><span class='line'>                                       STSuccess();
</span><span class='line'>                                   }];    
</span><span class='line'>    STAssertNotNil(img, nil);
</span><span class='line'>    STFailAfter(2.0, @"Timeout");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>æ€»ç»“</h1>

<p>åˆšå¼€å§‹çš„æ—¶å€™ï¼Œä½¿ç”¨å¹¶å‘è®¾è®¡æ¨¡å¼æµ‹è¯•åº”ç”¨ç¨‹åºæ˜¯å…·æœ‰ä¸€å®šçš„æŒ‘æˆ˜æ€§ï¼Œä½†æ˜¯ä¸€æ—¦ä½ ç†è§£äº†ä»–ä»¬çš„ä¸åŒï¼Œå¹¶å»ºç«‹æœ€ä½³å®è·µï¼Œä¸€åˆ‡éƒ½ä¼šå˜å¾—ç®€å•è€Œæœ‰è¶£ã€‚</p>

<p>ğŸ˜€fun~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Iosä¸­çš„å¤šä»»åŠ¡]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/19/ioszhong-de-duo-ren-wu/"/>
    <updated>2016-04-19T10:17:49+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/19/ioszhong-de-duo-ren-wu</id>
    <content type="html"><![CDATA[<p>åœ¨ios7ä¹‹å‰ï¼Œå½“ç¨‹åºç½®äºåå°ä¹‹åå¼€å‘è€…ä»¬å¯¹ä»–ä»¬ç¨‹åºæ‰€èƒ½åšçš„äº‹æƒ…éå¸¸æœ‰é™ï¼Œé™¤äº†VOIPå’ŒåŸºäºåœ°ç†ä½ç½®ç‰¹æ€§ä¹‹å¤–ï¼Œå”¯ä¸€èƒ½åšçš„åœ°æ–¹å°±æ˜¯åå°ä»»åŠ¡(background tasks)è®©ä»£ç å¯ä»¥æ‰§è¡Œå‡ åˆ†é’Ÿã€‚å¦‚æœä½ æƒ³ä¸‹è½½æ¯”è¾ƒå¤§çš„è§†é¢‘æ–‡ä»¶ä»¥ä¾¿ç¦»çº¿æµè§ˆï¼Œæˆ–è€…å¤‡ä»½ç”¨æˆ·çš„ç…§ç‰‡åˆ°ä½ çš„æœåŠ¡å™¨ä¸Šï¼Œä½ éƒ½ä»…èƒ½å®Œæˆä¸€éƒ¨åˆ†å·¥ä½œ.</p>

<p> <!--more--></p>

<p>ios7æ·»åŠ äº†ä¸¤ä¸ªæ–°çš„APIä»¥ä¾¿ä½ çš„ç¨‹åºå¯ä»¥åœ¨åå°æ›´æ–°ç•Œé¢ä»¥åŠå†…å®¹ã€‚é¦–å…ˆæ˜¯åå°è·å–(background Fetch)ï¼Œå®ƒå…è®¸ä½ å®šä¹‰åœ°ä»ç½‘ç»œè·å–æ–°çš„å†…å®¹ã€‚ç¬¬äºŒä¸ªAPIå°±æ˜¯è¿œç¨‹é€šçŸ¥(Remote Notifications)ï¼Œè¿™æ˜¯ä¸€ä¸ªå½“äº‹ä»¶å‘ç”Ÿæ—¶å¯ä»¥è®©æ¨é€é€šçŸ¥ä¸»åŠ¨æé†’åº”ç”¨çš„æ–°ç‰¹æ€§ï¼Œè¿™ä¸¤è€…éƒ½ä¸ºä½ çš„åº”ç”¨ç•Œé¢ä¿æŒæœ€æ–°æä¾›äº†æå¤§çš„å¸®åŠ©ã€‚åœ¨æ–°çš„åå°ä¼ è¾“æœåŠ¡(Background Trasnfer service)ä¸­æ‰§è¡Œå®šæœŸçš„ä»»åŠ¡ï¼Œä¹Ÿå…è®¸ä½ åœ¨è¿›ç¨‹ä¹‹å¤–å¯ä»¥æ‰§è¡Œç½‘ç»œä¼ è¾“(ä¸‹è½½å’Œä¸Šä¼ )å·¥ä½œ</p>

<p>åå°è·å–(Background Fetch)å’Œè¿œç¨‹é€šçŸ¥(Remote notification)åŸºäºç®€å•çš„ ApplicationDelegateé’©å­ï¼Œåœ¨åº”ç”¨ç¨‹åºæŒ‚èµ·ä¹‹å‰çš„30ç§’æ—¶é—´æ‰§è¡Œå·¥ä½œã€‚å®ƒä»¬ä¸æ˜¯ç”¨äºCPUé¢‘ç¹å·¥ä½œæˆ–è€…é•¿æ—¶é—´è¿è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯ç”¨æ¥å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„ç½‘ç»œè¯·æ±‚é˜Ÿåˆ—ï¼Œä¾‹å¦‚ä¸‹è½½ä¸€éƒ¨å¾ˆå¤§çš„ç”µå½±ï¼Œæˆ–è€…æ‰§è¡Œå¿«é€Ÿçš„å†…å®¹æ›´æ–°ã€‚</p>

<p>å¯¹äºç”¨æˆ·æ¥è¯´,å¤šä»»åŠ¡å¤„ç†æœ‰ç‚¹æ˜¾è€Œæ˜“è§çš„æ”¹å˜å°±æ˜¯æ–°çš„åº”ç”¨åˆ‡æ¢ç¨‹åºï¼Œå®ƒç”¨æ¥å‘ˆç°åº”ç”¨åˆ°åå°æ—¶çš„ç•Œé¢å¿«ç…§ã€‚è¿™äº›å¿«ç…§çš„å­˜åœ¨æ˜¯æœ‰ä¸€å®šç†ç”±çš„&ndash;ç°åœ¨ä½ å¯ä»¥åœ¨åå°å®Œæˆå·¥ä½œåæ›´æ–°ç¨‹åºå¿«ç…§ï¼Œä»¥ç”¨æ¥å‘ˆç°æ–°çš„å†…å®¹ã€‚ç¤¾äº¤ç½‘ç»œï¼Œæ–°é—»æˆ–è€…å¤©æ°”ç­‰åº”ç”¨ç°åœ¨éƒ½å¯ä»¥ç›´æ¥å‘ˆç°æœ€æ–°çš„å†…å®¹è€Œä¸éœ€è¦ç”¨æˆ·é‡æ–°æ‰“å¼€åº”ç”¨ã€‚æˆ‘ä»¬ç¨åä¼šä»‹ç»å¦‚ä½•æ›´æ–°å±å¹•å¿«ç…§ã€‚</p>

<h2>åå°è·å–</h2>

<p>åå°è·å–æ˜¯ä¸€ç§æ™ºèƒ½çš„è½®è¯¢æœºåˆ¶ï¼Œå®ƒå¾ˆé€‚åˆéœ€è¦ç»å¸¸æ›´æ–°å†…å®¹çš„ç¨‹åºï¼Œåƒç¤¾äº¤ç½‘ç»œï¼Œæ–°é—»æˆ–å¤©æ°”çš„ç¨‹åºã€‚ä¸ºäº†åœ¨ç”¨æˆ·å¯åŠ¨ç¨‹åºå‰æå‰å‡ºå‘åå°è·å–ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºå”¤é†’åº”ç”¨ç¨‹åºã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœç”¨æˆ·ç»å¸¸åœ¨ä¸‹åˆä¸€ç‚¹ä½¿ç”¨æŸä¸ªåº”ç”¨ç¨‹åºï¼Œç³»ç»Ÿä¼šå­¦ä¹ ï¼Œé€‚åº”å¹¶åœ¨ä½¿ç”¨å‘¨æœŸå‰æ‰§è¡Œåå°è·å–ã€‚ä¸ºäº†å‡å°‘ç”µæ± ä½¿ç”¨ï¼Œä½¿ç”¨è®¾å¤‡æ— çº¿é€šä¿¡çš„æ‰€æœ‰åº”ç”¨çš„åå°è·å–ä¼šè¢«åˆå¹¶ï¼Œå¦‚æœä½ æƒ³ç³»ç»ŸæŠ¥å‘Šæ–°æ•°æ®æ— æ³•è·å–ï¼Œiosä¼šé€‚åº”å¹¶ä½¿ç”¨æ­¤ä¿¡æ¯é¿å…ä¼šç»§ç»­è·å–ã€‚</p>

<p>å¼€å¯åå°è·å–çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨info plistæ–‡ä»¶ä¸­å¯¹UIBackgroundModesé”®æŒ‡å®šç‰¹å®šçš„å€¼ã€‚æœ€ç®€å•çš„é€”å¾„æ˜¯åœ¨Xcodeçš„project editorä¸­æ–°çš„Capabilitiesæ ‡ç­¾é¡µè®¾ç½®ï¼Œè¿™ä¸ªæ ‡ç­¾é¡µåŒ…å«äº†åå°æ¨¡å¼éƒ¨åˆ†ï¼Œå¯ä»¥æ–¹ä¾¿é…ç½®å¤šä»»åŠ¡é€‰é¡¹ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/capabilities-on-bgfetch.jpg" alt="logo" /></p>

<p>æˆ–è€…ä½ å¯ä»¥æ‰‹åŠ¨é…ç½®è¿™ä¸ªå€¼</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;key&gt;UIBackgroundModes&lt;/key&gt;
</span><span class='line'>&lt;array&gt;
</span><span class='line'>    &lt;string&gt;fetch&lt;/string&gt;
</span><span class='line'>&lt;/array&gt;  </span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œå‘Šè¯‰IOSå¤šä¹…è¿›è¡Œä¸€æ¬¡æ•°æ®è·å–</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
</span><span class='line'>{
</span><span class='line'>    [application setMinimumBackgroundFetchInterval:UIApplicationBackgroundFetchIntervalMinimum];
</span><span class='line'>
</span><span class='line'>    return YES;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>iosé»˜è®¤ä¸è¿›è¡Œåå°è·å–ï¼Œæ‰€ä»¥ä½ éœ€è¦è®¾ç½®ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œå¦åˆ™ï¼Œä½ çš„åº”ç”¨ç¨‹åºæ°¸è¿œä¸èƒ½åœ¨åå°è¢«å”¤é†’ã€‚UIApplicationBackgroundFetchIntervalMinimumè¿™ä¸ªå€¼è¦æ±‚ç³»ç»Ÿå°½å¯èƒ½é¢‘ç¹åœ°å»ç®¡ç†ä½ çš„ç¨‹åºåˆ°åº•ä»€ä¹ˆæ—¶å€™åº”è¯¥è¢«å”¤é†’ï¼Œä½†å¦‚æœä½ ä¸éœ€è¦è¿™æ ·çš„è¯ï¼Œä½ ä¹Ÿåº”è¯¥åˆ¶å®šä¸€ä¸ªä½ æƒ³è¦çš„æ—¶é—´é—´éš”ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤©æ°”çš„åº”ç”¨ç¨‹åºï¼Œå¯èƒ½åªéœ€è¦å‡ ä¸ªå°æ—¶æ›´æ–°ä¸€æ¬¡ï¼ŒIOSå°†ä¼šåœ¨åå°è·å–ä¹‹é—´è‡³å°‘ç­‰å¾…ä½ æŒ‡å®šçš„æ—¶é—´é—´éš”ã€‚</p>

<p>å¦‚æœä½ çš„åº”ç”¨å…è®¸ç”¨æˆ·é€€å‡ºç™»å½•ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰è·å–æ–°æ•°æ®çš„éœ€è¦äº†ï¼Œä½ åº”è¯¥æŠŠminimumBackgroundFetchIntervalè®¾ç½®ä¸ºUIApplicationBackgroundFetchIntervalNever,ä¸“ä¸šé‚£ä¸ªå¯ä»¥èŠ‚çœèµ„æºã€‚</p>

<p>æœ€åä¸€æ­¥æ˜¯åœ¨åº”ç”¨ç¨‹åºå§”æ‰˜ä¸­å®ç°ä¸‹åˆ—æ–¹æ³•:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)                application:(UIApplication *)application 
</span><span class='line'>  performFetchWithCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler
</span><span class='line'>{
</span><span class='line'>    NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];
</span><span class='line'>    NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration];
</span><span class='line'>
</span><span class='line'>    NSURL *url = [[NSURL alloc] initWithString:@"http://yourserver.com/data.json"];
</span><span class='line'>    NSURLSessionDataTask *task = [session dataTaskWithURL:url 
</span><span class='line'>                                        completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
</span><span class='line'>
</span><span class='line'>        if (error) {
</span><span class='line'>            completionHandler(UIBackgroundFetchResultFailed);
</span><span class='line'>            return;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        // è§£æå“åº”/æ•°æ®ä»¥å†³å®šæ–°å†…å®¹æ˜¯å¦å¯ç”¨
</span><span class='line'>        BOOL hasNewData = ...
</span><span class='line'>        if (hasNewData) {
</span><span class='line'>            completionHandler(UIBackgroundFetchResultNewData);
</span><span class='line'>        } else {
</span><span class='line'>            completionHandler(UIBackgroundFetchResultNoData);
</span><span class='line'>        }
</span><span class='line'>    }];
</span><span class='line'>
</span><span class='line'>    // å¼€å§‹ä»»åŠ¡
</span><span class='line'>    [task resume];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç³»ç»Ÿå”¤é†’åº”ç”¨ç¨‹åºåå°†ä¼šæ‰§è¡Œè¿™ä¸ªå§”æ‰˜æ–¹æ³•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ åªæœ‰30ç§’çš„æ—¶é—´æ¥ç¡®å®šè·å–çš„æ–°å†…å®¹æ˜¯å¦å¯ç”¨ï¼Œç„¶åå¤„ç†æ–°å†…å®¹å¹¶æ›´æ–°ç•Œé¢ï¼Œ30ç§’æ—¶é—´åº”è¯¥è¶³å¤Ÿå»ç½‘ç»œè·å–æ•°æ®å’Œè·å–ç•Œé¢çš„ç¼©ç•¥å›¾ï¼Œä½†æ˜¯æœ€å¤šåªæœ‰30ç§’ï¼Œå½“å®Œæˆäº†ç½‘ç»œè¯·æ±‚å’Œæ›´æ–°ç•Œé¢åï¼Œä½ åº”è¯¥æ‰§è¡Œå®Œæˆçš„å›è°ƒã€‚</p>

<p>å®Œæˆå›è°ƒçš„æ‰§è¡Œæœ‰ä¸¤ä¸ªç›®çš„ï¼Œé¦–å…ˆï¼Œç³»ç»Ÿä¼šä¼°é‡ä½ çš„è¿›ç¨‹æ¶ˆè€—çš„ç”µé‡ï¼Œå¹¶æ ¹æ®ä½ ä¼ é€’çš„UIBackgroundFetchResultå‚æ•°è®°å½•æ–°æ•°æ®æ˜¯å¦å¯ç”¨ï¼Œå…¶æ¬¡ï¼Œå½“ä½ è°ƒç”¨å®Œæˆçš„å¤„ç†ä»£ç æ—¶ï¼Œåº”ç”¨çš„ç•Œé¢ç¼©ç•¥å›¾ä¼šè¢«é‡‡ç”¨ï¼Œå¹¶æ›´æ–°åº”ç”¨ç¨‹åºåˆ‡æ¢å™¨ï¼Œå½“ç”¨æˆ·åœ¨åº”ç”¨é—´åˆ‡æ¢æ—¶ï¼Œç”¨æˆ·å°†ä¼šçœ‹åˆ°æ–°å†…å®¹ï¼Œè¿™ç§é€šè¿‡completion handleræ¥æŠ¥å‘Šå¹¶ä¸”ç”Ÿæˆæˆªå›¾çš„æ–¹æ³•ï¼Œåœ¨æ–°çš„å¤šä»»åŠ¡å¤„ç†APIä¸­æ˜¯å¾ˆå¸¸è§çš„ã€‚</p>

<p>åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œä½ åº”è¯¥å°†completionHandlerä¼ é€’åˆ°åº”ç”¨ç¨‹åºçš„å­ç»„ä»¶ï¼Œç„¶ååœ¨å¤„ç†å®Œæ•°æ®å’Œæ›´æ–°ç•Œé¢åè°ƒç”¨ã€‚</p>

<p>åœ¨è¿™é‡Œï¼Œä½ å¯èƒ½æƒ³çŸ¥é“iosæ˜¯å¦‚ä½•åœ¨åº”ç”¨ç¨‹åºåå°è¿è¡Œæ—¶è·å¾—ç•Œé¢æˆªå›¾çš„ï¼Œå¹¶ä¸”æƒ³çŸ¥é“åº”ç”¨ç¨‹åºçš„å£°æ˜å‘¨æœŸä¸åå°è·å–ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»ã€‚å¦‚æœåº”ç”¨ç¨‹åºå¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œç³»ç»Ÿä¼šå…ˆå”¤é†’åº”ç”¨ï¼Œç„¶åå†è°ƒç”¨application: performFetchWithCompletionHandler:ã€‚å¦‚æœåº”ç”¨ç¨‹åºè¿˜æ²¡æœ‰å¯åŠ¨ï¼Œç³»ç»Ÿå°†ä¼šå¯åŠ¨å®ƒï¼Œç„¶åè°ƒç”¨å¸¸è§çš„å§”æ‰˜æ–¹æ³•ï¼ŒåŒ…æ‹¬application: didFinishLaunchingWithOptions:ã€‚ä½ å¯ä»¥æŠŠè¿™ç§åº”ç”¨ç¨‹åºè¿è¡Œçš„æ–¹å¼æƒ³è±¡ä¸ºç”¨æˆ·ä»Springboardå¯åŠ¨è¿™ä¸ªç¨‹åºï¼ŒåŒºåˆ«ä»…ä»…åœ¨äºç•Œé¢æ˜¯çœ‹ä¸è§çš„ï¼Œåœ¨å±å¹•å¤–æ¸²æŸ“çš„ã€‚</p>

<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ— è®ºåº”ç”¨åœ¨åå°å¯åŠ¨æˆ–è€…åœ¨å‰å°ï¼Œä½ ä¼šæ‰§è¡Œç›¸åŒçš„å·¥ä½œï¼Œä½†ä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹UIAppcationçš„applicationStateå±æ€§æ¥åˆ¤æ–­åº”ç”¨æ˜¯ä¸æ˜¯ä»åå°å¯åŠ¨ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
</span><span class='line'>{
</span><span class='line'>    NSLog(@"Launched in background %d", UIApplicationStateBackground == application.applicationState);
</span><span class='line'>
</span><span class='line'>    return YES;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>æµ‹è¯•åå°æ•°æ®è·å–</h2>

<p>æœ‰ä¸¤ç§å¯ä»¥æ¨¡æ‹Ÿåå°è·å–çš„é€”å¾„ã€‚æœ€ç®€å•æ˜¯ä»Xcodeè¿è¡Œä½ çš„åº”ç”¨ï¼Œå½“åº”ç”¨è¿è¡Œæ—¶ï¼Œåœ¨Xcodeçš„Debugèœå•é€‰æ‹©Simulate Background Fetch.</p>

<p>ç¬¬äºŒç§æ–¹æ³•ï¼Œä½¿ç”¨schemeæ›´æ”¹Xcodeè¿è¡Œç¨‹åºçš„æ–¹å¼ã€‚åœ¨Xcodeèœå•çš„Producté€‰é¡¹ï¼Œé€‰æ‹©Schemeç„¶åé€‰æ‹©Manager Schemes.åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥ç¼–è¾‘æˆ–è€…æ·»åŠ ä¸€ä¸ªæ–°çš„scheme,ç„¶åé€‰ä¸­Launch due to a background fetch event ,å¦‚ä¸‹å›¾:</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/edit-scheme-simulate-background-fetch.png" alt="logo" /></p>

<h2>è¿œç¨‹é€šçŸ¥</h2>

<p>è¿œç¨‹é€šçŸ¥å…è®¸ä½ åœ¨é‡è¦äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå‘ŠçŸ¥ä½ çš„åº”ç”¨ã€‚ä½ å¯èƒ½éœ€è¦å‘é€æ–°çš„å³æ—¶æ¶ˆæ¯ï¼Œçªå‘æ–°é—»çš„æé†’ï¼Œæˆ–è€…ç”¨æˆ·å–œçˆ±ç”µè§†çš„æœ€æ–°å‰§é›†å·²ç»å¯ä»¥ä¸‹è½½ä¸€éç¦»çº¿è§‚çœ‹çš„æ¶ˆæ¯ã€‚è¿œç¨‹é€šçŸ¥å¾ˆé€‚åˆç”¨äºé‚£äº›å¶å°”å‡ºç°ï¼Œä½†å´å¾ˆé‡è¦çš„å†…å®¹ï¼Œå¦‚æœä½¿ç”¨åå°è·å–æ¨¡å¼ä¸­æœ‰ä¸¤æ¬¡è·å–é—´éœ€è¦ç­‰å¾…çš„æ—¶é—´æ˜¯ä¸å¯æ¥å—çš„è¯ï¼Œè¿œç¨‹é€šçŸ¥ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚è¿œç¨‹é€šçŸ¥ä¼šæ¯”åå°è·å–æ›´æœ‰æ•ˆç‡ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºåªæœ‰åœ¨éœ€è¦çš„æ—¶å€™çš„æ‰ä¼šå¯åŠ¨ã€‚</p>

<p>ä¸€æ¡è¿œç¨‹é€šçŸ¥å®é™…ä¸Šåªæ˜¯ä¸€æ¡æ™®é€šçš„å¸¦æœ‰content-available æ ‡å¿—çš„æ¨é€é€šçŸ¥ã€‚ä½ å¯ä»¥å‘é€ä¸€æ¡å¸¦æœ‰æé†’æ¶ˆæ¯çš„æ¨é€å»å‘Šè¯‰ç”¨æˆ·æœ‰äº‹æƒ…å‘ç”Ÿäº†ï¼ŒåŒæ—¶åœ¨åå°å¯¹ç•Œé¢è¿›è¡Œæ›´æ–°ã€‚ä½†è¿œç¨‹é€šçŸ¥ä¹Ÿå¯ä»¥åšåˆ°å®‰é™çš„ï¼Œæ²¡æœ‰æé†’æ¶ˆæ¯æˆ–è€…ä»»ä½•å£°éŸ³ çš„æƒ…å†µä¸‹ï¼Œåªå»æ›´æ–°åº”ç”¨ç•Œé¢æˆ–è€…è§¦å‘åå°å·¥ä½œã€‚ç„¶åä½ å¯ä»¥åœ¨å®Œæˆä¸‹è½½æˆ–è€…å¤„ç†å®Œæ–°å†…å®¹åï¼Œå‘é€ä¸€æ¡æœ¬åœ°é€šçŸ¥ã€‚</p>

<p>é™é»˜çš„æ¨é€é€šçŸ¥æœ‰é€Ÿåº¦é™åˆ¶ï¼Œæ‰€ä»¥ä½ å¯ä»¥å¤§èƒ†åœ°æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€è¦å‘é€å°½å¯èƒ½å¤šçš„é€šçŸ¥ã€‚ioså’Œè‹¹æœæ¨é€æœåŠ¡ä¼šæ§åˆ¶æ¨é€é€šçŸ¥å¤šä¹…è¢«é€’é€ï¼Œå‘é€å¾ˆå¤šæ¨é€é€šçŸ¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚å¦‚æœä½ çš„æ¨é€é€šçŸ¥è¾¾åˆ°äº†é™åˆ¶ï¼Œæ¨é€é€šçŸ¥å¯èƒ½ä¼šè¢«å»¶è¿Ÿï¼ŒçŸ¥é“è®¾å¤‡ä¸‹æ¬¡å‘é€ä¿æŒæ´»åŠ¨çŠ¶æ€çš„æ•°æ®åŒ…ï¼Œæˆ–è€…å—åˆ°å¦å¤–ä¸€ä¸ªé€šçŸ¥ã€‚</p>

<h2>å‘é€è¿œç¨‹é€šçŸ¥</h2>

<p>è¦å‘é€ä¸€æ¡è¿œç¨‹é€šçŸ¥ï¼Œéœ€è¦åœ¨æ¨é€é€šçŸ¥çš„æœ‰æ•ˆè´Ÿè½½è®¾ç½®contentï¼available æ ‡å¿—ã€‚contentï¼available æ ‡å¿—å’Œç”¨æ¥é€šçŸ¥æŠ¥åˆŠåº”ç”¨çš„é”®å€¼æ˜¯ä¸€æ ·çš„ã€‚å› æ­¤ï¼Œå¤§å¤šæ•°æ¨é€è„šæœ¬å’Œåº“éƒ½å·²ç»æ”¯æŒè¿œç¨‹é€šçŸ¥ã€‚å½“ä½ å‘é€ä¸€æ¡è¿œç¨‹é€šçŸ¥æ—¶ï¼Œä½ å¯èƒ½è¿˜æƒ³è¦åŒ…å«ä¸€äº›é€šçŸ¥æœ‰æ•ˆè´Ÿè½½ä¸­çš„æ•°æ®ï¼Œè®©ä½ åº”ç”¨ç¨‹åºå¯ä»¥å¼•ç”¨äº‹ä»¶ã€‚è¿™å¯ä»¥ä¸ºä½ èŠ‚çœä¸€äº›ç½‘ç»œè¯·æ±‚ï¼Œå¹¶æé«˜åº”ç”¨ç¨‹åºçš„å“åº”åº¦ã€‚</p>

<p>æˆ‘å»ºè®®åœ¨å¼€å‘çš„æ—¶å€™ï¼Œä½¿ç”¨<a href="http://nomad-cli.com/#houston">Nomand CLI&rsquo;s Houston</a>å·¥å…·å‘é€æ¨é€æ¶ˆæ¯ï¼Œå½“ç„¶ä½ å¯ä»¥ä½¿ç”¨ä½ å–œæ¬¢çš„åº“æˆ–è€…è„šæœ¬ã€‚</p>

<p>ä½ å¯ä»¥é€šè¿‡nomad-cli ruby gemæ¥å®‰è£…Houston</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem install nomad-cli</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åé€šè¿‡åŒ…å«åœ¨Nomançš„apnå®ç”¨å·¥å…·å‘é€ä¸€æ¡é€šçŸ¥:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Send a Push Notification to your Device
</span><span class='line'>apn push &lt;device token&gt; -c /path/to/key-cert.pem -n -d content-id=42</span></code></pre></td></tr></table></div></figure>


<p>åœ¨è¿™é‡Œï¼Œ-næ ‡å¿—æŒ‡å®šåº”è¯¥åŒ…å«content-available å¥å€¼,-dæ ‡å¿—å…è®¸æ·»åŠ æˆ‘ä»¬è‡ªå®šä¹‰çš„æ•°æ®é”®å€¼åˆ°æœ‰æ•ˆè´Ÿè·.
é€šçŸ¥çš„æœ‰æ•ˆè´Ÿè·(payload)ç»“æœå’Œä¸‹é¢ç±»ä¼¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>    "aps" : {
</span><span class='line'>        "content-available" : 1
</span><span class='line'>    },
</span><span class='line'>    "content-id" : 42
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ios7ä¸­æ·»åŠ äº†æ–°çš„åº”ç”¨ç¨‹åºå§”æ‰˜æ–¹æ³•ï¼Œå½“æ¥æ”¶åˆ°ä¸€æ¡å¸¦æœ‰ contentï¼availableçš„æ¨é€é€šçŸ¥æ—¶ï¼Œä¸‹é¢çš„æ–¹æ³•ä¼šè¢«è°ƒç”¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)application:(UIApplication *)application 
</span><span class='line'>  didReceiveRemoteNotification:(NSDictionary *)userInfo 
</span><span class='line'>        fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler
</span><span class='line'>{
</span><span class='line'>    NSLog(@"Remote Notification userInfo is %@", userInfo);
</span><span class='line'>
</span><span class='line'>    NSNumber *contentID = userInfo[@"content-id"];
</span><span class='line'>    // æ ¹æ® content ID è¿›è¡Œæ“ä½œ
</span><span class='line'>    completionHandler(UIBackgroundFetchResultNewData);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å’Œåå°æŠ“å–ä¸€æ ·ï¼Œåº”ç”¨ç¨‹åºè¿›å…¥åå°å¯åŠ¨ï¼Œä¹Ÿæœ‰30ç§’æ—¶é—´å»è·å–æ–°å†…å®¹å¹¶æ›´æ–°ç•Œé¢ï¼Œæœ€åè°ƒç”¨å®Œæˆçš„å¤„ç†ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥åƒåå°è·å–é‚£æ ·ï¼Œæ‰§è¡Œå¿«é€Ÿçš„ç½‘ç»œè¯·æ±‚ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–°çš„å¼ºå¤§çš„åå°ä¼ è¾“æœåŠ¡ï¼Œå¤„ç†ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸‹é¢çœ‹çœ‹æˆ‘ä»¬å¦‚ä½•åœ¨ä»»åŠ¡å®Œæˆåæ›´æ–°ç•Œé¢ã€‚</p>

<h2>NSurlSessionå’Œåå°ä¼ è¾“æœåŠ¡(Background Transfer Service)</h2>

<p>NSURLSessionæ˜¯ios7æ·»åŠ çš„ä¸€ä¸ªæ–°ç±»ï¼Œå®ƒä¹Ÿæ˜¯Foundation Networkingä¸­çš„æ–°æŠ€æœ¯ã€‚ä½œä¸ºNSURLConnectionçš„æ›¿ä»£å“ï¼Œä¸€äº›ç†Ÿæ‚‰çš„æ¦‚å¿µå’Œç±»éƒ½ä¿ç•™ä¸‹æ¥äº†ï¼Œä¾‹å¦‚NSURL,NSURLRequest,NSURLResponse.æ‰€ä»¥ï¼Œä½ å¯ä»¥ä½¿ç”¨NSURLSessionTaskè¿™ä¸€NSURLConnnectionçš„æ›¿ä»£å“ï¼Œæ¥å¤„ç†ç½‘ç»œè¯·æ±‚åŠå“åº”ã€‚ä¸€å…±æœ‰3ç§å›è¯ä»»åŠ¡ï¼šæ•°æ®ï¼Œä¸‹è½½å’Œä¸Šä¼ ã€‚æ¯ä¸€ç§éƒ½å‘NSURLSessionTaskæ·»åŠ äº†è¯­æ³•ç³–ï¼Œæ ¹æ®ä½ çš„éœ€è¦ï¼Œé€‚å½“é€‰æ‹©ä¸€ç§ã€‚</p>

<p>ä¸€ä¸ªNSURLSessionå¯¹è±¡åè°ƒä¸€ä¸ªæˆ–å¤šä¸ªNSURLSessionTaskå¯¹è±¡ï¼Œå¹¶æ ¹æ®NSURLSessionTaskåˆ›å»ºçš„NSURLSessionConfigurationå®ç°ä¸åŒçš„åŠŸèƒ½ã€‚ä½¿ç”¨ç›¸åŒçš„é…ç½®ï¼Œä½ ä¹Ÿå¯ä»¥åˆ›å»ºå¤šç»„å…·æœ‰ç›¸å…³ä»»åŠ¡çš„NSURLSessionTaskå¯¹è±¡ã€‚è¦åˆ©ç”¨åå°ä¼ è¾“æœåŠ¡ï¼Œä½ å°†ä¼šä½¿ç”¨<code>[NSURLSessionConfiguration backgroundSessionConfiguration]</code>æ¥åˆ›å»ºä¸€ä¸ªä¼šè¯é…ç½®ã€‚æ·»åŠ åˆ°åå°ä¼šè¯çš„ä»»åŠ¡åœ¨å¤–éƒ¨è¿›ç¨‹è¿è¡Œï¼Œå³ä½¿åº”ç”¨ç¨‹åºè¢«æŒ‚èµ·ï¼Œå´©æºƒï¼Œæˆ–è€…è¢«æ€æ­»ï¼Œå®ƒä¾ç„¶ä¼šè¿è¡Œã€‚</p>

<p>NSURLSessionConfigurationå…è®¸ä½ è®¾ç½®é»˜è®¤çš„HTTPå¤´ï¼Œé…ç½®ç¼“å­˜ç­–ç•¥ï¼Œé™åˆ¶ä½¿ç”¨èœ‚çªç…¤æ•°æ®ç­‰ç­‰ã€‚å…¶ä¸­ä¸€ä¸ªé€‰é¡¹æ˜¯discretionaryæ ‡å¿—ï¼Œè¿™ä¸ªæ ‡å¿—å…è®¸ç³»ç»Ÿä¸ºåˆ†é…ä»»åŠ¡è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚è¿™æ„å‘³ç€åªæœ‰å½“è®¾å¤‡è¶³å¤Ÿç”µé‡æ—¶ï¼Œè®¾å¤‡æ‰é€šè¿‡wifiè¿›è¡Œæ•°æ®ä¼ è¾“ã€‚å¦‚æœç”µé‡ä½ï¼Œæˆ–è€…åªä»…æœ‰ä¸€ä¸ªèœ‚çªè¿æ¥ï¼Œä¼ è¾“ä»»åŠ¡æ˜¯ä¸ä¼šè¿è¡Œçš„ã€‚åå°ä¼ è¾“æ€»æ˜¯åœ¨discretionaryæ¨¡å¼ä¸‹è¿è¡Œã€‚</p>

<p>ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¤§æ¦‚äº†è§£äº†NSURLSessionï¼Œä»¥åŠä¸€ä¸ªåå°å›è¯å¦‚ä½•è¿›è¡Œï¼Œæ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å›åˆ°è¿œç¨‹é€šçŸ¥çš„ä¾‹å­ï¼Œæ·»åŠ ä¸€äº›ä»£ç æ¥å¤„ç†åå°ä¼ å…¥æœåŠ¡çš„ä¸‹è½½é˜Ÿåˆ—ã€‚å½“ä¸‹è½½å®Œæˆåï¼Œæˆ‘ä»¬ä¼šé€šçŸ¥ç”¨æˆ·è¯¥æ–‡ä»¶å·²ç»å¯ä»¥ç”¨äº†ã€‚</p>

<h2>NSURLSessionDownloadTask</h2>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆå¤„ç†ä¸€æ¡è¿œç¨‹é€šçŸ¥ï¼Œå¹¶æŠŠä¸€ä¸ªNSURLSessionDownloadTaskæ·»åŠ åˆ°åå°ä¼ è¾“æœåŠ¡çš„é˜Ÿåˆ—ã€‚åœ¨backgroundURLSessionæ–¹æ³•å¼ ï¼Œæˆ‘ä»¬æ ¹æ®åå°å›è¯é…ç½®ï¼Œåˆ›å»ºä¸€ä¸ªNSURLSessionå¯¹è±¡ï¼Œå¹¶æŠŠapplication delegateä½œä¸ºå›è¯çš„å§”æ‰˜å¯¹è±¡ã€‚æ–‡æ¡£ä¸å»ºè®®å¯¹äºç›¸åŒçš„æ ‡è¯†ç¬¦(identifier)åˆ›å»ºå¤šä¸ªå›è¯å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨dispatch_onceæ¥é¿å…æ½œåœ¨çš„é—®é¢˜ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (NSURLSession *)backgroundURLSession
</span><span class='line'>{
</span><span class='line'>    static NSURLSession *session = nil;
</span><span class='line'>    static dispatch_once_t onceToken;
</span><span class='line'>    dispatch_once(&onceToken, ^{
</span><span class='line'>        NSString *identifier = @"io.objc.backgroundTransferExample";
</span><span class='line'>        NSURLSessionConfiguration* sessionConfig = [NSURLSessionConfiguration backgroundSessionConfiguration:identifier];
</span><span class='line'>        session = [NSURLSession sessionWithConfiguration:sessionConfig 
</span><span class='line'>                                                delegate:self 
</span><span class='line'>                                           delegateQueue:[NSOperationQueue mainQueue]];
</span><span class='line'>    });
</span><span class='line'>
</span><span class='line'>    return session;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)           application:(UIApplication *)application 
</span><span class='line'>  didReceiveRemoteNotification:(NSDictionary *)userInfo 
</span><span class='line'>        fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler
</span><span class='line'>{
</span><span class='line'>    NSLog(@"Received remote notification with userInfo %@", userInfo);
</span><span class='line'>
</span><span class='line'>    NSNumber *contentID = userInfo[@"content-id"];
</span><span class='line'>    NSString *downloadURLString = [NSString stringWithFormat:@"http://yourserver.com/downloads/%d.mp3", [contentID intValue]];
</span><span class='line'>    NSURL* downloadURL = [NSURL URLWithString:downloadURLString];
</span><span class='line'>
</span><span class='line'>    NSURLRequest *request = [NSURLRequest requestWithURL:downloadURL];
</span><span class='line'>    NSURLSessionDownloadTask *task = [[self backgroundURLSession] downloadTaskWithRequest:request];
</span><span class='line'>    task.taskDescription = [NSString stringWithFormat:@"Podcast Episode %d", [contentID intValue]];
</span><span class='line'>    [task resume];
</span><span class='line'>
</span><span class='line'>    completionHandler(UIBackgroundFetchResultNewData);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬ä½¿ç”¨NSURLSessionç±»æ–¹æ³•åˆ›å»ºçˆ±ä½ ä¸€ä¸ªä¸‹è½½ä»»åŠ¡ï¼Œé…ç½®è¯·æ±‚ï¼Œå¹¶æä¾›è¯´æ˜ä¾›ä»¥åä½¿ç”¨ã€‚å› ä¸ºæ‰€æœ‰å›è¯ä»»åŠ¡ä¸€å¼€å§‹å¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œä½ å¿…é¡»è°¨è®°è¦è°ƒç”¨[task resume]ä¿è¯å¼€å§‹äº†ä»»åŠ¡ã€‚</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å®ç° NSURLSessionDownloadDelegate çš„å§”æ‰˜æ–¹æ³•ï¼Œå½“ä¸‹è½½å®Œæˆæ—¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°ã€‚å¦‚æœä½ éœ€è¦å¤„ç†è®¤è¯æˆ–ä¼šè¯ç”Ÿå‘½å‘¨æœŸçš„å…¶ä»–äº‹ä»¶ï¼Œä½ å¯èƒ½è¿˜éœ€è¦å®ç°NSURLSessionDelegateæˆ–NSURLSessionTaskDelegateçš„æ–¹æ³•ï¼Œä½ åº”è¯¥é˜…è¯»Appleçš„<a href="https://developer.apple.com/library/ios/documentation/cocoa/Conceptual/URLLoadingSystem/NSURLSessionConcepts/NSURLSessionConcepts.html#//apple_ref/doc/uid/10000165i-CH2-SW42">Life Cycle of a URL Session with Custom Delegates</a>æ–‡æ¡£ï¼Œå®ƒè®²è§£äº†æ‰€æœ‰ç±»å‹å›è¯ä»»åŠ¡çš„å®Œæˆç”Ÿå‘½å‘¨æœŸã€‚</p>

<p>NSURLSessionDownloadDelegateä¸­çš„å§”æ‰˜æ–¹æ³•å…¨éƒ¨æ˜¯å¿…é¡»å®ç°çš„ï¼Œå°½ç®¡åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬åªéœ€è¦ç”¨åˆ° [NSURLSession downloadTask:didFinishDownloadingToURL:]ã€‚ä»»åŠ¡å®Œæˆä¸‹è½½æ—¶ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªç£ç›˜ä¸Šè¯¥æ–‡ä»¶çš„ä¸´æ—¶URL.ä½ å¿…é¡»æŠŠè¿™ä¸ªæ–‡ä»¶ç§»åŠ¨æˆ–å¤åˆ¶ä½ çš„åº”ç”¨ç¨‹åºç©ºé—´ï¼Œå› ä¸ºå½“ä½ ä»è¿™ä¸ªå§”æ‰˜æ–¹æ³•è¿”å›æ—¶ï¼Œè¯¥æ–‡ä»¶å°†ä»ä¸´æ—¶å­˜å‚¨ä¸­åˆ é™¤ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#Pragma Mark - NSURLSessionDownloadDelegate
</span><span class='line'>
</span><span class='line'>- (void)         URLSession:(NSURLSession *)session 
</span><span class='line'>               downloadTask:(NSURLSessionDownloadTask *)downloadTask
</span><span class='line'>  didFinishDownloadingToURL:(NSURL *)location
</span><span class='line'>{
</span><span class='line'>    NSLog(@"downloadTask:%@ didFinishDownloadingToURL:%@", downloadTask.taskDescription, location);
</span><span class='line'>
</span><span class='line'>    // ç”¨ NSFileManager å°†æ–‡ä»¶å¤åˆ¶åˆ°åº”ç”¨çš„å­˜å‚¨ä¸­
</span><span class='line'>    // ...
</span><span class='line'>
</span><span class='line'>    // é€šçŸ¥ UI åˆ·æ–°
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)  URLSession:(NSURLSession *)session 
</span><span class='line'>        downloadTask:(NSURLSessionDownloadTask *)downloadTask 
</span><span class='line'>   didResumeAtOffset:(int64_t)fileOffset 
</span><span class='line'>  expectedTotalBytes:(int64_t)expectedTotalBytes
</span><span class='line'>{
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)         URLSession:(NSURLSession *)session 
</span><span class='line'>               downloadTask:(NSURLSessionDownloadTask *)downloadTask 
</span><span class='line'>               didWriteData:(int64_t)bytesWritten totalBytesWritten:(int64_t)totalBytesWritten 
</span><span class='line'>  totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite
</span><span class='line'>{
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å½“åå°ä¼šè¯ä»»åŠ¡å®Œæˆæ—¶ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºä»ç„¶åœ¨å‰å°è¿è¡Œï¼Œä¸Šé¢çš„ä»£ç å·²ç»è¶³å¤Ÿäº†ã€‚ç„¶è€Œï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ çš„åº”ç”¨ç¨‹åºå¯èƒ½æ˜¯æ²¡æœ‰è¿è¡Œçš„ï¼Œæˆ–è€…åœ¨åå°è¢«æŒ‚èµ·ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½ å¿…é¡»å®ç°åº”ç”¨ç¨‹åºå§”æ‰˜çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™æ ·ç³»ç»Ÿå°±å¯ä»¥å”¤é†’ä½ çš„åº”ç”¨ç¨‹åºã€‚ä¸åŒäºä»¥å¾€çš„å§”æ‰˜å›è°ƒï¼Œè¯¥åº”ç”¨ç¨‹åºå§”æ‰˜ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œå› ä¸ºæ‚¨çš„ä¼šè¯å’Œä»»åŠ¡å§”æ‰˜å¯èƒ½ä¼šå—åˆ°ä¸€ç³»åˆ—æ¶ˆæ¯ã€‚App delegateçš„: handleEventsForBackgroundURLSessionï¼šæ–¹æ³•ä¼šåœ¨è¿™äº›NSURLSessionå§”æ‰˜çš„æ¶ˆæ¯å‘é€å‰è¢«è°ƒç”¨ï¼Œç„¶åURLSessionDidFinishEventsForBackgroundURLSessionåœ¨éšåè¢«è°ƒç”¨ã€‚åœ¨å‰é¢çš„æ–¹æ³•ä¸­ï¼ŒåŒ…å«äº†ä¸€ä¸ªåå°å®Œæˆçš„å›è°ƒï¼ˆcompletionHandlerï¼‰,å¹¶åœ¨åé¢çš„æ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒä»¥ä¾¿æ›´æ–°ç•Œé¢:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)                  application:(UIApplication *)application 
</span><span class='line'>  handleEventsForBackgroundURLSession:(NSString *)identifier completionHandler:(void (^)())completionHandler
</span><span class='line'>{
</span><span class='line'>    // ä½ å¿…é¡»é‡æ–°å»ºç«‹ä¸€ä¸ªåå° seesiong çš„å‚ç…§
</span><span class='line'>    // å¦åˆ™ NSURLSessionDownloadDelegate å’Œ NSURLSessionDelegate æ–¹æ³•ä¼šå› ä¸º
</span><span class='line'>    // æ²¡æœ‰ å¯¹ session çš„ delegate è®¾å®šè€Œä¸ä¼šè¢«è°ƒç”¨ã€‚å‚è§ä¸Šé¢çš„ backgroundURLSession
</span><span class='line'>    NSURLSession *backgroundSession = [self backgroundURLSession];
</span><span class='line'>
</span><span class='line'>    NSLog(@"Rejoining session with identifier %@ %@", identifier, backgroundSession);
</span><span class='line'>
</span><span class='line'>    // ä¿å­˜ completion handler ä»¥åœ¨å¤„ç† session äº‹ä»¶åæ›´æ–° UI
</span><span class='line'>    [self addCompletionHandler:completionHandler forSession:identifier];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)URLSessionDidFinishEventsForBackgroundURLSession:(NSURLSession *)session
</span><span class='line'>{
</span><span class='line'>    NSLog(@"Background URL session %@ finished events.\n", session);
</span><span class='line'>
</span><span class='line'>    if (session.configuration.identifier) {
</span><span class='line'>        // è°ƒç”¨åœ¨ -application:handleEventsForBackgroundURLSession: ä¸­ä¿å­˜çš„ handler
</span><span class='line'>        [self callCompletionHandlerForSession:session.configuration.identifier];
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)addCompletionHandler:(CompletionHandlerType)handler forSession:(NSString *)identifier
</span><span class='line'>{
</span><span class='line'>    if ([self.completionHandlerDictionary objectForKey:identifier]) {
</span><span class='line'>        NSLog(@"Error: Got multiple handlers for a single session identifier.  This should not happen.\n");
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    [self.completionHandlerDictionary setObject:handler forKey:identifier];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)callCompletionHandlerForSession: (NSString *)identifier
</span><span class='line'>{
</span><span class='line'>    CompletionHandlerType handler = [self.completionHandlerDictionary objectForKey: identifier];
</span><span class='line'>
</span><span class='line'>    if (handler) {
</span><span class='line'>        [self.completionHandlerDictionary removeObjectForKey: identifier];
</span><span class='line'>        NSLog(@"Calling completion handler for session %@", identifier);
</span><span class='line'>
</span><span class='line'>        handler();
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœå½“åå°ä¼ è¾“å®Œæˆæ—¶ï¼Œåº”ç”¨ç¨‹åºä¸å†åœç•™åœ¨å‰å°ï¼Œé‚£ä¹ˆå¯¹äºæ›´æ–°ç¨‹åºç•Œé¢æ¥è¯´ï¼Œè¿™ä¸ªä¸¤æ­¥å¤„ç†è¿‡ç¨‹æ˜¯å¿…è¦çš„ã€‚æ­¤å¤–ï¼Œå¦‚æœå½“åå°ä¼ è¾“å®Œæˆæ—¶ï¼Œåº”ç”¨é™ˆè°·æ ¹æœ¬æ²¡æœ‰åœ¨è¿è¡Œï¼Œioså°†ä¼šåœ¨åå°å¯åŠ¨è¯¥åº”ç”¨ç¨‹åºï¼Œç„¶åå‰é¢çš„åº”ç”¨ç¨‹åºå’Œä¼šè¯çš„å§”æ‰˜æ–¹æ³•ä¼šåœ¨application:didFinishLaunchingWithOptions: æ–¹æ³•è¢«è°ƒç”¨ä¹‹åè¢«è°ƒç”¨.</p>

<h2>é…ç½®å’Œé™åˆ¶</h2>

<p>æˆ‘ä»¬ç®€å•åœ°ä½“éªŒäº†åå°ä¼ è¾“çš„å¼ºå¤§ä¹‹å¤„ï¼Œä½†ä½ åº”è¯¥æ·±å…¥æ–‡æ¡£ï¼Œé˜…è¯»NSURLSessionConfigurationéƒ¨åˆ†ï¼Œä»¥ä¾¿æœ€å¥½æ»´æ»¡è¶³ä½ çš„ä½¿ç”¨åœºæ™¯ã€‚ä¾‹å¦‚:NSURLSessionTasksé€šè¿‡NSURLSessionConfigurationçš„timeoutIntervalForResourceå±æ€§ï¼Œæ”¯æŒèµ„æºè¶…æ—¶ç‰¹æ€§ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§æŒ‡å®šä½ å…è®¸å®Œæˆä¸€ä¸ªä¼ è¾“æ‰€éœ€çš„æœ€é•¿æ—¶é—´ã€‚å†…å®¹åªåœ¨æœ‰é™çš„æ—¶é—´å¯ç”¨ï¼Œæˆ–è€…åœ¨ç”¨æˆ·åªæœ‰æœ‰é™wifiå®½å¸¦çš„æ—¶é—´å†…æ— æ³•ä¸‹è½½æˆ–ä¸Šä¼ èµ„æºçš„æƒ…å†µä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ã€‚</p>

<p>é™¤äº†ä¸‹è½½ä»»åŠ¡ï¼ŒNSURLSessionä¹Ÿå…¨é¢æ”¯æŒä¸Šä¼ ä»»åŠ¡ï¼Œå› æ­¤ï¼Œä½ å¯èƒ½ä¼šåœ¨åå°å°†è§†é¢‘ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œè¿™ä¿è¯ç”¨æˆ·ä¸éœ€è¦å†åƒios6é‚£æ ·ä¿æŒåº”ç”¨ç¨‹åºå‰å°è¿è¡Œã€‚å¦‚æœå½“ä¼ è¾“å®Œæˆæ—¶ä½ çš„åº”ç”¨ç¨‹åºä¸éœ€è¦å†åå°è¿è¡Œï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„åšæ³•æ˜¯,æŠŠNSURLSessionConfigurationçš„sessionSendsLaunchEventså±æ€§è®¾ç½®ä¸ºNOã€‚é«˜æ•ˆåˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œæ˜¯ä¸€ä»¶è®©Ioså’Œç”¨æˆ·éƒ½é«˜å…´çš„äº‹ã€‚</p>

<p>æœ€åï¼Œæˆ‘ä»¬æ¥è¯´ä¸€è¯´ä½¿ç”¨åå°ä¼šè¯çš„å‡ ä¸ªé™åˆ¶ã€‚ä½œä¸ºä¸€ä¸ªå¿…é¡»å®ç°çš„å§”æ‰˜ï¼Œæ‚¨ä¸èƒ½å¯¹NSURLSessionçš„ä½¿ç”¨ç®€å•çš„åŸºäºblockçš„å›è°ƒæ–¹æ³•ã€‚åå°å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œæ˜¯ç›¸å¯¹è€—è´¹è¾ƒå¤šèµ„æºçš„ï¼Œæ‰€ä»¥æ€»æ˜¯é‡‡ç”¨Httpé‡å®šå‘ã€‚åå°ä¼ è¾“æœåŠ¡åªæ”¯æŒHTTPå’ŒHTTPSï¼Œä½ ä¸èƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„åè®®ã€‚ç³»ç»Ÿä¼šæ ¹æ®å¯ç”¨çš„èµ„æºè¿›è¡Œä¼˜åŒ–ï¼Œåœ¨ä»»ä½•æ—¶å€™ä½ éƒ½ä¸èƒ½å¼ºåˆ¶ä¼ è¾“ä»»åŠ¡åœ¨åå°è¿›è¡Œã€‚</p>

<p>å¦å¤–ï¼Œè¦æ³¨æ„çš„æ˜¯åœ¨åå°å›è¯ä¸­ï¼ŒNSURLSessionDataTasksæ˜¯å®Œå…¨ä¸æ”¯æŒçš„ï¼Œä½ åº”è¯¥åªå¤„äºçŸ­æœŸçš„ï¼Œå°è¯·æ±‚ä¸ºç›®çš„çš„ä½¿ç”¨è¿™äº›ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç”¨æ¥ä¸‹è½½æˆ–ä¸Šä¼ ã€‚</p>

<h2>æ€»ç»“</h2>

<p>åœ¨ios7ä¸­å¼ºå¤§çš„å¤šä»»åŠ¡å’Œç½‘ç»œAPIä¸ºç°æœ‰åº”ç”¨å’Œæ–°åº”ç”¨å¼€å¯äº†ä¸€ç³»åˆ—å…¨æ–°çš„å¯èƒ½æ€§ã€‚å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå¯ä»¥ä»è¿›ç¨‹å¤–çš„ç½‘ç»œä¼ è¾“å’Œæ•°æ®ä¸­è·ç›Šï¼Œé‚£ä¹ˆå°½æƒ…åœ°ä½¿ç”¨è¿™äº›ç¾å¦™çš„APIï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥å°±åƒä½ çš„åº”ç”¨æ­£åœ¨å‰å°è¿è¡Œé‚£æ ·å»å®ç°åå°ä¼ è¾“ï¼Œå¹¶è¿›è¡Œé€‚å½“çš„ç•Œé¢æ›´æ–°ï¼Œè€Œè¿™é‡Œç»å¤§å¤šæ•°çš„å·¥ä½œéƒ½å·²ç»ä¸ºä½ å®Œæˆäº†ã€‚</p>

<ul>
<li>ä½¿ç”¨é€‚å½“çš„æ–°çš„APIæ¥ä¸ºä½ çš„åº”ç”¨ç¨‹åºæä¾›å†…å®¹</li>
<li>å°½å¯èƒ½æ—©åœ°è°ƒç”¨completion handlerä»¥æé«˜æ•ˆç‡</li>
<li>è®©completion handerä¸ºåº”ç”¨ç¨‹åºæ›´æ–°ç•Œé¢å¿«ç…§</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AsynDisplayKitå…¥é—¨ç¯‡]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/15/asyndisplaykitru-men-pian/"/>
    <updated>2016-04-15T10:22:30+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/15/asyndisplaykitru-men-pian</id>
    <content type="html"><![CDATA[<h2>å‰è¨€</h2>

<p>FaceBookçš„Paperå›¢é˜Ÿç»™æˆ‘ä»¬å¼€æºäº†ä¸€ä¸ªå¾ˆæ£’çš„åº“:<a href="https://github.com/facebook/AsyncDisplayKit">AsynDisplayKit</a>,è¿™ä¸ªåº“èƒ½è®©ä½ é€šè¿‡å°†å›¾åƒè§£ç ï¼Œå¸ƒå±€ä»¥åŠæ¸²æŸ“æ“ä½œéƒ½æ”¾åˆ°åå°çº¿ç¨‹å¤„ç†ï¼Œä»è€Œå¸¦æ¥äº†å¿«é€Ÿå“åº”çš„ç”¨æˆ·ç•Œé¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸å†ä¼šå› ä¸ºç•Œé¢å¡é¡¿å°”é˜»æ–­ç”¨æˆ·äº¤äº’ã€‚</p>

<!--more-->


<p>ä¾‹å¦‚ï¼Œå¯¹äºéå¸¸å¤æ‚çš„ç•Œé¢ï¼Œä½ å¯ä»¥ä½¿ç”¨ AsyncDisplayKitæ„å»ºå®ƒè€Œå¾—åˆ°ä¸€ç§å¦‚ä¸èˆ¬é¡ºæ»‘çš„ï¼Œ60å¸§æ¯ç§’çš„æ»‘åŠ¨ä½“éªŒã€‚è€Œå¹³å¸¸çš„UIkitä¼˜åŒ–å°±ä¸å¤ªå¯èƒ½å…‹æœè¿™æ ·çš„æ€§èƒ½æŒ‘æˆ˜ã€‚</p>

<p>ä»æœ¬æ•™ç¨‹ä¸­ï¼Œä½ å°†ä»ä¸€ä¸ªåˆå§‹é¡¹ç›®å¼€å§‹ï¼Œå®ƒä¸»è¦æœ‰ä¸€ä¸ªUICollectionViewçš„æ»‘åŠ¨é—®é¢˜ï¼Œè€Œä½¿ç”¨AysncDisplayKitå°†å¤§å¤§æä¾›å…¶æ»‘åŠ¨æ€§èƒ½ã€‚ä¸€è·¯ä¸Šï¼Œä½ å°†å­¦ä¼šå¦‚ä½•åœ¨æ—§é¡¹ç›®ä¸Šä½¿ç”¨AsyncDisplaykit.</p>

<blockquote><p><em>æ³¨æ„</em>ï¼Œåœ¨æœ¬æ•™ç¨‹ä¹‹å‰ï¼Œä½ åº”è¯¥ç†Ÿæ‚‰ Swift,Core Animationä»¥åŠCore Graphics.</p></blockquote>

<h2>å¼€å§‹</h2>

<p>å¼€å§‹ä¹‹å‰ï¼Œè¯·å…ˆçœ‹çœ‹<a href="https://code.facebook.com/posts/721586784561674/introducing-asyncdisplaykit-for-smooth-and-responsive-apps-on-ios/">AsyncDisplayKitä»‹ç»</a>,å¯¹å®ƒæœ‰ä¸ªç®€è¦çš„æ¦‚å¿µï¼ŒçŸ¥é“å®ƒæ˜¯è§£å†³ä»€ä¹ˆé—®é¢˜çš„ã€‚</p>

<p>å‡†å¤‡å¥½äº†ï¼Œå°±ä¸‹è½½<a href="http://www.raywenderlich.com/wp-content/uploads/2015/04/Layers-Start.zip">å¼€å§‹é¡¹ç›®</a>,ä½ éœ€è¦è‡³å°‘Xcode6.1å’ŒiosSDK 8.1æ¥ç¼–è¯‘å®ƒï¼Œå¦‚æœç”¨æœ€æ–°Xcodeæ‰“å¼€ï¼Œswiftè¯­æ³•éœ€è¦åšä¸‹è½¬æ¢å’Œä¿®æ”¹ï¼Œè¯·è‡ªè¡Œè§£å†³è¿™äº›å…¼å®¹é—®é¢˜.</p>

<p>ä½ è¦ç ”ç©¶çš„é¡¹ç›®æ˜¯ç”±UICollectionViewåˆ¶ä½œçš„å¡ç‰‡å¼ç•Œé¢æ¥æè¿°ä¸åŒçš„é›¨æ—åŠ¨ç‰©ï¼Œæ¯å¼ ä¿¡æ¯å¡ä¸ŠåŒ…å«äº†ä¸€ä¸ªå›¾ç‰‡ï¼Œåå­—ä»¥åŠä¸€ä¸ªé˜Ÿé›¨æ—åŠ¨ç‰©çš„æè¿°ï¼Œå¡ç‰‡çš„èƒŒæ™¯å›¾æ˜¯ä¸»å›¾ç‰‡çš„æ¨¡ç³Šæ„Ÿï¼Œè§†è§‰ä¸Šè®¾è®¡çš„æ•ˆæœä¿è¯äº†æ–‡å­—çš„æ¸…æ™°å¯è¯»ã€‚</p>

<p><img src="http://cc.cocimg.com/api/uploads/20141124/1416797117122129.png" alt="logo" />
åœ¨Xcodeä¸­ï¼Œæ‰“å¼€åˆå§‹é¡¹ç›®çš„ Layers.xcworkspaceã€‚</p>

<p>åœ¨æœ¬æ•™ç¨‹é‡Œï¼Œè¯·éµå¾ªä»¥ä¸‹åŸåˆ™ä»¥ä½“ä¼šAsyncDisplayKitçš„é‚£äº›ååˆ†å¸å¼•äººçš„å¥½å¤„ã€‚</p>

<p>å°†åº”ç”¨è¿è¡Œåˆ°çœŸæœºä¸Šï¼Œåœ¨æ¨¡æ‹Ÿå™¨ä¸Šå¾ˆéš¾çœ‹å‡ºæ€§èƒ½æ”¹å–„ã€‚</p>

<p>åº”ç”¨æ˜¯é€šç”¨çš„ï¼Œä½†åœ¨ipadä¸Šçœ‹èµ·æ¥æœ€å¥½ã€‚</p>

<p>æœ€åï¼Œè¦çœŸæ­£æ„Ÿè°¢è¿™ä¸ªåº“ä¸ºä½ æ‰€æœ‰çš„äº‹æƒ…ï¼Œè¯·å°½é‡åœ¨æœ€æ—§çš„ios8.1çš„è®¾å¤‡ä¸Šå»è¿è¡Œè¯¥åº”ç”¨ï¼Œç¬¬ä¸‰ä»£çš„ipadæœ€å¥½ï¼Œå› ä¸ºå®ƒéšè®©æ˜¯è§†ç½‘è†œå±ï¼Œä½†æ˜¯è¿è¡Œçš„ä¸æ˜¯å¾ˆå¿«ã€‚</p>

<p>è¿è¡Œè¯¥é¡¹ç›®ï¼Œæ•ˆæœå¦‚ä¸‹:</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0002.png" alt="logo" /></p>

<p>è¯•ç€æ»‘åŠ¨CollectionVieå¹¶æ³¨æ„é‚£å¯æ€œçš„å¸§ç‡ï¼Œåœ¨ç¬¬ä¸‰ä»£ipadä¸Šï¼Œå¸§ç‡åªæœ‰15-20FPSï¼Œå®åœ¨ä¸¢æ‰å¤ªå¤šå¸§äº†ï¼Œåœ¨æœ¬æ•™ç¨‹çš„æœ€åï¼Œä½ èƒ½åœ¨60 FPSçš„å¸§ç‡ä¸‹æ»‘åŠ¨å®ƒ.</p>

<blockquote><p><em>æ³¨æ„</em>
ä½ æ‰€çœ‹åˆ°çš„å›¾åƒéƒ½æ˜¯åœ¨Appçš„assetç›®å½•é‡Œï¼Œå¹¶ä¸æ˜¯ä»ç½‘ç»œé‡Œè·å–çš„ã€‚</p></blockquote>

<p>åœ¨ä¸€ä¸ªæ—§é¡¹ç›®ä¸­ä½¿ç”¨AsyncDisplayKitå‰ï¼Œä½ åº”è¯¥é€šè¿‡Instrumentsæµ‹é‡ä½ çš„UIçš„æ€§èƒ½ï¼Œè¿™æ ·æ‰èƒ½æœ‰ä¸€ä¸ªåŸºå‡†çº¿ä»¥ä¾¿å¯¹æ¯”æ”¹åŠ¨çš„æ•ˆæœã€‚</p>

<p>æœ€é‡è¦çš„æ˜¯ï¼Œä½ è¦çŸ¥é“æ˜¯CPU-ç»‘å®šï¼Œè¿˜æ˜¯GPU-ç»‘å®šï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯CPUè¿˜æ˜¯GPUæ‹‰ä½äº†åº”ç”¨çš„å¸§ç‡ï¼Œè¿™ä¸ªä¿¡æ¯ä¼šå‘Šè¯‰ä½ è¯¥å……åˆ†åˆ©ç”¨AsyncDisplayKitçš„é‚£ä¸ªç‰¹æ€§ä»¥ä¼˜åŒ–åº”ç”¨çš„æ€§èƒ½ã€‚</p>

<p>å¦‚æœä½ æœ‰æ—¶é—´ï¼Œçœ‹çœ‹ä¹‹å‰æåˆ°çš„WWDC2012 session æˆ–åœ¨çœŸå®çš„è®¾å¤‡ä¸Šä½¿ç”¨Instrumentsæ¥è¯„ä¼°åˆå§‹é¡¹ç›®çš„æ—¶é—´æ›²çº¿ã€‚æ»‘åŠ¨æ€§èƒ½æ˜¯CPU-ç»‘å®šçš„ï¼Œä½ èƒ½çŒœåˆ°æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´äº† CollectionView ä¸¢æ‰äº†è¿™ä¹ˆå¤šå¸§å—?</p>

<h2>ä¸ºé¡¹ç›®å‡†å¤‡å¥½ä½¿ç”¨ AsyncDisplayKit</h2>

<p>åœ¨æ—§é¡¹ç›®é‡Œä½¿ç”¨AsyncDisplayKitï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ä½¿ç”¨ Display Node å±‚çº§ç»“æ„æ›¿æ¢è§†å›¾å±‚çº§ç»“æ„æˆ–Layeræ ‘ï¼Œå„ç§Display Nodeæ˜¯AsyncDisplayKitçš„å…³é”®æ‰€åœ¨ï¼Œå®ƒä»¬ä½äºè§†å›¾ä¹‹ä¸Šï¼Œè€Œä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¹‹å‰åœ¨ä¸»çº¿ç¨‹æ‰èƒ½æ‰§è¡Œçš„ä»»åŠ¡ç°åœ¨ä¹Ÿå¯ä»¥åœ¨éä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚è¿™å°±æ˜¯å‡å°‘ä¸»çº¿ç¨‹çš„å·¥ä½œé‡ä»¥æ‰§è¡Œå…¶å®ƒæ“ä½œï¼Œä¾‹å¦‚å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œæˆ–å¦‚ä¸‹æœ¬åº”ç”¨çš„æƒ…å†µä¸‹ï¼Œå¤„ç†CollectionViewçš„æ»‘åŠ¨ã€‚</p>

<p>è¿™å°±æ„å‘³ç€åœ¨æœ¬æ•™ç¨‹é‡Œï¼Œä½ çš„ç¬¬ä¸€æ­¥æ˜¯ç§»é™¤è§†å›¾å±‚çº§ç»“æ„ã€‚</p>

<h3>ç§»é™¤è§†å›¾çš„å±‚æ¬¡ç»“æ„</h3>

<p>æ‰“å¼€ RainForestCardCell.Swiftå¹¶åˆ é™¤awakeFromNib() ä¸­æ‰€æœ‰çš„ addSubview(&hellip;.)è°ƒç”¨ï¼Œç„¶åå¾—åˆ°å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func awakeFromNib() {
</span><span class='line'>  super.awakeFromNib()
</span><span class='line'>  contentView.layer.borderColor =
</span><span class='line'>    UIColor(hue: 0, saturation: 0, brightness: 0.85, alpha: 0.2).CGColor
</span><span class='line'>  contentView.layer.borderWidth = 1
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œæ›¿æ¢LayoutSubviews()çš„å†…å®¹å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func layoutSubviews() {
</span><span class='line'>  super.layoutSubviews()
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å†è®²configureCellDisplayWithCardInfo(cardInfo:)çš„å†…å®¹æ›¿æ¢å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func configureCellDisplayWithCardInfo(cardInfo: RainforestCardInfo) {
</span><span class='line'>  //MARK: Image Size Section
</span><span class='line'>  let image = UIImage(named: cardInfo.imageName)!
</span><span class='line'>  featureImageSizeOptional = image.size
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>åˆ é™¤RainforestCardCellçš„æ‰€æœ‰è§†å›¾å±æ€§ï¼Œåªç•™ä¸€ä¸ªå¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RainforestCardCell: UICollectionViewCell {
</span><span class='line'>  var featureImageSizeOptional: CGSize?
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æœ€åç¼–è¯‘è¿è¡Œï¼Œä½ çœ‹çš„çš„æ˜¯é»‘æ´æ´çš„ä¸€ç‰‡:</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0001.jpg" alt="logo" /></p>

<p>ç°åœ¨æ‰€æœ‰çš„celléƒ½ç©ºäº†ï¼Œæ»‘åŠ¨èµ·æ¥å°±å¾ˆé¡ºæ»‘ï¼Œä½ çš„ç›®æ ‡æ˜¯ä¿è¯ä¹‹åæ·»åŠ å®Œå„ä¸ªNodeä¹‹åï¼Œä¾ç„¶é¡ºæ»‘å¦‚åˆã€‚</p>

<h3>æ·»åŠ ä¸€ä¸ªå ä½å›¾</h3>

<p>æ‰“å¼€RainforestCardCell.swift,ç»™RainforestCardCellæ·»åŠ ä¸€ä¸ªå¯é€‰çš„ CALayerå˜é‡ï¼Œåä¸ºplaceholderLayerï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RainforestCardCell: UICollectionViewCell {
</span><span class='line'>  var featureImageSizeOptional: CGSize?
</span><span class='line'>  var placeholderLayer: CALayer!
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä½ ä¹‹æ‰€ä»¥éœ€è¦ä¸€ä¸ªå ä½å›¾æ˜¯å› ä¸ºæ˜¾ç¤ºä¼šå¼‚æ­¥å®Œæˆï¼Œå¦‚æœè¿™ä¸ªè¿‡ç¨‹éœ€è¦ä¸€äº›æ—¶é—´ï¼Œé‚£ç”¨æˆ·å°±ä¼šçœ‹åˆ°ç©ºçš„cell ã€‚å°±å¦‚åŒå¦‚æœä½ è¦ä»ç½‘ç»œä¸Šè·å–å›¾åƒï¼Œé‚£ä¹ˆå°±éœ€è¦ç”¨å ä½å›¾æ¥å¡«å……Cell,è¿™èƒ½è®©ä½ çš„ç”¨æˆ·çŸ¥é“å†…å®¹è¿˜æ²¡å‡†å¤‡å¥½ã€‚éšè®©åœ¨æˆ‘ä»¬è¿™ç§æƒ…å†µä¸‹ï¼Œä½ æ˜¯åœ¨åå°çº¿ç¨‹ç»˜åˆ¶è€Œä¸æ˜¯ä»ç½‘ç»œä¸Šä¸‹è½½ã€‚</p>

<p>åœ¨awakeFromNib()é‡Œï¼Œåˆ é™¤contentViewçš„borderè®¾ç½®ï¼Œå†åˆ›å»ºå¹¶é…ç½®ä¸€ä¸ªplaceholderLayer.å°†å…¶æ·»åŠ åˆ°cellçš„contentviewçš„layerä¸Šï¼Œç°åœ¨è¿™ä¸ªæ–¹æ³•å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func awakeFromNib() {
</span><span class='line'>  super.awakeFromNib()
</span><span class='line'> 
</span><span class='line'>  placeholderLayer = CALayer()
</span><span class='line'>  placeholderLayer.contents = UIImage(named: "cardPlaceholder")!.CGImage
</span><span class='line'>  placeholderLayer.contentsGravity = kCAGravityCenter
</span><span class='line'>  placeholderLayer.contentsScale = UIScreen.mainScreen().scale
</span><span class='line'>  placeholderLayer.backgroundColor = UIColor(hue: 0, saturation: 0, brightness: 0.85, alpha: 1).CGColor
</span><span class='line'>  contentView.layer.addSublayer(placeholderLayer)
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>åœ¨layoutSubviews()é‡Œï¼Œä½ éœ€è¦å¸ƒå±€placeholderLayer.æ›¿æ¢è¿™ä¸ªæ–¹æ³•ä¸º:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func layoutSubviews() {
</span><span class='line'>  super.layoutSubviews()
</span><span class='line'> 
</span><span class='line'>  placeholderLayer?.frame = bounds
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘å¹¶è¿è¡Œï¼Œä½ ä»è™šæ— çš„è¾¹ç¼˜å›æ¥äº†:
<img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0003.png" alt="logo" /></p>

<p>æ™®é€šçš„CALayerä¸æ˜¯ç”±UIviewæ”¯æŒçš„ï¼Œå½“å®ƒä»¬æ”¹å˜frameæ—¶ï¼Œé»˜è®¤ä¼šæœ‰éšå¼åŠ¨ç”»ï¼Œè¿™å°±æ˜¯ä½ çœ‹åˆ°layeråœ¨å¸ƒå±€æ”¾å¤§æ—¶ï¼Œè¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œæ”¹åŠ¨layoutSubviews()å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func layoutSubviews() {
</span><span class='line'>  super.layoutSubviews()
</span><span class='line'> 
</span><span class='line'>  CATransaction.begin()
</span><span class='line'>  CATransaction.setValue(kCFBooleanTrue, forKey: kCATransactionDisableActions)
</span><span class='line'>  placeholderLayer?.frame = bounds
</span><span class='line'>  CATransaction.commit()
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œé—®é¢˜è§£å†³äº†ã€‚</p>

<p>ç°åœ¨å ä½å›¾ä¸ä¼šä¹±åŠ¨ï¼Œä¸å†åŠ¨ç”»å®ƒä»¬çš„frameäº†ã€‚</p>

<h2>ç¬¬ä¸€ä¸ªNode</h2>

<p>é‡å»ºAppçš„ç¬¬ä¸€æ­¥å°±æ˜¯ç»™æ¯ä¸€ä¸ªUICollectionView cell æ·»åŠ ä¸€ä¸ªèƒŒæ™¯å›¾ç‰‡çš„Node,æ­¥éª¤å¦‚ä¸‹:</p>

<ol>
<li>åˆ›å»ºï¼Œå¸ƒå±€å¹¶æ·»åŠ ä¸€ä¸ªå›¾åƒNodeåˆ°UICollectionView cell</li>
<li>å¤„ç†cellé‡ç”¨Nodeå’Œå®ƒä»¬çš„layer</li>
<li>æ¨¡ç³Šå›¾åƒNode</li>
</ol>


<p>ä½†åœ¨åšä¹‹å‰ï¼Œæ‰“å¼€ Layers-Bridging-Header.h å¹¶å¯¼å…¥ AsyncDisplayKit :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#import &lt;AsyncDisplayKit/AsyncDisplayKit.h&gt;
</span><span class='line'>#import &lt;AsyncDisplayKit/_ASDisplayLayer.h&gt;</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¼šè®©æ‰€æœ‰çš„Swiftæ–‡ä»¶éƒ½èƒ½è®¿é—®AsyncDisplayKitç±»åº“ã€‚</p>

<p>ç¼–è¯‘ä¸€ä¸‹ï¼Œç¡®ä¿æ²¡æœ‰é”™è¯¯</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹Collectin Viewçš„ç¥–æˆ:</p>

<ul>
<li>View Controller: RainforestViewControlleræ²¡æœ‰ä»€ä¹ˆèŠ±å“¨çš„ä¸œè¥¿ï¼Œå®ƒåªæ˜¯ä¸ºæ‰€æœ‰çš„é›¨æ—å¡ç‰‡è·å–ä¸€ä¸ªæ•°æ®æ•°ç»„ï¼Œå¹¶ä¸ºUIcollectioNViewå®ç°DataSource.äº‹å®ä¸Šï¼Œä½ ä¸éœ€è¦èŠ±å¤ªå¤šæ—¶é—´åœ¨è¿™ä¸ªä¸Š</li>
<li>DataSource:å¤§éƒ¨åˆ†æ—¶é—´éƒ½å°†èŠ±åœ¨Cellç±»çš„RainforestCardCellä¸Šï¼ŒViewControllerå‡ºé˜Ÿæ¯ä¸ªcellï¼Œå¹¶å°†é›¨æ—å¡ç‰‡çš„æ•°æ®ç”¨configureCellDisplayWithCardInfo(cardInfo:) ä¼ ç»™å®ƒã€‚cellå°±ä½¿ç”¨è¿™ä¸ªæ•°æ®æ¥é…ç½®è‡ªèº«.</li>
<li>Cell: åœ¨configureCellDisplayWithCardInfo(cardInfo:)é‡Œï¼Œcellåˆ›å»ºï¼Œé…ç½®ï¼Œå¸ƒå±€ä»¥åŠæ·»åŠ Nodeåˆ°å®ƒè‡ªå·±èº«ä¸Šã€‚è¿™å°±æ„å‘³ç€æ¯æ¬¡ViewControllerå‡ºé˜Ÿä¸€ä¸ªcell,è¿™ä¸ªcellå°±ä¼šåˆ›å»ºå¹¶æ·»åŠ å®ƒè‡ªå·±ä¸€ä¸ªæ–°çš„Nodeå±‚çº§ç»“æ„</li>
</ul>


<p>å¦‚æœä½ ä½¿ç”¨Viewè€Œä¸æ˜¯Nodeï¼Œé‚£ä¹ˆè¿™æ ·åšå¯¹äºæ€§èƒ½æ¥è¯´å°±ä¸æ˜¯æœ€ä½³ç­–ç•¥ã€‚ä½†å› ä¸ºä½ å¯ä»¥å¼‚æ­¥çš„åˆ›å»ºï¼Œé…ç½®ä»¥åŠå¸ƒå±€ï¼Œè€Œä¸”Nodeä¹Ÿæ˜¯å¼‚æ­¥åœ°ç»˜åˆ¶ï¼Œæ‰€ä»¥è¿™ä¸ä¼šæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚çœŸæ­£çš„éš¾ç‚¹æ˜¯åœ¨cellå‡†å¤‡é‡ç”¨æ—¶å–æ¶ˆä»»ä½•åœ¨è¿›è¡Œé¢å¼‚æ­¥æ“ä½œå¹¶ç§»é™¤æ—§çš„node.</p>

<p>ç„¶è€Œï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œä½ æœ€å¥½ä½¿ç”¨ASRangeControlleræ¥ç¼“å­˜ä½ çš„Node,è¿™æ ·ä½ å°±ä¸ç”¨æ¯æ¬¡åœ¨cellé‡ç”¨æ—¶é‡å»ºå®ƒçš„Nodeå±‚çº§ç»“æ„ï¼ŒASRangeControllerè¶…å‡ºäº†æœ¬æ•™ç¨‹çš„èŒƒå›´ã€‚</p>

<p>OKï¼ŒåŠ¨æ‰‹!</p>

<h3>æ·»åŠ èƒŒæ™¯å›¾ç‰‡Node</h3>

<p>ç°åœ¨ä½ è¦èµ°ä¸€éç”¨Nodeé…ç½®cellçš„è¿‡ç¨‹ï¼Œä¸€æ¬¡ä¸€æ­¥ï¼š
æ‰“å¼€RainforestCardCell.swift å¹¶æ›¿æ¢configureCellDisplayWithCardInfo(cardInfo:) ä¸º:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func configureCellDisplayWithCardInfo(cardInfo: RainforestCardInfo) {
</span><span class='line'>  //MARK: Image Size Section
</span><span class='line'>  let image = UIImage(named: cardInfo.imageName)!
</span><span class='line'>  featureImageSizeOptional = image.size
</span><span class='line'> 
</span><span class='line'>  //MARK: Node Creation Section
</span><span class='line'>  let backgroundImageNode = ASImageNode()
</span><span class='line'>  backgroundImageNode.image = image
</span><span class='line'>  backgroundImageNode.contentMode = .ScaleAspectFill
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±åˆ›å»ºå¹¶é…ç½®äº†ä¸€ä¸ªASImageNodeå¸¸é‡ï¼Œå«åšbackgroundImageNode.</p>

<p>AsyncDisplayKitå¸¦æœ‰å¥½å‡ ç§Nodeç±»å‹ï¼ŒåŒ…æ‹¬ASImageNodeï¼Œç”¨äºæ˜¾ç¤ºå›¾ç‰‡ã€‚å®ƒç›¸å½“äºUIImageView,é™¤äº†ASImageNodeæ˜¯é»˜è®¤å¼‚æ­¥çš„è§£ç å›¾ç‰‡ã€‚</p>

<p>æ·»åŠ å¦‚ä¸‹ä»£ç åˆ°configureCellDisplayWithCardInfo(cardInfo:) åº•éƒ¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>backgroundImageNode.layerBacked = true</span></code></pre></td></tr></table></div></figure>


<p>è¿™è®©backgroundImageNodeå˜ä¸ºlayeræ”¯æŒçš„Node.</p>

<p>Nodeå¯ç”±UIviewæ”¯æŒæˆ–CALayeræ”¯æŒï¼Œå½“nodeéœ€è¦å¤„ç†äº‹ä»¶æ—¶ï¼ˆä¾‹å¦‚è§¦æ‘¸äº‹ä»¶ï¼‰ï¼Œä½ å°±è¦ä½¿ç”¨UIViewæ”¯æŒçš„Node.å¦‚æœä½ ä¸éœ€è¦å¤„ç†äº‹ä»¶ï¼Œåªéœ€è¦æ˜¾ç¤ºä¸€ä¸‹å†…å®¹ï¼Œé‚£ä½¿ç”¨Layeræ”¯æŒçš„Nodeä¼šæ›´åŠ è½»é‡ï¼Œå› æ­¤å¯ä»¥è·å¾—ä¸€ä¸ªå°çš„æ€§èƒ½æå‡ã€‚</p>

<p>å› ä¸ºæœ¬æ•™ç¨‹çš„APPä¸éœ€è¦å¤„ç†äº‹ä»¶ï¼Œæ‰€ä»¥ä½ å¯ä»¥è®©æ‰€æœ‰çš„Nodeéƒ½è®¾ç½®ä¸ºLayeræ”¯æŒçš„ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œç”±äºbackgroundImageNodeä¸ºLayeræ”¯æŒçš„ã€‚AsyncDisplayKitä¼šåˆ›å»ºä¸€ä¸ªCALayerç”¨äºé›¨æ—åŠ¨ç‰©å›¾åƒå†…å®¹çš„æ˜¾ç¤º.</p>

<p>ç»§ç»­åœ¨ configureCellDisplayWithCardInfo(cardInfo:)æ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//MARK:Â NodeÂ LayoutÂ Section
</span><span class='line'>backgroundImageNode.frameÂ =Â FrameCalculator.frameForContainer(featureImageSize:Â image.size)</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œä½¿ç”¨FrameCalculatorä¸ºbackgroundImageNodeå¸ƒå±€.</p>

<p>FrameCalculatoræ˜¯ä¸€ä¸ªå¸®åŠ©ç±»ï¼Œè´Ÿè´£ç»™æ¯ä¸ªNodeå¸ƒå±€ã€‚æ³¨æ„æ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯æ‰‹åŠ¨å¸ƒå±€çš„ï¼Œæ²¡æœ‰ä½¿ç”¨AutoLayoutçº¦æŸã€‚<strong>å¦‚æœä½ éœ€è¦æ„å»ºè‡ªé€‚åº”å¸ƒå±€æˆ–è€…æœ¬åœ°åŒ–é©±åŠ¨çš„å¸ƒå±€ï¼Œé‚£å°±è¦æ³¨æ„ï¼Œå› ä¸ºä½ ä¸èƒ½ç»™Nodeæ·»åŠ çº¦æŸ</strong></p>

<p>æ¥ä¸‹æ¥ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç åˆ°configureCellDisplayWithCardInfo(cardInfo:)åº•éƒ¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//MARK: Node Layer and Wrap Up Section
</span><span class='line'>self.contentView.layer.addSublayer(backgroundImageNode.layer)</span></code></pre></td></tr></table></div></figure>


<p>è¿™å¥å°†backgroundImageNodeçš„layeræ·»åŠ åˆ°cell ContentViewçš„layerä¸Šã€‚</p>

<blockquote><p><strong>æ³¨æ„</strong>
AsyncDisplayKitä¼šä¸ºbackgroundImageNodeåˆ›å»ºä¸€ä¸ªLayer.ç„¶è€Œï¼Œä½ å¿…é¡»è¦å°†Nodeæ”¾åˆ°æŸä¸ªLayeræ ‘ä¸­æ‰èƒ½åœ¨å±å¹•ä¸Šæ˜¾ç¤ºï¼Œè¿™ä¸ªNodeä¼šå¼‚æ­¥åœ°ç»˜åˆ¶ï¼Œæ‰€ä»¥ç›´åˆ°ç»˜åˆ¶å®Œæˆï¼Œå®ƒçš„å†…å®¹éƒ½ä¸ä¼šæ˜¾ç¤ºï¼Œå°½ç®¡å®ƒçš„Layerå·²ç»åœ¨ä¸€ä¸ªLayeræ ‘ä¸­ã€‚</p></blockquote>

<p>ä»æŠ€æœ¯çš„è§’åº¦æ¥è¯´ï¼Œlayerä¸€ç›´éƒ½å­˜åœ¨ã€‚ä½†æ¸²æŸ“å›¾åƒæ˜¯å¼‚æ­¥è¿›è¡Œçš„ã€‚layeråˆå§‹åŒ–æ—¶æ²¡æœ‰å†…å®¹ï¼Œä¸€æ—¦æ¸²æŸ“å®Œæˆï¼Œlayerçš„contentså°±ä¼šæ›´æ–°ä¸ºåŒ…å«å›¾åƒçš„å†…å®¹ã€‚</p>

<p>åœ¨è¿™ä¸ªç‚¹ï¼Œcellçš„contentViewçš„layerå°†ä¼šåŒ…å«ä¸¤ä¸ªSublayer:ä¸€ä¸ªå ä½å›¾å’ŒNodeçš„layerã€‚åœ¨nodeå®Œæˆç»˜åˆ¶å‰ï¼Œåªæœ‰å ä½å›¾ä¼šæ˜¾ç¤ºã€‚</p>

<p>æ³¨æ„åˆ°configureCellDisplayWithCardInfo(cardInfo:)ä¼šåœ¨æ¯æ¬¡cellå‡ºé˜Ÿæ—¶è¢«è°ƒç”¨ã€‚æ¯æ¬¡cellè¢«å›æ”¶ï¼Œè¿™ä¸ªé€»è¾‘ä¼šæ·»åŠ ä¸€ä¸ªæ–°çš„sublayeråˆ°cellçš„contentview layerä¸Šã€‚ä¸è¦æ‹…å¿ƒï¼Œä½ å¾ˆå¿«ä¼šè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>

<p>å›åˆ°RainforestCardCell.swiftå¼€å¤´ï¼Œç»™RainforestCardCellæ·»åŠ ä¸€ä¸ªASImageNodeå˜é‡å­˜ä¸ºå±æ€§backgroundImageNodeï¼Œå¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RainforestCardCell: UICollectionViewCell {
</span><span class='line'>  var featureImageSizeOptional: CGSize?
</span><span class='line'>  var placeholderLayer: CALayer!
</span><span class='line'>  var backgroundImageNode: ASImageNode? ///&lt; ADD THIS LINE
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä½ ä¹‹æ‰€ä»¥éœ€è¦è¿™ä¸ªå±æ€§æ˜¯å› ä¸ºå¿…é¡»è¦æœ‰æŸä¸ªä¸œè¥¿å°†backgroundImageNodeçš„å¼•ç”¨ä¿ç•™ä½ï¼Œå¦åˆ™ARCå°±ä¼šå°†å…¶é‡Šæ”¾ï¼Œä¹Ÿå°±ä¸ä¼šæœ‰ä»»ä½•ä¸œè¥¿æ˜¾ç¤ºå‡ºæ¥äº†&ndash;å³ä½¿Nodeçš„åœ¨ä¸€ä¸ªlayeræ ‘ä¸­ï¼Œä½ ä¾ç„¶éœ€è¦ä¿ç•™Node.</p>

<p>åœ¨configureCellDisplayWithCardInfo(cardInfo:)åº•éƒ¨çš„Node Layer and Wrap Up Section ,è®¾ç½®cellæ–°çš„backgroundImageNodeä¸ºä¹‹å‰çš„backgroundImageNodeï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>self.backgroundImageNode = backgroundImageNode</span></code></pre></td></tr></table></div></figure>


<p>ä¸‹é¢æ˜¯å®Œæ•´çš„configureCellDisplayWithCardInfo(cardInfo:) æ–¹æ³•ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func configureCellDisplayWithCardInfo(cardInfo: RainforestCardInfo) {
</span><span class='line'>  //MARK: Image Size Section
</span><span class='line'>  let image = UIImage(named: cardInfo.imageName)!
</span><span class='line'>  featureImageSizeOptional = image.size
</span><span class='line'> 
</span><span class='line'>  //MARK: Node Creation Section
</span><span class='line'>  let backgroundImageNode = ASImageNode()
</span><span class='line'>  backgroundImageNode.image = image
</span><span class='line'>  backgroundImageNode.contentMode = .ScaleAspectFill
</span><span class='line'>  backgroundImageNode.layerBacked = true
</span><span class='line'> 
</span><span class='line'>  //MARK: Node Layout Section
</span><span class='line'>  backgroundImageNode.frame = FrameCalculator.frameForContainer(featureImageSize: image.size)
</span><span class='line'> 
</span><span class='line'>  //MARK: Node Layer and Wrap Up Section
</span><span class='line'>  self.contentView.layer.addSublayer(backgroundImageNode.layer)
</span><span class='line'>  self.backgroundImageNode = backgroundImageNode
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œè§‚å¯ŸAsyncDisplaytKitæ˜¯å¦‚ä½•å¼‚æ­¥åœ°ä½¿ç”¨å›¾åƒè®¾ç½®Layerçš„Contentsçš„ã€‚è¿™èƒ½è®©ä½ åœ¨CPUè¿˜åœ¨ç»˜åˆ¶layerçš„å†…å®¹çš„åŒäº‹ä¸Šä¸‹æ»‘åŠ¨é¡µé¢ã€‚</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0006.png" alt="logo" /></p>

<p>å¦‚æœä½ è¿è¡Œåœ¨æ—§è®¾å¤‡ä¸Šï¼Œæ³¨æ„å›¾åƒæ˜¯å¦‚ä½•å¼¹å‡ºåˆ°ä½ç½®&ndash;è¿™æ˜¯çˆ†ç±³èŠ±æ•ˆæœï¼Œä½†ä¸æ€»æ˜¯è®©äººå–œæ¬¢ã€‚æœ¬æ•™ç¨‹çš„æœ€åä¸€èŠ‚å°†ä¼šæå®šè¿™ä¸ªä¸ä»¤äººæ„‰å¿«çš„å¼¹å‡ºæ•ˆæœï¼Œç»™ä½ å±•ç¤ºå›¾åƒå¦‚ä½•å¼¹å…¥å¼¹å‡ºï¼Œå¦‚åŒæ‘‡æ»šå·¨æ˜Ÿã€‚</p>

<p>å¦‚åŒä¹‹å‰æ‰€è®¨è®ºçš„ï¼Œæ–°çš„Nodeä¼šåœ¨æ¯æ¬¡cellè¢«é‡ç”¨æ—¶åˆ›å»ºï¼Œè¿™å¹¶ä¸ç†æƒ³ï¼Œå› ä¸ºè¿™æ„å‘³ç€æ–°çš„Layerä¼šåœ¨æ¯æ¬¡cellè¢«é‡ç”¨æ—¶åŠ å…¥ã€‚</p>

<p>å¦‚æœä½ æƒ³çœ‹çœ‹Sublayerå †ç§¯å¤ªå¤šçš„å½±å“ï¼Œé‚£å°±ä¸åœçš„æ»‘ä¸Šæ»‘ä¸‹ï¼Œç„¶ååŠ æ–­ç‚¹æ‰“å°å‡ºcellçš„contentviewçš„Layerçš„sublayerså±æ€§ã€‚ä½ ä¼šçœ‹åˆ°å¾ˆå¤šlayer,è¿™ä¸å¥½.</p>

<h2>å¤„ç†cellé‡ç”¨</h2>

<p>ç»§ç»­RainforestCardCell.swift,ç»™RainforestCardCell æ·»åŠ ä¸€ä¸ªcontentLayerçš„CALayerå±æ€§ï¼Œè¿™ä¸ªå±æ€§ä¹Ÿæ˜¯ä¸€ä¸ªå¯é€‰ç±»å‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RainforestCardCell: UICollectionViewCell {
</span><span class='line'>  var featureImageSizeOptional: CGSize?
</span><span class='line'>  var placeholderLayer: CALayer!
</span><span class='line'>  var backgroundImageNode: ASImageNode?
</span><span class='line'>  var contentLayer: CALayer? ///&lt; ADD THIS LINE
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä½ å°†ä½¿ç”¨æ­¤å±æ€§å»ç§»é™¤Cellçš„ContentViewçš„Layeræ ‘ä¸­æ—§çš„Node Layer.è™½ç„¶ä½ å¯ä»¥ç®€å•åœ°ä¿ç•™Nodeå¹¶è®¿é—®å…¶Layerå±æ€§ï¼Œä½†ä¸Šé¢çš„å†™æ³•æ›´åŠ æ˜ç¡®ã€‚</p>

<p>æ·»åŠ å¦‚ä¸‹ä»£ç åˆ°configureCellDisplayWithCardInfo(cardInfo:) ç»“å°¾ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>self.contentLayer = backgroundImageNode.layer</span></code></pre></td></tr></table></div></figure>


<p>è¿™å¥è®©backgroundImageNodeçš„Layerä¿ç•™åˆ°contentLayerå±æ€§ã€‚</p>

<p>æ›¿æ¢prepareForReuse()çš„å®ç°å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func prepareForReuse() {
</span><span class='line'>  super.prepareForReuse()
</span><span class='line'>  backgroundImageNode?.preventOrCancelDisplay = true
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å› ä¸ºAsyncDisplaytKitèƒ½å¤Ÿå¼‚æ­¥åœ°ç»˜åˆ¶Node,æ‰€ä»¥Nodeè®©ä½ èƒ½é¢„é˜²ä»å¤´ç»˜åˆ¶æˆ–å–æ¶ˆä»»ä½•åœ¨è¿›è¡Œçš„ç»˜åˆ¶ã€‚æ— è®ºæ˜¯ä½ éœ€è¦é¢„é˜²æˆ–å–æ¶ˆç»˜åˆ¶ï¼Œéƒ½å¯å°†preventOrcancelDisplayè®¾ç½®ä¸ºtrue,å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œåœ¨æœ¬æ¥ä¸­ï¼Œä½ è¦åœ¨cellè¢«é‡ç”¨å‰å–æ¶ˆä»»ä½•æ­£åœ¨è¿›è¡Œçš„ç»˜åˆ¶æ´»åŠ¨.</p>

<p>æ¥ä¸‹æ¥ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç åˆ°prepareForReuseï¼ˆï¼‰å°¾éƒ¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>contentLayer?.removeFromSuperlayer()</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°†contentLayerä»å…¶SuperLayer(ä¹Ÿå°±æ˜¯contentviewçš„Layer)ä¸­ç§»é™¤.</p>

<p>æ¯æ¬¡ä¸€ä¸ªcellè¢«å›æ”¶æ—¶ï¼Œè¿™ä¸ªä»£ç å°±ç§»é™¤Nodeçš„æ—§Layer,å› è€Œè§£å†³äº†å †ç§¯é—®é¢˜ã€‚æ‰€ä»¥åœ¨ä»»ä½•æ—¶é—´ï¼Œä½ çš„Nodeæœ€å¤šåªæœ‰ä¸¤ä¸ªsublayer:å ä½å›¾å’ŒNodeçš„Layer.</p>

<p>æ¥ä¸‹æ¥æ·»åŠ å¦‚ä¸‹ä»£ç åˆ°prepareForReuse()å°¾éƒ¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>contentLayer = nil
</span><span class='line'>backgroundImageNode = nil</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç¡®ä¿cellé‡Šæ”¾å®ƒä»¬çš„å¼•ç”¨ï¼Œè¿™æ ·å¦‚æœ‰å¿…è¦ï¼ŒARCæ‰å¥½åšæ¸…ç†å·¥ä½œã€‚</p>

<p>ç¼–è¯‘è¿è¡Œï¼Œè¿™æ¬¡ï¼Œæ²¡æœ‰sublayerä¼šå †ç§¯çš„é—®é¢˜ï¼Œä¸”æ‰€æœ‰ä¸å¿…è¦çš„ç»˜åˆ¶éƒ½å°†è¢«å–æ¶ˆ.</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0006.png" alt="logo" /></p>

<p>æ˜¯æ—¶å€™æ¥ç‚¹æ¨¡ç³Šæ•ˆæœäº†!
<img src="http://www.raywenderlich.com/wp-content/uploads/2014/11/asyncscroll.png" alt="blue" /></p>

<h2>æ¨¡ç³Šå›¾åƒ</h2>

<p>è¦å®ç°æ¨¡ç³Šå›¾åƒï¼Œä½ è¦æ·»åŠ ä¸€ä¸ªé¢å¤–çš„æ­¥éª¤åˆ°å›¾åƒNodeçš„æ˜¾ç¤ºè¿‡ç¨‹é‡Œã€‚</p>

<p>ç»§ç»­RainforestCardCell.swift ,åœ¨configureCellDisplayWithCardInfo(cardInfo:) çš„è®¾ç½®backgroundImageNode.layerBacked çš„åé¢ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>backgroundImageNode.imageModificationBlock = { input in
</span><span class='line'>  if input == nil {
</span><span class='line'>    return input
</span><span class='line'>  }
</span><span class='line'>  if let blurredImage = input.applyBlurWithRadius(
</span><span class='line'>    30,
</span><span class='line'>    tintColor: UIColor(white: 0.5, alpha: 0.3),
</span><span class='line'>    saturationDeltaFactor: 1.8,
</span><span class='line'>    maskImage: nil, 
</span><span class='line'>    didCancel:{ return false }) {
</span><span class='line'>      return blurredImage
</span><span class='line'>  } else {
</span><span class='line'>    return image
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ASImageNodeçš„imageModificationBlockç»™ä½ ä¸€ä¸ªç§¯æ°´åœ¨æ˜¾ç¤ºä¹‹å‰å»å¤„ç†åº•å±‚çš„å›¾åƒï¼Œè¿™æ˜¯éå¸¸å®ç”¨çš„åŠŸèƒ½ï¼Œå®ƒè®©ä½ å¯¹å›¾åƒNodeåšä¸€äº›æ“ä½œï¼Œä¾‹å¦‚æ·»åŠ æ»¤é•œç­‰ã€‚</p>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä½ ä½¿ç”¨imageModificationBlockæ¥ä¸ºcellçš„èƒŒæ™¯å›¾åƒåº”ç”¨æ¨¡ç³Šæ•ˆæœã€‚å…³é”®ç‚¹å°±æ˜¯å›¾åƒNodeå°†ä¼šç»˜åˆ¶å®ƒçš„å†…å®¹å¹¶åœ¨åå°æ‰§è¡Œè¿™ä¸ªé—­åŒ…ï¼Œè€Œä¸»çº¿ç¨‹ä¾ç„¶é¡ºæ»‘æµç•…ã€‚è¿™ä¸ªé—­åŒ…æ¥å—åŸå§‹çš„UIImageå¹¶è¿”å›ä¸€ä¸ªä¿®æ”¹è¿‡çš„UIimage.</p>

<p>ä¸Šé¢çš„ä»£ç ä½¿ç”¨äº†UIImageçš„æ¨¡ç³Šcategory,å®ƒç”±Appleåœ¨WWDC2013æä¾›ã€‚ä½¿ç”¨äº†Accelerate framework åœ¨CPUä¸Šæ¨¡ç³Šå›¾åƒã€‚å› ä¸ºæ¨¡ç³Šä¼šæ¶ˆè€—å¾ˆå¤šæ—¶é—´å’Œå†…å­˜ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„categoryè¢«ä¿®æ”¹ä¸ºåŒ…å«äº†å–æ¶ˆæœºåˆ¶ã€‚è¿™ä¸ªæ¨¡ç³Šæ–¹æ³•å°†å®šæœŸè°ƒç”¨didCancelé—­åŒ…æ¥å†³å®šæ˜¯å¦åº”è¯¥åœæ­¢æ¨¡ç³Šã€‚</p>

<p>ç°åœ¨ï¼Œä¸Šé¢çš„ä»£ç ç»™didCancelç®€å•åœ°è¿”å›false,ä¹‹åä½ å¯ä»¥é‡å†™didCancelé—­åŒ….</p>

<blockquote><p><em>æ³¨æ„</em>
è¿˜è®°å¾—ç¬¬ä¸€æ¬¡è¿è¡ŒAPPæ—¶collectionViewé‚£å¯æ€œçš„æ»‘åŠ¨æ•ˆæœå—ï¼Ÿæ¨¡ç³Šæ–¹æ³•é˜»å¡äº†ä¸»çº¿ç¨‹ã€‚é€šè¿‡ä½¿ç”¨AsyncDisplayKitå°†æ¨¡ç³Šæ”¾å…¥åå°çº¿ç¨‹ï¼Œä½ å°±å¤§å¹…åº¦åœ°æé«˜äº†CollectionViewçš„æ»‘åŠ¨æ€§èƒ½ã€‚ç®€ç›´å¤©å£¤ä¹‹åˆ«ã€‚</p></blockquote>

<p>ç¼–è¯‘å¹¶è¿è¡Œï¼Œè§‚å¯Ÿæ¨¡ç³Šæ•ˆæœ:
<img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0009.png" alt="lgo" />
æ³¨æ„ä½ å¯ä»¥éå¸¸æµç•…çš„æ»‘åŠ¨é¡µé¢äº†</p>

<p>å½“Collectionviewå‡ºé˜Ÿä¸€ä¸ªcellæ—¶ï¼Œä¸€ä¸ªæ¨¡ç³Šæ“ä½œå°†å¼€å§‹åå°çº¿ç¨‹ï¼Œå½“ç”¨æˆ·å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼ŒCollectionViewä¼šé‡ç”¨æ¯ä¸ªcellå¤šæ¬¡ï¼Œå¹¶å¼€å§‹è®¸å¤šæ¨¡ç³Šæ“ä½œã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨cellå‡†å¤‡é‡ç”¨æ—¶å–æ¶ˆæ­£åœ¨è¿›è¡Œä¸­çš„æ¨¡ç³Šæ“ä½œã€‚</p>

<p>ä½ å·²ç»åœ¨prepareForReuse()é‡Œå–æ¶ˆäº†Nodeçš„ç»˜åˆ¶æ“ä½œï¼Œä½†ä¸€æ—¦æ§åˆ¶è¢«ç§»äº¤ç»™å¤„ç†ä½ å›¾åƒä¿®æ”¹çš„é—­åŒ…ï¼Œé‚£å°±æ˜¯ä½ çš„è´£ä»»æ¥å¤„ç†Nodeçš„preventOrCancelDisplayçš„è®¾ç½®ã€‚</p>

<h2>å–æ¶ˆæ¨¡ç³Šæ“ä½œ</h2>

<p>è¦å–æ¶ˆè¿›è¡Œä¸­çš„æ¨¡ç³Šæ“ä½œï¼Œä½ éœ€è¦å®ç°æ¨¡ç³Šæ–¹æ³•çš„didCancelé—­åŒ….</p>

<p>æ·»åŠ ä¸€ä¸ªæ•è·åˆ—è¡¨åˆ°imageModificationBlockä»¥æ•æ‰ä¸€ä¸ªbackgroundImageNodeçš„weakå¼•ç”¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>backgroundImageNode.imageModificationBlock = { [weak backgroundImageNode] input in
</span><span class='line'>   ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä½ éœ€å•Šå“Ÿweakå¼•ç”¨æ¥é¿å…é—­åŒ…å’Œå›¾åƒNodeä¹‹é—´çš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚ä½ å°†ä½¿ç”¨è¿™ä¸ªweak  backgroundImageNode æ¥ç¡®å®šæ˜¯å¦è¦å–æ¶ˆæ¨¡ç³Šæ“ä½œã€‚</p>

<p>æ˜¯æ—¶å€™æ„å»ºæ¨¡ç³Šå–æ¶ˆç¢§æ³¢å•Šäº†ã€‚æ·»åŠ å¦‚ä¸‹ä»£ç åˆ°imageModificationBlock:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>backgroundImageNode.imageModificationBlock = { [weak backgroundImageNode] input in
</span><span class='line'>  if input == nil {
</span><span class='line'>    return input
</span><span class='line'>  }
</span><span class='line'> 
</span><span class='line'>  // ADD FROM HERE...
</span><span class='line'>  let didCancelBlur: () -&gt; Bool = {
</span><span class='line'>    var isCancelled = true
</span><span class='line'>    // 1
</span><span class='line'>    if let strongBackgroundImageNode = backgroundImageNode {
</span><span class='line'>      // 2
</span><span class='line'>      let isCancelledClosure = {
</span><span class='line'>        isCancelled = strongBackgroundImageNode.preventOrCancelDisplay
</span><span class='line'>      }
</span><span class='line'> 
</span><span class='line'>      // 3
</span><span class='line'>      if NSThread.isMainThread() {
</span><span class='line'>        isCancelledClosure()
</span><span class='line'>      } else {
</span><span class='line'>        dispatch_sync(dispatch_get_main_queue(), isCancelledClosure)
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>    return isCancelled
</span><span class='line'>  }
</span><span class='line'>  // ...TO HERE
</span><span class='line'> 
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸‹é¢è§£é‡Šä¸€ä¸‹è¿™äº›ä»£ç ï¼š</p>

<ol>
<li>å¾—åˆ°backgroundImageNodeçš„Strongå¼•ç”¨ï¼Œå‡†å¤‡å…¶å¹²æ´»ã€‚å¦‚æœbackgroundImageNodeåœ¨æœ¬æ¬¡è¿è¡Œæ—¶å°æ—¶ï¼Œé‚£ä¹ˆisCancelledå°†ä¿æŒä¸ºtrue,ç„¶åæ¨¡ç³Šæ“ä½œä¼šè¢«å–æ¶ˆï¼Œå¦‚æœæ²¡æœ‰Nodeéœ€è¦æ˜¾ç¤ºï¼Œè‡ªç„¶æ²¡æœ‰å¿…è¦ç»§ç»­æ¨¡ç³Šæ“ä½œã€‚</li>
<li>åœ¨æ­¤ä½ å°†æ“ä½œå–æ¶ˆæ£€æŸ¥åŒ…åœ¨é—­åŒ…é‡Œï¼Œå› ä¸ºä¸€æ—¦Nodeåˆ›å»ºå®ƒçš„Layeræˆ–Viewï¼Œé‚£å°±åªèƒ½åœ¨ä¸»çº¿ç¨‹è®¿é—®Nodeçš„å±æ€§ã€‚ç”±äºä½ éœ€è¦è®¿é—®preventOrCancelDisplayï¼Œæ‰€ä»¥ä½ å¿…é¡»åœ¨ä¸»çº¿ç¨‹æ£€æŸ¥ã€‚</li>
<li>æœ€åï¼Œç¡®ä¿isCancelledClosureæ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œï¼Œæ— è®ºæ˜¯åœ¨ä¸»çº¿ç¨‹ç›´æ¥è¿è¡Œï¼Œè¿˜æ˜¯ä¸å†ä¸»çº¿ç¨‹è€Œé€šè¿‡dispatch_syncæ¥è°ƒåº¦ã€‚å®ƒå¿…é¡»æ˜¯ä¸€ä¸ªåŒæ­¥çš„è°ƒåº¦ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦é—­åŒ…å®Œæˆï¼Œå¹¶åœ¨didCancelblueé—­åŒ…è¿”å›ä¹‹å‰è®¾ç½®isCancelled.</li>
</ol>


<p>åœ¨è°ƒç”¨applyBlurWithRadius(&hellip;)ä¸­ï¼Œä¿®æ”¹ä¼ é€’ç»™didCancelçš„å‚æ•°ï¼Œæ›¿æ¢ä¸€ç›´è¿”å›falseçš„é—­åŒ…ä¸ºä½ åˆšæ‰å®šä¹‰å¹¶ä¿ç•™åœ¨didCancelBlurçš„é—­åŒ…ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let blurredImage = input.applyBlurWithRadius(
</span><span class='line'>  30,
</span><span class='line'>  tintColor: UIColor(white: 0.5, alpha: 0.3),
</span><span class='line'>  saturationDeltaFactor: 1.8,
</span><span class='line'>  maskImage: nil,
</span><span class='line'>  didCancel: didCancelBlur) {
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œä½ çœ‹ä½ ä¸ä¼šæ³¨æ„åˆ°å¤ªå¤šå·®åˆ«ï¼Œä½†ç°åœ¨ä»»ä½•åœ¨cellç¦»å¼€å±å¹•æ—¶è¿˜æœªå®Œæˆçš„æ¨¡ç³Šéƒ½ä¼šè¢«å–æ¶ˆäº†ã€‚è¿™å°±æ„å‘³ç€è®¾å¤‡æ¯”ä¹‹å‰åšçš„æ›´å°‘ã€‚ä½ å¯èƒ½è§‚å¯Ÿåˆ°è½»å¾®çš„æ€§èƒ½æå‡ï¼Œç‰¹åˆ«æ˜¯åœ¨è¾ƒæ…¢çš„è®¾å¤‡å¦‚ç¬¬ä¸‰ä»£iPadä¸Šè¿è¡Œã€‚</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0009.png" alt="logo" /></p>

<p>ä½ çš„å¡ç‰‡éœ€è¦å†…å®¹ï¼Œé€šè¿‡ä¸‹é¢å››ä¸ªå°èŠ‚ï¼Œä½ å°†å­¦ä¼š:</p>

<ul>
<li>åˆ›å»ºä¸€ä¸ªå®¹å™¨Node,å®ƒå°†æ‰€æœ‰çš„SubNodeç»˜åˆ¶åˆ°ä¸€ä¸ªå•ç‹¬çš„CALayeré‡Œ</li>
<li>æ„å»ºä¸€ä¸ªNodeå±‚æ¬¡ç»“æ„</li>
<li>åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ASDispalyNodeå­ç±»ï¼Œå¹¶åœ¨åå°æ„å»ºå¹¶å¸ƒå±€Nodeå±‚æ¬¡ç»“æ„</li>
</ul>


<p>åšå®Œè¿™äº›ï¼Œä½ å°±ä¼šå¾—åˆ°ä¸€ä¸ªçœ‹èµ·æ¥å’Œæ·»åŠ AsyncDisplayKitä¹‹å‰ä¸€æ ·çš„APPï¼Œä½†æœ‰ç€é»„æ²¹ç‰ˆé¡ºæ»‘çš„æ»‘åŠ¨ä½“éªŒã€‚</p>

<h2>æ …æ ¼åŒ–çš„å®¹å™¨Node</h2>

<p>ç›´åˆ°ç°åœ¨ï¼Œä½ ä¸€ç›´åœ¨æ“ä½œcellå†…çš„ä¸€ä¸ªå•ç‹¬çš„Nodeï¼Œæ¥ä¸‹æ¥ï¼Œä½ å°†åˆ›å»ºä¸€ä¸ªå®¹å™¨Nodeï¼Œå®ƒä¼šåŒ…å«æ‰€æœ‰å¡ç‰‡å†…å®¹ã€‚</p>

<h3>æ·»åŠ ä¸€ä¸ªå®¹å™¨Node</h3>

<p>ç»§ç»­ RainforestCardCell.swift,åœ¨ configureCellDisplayWithCardInfo(cardInfo:) çš„backgroundImageNode.imageModificationBlockåé¢ä»¥åŠNode Layout Sectionå‰é¢æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//MARK: Container Node Creation Section
</span><span class='line'>let containerNode = ASDisplayNode()
</span><span class='line'>containerNode.layerBacked = true
</span><span class='line'>containerNode.shouldRasterizeDescendants = true
</span><span class='line'>containerNode.borderColor = UIColor(hue: 0, saturation: 0, brightness: 0.85, alpha: 0.2).CGColor
</span><span class='line'>containerNode.borderWidth = 1</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±åˆ›å»ºå¹¶é…ç½®äº†ä¸€ä¸ªå«åšcontainerNodeçš„ASDisplayNodeå¸¸é‡ã€‚æ³¨æ„è¿™ä¸ªå®¹å™¨çš„shouldRasterizeDescendants,è¿™æ˜¯ä¸€ä¸ªå…³äºèŠ‚ç‚¹å¦‚ä½•å·¥ä½œçš„æç¤ºä»¥åŠä¸€ä¸ªå¦‚ä½•è®©å®ƒä»¬å·¥ä½œçš„æ›´å¥½çš„æœºä¼š.</p>

<p>å¦‚å•è¯<code>descendants (å­å­™)</code>æ‰€æš—ç¤ºçš„ï¼Œä½ å¯ä»¥åˆ›å»º AsyncDisplayKit Nodeçš„å±‚æ¬¡ç»“æ„æˆ–æ ‘ï¼Œå°±å¦‚ä½ å¯ä»¥åˆ›å»ºCore Animation Layer çš„å±‚æ¬¡ç»“æ„ä¸€æ ·ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªéƒ½æ˜¯Layeræ”¯æŒçš„Nodeå±‚çº§ç»“æ„ï¼Œé‚£ä¹ˆAsyncDisplaykitå°†ä¼šä¸ºæ¯ä¸ªNodeåˆ›å»ºä¸€ä¸ªåˆ†ç¦»çš„CALayer,Layerå±‚æ¬¡ç»“æ„å°†ä¼šå’ŒNodeå±‚çº§ç»“æ„ä¸€æ ·ï¼Œå¦‚åŒé•œåƒã€‚</p>

<p>è¿™å¬èµ·æ¥å¾ˆç†Ÿæ‚‰ï¼šå®ƒç±»ä¼¼äºå½“ä½ ä½¿ç”¨UIkitæ—¶ï¼ŒLayerå±‚æ¬¡ç»“æ„é•œåƒäºViewå±‚æ¬¡ç»“æ„ã€‚ç„¶è€Œï¼Œè¿™ä¸ªLayerçš„æ ˆæœ‰ä¸€äº›ä¸åŒçš„æ•ˆæœã€‚</p>

<p>é¦–å…ˆï¼Œå› ä¸ºæ˜¯å¼‚æ­¥æ¸²æŸ“ï¼Œä½ å°±ä¸ä¼šçœ‹åˆ°æ¯ä¸ªlayerä¸€ä¸ªæ¥ä¸€ä¸ªçš„æ˜¾ç¤ºï¼Œå½“AsyncDisplayKitç»˜åˆ¶å®Œæˆæ¯ä¸ªlayerï¼Œå®ƒé©¬ä¸Šåˆ¶ä½œlayerçš„æ˜¾ç¤ºå†…å®¹ï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰ä¸€ä¸ªlayerçš„ç»˜åˆ¶æ¯”å…¶ä»–layerè€—æ—¶æ›´é•¿ï¼Œé‚£ä¹ˆå®ƒå°†ä¼šåœ¨å®ƒä»¬ä¹‹åæ˜¾ç¤ºã€‚ç”¨æˆ·ä¼šçœ‹åˆ°é›¶ç¢çš„layerç»„ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸æ˜¯ä¸å¯è§çš„ï¼Œå› ä¸ºCore Animationä¼šåœ¨æ˜¾ç¤ºä»»ä½•ä¸œè¥¿ä¹‹å‰é‡ç»˜æ‰€æœ‰å¿…é¡»çš„Layerã€‚</p>

<p>ç¬¬äºŒï¼Œæœ‰éœ€è¦Layerèƒ½å¤Ÿå¼•èµ·æ€§èƒ½é—®é¢˜ã€‚æ¯ä¸ªCALayeréƒ½éœ€è¦ä¸€ä¸ªæ”¯æŒå­˜å‚¨æ¥ä¿å­˜å®ƒçš„åƒç´ ä½å›¾å’Œå†…å®¹ã€‚åŒæ ·ï¼ŒCoreAnimationå¿…é¡»å°†æ¯ä¸ªLayeré€šè¿‡XPCå‘ç»™æ¸²æŸ“æœåŠ¡å™¨ã€‚æœ€åï¼Œæ¸²æŸ“æœåŠ¡å™¨å¯èƒ½éœ€è¦é‡ç»˜ä¸€äº›Layerä»¥å¤åˆå®ƒä»¬ï¼Œä¾‹å¦‚åœ¨æ··åˆlayeræ—¶ï¼Œæ€»çš„æ¥è¯´ï¼Œæ›´å¤šçš„Layeræ„å‘³ç€CoreAnimationæ›´å¤šçš„å·¥ä½œã€‚æ‰€ä»¥é™åˆ¶layerä½¿ç”¨çš„æ•°é‡æœ‰è®¸å¤šä¸åŒçš„å¥½å¤„ã€‚</p>

<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒAsyncDisplayKitæœ‰ä¸€ä¸ªæ–¹ä¾¿çš„ç‰¹æ€§ï¼Œå®ƒå…è®¸ä½ ç»˜åˆ¶ä¸€ä¸ªNodeå±‚æ¬¡ç»“æ„åˆ°ä¸€ä¸ªå•ç‹¬çš„Layerå®¹å™¨é‡Œã€‚è¿™å°±æ˜¯shouldRasterizeDescendantsæ‰€åšçš„ï¼Œå½“ä½ è®¾ç½®å®ƒï¼Œé‚£åœ¨å®Œæˆç´ æœ‰çš„subnodeçš„ç»˜åˆ¶ä¹‹å‰ï¼ŒASDisplayNodeå°†ä¸ä¼šè®¾ç½®Layerçš„Contentsã€‚</p>

<p>æ‰€ä»¥åœ¨ä¹‹å‰çš„æ­¥éª¤é‡Œï¼Œè®¾ç½®å®¹å™¨Nodeçš„shouldRasterizeDescendantsä¸ºtrueæœ‰ä¸¤ä¸ªå¥½å¤„:</p>

<ol>
<li>å®ƒç¡®ä¿å¡ç‰‡ä¸€æ¬¡æ˜¾ç¤ºæ‰€æœ‰çš„Nodeï¼Œå¦‚åŒæ—§çš„åŒæ­¥ç»˜åˆ¶</li>
<li>è€Œä¸”å®ƒé€šè¿‡æ …æ ¼åŒ–Layeræ ˆä¸ºå•ä¸ªLayerå¹¶è¾ƒå°‘æœªæ¥çš„åˆæˆè€Œæé«˜äº†æ•ˆç‡</li>
</ol>


<p>ä¸è¶³ä¹‹å¤„æ˜¯ï¼Œç”±äºä½ å°†æ‰€æœ‰çš„layeræ”¾å…¥äº†ä¸€ä¸ªä½å›¾ï¼Œä½ å°±ä¸èƒ½å†ä¹‹åå•ç‹¬åŠ¨ç”»æŸä¸ªNodeäº†ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œåœ¨ Container Node Creation Sectionåï¼Œæ·»åŠ backgroundImageNodeä¸ºcontainerNodeçš„subnode:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//MARK: Node Hierarchy Section
</span><span class='line'>containerNode.addSubnode(backgroundImageNode)</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>æ³¨æ„</em>
æ·»åŠ Nodeçš„é¡ºåºå¾ˆé‡è¦ï¼Œå°±å¦‚åŒsubviewå’Œsublayer,æœ€å…ˆæ·»åŠ çš„Nodeä¼šè¢«ä¹‹åæ·»åŠ çš„é˜»æŒ¡æ˜¾ç¤º</p></blockquote>

<p>æ›¿æ¢ Node Layout Section çš„ç¬¬ä¸€è¡Œä¸ºï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//MARK: Node Layout Section
</span><span class='line'>containerNode.frame = FrameCalculator.frameForContainer(featureImageSize: image.size)</span></code></pre></td></tr></table></div></figure>


<p>æœ€åï¼Œä½¿ç”¨FrameCalculatorå¸ƒå±€backgroundImageNode:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>backgroundImageNode.frame = FrameCalculator.frameForBackgroundImage(
</span><span class='line'>  containerBounds: containerNode.bounds)</span></code></pre></td></tr></table></div></figure>


<p>è¿™è®¾ç½®backgroundImageNodeå¡«æ»¡æ•´ä¸ªcontainerNode.</p>

<p>ä½ å‡ ä¹å®Œæˆäº†æ–°çš„Nodeå±‚æ¬¡ç»“æ„ï¼Œä½†é¦–å…ˆä½ éœ€è¦æ­£ç¡®åœ°è®¾ç½®Layerå±‚æ¬¡ç»“æ„ï¼Œå› ä¸ºå®¹å™¨Nodeç°åœ¨æ˜¯æ ¹ã€‚</p>

<h3>ç®¡ç†å®¹å™¨Nodeçš„Layer</h3>

<p>åœ¨Node Layer and Wrap Up Sectionï¼Œå°†backgroundImageNodeçš„Layeræ·»åŠ åˆ°containerNodeçš„layerä¸Šï¼Œè€Œä¸æ˜¯containerViewçš„Layerä¸Š:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Replace the following line...
</span><span class='line'>// self.contentView.layer.addSublayer(backgroundImageNode.layer)
</span><span class='line'>// ...with this line:
</span><span class='line'>self.contentView.layer.addSublayer(containerNode.layer)</span></code></pre></td></tr></table></div></figure>


<p>åˆ é™¤ä¸‹é¢çš„backgroundImageNodeä¿ç•™:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>self.backgroundImageNode = backgroundImageNode</span></code></pre></td></tr></table></div></figure>


<p>å› ä¸ºcellåªéœ€è¦å•ç‹¬ä¿ç•™å®¹å™¨Node,æ‰€ä»¥ä½ è¦ç§»é™¤backgroundImageNodeå±æ€§ã€‚</p>

<p>ä¸å†è®¾ç½®cellçš„contentLayerå±æ€§ä¸ºbackgroundImageNodeçš„Layer,ç°åœ¨å°†å…¶è®¾ç½®ä¸ºcontainerNodeçš„layerï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Replace the following line...
</span><span class='line'>// self.contentLayer = backgroundImageNode.layer
</span><span class='line'>// ...with this line:
</span><span class='line'>self.contentLayer = containerNode.layer</span></code></pre></td></tr></table></div></figure>


<p>ç»™RainforestCardCellæ·»åŠ ä¸€ä¸ªå¯é€‰çš„ASDisplayNodeå®ä¾‹å­˜å‚¨ä¸ºå±æ€§containerNode:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RainforestCardCell: UICollectionViewCell {
</span><span class='line'>  var featureImageSizeOptional: CGSize?
</span><span class='line'>  var placeholderLayer: CALayer!
</span><span class='line'>  var backgroundImageNode: ASImageNode?
</span><span class='line'>  var contentLayer: CALayer?
</span><span class='line'>  var containerNode: ASDisplayNode? ///&lt; ADD THIS LINE
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è®°ä½ä½ éœ€è¦ä¿ç•™ä½ è‡ªå·±çš„Nodeï¼Œå¦‚æœä½ ä¸æ€ä¹ˆåšå®ƒä»¬å°±ä¼šè¢«ç«‹å³é‡Šæ”¾ã€‚</p>

<p>å›åˆ°configureCellDisplayWithCardInfo(cardInfo:)ï¼Œåœ¨Node Layer and Wrap Up Section æœ€åï¼Œè®¾ç½®containerNodeå±æ€§ä¸ºcontainerNodeå¸¸é‡:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>self.containerNode = containerNode</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œæ¨¡ç³Šçš„å›¾å½¢å°†ä¼šå†æ¬¡æ˜¾ç¤ºï¼ä½†è¿˜æœ‰æœ€åä¸€ä»¶äº‹è¦å»æ”¹å˜ï¼Œå› ä¸ºç°åœ¨æœ‰äº†æ–°çš„Nodeå±‚æ¬¡ç»“æ„ï¼Œå›å¿†ä¹‹å‰cellé‡ç”¨æ—¶ä½ å°†å›¾åƒåœæ­¢æ˜¾ç¤ºã€‚ç°åœ¨ä½ éœ€è¦è®©æ•´ä¸ªNodeå±‚æ¬¡ç»“æ„åœæ­¢æ˜¾ç¤ºã€‚</p>

<h3>åœ¨æ–°çš„Nodeå±‚æ¬¡ç»“æ„ä¸Šå¤„ç†cellé‡ç”¨</h3>

<p>ç»§ç»­RainforestCardCell.swift ï¼Œåœ¨prepareForReuse()é‡Œï¼Œæ›¿æ¢è®¾ç½®backgroundImageNode.preventOrCancelDisplay ä¸ºåœ¨ containerNode ä¸Šè°ƒç”¨ recursiveSetPreventOrCancelDisplay(&hellip;) å¹¶ä¼ é€’ trueï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func prepareForReuse() {
</span><span class='line'>  super.prepareForReuse()
</span><span class='line'> 
</span><span class='line'>  // Replace this line...
</span><span class='line'>  // backgroundImageNode?.preventOrCancelDisplay = true
</span><span class='line'>  // ...with this line:
</span><span class='line'>  containerNode?.recursiveSetPreventOrCancelDisplay(true)
</span><span class='line'> 
</span><span class='line'>  contentLayer?.removeFromSuperlayer()
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å½“ä½ è¦å–æ¶ˆæ•´ä¸ªNodeå±‚æ¬¡ç»“æ„çš„ç»˜åˆ¶ï¼Œå°±ä½¿ç”¨ recursiveSetPreventOrCancelDisplay()ã€‚è¿™ä¸ªæ–¹æ³•å°†ä¼šè®¾ç½®è¿™ä¸ªnodeä»¥åŠæ‰€æœ‰å­Nodeçš„preventOrCancelDisplayå±æ€§ï¼Œæ— è®ºtrueæˆ–falseã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œä¾ç„¶åœ¨prepareForReuse(),ç”¨è®¾ç½®containerNodeä¸ºnilæ›¿æ¢è®¾ç½®backgroundImageNodeä¸ºnil:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func prepareForReuse() {
</span><span class='line'>  ...
</span><span class='line'>  contentLayer = nil
</span><span class='line'>
</span><span class='line'>  // Replace this line...
</span><span class='line'>  // backgroundImageNode = nil
</span><span class='line'>  // ...with this line:
</span><span class='line'>  containerNode = nil
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç§»é™¤RainforestCardCellçš„backgroundImageNodeå±æ€§:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RainforestCardCell: UICollectionViewCell {
</span><span class='line'>  var featureImageSizeOptional: CGSize?
</span><span class='line'>  var placeholderLayer: CALayer!
</span><span class='line'>  // var backgroundImageNode: ASImageNode? ///&lt; REMOVE THIS LINE
</span><span class='line'>  var contentLayer: CALayer?
</span><span class='line'>  var containerNode: ASDisplayNode?
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œè¿™ä¸ªAPPå°±å¦‚ä¹‹å‰ä¸€æ ·ï¼Œä½†ç°åœ¨ä½ çš„å›¾åƒNodeåœ¨å®¹å™¨Nodeå†…ï¼Œè€Œé‡ç”¨ä¾ç„¶å’Œå®ƒåº”æœ‰çš„æ–¹å¼ä¸€æ ·.</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0009.png" alt="logo" /></p>

<h2>cellå†…å®¹</h2>

<p>ç›®å‰ä¸ºæ­¢ä½ æœ‰äº†ä¸€ä¸ªNodeå±‚çº§ç»“æ„ï¼Œä½†å®¹å™¨å†…è¿˜åªæœ‰ä¸€ä¸ªNode&ndash;å›¾åƒNode.ç°åœ¨æ˜¯æ—¶å€™è®¾ç½®Nodeå±‚æ¬¡ç»“æ„å»å¤åˆ¶åœ¨æ·»åŠ AsyncDisplayKitä¹‹å‰æ—¶åº”ç”¨çš„è§†å›¾å±‚æ¬¡ç»“æ„äº†ã€‚è¿™æ„å‘³ç€æ·»åŠ textå’Œä¸€ä¸ªæœªæ¨¡ç³Šçš„ç‰¹å¾å›¾åƒã€‚</p>

<h3>æ·»åŠ ç‰¹å¾å›¾åƒ</h3>

<p>æˆ‘ä»¬è¦æ·»åŠ ç‰¹å¾å›¾åƒäº†ï¼Œå®ƒæ˜¯ä¸€ä¸ªæœªæ¨¡ç³Šçš„å›¾åƒï¼Œæ˜¾ç¤ºåœ¨å¡ç‰‡çš„é¡¶éƒ¨ã€‚</p>

<p>æ‰“å¼€RainforestCardCell.swift ï¼Œå¹¶æ‰¾åˆ°configureCellDisplayWithCardInfo(cardInfo:).åœ¨Node Creation Section åº•éƒ¨ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let featureImageNode = ASImageNode()
</span><span class='line'>featureImageNode.layerBacked = true
</span><span class='line'>featureImageNode.contentMode = .ScaleAspectFit
</span><span class='line'>featureImageNode.image = image</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¼šåˆ›å»ºå¹¶é…ç½®ä¸€ä¸ªå«åšfeatureImageNodeçš„ASImageNodeå¸¸é‡ã€‚å®ƒè¢«è®¾ç½®ä¸ºLayeræ”¯æŒçš„ï¼Œæ”¾å¤§ä»¥é€‚ç”¨ï¼Œå¹¶è®¾ç½®æ˜¾ç¤ºå›¾åƒï¼Œè¿™æ¬¡ä¸éœ€è¦æ¨¡ç³Šã€‚</p>

<p>åœ¨Node Hierarchy Sectionçš„æœ€åï¼Œæ·»åŠ featureImageNodeä¸ºcontainerNodeçš„subNode:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>containerNode.addSubnode(featureImageNode)
</span></code></pre></td></tr></table></div></figure>


<p>ä½ æ­£åœ¨ç”¨æ›´å¤šNodeå¡«å……å®¹å™¨å“¦!</p>

<p>åœ¨Node Layout Sectionä¸­ï¼Œä½¿ç”¨FrameCalculatorå¸ƒå±€featureImageNodeï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>featureImageNode.frame = FrameCalculator.frameForFeatureImage(
</span><span class='line'>  featureImageSize: image.size,
</span><span class='line'>  containerFrameWidth: containerNode.frame.size.width)</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œä½ å°±ä¼šçœ‹åˆ°ç‰¹å¾å›¾åƒåœ¨å¡ç‰‡çš„é¡¶éƒ¨å‡ºç°ï¼Œä½äºæ¨¡ç³Šå›¾åƒçš„ä¸Šæ–¹ï¼Œæ³¨æ„ç‰¹å¾å›¾åƒå’Œæ¨¡ç³Šå›¾åƒæ˜¯å¦‚ä½•åœ¨åŒä¸€æ—¶é—´è·³å‡ºã€‚è¿™æ˜¯ä½ ä¹‹å‰æ·»åŠ çš„shouldRasterizeDescendantsåœ¨èµ·ä½œç”¨.</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0015.png" alt="logo" /></p>

<h2>æ·»åŠ Titleæ–‡æœ¬</h2>

<p>æ¥ä¸‹æ¥æ·»åŠ æ–‡å­—Label,ä»¥æ˜¾ç¤ºåŠ¨ç‰©çš„åå­—å’Œæè¿°ï¼Œé¦–å…ˆæ¥æ·»åŠ åŠ¨ç‰©åå­—å§ã€‚</p>

<p>ç»§ç»­configureCellDisplayWithCardInfo(cardInfo:),æ‰¾åˆ°Node Creation Sectionã€‚æ·»åŠ ä¸‹åˆ—ä»£ç åˆ°è¿™èŠ‚å°¾éƒ¨ï¼Œå°±åœ¨åˆ›å»ºfeatureImageNodeä¹‹åï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let titleTextNode = ASTextNode()
</span><span class='line'>titleTextNode.layerBacked = true
</span><span class='line'>titleTextNode.backgroundColor = UIColor.clearColor()
</span><span class='line'>titleTextNode.attributedString = NSAttributedString.attributedStringForTitleText(cardInfo.name)</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±åˆ›å»ºäº†ä¸€ä¸ªå«åštitleTextNodeçš„AsTextNodeå¸¸é‡ã€‚</p>

<p>ASTextNodeæ˜¯å¦ä¸€ä¸ªAsyncDisplayKitæä¾›çš„Nodeå­ç±»ï¼Œå…¶ç”¨äºæ˜¾ç¤ºæ–‡æœ¬ã€‚ä»–æ˜¯ä¸€ä¸ªå…·æœ‰UIlabelæ•ˆæœçš„Node.å®ƒæ¥å—ä¸€ä¸ªattributedString,ç”±TextKitæ”¯æŒï¼Œæœ‰è®¸å¤šç‰¹æ€§å¦‚æ–‡æœ¬é“¾æ¥ï¼Œè¦å­¦åˆ°æ›´å¤šå…³äºè¿™ä¸ªNodeçš„åŠŸèƒ½ï¼Œå»çœ‹ASTextNode.hå§ã€‚</p>

<p>åˆå§‹ç¾¡æ…•åŒ…å«ä¸€ä¸ªNSAttributedStringçš„æ‰©å±•ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå·¥å‚æ–¹æ³•å»ç”Ÿæˆä¸€ä¸ªå±æ€§å­—ç¬¦ä¸²ç”¨äºTitleå’ŒDescriptionæ–‡æœ¬ä»¥æ˜¾ç¤ºåœ¨é›¨æ—å¡ç‰‡ä¸Šã€‚ä¸Šé¢çš„ä»£ç ä½¿ç”¨äº†è¿™ä¸ªæ‰©å±•çš„attributedStringForTitleText(&hellip;) æ–¹æ³•ã€‚</p>

<p>ç°åœ¨åœ¨Node Hierarchy Section åº•éƒ¨ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>containerNode.addSubnode(titleTextNode)</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±æ·»åŠ äº†titleTextNodeåˆ°Nodeå±‚æ¬¡ç»“æ„é‡Œï¼Œå®ƒå°†ä½äºç‰¹å¾å›¾åƒå’ŒèƒŒæ™¯å›¾åƒæ™ºå•†ï¼Œå› ä¸ºå®ƒåœ¨å®ƒä»¬ä¹‹åæ·»åŠ ã€‚</p>

<p>åœ¨Node Layout Sectionåº•éƒ¨æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>titleTextNode.frame = FrameCalculator.frameForTitleText(
</span><span class='line'>  containerBounds: containerNode.bounds,
</span><span class='line'>  featureImageFrame: featureImageNode.frame)</span></code></pre></td></tr></table></div></figure>


<p>ä¸€æ ·ä½¿ç”¨FrameCalculatorå¸ƒå±€titleTextNode,å°±åƒbackgroundImageNodeå’ŒfeatureImageNodeé‚£æ ·ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œï¼Œä½ å°±æœ‰äº†ä¸€ä¸ªtitleæ˜¾ç¤ºåœ¨ç‰¹å¾å›¾åƒçš„é¡¶éƒ¨ã€‚å†æ¬¡è¯´æ˜ï¼ŒLabelåªä¼šåœ¨æ•´ä¸ªCellå‡†å¤‡å¥½æ¸²æŸ“æ—¶æ‰æ¸²æŸ“ã€‚
<img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0017.png" alt="logo" /></p>

<h2>æ·»åŠ Descriptionæ–‡æœ¬</h2>

<p>æ·»åŠ ä¸€ä¸ªæœ‰ç€Descriptionæ–‡æœ¬çš„Nodeå’Œæ·»åŠ Titleæ–‡æœ¬çš„Nodeç±»ä¼¼.</p>

<p>å›åˆ°configureCellDisplayWithCardInfo(cardInfo:),åœ¨ Node Creation Section æœ€åï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ã€‚å°±åœ¨ä¹‹å‰åˆ›å»ºtitleTextNodeçš„è¯­å¥ä¹‹å:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let descriptionTextNode = ASTextNode()
</span><span class='line'>descriptionTextNode.layerBacked = true
</span><span class='line'>descriptionTextNode.backgroundColor = UIColor.clearColor()
</span><span class='line'>descriptionTextNode.attributedString = 
</span><span class='line'>  NSAttributedString.attributedStringForDescriptionText(cardInfo.description)</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±åˆ›å»ºå¹¶é…ç½®äº†ä¸€ä¸ªå«åšdescriptionTextNodeçš„AStextNodeå®ä¾‹ã€‚</p>

<p>åœ¨ Node Hierarchy Sectionæœ€åï¼Œæ·»åŠ descriptionTextNodeåˆ°containerNodeï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>containerNode.addSubnode(descriptionTextNode)</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ Node Layout Section,ä¸€æ ·ä½¿ç”¨FrameCalculatorå¸ƒå±€descriptionTextNodeï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>descriptionTextNode.frame = FrameCalculator.frameForDescriptionText(
</span><span class='line'>  containerBounds: containerNode.bounds,
</span><span class='line'>  featureImageFrame: featureImageNode.frame)</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œç°åœ¨ä½ èƒ½çœ‹åˆ°Descriptionæ–‡æœ¬äº†ã€‚
<img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0018.png" alt="logo" /></p>

<h2>è‡ªå®šä¹‰Nodeå­ç±»</h2>

<p>ç›®å‰ä¸ºæ­¢ï¼Œä½ ä½¿ç”¨äº†ASImageNodeå’ŒAStextNode,ä½†æœ‰äº›æ—¶å€™ä½ éœ€è¦è‡ªå·±å®šä¹‰Node,å°±å¦‚åŒæŸäº›æ—¶å€™åœ¨ä¼ ç»Ÿçš„UIKitç¼–ç¨‹é‡Œä½ éœ€è¦è‡ªå·±çš„Viewä¸€æ ·ã€‚</p>

<h3>åˆ›å»ºæ¢¯åº¦Nodeç±»</h3>

<p>æ¥ä¸‹æ¥ï¼Œä½ å°†ç»™GradientView.swift æ·»åŠ Core Graphics ä»£ç æ¥æ„å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„æ¢¯åº¦Display Node,è¿™å›è¢«ç”¨äºåˆ›å»ºä¸€ä¸ªç»˜åˆ¶æ¢¯åº¦çš„è‡ªå®šä¹‰Node.æ¢¯åº¦å›¾ä¼šæ˜¾ç¤ºåœ¨ç‰¹å¾å›¾åƒçš„åœ°æ­¥ä»¥ä¾¿è®©Titleçœ‹èµ·æ¥æ›´åŠ æ˜æ˜¾ã€‚</p>

<p>æ‰“å¼€Layers-Bridging-Header.hï¼Œå¹¶æ·»åŠ å¦‚ä¸‹ä»£ç </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#import &lt;AsyncDisplayKit/_ASDisplayLayer.h&gt;</span></code></pre></td></tr></table></div></figure>


<p>éœ€è¦è¿™ä¸€æ­¥æ˜¯å› ä¸ºè¿™ä¸ªç±»æ²¡æœ‰åŒ…å«åœ¨ä¸»å¤´æ–‡ä»¶ä¸­ï¼Œä½ åœ¨å­ç±»åŒ–ä»»ä½•ASDisplayNodeæˆ–è€…_ASDisplayLayeræ—¶éƒ½éœ€è¦è®¿é—®è¿™ä¸ªç±»ã€‚</p>

<p>èœå• File\New\Fileâ€¦ ã€‚é€‰æ‹© iOS\Source\Cocoa Touch Class ã€‚å‘½åç±»ä¸º GradientNode å¹¶ä½¿å…¶ä½œä¸º ASDisplayNode çš„å­ç±»ã€‚é€‰æ‹© Swift è¯­è¨€å¹¶ç‚¹å‡» Next ã€‚ä¿å­˜æ–‡ä»¶å†æ‰“å¼€ GradientNode.swift ã€‚</p>

<p>æ·»åŠ å¦‚ä¸‹æ–¹æ³•åˆ°è¿™ä¸ªç±»:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class func drawRect(bounds: CGRect, withParameters parameters: NSObjectProtocol!,
</span><span class='line'>    isCancelled isCancelledBlock: asdisplaynode_iscancelled_block_t!, isRasterizing: Bool) {
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å¦‚åŒUiviewæˆ–è€…CALayer,ä½ å¯ä»¥å­ç±»åŒ–ASDisplayNodeå»åšè‡ªå®šä¹‰ç»˜åˆ¶ã€‚ä½ å¯ä»¥ä½¿ç”¨å¦‚åŒç”¨äºUIViewçš„Layeræˆ–å•ç‹¬çš„CALayerçš„ç»˜åˆ¶ä»£ç ï¼Œè¿™å–å†³äºå®¢æˆ·Nodeå¦‚ä½•é…ç½®Node.æŸ¥çœ‹ASDisplayNode+Subclasses.h è·å–æ›´å¤šå…³äºå­ç±»åŒ– ASDisplayNode çš„ä¿¡æ¯ã€‚</p>

<p>è¿›ä¸€æ­¥ï¼ŒASDisplayNodeçš„ç»˜åˆ¶æ–¹æ³•æ¯”åœ¨UIViewå’ŒCALayeré‡Œæ¥å—æ›´å¤šå‚æ•°ï¼Œç»™ä½ æä¾›æ–¹æ³•å°‘åšå·¥ä½œï¼Œæ›´æœ‰æ•ˆç‡ã€‚</p>

<p>è¦ä¸ºä½ çš„è‡ªå®šä¹‰DisplayNodeå¡«å……å†…å®¹ï¼Œä½ éœ€è¦å®ç°æ¥è‡ª<em>ASDisplayLayerDelegateåè®®çš„drawRect(&hellip;) æˆ– displayWithParameters(&hellip;)ã€‚åœ¨ç»§ç»­ä¹‹å‰ï¼Œçœ‹çœ‹ </em>ASDisplayLayer.h å¾—åˆ°è¿™ä¸ªæ–¹æ³•å’Œå®ƒä»¬å‚æ•°çš„ä¿¡æ¯ã€‚æœç´¢_ASDisplayLayerDelegateã€‚é‡ç‚¹çœ‹çœ‹å¤´æ–‡ä»¶æ³¨é‡Šé‡Œå…³äºdrawRect(..)çš„æè¿°ã€‚</p>

<p>å› ä¸ºæ¢¯åº¦å›¾ä½äºç‰¹å¾å›¾çš„ä¸Šæ–¹ï¼Œä½¿ç”¨Core Graphics ç»˜åˆ¶ï¼Œæ‰€ä»¥ä½ éœ€è¦ä½¿ç”¨drawRect.</p>

<p>æ‰“å¼€GradientView.swift å¹¶æ‹·è´drawRect(&hellip;)çš„å†…å®¹åˆ°GradientNode.swift çš„drawRect(&hellip;)ï¼Œå¦‚ä¸‹ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class func drawRect(bounds: CGRect, withParameters parameters: NSObjectProtocol!,
</span><span class='line'>    isCancelled isCancelledBlock: asdisplaynode_iscancelled_block_t!, isRasterizing: Bool) {
</span><span class='line'>  let myContext = UIGraphicsGetCurrentContext()
</span><span class='line'>  CGContextSaveGState(myContext)
</span><span class='line'>  CGContextClipToRect(myContext, bounds)
</span><span class='line'>
</span><span class='line'>  let componentCount: UInt = 2
</span><span class='line'>  let locations: [CGFloat] = [0.0, 1.0]
</span><span class='line'>  let components: [CGFloat] = [0.0, 0.0, 0.0, 1.0,
</span><span class='line'>    0.0, 0.0, 0.0, 0.0]
</span><span class='line'>  let myColorSpace = CGColorSpaceCreateDeviceRGB()
</span><span class='line'>  let myGradient = CGGradientCreateWithColorComponents(myColorSpace, components,
</span><span class='line'>    locations, componentCount)
</span><span class='line'>
</span><span class='line'>  let myStartPoint = CGPoint(x: bounds.midX, y: bounds.maxY)
</span><span class='line'>  let myEndPoint = CGPoint(x: bounds.midX, y: bounds.midY)
</span><span class='line'>  CGContextDrawLinearGradient(myContext, myGradient, myStartPoint,
</span><span class='line'>    myEndPoint, UInt32(kCGGradientDrawsAfterEndLocation))
</span><span class='line'>
</span><span class='line'>  CGContextRestoreGState(myContext)
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç„¶ååˆ é™¤GradientView.swift,ç¡®ä¿ç¼–è¯‘æ²¡æœ‰é”™è¯¯</p>

<h3>æ·»åŠ æ¢¯åº¦Node</h3>

<p>æ‰“å¼€RainforestCardCell.swiftå¹¶æ‰¾åˆ°configureCellDisplayWithCardInfo(cardInfo:)ï¼Œåœ¨Node Creation Sectionåº•éƒ¨ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼Œå°±åœ¨åˆ›å»ºdescriptionTextNodeçš„ä»£ç ä¹‹å:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let gradientNode = GradientNode()
</span><span class='line'>gradientNode.opaque = false
</span><span class='line'>gradientNode.layerBacked = true</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±åˆ›å»ºäº†ä¸€ä¸ªå«åšgradientNodeçš„GradientNodeå¸¸é‡ã€‚</p>

<p>åœ¨Node Hierarchy Sectionï¼Œåœ¨æ·»åŠ featureImageNodeé‚£æ ·ä¸‹é¢ï¼Œæ·»åŠ gradientNodeåˆ°containerNode:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//MARK: Node Hierarchy Section
</span><span class='line'>containerNode.addSubnode(backgroundImageNode)
</span><span class='line'>containerNode.addSubnode(featureImageNode)
</span><span class='line'>containerNode.addSubnode(gradientNode) ///&lt; ADD THIS LINE
</span><span class='line'>containerNode.addSubnode(titleTextNode)
</span><span class='line'>containerNode.addSubnode(descriptionTextNode)</span></code></pre></td></tr></table></div></figure>


<p>æ¢¯åº¦Nodeéœ€è¦è¿™ä¸ªä½ç½®æ‰èƒ½åœ¨ç‰¹å¾å›¾ä¹‹åï¼ŒTitleä¹‹ä¸‹ã€‚</p>

<p>ç„¶åæ·»åŠ å¦‚ä¸‹ä»£ç åˆ°Node Layout Sectionåº•éƒ¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gradientNode.frame = FrameCalculator.frameForGradient(
</span><span class='line'>  featureImageFrame: featureImageNode.frame)</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œä½ å°†çœ‹åˆ°æ¢¯åº¦åœ¨ç‰¹å¾å›¾çš„åº•éƒ¨ï¼Œtitleç¡®å®çœ‹çš„æ›´æ¸…æ¥šäº†</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0019.png" alt="logo" /></p>

<h2>çˆ†ç±³èŠ±ç‰¹æ•ˆ</h2>

<p>å¦‚ä¹‹å‰æåˆ°çš„ï¼Œcellçš„Nodeå†…å®¹ä¼šåœ¨å®Œæˆç»˜åˆ¶æ—¶â€œå¼¹å‡ºâ€ï¼Œè¿™ä¸æ˜¯å¾ˆç†æƒ³ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç»§ç»­ï¼Œä»¥ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œä½†é¦–å…ˆï¼Œæ›´åŠ æ·±å…¥AsyncDisplayKitä»¥çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚</p>

<p>åœ¨configureCellDisplayWithCardInfo(cardInfo:) çš„Container Node Creation Sectionï¼Œå…³é—­å®¹å™¨Nodeçš„shouldRasterizeDescendantsï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>containerNode.shouldRasterizeDescendants = false</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œä½ ä¼šæ³¨æ„åˆ°ç°åœ¨å®¹å™¨å±‚æ¬¡ç»“æ„é‡Œä¸åŒçš„Nodeä¸€ä¸ªæ¥ä¸€ä¸ªçš„å¼¹å‡ºã€‚ä½ ä¼šçœ‹åˆ°æ–‡å­—å¼¹å‡ºç„¶åæ˜¯ç‰¹å¾å›¾ï¼Œç„¶åæ˜¯æ¨¡ç³ŠèƒŒæ™¯å›¾ã€‚</p>

<p>å½“shouldRasterizeDescendantså…³é—­åï¼ŒAsyncDisplayKitå°±ä¸æ˜¯ç»˜åˆ¶ä¸€ä¸ªå®¹å™¨Layeräº†ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªé•œåƒå¡ç‰‡Nodeå±‚æ¬¡ç»“æ„çš„Layeræ•°ã€‚è®°å¾—çˆ†ç±³èŠ±ç‰¹æ•ˆå­˜åœ¨æ˜¯å› ä¸ºæ¯ä¸ªLayeréƒ½åœ¨å®ƒç»˜åˆ¶ç»“æŸåç«‹å³å‡ºç°ï¼Œè€ŒæŸäº›Layeræ¯”å¦å¤–ä¸€ä¸ªèŠ±è´¹æ›´å¤šæ—¶é—´åœ¨ç»˜åˆ¶ä¸Šã€‚</p>

<p>è¿™ä¸æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ï¼Œä½†å®ƒæè¿°äº†AsyncDisplayKitçš„å·¥ä½œæ–¹å¼ï¼Œæˆ‘ä»¬ä¸æƒ³è¦è¿™ä¸ªè¡Œä¸ºï¼Œæ‰€ä»¥è¿˜æ˜¯å°†shouldRasterizeDescendantsæ‰“å¼€ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>containerNode.shouldRasterizeDescendants = true</span></code></pre></td></tr></table></div></figure>


<h2>åœ¨åå°æ„é€ Node</h2>

<p>é™¤äº†å¼‚æ­¥çš„ç»˜åˆ¶ï¼Œä½¿ç”¨AsyncDisplayKit,ä½ åŒæ ·å¯ä»¥å¼‚æ­¥åœ°åˆ›å»ºï¼Œé…ç½®ä»¥åŠå¸ƒå±€ã€‚æ·±å‘¼å¸ä¸€ä¸‹ï¼Œæ¥ä¸‹æ¥å¼€å§‹åšäº‹æƒ…ã€‚</p>

<h3>åˆ›å»ºä¸€ä¸ªNodeæ„é€ æ“ä½œ(OPeration)</h3>

<p>ä½ è¦è®²Nodeå±‚æ¬¡ç»“æ„çš„æ„é€ åŒ…è£…åˆ°ä¸€ä¸ªNSOperationä¸­ï¼Œè¿™æ ·åšå¾ˆæ£’ï¼Œå› ä¸ºè¿™ä¸ªæ“ä½œèƒ½å¾ˆå®¹æ˜“çš„åœ¨ä¸åŒçš„æ“ä½œé˜Ÿåˆ—ä¸­æ‰§è¡Œï¼ŒåŒ…æ‹¬åå°é˜Ÿåˆ—ã€‚</p>

<p>æ‰“å¼€RainforestCardCell.swift ï¼Œç„¶åæ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func nodeConstructionOperationWithCardInfo(cardInfo: RainforestCardInfo, image: UIImage) -&gt; NSOperation {
</span><span class='line'>  let nodeConstructionOperation = NSBlockOperation()
</span><span class='line'>  nodeConstructionOperation.addExecutionBlock { 
</span><span class='line'>    // TODO: Add node hierarchy construction
</span><span class='line'>  }
</span><span class='line'>  return nodeConstructionOperation
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç»˜åˆ¶å¹¶ä¸æ˜¯å”¯ä¸€ä¼šæ‹–æ…¢ä¸»çº¿ç¨‹çš„æ“ä½œï¼Œå¯¹äºå¤æ‚çš„å±å¹•ï¼Œå¸ƒå±€è®¡ç®—ä¹Ÿæœ‰å¯èƒ½å˜å¾—æ˜‚é€€ã€‚ç›®å‰ä¸ºæ­¢ï¼Œæœ¬æ•™ç¨‹å½“å‰çŠ¶æ€çš„é¡¹ç›®ï¼Œä¸€ä¸ªç¼“æ…¢çš„Nodeå¸ƒå±€ä¼šå¼•èµ·Collectionviewä¸¢å¸§ã€‚</p>

<p>60FPSæ„å‘³ç€ä½ æœ‰å¤§çº¦17msçš„æ—¶é—´è®©ä½ çš„cellå‡†å¤‡å¥½æ˜¾ç¤ºï¼Œå¦åˆ™ä¸€ä¸ªæˆ–è€…å¤šä¸ªå¸§å°±ä¼šè¢«ä¸¢æ‰ã€‚è¿™åœ¨Table viewå’Œ collection viewæœ‰å¾ˆå¤æ‚çš„cellæ—¶æ—¶éå¸¸å¸¸è§çš„ï¼Œæ»‘åŠ¨æ—¶ä¸¢å¸§å°±æ˜¯è¿™ä¸ªåŸå› ã€‚</p>

<p>AsyncDisplayKitå‰æ¥æ•‘æ´</p>

<p>ä½ å°†ä½¿ç”¨ä¸Šé¢çš„nodeConstructionOperationå°†æ‰€æœ‰Nodeå±‚æ¬¡ç»“æ„ä»¥åŠå¸ƒå±€ä»ä¸»çº¿ç¨‹å‰¥ç¦»å¹¶æ”¾å…¥åå°NSOperatonQueueï¼Œè¿›ä¸€æ­¥ç¡®ä¿Collection viewèƒ½å°½é‡ä»¥æ¥è¿‘60 fpsçš„å¸§ç‡æ»‘åŠ¨ã€‚</p>

<blockquote><p><em>æ³¨æ„</em>
ä½ å¯ä»¥åœ¨åå°è®¿é—®å¹¶è®¾ç½®Nodeçš„å±æ€§ï¼Œä½†åªèƒ½åœ¨Nodeçš„Layeræˆ–Viewè¢«åˆ›å»ºä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯å½“ä½ ç¬¬ä¸€æ¬¡è®¿é—®Nodeçš„Layeræˆ–Viewå±æ€§æ—¶ã€‚</p></blockquote>

<p>ä¸€æ—¦Nodeçš„Layeræˆ–Viewè¢«åˆ›å»ºï¼Œä½ å¿…é¡»åœ¨ä¸»çº¿ç¨‹æ‰èƒ½è®¿é—®å’Œè®¾ç½®Nodeçš„å±æ€§ï¼Œå› ä¸ºNodeå°†ä¼šè½¬å‘è¿™äº›è°ƒç”¨åˆ°å®ƒçš„Layeræˆ–View.å¦‚æœä½ å¾—åˆ°ä¸€ä¸ªå´©æºƒlogè¯´â€œIncorrect display node thread affinityâ€,é‚£å°±æ„å‘³ç€åœ¨åˆ›å»ºNodeçš„Layeræˆ–Viewä¹‹åï¼Œä½ ä¾ç„¶å°è¯•åœ¨åå°è®¿é—®æˆ–è®¾ç½®Nodeçš„å±æ€§ã€‚</p>

<p>ä¿®æ”¹nodeConstructionOperation æ“ä½œBlockçš„å†…å®¹å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nodeConstructionOperation.addExecutionBlock {
</span><span class='line'>  [weak self, unowned nodeConstructionOperation] in
</span><span class='line'>  if nodeConstructionOperation.cancelled {
</span><span class='line'>    return
</span><span class='line'>  }
</span><span class='line'>  if let strongSelf = self {
</span><span class='line'>    // TODO: Add node hierarchy construction
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>åœ¨è¿™ä¸ªæ“ä½œè¿è¡Œæ—¶ï¼Œcellå¯èƒ½å·²ç»è¢«é‡Šæ”¾äº†ï¼Œåœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œä½ ä¸éœ€è¦åšä»»ä½•å·¥ä½œã€‚ç±»ä¼¼çš„ï¼Œå¦‚æœæ“ä½œè¢«å–æ¶ˆäº†ï¼Œé‚£ä¸€æ ·ä¹Ÿæ²¡æœ‰å·¥ä½œè¦åšäº†ã€‚</p>

<p>ä¹‹æ‰€ä»¥å¯¹nodeConstructionOperationä½¿ç”¨ unowneræ— ä¸»å¼•ç”¨æ˜¯ä¸ºäº†é¿å…åœ¨æ“ä½œå’Œæ‰§è¡Œå¿…è¦ä¹‹é—´äº§ç”Ÿå¾ªç¯å¼•ç”¨ã€‚</p>

<p>ç°åœ¨æ‰¾åˆ°configureCellDisplayWithCardInfo(cardInfo:)ã€‚å°†ä»»ä½•åœ¨Image Size Sectionä¹‹åçš„ä»£ç ç§»åŠ¨åˆ°nodeConstructionOperationçš„æ‰§è¡Œé—­åŒ…é‡Œï¼Œå°†ä»£ç æ”¾åœ¨strongSelfçš„æ¡ä»¶è¯­å¥é‡Œï¼Œå³ TODOçš„ä½ç½®ï¼Œä¹‹åconfigureCellDisplayWithCardInfo(cardInfo:)å°†å¼€èµ·æ¥å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func configureCellDisplayWithCardInfo(cardInfo: RainforestCardInfo) {
</span><span class='line'>  //MARK: Image Size Section
</span><span class='line'>  let image = UIImage(named: cardInfo.imageName)!
</span><span class='line'>  featureImageSizeOptional = image.size
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç›®å‰ï¼Œä½ ä¼šæœ‰ä¸€äº›ç¼–è¯‘é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºæ“ä½œBlocké‡Œçš„selfæ˜¯weakå¼•ç”¨ï¼Œå› æ­¤æ˜¯å¯é€‰çš„ã€‚ä½†ä½ æœ‰ä¸€ä¸ªselfçš„strongå¼•ç”¨ï¼Œå› ä¸ºä»£ç åœ¨å¯é€‰ç»‘å®šè¯­å¥å†…ã€‚æ‰€ä»¥æ›¿æ¢é”™è¯¯çš„å‡ è¡Œæˆä¸‹é¢çš„æ ·å­:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>strongSelf.contentView.layer.addSublayer(containerNode.layer)
</span><span class='line'>strongSelf.contentLayer = containerNode.layer
</span><span class='line'>strongSelf.containerNode = containerNode</span></code></pre></td></tr></table></div></figure>


<p>æœ€åï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç åˆ°ä½ åˆšæ”¹åŠ¨çš„ä¸‰è¡Œä¹‹ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>containerNode.setNeedsDisplay()</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘ç¡®ä¿æ²¡æœ‰é”™è¯¯ã€‚å¦‚æœä½ ç°åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¹‹åå ä½å›¾ä¼šæ˜¾ç¤ºï¼Œå› ä¸ºNodeçš„åˆ›å»ºæ“ä½œè¿˜æ²¡æœ‰å®é™…ä½¿ç”¨ã€‚è®©æˆ‘ä»¬æ¥æ·»åŠ å®ƒ</p>

<h3>ä½¿ç”¨Nodeåˆ›å»ºæ“ä½œ</h3>

<p>æ‰“å¼€ RainforestCardCell.swift å¹¶æ·»åŠ å¦‚ä¸‹å±æ€§ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RainforestCardCell: UICollectionViewCell {
</span><span class='line'>  var featureImageSizeOptional: CGSize?
</span><span class='line'>  var placeholderLayer: CALayer!
</span><span class='line'>  var backgroundImageNode: ASImageNode?
</span><span class='line'>  var contentLayer: CALayer?
</span><span class='line'>  var containerNode: ASDisplayNode?
</span><span class='line'>  var nodeConstructionOperation: NSOperation? ///&lt; ADD THIS LINE
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±æ·»åŠ äº†ä¸€ä¸ªå«åšnodeConstructionOperationå¯é€‰å±æ€§ã€‚
å½“Cellå‡†å¤‡å›æ”¶æ—¶ï¼Œä½ ä¼šä½¿ç”¨è¿™ä¸ªå±æ€§å–æ¶ˆNodeçš„æ„é€ ã€‚è¿™ä¼šåœ¨ç”¨æˆ·éå¸¸å¿«é€Ÿåœ°æ»‘åŠ¨Collection Viewæ—¶å‘ç”Ÿï¼Œç‰¹åˆ«æ˜¯å¦‚æœå¸ƒå±€è¿˜éœ€è¦ä¸€äº›è®¡ç®—æ—¶é—´çš„è¯ã€‚</p>

<p>åœ¨prepareForReuse()æ·»åŠ å¦‚ä¸‹æŒ‡ç¤ºçš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func prepareForReuse() {
</span><span class='line'>  super.prepareForReuse()
</span><span class='line'> 
</span><span class='line'>  // ADD FROM HERE...
</span><span class='line'>  if let operation = nodeConstructionOperation {
</span><span class='line'>    operation.cancel()
</span><span class='line'>  }
</span><span class='line'>  // ...TO HERE
</span><span class='line'> 
</span><span class='line'>  containerNode?.recursiveSetPreventOrCancelDisplay(true)
</span><span class='line'>  contentLayer?.removeFromSuperlayer()
</span><span class='line'>  contentLayer = nil
</span><span class='line'>  containerNode = nil
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±åœ¨cellé‡ç”¨æ—¶å–æ¶ˆäº†æ“ä½œï¼Œæ‰€ä»¥å¦‚æœNodeåˆ›å»ºè¿˜æ²¡å®Œæˆï¼Œå®ƒä¹Ÿä¸ä¼šå®Œæˆã€‚</p>

<p>ç°åœ¨æ‰¾åˆ° configureCellDisplayWithCardInfo(cardInfo:) ,å¹¶æ·»åŠ å¦‚ä¸‹æŒ‡ç¤ºçš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func configureCellDisplayWithCardInfo(cardInfo: RainforestCardInfo) {
</span><span class='line'>  // ADD FROM HERE...
</span><span class='line'>  if let oldNodeConstructionOperation = nodeConstructionOperation {
</span><span class='line'>    oldNodeConstructionOperation.cancel()
</span><span class='line'>  }
</span><span class='line'>  // ...TO HERE
</span><span class='line'> 
</span><span class='line'>  //MARK: Image Size Section
</span><span class='line'>  let image = UIImage(named: cardInfo.imageName)!
</span><span class='line'>  featureImageSizeOptional = image.size
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªCellç°åœ¨ä¼šåœ¨å®ƒå‡†å¤‡é‡ç”¨å¹¶å¼€å§‹é…ç½®æ—¶ï¼Œå–æ¶ˆä»»ä½•è¿›è¡Œä¸­çš„ Nodeæ„é€ æ“ä½œã€‚è¿™ç¡®ä¿äº†æ“ä½œè¢«å–æ¶ˆï¼Œå³ä½¿cellåœ¨å‡†å¤‡é‡ç”¨å‰å°±è¢«é‡æ–°é…ç½®ã€‚</p>

<p>åœ¨ä¸»çº¿ç¨‹è¿è¡Œ</p>

<p>AsyncDisplayKitå…è®¸ä½ åœ¨éä¸»çº¿ç¨‹åšè®¸å¤šå·¥ä½œã€‚ä½†å½“å®ƒè¦é¢å¯¹UIKitå’ŒCoreAnimationæ—¶ï¼Œä½ è¿˜æ˜¯éœ€è¦åœ¨ä¸»çº¿ç¨‹åšã€‚ç›®å‰ä¸ºæ­¢ï¼Œä½ ä»ä¸»çº¿ç¨‹ç§»èµ°äº†æ‰€æœ‰çš„Nodeåˆ›å»ºï¼Œä½†è¿˜æœ‰ä¸€ä»¶äº‹éœ€è¦è¢«æ”¾åœ¨ä¸»çº¿ç¨‹&ndash;å³è®¾ç½®coreAnimationçš„Layerå±‚æ¬¡ç»“æ„ã€‚</p>

<p>åœ¨RainforestCardCell.swifté‡Œï¼Œæ‰¾åˆ°nodeConstructionOperationWithCardInfo(cardInfo:image:) å¹¶æ›¿æ¢Node Layer and Wrap Up Section ä¸ºå¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1
</span><span class='line'>dispatch_async(dispatch_get_main_queue()) { [weak nodeConstructionOperation] in
</span><span class='line'>  if let strongNodeConstructionOperation = nodeConstructionOperation {
</span><span class='line'>    // 2
</span><span class='line'>    if strongNodeConstructionOperation.cancelled {
</span><span class='line'>      return
</span><span class='line'>    }
</span><span class='line'> 
</span><span class='line'>    // 3
</span><span class='line'>    if strongSelf.nodeConstructionOperation !== strongNodeConstructionOperation {
</span><span class='line'>      return
</span><span class='line'>    }
</span><span class='line'> 
</span><span class='line'>    // 4
</span><span class='line'>    if containerNode.preventOrCancelDisplay {
</span><span class='line'>      return
</span><span class='line'>    }
</span><span class='line'> 
</span><span class='line'>    // 5
</span><span class='line'>    //MARK: Node Layer and Wrap Up Section
</span><span class='line'>    strongSelf.contentView.layer.addSublayer(containerNode.layer)
</span><span class='line'>    containerNode.setNeedsDisplay()
</span><span class='line'>    strongSelf.contentLayer = containerNode.layer
</span><span class='line'>    strongSelf.containerNode = containerNode
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸‹é¢æè¿°ä¸€ä¸‹:</p>

<ol>
<li>å›å¿†å½“Nodeçš„Layerå±æ€§è¢«ç¬¬ä¸€ä¸ªè®¿é—®æ—¶ï¼Œæ‰€æœ‰çš„Layerä¼šè¢«åˆ›å»ºã€‚è¿™å°±æ˜¯ä¸ºä½•ä½ å¿…é¡»è¿è¡ŒNode Layerå¹¶åœ¨ä¸»çº¿ç¨‹åŒ…è£…å°èŠ‚ï¼Œå› æ­¤ä»£ç è®¿é—®Nodeçš„Layer.</li>
<li>æ“ä½œè¢«æ£€æŸ¥ä»¥ç¡®å®šæ˜¯å¦åœ¨æ·»åŠ Layerä¹‹å‰å°±å·²ç»å–æ¶ˆäº†ã€‚åœ¨æ“ä½œå®Œæˆå‰ï¼Œcellè¢«é‡ç”¨æˆ–è€…é‡æ–°é…ç½®ï¼Œå°±å¾ˆå¯èƒ½å‡ºç°è¿™æ ·çš„æƒ…å†µï¼Œé‚£ä½ å°±ä¸åº”è¯¥æ·»åŠ Layeräº†ã€‚</li>
<li>ä½œä¸ºä¸€ä¸ªä¿é™©ï¼Œç¡®ä¿Nodeå½“å‰çš„nodeConstructionOperationå’Œè°ƒåº¦é—­åŒ…çš„æ“ä½œæ˜¯åŒä¸€ä¸ªNSOperation</li>
<li>å¦‚æœcontainerNodeçš„preventOrCancelæ˜¯trueå°±ç«‹å³è¿”å›ã€‚å¦‚æœæ„é€ æ“ä½œå®Œæˆï¼Œä½†nodeçš„ç»˜åˆ¶è¿˜æ²¡æœ‰è¢«å–æ¶ˆï¼Œä½ ä¾ç„¶ä¸æƒ³Nodeçš„layerç°åœ¨åœ¨cellé‡Œ</li>
<li>æœ€åï¼Œæ·»åŠ Nodeçš„Layeråˆ°å±‚æ¬¡ç»“æ„ä¸­ï¼Œå¦‚æœå¿…è¦ï¼Œè¿™å°±åˆ›å»ºLayer.</li>
</ol>


<p>ç¼–è¯‘ç¡®ä¿æ²¡æœ‰é”™è¯¯</p>

<h3>å¼€å§‹Nodeåˆ›å»ºæ“ä½œ</h3>

<p>ä½ ä¾ç„¶æ²¡æœ‰å®é™…åˆ›å»ºå’Œå¼€å§‹æ“ä½œï¼Œè®©æˆ‘ä»¬å¼€å§‹å§</p>

<p>ç»§ç»­åœ¨RainforestCardCell.swifté‡Œï¼Œæ”¹å˜configureCellDisplayWithCardInfo(cardInfo:) çš„æ–¹æ³•ç­¾åä¸º:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func configureCellDisplayWithCardInfo(
</span><span class='line'>  cardInfo: RainforestCardInfo,
</span><span class='line'>  nodeConstructionQueue: NSOperationQueue)</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œæ·»åŠ äº†ä¸€ä¸ªæ–°çš„å‚æ•°nodeConstructionQueue.å®ƒå°±æ˜¯ä¸€ä¸ªç”¨äºNodeåˆ›å»ºæ“ä½œå…¥é˜Ÿçš„NSOperationQueue.</p>

<p>åœ¨func configureCellDisplayWithCardInfo(
  cardInfo: RainforestCardInfo,
  nodeConstructionQueue: NSOperationQueue) åº•éƒ¨ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let newNodeConstructionOperation = nodeConstructionOperationWithCardInfo(cardInfo, image: image)
</span><span class='line'>nodeConstructionOperation = newNodeConstructionOperation
</span><span class='line'>nodeConstructionQueue.addOperation(newNodeConstructionOperation)</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±åˆ›å»ºäº†ä¸€ä¸ªNodeæ„é€ æ“ä½œï¼Œå°†å…¶ä¿ç•™åœ¨nodeConstructionOperationå±æ€§ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ä¼ å…¥çš„é˜Ÿåˆ—ã€‚</p>

<p>æœ€åæ‰“å¼€ RainforestViewController.swift ï¼Œç»™RainforestViewControlleræ·»åŠ ä¸€ä¸ªå«åšnodeConstructionQueue çš„åˆå§‹åŒ–ä¸ºå¸¸é‡çš„å±æ€§ï¼Œå¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class RainforestViewController: UICollectionViewController {
</span><span class='line'>  let rainforestCardsInfo = getAllCardInfo()
</span><span class='line'>  let nodeConstructionQueue = NSOperationQueue() ///&lt; ADD THIS LINE
</span><span class='line'>  ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œåœ¨collectionView(collectionView:cellForItemAtIndexPath indexPath:)é‡Œï¼Œä¼ é€’View Controllerçš„ nodeConstructionQueueåˆ° configureCellDisplayWithCardInfo(cardInfo:nodeConstructionQueue:) ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cell.configureCellDisplayWithCardInfo(cardInfo,Â nodeConstructionQueue:Â nodeConstructionQueue)</span></code></pre></td></tr></table></div></figure>


<p>cellå°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Nodeæ„é€ æ“ä½œå¹¶å°†å…¶æ·»åŠ åˆ°ViewControlerçš„æ“ä½œé˜Ÿåˆ—é‡Œå¹¶å‘è¿è¡Œã€‚è®°ä½åœ¨cellå‡ºé˜Ÿæ—¶å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Nodeå±‚æ¬¡ç»“æ„ã€‚è¿™å¹¶ä¸ç†æƒ³ï¼Œä½†è¶³å¤Ÿå¥½ã€‚å¦‚æœä½ è¦ç¼“å­˜Nodeçš„é‡ç”¨ï¼Œçœ‹çœ‹ASRangeController å§</p>

<p>OKï¼Œç¼–è¯‘è¿è¡Œï¼Œä½ è®²çœ‹åˆ°å’Œä¹‹å‰ä¸€æ ·çš„æ•ˆæœï¼Œä½†ç°åœ¨å¸ƒå±€å’Œæ¸²æŸ“éƒ½æ²¡åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œäº†ï¼Œç‰›ï¼æˆ‘æ‰“èµŒä½ ä»æ¥æ²¡æœ‰æƒ³è¿‡ä½ çœ‹åˆ°è¿™ä¸€å¤©ä½ æ‰€åšçš„äº‹æƒ…ï¼Œè¿™å°±æ˜¯AsyncDisplayKitçš„å¨åŠ›ã€‚ä½ å¯ä»¥å°†æ›´å¤šä¸éœ€è¦å†ä¸»çº¿ç¨‹æ“ä½œä»ä¸»çº¿ç¨‹ä¸­ç§»é™¤ï¼Œè¿™å°†ç»™ä¸»çº¿ç¨‹æ›´å¤šæœºä¼šå¤„ç†å’Œç”¨æˆ·çš„äº¤äº’ï¼Œè®©ä½ çš„Appæ‘¸èµ·æ¥å¦‚é»„æ²¹èˆ¬é¡ºæ»‘</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0019.png" alt="logo" /></p>

<h2>æ·¡å…¥Cell</h2>

<p>åœ¨è¿™ä¸ªå°±ç®€çŸ­çš„ç« èŠ‚ï¼Œä½ å°†ä¼šå­¦åˆ°:</p>

<ul>
<li>ç”¨è‡ªå®šä¹‰çš„Display Layerå­ç±»æ¥æ”¯æŒNode</li>
<li>è§¦å‘Node Layerçš„éšå¼åŠ¨ç”»</li>
</ul>


<p>è¿™å°†ä¼šç¡®ä¿ä½ çš„ç§»é™¤çˆ†ç±³èŠ±ç‰¹æ•ˆå¹¶æœ€ç»ˆå¸¦æ¥è‰¯å¥½çš„æ·¡å…¥åŠ¨ç”»</p>

<p>åˆ›å»ºä¸€ä¸ªæ–°çš„Layerå­ç±».</p>

<p>èœå• File\New\Fileâ€¦ ï¼Œé€‰æ‹© iOS\Source\Cocoa Touch Class å¹¶å•å‡»Next.å‘½åç±»ä¸ºAnimatedContentsDisplayLayerå¹¶ä½¿å…¶ä½œä¸º_ASDisplayLayerå­ç±»ã€‚é€‰æ‹© Swiftè¯­è¨€å¹¶å•å‡»Next.æœ€åä¿å­˜å¹¶æ‰“å¼€AnimatedContentsDisplayLayer.swift .</p>

<p>ç°åœ¨æ·»åŠ å¦‚ä¸‹æ–¹æ³•åˆ°ç±»:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>override func actionForKey(event: String!) -&gt; CAAction! {
</span><span class='line'>  if let action = super.actionForKey(event) {
</span><span class='line'>    return action
</span><span class='line'>  }
</span><span class='line'> 
</span><span class='line'>  if event == "contents" && contents == nil {
</span><span class='line'>    let transition = CATransition()
</span><span class='line'>    transition.duration = 0.6
</span><span class='line'>    transition.type = kCATransitionFade
</span><span class='line'>    return transition
</span><span class='line'>  }
</span><span class='line'> 
</span><span class='line'>  return nil
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Layeræœ‰ä¸€ä¸ªcontentså±æ€§ï¼Œå®ƒå‘Šè¯‰ç³»ç»Ÿä¸ºè¿™ä¸ªLayerç»˜åˆ¶ä»€ä¹ˆï¼ŒAsyncDisplayKité€šè¿‡åœ¨åå°æ¸²æŸ“contentså¹¶æœ€ååœ¨ä¸»çº¿ç¨‹è®¾ç½®contents</p>

<p>è¿™ä¸ªä»£ç å°†ä¼šæ·»åŠ ä¸€ä¸ªè¿‡æ¸¡åŠ¨ç”»ï¼Œè¿™æ ·contentså°±ä¼šæ·¡å…¥åˆ°Viewä¸­ï¼Œä½ å¯ä»¥åœ¨Appleçš„ <a href="https://developer.apple.com/library/mac/documentation/cocoa/conceptual/CoreAnimation_guide/ReactingtoLayerChanges/ReactingtoLayerChanges.html">Core Animation Prgramming Guide</a>æ‰¾åˆ°æ›´å¤šå…³äºéšå¼LayeråŠ¨ç”»</p>

<p>æ‰“å¼€ RainforestCardCell.swiftã€‚åœ¨nodeConstructionOperationWithCardInfo(cardInfo:image:) é‡Œï¼Œåœ¨Container Node Creation Sectionå¼€å¤´ï¼Œæ”¹åŠ¨å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// REPLACE THIS LINE...
</span><span class='line'>// let containerNode = ASDisplayNode()
</span><span class='line'>// ...WITH THIS LINE:
</span><span class='line'>let containerNode = ASDisplayNode(layerClass: AnimatedContentsDisplayLayer.self)</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¼šå‘Šè¯‰å®¹å™¨Nodeä½¿ç”¨AnimatedContentsDisplayLayerå®ä¾‹ä½œä¸ºå…¶æ”¯æŒLayer,å› æ­¤è‡ªåŠ¨å¸¦æ¥æ·¡å…¥æ•ˆæœ</p>

<blockquote><p><em>æ³¨æ„</em>
åªæœ‰_ASDisplayLayerçš„å­ç±»æ‰èƒ½è¢«å¼‚æ­¥åœ°ç»˜åˆ¶</p></blockquote>

<p>ç¼–è¯‘è¿è¡Œï¼Œä½ è®²çœ‹åˆ°å®¹å™¨Nodeä¼šåœ¨å…¶ç»˜åˆ¶å¥½ä¹‹åæ·¡å…¥.</p>

<p><img src="http://www.raywenderlich.com/wp-content/uploads/2014/10/IMG_0023.png" alt="logo" /></p>

<h2>å®Œæ•´å·¥ç¨‹</h2>

<p><a href="https://cdn3.raywenderlich.com/wp-content/uploads/2014/11/Layers-Finished-7.3.zip">å®Œæ•´å·¥ç¨‹</a>è¯·åœ¨è¿™é‡Œä¸‹è½½!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[é€šè¿‡ä¸€ä¸ªDemoè¯¦è§£UIStackView]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/04/tong-guo-%5B%3F%5D-ge-demoxiang-jie-uistackview/"/>
    <updated>2016-04-04T19:48:29+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/04/tong-guo-[?]-ge-demoxiang-jie-uistackview</id>
    <content type="html"><![CDATA[<p><a href="http://andrew-anlu.github.io/blog/2016/04/04/uistackviewjie-shao/">åœ¨ä¸Šä¸€ä¸ªç« èŠ‚</a>æˆ‘ä»¬å·²ç»ä»‹ç»äº†ä»€ä¹ˆæ˜¯UIStackViewäº†ï¼Œå…¶å®å®ƒæ›´ç±»ä¼¼äºAndroidå¼€å‘ä¸­çš„LinerLayeræ’ç‰ˆæŠ€æœ¯ã€‚</p>

<p>è¿™ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥è®²è§£UIStackViewçš„ç”¨æ³•</p>

<!--more-->


<h2>å¼€å§‹</h2>

<p>ä¸‹ä¸‹è½½è¿™ä¸ª<a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/VacationSpots_Starter.zip">å¼€å§‹å·¥ç¨‹</a>,ä¸‹è½½å®Œæ¯•åï¼Œç”¨Iphone6 æ¨¡æ‹Ÿå™¨è¿è¡Œèµ·æ¥ï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸€ä¸ªåº¦å‡æ—…æ¸¸çš„åˆ—è¡¨</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/01-table-view-is-now-correct_750x1334-281x500.png" alt="logo" />
ç‚¹å‡»ç¬¬ä¸€è¡Œcell,å’‹çœ‹ï¼Œè¿™ä¸ªè§†å›¾æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ä½ ä»”ç»†è§‚å¯Ÿï¼Œå°±ä¼šå‘ç°æœ‰å‡ ä¸ªé—®é¢˜:</p>

<ol>
<li>çœ‹è§†å›¾çš„ä¸‹é¢çš„é‚£ä¸€æ’æŒ‰é’®ï¼Œå®ƒä»¬ä¸­é—´éƒ½æœ‰ä¸€å®šé—´éš™è§„åˆ™å¸ƒå±€ï¼Œä½†æ˜¯å®ƒä»¬å¹¶æ²¡æœ‰é€‚é…æ•´ä¸ªå±å¹•çš„å¸ƒå±€ï¼Œçœ‹ç€æŒºä¸‘çš„ï¼Œä¸´æ—¶è½¬æ¢å±å¹•landscape orientation,é€šè¿‡ <code>Command-left</code></li>
</ol>


<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/02-issues-visible-in-landscape-view_1334x750-480x270.png" alt="logo" /></p>

<ol>
<li>åœ¨è¯¦æƒ…é¡µé¢ï¼Œç‚¹å‡»hiddenæŒ‰é’®ï¼Œå®ƒæˆåŠŸåœ°éšè—äº†æ–‡å­—ï¼Œä½†æ˜¯ä¸‹é¢çš„å†…å®¹å¹¶æ²¡æœ‰é¡¶ä¸Šå»ï¼Œä¸­é—´ä¸€ç‰‡ç©ºç™½
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/03-hide-weather-issue_750x1334-281x500.png" alt="logo" /></li>
</ol>


<p>ç°åœ¨ä½ å·²ç»æœ‰å‡ ç‚¹å¥½çš„å»ºè®®å»æå‡appçš„ä½“éªŒï¼Œç°åœ¨è®©æˆ‘ä»¬å¼€å§‹åˆ‡å…¥è¿™ä¸ªå·¥ç¨‹</p>

<p>æ‰“å¼€Main.storyboardç„¶åæ‰¾åˆ° <code>Spot Info View Controller</code>,è¿™é‡Œæœ‰ä¸€äº›é¢œè‰²åœ¨stackViewä¸­ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/04-colorful-scene-in-storyboard_504x636-396x500.png" alt="logo" /></p>

<p>è¿™äº›æ ‡ç­¾å’ŒæŒ‰é’®å·²ç»æœ‰å‡ ç§ä¸åŒé¢œè‰²çš„èƒŒæ™¯è‰²ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶ä»–ä»¬çš„èƒŒæ™¯è‰²å°±æ˜¯é€æ˜çš„ï¼Œåœ¨è¿™ä¸ªstoryboardä¸­ï¼Œä»–ä»¬ä»…ä»…æ˜¯ä¸ºäº†å¸®åŠ©ä½ å±•ç¤ºstackViewæ˜¯æ€ä¹ˆæ”¹å˜å±æ€§å½±å“åµŒå¥—çš„å­è§†å›¾</p>

<p>ä½ ä¸éœ€è¦åšè¿™äº›ï¼Œä½†æ˜¯ä»å¦ä¸€ä¸ªè§‚ç‚¹æ¥è¯´ä½ å®é™…ä¸Šå–œæ¬¢å»çœ‹çœ‹è¿™äº›èƒŒæ™¯è‰²å½“è¿è¡Œç¨‹åºçš„æ—¶å€™ï¼Œä½ èƒ½ä¸´æ—¶åšäº›æ”¹å˜åœ¨SpotInfoViewControllerçš„viewDidLoad()ä¸­:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Clear background colors from labels and buttons
</span><span class='line'>for view in backgroundColoredViews {
</span><span class='line'>  view.backgroundColor = UIColor.clearColor()
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å½“ç„¶ï¼Œå…¶å®ƒæ ‡ç­¾éƒ½æœ‰å ä½ç¬¦æ–‡å­—è¯´æ˜ï¼Œä»–ä»¬ä»…ä»…æ˜¯ä¸ºäº†è®©ä½ åŒºåˆ†å“ªäº›æ˜¯å’Œåå°è¿æ¥çš„ã€‚å“ªäº›æ˜¯æè¿°ä»€ä¹ˆå†…å®¹çš„ã€‚ä¾‹å¦‚<code>&lt;whyVisitLabel&gt;</code>æ˜¯è¿æ¥</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@IBOutlet weak var whyVisitLabel: UILabel!</span></code></pre></td></tr></table></div></figure>


<p>å¦å¤–ä¸€ä¸ªéœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™ä¸ªstoryboardä¸­ä¸æ˜¯é»˜è®¤çš„ 600 x 600,å½“ä½ ä½¿ç”¨SizeClassçš„æ—¶å€™ã€‚</p>

<p>SizeClassæ€»æ˜¯å¯ç”¨çš„ï¼Œä½†æ˜¯åˆå§‹åŒ–Navigation Controller é»˜è®¤æ˜¯æ€»æ˜¯iPhone 4-inchåœ¨æ¨¡æ‹Ÿå™¨ä¸‹ï¼Œè¿™ä¸ªæ˜¯å®¹æ˜“çš„åœ¨storyboardä¸­ï¼Œè¿™ä¸ªæ¨¡æ‹Ÿå™¨åœ¨å¯åŠ¨çš„æ—¶å€™æ˜¯ä¸å—å½±å“çš„ï¼Œè¿™ä¸ªè§†å›¾å°†ä¼šåŠ¨æ€é€‚åº”ä¸åŒçš„è®¾å¤‡ã€‚
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/05-simulated-metrics-iphone-4-inch_639x173.png" alt="logo" /></p>

<h2>ä½ çš„ç¬¬ä¸€ä¸ªStackView</h2>

<p>ç¬¬ä¸€ä»¶äº‹æ˜¯ä½ å°†é€šè¿‡ä¸€ä¸ªstackViewä¿®å¤æœ€ä¸‹é¢ä¸€æ’æŒ‰é’®çš„é—´è·ï¼Œä¸€ä¸ªstackViewèƒ½æè¿°åœ¨ä¸ä¸åŒè½´å‘çš„å¸ƒå±€ï¼ˆæ¨ªå‘åæ ‡å’Œçºµå‘åæ ‡ï¼‰ï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯å­è§†å›¾ä¹‹é—´çš„è·ç¦»è®¾ç½®ã€‚</p>

<p>å¹¸è¿çš„æ˜¯ï¼Œä¿®æ”¹å·²ç»å­˜åœ¨çš„Viewåœ¨ä¸€ä¸ªstackViewä¸­å¹¶ä¸å¤æ‚ï¼Œé€‰ä¸­ <code>Spot Info View Controller</code>åº•éƒ¨çš„æ‰€æœ‰æŒ‰é’®</p>

<p>æ£€æŸ¥è¿™ä¸‰ä¸ªæŒ‰é’®æ˜¯ä¸æ˜¯éƒ½é€‰æ‹©ä¸Šäº†ï¼Œæ‰“å¼€å·¦è¾¹çš„æ§ä»¶é¢æ¿æŸ¥çœ‹ï¼Œ
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/08-verify-button-selection_360x90.png" alt="logo" /></p>

<p>ä¸€æ—¦é€‰ä¸­äº†ï¼Œåœ¨storyboardçš„å³ä¸‹è§’ç‚¹å‡»new Stack button
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/09-stack_button_outlined_148x52.png" alt="logo" /></p>

<p>è¿™ä¸ªæŒ‰é’®å°†ä¼šå˜æˆåµŒå…¥å¼çš„åœ¨stackViewä¸­</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/10-bottom-row-is-now-in-stack-view_640x100.png" alt="logo" /></p>

<p>è¿™äº›æŒ‰é’®çœ‹èµ·æ¥ä¸æ˜¯å¹³æ»‘çš„ï¼Œç¨åæˆ‘ä»¬å°†ä¼šä¿®å¤</p>

<p>å½“è¿™ä¸ªstackViewå¼€å§‹åµŒå¥—è¿™äº›æŒ‰é’®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†è¦æ·»åŠ è‡ªåŠ¨å¸ƒå±€ç»™è¿™ä¸ªstackView</p>

<p>å½“ä½ åµŒå¥—ä¸€ä¸ªè§†å›¾åœ¨ä¸€ä¸ªstackViewä¸­ï¼Œè¿™ä¸ªè§†å›¾çš„ä»»ä½•çº¦æŸéƒ½ä¼šè¢«ç§»é™¤ï¼Œä¾‹å¦‚ï¼Œåœ¨åµŒå¥—åˆ°stackViewä¹‹é’±ï¼Œåœ¨æœ€å‰é¢çš„é‚£ä¸ªæŒ‰é’®<code>Submit Rating</code>æœ‰ä¸ªå‚ç›´è·ç¦»çš„çº¦æŸå’Œ<code>Rating:</code>labelä¹‹é—´:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/11-prior-constraint_420x90.png" alt="logo" /></p>

<p>ç‚¹å‡»<code>Submit Rating</code>æŒ‰é’®å»çœ‹çœ‹æ˜¯å¦è¿˜æœ‰è¿™ä¸ªçº¦æŸ:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/12-no-more-constraints_400x80.png" alt="logo" /></p>

<p>ä¸ºäº†ç»™stackViewæ·»åŠ çº¦æŸï¼Œé¦–å…ˆä½ å¿…é¡»é€‰ä¸­å®ƒï¼Œä¸€ä¸ªç®€å•çš„æ–¹å¼å»é€‰æ‹©è¿™ä¸ªstackViewåœ¨outline View:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/140040561762600.png" alt="logo" />
å¦å¤–ä¸€ç§æ–¹å¼æ˜¯æŒ‰ä½ shift&amp;Right-click åœ¨ä½ æƒ³é€‰æ‹©çš„è§†å›¾ä¸Šï¼Œæˆ–è€…æŒ‰é’® <code>control</code>+<code>shift</code>+<code>å·¦é”®ç‚¹å‡»</code>åœ¨ä½ æƒ³è¦é€‰æ‹©çš„è§†å›¾ä¸Šï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸€ä¸ªèœå•è§†å›¾ï¼Œä¾›ä½ é€‰æ‹©ã€‚
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/15-select-stack-view-in-view-hierarchy-menu_400x280.png" alt="logo" /></p>

<p>ç°åœ¨ï¼Œç‚¹å‡»pinæŒ‰é’®åœ¨è‡ªåŠ¨å¸ƒå±€çš„å·¥å…·æ¡ä¸Š  å» æ·»åŠ çº¦æŸã€‚</p>

<p>é¦–å…ˆæ£€æŸ¥Constrain to marginsï¼Œç„¶åæ·»åŠ ä¸‹è½½çš„çº¦æŸ:</p>

<pre><code>Top: 20, Leading: 0, Trailing: 0, Bottom: 0
</code></pre>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/17-bottom-stack-view-constraints_264x364.png" alt="logo" /></p>

<p>ç°åœ¨ï¼Œè¿™ä¸ªstackVeiwæ˜¯æ­£ç¡®çš„å°ºå¯¸ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ç‚¹æ‹‰ä¼¸ç¬¬ä¸€ä¸ªæŒ‰é’®ï¼Œå› ä¸ºå®ƒè¦å»åˆ©ç”¨å¤šä½™çš„ç©ºé—´ã€‚</p>

<p>stackViewæœ‰ä¸ª<code>distribution</code>å±æ€§æ¥å†³å®šå­è§†å›¾çš„å¸ƒå±€ï¼Œå½“å‰ï¼Œå®ƒæ˜¯fill,è¿™æ„å‘³ç€åŒ…å«çš„å­è§†å›¾éƒ½ä¼šå®Œå…¨å¡«å……stackviewå‰©ä¸‹çš„ç©ºé—´ï¼Œä¸ºäº†ä¿®è¡¥è¿™ä¸ªï¼Œè¿™ä¸ªstackViewå°†è¦å±•å¼€å…¶ä¸­çš„ä¸€ä¸ªå­è§†å›¾å»å¡«è¡¥è¿™ä¸ªå¤šä½™çš„ç©ºé—´</p>

<p>ç„¶è€Œï¼Œä½ å¹¶ä¸æœŸæœ›è¿™ä¸ªæŒ‰é’®å®Œå…¨å¡«å……stackViewï¼Œä½ æƒ³è®©ä»–ä»¬å ç”¨ç›¸åŒçš„ç©ºé—´ã€‚</p>

<p>é€‰ä¸­è¿™ä¸ªstackView,ç„¶åä¿®æ”¹å®ƒçš„å±æ€§<code>Distribution</code>ä»<code>Fill</code>åˆ°<code>Equal Spacing:</code>
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/19-change-distribution-to-equal-spacing_640x148.png" alt="logo" /></p>

<p>ç°åœ¨ç¼–è¯‘è¿è¡Œï¼Œç‚¹å‡»è¿™ä¸ªcell.æ—‹è½¬å±å¹•ï¼Œä½ å°†ä¼šçœ‹åˆ°åº•éƒ¨çš„æŒ‰é’®å¹³åˆ†åœ¨å±å¹•çš„åº•éƒ¨ï¼Œæ˜¯ä¸æ˜¯å¾ˆé…·å‘¢!
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/20-now-buttons-are-equally-spaced_1334x750-480x270.png" alt="logo" /></p>

<p>å¦‚æœä¸ä½¿ç”¨stackViewæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ ä¸å¾—ä¸ä½¿ç”¨sapce viewsï¼Œåœ¨æ²¡ä¸¤ä¸ªæŒ‰é’®ä¹‹é—´ï¼Œä½ çš„åŠ å…¥ç­‰æ¯”å®½åº¦çš„çº¦æŸã€‚å¾ˆæ˜¯éº»çƒ¦ã€‚
å®ƒçœ‹èµ·æ¥åƒæ˜¯ä¸‹é¢è¿™æ ·ï¼Œè¿™ä¸­é—´çš„space Viewçœ‹èµ·æ¥æœ‰ç‚¹ç°è‰²</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/21-alternate-solution-1_346x76.png" alt="logo" /></p>

<p>è¿™ä¸ªé—®é¢˜è¿˜æ˜¯ä¸æ˜¯å¾ˆå¤§åœ¨ä¸€ä¸ªstoryboardä¸­ï¼Œä½†æ˜¯å¾ˆå¤šè§†å›¾éƒ½æ˜¯åŠ¨æ€çš„ï¼Œè¿™å°±ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ä»»åŠ¡äº†ï¼Œåœ¨è¿è¡Œæ—¶å»å¢åŠ ä¸€ä¸ªæŒ‰é’®æˆ–è€…éšè—ä¸€ä¸ªæŒ‰é’®ï¼Œå› ä¸ºéœ€è¦å»è°ƒèŠ‚è§†å›¾å’Œçº¦æŸä¹‹é—´çš„å…³ç³»ã€‚</p>

<p>ä¸ºäº†åœ¨ä¸€ä¸ªstack viewä¸­éšè—ä¸€ä¸ªè§†å›¾ï¼Œä½ ä¸å¾—ä¸è®¾ç½®å­è§†å›¾çš„hiddenå±æ€§ä¸ºtrue.ç°åœ¨ä½ å°†è¦ä¿®å¤ä¹‹å‰è¯´è¿‡çš„é‚£ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“ç‚¹å‡» hiddenä¹‹åï¼Œæ–‡å­—æ¶ˆå¤±ï¼Œä¸‹é¢çš„å¤šä½™ç©ºé—´è¦é¡¶ä¸Šå»ã€‚</p>

<h2>è½¬æ¢Sections</h2>

<p>ä½ å°†è¦è½¬æ¢æ‰€æœ‰çš„sectionç”¨stack viewä¸­ï¼Œè¿™å°†è¦ç¡®ä¿ä½ å®¹æ˜“çš„å®Œæˆä½ çš„ä»»åŠ¡ï¼Œä¸‹ä¸€æ­¥ä½ å°†è¦è½¬æ¢ rating section.</p>

<h3>Rating section</h3>

<p>å®šä½åˆ°ä½ åˆšæ‰çš„é¡µé¢ï¼Œç„¶åé€‰æ‹©<code>RATING</code>æ ‡ç­¾å’Œ æ˜Ÿæ˜Ÿçš„è§†å›¾ï¼š
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/22-select-rating-label-and-stars-label_640x74.png" alt="logo" />
ç„¶åç‚¹å‡» stackæŒ‰é’®è®©å…¶åµŒå¥—åœ¨ä¸€ä¸ªstackViewä¸­ã€‚
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/23-after-clicking-stack-button_640x74.png" alt="logo" />
 ç°åœ¨ï¼Œç‚¹å‡»PINæŒ‰é’®ï¼Œæ·»åŠ ä¸‹é¢ä¸‰ä¸ªå±æ€§:</p>

<pre><code class="`"> Top: 20, Leading: 0, Bottom: 20
</code></pre>

<p> <img src="http://7xkxhx.com1.z0.glb.clouddn.com/24-add-second-stack-view-constraints_264x171.png" alt="logo" /></p>

<p> ç°åœ¨åˆ‡æ¢åˆ°<code>Attributes inspector</code>ï¼Œè®¾ç½® spacingä¸º8:
 <img src="http://7xkxhx.com1.z0.glb.clouddn.com/25-set-spacing-to-8_259x87.png" alt="logo" /></p>

<p> è¿™æ—¶ï¼Œä½ çœ‹åˆ°è§†å›¾ä¸Šçš„ä¸¤ä¸ªæ§ä»¶ä¹‹é—´å·²ç»æœ‰äº›é—´è·äº†ï¼Œ
 <img src="http://7xkxhx.com1.z0.glb.clouddn.com/26-stars-label-weirdly-stretched_640x85.png" alt="logo" />
 æœ‰æ—¶å€™ï¼Œxcodeå¯èƒ½æç¤ºä½ stackviewçš„ä½ç½®æ˜¯ä¸æ­£ç¡®çš„ï¼Œä½†æ˜¯è¿™äº›è­¦å‘Šå°†ä¼šæ¶ˆå¤±ï¼Œå½“ä½ æ›´æ–°å…¶å®ƒæ§ä»¶çš„æ—¶å€™ï¼Œä½ é€šå¸¸å¯ä»¥å¿½ç•¥ä»–ä»¬ã€‚</p>

<p>ä¸ºäº†è¯æ˜è¿™ä¸ªï¼Œæ”¹å˜ <code>Alignment</code>ä»<code>Fill</code>åˆ°<code>Top</code>ç„¶åå†æ”¹ä¸ºFill,ä½ å°†ä¼šçœ‹åˆ°è¿™ä¸ªstars æ ‡ç­¾å˜æˆæ­£ç¡®çš„ä½ç½®äº†ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„app,ä¸€åˆ‡çœ‹èµ·æ¥è¿˜æ˜¯å’Œä»å‰ä¸€æ ·.</p>

<h2>å–æ¶ˆåµŒå¥—ä¸€ä¸ªStack View</h2>

<p>åœ¨ä½ æ·±å…¥å­¦ä¹ ä¹‹å‰ï¼Œå»è¿›è¡Œä¸€äº›"æ€¥æ•‘"è®­ç»ƒï¼Œæœ‰æ—¶ï¼Œä½ ä¼šå‘ç°ä½ çš„è§†å›¾ä¸Šæœ‰ä¸€ä¸ªä½ ä¸å†éœ€è¦çš„stackview,æˆ–è®¸ä½ ä¸ºäº†ç»ƒä¹ è€Œå¯¼è‡´çš„äº‹æ•…ã€‚</p>

<p>å¹¸è¿çš„æ˜¯ï¼Œè¿™é‡Œæœ‰å®¹æ˜“çš„æ–¹å¼å»ç§»é™¤ä¸€ä¸ªåµŒå¥—çš„viewä»stack viewä¸­ã€‚</p>

<p>é¦–å…ˆï¼Œä½ æœ€å¥½é€‰æ‹©ä½ æƒ³è¦åˆ é™¤çš„stack view,æŒ‰ä½<code>Option</code>é”®ï¼Œç„¶åç‚¹å‡» <code>stack</code>æŒ‰é’®ï¼Œç‚¹å‡» <code>Unembed</code>èœå•å°±å¯ä»¥äº†:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/28-how-to-unembed_186x71.png" alt="logo" /></p>

<h2>ä½ çš„ç¬¬ä¸€ä¸ªå‚ç›´Stack view</h2>

<p>ç°åœ¨ï¼Œä½ å°†è¦åˆ›å»ºä¸€ä¸ªå‚ç›´çš„stack view,é€‰ä¸­<code>WHY VISIT</code>æ ‡ç­¾å’Œ<code>&lt;whyVisitLabel&gt;</code>ï¼š
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/29-select-why-visit-labels_640x90.png" alt="logo" />
Xcodeå°†ä¼šæ­£ç¡®çš„æ¨æ–­å‡ºè¿™ä¸ªè§†å›¾å°†ä¼šéœ€è¦ä¸€ä¸ªå‚ç›´çš„stack view,ç‚¹å‡»<code>Stack</code>æŒ‰é’®å»åµŒå¥—å®ƒä»¬åˆ°ä¸€ä¸ªstack viewä¸­ã€‚</p>

<p>å½“stack viewæ·»åŠ æˆåŠŸä¹‹åï¼ŒåµŒå¥—çš„è§†å›¾çš„çº¦æŸå°†ä¼šç»™åˆ é™¤ï¼Œå½“å‰çš„è¿™ä¸ªstack viewæ²¡æœ‰ä»»ä½•çº¦æŸï¼Œæ‰€ä»¥å®ƒä¼šé€‚é…å­è§†å›¾ä¸­æœ€å¤§å°ºå¯¸çš„ã€‚</p>

<p>å½“è¿™ä¸ªstack viewé€‰ä¸­çš„æ—¶å€™ï¼Œç‚¹å‡» PinæŒ‰é’®ï¼Œè®¾ç½®å¦‚ä¸‹å±æ€§:
Top, Leading and Trailing éƒ½ä¸º0</p>

<p>ç„¶åï¼Œç‚¹å‡»dropdownåœ¨å³ä¸‹è§’ï¼Œç„¶åé€‰æ‹©<code>WEATHER (current distance = 20):</code></p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/31-dont-select-nearest-neighbor-constraint_463x417.png" alt="logo" /></p>

<p>æœ€åï¼Œæ·»åŠ è¿™4ä¸ªçº¦æŸï¼Œä½ å°†ä¼šçœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/32-why-visit-stack-view-stretched_640x90.png" alt="logo" />
ç°åœ¨ä½ æœ‰ä¸¤ä¸ªä¸€ä¸ªå±•å¼€çš„stackview,å®ƒçš„å³è¾¹ç•Œæ˜¯å®šä½åˆ°äº†è§†å›¾çš„å³è¾¹ç•Œï¼Œç„¶è€Œï¼Œè¿™ä¸‹é¢çš„æ ‡ç­¾ä¾ç„¶æ˜¯åŒæ ·å®½çš„ï¼Œä½ å°†è¦ä¿®å¤å®ƒé€šè¿‡stack viewçš„<code>alignment</code>å±æ€§</p>

<h2>Alignmentå±æ€§</h2>

<p>è¿™ä¸ªalignmentå±æ€§å†³å®šäº†stack viewåœ¨å…¶è½´å‘ä¸Šçš„å¸ƒå±€æ–¹å¼ï¼Œå¯èƒ½æ˜¯Fill,Leading,Centerå’ŒTrailing.</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/33-horizontal-and-vertical-alignment_594x171.png" alt="logo" /></p>

<p>åœ¨å‚ç›´çš„stackviewä¸­ï¼Œé€‰æ‹©ä¸åŒçš„å±æ€§ï¼Œå°†ä¼šçœ‹åˆ°ä¸åŒçš„å¸ƒå±€:</p>

<p>Fill:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/34-alignment-fill_640x64.png" alt="logo" /></p>

<p>Leading:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/35-alignment-leading_640x64.png" alt="logo" /></p>

<p>Center:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/36-alignment-center_640x64.png" alt="lgo" /></p>

<p>Trailing:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/37-alignment-trailing_640x64.png" alt="lgo" /></p>

<p>å½“ä½ æµ‹è¯•å®Œæ¯ä¸ªå±æ€§å€¼åï¼Œæœ€åè®¾ç½®æˆFill</p>

<p>ç¼–è¯‘è¿è¡Œç¨‹åºçœ‹èµ·æ¥æ˜¯OKçš„ï¼Œç‰¹åˆ«éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œ<code>Fill</code>æ„å‘³ç€ä½ æƒ³è¦æ‰€æœ‰çš„è§†å›¾éƒ½æ˜¯å®Œå…¨å ç”¨ç©ºé—´åœ¨å…¶è½´å‘ä¸Šï¼Œè¿™å°†å¼•èµ·<code>WHY VISIT</code>æ ‡ç­¾å»å±•å¼€å®ƒåˆ°å³è¾¹ç¼˜ã€‚</p>

<p>ä½†æ˜¯å¦‚æœä½ åªæƒ³ä¸‹é¢çš„labelå¼ å¼€åˆ°å³è¾¹ç¼˜ï¼Œæ­¤æ—¶è¯¥æ€ä¹ˆåšå‘¢?</p>

<h2>è½¬æ¢"what to see"æ¨¡å—</h2>

<p>è¿™ä¸ªè½¬æ¢å’Œä¸Šé¢çš„é‚£ä¸ªå¾ˆç›¸ä¼¼ï¼Œä»‹ç»å¦‚ä¸‹:</p>

<ol>
<li>é¦–å…ˆï¼Œé€‰æ‹©<code>WHAT TO SEE</code>æ ‡ç­¾å’Œ<code>&lt;whatToSeeLabel&gt;</code></li>
<li>ç‚¹å‡»<code>Stack</code>æŒ‰é’®</li>
<li>ç‚¹å‡»<code>Pin</code>æŒ‰é’®</li>
<li>è®¾ç½®<code>margins</code>çº¦æŸï¼Œæ·»åŠ ä¸‹é¢4ä¸ªçº¦æŸ</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Top: 20, Leading: 0, Trailing: 0, Bottom: 20</span></code></pre></td></tr></table></div></figure>


<ol>
<li>è®¾ç½®stack viewçš„Alignmentä¸ºFIll</li>
</ol>


<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/39-after-what-to-see-section_640x308.png" alt="logo" />
ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼ŒéªŒè¯é¡µé¢æ˜¯ä¸æ˜¯çœ‹èµ·æ¥å’Œä¹‹å‰ä¸€æ ·ã€‚</p>

<p>å‰©ä¸‹å°±æ˜¯è¿™ä¸ª<code>weather</code>æ¨¡å—äº†</p>

<h2>è½¬æ¢weatheræ¨¡å—</h2>

<p>è¿™ä¸ªweatheræ¨¡å—æ¯”å…¶ä»–å‡ ä¸ªç¨å¾®å¤æ‚ä¸€äº›ï¼Œå› ä¸ºå®ƒåŒ…å«äº†ä¸€ä¸ªhiddenæŒ‰é’®</p>

<p>ä¸€ç§æ–¹æ³•æ˜¯ä½ å°†ä¼šåˆ›å»ºä¸€ä¸ªæœ€è¿‘çš„stacviewé€šè¿‡åµŒå¥—<code>WEATHER</code>æ ‡ç­¾å’Œ<code>Hide</code>æŒ‰é’®åœ¨ä¸€ä¸ªæ°´å¹³çš„stackviewä¸­ï¼Œç„¶ååµŒå¥—æ°´å¹³çš„stackviewå’Œ<code>&lt;weatherInfoLabel&gt;</code>åˆ°ä¸€ä¸ªå‚ç›´çš„stackviewä¸­ã€‚</p>

<p>çœ‹èµ·æ¥ä½ åƒæ˜¯è¿™æ ·:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/40-weather-stack-in-stack_640x92.png" alt="lgo" /></p>

<p>ç‚¹å‡»<code>Stack</code>æŒ‰é’®:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/43-weather-click-stack-button_640x92.png" alt="logo" /></p>

<p>ç„¶åç‚¹å‡» PinæŒ‰é’®ï¼Œè®¾ç½®marginçº¦æŸ,è®¾ç½®å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Top: 20, Leading: 0, Trailing: 0, Bottom: 20</span></code></pre></td></tr></table></div></figure>


<p>è®¾ç½® stack viewçš„Alignmentä¸ºFill
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/44-weather-alignment-fill_640x92.png" alt="logo" /></p>

<p>ä½ éœ€è¦ä¸€ä¸ªåœ¨hideæŒ‰é’®å’Œ<code>WEATHER</code>æ ‡ç­¾çš„å³è¾¹åŠ ä¸€ä¸ªçº¦æŸï¼Œå› ä¸º<code>WEATHER</code>æ ‡ç­¾è¢«åŠ åˆ°äº†stack viewä¸­ï¼Œå®ƒçš„æ‰€æœ‰çº¦æŸéƒ½è¢«è‡ªåŠ¨å»æ‰äº†.</p>

<p>ç„¶åï¼Œä½ å¸Œæœ›åº•éƒ¨çš„<code>&lt;weatherInfoLabel&gt;</code>å»å¡«å……æ•´ä¸ªstack view.</p>

<p>ä½ å¯ä»¥å®Œæˆè¿™ä¸ªé€šè¿‡æŠŠ<code>WEATHER</code>åµŒå¥—è¿›ä¸€ä¸ªå‚ç›´çš„stack viewä¸­ï¼Œè®°ä½å‚ç›´stackviewå¯ä»¥è®¾ç½®alignmentä¸º .Leading,å‡å¦‚stack viewæ˜¯æ‹‰ä¼¸çš„è¶…å‡ºäº†å®ƒå›ºæœ‰çš„è¾¹ç•Œï¼Œå®ƒåŒ…å«çš„å­è§†å›¾å°†ä¼šåˆ°è¾¾å®ƒçš„è¾¹ç•Œã€‚</p>

<p>é€‰æ‹©<code>WEATHER</code>æ ‡ç­¾é€šè¿‡document outlineï¼Œæˆ–è€…é€šè¿‡<code>Control-Shift-click</code>æ–¹æ³•:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/45-select-just-the-weather-label_640x92.png" alt="logo" /></p>

<p>ç‚¹å‡» stackæŒ‰é’®:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/46-weather-in-horizontal-stack_640x92.png" alt="lgo" /></p>

<p>è®¾ç½®Alignmentä¸ºLeading,ç„¶åç¡®ä¿axisæ˜¯å‚ç›´æ–¹å‘:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/47-vertical-and-leading_640x92.png" alt="log" /></p>

<p>å®Œç¾ï¼ä½ å·²ç»å®Œæˆäº†å¤–éƒ¨çš„stackviewå¹³é“ºï¼Œåœ¨åµŒå¥—çš„stackViewä¸­å»å¡«å……å®ƒçš„å®½åº¦ï¼Œä½†æ˜¯å†…éƒ¨çš„stackviewå…è®¸è¿™ä¸ªæ ‡ç­¾å»ä¿æŒå®ƒåŸæœ‰çš„å®½åº¦ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œï¼Œä¸ºä»€ä¹ˆhideæŒ‰é’®ç°åœ¨é£˜åˆ°ä¸Šé¢å»äº†å‘¢ï¼Ÿ
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/48-hide-label-incorrect-position_750x573-419x320.png" alt="dlo" /></p>

<p>å®ƒæ˜¯å› ä¸ºå½“ä½ åµŒå¥—<code>WEATHER</code>æ ‡ç­¾åˆ°ä¸€ä¸ªstackviewä¸­æ—¶ï¼Œå®ƒçš„æ‰€æœ‰å’ŒhideæŒ‰é’®ç›¸å…³çš„çº¦æŸéƒ½è¢«ç§»é™¤æ‰äº†ã€‚</p>

<p>ç°åœ¨ä½ éœ€è¦ç»™hideæŒ‰é’®å’Œ<code>WEATHER</code>æ ‡ç­¾ä¹‹é—´å¢åŠ æ–°çš„çº¦æŸ,æŒ‰ä½<code>control-drag</code>ä»HideæŒ‰é’®æ‹–å‘<code>WEATHER</code>æ ‡ç­¾:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/49-drag-to-weather-label_380x94.png" alt="logo" /></p>

<p>æ·»åŠ ä¸¤ä¸ªçº¦æŸ:</p>

<ol>
<li>Horizontal Spacing</li>
<li>Baseline</li>
</ol>


<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/50-add-multiple-constraints_380x224.png" alt="logo" />
ç¼–è¯‘è¿è¡Œï¼Œè¿™ä¸ªHideæŒ‰é’®çœ‹èµ·æ¥æ­£å¸¸äº†ã€‚</p>

<p>ç°åœ¨æ‰€æœ‰çš„æ¨¡å—éƒ½æ˜¯åœ¨å”¯ä¸€çš„stackviewä¸­äº†ï¼Œä½ æŠŠä»–ä»¬å…¨éƒ¨éƒ½åµŒå¥—è¿›äº†stackviewä¸­ã€‚</p>

<h2>è®¾ç½®ç¬¬ä¸€çº§Stack view</h2>

<p>ç‚¹å‡» <code>command</code> ç„¶åé€‰æ‹©æ‰€æœ‰çš„5ä¸ªé¡¶çº§çš„stackviewåœ¨ outline viewä¸­
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/52-select-all-stack-views-in-outline_640x260.png" alt="log" /></p>

<p>ç„¶åç‚¹å‡»stackæŒ‰é’®ï¼š
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/53-stack-all-the-views_640x185.png" alt="lgo" /></p>

<p>ç‚¹å‡»PinæŒ‰é’®ï¼Œè®¾ç½®çº¦æŸå±æ€§:
å…¨éƒ¨éƒ½è®¾ç½®æˆ0.ç„¶åè®¾ç½®Spacingä¸º20, Alignmentä¸ºFill,ä½ çš„storyboardçœ‹èµ·æ¥åƒæ˜¯è¿™æ ·:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/54-set-the-spacing-to-20-and-alignment-to-fill_640x300.png" alt="g" /></p>

<p>ç¼–è¯‘è¿è¡Œï¼Œæ­¤æ—¶ä½ çš„ hideæŒ‰é’®åˆè·‘åäº†ï¼Œå’Œä¹‹å‰è®¾ç½®çš„ä¸€æ ·ï¼Œéœ€è¦æŠŠhideå’Œ<code>WEATHER</code>é‡æ–°å»ºç«‹çº¦æŸ:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/56-add-constraints-to-button-again_380x223.png" alt="d" /></p>

<p>ç¼–è¯‘è¿è¡Œï¼Œæ­¤æ—¶hideæŒ‰é’®åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šäº†ã€‚</p>

<h2>é‡æ–°å¸ƒå±€è§†å›¾</h2>

<p>ç°åœ¨æ‰€æœ‰çš„çš„æ¨¡å—éƒ½åœ¨é¡¶çº§çš„stackviewä¸­ï¼Œä½ ç°åœ¨å¯ä»¥æ›´æ”¹<code>what to see</code>æ¨¡å—çš„ä½ç½®ï¼Œæ¯”å¦‚å’Œ<code>weather</code>æ¨¡å—çš„ä½ç½®è¿›è¡Œäº’æ¢ã€‚</p>

<p>é€‰æ‹©<code>middle stack view</code>ä»outline viewç„¶åæ‹–æ‹½å®ƒå’Œweatherçš„é‚£ä¸ªstackviewè¿›è¡Œäº’æ¢ï¼Œ
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/57-drag-and-drop-to-reposition-section_639x130.png" alt="log" /></p>

<p>æ­¤æ—¶ï¼Œ<code>weather</code>æ¨¡å—æ˜¯ç¬¬ä¸‰ä¸ªæ¨¡å—ï¼Œä½†æ˜¯è¿™ä¸ª hideæŒ‰é’®ä¸æ˜¯åœ¨stackviewä¸­ï¼Œå®ƒä¸ä¼šè¢«ç§»åŠ¨ã€‚</p>

<p>é€‰ä¸­ HideæŒ‰é’® :
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/58-hide-button-not-moved_640x130.png" alt="logo" />
ç„¶åç‚¹å‡»<code>Resolve Auto Layout Issues</code>åœ¨è‡ªåŠ¨å¸ƒå±€çš„èœå•ä¸Šç‚¹å‡» update frame:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/59-resolve-auto-layout-issues_356x269.png" alt="logo" /></p>

<h2>Size class based configuration</h2>

<p>æœ€åï¼Œä½ èƒ½æŠŠä½ æ³¨æ„åŠ›é›†ä¸­åˆ°ä¹‹å‰çš„ä»»åŠ¡æ¸…å•ä¸Šï¼Œåœ¨åŠ è½½æ¨¡å¼ä¸­ï¼Œå‚ç›´ç©ºé—´æ˜¯æ˜‚è´µçš„ï¼Œæ‰€ä»¥ä½ æƒ³è®©stackviewä¸­çš„æ¨¡å—é è¿‘äº›ï¼Œä¸ºäº†åšåˆ°è¿™äº›ï¼Œä½ å°†è¦ä½¿ç”¨size classeså»è®¾ç½®é¡¶éƒ¨stackviewçš„ç©ºé—´ä»20ä¿®æ”¹æˆ10.</p>

<p>é€‰ä¸­é¡¶éƒ¨çš„stackviewç„¶åç‚¹å‡»å°å°çš„<code>+</code>å·ï¼Œè®¾ç½®spacing:</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/61-select-plus-button_260x120.png" alt="log" /></p>

<p>é€‰æ‹© Any Width > Compact Height:</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/62-anywidth-compact-height_403x108.png" alt="lgo" /></p>

<p>ç„¶åè®¾ç½®Spacing ä¸º10,åœ¨ new wAny hCæ–‡æœ¬æ¡†ä¸­:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/63-set-spacing-to-10_260x160.png" alt="lgo" /></p>

<h2>åŠ¨ç”»</h2>

<p>æ‰“å¼€SpotInfoViewController.swiftæ–‡ä»¶ï¼Œç„¶åæ‰¾åˆ°<code>updateWeatherInfoViews(hideWeatherInfo:animated:).</code>æ–¹æ³•</p>

<p>ä½ å°†è¦æ›¿æ¢è¿™ä¸€è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>weatherInfoLabel.hidden = shouldHideWeatherInfo</span></code></pre></td></tr></table></div></figure>


<p>æ”¹æˆå¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if animated {
</span><span class='line'>  UIView.animateWithDuration(0.3) {
</span><span class='line'>    self.weatherInfoLabel.hidden = shouldHideWeatherInfo
</span><span class='line'>  }
</span><span class='line'>} else {
</span><span class='line'>  weatherInfoLabel.hidden = shouldHideWeatherInfo
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç¼–è¯‘è¿è¡Œï¼Œç‚¹å‡»<code>hide</code>å’Œ<code>show</code>æŒ‰é’®ï¼Œä¼šä¸ä¼šæ„Ÿè§‰å‡ºæ¥æœ‰ç‚¹åŠ¨ç”»æ•ˆæœå‘¢?</p>

<p>åœ¨stackviewä¸­å¢åŠ åŠ¨ç”»æ•ˆæœä¹Ÿæ˜¯å¾ˆå®¹æ˜“çš„ï¼Œæ¯”å¦‚hidden, alignment, distribution, spacingï¼Œç”šè‡³axisã€‚</p>

<h2>å®Œæ•´å·¥ç¨‹ä¸‹è½½</h2>

<p>ä½ å¯ä»¥ä¸‹è½½å®Œæ•´çš„å·¥ç¨‹ <a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/VacationSpots_Complete.zip">å®Œæ•´å·¥ç¨‹</a></p>

<p>å¸Œæœ›èƒ½å¤Ÿå¸®åˆ°ä½ ~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UIStackViewä»‹ç»]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/04/uistackviewjie-shao/"/>
    <updated>2016-04-04T15:47:37+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/04/uistackviewjie-shao</id>
    <content type="html"><![CDATA[<p>UIStackViewç±»æä¾›äº†ä¸€ä¸ªé«˜æ•ˆçš„æ¥å£ç”¨äºå¹³é“ºä¸€è¡Œæˆ–ä¸€åˆ—çš„è§†å›¾ç»„åˆ.Stackè§†å›¾ä½¿ä½ çš„ä¾é è‡ªåŠ¨å¸ƒå±€çš„èƒ½åŠ›ï¼Œåˆ›å»ºç”¨æˆ·æ¥å£ä½¿å¾—å¯ä»¥åŠ¨æ€çš„è°ƒæ•´è®¾å¤‡çš„æœå‘ï¼Œå±å¹•å°ºå¯¸ä»¥åŠä»»ä½•å¯ç”¨èŒƒå›´å†…çš„å˜åŒ–ã€‚Stackè§†å›¾ç®¡ç†ç€æ‰€æœ‰å®ƒçš„ arrageedSubviewså±æ€§ä¸­è§†å›¾çš„å¸ƒå±€ï¼Œè¿™äº›è§†å›¾æ ¹æ®å®ƒä»¬åœ¨arrangedSubviewsæ•°ç»„ä¸­çš„é¡ºåºæ²¿ç€stackè§†å›¾çš„è½´å‘æ’åˆ—ï¼Œç²¾ç¡®çš„å¸ƒå±€å˜é‡æ ¹æ®Stackè§†å›¾çš„ axixs,distribution,allignment,spcing,å’Œå…¶å®ƒå±æ€§å†³å®šã€‚</p>

<!--more-->


<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/130054395519774.png" alt="logo" /></p>

<p>ä½¿ç”¨ Stackè§†å›¾ï¼Œæ‰“å¼€ä¸€ä¸ªä½ å¸Œæœ›ç¼–è¾‘çš„storyboard,ä»å¯¹è±¡åº“ä¸­æ‹–å‡ºä¸€ä¸ªHorizontal Stack Viewæˆ–è€…Vertical Stack View,å¹¶æ”¾ç½®åˆ°ä½ å¸Œæœ›çš„ä½ç½®ä¸Šï¼Œä¸‹ä¸€æ­¥ï¼Œå°†æ§ä»¶æˆ–è§†å›¾æ‹–æ‹½åˆ°stackä¸­ï¼Œå¦‚æœéœ€è¦ä½ å¯ä»¥ç»§ç»­æ·»åŠ è§†å›¾æˆ–è€…æ§ä»¶ç»™æŒ‡å®šçš„statck.Interface buiderå°†æ ¹æ®stackå†…å®¹è‡ªåŠ¨è°ƒèŠ‚å°ºå¯¸ï¼Œä½ å¯ä»¥é€šè¿‡ä¿®æ”¹å°šéœ€ç»é¢æ¿ä¸­stackè§†å›¾çš„å±æ€§è°ƒæ•´statckçš„å¤–è§‚.</p>

<h2>Stackè§†å›¾ä¸è‡ªåŠ¨å¸ƒå±€</h2>

<p>Stackè§†å›¾ä½¿ç”¨è‡ªåŠ¨å¸ƒå±€æ¥å®šä½å’Œæ§åˆ¶å…¶ç®¡ç†çš„è§†å›¾çš„å°ºå¯¸ï¼Œstackè§†å›¾æ²¿ç€å®ƒçš„è½´å‘æ‹¼å‡‘ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªè¢«ç®¡ç†çš„è§†å›¾ï¼Œä½¿å…¶ä¾¿æ·å¹³é½ã€‚å¯¹ä¸€ä¸ªæœˆæ°´å¹³stackè§†å›¾ï¼Œè¿™æ„å‘³ç€ç¬¬ä¸€ä¸ªè¢«ç®¡ç†çš„è§†å›¾çš„å·¦è¾¹ç•Œæ˜¯ä¸stackçš„å·¦è¾¹ç•Œå¯¹é½çš„ï¼Œå¹¶ä¸”æœ€åä¸€ä¸ªè¢«ç®¡ç†çš„è§†å›¾å³è¾¹ç•Œä¸stackå³è¾¹ç•Œæ˜¯å¹³é½çš„ã€‚å¯¹äºå‚ç›´stack,ä¸Šè¾¹ç•Œå’Œä¸‹è¾¹ç•Œæ ¼å¼å¯¹é½çš„ã€‚å¦‚æœä½ è®¾ç½®äº†stackè§†å›¾çš„ <code>layoutMarginsRelativeArrangement</code>ä¸ºYES,stackè§†å›¾å°†ä½¿ç”¨ç›¸å…³çš„è¾¹è·ä¸å…¶å†…å®¹å¯¹é½ï¼Œè€Œä¸æ˜¯è¾¹ç•Œã€‚</p>

<p>å¯¹äºé™¤å»<code>UIStackViewDistributionFillEqually</code>åˆ†å¸ƒä»¥å¤–çš„åˆ†å¸ƒæ–¹å¼ï¼Œstackè§†å›¾ä½¿ç”¨è¢«ç®¡ç†è§†å›¾çš„<code>intrinsicContentSize</code>å±æ€§æ¥è®¡ç®—æ²¿ç€stackè½´å‘çš„è§†å›¾å°ºå¯¸ï¼Œ<code>UIStackViewDistributionFillEqually</code>åˆ†å¸ƒå°†è°ƒèŠ‚æ‰€æœ‰è¢«ç®¡ç†è§†å›¾çš„åœ¨stackè½´å‘ä¸Šæ‹¥æœ‰ç›¸åŒå°ºå¯¸ï¼Œä»¥å¡«å……stackè§†å›¾ã€‚å¦‚æœå¯èƒ½ï¼Œstackè§†å›¾å°†æ‹‰ä¼¸æ‰€æœ‰è¢«ç®¡ç†çš„è§†å›¾ï¼Œæ¥åŒ¹é…å…¶åœ¨stackè½´å‘ä¸Šæœ€é•¿çš„åŸæœ‰å°ºå¯¸ã€‚</p>

<p>å¯¹äºé™¤å»<code>UIStackViewAlignmentFill</code>å¯¹é½ä»¥å¤–çš„å¯¹é½æ–¹å¼ï¼Œstackè§†å›¾ä½¿ç”¨å…¶ç®¡ç†çš„è§†å›¾çš„<code>intrinsicContentSize</code>å±æ€§æ¥è®¡ç®—è§†å›¾å‚ç›´äºstackè½´å‘çš„å°ºå¯¸ã€‚<code>UIStackViewAlignmentFill</code>é‡æ–°è°ƒèŠ‚äº†æ‰€æœ‰å…¶ç®¡ç†çš„è§†å›¾ï¼Œä½¿è¿™äº›è§†å›¾å¡«å……stackè§†å›¾å‚ç›´äºå…¶è½´å‘ç©ºé—´ã€‚å¦‚æœå¯èƒ½ï¼Œstackè§†å›¾å°†æ‹‰ä¼¸æ‰€æœ‰ç®¡ç†çš„è§†å›¾æ¥åŒ¹é…å…¶å‚ç›´äºstackè½´å‘çš„æœ€å¤§å›ºæœ‰å°ºå¯¸ã€‚</p>

<h2>å®šä½å’Œè°ƒæ•´Stackè§†å›¾å°ºå¯¸</h2>

<p>å½“stackè§†å›¾å…è®¸ä½ å¸ƒå±€å…¶å†…å®¹è€Œä¸ç›´æ¥ä½¿ç”¨è‡ªåŠ¨å¸ƒå±€ï¼Œä½ å°†ä»ç„¶éœ€è¦ä½¿ç”¨è‡ªåŠ¨å¸ƒå±€æ¥å®šä½stackè§†å›¾ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€éœ€è¦çš®å‡‘è‡³å°‘ä¸¤ä¸ªè¾¹ç•Œç›¸é‚»çš„stackæ¥å®šä¹‰å®ƒçš„ä½ç½®ï¼Œæ²¡æœ‰é¢å¤–çº¦æŸçš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šä¸ºstackè§†å›¾è®¡ç®—ä¸€ä¸ªå°ºå¯¸æ¥é€‚åº”å…¶å†…å®¹:</p>

<ul>
<li>æ²¿ç€stackè§†å›¾è½´å‘ï¼Œå…¶é€‚åº”å°ºå¯¸ç­‰äºå…¶ç®¡ç†çš„è§†å›¾å°ºå¯¸ä¸é—´è·çš„å’Œ</li>
<li>å‚ç›´äºstackè§†å›¾è½´å‘ï¼Œå…¶é€‚åº”å°ºå¯¸ç­‰äºå…¶ç®¡ç†çš„è§†å›¾ä¸­æœ€å¤§è§†å›¾çš„å°ºå¯¸</li>
<li>å¦‚æœstackè§†å›¾çš„<code>layoutMarginsRelativeArrangement</code>ä¸ºYES,stackè§†å›¾çš„é€‚åº”å°ºå¯¸ä¼šåŒ…æ‹¬è¾¹è·ç©ºé—´</li>
</ul>


<p>ä½ å¯ä»¥æä¾›é¢å¤–çš„çº¦æŸæ¥å…·ä½“è¯´æ˜stackè§†å›¾çš„é«˜åº¦ï¼Œå®½åº¦æˆ–è€…ä¸¤è€…å…¼æœ‰ï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œstackè§†å›¾è°ƒæ•´äº†å…¶ç®¡ç†çš„è§†å›¾çš„å¸ƒå±€å’Œå°ºå¯¸æ¥å¡«å……æŒ‡å®šåŒºåŸŸã€‚ç²¾ç¡®çš„å¸ƒå±€å˜é‡æ ¹æ®stackè§†å›¾çš„å±æ€§è·å¾—ã€‚å¯ä»¥é€šè¿‡æŸ¥çœ‹<code>UIStackViewDistribution</code>å’Œ<code>UIStackViewAlignment</code>æšä¸¾ï¼Œå·²è·å¾—ä¸€ä¸ªå®Œæ•´çš„stackè§†å›¾ã€‚</p>

<p>ä½ ä¹Ÿå¯ä»¥æ ¹æ®stackè§†å›¾çš„ç¬¬ä¸€æ¡æˆ–æœ€åä¸€æ¡åŸºçº¿å®šä½å®ƒï¼Œè€Œä¸æ˜¯ä½¿ç”¨é¡¶éƒ¨ï¼Œåº•éƒ¨æˆ–è€…ä¸­å¿ƒYå€¼ï¼Œç±»ä¼¼äºstackè§†å›¾çš„é€‚åº”å°ºå¯¸ï¼Œè¿™äº›åŸºçº¿éƒ½æ˜¯åŸºäºstackè§†å›¾çš„å†…å®¹è®¡ç®—å¾—åˆ°çš„</p>

<ul>
<li><p>ä¸€ä¸ªæ°´å¹³çš„stackè§†å›¾è°ƒç”¨ <code>viewForFirstBaselineLayout</code>æ–¹æ³•æˆ–è€… <code>viewForLastBaselineLayout</code>æ–¹æ³•æ—¶è¿”å›å®ƒæœ€é«˜çš„è§†å›¾ã€‚å¦‚æœæœ€é«˜çš„è§†å›¾ä¹Ÿæ˜¯ä¸€ä¸ªstackè§†å›¾ï¼Œé‚£ä¹ˆå…¶è¿”å›çš„å°†æ˜¯åœ¨åµŒå¥—çš„stackè§†å›¾ä¸Šè°ƒç”¨<code>viewForFirstBaselineLayout</code>æ–¹æ³•æˆ–è€…<code>viewForLastBaselineLayout</code>æ–¹æ³•çš„ç»“æœã€‚</p></li>
<li><p>ä¸€ä¸ªå‚ç›´çš„stackè§†å›¾å½“è°ƒç”¨ <code>viewForFirstBaselineLayout</code>æ–¹æ³•æ—¶è¿”å›çš„æ˜¯å…¶ç®¡ç†çš„ç¬¬ä¸€ä¸ªè§†å›¾ï¼Œå½“è°ƒç”¨<code>viewForLastBaselineLayout</code>æ–¹æ³•æ—¶è¿”å›çš„æ˜¯å…¶ç®¡ç†çš„æœ€åä¸€ä¸ªè§†å›¾ã€‚å¦‚æœè¿™ä¸¤ä¸ªè§†å›¾ä¹‹ä¸€ä¹Ÿæ˜¯stackè§†å›¾ï¼Œé‚£ä¹ˆå…¶è¿”å›çš„å°†æ˜¯åœ¨åµŒå¥—çš„stackè§†å›¾ä¸Šå¯¹åº”è°ƒç”¨<code>viewForFirstBaselineLayout</code>æ–¹æ³•æˆ–<code>viewForLastBaselineLayout</code>æ–¹æ³•çš„ç»“æœã€‚</p></li>
</ul>


<blockquote><p><em>æ³¨æ„</em>
åŸºçº¿å¯¹é½æ–¹å¼åªä½œç”¨äºé‚£äº›é«˜åº¦åŒ¹é…å…¶åŸæœ¬å†…å®¹é«˜åº¦çš„è§†å›¾ï¼Œå¦‚æœè§†å›¾è¢«æ‹‰ä¼¸æˆ–å‹ç¼©è¿‡ï¼Œé‚£ä¹ˆåŸºçº¿å°†å‡ºç°åœ¨é”™è¯¯çš„ä½ç½®ä¸Šã€‚</p></blockquote>

<h2>é€šè¿‡Stackè§†å›¾å¸ƒå±€</h2>

<p>è¿™æœ‰ä¸€äº›é€šç”¨æ–¹æ³•ç”¨äºstackè§†å›¾ã€‚è¿™ä¸ªæ¸…å•æ˜¯è¦é«˜äº®ä¸€äº›æœ‰ç”¨çš„å®ä¾‹æ¥æ˜¾ç¤º stackè§†å›¾çš„çµæ´»æ€§ï¼Œç›®å‰è¿™è¿˜ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¸…å•ã€‚</p>

<ul>
<li>åªæ˜¯å®šä¹‰ä½ç½®. ä½ å¯ä»¥é€šè¿‡å›ºå®šä¸¤ä¸ªä¸å…¶çˆ¶è§†å›¾ç›¸é‚»çš„è¾¹ç•Œæ¥å®šä¹‰stackè§†å›¾çš„ä½ç½®ã€‚åœ¨è¿™é‡Œï¼Œstackè§†å›¾çš„å°ºå¯¸å°†æ ¹æ®å…¶ç®¡ç†çš„è§†å›¾åœ¨ä¸¤ä¸ªç»´åº¦ä¸Šè‡ªç”±æ‰©å±•ã€‚</li>
</ul>


<p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨Figure 1ä¸­ï¼Œstackè§†å›¾çš„å·¦è¾¹ç•Œå’Œä¸Šè¾¹ç•Œéƒ½å·²ç»ç›¸å¯¹å›ºå®šäºå…¶çˆ¶è§†å›¾ã€‚è¿™äº›æ ‡ç­¾å°†æ ¹æ®å¸¦æœ‰8ä¸ªç‚¹çš„ä¸¤è€…ä¹‹é—´çš„ç©ºé—´ä½œä¸ºç¬¬ä¸€åŸºå‡†çº¿ã€‚è¿™å¯¹äºç›¸å¯¹äºå…¶æœ¬èº«å·¦å¯¹é½çš„stackè§†å›¾å†…å®¹æ˜¯æœ‰æ•ˆçš„ã€‚</p>

<p>Figure1å®šä¹‰ä½ç½®
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/140040561762600.png" alt="logo" /></p>

<ul>
<li>å®šä¹‰æ²¿ç€ stackè§†å›¾è½´å‘çš„å°ºå¯¸ã€‚è¿™é‡Œï¼Œä½ å›ºå®šäº†æ²¿ç€stackè§†å›¾è½´å‘ç›¸å¯¹äºå…¶çˆ¶è§†å›¾çš„ä¸¤ä¸ªè¾¹ç•Œï¼Œå®šä¹‰äº†stackè§†å›¾æ²¿ç€å…¶è½´å‘çš„å°ºå¯¸ã€‚ä½ å°†éœ€è¦å›ºå®šå…¶å®ƒè¾¹ç•Œä¸­çš„ä¸€ä¸ªæ¥å®šä¹‰stackè§†å›¾çš„ä½ç½®ã€‚stackè§†å›¾å°†æ²¿ç€å…¶è½´å‘æ”¹å˜å°ºå¯¸å’Œä½ç½®æ¥å¡«å……å®šä¹‰çš„ç©ºé—´:ç„¶è€Œï¼Œæœªå›ºå®šçš„è¾¹ç•Œå°†æ ¹æ®å…¶ç®¡ç†çš„æœ€å¤§è§†å›¾çš„å°ºå¯¸è‡ªåŠ¨ç§»åŠ¨ã€‚</li>
</ul>


<p>ä¸¾ä¾‹Figure 2,stackè§†å›¾çš„å·¦ï¼Œä¸Šï¼Œå³è¾¹ç•Œéƒ½å·²ç»ç›¸å¯¹äºå…¶çˆ¶è§†å›¾å›ºå®šäº†ã€‚ä½¿ç”¨<code>UIStackViewDistributionFill</code>åˆ†å¸ƒæ˜¯çš„å…¶å†…å®¹é‡è®¾å°ºå¯¸æ¥å¡«å……å®ƒçš„é«˜åº¦ï¼Œå¹¶ä¸”ä»æ–‡æœ¬æ¡†æœ‰æ¯”æ ‡ç­¾æ›´ä½çš„å†…å®¹ç´§å‡‘ä¼˜å…ˆçº§å¼€å§‹ï¼Œå®ƒå°†åœ¨å¿…è¦çš„æ—¶å€™è¢«æ‹‰ä¼¸ã€‚</p>

<p>Figure2å®šä¹‰æ²¿ç€stackè§†å›¾è½´å‘çš„å°ºå¯¸</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/140059516762099.png" alt="logo" /></p>

<ul>
<li>å®šä¹‰å‚ç›´äºstackè§†å›¾è½´å‘çš„å°ºå¯¸ã€‚è¿™ç±»ä¼¼äºä¸Šä¸€ä¸ªå®ä¾‹ï¼Œä½†æ˜¯ä½ å›ºå®šäº†å‚ç›´äºstackè§†å›¾è½´å‘çš„è¿ä¸ªè¾¹ç•Œå’Œæ²¿ç€è½´å‘çš„ä¸€ä¸ªè¾¹ç•Œã€‚è¿™ä½¿å¾—stackè§†å›¾åœ¨ä½ å¢åŠ æˆ–ç§»é™¤å…¶ç®¡ç†çš„è§†å›¾æ—¶å°†æ²¿ç€å…¶è½´å‘æ‰©å±•æˆ–å›ç¼©ã€‚é™¤éä½ ä½¿ç”¨äº†
<code>UIStackViewDistributionFillEqually</code>åˆ†å¸ƒï¼Œè¢«ç®¡ç†çš„è§†å›¾å°†è·Ÿæ ¹æ®å…¶åŸæœ‰å°ºå¯¸è°ƒèŠ‚å°ºå¯¸ã€‚å‚ç›´äºå…¶è½´å‘çš„è§†å›¾å°†æ ¹æ®å…¶stackè§†å›¾çš„å¯¹é½æ¨¡å¼åœ¨å…¶å®šä¹‰çš„èŒƒå›´å†…å¹³é“ºã€‚</li>
</ul>


<p>ä¸¾ä¾‹ï¼ŒFigure3å±•ç¤ºäº†ä¸€ä¸ªåŒ…å«äº†å››ä¸ªæ ‡ç­¾å’Œä¸€ä¸ªæŒ‰é’®çš„å‚ç›´stackè§†å›¾ã€‚è¿™ä¸ªstackè§†å›¾ä½¿ç”¨äº†8ä¸ªç‚¹çš„é—´éš™å’Œ<code>UIStackViewAlignmentCenter</code>å¯¹é½æ–¹å¼ã€‚stackè§†å›¾çš„é«˜åº¦å°†æ ¹æ®stackå†…éƒ¨å…ƒç´ çš„å¢å‡è€Œå¢å¤§æˆ–å›ç¼©ã€‚</p>

<p>FIgure3.å®šä¹‰å‚ç›´äºstackè§†å›¾è½´å‘çš„å°ºå¯¸
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/140110013482874.png" alt="logo" /></p>

<ul>
<li>åŒæ—¶å®šä¹‰stackè§†å›¾çš„ä½ç½®å’Œå°ºå¯¸ã€‚è¿™é‡Œä½ å›ºå®šäº†stackè§†å›¾çš„æ‰€æœ‰å››ä¸ªè¾¹ç•Œã€‚stackè§†å›¾å°†åœ¨æä¾›çš„èŒƒå›´ä¹‹å†…å¹³é“ºå…¶å†…å®¹ï¼Œä¸¾ä¾‹ï¼ŒFigure4å±•ç¤ºäº†ä¸€ä¸ªæ‰€æœ‰å››ä¸ªè¾¹ç•Œéƒ½ç›¸å¯¹äºå…¶çˆ¶è§†å›¾å›ºå®šçš„å‚ç›´stackè§†å›¾ã€‚é€šè¿‡ä½¿ç”¨<code>UIStackViewAlignmentCenter</code>å¯¹é½æ–¹å¼å’Œ<code>UIStackViewDistributionFill</code>åˆ†å¸ƒæ–¹å¼ï¼Œstackè§†å›¾ç¡®ä¿å…¶å†…å®¹å°†æ°´å¹³å’Œå‚ç›´å±…ä¸­å¡«å……å±å¹•ï¼Œç„¶åï¼Œè·å¾—æƒ³è¦çš„å¸ƒå±€éœ€è¦ä¸¤ä¸ªé¢å¤–çš„æ­¥éª¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œstackè§†å›¾ä¼šå‚ç›´æ‹‰ä¼¸æ ‡ç­¾è€Œä¸æ˜¯å›¾ç‰‡ï¼Œè¦ç¼©æ”¾å›¾ç‰‡æ§ä»¶ï¼Œå°±è¦é™ä½å…¶å†…å®¹ç´§å‡‘ä¼˜å…ˆçº§åˆ°ä½äºæ ‡ç­¾ï¼Œé¢å¤–çš„ï¼Œä¸ºäº†ä¿æŒå›¾ç‰‡ç¼©æ”¾æ—¶çš„é•¿å®½æ¯”ï¼Œä½ å¿…é¡»è®¾ç½®å›¾ç‰‡è§†å›¾çš„æ¨¡å¼ä¸º Aspect Fit.å¢åŠ ä¸€ä¸ªå›¾ç‰‡è§†å›¾æœˆstackè§†å›¾é—´ç›¸ç­‰çº¦æŸå°†æœ‰åŠ©äºç¡®ä¿å›¾ç‰‡å°†è¢«ç¼©æ”¾æ¥å¡«å……å¯ç”¨èŒƒå›´ã€‚</li>
</ul>


<p>Figure 4.åŒæ—¶å®šä¹‰stackè§†å›¾çš„ä½ç½®å’Œå°ºå¯¸
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/140122324105787.png" alt="logog" /></p>

<h2>ç®¡ç†stackè§†å›¾çš„å±•ç°</h2>

<p>UistackViewæ˜¯UIviewçš„éæ¸²æŸ“å‹å­ç±»ã€‚å®ƒæ²¡æä¾›å…¶è‡ªç”±çš„ä»»ä½•ç”¨æˆ·æ¥å£ï¼Œç›¸ååœ°ï¼Œå®ƒåªç®¡ç†è¢«å…¶ç®¡ç†çš„è§†å›¾çš„ä½ç½®å’Œå°ºå¯¸ã€‚å› æ­¤ï¼Œæœ‰äº›å±æ€§(å¦‚backgroundCOlor)åœ¨stackè§†å›¾ä¸Šæ˜¯æ— æ•ˆçš„ã€‚ç±»ä¼¼çš„ï¼Œä½ æ— æ³•é‡å†™layerClass,drawRectç­‰æ–¹æ³•ã€‚</p>

<p>è¿™é‡Œæœ‰ä¸€ç³»åˆ—çš„å±æ€§æ¥å®šä¹‰stackè§†å›¾å¦‚ä½•å¹³é“ºå…¶å†…å®¹ã€‚</p>

<ul>
<li>axis(è½´å‘)å±æ€§å†³å®šäº†stackçš„æœå‘ï¼Œåªæœ‰å‚ç›´å’Œæ°´å¹³</li>
<li>distributin(åˆ†å¸ƒ)å±æ€§å†³å®šäº†å…¶ç®¡ç†çš„è§†å›¾åœ¨æ²¿ç€å…¶è½´å‘ä¸Šçš„å¸ƒå±€</li>
<li>alignment(å¯¹é½)å±æ€§å†³å®šäº†å…¶ç®¡ç†çš„è§†å›¾åœ¨å‚ç›´äºå…¶è½´å‘ä¸Šçš„å¸ƒå±€</li>
<li>spacing(ç©ºéš™)å±æ€§å†³å®šäº†å…¶ç®¡ç†çš„è§†å›¾é—´çš„æœ€å°é—´éš™</li>
<li>baselineRelativeArragement å±æ€§å†³å®šäº†å…¶è§†å›¾é—´çš„å‚ç›´é—´éš™æ˜¯å¦æ ¹æ®åŸºçº¿æµ‹é‡å¾—åˆ°</li>
<li>layoutMarginsRelativeArrangement å±æ€§å†³å®šäº† stack è§†å›¾å¹³é“ºå…¶ç®¡ç†çš„è§†å›¾æ—¶æ˜¯å¦è¦å‚ç…§å®ƒçš„å¸ƒå±€è¾¹è·</li>
</ul>


<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ ä¼šä½¿ç”¨ä¸€ä¸ªstackè§†å›¾æ¥å¸ƒå±€å°æ•°é‡çš„è§†å›¾ï¼Œä½ å¯ä»¥é€šè¿‡åœ¨å…¶ä»–stackè§†å›¾ä¸ŠåµŒå¥—å¤šä¸ªstackè§†å›¾çš„æ–¹å¼åˆ›å»ºæ›´åŠ å¤æ‚çš„è§†å›¾å±‚æ¬¡ç»“æ„ã€‚ä¸¾ä¾‹ï¼šFigure5å±•ç¤ºä¹æ„ä¸ªåŒ…å«ä¸¤ä¸ªæ°´å¹³stackè§†å›¾çš„å‚ç›´stackè§†å›¾ã€‚æ¯ä¸€ä¸ªæ°´å¹³stackè§†å›¾å„åŒ…å«ä¸€ä¸ªæ ‡ç­¾å’Œä¸€ä¸ªæ–‡æœ¬æ¡†.</p>

<p>Figure 5.Stack è§†å›¾çš„åµŒå¥—
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/140146204108925.png" alt="logo" /></p>

<p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡å¢åŠ è¢«ç®¡ç†çš„è§†å›¾çš„é¢å¤–çº¦æŸæ¥å®Œå¤‡çš„åŠæ¥ä¸€ä¸ªè¢«ç®¡ç†è§†å›¾çš„å±•ç°ï¼Œä¸¾ä¾‹è¯´æ˜ï¼Œä½ å¯ä»¥ä½¿ç”¨çº¦æŸç±»è®¾ç½®è§†å›¾çš„æœ€å°æˆ–æœ€å¤§çš„é«˜åº¦æˆ–å®½åº¦ï¼Œæˆ–è€…ä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªé•¿å®½æ¯”ã€‚å½“å¹³é“ºå…¶å†…å®¹æ—¶ï¼Œstackè§†å›¾å°†ä½¿ç”¨è¿™äº›çº¦æŸã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œåœ¨Figure4ä¸­ï¼Œå½“å›¾ç‰‡è¢«å‹ç¼©æ—¶ï¼Œå›¾ç‰‡è§†å›¾çš„ä¸€ä¸ªé•¿å®½æ¯”çº¦æŸè¢«å¼ºè¡Œèµ‹äºˆäº†ä¸€ä¸ªé•¿å®½æ¯”æ•°ã€‚</p>

<blockquote><p><strong>æ³¨æ„</strong>
å½“ç»™ä¸€ä¸ªstackè§†å›¾å†…çš„è§†å›¾å¢åŠ çº¦æŸæ—¶è¦ç‰¹åˆ«æ³¨æ„é¿å…ä¼ å…¥å†²çªï¼Œä½œä¸ºæƒ¯ä¾‹ï¼Œå¦‚æœä¸€ä¸ªè§†å›¾çš„å°ºå¯¸åœ¨ä¸€ä¸ªæŒ‡å®šçš„ç»´åº¦ä¸Šé»˜è®¤å›åˆ°å…¶åŸæœ¬å†…å®¹çš„å°ºå¯¸ï¼Œé‚£ä¹ˆä½ å¯ä»¥å®‰å…¨çš„åœ¨è¿™ä¸ªç»´åº¦ä¸Šå¢åŠ çº¦æŸ</p></blockquote>

<h2>ç»´æŠ¤å…¶æƒ¯ä¾‹çš„è§†å›¾ä¸å­è§†å›¾ä¹‹é—´çš„ç»Ÿä¸€æ€§</h2>

<p>Stackè§†å›¾ç¡®ä¿å®ƒçš„arragedSubveiwså±æ€§å°†ä¸€ç›´æ˜¯å…¶ subviewså±æ€§çš„å­é›†åˆã€‚æ˜ç¡®çš„è¯´ï¼Œstackè§†å›¾å¼ºåˆ¶å®æ–½äº†ä»¥ä¸‹è§„å®š:</p>

<ul>
<li>æ— è®ºä½•æ—¶stackè§†å›¾å¢åŠ äº†ä¸€ä¸ªè§†å›¾åˆ°å®ƒçš„arrangedSubviewsæ•°ç»„ï¼Œå…¶ä¹Ÿå°†æŠŠè¿™ä¸ªè§†å›¾ä½œä¸ºå­è§†å›¾å¢åŠ ï¼Œå¦‚æœè¿˜æœªå¢åŠ çš„è¯ã€‚</li>
<li>æ— è®ºä½•æ—¶ä¸€ä¸ªå­è§†å›¾ä»stackè§†å›¾ä¸­ç§»é™¤ï¼Œé‚£ä¹ˆstackè§†å›¾ä¹Ÿå°†ä»ä»arrangedSubviewsæ•°ç»„ä¸­ç§»é™¤.</li>
<li>ä»arrangedSubviewsç§»é™¤ä¸€ä¸ªè§†å›¾å¹¶ä¸ä¼šå°†å…¶ä½œä¸ºå§¿åŠ¿å›¾ç§»é™¤ã€‚stackè§†å›¾å°†ä¸å†ç®¡ç†æ”¹è§†å›¾çš„å°ºå¯¸å’Œä½ç½®ï¼Œä½†æ˜¯è¯¥è§†å›¾æ‰”å°†æ˜¯è§†å›¾ç»“æ„çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”å½“å…¶å¯è§çš„ç‹‚ä¸‹ä»ä¼šè¢«æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚</li>
</ul>


<p>å½“arrangedSubviewsæ•°ç»„ä¸€ç›´åŒ…å«ç€subviewsæ•°ç»„çš„è‡ªå·±å’Œï¼Œè¿™äº›æ•°ç»„é—´çš„é¡ºåºä»ç„¶æ˜¯ç‹¬ç«‹çš„ã€‚</p>

<ul>
<li>arrangedSubviewsæ•°ç»„çš„é¡ºåºå®šä¹‰äº†å±•ç°åœ¨stackä¸­çš„è§†å›¾çš„é¡ºåºã€‚å¯¹äºæ°´å¹³stackè§†å›¾ï¼Œè¿™äº›è§†å›¾å°†ä»¥é˜…è¯»é¡ºåºå¹³é“ºï¼Œå³æœ€å°ç´¢å¼•çš„è§†å›¾åœ¨è¾ƒå¤§ç´¢å¼•è§†å›¾çš„å·¦ä¾§ã€‚å¯¹äºå‚ç›´stackè§†å›¾ï¼Œè¿™äº›è§†å›¾æ˜¯ä»ä¸Šåˆ°ä¸‹å¹³é“ºçš„ï¼ŒåŠè¾ƒå°ç´¢å¼•çš„è§†å›¾åœ¨è¾ƒå¤§ç´¢å¼•è§†å›¾çš„ä¸Šæ–¹ã€‚</li>
<li>subviewsæ•°ç»„ä¸­çš„é¡ºåºå®šä¹‰äº†å­è§†å›¾åœ¨zè½´ä¸Šçš„é¡ºåºã€‚å¦‚æœè§†å›¾é‡å ï¼Œæœ‰è¾ƒå°ç´¢å¼•çš„å­è§†å›¾å°†å‡ºç°åœ¨æœ‰å®¶å¤šéŸ³çš„å­è§†å›¾åæ–¹ã€‚</li>
</ul>


<h2>åŠ¨æ€æ”¹å˜stackè§†å›¾å†…å®¹</h2>

<p>å½“è§†å›¾è¢«åŠ å…¥ï¼Œç§»é™¤æˆ–æ’å…¥arrangedSubviewsæ•°ç»„æ—¶ï¼Œæˆ–å½“ä¸€ä¸ªè¢«ç®¡ç†çš„å­è§†å›¾çš„hiddenå±æ€§æ”¹å˜æ—¶ï¼Œstackè§†å›¾éƒ½ä¼šè‡ªåŠ¨æ›´æ–°å®ƒçš„å¸ƒå±€ã€‚</p>

<p>Ocä»£ç å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Appears to remove the first arranged view from the stack.
</span><span class='line'>// The view is still inside the stack, it's just no longer visible, and no longer contributes to the layout.
</span><span class='line'>UIView * firstView = self.stackView.arrangedSubviews[0];
</span><span class='line'>firstView.hidden = YES;</span></code></pre></td></tr></table></div></figure>


<p>swiftä»£ç å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Appears to remove the first arranged view from the stack.
</span><span class='line'>// The view is still inside the stack, it's just no longer visible, and no longer contributes to the layout.
</span><span class='line'>let firstView = stackView.arrangedSubviews[0]
</span><span class='line'>firstView.hidden = true</span></code></pre></td></tr></table></div></figure>


<p>stackè§†å›¾ä¹Ÿä¼šè‡ªåŠ¨å“åº”å…¶ä»»ä½•å±æ€§çš„æ”¹å˜ã€‚ä¸¾ä¾‹ï¼Œä½ å¯ä»¥æ›´æ–°stackè§†å›¾çš„axiså±æ€§æ¥åŠ¨æ€æ”¹å˜æœå‘</p>

<p>OCä»£ç å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Toggle between a vertical and horizontal stack
</span><span class='line'>if (self.stackView.axis == UILayoutConstraintAxisHorizontal) {
</span><span class='line'>    self.stackView.axis = UILayoutConstraintAxisVertical;
</span><span class='line'>}else {
</span><span class='line'>    self.stackView.axis = UILayoutConstraintAxisHorizontal;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Swiftä»£ç å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Toggle between a vertical and horizontal stack
</span><span class='line'>if stackView.axis == .Horizontal {
</span><span class='line'>    stackView.axis = .Vertical
</span><span class='line'>}else {
</span><span class='line'>    stackView.axis = .Horizontal
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å¯¹äºè¢«ç®¡ç†çš„å­è§†å›¾çš„hiddenå±æ€§çš„å˜åŒ–å’Œstackè§†å›¾å±æ€§çš„å˜åŒ–ï¼Œä½ å¯ä»¥é€šè¿‡å°†è¿™äº›æ”¹å˜å†…ç½®åˆ°ä¸€ä¸ªåŠ¨ç”»å—ä»£ç çš„æ–¹å¼ä»¥åŠ¨ç”»çš„æ–¹å¼å±•ç°ã€‚</p>

<p>OCä»£ç å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Animates removing the first item in the stack.
</span><span class='line'>[UIView animateWithDuration:0.25 animations:^{
</span><span class='line'>    UIView * firstView = self.stackView.arrangedSubviews[0];
</span><span class='line'>    firstView.hidden = YES;
</span><span class='line'>}];</span></code></pre></td></tr></table></div></figure>


<p>Swiftä»£ç å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Animates removing the first item in the stack.
</span><span class='line'>UIView.animateWithDuration(0.25) { () -&gt; Void in
</span><span class='line'>    let firstView = stackView.arrangedSubviews[0]
</span><span class='line'>    firstView.hidden = true}</span></code></pre></td></tr></table></div></figure>


<h2>å¸¸ç”¨æ–¹æ³•</h2>

<h3>åˆ›å»ºStackè§†å›¾</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- initWithArrangedSubviews:  (New in iOS 9.0)</span></code></pre></td></tr></table></div></figure>


<h3>ç®¡ç†å®‰æ’çš„å­è§†å›¾</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- addArrangedSubview: (New in iOS 9.0)
</span><span class='line'>  arrangedSubviews Property (New in iOS 9.0)
</span><span class='line'>- insertArrangedSubview:atIndex: (New in iOS 9.0)
</span><span class='line'>- removeArrangedSubview: (New in iOS 9.0)</span></code></pre></td></tr></table></div></figure>


<h3>è®¾ç½®å¸ƒå±€</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>alignment Property  (New in iOS 9.0)
</span><span class='line'>axis Property  (New in iOS 9.0)
</span><span class='line'>baselineRelativeArrangement Property  (New in iOS 9.0)
</span><span class='line'>distribution Property  (New in iOS 9.0)
</span><span class='line'>layoutMarginsRelativeArrangement Property  (New in iOS 9.0)
</span><span class='line'>spacing Property  (New in iOS 9.0)</span></code></pre></td></tr></table></div></figure>


<h3>å¸¸é‡</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>UIStackViewDistribution
</span><span class='line'>UIStackViewAlignment</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ·±å…¥ç†è§£RunLoop]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/29/shen-ru-li-jie-runloop/"/>
    <updated>2016-03-29T17:29:43+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/29/shen-ru-li-jie-runloop</id>
    <content type="html"><![CDATA[<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/1432799466416554.jpeg" alt="runloop" /></p>

<p>RunLoopæ˜¯ioså’ŒOSXå¼€å‘ä¸­éå¸¸åŸºç¡€çš„ä¸€ä¸ªæ¦‚å¿µï¼Œæœ¬ç« å°†ä¼šä»‹ç»ä¸€ä¸‹åœ¨iosä¸­ï¼Œè‹¹æœæ˜¯åˆ©ç”¨RunLoopå®ç°è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå»¶è¿Ÿå›è°ƒï¼Œè§¦æ‘¸äº‹ä»¶ï¼Œå±å¹•åˆ·æ–°ç­‰.</p>

<h2>RunLoopçš„æ¦‚å¿µ</h2>

<p>ä¸€èˆ¬æ¥è®²ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆä¹‹åçº¿ç¨‹å°±ä¼šé€€å‡ºã€‚å¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœºåˆ¶ï¼Œè®©çº¿ç¨‹èƒ½éšæ—¶å¤„ç†äº‹ä»¶ä½†å¹¶ä¸é€€å‡ºï¼Œé€šå¸¸çš„ä»£ç é€»è¾‘æ˜¯è¿™æ ·çš„:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function loop() {
</span><span class='line'>    initialize();
</span><span class='line'>    do {
</span><span class='line'>        var message = get_next_message();
</span><span class='line'>        process_message(message);
</span><span class='line'>    } while (message != quit);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<!--more-->


<p> è¿™ç§æ¨¡å‹é€šå¸¸è¢«ç§°ä¸º <code>Event Loop</code>,Event Loopåœ¨å¾ˆå¤šç³»ç»Ÿå’Œæ¡†æ¶ä¸­éƒ½æœ‰å®ç°ï¼Œæ¯”å¦‚ Node.jsçš„äº‹ä»¶å¤„ç†ï¼Œæ¯”å¦‚windowç¨‹åºçš„æ¶ˆæ¯å¾ªç¯ï¼Œå†æ¯”å¦‚OS X/IOSé‡Œçš„RunLoop.å®ç°è¿™ç§æ¨¡å‹çš„å…³é”®ç‚¹åœ¨äº:å¦‚ä½•ç®¡ç†äº‹ä»¶/æ¶ˆæ¯,å¦‚ä½•è®©çº¿ç¨‹åœ¨æ²¡æœ‰å¤„ç†æ¶ˆæ¯æ—¶ä¼‘çœ ä»¥é¿å…èµ„æºå ç”¨ï¼Œåœ¨æœ‰æ¶ˆæ¯åˆ°æ¥æ—¶è¢«å”¤é†’ã€‚</p>

<p> æ‰€ä»¥ï¼ŒRunLoopå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç®¡ç†äº†å…¶éœ€è¦å¤„ç†çš„äº‹ä»¶å’Œæ¶ˆæ¯ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªå…¥å£å‡½æ•°æ¥æ‰§è¡Œä¸Šé¢çš„EventLoopé€»è¾‘ã€‚çº¿ç¨‹æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°åï¼Œå°±ä¼šä¸€ç›´å¤„ç†è¿™ä¸ªå‡½æ•°å†…éƒ¨"æ¥å—æ¶ˆæ¯->ç­‰å¾…->å¤„ç†"çš„å¾ªç¯ä¸­ï¼ŒçŸ¥é“è¿™ä¸ªå¾ªç¯ç»“æŸ(æ¯”å¦‚ä¼ å…¥quitçš„æ¶ˆæ¯)ï¼Œå‡½æ•°è¿”å›.</p>

<p> åœ¨OSX/IOSç³»ç»Ÿä¸­ï¼Œæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡:NSRunLoopå’ŒCFRunLoopref.</p>

<p> CFRunLoopRefæ˜¯åœ¨CoreFoundationæ¡†æ¶å†…ï¼Œå®ƒæä¾›äº†çº¯Cå‡½æ•°çš„API,æ‰€æœ‰è¿™äº›APIéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>

<p> NSRunLoopæ˜¯åŸºäºCFRunLoopRefçš„å°è£…ï¼Œæä¾›äº†é¢å‘å¯¹è±¡çš„API,ä½†æ˜¯è¿™äº›APIä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>

<h2>RunLoopä¸çº¿ç¨‹çš„å…³ç³»</h2>

<p>é¦–å…ˆï¼ŒiOSå¼€å‘ä¸­èƒ½é‡åˆ°ä¸¤ä¸ªçº¿ç¨‹å¯¹è±¡:pthread_t å’Œ NSThread.è¿‡å»è‹¹æœæœ‰ä»½æ–‡æ¡£è¡¨æ˜äº†NSThreadåªæ˜¯pthread_t çš„å°è£…ï¼Œä½†é‚£ä»½æ–‡æ¡£å·²ç»å¤±æ•ˆäº†ï¼Œç°åœ¨å®ƒä»¬ä¹Ÿæœ‰è‚¯å®šéƒ½æ˜¯ç›´æ¥åŒ…è£…è‡ªæœ€åº•å±‚çš„mach threadã€‚</p>

<p>ä½ å¯ä»¥é€šè¿‡pthread_main_np() æˆ– [NSThread mainThread] æ¥è·å–ä¸»çº¿ç¨‹,ä¹Ÿå¯ä»¥é€šè¿‡pthread_self()æˆ–è€…[NSThread currentThread]æ¥è·å–å½“å‰çº¿ç¨‹ã€‚CFRunLoopæ˜¯åŸºäºpthreadæ¥ç®¡ç†çš„ã€‚</p>

<p>è‹¹æœä¸å…è®¸ç›´æ¥åˆ›å»ºRunLoop,å®ƒåªæä¾›äº†ä¸¤ä¸ªè‡ªåŠ¨è·å–çš„å‡½æ•°:CFRunLoopGetMain()å’ŒCFRUnLoopGetCurrent().è¿™ä¸¤ä¸ªå‡½æ•°å†…éƒ¨çš„é€»è¾‘å¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ ·:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/// å…¨å±€çš„Dictionaryï¼Œkey æ˜¯ pthread_tï¼Œ value æ˜¯ CFRunLoopRef
</span><span class='line'>static CFMutableDictionaryRef loopsDic;
</span><span class='line'>/// è®¿é—® loopsDic æ—¶çš„é”
</span><span class='line'>static CFSpinLock_t loopsLock;
</span><span class='line'>  
</span><span class='line'>/// è·å–ä¸€ä¸ª pthread å¯¹åº”çš„ RunLoopã€‚
</span><span class='line'>CFRunLoopRef _CFRunLoopGet(pthread_t thread) {
</span><span class='line'>    OSSpinLockLock(&loopsLock);
</span><span class='line'>     
</span><span class='line'>    if (!loopsDic) {
</span><span class='line'>        // ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶ï¼Œåˆå§‹åŒ–å…¨å±€Dicï¼Œå¹¶å…ˆä¸ºä¸»çº¿ç¨‹åˆ›å»ºä¸€ä¸ª RunLoopã€‚
</span><span class='line'>        loopsDic = CFDictionaryCreateMutable();
</span><span class='line'>        CFRunLoopRef mainLoop = _CFRunLoopCreate();
</span><span class='line'>        CFDictionarySetValue(loopsDic, pthread_main_thread_np(), mainLoop);
</span><span class='line'>    }
</span><span class='line'>     
</span><span class='line'>    /// ç›´æ¥ä» Dictionary é‡Œè·å–ã€‚
</span><span class='line'>    CFRunLoopRef loop = CFDictionaryGetValue(loopsDic, thread));
</span><span class='line'>     
</span><span class='line'>    if (!loop) {
</span><span class='line'>        /// å–ä¸åˆ°æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª
</span><span class='line'>        loop = _CFRunLoopCreate();
</span><span class='line'>        CFDictionarySetValue(loopsDic, thread, loop);
</span><span class='line'>        /// æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“çº¿ç¨‹é”€æ¯æ—¶ï¼Œé¡ºä¾¿ä¹Ÿé”€æ¯å…¶å¯¹åº”çš„ RunLoopã€‚
</span><span class='line'>        _CFSetTSD(..., thread, loop, __CFFinalizeRunLoop);
</span><span class='line'>    }
</span><span class='line'>     
</span><span class='line'>    OSSpinLockUnLock(&loopsLock);
</span><span class='line'>    return loop;
</span><span class='line'>}
</span><span class='line'>  
</span><span class='line'>CFRunLoopRef CFRunLoopGetMain() {
</span><span class='line'>    return _CFRunLoopGet(pthread_main_thread_np());
</span><span class='line'>}
</span><span class='line'>  
</span><span class='line'>CFRunLoopRef CFRunLoopGetCurrent() {
</span><span class='line'>    return _CFRunLoopGet(pthread_self());
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä»ä¸Šé¢çš„ä»£ç æ¥çœ‹ï¼Œçº¿ç¨‹å’ŒRunLoopä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„Dictionaryé‡Œï¼Œçº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰RunLoop,å¦‚æœä½ ä¸ä¸»åŠ¨è·å–ï¼Œé‚£å®ƒä¸€ç›´ä¸ä¼šæœ‰ã€‚RunLoopçš„åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶ï¼ŒRunLoopçš„é”€æ¯æ—¶å‘ç”Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶ï¼Œä½ åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨è·å–å…¶RunLoop(ä¸»çº¿ç¨‹é™¤å¤–)</p>

<h2>RunLoopå¯¹å¤–çš„æ¥å£</h2>

<ul>
<li>CFRunLoopRef</li>
<li>CFRunLoopModelRef</li>
<li>CFRunLoopSourceRef</li>
<li>CFRunLoopTimerRef</li>
<li>CFRunLoopObserverRef</li>
</ul>


<p>å…¶ä¸­ï¼ŒCFRunLoopModelRefç±»å¹¶æ²¡æœ‰å¯¹å¤–æš´éœ²ï¼Œåªæ˜¯é€šè¿‡CFRunLoopRefçš„æ¥å£è¿›è¡Œäº†å°è£…ï¼Œä»–ä»¬çš„å…³ç³»å¦‚ä¸‹:</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/1432798883604537.png" alt="runloop" /></p>

<p>ä¸€ä¸ªRunLoopåŒ…å«è‹¥å¹²ä¸ªModel,æ¯ä¸ªmodelåˆåŒ…å«è‹¥å¹²ä¸ªSource/Timer/Observerã€‚æ¯æ¬¡è°ƒç”¨RunLoopçš„ä¸»å‡½æ•°æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ªmodel,è¿™ä¸ªModelè¢«ç§°ä½œä¸ºCurrentMode.å¦‚æœéœ€è¦åˆ‡æ¢Mode,åªèƒ½é€€å‡ºLoop,å†é‡æ–°æŒ‡å®šä¸€ä¸ªModeè¿›å…¥ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„ Source/Timer/Observer,è®©å…¶äº’ä¸å½±å“.</p>

<p>CFRunLoopSourceREfæ˜¯äº‹ä»¶äº§ç”Ÿçš„åœ°æ–¹ã€‚Sourceæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼ŒSource0å’ŒSource1.</p>

<ul>
<li>Source0åªåŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå®ƒå¹¶ä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶ã€‚ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦å…ˆè°ƒç”¨CFRunLoopSourceSignal(source)ï¼Œå°†è¿™ä¸ªSourceæ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨CFRunLoopwakeUp(runloop)æ¥å”¤é†’RunLoop,è®©å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶</li>
<li>Source1åŒ…å«ä¹ä¸šä¸€ä¸ªmatch_portå’Œä¸€ä¸ªå›è°ƒ(å‡½æ•°æŒ‡é’ˆ),è¢«ç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶å®ƒçº¿ç¨‹ç›¸åå‘é€æ¶ˆæ¯ã€‚è¿™ç§Sourceèƒ½ä¸»åŠ¨å”¤é†’Runloopçš„çº¿ç¨‹</li>
</ul>


<p><em>CFRUnLoopTimerRef</em>æ˜¯åŸºäºæ—¶é—´çš„è§¦å‘å™¨ï¼Œå®ƒå’ŒNStimerå¯ä»¥æ··ç”¨ï¼Œå…¶åŒ…å«ä¸€ä¸ªæ—¶é—´é•¿åº¦å’Œä¸€ä¸ªå›è°ƒ(å‡½æ•°æŒ‡é’ˆ).å½“å…¶åŠ å…¥åˆ°RUnLoopæ—¶ï¼ŒRunLoopä¼šæ³¨å†Œå¯¹åº”çš„æ—¶é—´ç‚¹ï¼Œå½“æ—¶é—´ç‚¹åˆ°æ—¶ï¼ŒRunLoopä¼šè¢«å”¤é†’ä»¥æ‰§è¡Œé‚£ä¸ªå›è°ƒ.</p>

<p><em>CFRunLoopObserverRef</em>æ˜¯è§‚å¯Ÿè€…ï¼Œæ¯ä¸ªObserveréƒ½åŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼Œå½“Runloopçš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§‚å¯Ÿè€…å°±èƒ½é€šè¿‡å›è°ƒæ¥æ”¶åˆ°è¿™ä¸ªå˜åŒ–ã€‚å¯ä»¥è§‚æµ‹çš„æ—¶é—´ç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ª:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {
</span><span class='line'>    kCFRunLoopEntry         = (1UL &lt;&lt; 0), // å³å°†è¿›å…¥Loop
</span><span class='line'>    kCFRunLoopBeforeTimers  = (1UL &lt;&lt; 1), // å³å°†å¤„ç† Timer
</span><span class='line'>    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2), // å³å°†å¤„ç† Source
</span><span class='line'>    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5), // å³å°†è¿›å…¥ä¼‘çœ 
</span><span class='line'>    kCFRunLoopAfterWaiting  = (1UL &lt;&lt; 6), // åˆšä»ä¼‘çœ ä¸­å”¤é†’
</span><span class='line'>    kCFRunLoopExit          = (1UL &lt;&lt; 7), // å³å°†é€€å‡ºLoop
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ Source/Timers/Observer è¢«ç»Ÿç§°ä¸ºMode item,ä¸€ä¸ªItemå¯ä»¥è¢«åŒäº‹åŠ å…¥å¤šä¸ªMode,ä½†ä¸€ä¸ªItemè¢«é‡å¤åŠ å…¥åŒä¸€ä¸ªmodeæ—¶æ˜¯ä¸ä¼šæœ‰æ•ˆæœçš„ã€‚å¦‚æœä¸€ä¸ªModeä¸­ä¸€ä¸ªiteméƒ½æ²¡æœ‰ï¼Œåˆ™RunLoopä¼šç›´æ¥é€€å‡ºï¼Œä¸è¿›å…¥å¾ªç¯ã€‚</p>

<h2>Runloopçš„Mode</h2>

<p>CFRunLoopModeå’ŒCFRunLoopçš„ç»“æ„å¤§è‡´å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct __CFRunLoopMode {
</span><span class='line'>    CFStringRef _name;            // Mode Name, ä¾‹å¦‚ @"kCFRunLoopDefaultMode"
</span><span class='line'>    CFMutableSetRef _sources0;    // Set
</span><span class='line'>    CFMutableSetRef _sources1;    // Set
</span><span class='line'>    CFMutableArrayRef _observers; // Array
</span><span class='line'>    CFMutableArrayRef _timers;    // Array
</span><span class='line'>    ...
</span><span class='line'>};
</span><span class='line'>  
</span><span class='line'>struct __CFRunLoop {
</span><span class='line'>    CFMutableSetRef _commonModes;     // Set
</span><span class='line'>    CFMutableSetRef _commonModeItems; // Set
</span><span class='line'>    CFRunLoopModeRef _currentMode;    // Current Runloop Mode
</span><span class='line'>    CFMutableSetRef _modes;           // Set
</span><span class='line'>    ...
</span><span class='line'>};</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œæœ‰ä¸ªæ¦‚å¿µå«<code>CommonModes</code>ï¼šä¸€ä¸ªModeå¯ä»¥å°†è‡ªå·±æ ‡è®°ä¸º<code>Common</code>å±æ€§ï¼ˆé€šè¿‡å°†å…¶ModeNameæ·»åŠ åˆ°RunLoopçš„ &ldquo;CommmonModes"ä¸­ï¼‰ã€‚æ¯å½“RunLoopçš„å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒRunLoopéƒ½ä¼šè‡ªåŠ¨å°†_CommonModeItemsé‡Œçš„ Source/Observer/TimeråŒæ­¥åˆ°å…·æœ‰'Common'æ ‡è®°çš„æ‰€æœ‰Modeé‡Œã€‚</p>

<p>åº”ç”¨åœºæ™¯:ä¸»çº¿ç¨‹çš„RunLoopé‡Œæœ‰ä¸¤ä¸ªé¢„ç½®çš„Mode:KCFRunLoopDefaultModeå’ŒUITrackingRunLoopModeã€‚è¿™ä¸¤ä¸ªModeéƒ½å·²ç»è¢«æ ‡è®°ä¸º"Common"å±æ€§ã€‚DefaultModeæ˜¯Appå¹³æ—¶æ‰€å¤„çš„çŠ¶æ€ï¼ŒTrackingRunLoopModeæ˜¯è¿½è¸ªScrollViewæ»‘åŠ¨æ—¶çš„çŠ¶æ€ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªTimerå¹¶åŠ åˆ°DefaultModeæ—¶ï¼ŒTImerä¼šå¾—åˆ°é‡å¤å›è°ƒï¼Œä½†æ­¤æ—¶æ»‘åŠ¨ä¸€ä¸ªTableViewæ—¶ï¼ŒRunLoopä¼šå°†modeåˆ‡æ¢åˆ° TrackingRunLoopMode,è¿™æ—¶Timerå°±ä¸ä¼šè¢«å›è°ƒï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šå½±å“åˆ°æ»‘åŠ¨æ“ä½œ.</p>

<p>æœ‰æ—¶ä½ éœ€è¦ä¸€ä¸ªTimer,åœ¨ä¸¤ä¸ªModeä¸­éƒ½èƒ½å¾—åˆ°å›è°ƒï¼Œä¸€ç§åŠæ³•å°±æ˜¯å°†è¿™ä¸ªTimeråˆ†åˆ«åŠ å…¥è¿™ä¸¤ä¸ªMode.è¿˜æœ‰ä¸€ç§æ–¹å¼ï¼Œå°±æ˜¯å°†TImeråŠ å…¥åˆ°é¡¶å±‚RunLoopçš„"commonModeItems"ä¸­ï¼Œâ€œcommonMOdeItemsâ€è¢«RunLoopè‡ªåŠ¨æ›´æ–°åˆ°æ‰€æœ‰å…·æœ‰"Common"å±æ€§çš„Modeé‡Œå».</p>

<p>CFRunLoopå¯¹å¤–æš´éœ²çš„ç®¡ç†Modeæ¥å£åªæœ‰ä¸‹é¢2ä¸ª:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CFRunLoopAddCommonMode(CFRunLoopRef runloop, CFStringRef modeName);
</span><span class='line'>CFRunLoopRunInMode(CFStringRef modeName, ...);</span></code></pre></td></tr></table></div></figure>


<p>Modeæš´éœ²çš„ç®¡ç†Mode Itemçš„æœ‰ä¸‹é¢å‡ ä¸ª:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CFRunLoopAddSource(CFRunLoopRef rl, CFRunLoopSourceRef source, CFStringRef modeName);
</span><span class='line'>CFRunLoopAddObserver(CFRunLoopRef rl, CFRunLoopObserverRef observer, CFStringRef modeName);
</span><span class='line'>CFRunLoopAddTimer(CFRunLoopRef rl, CFRunLoopTimerRef timer, CFStringRef mode);
</span><span class='line'>CFRunLoopRemoveSource(CFRunLoopRef rl, CFRunLoopSourceRef source, CFStringRef modeName);
</span><span class='line'>CFRunLoopRemoveObserver(CFRunLoopRef rl, CFRunLoopObserverRef observer, CFStringRef modeName);
</span><span class='line'>CFRunLoopRemoveTimer(CFRunLoopRef rl, CFRunLoopTimerRef timer, CFStringRef mode);</span></code></pre></td></tr></table></div></figure>


<h2>RunLoopçš„å†…éƒ¨é€»è¾‘</h2>

<p>æ ¹æ®è‹¹æœå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼ŒRunLoopå†…éƒ¨é€»è¾‘å¤§è‡´å¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/1432798974517485.png" alt="logo" /></p>

<p>å®é™…ä¸Šï¼ŒRunLoopå°±æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ª do-whileå¾ªç¯ï¼Œå½“ä½ è°ƒç”¨ CFRunLoopRun()æ—¶ï¼Œçº¿ç¨‹å°±ä¼šä¸€ç›´åœç•™åœ¨è¿™ä¸ªå¾ªç¯é‡Œï¼ŒçŸ¥é“è¶…æ—¶æˆ–è¢«æ‰‹åŠ¨åœæ­¢ï¼Œè¯¥å‡½æ•°æ‰ä¼šè¿”å›.</p>

<h2>è‹¹æœç”¨RunLoopå®ç°çš„åŠŸèƒ½</h2>

<p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥å…ˆçœ‹ä¸€ä¸‹Appå¯åŠ¨åRunLoopçš„çŠ¶æ€:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CFRunLoop {
</span><span class='line'>    current mode = kCFRunLoopDefaultMode
</span><span class='line'>    common modes = {
</span><span class='line'>        UITrackingRunLoopMode
</span><span class='line'>        kCFRunLoopDefaultMode
</span><span class='line'>    }
</span><span class='line'>  
</span><span class='line'>    common mode items = {
</span><span class='line'>  
</span><span class='line'>        // source0 (manual)
</span><span class='line'>        CFRunLoopSource {order =-1, {
</span><span class='line'>            callout = _UIApplicationHandleEventQueue}}
</span><span class='line'>        CFRunLoopSource {order =-1, {
</span><span class='line'>            callout = PurpleEventSignalCallback }}
</span><span class='line'>        CFRunLoopSource {order = 0, {
</span><span class='line'>            callout = FBSSerialQueueRunLoopSourceHandler}}
</span><span class='line'>  
</span><span class='line'>        // source1 (mach port)
</span><span class='line'>        CFRunLoopSource {order = 0,  {port = 17923}}
</span><span class='line'>        CFRunLoopSource {order = 0,  {port = 12039}}
</span><span class='line'>        CFRunLoopSource {order = 0,  {port = 16647}}
</span><span class='line'>        CFRunLoopSource {order =-1, {
</span><span class='line'>            callout = PurpleEventCallback}}
</span><span class='line'>        CFRunLoopSource {order = 0, {port = 2407,
</span><span class='line'>            callout = _ZL20notify_port_callbackP12__CFMachPortPvlS1_}}
</span><span class='line'>        CFRunLoopSource {order = 0, {port = 1c03,
</span><span class='line'>            callout = __IOHIDEventSystemClientAvailabilityCallback}}
</span><span class='line'>        CFRunLoopSource {order = 0, {port = 1b03,
</span><span class='line'>            callout = __IOHIDEventSystemClientQueueCallback}}
</span><span class='line'>        CFRunLoopSource {order = 1, {port = 1903,
</span><span class='line'>            callout = __IOMIGMachPortPortCallback}}
</span><span class='line'>  
</span><span class='line'>        // Ovserver
</span><span class='line'>        CFRunLoopObserver {order = -2147483647, activities = 0x1, // Entry
</span><span class='line'>            callout = _wrapRunLoopWithAutoreleasePoolHandler}
</span><span class='line'>        CFRunLoopObserver {order = 0, activities = 0x20,          // BeforeWaiting
</span><span class='line'>            callout = _UIGestureRecognizerUpdateObserver}
</span><span class='line'>        CFRunLoopObserver {order = 1999000, activities = 0xa0,    // BeforeWaiting | Exit
</span><span class='line'>            callout = _afterCACommitHandler}
</span><span class='line'>        CFRunLoopObserver {order = 2000000, activities = 0xa0,    // BeforeWaiting | Exit
</span><span class='line'>            callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv}
</span><span class='line'>        CFRunLoopObserver {order = 2147483647, activities = 0xa0, // BeforeWaiting | Exit
</span><span class='line'>            callout = _wrapRunLoopWithAutoreleasePoolHandler}
</span><span class='line'>  
</span><span class='line'>        // Timer
</span><span class='line'>        CFRunLoopTimer {firing = No, interval = 3.1536e+09, tolerance = 0,
</span><span class='line'>            next fire date = 453098071 (-4421.76019 @ 96223387169499),
</span><span class='line'>            callout = _ZN2CAL14timer_callbackEP16__CFRunLoopTimerPv (QuartzCore.framework)}
</span><span class='line'>    },
</span><span class='line'>  
</span><span class='line'>    modes ï¼ {
</span><span class='line'>        CFRunLoopMode  {
</span><span class='line'>            sources0 =  { /* same as 'common mode items' */ },
</span><span class='line'>            sources1 =  { /* same as 'common mode items' */ },
</span><span class='line'>            observers = { /* same as 'common mode items' */ },
</span><span class='line'>            timers =    { /* same as 'common mode items' */ },
</span><span class='line'>        },
</span><span class='line'>  
</span><span class='line'>        CFRunLoopMode  {
</span><span class='line'>            sources0 =  { /* same as 'common mode items' */ },
</span><span class='line'>            sources1 =  { /* same as 'common mode items' */ },
</span><span class='line'>            observers = { /* same as 'common mode items' */ },
</span><span class='line'>            timers =    { /* same as 'common mode items' */ },
</span><span class='line'>        },
</span><span class='line'>  
</span><span class='line'>        CFRunLoopMode  {
</span><span class='line'>            sources0 = {
</span><span class='line'>                CFRunLoopSource {order = 0, {
</span><span class='line'>                    callout = FBSSerialQueueRunLoopSourceHandler}}
</span><span class='line'>            },
</span><span class='line'>            sources1 = (null),
</span><span class='line'>            observers = {
</span><span class='line'>                CFRunLoopObserver &gt;{activities = 0xa0, order = 2000000,
</span><span class='line'>                    callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv}
</span><span class='line'>            )},
</span><span class='line'>            timers = (null),
</span><span class='line'>        },
</span><span class='line'>  
</span><span class='line'>        CFRunLoopMode  {
</span><span class='line'>            sources0 = {
</span><span class='line'>                CFRunLoopSource {order = -1, {
</span><span class='line'>                    callout = PurpleEventSignalCallback}}
</span><span class='line'>            },
</span><span class='line'>            sources1 = {
</span><span class='line'>                CFRunLoopSource {order = -1, {
</span><span class='line'>                    callout = PurpleEventCallback}}
</span><span class='line'>            },
</span><span class='line'>            observers = (null),
</span><span class='line'>            timers = (null),
</span><span class='line'>        },
</span><span class='line'>         
</span><span class='line'>        CFRunLoopMode  {
</span><span class='line'>            sources0 = (null),
</span><span class='line'>            sources1 = (null),
</span><span class='line'>            observers = (null),
</span><span class='line'>            timers = (null),
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿé»˜è®¤æ³¨å†Œäº†5ä¸ªMode;</p>

<ol>
<li>kcfRunLoopDefaultMode:Appé»˜è®¤çš„Mode,é€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªModeä¸‹è¿è¡Œçš„</li>
<li>UITrackingRunLoopMode:ç•Œé¢è·Ÿè¸ªMode,ç”¨äºScrollViewè¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–Modeå½±å“</li>
<li>UIInitializationRunLoopMode:åœ¨åˆšå¯åŠ¨Appæ—¶è¿›å…¥çš„ç¬¬ä¸€ä¸ªMode,å¯åŠ¨å®Œæˆåä¸å†ä½¿ç”¨</li>
<li>CGEventReceiveRunLoopMode:æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨Mode,é€šå¸¸ç”¨ä¸åˆ°</li>
<li>KcfRunLoopCommonModes:è¿™æ˜¯ä¸€ä¸ªå ä½çš„Mode,æ²¡æœ‰å®é™…ä½œç”¨</li>
</ol>


<p>å½“RunLoopè¿›è¡Œå›è°ƒæ—¶ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°è°ƒç”¨å‡ºå»(call out),å½“ä½ åœ¨ä½ çš„ä»£ç ä¸­æ–­ç‚¹è°ƒè¯•æ—¶ï¼Œé€šå¸¸èƒ½åœ¨è°ƒç”¨æ ˆä¸Šçœ‹åˆ°è¿™äº›å‡½æ•°ã€‚ä¸‹é¢å°±æ˜¯è¿™å‡ ä¸ªå‡½æ•°çš„æ•´ç†ç‰ˆæœ¬ï¼Œå¦‚æœä½ åœ¨ä½ çš„è°ƒç”¨æ ˆä¸­çœ‹åˆ°è¿™äº›é•¿å‡½æ•°åï¼Œåœ¨è¿™é‡ŒæŸ¥æ‰¾ä¸€ä¸‹å°±èƒ½å®šä½åˆ°å…·ä½“çš„è°ƒç”¨åœ°ç‚¹äº†:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>    /// 1. é€šçŸ¥Observersï¼Œå³å°†è¿›å…¥RunLoop
</span><span class='line'>    /// æ­¤å¤„æœ‰Observerä¼šåˆ›å»ºAutoreleasePool: _objc_autoreleasePoolPush();
</span><span class='line'>    __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopEntry);
</span><span class='line'>    do {
</span><span class='line'>  
</span><span class='line'>        /// 2. é€šçŸ¥ Observers: å³å°†è§¦å‘ Timer å›è°ƒã€‚
</span><span class='line'>        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeTimers);
</span><span class='line'>        /// 3. é€šçŸ¥ Observers: å³å°†è§¦å‘ Source (éåŸºäºportçš„,Source0) å›è°ƒã€‚
</span><span class='line'>        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeSources);
</span><span class='line'>        __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);
</span><span class='line'>  
</span><span class='line'>        /// 4. è§¦å‘ Source0 (éåŸºäºportçš„) å›è°ƒã€‚
</span><span class='line'>        __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__(source0);
</span><span class='line'>        __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);
</span><span class='line'>  
</span><span class='line'>        /// 6. é€šçŸ¥Observersï¼Œå³å°†è¿›å…¥ä¼‘çœ 
</span><span class='line'>        /// æ­¤å¤„æœ‰Observeré‡Šæ”¾å¹¶æ–°å»ºAutoreleasePool: _objc_autoreleasePoolPop(); _objc_autoreleasePoolPush();
</span><span class='line'>        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeWaiting);
</span><span class='line'>  
</span><span class='line'>        /// 7. sleep to wait msg.
</span><span class='line'>        mach_msg() -&gt; mach_msg_trap();
</span><span class='line'>         
</span><span class='line'>  
</span><span class='line'>        /// 8. é€šçŸ¥Observersï¼Œçº¿ç¨‹è¢«å”¤é†’
</span><span class='line'>        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopAfterWaiting);
</span><span class='line'>  
</span><span class='line'>        /// 9. å¦‚æœæ˜¯è¢«Timerå”¤é†’çš„ï¼Œå›è°ƒTimer
</span><span class='line'>        __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__(timer);
</span><span class='line'>  
</span><span class='line'>        /// 9. å¦‚æœæ˜¯è¢«dispatchå”¤é†’çš„ï¼Œæ‰§è¡Œæ‰€æœ‰è°ƒç”¨ dispatch_async ç­‰æ–¹æ³•æ”¾å…¥main queue çš„ block
</span><span class='line'>        __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(dispatched_block);
</span><span class='line'>  
</span><span class='line'>        /// 9. å¦‚æœå¦‚æœRunloopæ˜¯è¢« Source1 (åŸºäºportçš„) çš„äº‹ä»¶å”¤é†’äº†ï¼Œå¤„ç†è¿™ä¸ªäº‹ä»¶
</span><span class='line'>        __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__(source1);
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>    } while (...);
</span><span class='line'>  
</span><span class='line'>    /// 10. é€šçŸ¥Observersï¼Œå³å°†é€€å‡ºRunLoop
</span><span class='line'>    /// æ­¤å¤„æœ‰Observeré‡Šæ”¾AutoreleasePool: _objc_autoreleasePoolPop();
</span><span class='line'>    __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopExit);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>AutoReleasePool</h3>

<p>Appå¯åŠ¨åï¼Œè‹¹æœåœ¨ä¸»çº¿ç¨‹RunLoopé‡Œæ³¨å†Œäº†ä¸¤ä¸ªObserver,å…¶å›è°ƒéƒ½æ˜¯
<code>_wrapRunLoopWithAutoreleasePoolHandler()ã€‚</code></p>

<p>ç¬¬ä¸€ä¸ªObserverç›‘è§†çš„äº‹ä»¶æ˜¯è¿›å…¥Loop,å…¶å›è°ƒå†…éƒ½ä¼šè°ƒç”¨<code>_objc_autoreleasePoolPush()</code>,åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>

<p>ç¬¬äºŒä¸ªObserverç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶ï¼šBeforeWaitingæ—¶è°ƒç”¨
<em>objc_autoreleasePoolPop() å’Œ </em>objc_autoreleasePoolPush()é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›Exit(å³å°†æ¨å‡ºLoop)æ—¶è°ƒç”¨<code>_objc_autoreleasePoolPop()</code>æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>

<p>åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œé€šå¸¸éƒ½æ˜¯å†™åœ¨äº‹ä»¶å›è°ƒï¼ŒTimerå›è°ƒå†…çš„ï¼Œè¿™äº›å›è°ƒä¼šè¢«RunLoopåˆ›å»ºå¥½çš„AutoreleasePoolç¯ç»•ç€ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜æ³„éœ²ï¼Œå¼€å‘è€…ä¹Ÿä¸å¿…æ˜¾ç¤ºåˆ›å»ºPooläº†ã€‚</p>

<h3>æ‰‹åŠ¿è¯†åˆ«</h3>

<p>å½“ä¸Šé¢çš„<code>_UIApplicationHandleEventQueue()</code>è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨Cancelå°†å½“å‰çš„ <code>touchesBegin/Move/End</code>ç³»åˆ—å›è°ƒæ‰“æ–­.éšåç³»ç»Ÿå°†å¯¹åº”çš„<code>UIGestureRecognizer</code>æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚</p>

<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ªObserveræ£€æµ‹BeforeWaiting (Loopå³å°†è¿›å…¥ä¼‘çœ ) äº‹ä»¶,è¿™ä¸ªObserverçš„å›è°ƒå‡½æ•°æ˜¯ <code>_UIGestureRecognizerUpdateObserver()</code>,å…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„ GestureRecognizer,å¹¶æ‰§è¡ŒGestureRecognizerçš„å›è°ƒ</p>

<h3>ç•Œé¢æ›´æ–°</h3>

<p>å½“åœ¨æ“ä½œUIæ—¶ï¼Œæ¯”å¦‚æ”¹å˜äº†Frame,æ›´æ–°äº†UIview/CaLayerçš„å±‚æ¬¡æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº† UIView/CALayer çš„ setNeedsLayout/setNeedsDisplayæ–¹æ³•å,è¿™ä¸ªUIview/CALayerå°±ä¼šæ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œå¹¶è¢«æäº¤åˆ°ä¸€ä¸ªå…¨å±€çš„å®¹å™¨ä¸­ã€‚</p>

<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ªObserverç›‘å¬BeforeWaiting(å³å°†è¿›å…¥ç¡çœ )å’ŒExit(å³å°†é€€å‡ºLoop)äº‹ä»¶ï¼Œå›è°ƒå»æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°:</p>

<h3>å®šæ—¶å™¨</h3>

<p>NStimerå…¶å®å°±æ˜¯<code>CFRunLoopTimerRef</code>,ä»–ä»¬ä¹‹é—´æ˜¯toll-free bridgedçš„ï¼Œä¸€ä¸ªNStimeræ³¨å†Œåˆ°RunLoopåï¼ŒRunLoopä¼šä¸ºå…¶é‡å¤çš„æ—¶é—´ç‚¹æ³¨å†Œå·é€šçŸ¥ï¼Œä¾‹å¦‚10:00,11:00,12:00,è¿™å‡ ä¸ªæ—¶é—´ç‚¹ï¼Œ</p>

<p>å¦‚æœæŸä¸ªæ—¶é—´ç‚¹è¢«é”™è¿‡äº†ï¼Œä¾‹å¦‚æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œåˆ™é‚£ä¸ªæ—¶é—´ç‚¹çš„å›è°ƒä¹Ÿä¼šè·³è¿‡å»ï¼Œä¸ä¼šå»¶åæ‰§è¡Œï¼Œå°±å¥½æ¯”ç­‰å…¬äº¤ï¼Œå¦‚æœ10:10æ—¶ï¼Œæˆ‘å¿™ç€ç©æ‰‹æœºé”™è¿‡äº†ï¼Œé‚£æˆ‘åªèƒ½ç­‰10ï¼š20çš„é‚£è¶Ÿå…¬äº¤äº†ã€‚</p>

<p>CADisplayLinkæ˜¯ä¸€ä¸ªå’Œå±å¹•åˆ·æ–°ç‡ä¸€è‡´çš„å®šæ—¶å™¨ï¼Œå¦‚æœåœ¨ä¸¤æ¬¡å±å¹•åˆ·æ–°ä¹‹é—´æ‰§è¡Œäº†ä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œé‚£å…¶ä¸­å°±ä¼šæœ‰ä¸€å¸§è¢«è·³è¿‡å»ï¼Œé€ æˆç•Œé¢å¡é¡¿çš„æ„Ÿè§‰ï¼Œåœ¨å¿«é€Ÿæ»šåŠ¨TableViewæ—¶ï¼Œå³ä½¿ä¸€å¸§çš„å¡é¡¿ä¹Ÿä¼šè®©ç”¨æˆ·æœ‰æ‰€æ„Ÿè§‰.FaceBookå¼€æºçš„ <a href="https://github.com/facebook/AsyncDisplayKit.git">AsyncDisplayKit</a>å°±æ˜¯ä¸ºäº†è§£å†³ç•Œé¢å¡é¡¿çš„é—®é¢˜ï¼Œå…¶å†…éƒ¨ä¹Ÿç”¨åˆ°äº†RunLoopã€‚</p>

<h3>performSelecter</h3>

<p>å½“è°ƒç”¨NSobjectçš„<code>performSelecter:afterDelay:</code>åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ªTimerå¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„RunLoopä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰RunLoop,åˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆ.</p>

<p>å½“è°ƒç”¨ <code>performSelector:onThread:</code>æ—¶ï¼Œå®é™…ä¸Šå…¶ä¼šåˆ›å»ºä¸€ä¸ªTImeråŠ åˆ°å¯¹åº”çš„çº¿ç¨‹ä¸­ï¼ŒåŒæ ·æ»´ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰RunLoopè¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆ.</p>

<h3>å…³äºGCD</h3>

<p>å®é™…ä¸ŠRunLoopåº•å±‚ä¹Ÿä¼šç”¨åˆ°GCDçš„ä¸œè¥¿ï¼Œæ¯”å¦‚RUnLoopæ˜¯ç”¨dispatch_source_t å®ç°çš„Timer.ä½†åŒæ—¶GCDæä¾›çš„æŸäº›æ¥å£ä¹Ÿç”¨äº†RUnLoopï¼Œæ¯”å¦‚dispatch_async().</p>

<p>å½“è°ƒç”¨<code>dispatch_async(dispatch_get_main_queue(), block)</code>æ—¶ï¼ŒlibDispatchä¼šæƒ³ä¸»çº¿ç¨‹çš„RunLoopå‘é€æ¶ˆæ¯ï¼ŒRunLoopä¼šè¢«å”¤é†’ï¼Œå¹¶ä»æ¶ˆæ¯ä¸­å»çš„è¿™ä¸ªblock,å¹¶åœ¨å›è°ƒ.</p>

<h3>å…³äºç½‘ç»œè¯·æ±‚</h3>

<p>iosä¸­ï¼Œå…³äºç½‘ç»œè¯·æ±‚çš„æ¥å£è‡ªä¸‹è€Œä¸Šå¦‚ä¸‹å‡ å±‚:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CFSocket
</span><span class='line'>CFNetwork       -&gt;ASIHttpRequest
</span><span class='line'>NSURLConnection -&gt;AFNetworking
</span><span class='line'>NSURLSession    -&gt;AFNetworking2, Alamofire</span></code></pre></td></tr></table></div></figure>


<ul>
<li>CFSocketæ˜¯æœ€åº•å±‚çš„æ¥å£ï¼Œå€¼è´Ÿè´£socketé€šä¿¡</li>
<li>CGNetworkæ˜¯åŸºäºcfSocketç­‰æ¥å£çš„ä¸Šå±‚å°è£…</li>
<li>NSUrlConnectionæ˜¯åŸºäºCFNetworkçš„æ›´é«˜å±‚çš„å°è£…ï¼Œæä¾›é¢å‘å¯¹è±¡çš„æ¥å£ï¼ŒAFNetworkingå·¥ä½œäºè¿™ä¸€å±‚</li>
<li>NSURlSessionæ˜¯ios7ä¸­æ–°å¢çš„æ¥å£ï¼Œè¡¨é¢å’ŒNSUrlConnectionå¹¶åˆ—çš„ï¼Œä½†åº•å±‚ä»ç„¶ç”¨åˆ°äº†NSURLConnection çš„éƒ¨åˆ†åŠŸèƒ½ï¼ŒAFNetworking2 å’Œ Alamofire å·¥ä½œäºè¿™ä¸€å±‚ã€‚
*</li>
</ul>


<p>ä¸‹é¢ä¸»è¦ä»‹ç»NSURlConnectionçš„å·¥ä½œè¿‡ç¨‹.</p>

<p>é€šå¸¸ä½¿ç”¨NSURLconnectionæ—¶ï¼Œä½ ä¼šä¼ å…¥ä¸€ä¸ªDelegate,å½“ä½ è°ƒç”¨ [connection start] åï¼Œè¿™ä¸ªdelegateå°±ä¼šä¸åœçš„æ”¶åˆ°äº‹ä»¶å›è°ƒã€‚å®é™…ä¸Šï¼Œstartè¿™ä¸ªå‡½æ•°çš„å†…éƒ¨ä¼šè·å– CurrentRunLoop,ç„¶ååœ¨å…¶ä¸­çš„DefaultModeæ·»åŠ äº†4ä¸ªSource0, CFMultiplexerSourceæ˜¯è´Ÿè´£å„ç§Delegateå›è°ƒçš„, CFHTTPCookieStorageæ˜¯å¤„ç†å„ç§Cookieçš„ã€‚</p>

<p>å½“å¼€å§‹ç½‘ç»œä¼ è¾“æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°NSURLCOnnenctionåˆ›å»ºäº†ä¸¤ä¸ªæ–°çº¿ç¨‹:
com.apple.NSURLConnectionLoader å’Œ com.apple.CFSocket.private.å…¶ä¸­ï¼ŒCFSocketçº¿ç¨‹æ˜¯å¤„ç†åº•å±‚socketè¿æ¥çš„ã€‚NSUrlConnnectionLoaderè¿™ä¸ªçº¿ç¨‹å†…éƒ¨ä¼šä½¿ç”¨RunLoopæ¥æ¥æ”¶åº•å±‚socketçš„äº‹ä»¶ï¼Œå¹¶é€šè¿‡è¯¥ä¹‹å‰æ·»åŠ çš„Source0é€šçŸ¥ä¸Šå±‚çš„delegateã€‚
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/1432799200369980.png" alt="logo" /></p>

<p>NSURLConnectionLoader ä¸­çš„ RunLoop é€šè¿‡ä¸€äº›åŸºäº mach port çš„ Source æ¥æ”¶æ¥è‡ªåº•å±‚ CFSocket çš„é€šçŸ¥ã€‚å½“æ”¶åˆ°é€šçŸ¥åï¼Œå…¶ä¼šåœ¨åˆé€‚çš„æ—¶æœºå‘ CFMultiplexerSource ç­‰ Source0 å‘é€é€šçŸ¥ï¼ŒåŒæ—¶å”¤é†’ Delegate çº¿ç¨‹çš„ RunLoop æ¥è®©å…¶å¤„ç†è¿™äº›é€šçŸ¥ã€‚CFMultiplexerSource ä¼šåœ¨ Delegate çº¿ç¨‹çš„ RunLoop å¯¹ Delegate æ‰§è¡Œå®é™…çš„å›è°ƒ</p>

<h2>RunLoopçš„å®é™…åº”ç”¨ä¸¾ä¾‹</h2>

<p>AFURLConnectionOperation è¿™ä¸ªç±»æ˜¯åŸºäº<code>NSURLConnection</code>æ„å»ºçš„ï¼Œå…¶å¸Œæœ›èƒ½åœ¨åå°çº¿ç¨‹æ¥æ”¶Delegateå›è°ƒã€‚ä¸ºæ­¤ï¼ŒAFNetworkingå•ç‹¬åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­å¯åŠ¨äº†ä¸€ä¸ªRunLoop:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (void)networkRequestThreadEntryPoint:(id)__unused object {
</span><span class='line'>    @autoreleasepool {
</span><span class='line'>        [[NSThread currentThread] setName:@"AFNetworking"];
</span><span class='line'>        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
</span><span class='line'>        [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
</span><span class='line'>        [runLoop run];
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>  
</span><span class='line'>+ (NSThread *)networkRequestThread {
</span><span class='line'>    static NSThread *_networkRequestThread = nil;
</span><span class='line'>    static dispatch_once_t oncePredicate;
</span><span class='line'>    dispatch_once(&oncePredicate, ^{
</span><span class='line'>        _networkRequestThread = [[NSThread alloc] initWithTarget:self selector:@selector(networkRequestThreadEntryPoint:) object:nil];
</span><span class='line'>        [_networkRequestThread start];
</span><span class='line'>    });
</span><span class='line'>    return _networkRequestThread;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>RunLoopå¯åŠ¨å‰å†…éƒ¨å¿…é¡»è¦æœ‰è‡³å°‘ä¸€ä¸ª Timer/Observer/Source,æ‰€ä»¥AFNetworkingåœ¨[run start]ä¹‹å‰æ”¾å…¥äº†ä¸€ä¸ªæ–°çš„NSmachPortæ·»åŠ è¿›å…¥äº†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè°ƒç”¨è€…éœ€è¦æŒæœ‰NSMachPort (mach_port),å¹¶åœ¨å¤–éƒ¨çº¿ç¨‹é€šè¿‡è¿™ä¸ªPortå‘é€æ¶ˆæ¯åˆ°loopå†…ï¼›ä½†æ­¤å¤„æ·»åŠ portåªæ˜¯ä¸ºäº†è®©RunLoopä¸è‡³äºé€€å‡ºï¼Œå¹¶æ²¡æœ‰å®é™…çš„å‘é€æ¶ˆæ¯.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)start {
</span><span class='line'>    [self.lock lock];
</span><span class='line'>    if ([self isCancelled]) {
</span><span class='line'>        [self performSelector:@selector(cancelConnection) onThread:[[self class] networkRequestThread] withObject:nil waitUntilDone:NO modes:[self.runLoopModes allObjects]];
</span><span class='line'>    } else if ([self isReady]) {
</span><span class='line'>        self.state = AFOperationExecutingState;
</span><span class='line'>        [self performSelector:@selector(operationDidStart) onThread:[[self class] networkRequestThread] withObject:nil waitUntilDone:NO modes:[self.runLoopModes allObjects]];
</span><span class='line'>    }
</span><span class='line'>    [self.lock unlock];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å½“éœ€è¦åœ¨è¿™ä¸ªåå°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼ŒAFNetworkingé€šè¿‡è°ƒç”¨[NSObject performSelector:onThread:..] å°†è¿™ä¸ªä»»åŠ¡æ‰”åˆ°äº†åå°çº¿ç¨‹çš„RunLoopä¸­ã€‚</p>

<h2>AsyncDisplayKit</h2>

<p>AsyncDisplayKit æ˜¯ Facebook æ¨å‡ºçš„ç”¨äºä¿æŒç•Œé¢æµç•…æ€§çš„æ¡†æ¶ï¼Œå…¶åŸç†å¤§è‡´å¦‚ä¸‹:
UIçº¿ç¨‹ä¸­ä¸€æ—¦å‡ºç°ç¹é‡çš„ä»»åŠ¡å°±ä¼šå¯¼è‡´ç•Œé¢å¡é¡¿ï¼Œè¿™ç±»ä»»åŠ¡é€šå¸¸åˆ†ä¸º3ç±»ï¼šæ’ç‰ˆï¼Œç»˜åˆ¶ï¼ŒUiå¯¹è±¡æ“ä½œ.</p>

<p>æ’ç‰ˆé€šå¸¸åŒ…æ‹¬è®¡ç®—è§†å›¾çš„å¤§å°ï¼Œè®¡ç®—æ–‡æœ¬çš„é«˜åº¦ï¼Œç­‰æ“ä½œã€‚</p>

<p>ç»˜åˆ¶ä¸€èˆ¬æœ‰æ–‡æœ¬ç»˜åˆ¶ï¼Œä¾‹å¦‚CoreText,å›¾ç‰‡ç»˜åˆ¶ï¼Œä¾‹å¦‚é¢„å…ˆè§£å‹ï¼Œå…ƒç´ å›¾å½¢ç»˜åˆ¶ç­‰.</p>

<p>UIå¯¹è±¡æ“ä½œé€šå¸¸åŒ…æ‹¬UIView/CaLayerç­‰ui å¯¹è±¡çš„åˆ›å»ºï¼Œè®¾ç½®å±æ€§å’Œé”€æ¯.</p>

<p>å…¶ä¸­å‰ä¸¤ç±»æ“ä½œå¯ä»¥é€šè¿‡å„ç§æ–¹æ³•æ‰”åˆ°åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè€Œæœ€åä¸€ç±»æ“ä½œåªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­å®Œæˆï¼Œå¹¶ä¸”æœ‰æ—¶åé¢çš„æ“ä½œéœ€è¦ä¸€æ å‰é¢æ“ä½œçš„ç»“æœã€‚ï¼ˆä¾‹å¦‚UITextViewåˆ›å»ºæ—¶å¯èƒ½éœ€è¦æå‰è®¡ç®—å‡ºæ–‡æœ¬çš„å¤§å°ï¼‰.ASDKæ‰€åšçš„ï¼Œå°±æ˜¯å°½é‡å°†èƒ½æ”¾å…¥åˆ°åå°çš„ä»»åŠ¡æ”¾å…¥åˆ°åå°ï¼Œä¸èƒ½åˆ™å°½é‡æ¨è¿Ÿ(ä¾‹å¦‚è§†å›¾çš„åˆ›å»ºï¼Œå±æ€§çš„è°ƒæ•´)</p>

<p>ä¸ºæ­¤ï¼ŒASDKåˆ›å»ºäº†ä¸€ä¸ªåä¸º <code>ASDisplayNode</code>çš„å¯¹è±¡ï¼Œå¹¶åœ¨å†…éƒ¨å°è£…äº†UiView/CaLayerï¼Œå®ƒå…·æœ‰å’ŒUIView/CALayerç›¸ä¼¼çš„å±æ€§ï¼Œä¾‹å¦‚ frame,backgroundColorç­‰ã€‚æ‰€æœ‰è¿™äº›å°šéœ€ç»éƒ½å¯ä»¥æ”¾åˆ°åå°çº¿ç¨‹æ›´æ”¹ï¼Œå¼€å‘è€…å¯ä»¥åªé€šè¿‡Nodeæ¥æ“ä½œå™¨å†…éƒ¨çš„UIVidw/CaLayerï¼Œè¿™æ ·å°±å¯ä»¥å°†æ’ç‰ˆå’Œç»˜åˆ¶æ”¾å…¥åˆ°äº†åå°çº¿ç¨‹ï¼Œä½†æ˜¯æ— è®ºæ€ä¹ˆæ“ä½œï¼Œè¿™äº›å±æ€§æ€»æ˜¯éœ€è¦åœ¨æŸä¸ªæ—¶åˆ»åŒæ­¥åˆ°ä¸»çº¿ç¨‹çš„ UIview/CaLayerä¸­ã€‚</p>

<p>ASDKä»¿ç…§ QuartzCore/UIKitæ¡†æ¶çš„æ¨¡å¼ï¼Œå®ç°äº†ä¸€å¥—ç±»ä¼¼çš„ç•Œé¢æ›´æ–°æœºåˆ¶:å³åœ¨ä¸»çº¿ç¨‹çš„RunLoopä¸­æ·»åŠ ä¸€ä¸ªObserver,ç›‘å¬äº† kCFRunLoopBeforeWaiting å’Œ kCFRunLoopExit äº‹ä»¶,åœ¨æ”¶åˆ°å›è°ƒæ—¶ï¼Œéå†æ‰€æœ‰ä¹‹å‰æ”¾å…¥é˜Ÿåˆ—ç­‰å¾…å¤„ç†çš„ä»»åŠ¡ï¼Œç„¶åä¸€ä¸€æ‰§è¡Œã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[NSUrlSessionè¯¦è§£]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/27/nsurlsessionxiang-jie/"/>
    <updated>2016-03-27T18:48:28+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/27/nsurlsessionxiang-jie</id>
    <content type="html"><![CDATA[<p>NSUrlSessionæ˜¯NSUrlConnectionçš„æ›¿ä»£å“ã€‚</p>

<p>NSUrlConennectionæŒ‡çš„æ˜¯ä¸€ç»„æ„æˆ Foundationæ¡†æ¶ä¸­URLåŠ è½½ç³»ç»Ÿçš„ç›¸äº’å…³è”çš„ç»„ä»¶:NSURLRequest,NSUrlResponse,NSURlProtocolç­‰,åœ¨åå•†å‘é€ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥æœåŠ¡å™¨å¯å‘å‡ºéªŒè¯è´¨è¯¢ï¼Œè¿™å¯ä»¥ç”±å…±äº«çš„cookieï¼Œè¯ä¹¦å­˜å‚¨ï¼ˆcredential storageï¼‰æˆ–é€šè¿‡è¿æ¥å§”æ‰˜è‡ªåŠ¨å¤„ç†ã€‚å¿…è¦çš„æ—¶å€™ï¼Œä¸ºäº†æ— ç¼åœ°æ”¹å˜è£…è½½è¡Œä¸ºï¼Œä¼ å‡ºè¯·æ±‚ä¹Ÿå¯ä»¥è¢«æ³¨å†Œçš„NSURLProtocolå¯¹è±¡æˆªè·.</p>

<!--more-->


<p>ä¸ç®¡æ€æ ·ï¼Œè€ƒè™‘åˆ°NSURLConnectionä½œä¸ºä¸€ä¸ªç½‘ç»œåŸºç¡€æ¶æ„ï¼Œæˆåƒä¸Šä¸‡çš„Cocoaå’ŒCocoa Touchåº”ç”¨ç¨‹åºä»ä¸­è·ç›Šï¼Œå®ƒå·²ç»è¡¨ç°å¾—ç›¸å½“å¥½ã€‚ä½†æ˜¯ï¼Œè¿™äº›å¹´æ¥ï¼ŒiPhoneå’ŒiPadæ–°å…´çš„ç”¨ä¾‹ï¼Œç‰¹åˆ«æ˜¯æœ‰ä¸€äº›å·²ç»å‘NSURLConnectionçš„å‡ ä¸ªæ ¸å¿ƒè®¾æƒ³æå‡ºäº†æŒ‘æˆ˜ï¼Œå¯¹å…¶é‡æ„å·²ç»è¿«åœ¨çœ‰ç«ã€‚</p>

<p>åœ¨2013å¹´çš„WWDCä¸Šï¼ŒAppleæ­å¼€äº†NSURLConnectionç»§ä»»è€…çš„é¢çº±ï¼šNSURLSession.</p>

<p>ä¸NSUrlConnectionç±»ä¼¼ï¼Œé™¤äº†åŒåç±» NSUrlsession,NSUrlSessionæŒ‡çš„æ˜¯ä¸€ç»„ç›¸äº’ä¾èµ–çš„ç±»ï¼ŒNSURlSessionåŒ…æ‹¬ä¸ä¹‹å‰ç›¸åŒçš„ç»„ä»¶ï¼Œä¾‹å¦‚NSUrlRequest,NSURLCatchç­‰ç­‰ã€‚
ã€€ã€€</p>

<h2>NSURlconenction ä¸ NSSessionçš„ä¸åŒ</h2>

<p>ã€€ã€€ä¸NSUrlConnectionç›¸æ¯”ï¼ŒNSUrlSessionæœ€ç›´æ¥çš„æ”¹å–„å°±æ˜¯æä¾›äº†é…ç½®æ¯ä¸ªå›è¯çš„ç¼“å­˜ï¼Œåè®®ï¼Œcookieå’Œè¯ä¹¦ç­–ç•¥(credential policies),ç”šè‡³è·¨åº”ç”¨ç¨‹åºå…±äº«å®ƒä»¬çš„èƒ½åŠ›ã€‚è¿™ä½¿å¾—æ¡†æ¶çš„ç½‘ç»œåŸºç¡€æ¶æ„å’Œéƒ¨åˆ†åº”ç”¨ç¨‹åºç‹¬ç«‹å·¥ä½œï¼Œè€Œä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œæ¯ä¸€ä¸ªNSUrlSessionå¯¹è±¡éƒ½æ˜¯æ ¹æ®ä¸€ä¸ªNSURlSessionConfigurationåˆå§‹åŒ–çš„ï¼Œ
ã€€ã€€
ã€€ã€€</p>

<p>è¯¥NSURlSessionConfigurationæŒ‡å®šäº†ä¸Šé¢æåˆ°çš„ç­–ç•¥ï¼Œä¸€çº§ä¸€ç³»åˆ—ä¸ºäº†æé«˜ç§»åŠ¨è®¾å¤‡æ€§èƒ½è€Œä¸“é—¨æ·»åŠ çš„æ–°é€‰é¡¹ã€‚</p>

<p>NSUrlSessionçš„å¦ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†å°±æ˜¯ä¼šè¯ä»»åŠ¡ï¼Œå®ƒè´Ÿè´£å¤„ç†æ•°æ®çš„åŠ è½½ï¼Œä»¥åŠå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„æ–‡ä»¶å’Œæ•°æ®çš„ä¸Šä¼ å’Œä¸‹è½½ã€‚</p>

<h2>NSURLSessionç®€ä»‹</h2>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Screen-Shot-2015-08-20-at-12.27.21-am.png" alt="logo" /></p>

<p>NSURLsessionå…³é”®å¯¹è±¡è´Ÿè´£æ¥æ”¶å’Œå‘é€httpè¯·æ±‚ï¼Œåˆ›å»ºNSURlSessionConfiguration,è¿™é‡Œæœ‰ä¸‰ç§æ–¹å¼:</p>

<ul>
<li><code>defaultSessionConfiguration</code>åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥å­˜å‚¨ç¼“å­˜ï¼Œåˆ›å»ºè¯ä¹¦å’Œç¼“å­˜cookieç­‰</li>
<li><code>ephemeralSessionConfiguration</code>å’Œé»˜è®¤é…ç½®æ–‡ä»¶å¾ˆç›¸ä¼¼ï¼Œé™¤äº†å®ƒå¯ä»¥åœ¨å†…å­˜ä¸­å­˜å‚¨ä¹‹å¤–ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ªç§æœ‰çš„session</li>
<li><code>backgroundSessionConfiguration</code>è¿™ä¸ªé…ç½®æ–‡ä»¶æ”¯æŒä¸Šä¼ å’Œä¸‹è½½ä»»åŠ¡åœ¨åå°ã€‚å½“ç¨‹åºæŒ‚èµ·æˆ–è€…è¢«ç»ˆæ­¢ä¹‹åä»»åŠ¡å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</li>
</ul>


<p><code>NSURLSessionConfiguration</code>ä¾ç„¶å¯ä»¥è®©ä½ é…ç½®sessionçš„å±æ€§ï¼Œæ¯”å¦‚è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œç¼“å­˜ç­–ç•¥å’Œhttpè¯·æ±‚å¤´ç­‰ã€‚<a href="https://developer.apple.com/library/mac/documentation/Foundation/Reference/NSURLSessionConfiguration_class/index.html#//apple_ref/occ/cl/NSURLSessionConfiguration">è¿™é‡Œ</a>æœ‰å®Œæ•´çš„é…ç½®æ–‡æ¡£ã€‚</p>

<p><code>NSURLSessionTask</code>æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ä»»åŠ¡ç¬¦å·,ä¸€ä¸ªsessionåˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œå®ƒä¸ä»…å¯ä»¥è¯·æ±‚æ•°æ®ï¼Œè¿˜å¯ä»¥ä¸Šä¼ å’Œä¸‹è½½ã€‚</p>

<p>è¿™é‡Œæœ‰ä¸‰ç§ç±»å‹çš„ä»»åŠ¡ï¼š</p>

<ul>
<li><code>NSURLSessionDataTask</code>ï¼šç”¨è¿™ä¸ªä»»åŠ¡å¯ä»¥å‘é€httpè¯·æ±‚ï¼Œä»è€Œä»æœåŠ¡å™¨å¾—åˆ°è¿”å›çš„æ•°æ®</li>
<li><code>NSURLSessionUploadTask</code>ï¼šç”¨è¿™ä¸ªä»»åŠ¡å¯ä»¥ä»æœ¬åœ°ç¡¬ç›˜ä¸Šå¾€æœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯HTTP postè¯·æ±‚æˆ–è€…PUTè¯·æ±‚.</li>
<li><code>NSURLSessionDownloadTask</code>:ç”¨è¿™ä¸ªä»»åŠ¡å¯ä»¥ä»è¿œç¨‹æœåŠ¡å™¨ä¸Šä¸‹è½½æ–‡ä»¶</li>
</ul>


<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Screen-Shot-2015-08-20-at-12.27.27-am.png" alt="logo" /></p>

<p>ä½ å¯ä»¥æŒ‚èµ·ï¼Œå›æ»šå’Œå–æ¶ˆä»»åŠ¡ï¼Œ<code>NSURLSessionDownloadTask</code>è¿˜æœ‰ä¸€ä¸ªç‰¹æ€§å°±æ˜¯æ”¯æŒæ–­ç‚¹ä¸‹è½½ã€‚</p>

<p>ä¸€èˆ¬æ¥è®², NSURLSession æœ‰ä¸¤ç§æ–¹å¼è¿”å›æ•°æ®ï¼š</p>

<ol>
<li>åˆ©ç”¨completion handler,å½“ä»»åŠ¡å®Œæˆä¹‹åï¼Œä¸ç®¡æ˜¯æˆåŠŸè¿”å›è¿˜æ˜¯äº§ç”Ÿé”™è¯¯ï¼›</li>
<li>è¿˜æœ‰ä¸€ç§å°±æ˜¯åˆ©ç”¨NSSessionçš„ä»£ç†ï¼Œä¾ç„¶å¯ä»¥æ•è·åˆ°è¿”å›çš„æ•°æ®;</li>
</ol>


<h2>ç¼–å†™å®ä¾‹Demo</h2>

<p><a href="http://www.raywenderlich.com/wp-content/uploads/2016/01/HalfTunes-Starter.zip">å¯åŠ¨å·¥ç¨‹åœ¨è¿™é‡Œä¸‹è½½</a>,</p>

<p>å¼€å§‹åšä¸€ä¸ª åœ¨Itunesæœç´¢æ­Œæ›²ï¼Œé€šè¿‡<a href="https://www.apple.com/itunes/affiliates/resources/documentation/itunes-store-web-service-search-api.html">Itunes API</a>ä¸‹è½½æ­Œæ›²çš„è¿™ä¹ˆä¸ªå°å·¥ç¨‹ï¼Œæ”¯æŒæš‚åœï¼Œä¸‹è½½åŠŸèƒ½ã€‚</p>

<p>ä¸‹å®Œå·¥ç¨‹ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/Simulator-Screen-Shot-12-Aug-2015-11.10.57-pm-281x500.png" alt="itunes" /></p>

<h3>å¼€å§‹ç¼–å†™ä»£ç </h3>

<p>ä½ å¯ä»¥æ·»åŠ ä»£ç å»æŸ¥è¯¢itunesä¸­çš„æ­Œæ›²ï¼Œé€šè¿‡æŸ¥æ‰¾ Itunes search Api.</p>

<p>åœ¨<code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1
</span><span class='line'>let defaultSession = NSURLSession(configuration: NSURLSessionConfiguration.defaultSessionConfiguration())
</span><span class='line'>// 2
</span><span class='line'>var dataTask: NSURLSessionDataTask?</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä»£ç åšäº†å¦‚ä¸‹å·¥ä½œ:</p>

<ol>
<li>ç”¨é»˜è®¤çš„é…ç½®æ–‡ä»¶åˆ›å»ºNSURLSession</li>
<li>ä½ å®šä¹‰äº†ä¸€ä¸ª<code>NSURLSessionDataTask</code>å˜é‡ï¼Œç”¨å®ƒå‘é€httpè¯·æ±‚ï¼Œè¿™ä¸ªä»»åŠ¡å°†ä¼šè¢«é‡å¤åˆå§‹åŒ–å’Œé‡å¤åˆ©ç”¨åœ¨ç”¨æˆ·åˆ›å»ºä¸€ä¸ªæ–°æŸ¥è¯¢çš„æ—¶å€™</li>
</ol>


<p>ç°åœ¨ï¼Œæ›¿æ¢<code>searchBarSearchButtonClicked(_:)</code>é‡Œé¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func searchBarSearchButtonClicked(searchBar: UISearchBar) {
</span><span class='line'>  dismissKeyboard()
</span><span class='line'> 
</span><span class='line'>  if !searchBar.text!.isEmpty {
</span><span class='line'>    // 1
</span><span class='line'>    if dataTask != nil {
</span><span class='line'>      dataTask?.cancel()
</span><span class='line'>    }
</span><span class='line'>    // 2
</span><span class='line'>    UIApplication.sharedApplication().networkActivityIndicatorVisible = true
</span><span class='line'>    // 3
</span><span class='line'>    let expectedCharSet = NSCharacterSet.URLQueryAllowedCharacterSet()
</span><span class='line'>    let searchTerm = searchBar.text!.stringByAddingPercentEncodingWithAllowedCharacters(expectedCharSet)!
</span><span class='line'>    // 4
</span><span class='line'>    let url = NSURL(string: "https://itunes.apple.com/search?media=music&entity=song&term=\(searchTerm)")
</span><span class='line'>    // 5
</span><span class='line'>    dataTask = defaultSession.dataTaskWithURL(url!) {
</span><span class='line'>      data, response, error in
</span><span class='line'>      // 6
</span><span class='line'>      dispatch_async(dispatch_get_main_queue()) {
</span><span class='line'>        UIApplication.sharedApplication().networkActivityIndicatorVisible = false
</span><span class='line'>      }
</span><span class='line'>      // 7
</span><span class='line'>      if let error = error {
</span><span class='line'>        print(error.localizedDescription)
</span><span class='line'>      } else if let httpResponse = response as? NSHTTPURLResponse {
</span><span class='line'>        if httpResponse.statusCode == 200 {
</span><span class='line'>          self.updateSearchResults(data)
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>    // 8
</span><span class='line'>    dataTask?.resume()
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿è¡Œåä»£ç å¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160401-1.png" alt="logo" /></p>

<p>å¦‚æœå‡ºç°é”™è¯¯<code>An SSL error has occurred and a secure connection to the server cannot be made.</code></p>

<p>è¯·åœ¨info.plistä¸­é…ç½®ï¼Œåœ¨Info.plistä¸­æ·»åŠ NSAppTransportSecurityç±»å‹Dictionaryã€‚ åœ¨NSAppTransportSecurityä¸‹æ·»åŠ NSAllowsArbitraryLoadsç±»å‹Boolean,å€¼è®¾ä¸º YES</p>

<p>ä¸Šé¢çš„ä»£ç æ­¥éª¤æ„ä¹‰å¦‚ä¸‹:</p>

<ol>
<li>æ£€æŸ¥ç”¨æˆ·æ¯ä¸€æ¬¡æŸ¥è¯¢ï¼ŒdataTaskæ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å–æ¶ˆè¯¥ä»»åŠ¡</li>
<li>è®¾ç½®çš„çŠ¶æ€æ ä¸Šçš„è½¬å­è¿è¡Œèµ·æ¥ï¼Œè¯æ˜æ•°æ®æ­£åœ¨è¯·æ±‚å½“ä¸­</li>
<li>å½“ç”¨æˆ·è¾“å…¥æŸ¥è¯¢å‚æ•°ä¹‹å‰ï¼Œè°ƒç”¨ è¯·æ±‚å­—ç¬¦ä¸²çš„<code>stringByAddingPercentEncodingWithAllowedCharacters(_:)</code>,ç¡®ä¿æ˜¯ä¸€ä¸ªæ­£ç¡®çš„URL.ã€€(è¿™ä¸ª text çš„ç±»å‹æ˜¯ String ï¼Œå¸¸ç”¨äºæœç´¢åŠŸèƒ½ï¼Œåœ¨  URL ä¸­åŒ…å«è¢«æœçš„å…³é”®å­—ï¼Œå¦‚æœä¸å¤„ç†æœä¸­æ–‡æˆ–è€…å¸¦ç©ºæ ¼çš„è‹±æ–‡ä¼šç›´æ¥å´©æºƒ);</li>
<li>ä¸‹ä¸€æ­¥åˆ›å»ºä¸€ä¸ªNSURLç”¨ä¸Šé¢çš„ï¼ˆå®‰å…¨çš„ï¼‰å­—ç¬¦ä¸²ï¼Œä½¿ç”¨GETè¯·æ±‚å»è°ƒç”¨Itunes Search API</li>
<li>ä»åˆ›å»ºçš„Sessionä¸­ï¼Œä½ åˆå§‹åŒ–<code>NSURLSessionDataTask</code>å»å¤„ç†httpè¯·æ±‚ï¼Œè¿™ä¸ª<code>NSURLSessionDataTask</code>ä»»åŠ¡ä½¿ç”¨completion handler ï¼ˆå›è°ƒå‡½æ•°ï¼‰å»å“åº”æœåŠ¡å™¨è¿”å›çš„æ•°æ®</li>
<li>å¼‚æ­¥è°ƒç”¨ä¸»çº¿ç¨‹ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸Šéšè—ç½‘ç»œè¯·æ±‚çš„è½¬å­</li>
<li>å¦‚æœhttpè¯·æ±‚æ˜¯æˆåŠŸçš„ï¼Œä½ å¯ä»¥è°ƒç”¨<code>updateSearchResults(_:)</code>æ¥åˆ·æ–°è¡¨æ ¼æ•°æ®ï¼Œè¿”å›æ•°æ®æ˜¯NSDataç±»å‹çš„ï¼Œéœ€è¦åœ¨updateSearchResultsæ–¹æ³•ä¸­è¿›è¡Œå¤„ç†</li>
<li>æ‰€æœ‰ä»»åŠ¡é»˜è®¤æ˜¯æŒ‚èµ·çŠ¶æ€ï¼Œéœ€è¦ä½ è°ƒç”¨ <code>resume()</code>å»å¯åŠ¨ä»»åŠ¡</li>
</ol>


<h2>ä¸‹è½½</h2>

<p>çœ‹ç€æœç´¢åˆ°çš„æ­Œæ›²ï¼Œæ„Ÿè§‰é¡µé¢ä¸é”™ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡ç‚¹å‡» download,ç„¶åæŠŠæ­Œæ›²ä¸‹è½½åˆ°æœ¬åœ°æ˜¯ä¸æ˜¯æ›´çˆ½å‘¢?ä¸‹ä¸€æ­¥è®©æˆ‘å®ç°è¿™ä¸ªåŠŸèƒ½ç‚¹.</p>

<p>ç”¨å¤šçº¿ç¨‹å®ç°ä¸‹è½½æ˜¯å®¹æ˜“çš„ã€‚é¦–å…ˆä½ è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶å‘½åä¸º <code>Download.swift</code>. æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Download: NSObject {
</span><span class='line'> 
</span><span class='line'>  var url: String
</span><span class='line'>  var isDownloading = false
</span><span class='line'>  var progress: Float = 0.0
</span><span class='line'> 
</span><span class='line'>  var downloadTask: NSURLSessionDownloadTask?
</span><span class='line'>  var resumeData: NSData?
</span><span class='line'> 
</span><span class='line'>  init(url: String) {
</span><span class='line'>    self.url = url
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å±æ€§è¯´æ˜å¦‚ä¸‹:</p>

<ul>
<li>URL:ä¸‹è½½æ–‡ä»¶çš„urlåœ°å€ï¼Œå®ƒä¹Ÿæ‰®æ¼”ç€å”¯ä¸€çš„æ ‡è¯†ç¬¦åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­</li>
<li>isDownloading:æ˜¯å¦æ­£åœ¨ä¸‹è½½æˆ–æš‚åœ</li>
<li>progress : ä¸‹è½½çš„è¿›åº¦,[0-1]</li>
<li>downloadTask: NSURLSessionDownloadTaskä¸‹è½½ä»»åŠ¡</li>
<li>resumeData:å½“ä½ æš‚åœä¸€ä¸ªä¸‹è½½ä»»åŠ¡æ—¶ï¼Œå®ƒè´Ÿè´£å­˜å‚¨æ­¤æ—¶çš„æ•°æ®é‡ï¼›å¦‚æœåå°æœåŠ¡å™¨æ”¯æŒçš„è¯ï¼Œå½“ç”¨æˆ·å†æ¬¡ç‚¹å‡»ç»§ç»­ä¸‹è½½ï¼Œå®ƒä¼šä»è¿™é‡Œå¼€å§‹ç»§ç»­ä¸‹è½½è¿™ä¸ªæ–‡ä»¶ï¼Œä¿—ç§° æ–­ç‚¹ä¸‹è½½</li>
</ul>


<p>åˆ‡æ¢åˆ° <code>SearchViewController.swift</code>ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var activeDownloads = [String: Download]()</span></code></pre></td></tr></table></div></figure>


<h2>åˆ›å»ºä¸‹è½½ä»»åŠ¡</h2>

<p>å‡†å¤‡å·¥ä½œåšå¾—å·®ä¸å¤šäº†ï¼Œç°åœ¨ä½ åªéœ€å®ç°ä¸‹è½½ï¼Œé¦–å…ˆä½ è¦åˆ›å»ºä¸€ä¸ªsessionå»å®ç°ä¸‹è½½ä»»åŠ¡.</p>

<p>åœ¨ <code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œåœ¨<code>viewDidLoad():</code>ä¹‹å‰æ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lazy var downloadsSession: NSURLSession = {
</span><span class='line'>  let configuration = NSURLSessionConfiguration.defaultSessionConfiguration()
</span><span class='line'>  let session = NSURLSession(configuration: configuration, delegate: self, delegateQueue: nil)
</span><span class='line'>  return session
</span><span class='line'>}()</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œåˆå§‹åŒ–äº†ä¸€ä¸ªsession,ç”¨é»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œå»å¤„ç†æ‰€æœ‰çš„ä¸‹è½½ä»»åŠ¡ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šdelegate,è¿™å°†ä¼šä½¿ä½ æ”¶åˆ° <code>NSURLSession</code>çš„ä»£ç†è°ƒç”¨ï¼Œè¿™ä¸ªæ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå®ƒèƒ½æœ‰æ•ˆçš„è·Ÿè¸ªä¸‹è½½ä»»åŠ¡ä¸‹è½½çš„è¿›åº¦å’Œæ˜¯å¦ä¸‹è½½å®Œæˆç­‰ã€‚</p>

<p>è®¾ç½®ä»£ç†çš„é˜Ÿåˆ—æ˜¯nil,ä¼šä¿ƒä½¿sessionåˆ›å»ºä¸€ä¸ªæ“ä½œé˜Ÿåˆ—ï¼Œé»˜è®¤çš„å»è°ƒç”¨ä»£ç†æ–¹æ³•å’Œå›è°ƒæ–¹æ³•.</p>

<p>åœ¨åˆ›å»º<code>downloadsSession</code>å±æ€§çš„æ—¶å€™ï¼Œæˆ‘ä»¬åŠ äº†<code>lazy</code>ç‰¹æ€§ï¼Œè¿™ä¼šè®©ä½ å»¶è¿ŸåŠ è½½è¿™ä¸ªsessionç›´åˆ°ä½ éœ€è¦å®ƒçš„æ—¶å€™ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä¼šé€šè¿‡<code>self</code>ä½œä¸ºä»£ç†å‚æ•°å»åˆå§‹åŒ–ï¼Œå‡å¦‚<code>self</code>è¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚</p>

<p>åœ¨<code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°ç©ºçš„<code>NSURLSessionDownloadDelegate</code>å¹¶ä¸”æ‰©å±•å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>extension SearchViewController: NSURLSessionDownloadDelegate {
</span><span class='line'>  func URLSession(session: NSURLSession, downloadTask: NSURLSessionDownloadTask, didFinishDownloadingToURL location: NSURL) {
</span><span class='line'>    print("Finished downloading.")
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>NSURLSessionDownloadDelegate</code>å®šä¹‰äº†ä»£ç†æ–¹æ³•ä½ éœ€è¦å»å®ç°ï¼Œåœ¨ä½ ä½¿ç”¨ NSURLSession ä¸‹è½½ä»»åŠ¡çš„æ—¶å€™ï¼Œè¿™ä¸ªå”¯ä¸€çš„ä¸æ˜¯å¯é€‰çš„ä»£ç†æ–¹æ³•æ˜¯ <code>URLSession(_:downloadTask:didFinishDownloadingToURL:),</code>,å½“ä¸‹è½½å®Œæˆçš„æ—¶å€™ï¼Œå°†ä¼šæ‰§è¡Œè¿™ä¸ªä»£ç†æ–¹æ³•ï¼Œæ‰“å°ç®€ç­”çš„ä¸€å¥è¯.</p>

<p>åœ¨<code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œæ›¿æ¢<code>startDownload(_:)</code>è¿™ä¸ªæ–¹æ³•çš„ä»£ç å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func startDownload(track: Track) {
</span><span class='line'>  if let urlString = track.previewUrl, url =  NSURL(string: urlString) {
</span><span class='line'>    // 1
</span><span class='line'>    let download = Download(url: urlString)
</span><span class='line'>    // 2
</span><span class='line'>    download.downloadTask = downloadsSession.downloadTaskWithURL(url)
</span><span class='line'>    // 3
</span><span class='line'>    download.downloadTask!.resume()
</span><span class='line'>    // 4
</span><span class='line'>    download.isDownloading = true
</span><span class='line'>    // 5
</span><span class='line'>    activeDownloads[download.url] = download
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å½“ä½ ç‚¹å‡» <code>Download</code>æŒ‰é’®çš„æ—¶å€™ï¼Œä½ å°†ä¼šè°ƒç”¨<code>startDownload(_:)</code>å‡½æ•°å»æ‰§è¡Œä¸‹è½½å‘½ä»¤ï¼Œä¸Šé¢çš„ä»£ç æ‰§è¡Œçš„æ­¥éª¤å¦‚ä¸‹:</p>

<ol>
<li>ä½ ç”¨URLå»åˆå§‹åŒ–ä¸€ä¸ªDownLoadå¯¹è±¡</li>
<li>ä½¿ç”¨ä¸Šé¢çš„NSURLå’ŒdownloadsSessionå»åˆå§‹åŒ–<code>NSURLSessionDownloadTask</code></li>
<li>è°ƒç”¨resume()å»å¯åŠ¨ä¸€ä¸ªä¸‹è½½ä»»åŠ¡</li>
<li>è®¾ç½®ä¸‹è½½æ ‡è¯† ä¸ºtrue</li>
<li>æœ€åï¼Œä½ æŠŠä¸‹è½½çš„URLä½œä¸ºkey,downloadå¯¹è±¡ä½œä¸ºå€¼æ”¾åˆ°ä¸€ä¸ªå­—å…¸ä¸­</li>
</ol>


<p>ç¼–è¯‘è¿è¡Œä½ çš„é¡¹ç›®ï¼ŒæŸ¥è¯¢å‡ºæ¥çš„æ­Œæ›²ä¸­ï¼Œç‚¹å‡» DownloadæŒ‰é’®ï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸€ä¸ªæ¶ˆæ¯æ‰“å°åœ¨æ§åˆ¶å°ã€‚
<code>Finished downloading.</code></p>

<h2>ä¿å­˜&amp;æ’­æ”¾</h2>

<p>å½“ä¸‹è½½ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œ<code>URLSession(_:downloadTask:didFinishDownloadingToURL:)</code>æä¾›äº†ä¸€ä¸ªURLå­˜å‚¨ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼Œä½ çš„å·¥ä½œå°±æ˜¯ç§»åŠ¨å®ƒåˆ°ä½ ç¨‹åºçš„æ²™ç›’å½“ä¸­ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•è¿”å›ä¹‹å‰ã€‚å½“ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å½“ä¸­ä½ éœ€è¦åˆ é™¤å…¨å±€å­—å…¸ä¸­æ­£åœ¨ä¸‹è½½çš„downloadå¯¹è±¡ï¼Œå¹¶ä¸”æ›´æ–°è¡¨æ ¼.</p>

<p>ä½ éœ€è¦æ·»åŠ ä¸€ä¸ªHelperæ–¹æ³•ç®€åŒ–è¿™ä¸ªæ“ä½œï¼Œåœ¨<code>SearchViewController.swift</code>ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹æ–¹æ³•:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func trackIndexForDownloadTask(downloadTask: NSURLSessionDownloadTask) -&gt; Int? {
</span><span class='line'>  if let url = downloadTask.originalRequest?.URL?.absoluteString {
</span><span class='line'>    for (index, track) in searchResults.enumerate() {
</span><span class='line'>      if url == track.previewUrl! {
</span><span class='line'>        return index
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>  return nil
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªæ–¹æ³•ä»…ä»…è¿”å› å½“å‰çš„URLåœ¨ searchResultsé›†åˆä¸­çš„ç´¢å¼•ï¼Œä¸‹ä¸€æ­¥ï¼Œæ›¿æ¢ URLSession(_:downloadTask:didFinishDownloadingToURL:) ä¸­çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func URLSession(session: NSURLSession, downloadTask: NSURLSessionDownloadTask, didFinishDownloadingToURL location: NSURL) {
</span><span class='line'>  // 1
</span><span class='line'>  if let originalURL = downloadTask.originalRequest?.URL?.absoluteString,
</span><span class='line'>    destinationURL = localFilePathForUrl(originalURL) {
</span><span class='line'> 
</span><span class='line'>    print(destinationURL)
</span><span class='line'> 
</span><span class='line'>    // 2
</span><span class='line'>    let fileManager = NSFileManager.defaultManager()
</span><span class='line'>    do {
</span><span class='line'>      try fileManager.removeItemAtURL(destinationURL)
</span><span class='line'>    } catch {
</span><span class='line'>      // Non-fatal: file probably doesn't exist
</span><span class='line'>    }
</span><span class='line'>    do {
</span><span class='line'>      try fileManager.copyItemAtURL(location, toURL: destinationURL)
</span><span class='line'>    } catch let error as NSError {
</span><span class='line'>      print("Could not copy file to disk: \(error.localizedDescription)")
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'> 
</span><span class='line'>  // 3
</span><span class='line'>  if let url = downloadTask.originalRequest?.URL?.absoluteString {
</span><span class='line'>    activeDownloads[url] = nil
</span><span class='line'>    // 4
</span><span class='line'>    if let trackIndex = trackIndexForDownloadTask(downloadTask) {
</span><span class='line'>      dispatch_async(dispatch_get_main_queue(), {
</span><span class='line'>        self.tableView.reloadRowsAtIndexPaths([NSIndexPath(forRow: trackIndex, inSection: 0)], withRowAnimation: .None)
</span><span class='line'>      })
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä»£ç åšçš„äº‹æƒ…å¦‚ä¸‹:</p>

<ol>
<li>å®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼Œ<code>originalURL</code>è¯·æ±‚è·¯å¾„çš„url,<code>destinationURL</code>å˜é‡åˆ™æ˜¯é€šè¿‡<code>localFilePathForUrl(_:)</code>æ–¹æ³•ç”Ÿæˆçš„ï¼Œè¯¥æ–¹æ³•ä¼šè·å–å½“å‰ç¨‹åºçš„æ²™ç›’è·¯å¾„å†è¿½åŠ  ä¼ é€’çš„URLçš„æœ€åä¸€ä¸ªåç¼€(/)çš„è·¯å¾„ä½œä¸ºè¿”å›çš„å‚æ•°ã€‚ä½œä¸ºç›®æ ‡æ–‡ä»¶å¤¹çš„è·¯å¾„</li>
<li>ä½¿ç”¨NSFileManager,åœ¨å¼€å§‹æ‹·è´æ–‡ä»¶ä¹‹å‰ï¼Œå…ˆåˆ é™¤ç›®æ ‡æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨çš„è¯ã€‚ç„¶åè¿›è¡Œæ‹·è´ä»æœ¬åœ°æ‹·è´åˆ°ç›®æ ‡æ–‡ä»¶å¤¹</li>
<li>åˆ é™¤downloadä»å…¨å±€çš„downloadå­—å…¸ä¸­</li>
<li>æœ€ååˆ·æ–°è¡¨æ ¼å¯¹åº”çš„å“ªä¸€è¡Œ</li>
</ol>


<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œç‚¹å‡»æœç´¢ç„¶åé€‰ä¸­ä¸€è¡Œè¿›è¡Œä¸‹è½½ï¼Œå½“ä¸‹è½½å®Œæˆæ—¶å€™ï¼Œåœ¨æ§åˆ¶å°ä¼šæ‰“å°ä¸€è¡Œä¿¡æ¯,ä¸‹è½½çš„ç›®æ ‡è·¯å¾„</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>file:///Users/Andrew/Library/Developer/CoreSimulator/Devices/875165C2-FA55-4884-96AE-A7C8E3223C12/data/Containers/Data/Application/52B47648-04A2-4C26-8BCF-F41D2C76CA21/Documents/mzm.gyadmzom.aac.p.m4a</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ—¶ä¸‹è½½æŒ‰é’®å°†ä¼šæ¶ˆå¤±ï¼Œå†æ¬¡ç‚¹å‡»è¡¨æ ¼çš„å¯¹åº”çš„é‚£è¡Œï¼Œå°†ä¼šå¼¹å‡ºä¸€ä¸ª MPMoviePlayerViewController,å¼€å§‹æ’­æ”¾éŸ³é¢‘.</p>

<h2>ç›‘è§†ä¸‹è½½è¿›åº¦</h2>

<p>å½“ç„¶ï¼Œç°åœ¨ä½ è¿˜æ²¡æœ‰ç›‘è§†ä¸‹è½½çš„è¿›åº¦æ¡ï¼Œä¸ºäº†æé«˜ç”¨æˆ·ä½“éªŒï¼Œä½ å°†è¦æ”¹å˜ä½ çš„Appå»ç›‘å¬ä¸‹è½½çš„è¿›åº¦åœ¨æ¯ä¸ªcellä¸­ã€‚</p>

<p>åœ¨SearchViewController.swiftæ–‡ä»¶ä¸­,æ‰¾åˆ° <code>NSURLSessionDownloadDelegate</code>çš„æ‰©å±•ï¼Œç„¶åæ·»åŠ å¦‚ä¸‹çš„ä»£ç†æ–¹æ³•:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func URLSession(session: NSURLSession, downloadTask: NSURLSessionDownloadTask, didWriteData bytesWritten: Int64, totalBytesWritten: Int64, totalBytesExpectedToWrite: Int64) {
</span><span class='line'> 
</span><span class='line'>    // 1
</span><span class='line'>    if let downloadUrl = downloadTask.originalRequest?.URL?.absoluteString,
</span><span class='line'>      download = activeDownloads[downloadUrl] {
</span><span class='line'>      // 2
</span><span class='line'>      download.progress = Float(totalBytesWritten)/Float(totalBytesExpectedToWrite)
</span><span class='line'>      // 3
</span><span class='line'>      let totalSize = NSByteCountFormatter.stringFromByteCount(totalBytesExpectedToWrite, countStyle: NSByteCountFormatterCountStyle.Binary)
</span><span class='line'>      // 4
</span><span class='line'>      if let trackIndex = trackIndexForDownloadTask(downloadTask), let trackCell = tableView.cellForRowAtIndexPath(NSIndexPath(forRow: trackIndex, inSection: 0)) as? TrackCell {
</span><span class='line'>        dispatch_async(dispatch_get_main_queue(), {
</span><span class='line'>          trackCell.progressView.progress = download.progress
</span><span class='line'>          trackCell.progressLabel.text =  String(format: "%.1f%% of %@",  download.progress * 100, totalSize)
</span><span class='line'>        })
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>é€šè¿‡è¿™ä¸ªä»£ç†æ–¹æ³•åšçš„å·¥ä½œå¦‚ä¸‹:</p>

<ol>
<li>ä½¿ç”¨æä¾›çš„ downloadTask æ‰¾åˆ°URLå±æ€§ï¼Œç„¶åä»å…¨å±€æ¿€æ´»çš„ä¸‹è½½å­—å…¸ä¸­æŸ¥æ‰¾ DownLoadå¯¹è±¡</li>
<li>è¿™ä¸ªæ–¹æ³•å°†ä¼šè¿”å›æ€»çš„å­—èŠ‚æ•°å’Œå·²ç»å†™å…¥çš„å­—èŠ‚æ•°ï¼Œä½ å¯ä»¥åˆ©ç”¨è¿™ä¸ªä¸¤ä¸ªå€¼ç®—å‡ºå½“å‰çš„ä¸‹è½½è¿›åº¦å¹¶ä¸”å®æ—¶æ›´æ–°è¿›åº¦æ¡ã€‚</li>
<li>NSByteCountFormatter å°†ä¼šæŠŠå­—èŠ‚æ•°è½¬åŒ–æˆäººç±»èƒ½å¤Ÿçœ‹æ‡‚çš„æ–‡ä»¶å¤§å°ï¼Œæœ‰å°†ä¼šä½¿ç”¨è¿™ä¸ªå­—ç¬¦ä¸²å»æ˜¾ç¤ºä¸‹è½½çš„æ–‡ä»¶å¤§å°å’Œç™¾åˆ†æ¯”</li>
<li>æœ€åï¼Œä½ å°†è¦å®šä½åˆ°è¿™ä¸ªCell,åœ¨ä¸»çº¿ç¨‹ä¸­æ›´æ–°è¿›åº¦æ¡å’Œæ˜¾ç¤ºçš„ç™¾åˆ†æ¯”</li>
</ol>


<p>ä¸‹ä¸€æ­¥ï¼Œä½ å°†è¦é…ç½®è¿™ä¸ªcellå±æ€§å»æ˜¾ç¤ºè¿›åº¦æ¡</p>

<p>æ‰¾åˆ°ä¸‹é¢çš„ä»£ç åœ¨ <code>tableView(_:cellForRowAtIndexPath:):</code>ä¸­</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let downloaded = localFileExistsForTrack(track)</span></code></pre></td></tr></table></div></figure>


<p>æ·»åŠ å¦‚ä¸‹ä»£ç åœ¨è¿™è¡Œçš„ä¸Šé¢:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var showDownloadControls = false
</span><span class='line'>if let download = activeDownloads[track.previewUrl!] {
</span><span class='line'>  showDownloadControls = true
</span><span class='line'> 
</span><span class='line'>  cell.progressView.progress = download.progress
</span><span class='line'>  cell.progressLabel.text = (download.isDownloading) ? "Downloading..." : "Paused"
</span><span class='line'>}
</span><span class='line'>cell.progressView.hidden = !showDownloadControls
</span><span class='line'>cell.progressLabel.hidden = !showDownloadControls</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†è·Ÿè¸ªæ­£åœ¨ä¸‹è½½çš„æ­Œæ›²ï¼Œä½ å°†è¦è®¾ç½® showDownloadControlsä¸ºtrue,å¦åˆ™ï¼Œä½ å°†è¦è®¾ç½®ä¸ºfalse.ä½ å°†è¦æ˜¾ç¤ºè¿™è¿›åº¦æ¡å’Œæ–‡å­—ã€‚</p>

<p>ä¸ºäº†æš‚åœä»»åŠ¡ï¼Œæ˜¾ç¤º"Paused"çŠ¶æ€ï¼Œå¦åˆ™ï¼Œæ˜¾ç¤º â€œDownloading&hellip;.â€
æœ€åï¼Œæ›¿æ¢è¿™è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cell.downloadButton.hidden = downloaded</span></code></pre></td></tr></table></div></figure>


<p>ä½¿ç”¨ä¸‹é¢è¿™è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cell.downloadButton.hidden = downloaded || showDownloadControls</span></code></pre></td></tr></table></div></figure>


<p>åˆ°è¿™ï¼Œä½ å¯ä»¥å‘Šè¯‰è¡¨æ ¼æ˜¯å¦éšè—ä¸‹è½½æŒ‰é’®ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼Œä½ å°†è¦çœ‹åˆ°ä¸€ä¸ªè¿›åº¦æ¡å’Œä¸‹è½½çš„è¿›åº¦ï¼Œä»¥åŠä¸‹è½½çš„ç™¾åˆ†æ¯”ã€‚
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/Screen-Shot-2015-08-17-at-11.02.03-pm-480x78.png" alt="logo" /></p>

<p>OK,ä½ åšåˆ°äº†!ğŸ˜€</p>

<h2>æš‚åœ æ¢å¤  å–æ¶ˆä¸‹è½½ä»»åŠ¡</h2>

<p>å‡å¦‚æˆ‘éœ€è¦æš‚åœä¸€ä¸ªä»»åŠ¡ï¼Œæˆ–è€…å–æ¶ˆä»»åŠ¡ï¼Ÿæ­¤æ—¶è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>

<p>åœ¨è¿™ä¸ªç« èŠ‚ï¼Œä½ å°†è¦å®ç°æš‚åœï¼Œæ¢å¤ï¼Œå–æ¶ˆä»»åŠ¡æ“ä½œã€‚</p>

<p>ä½ å°†è¦å¼€å§‹ç¼–å†™ä»£ç ï¼Œé€šè¿‡å…è®¸ç”¨æˆ·å»å–æ¶ˆä¸€ä¸ªæ­£åœ¨æ¿€æ´»çš„ä»»åŠ¡
æ›¿æ¢ <code>cancelDownload(_:)</code> ä½¿ç”¨ä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func cancelDownload(track: Track) {
</span><span class='line'>  if let urlString = track.previewUrl,
</span><span class='line'>    download = activeDownloads[urlString] {
</span><span class='line'>      download.downloadTask?.cancel()
</span><span class='line'>      activeDownloads[urlString] = nil
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†å–æ¶ˆä»»åŠ¡ï¼Œä½ å¯ä»¥ä»å…¨å±€æ¿€æ´»çš„å­—å…¸ä¸­å–å‡ºDownloadå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„ cancel() æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆå‘½ä»¤ï¼Œç„¶ååœ¨å…¨å±€å­—å…¸ä¸­ç§»é™¤å®ƒ</p>

<p>æš‚åœä»»åŠ¡å’Œå–æ¶ˆä»»åŠ¡éå¸¸ç±»ä¼¼ï¼Œä¸åŒç‚¹åœ¨äºå½“ä½ æš‚åœä¸€ä¸ªä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿæ¢å¤æ•°æ®ï¼Œå®ƒåŒ…å«äº†è¶³å¤Ÿå¤šçš„ä¿¡æ¯å»æ¢å¤ä¸‹è½½æ•°æ®ï¼Œå½“ç„¶åå°æœåŠ¡å™¨å¿…é¡»è¦æ”¯æŒè¿™ä¸ªç‰¹æ€§æ‰èƒ½å®Œå…¨å®ç°æ–­ç‚¹ä¸‹è½½åŠŸèƒ½.</p>

<blockquote><p><strong>æ³¨æ„</strong>
ä½ èƒ½æ¢å¤ä¸€ä¸ªä¸‹è½½ä»»åŠ¡åœ¨ä¸€å®šçš„æ§åˆ¶æ¡ä»¶ä¸‹ï¼Œä¾‹å¦‚ï¼Œä»ä½ ç¬¬ä¸€ä¸‹è¯·æ±‚ä¸‹è½½å¼€å§‹ï¼Œè¿™ä¸ªä¸‹è½½èµ„æºå°±ä¸èƒ½å†æ”¹å˜äº†ã€‚æƒ³è¦æ›´è¯¦ç»†çš„æ§åˆ¶æ¡ä»¶ï¼Œè¯·å‚è€ƒè‹¹æœçš„ <a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSessionDownloadTask_class/index.html#//apple_ref/occ/instm/NSURLSessionDownloadTask/cancelByProducingResumeData:">å®˜æ–¹æ–‡æ¡£</a></p></blockquote>

<p>ç°åœ¨ï¼Œæ›¿æ¢ <code>pauseDownload(_:)</code>ä½¿ç”¨ä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func pauseDownload(track: Track) {
</span><span class='line'>  if let urlString = track.previewUrl,
</span><span class='line'>    download = activeDownloads[urlString] {
</span><span class='line'>      if(download.isDownloading) {
</span><span class='line'>        download.downloadTask?.cancelByProducingResumeData { data in
</span><span class='line'>          if data != nil {
</span><span class='line'>            download.resumeData = data
</span><span class='line'>          }
</span><span class='line'>        }
</span><span class='line'>        download.isDownloading = false
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªå…³é”®å­—æ˜¯ä¸åŒçš„ cancelByProducingResumeData(_:) æ›¿ä»£äº† cancel(),ä½ æ£€ç´¢è¿™ä¸ªæ¢å¤çš„æ•°æ®ä»è¿™ä¸ªæ–¹æ³•cancelByProducingResumeDataæä¾›çš„å›è°ƒå‡½æ•°ä¸­ï¼Œå¹¶ä¸”æŠŠæ¢å¤çš„æ•°æ®ä¿å­˜åˆ°Downloadçš„resumeDataå±æ€§ä¸­ã€‚å¹¶ä¸”è®¾ç½®isDownloading=false</p>

<p>ä¸‹é¢æ›¿æ¢<code>resumeDownload(_:)</code>ç”¨ä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func resumeDownload(track: Track) {
</span><span class='line'>  if let urlString = track.previewUrl,
</span><span class='line'>    download = activeDownloads[urlString] {
</span><span class='line'>      if let resumeData = download.resumeData {
</span><span class='line'>        download.downloadTask = downloadsSession.downloadTaskWithResumeData(resumeData)
</span><span class='line'>        download.downloadTask!.resume()
</span><span class='line'>        download.isDownloading = true
</span><span class='line'>      } else if let url = NSURL(string: download.url) {
</span><span class='line'>        download.downloadTask = downloadsSession.downloadTaskWithURL(url)
</span><span class='line'>        download.downloadTask!.resume()
</span><span class='line'>        download.isDownloading = true
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å½“ç”¨æˆ·æ¢å¤ä¸€ä¸ªä¸‹è½½ä»»åŠ¡æ—¶ï¼Œä½ æ£€æŸ¥ä¸‹å½“å‰çš„Downloadå¯¹è±¡ æ¢å¤æ•°æ®çš„å±æ€§æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼ï¼Œä½ å°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‹è½½ä»»åŠ¡é€šè¿‡ <code>downloadTaskWithResumeData(_:)</code>å’Œä¸€ä¸ªæ¢å¤æ•°æ®çš„å‚æ•°ï¼Œå¯åŠ¨<code>resume()</code>æ¢å¤æ•°æ®çš„å‘½ä»¤;å¦‚æœè¿™ä¸ª æ¢å¤æ•°æ®çš„å±æ€§æ˜¯ç©ºçš„æˆ–è€…å…¶ä»–ä¸€äº›åŸå› ï¼Œä½ å°†è¦ç”¨URLåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‹è½½ä»»åŠ¡ï¼Œå¯åŠ¨å®ƒ.</p>

<p>åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œä½ è®¾ç½®è¿™ä¸ªisDownloadingä¸ºtrue,è¡¨æ˜ä»»åŠ¡æ­£åœ¨è¿›è¡Œ.</p>

<p>è¿˜æœ‰ä¸€ä»¶äº‹ä»¶è¦åšå°±æ˜¯è®¾ç½®è¿™ä¸‰ä¸ªå‡½æ•°çš„å·¥ä½œå±æ€§ï¼Œä½ éœ€è¦åœ¨cellä¸­æ˜¾ç¤º æˆ–è€…éšè— <code>æš‚åœ</code>ï¼Œ<code>å–æ¶ˆ</code>å’Œ<code>ç»§ç»­ä¸‹è½½</code>æŒ‰é’®ã€‚</p>

<p>æ‰¾åˆ° <code>tableView(_:cellForRowAtIndexPath:)</code>ç„¶åæ‰¾åˆ°ä¸‹é¢è¿™è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let download = activeDownloads[track.previewUrl!] {</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åæ·»åŠ ä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let title = (download.isDownloading) ? "Pause" : "Resume"
</span><span class='line'>cell.pauseButton.setTitle(title, forState: UIControlState.Normal)</span></code></pre></td></tr></table></div></figure>


<p>æš‚åœå’Œç»§ç»­ä¸‹è½½æŒ‰é’®å…±ç”¨ä¸€ä¸ªæŒ‰é’®ã€‚</p>

<p>ä¸‹ä¸€æ­¥ï¼Œæ·»åŠ ä¸‹é¢çš„ä»£ç åœ¨ <code>tableView(_:cellForRowAtIndexPath:)</code>ç»“å°¾:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cell.pauseButton.hidden = !showDownloadControls
</span><span class='line'>cell.cancelButton.hidden = !showDownloadControls</span></code></pre></td></tr></table></div></figure>


<p>å½“ä¸‹è½½ä»»åŠ¡æ¿€æ´»çš„æ—¶å€™ï¼Œè¿™é‡Œä»…ä»…æŠŠæŒ‰é’®æ˜¾ç¤ºå‡ºæ¥ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œä¸‹è½½å‡ ä¸ªæ­Œæ›²è¯•è¯•ï¼Œä½ å¯ä»¥æš‚åœï¼Œç»§ç»­ä¸‹è½½ï¼Œå–æ¶ˆ ä¸‹è½½ä»»åŠ¡ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Simulator-Screen-Shot-18-Aug-2015-10.14.38-pm-281x500.png" alt="logo" /></p>

<h2>æ”¯æŒåå°ä¸‹è½½</h2>

<p>ä½ çš„Appç°åœ¨çœ‹æ¥å·²ç»å¾ˆä¸é”™äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å¦æ”¯æŒåå°ä»»åŠ¡ä¸‹è½½:å½“ä½ çš„ç¨‹åºè¿›å…¥åå°æ¨¡å¼æˆ–è€…å› ä¸ºåˆ«çš„åŸå› æ„å¤–ç»ˆæ­¢äº†ï¼Œåå°ä»»åŠ¡æ˜¯å¦èƒ½ç»§ç»­ä¸‹è½½?</p>

<p>å‡å¦‚ä½ çš„Appä¸å†è¿è¡Œäº†ï¼Œé‚£å®ƒæ€ä¹ˆèƒ½ç»§ç»­å·¥ä½œå‘¢ï¼Ÿè¿™å„¿æœ‰ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹åœ¨Appè¿è¡Œä¹‹å¤–ï¼Œå»ç®¡ç†åå°ä»»åŠ¡ä¸‹è½½ï¼›å®ƒå‘é€ä¸€ä¸ªé€‚å½“çš„ä»£ç†æ–¹æ³•é€šçŸ¥ç»™appè®©å…¶ä»»åŠ¡ä¸‹è½½ç»§ç»­ï¼Œå½“è¿™ä¸ªappæ­£åœ¨ä¸‹è½½çš„æ—¶å€™çªç„¶é€€å‡ºï¼Œè¿™ä¸ªä»»åŠ¡å°†è¦ç»§ç»­ä¸‹è½½ã€‚</p>

<p>å½“ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œè¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹å°†è¦é‡æ–°åŠ è½½åœ¨åå°æ¨¡å¼ä¸­ï¼Œè¿™ä¸ªé‡æ–°åŠ è½½appå°†è¦é‡æ–°è¿æ¥è¿™åŒæ ·çš„session.æ”¶åˆ°ç›¸å…³çš„å®Œæˆçš„ä»£ç†æ¶ˆæ¯å¹¶ä¸”æ‰§è¡Œä¸€äº›è¦æ±‚çš„åŠ¨ä½œï¼Œæ¯”å¦‚æŒä¹…åŒ–ä¸‹è½½çš„æ–‡ä»¶åˆ°ç¡¬ç›˜ä¸Šç­‰ã€‚</p>

<blockquote><p><em>æ³¨æ„</em>
å¦‚æœä½ å¼ºåˆ¶é€€å‡ºappé€šè¿‡app switcheï¼Œè¿™ä¸ªç³»ç»Ÿå°†è¦å–æ¶ˆæ‰€æœ‰åå°ä¸‹è½½çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¸ä¼šå†è§†å›¾é‡å¯è¿™ä¸ªapp</p></blockquote>

<p>ä»ç„¶åœ¨SearchViewController.swiftè¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œåœ¨åˆå§‹åŒ– <code>downloadsSession</code>çš„åœ°æ–¹ï¼Œæ‰¾åˆ°ä¸‹é¢è¿™è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let configuration = NSURLSessionConfiguration.defaultSessionConfiguration()
</span></code></pre></td></tr></table></div></figure>


<p>æ›¿æ¢æˆä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let configuration = NSURLSessionConfiguration.backgroundSessionConfigurationWithIdentifier("bgSessionConfiguration")</span></code></pre></td></tr></table></div></figure>


<p>æ›¿æ¢é»˜è®¤çš„sessioné…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šä¸€ä¸ªç‰¹æ®Šçš„åå°sessioné…ç½®æ–‡ä»¶ï¼Œæ³¨æ„ä½ è®¾ç½®äº†å”¯ä¸€çš„IDä¸ºè¿™ä¸ªsession,è¿™ä¼šå…è®¸ä½ å¼•ç”¨å¹¶ä¸”é‡æ–°è¿æ¥åŒæ ·çš„åå°session.</p>

<p>ä¸‹ä¸€æ­¥ï¼Œåœ¨ viewDidLoad()ä¸­ï¼Œå¢åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_ = self.downloadsSession</span></code></pre></td></tr></table></div></figure>


<p>è°ƒç”¨æ‡’åŠ è½½å±æ€§<code>downloadsSession</code>,ç¡®ä¿åº”ç”¨ç¨‹åºç¡®å®åˆ›å»ºäº†ä¸€ä¸ªåå°session çš„SearchViewControllerçš„å®ä¾‹ã€‚</p>

<p>å½“ä¸€ä¸ªåå°ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œè¿™ä¸ªAppä¸å†è¿è¡Œï¼Œè¿™ä¸ªappå°†ä¼šé‡æ–°è¿è¡Œåˆ°åå°è¿›ç¨‹ä¸­ï¼Œä½ éœ€è¦å»å¤„ç†ä½ çš„appçš„ä¸€äº›ä»£ç†æ–¹æ³•.</p>

<p>åˆ‡æ¢åˆ° AppDelegate.swift,æ·»åŠ ä¸‹é¢çš„ä»£ç åœ¨ç±»çš„é¡¶éƒ¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var backgroundSessionCompletionHandler: (() -&gt; Void)?</span></code></pre></td></tr></table></div></figure>


<p>ä¸‹ä¸€æ­¥ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç åœ¨AppDelegate.swift:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func application(application: UIApplication, handleEventsForBackgroundURLSession identifier: String, completionHandler: () -&gt; Void) {
</span><span class='line'>  backgroundSessionCompletionHandler = completionHandler
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æä¾›ä¸€ä¸ªcompletionHandlerä½œä¸ºä¸€ä¸ªå˜é‡åœ¨ä½ çš„Appä»£ç†æ–¹æ³•ä¸­ï¼Œç­‰ä¼šä¼šç”¨åˆ°ã€‚</p>

<p>application(_:handleEventsForBackgroundURLSession:)ä¼šå”¤é†’è¿™ä¸ªAppå¤„ç†å®Œæˆè¿™ä¸ªåå°ä»»åŠ¡ï¼Œä½ éœ€è¦å»å¤„ç†ä¸¤ä¸ªäº‹æƒ…ï¼š</p>

<ul>
<li>é¦–å…ˆï¼Œé€šè¿‡ä»£ç†æ–¹æ³•ç”¨è¿™ä¸ªAppå»é‡æ–°è¿æ¥è¿™ä¸ªåå°session,ä¸€æ—¦ä½ åˆ›å»ºå¹¶ä¸”æ¯æ¬¡ä½¿ç”¨åå°sessionæ—¶ï¼ŒSearchViewControllerå°±ä¼šè¢«å®ä¾‹åŒ–ï¼Œä½ å·²ç»é‡æ–°è¿æ¥äº†.</li>
<li>ç¬¬äºŒï¼Œä½ éœ€è¦å»æ•è·å®Œæˆçš„å›è°ƒæ–¹æ³•ï¼Œåœ¨å®Œæˆçš„å›è°ƒå‡½æ•°ä¸­ï¼Œæ›´æ–°ä½ çš„UI,ç„¶åå‘Šè¯‰ç³»ç»Ÿä½ çš„Appå·²ç»å·¥ä½œå®Œæ¯•ä½¿ç”¨åå°ä»»åŠ¡çš„session.</li>
</ul>


<p>ä½†æ˜¯ä»€ä¹ˆæ—¶å€™ä½ å°†ä¼šè°ƒç”¨å®Œæˆçš„å›è°ƒå‡½æ•°å‘¢ï¼Ÿ
<code>URLSessionDidFinishEventsForBackgroundURLSession(_:)</code>å°†ä¼šæ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œå®ƒæ˜¯NSURLSessionDelegateçš„ä¸€ä¸ªä»£ç†æ–¹æ³•ï¼Œå½“æ‰€æœ‰çš„ä»»åŠ¡åœ¨åå°sessionä¸­å®Œæˆçš„æ—¶å€™ã€‚</p>

<p>å®ç°ä¸‹é¢çš„æ‰©å±•åœ¨<code>SearchViewController.swift</code>ä¸­</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>extension SearchViewController: NSURLSessionDelegate {
</span><span class='line'> 
</span><span class='line'>  func URLSessionDidFinishEventsForBackgroundURLSession(session: NSURLSession) {
</span><span class='line'>    if let appDelegate = UIApplication.sharedApplication().delegate as? AppDelegate {
</span><span class='line'>      if let completionHandler = appDelegate.backgroundSessionCompletionHandler {
</span><span class='line'>        appDelegate.backgroundSessionCompletionHandler = nil
</span><span class='line'>        dispatch_async(dispatch_get_main_queue(), {
</span><span class='line'>          completionHandler()
</span><span class='line'>        })
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä»£ç ä»…ä»…æŠ“å–äº†åœ¨APPDelegateä¸­å­˜å‚¨çš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”åœ¨ä¸»çº¿ä¸­è°ƒç”¨å®ƒ.</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œå¼€å§‹å‡ ä¸ªä¸‹è½½ä¹‹åè¿…é€ŸæŒ‰åœ¨homeé”®ï¼Œä½¿å¾—ä¸‹è½½ä»»åŠ¡è¿›å…¥åå°ï¼Œç­‰å‡ åç§’ä½ çš„ä¸‹è½½ä»»åŠ¡å°†ä¼šå®Œæˆï¼Œç„¶ååŒå‡»home,å…³é—­å½“å‰ç¨‹åºã€‚</p>

<p>ä¸‹è½½ä»»åŠ¡å°†ä¼šå®Œæˆå¹¶ä¸”ä»–ä»¬å°†ä¼šæ›´æ–°æ˜¾ç¤ºçŠ¶æ€ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Simulator-Screen-Shot-19-Aug-2015-1.06.24-am-281x500.png" alt="logo" /></p>

<p>OKï¼Œè¿™ä¸ªdemoå·²ç»å®Œå¤‡äº†ã€‚</p>

<h2>å®Œæ•´å·¥ç¨‹ä¸‹è½½</h2>

<p>ä½ å¯ä»¥ä¸‹è½½å®Œæ•´çš„å·¥ç¨‹ä» <a href="http://www.raywenderlich.com/wp-content/uploads/2016/01/HalfTunes-Final.zip">è¿™é‡Œ</a></p>

<p>æ›´å¤šèµ„æº</p>

<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSession_class/">è‹¹æœçš„å®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="https://github.com/Alamofire/Alamofire">AlamoFire</a>æ˜¯Swiftä¸­éå¸¸æµè¡Œçš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œå¯ä»¥å­¦ä¹ ä¸€ä¸‹.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[NSOperationQueueç®€å•ä»‹ç»]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/26/nsoperationqueuejian-dan-jie-shao/"/>
    <updated>2016-03-26T08:11:55+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/26/nsoperationqueuejian-dan-jie-shao</id>
    <content type="html"><![CDATA[<p>åœ¨iOSä¸­æœ‰ä¸¤ç§æ–¹å¼æ¥å®ç°å¤šçº¿ç¨‹:NSOperationå’ŒGCD.
å…¶ä¸­GCDæ˜¯åŸºäºCçš„åº•å±‚çš„API,è€ŒNSOperationåˆ™æ˜¯GCDå®ç°çš„Object-cçš„API,éšè®©NSOPerationæ˜¯åŸºäºGCDå®ç°çš„ï¼Œä½†æ˜¯å¹¶ä¸æ„å‘³ç€å®ƒæ˜¯ä¸€ä¸ªGCDçš„é‡å¤ç‰ˆæœ¬ï¼Œç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨NSOperationè½»æ˜“çš„å®ç°ä¸€äº›GCDè¦å†™å¤§é‡ä»£ç çš„äº‹æƒ…ï¼Œå› æ­¤ï¼ŒNSOperationæ˜¯è¢«æ¨èä½¿ç”¨çš„.</p>

<!--more-->


<h2>ä¸ºä»€ä¹ˆä¼˜å…ˆä½¿ç”¨NSOperationQuere,è€Œä¸æ˜¯GCD</h2>

<p>ä½ å¯èƒ½å†™è¿‡è¿™æ ·çš„ç½‘ç»œè¯·æ±‚çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dispatch_async(_Queue, ^{  
</span><span class='line'>    //è¯·æ±‚æ•°æ® 
</span><span class='line'>    NSData *data = [NSData dataWithContentURL:[NSURL URLWithString:@"http://domain.com/a.png"]]; 
</span><span class='line'>    dispatch_async(dispatch_get_main_queue(), ^{ 
</span><span class='line'>        [self refreshViews:data];
</span><span class='line'>     });
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ®µä»£ç æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºç‚¹ï¼Œå°±æ˜¯<em>è¿™ä¸ªä»»åŠ¡æ˜¯æ— æ³•å–æ¶ˆçš„</em></p>

<p><code>dataWithContentURL:</code>æ˜¯åŒæ­¥æ‹‰å–æ•°æ®ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡ä¸»çº¿ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰çš„æ•°æ®è¿”å›ä¹‹åï¼›è¿™ä¸ªæœŸé—´ï¼Œå¹¶å‘é˜Ÿåˆ—å°±éœ€è¦ä¸ºå…¶å®ƒä»»åŠ¡æ–°å»ºçº¿ç¨‹ï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™é—®é¢˜ã€‚å› æ­¤æˆ‘ä»¬ä¸æ¨èè¿™ç§å†™æ³•æ¥ä»ç½‘ç»œä¸Šæ‹‰å–æ•°æ®ã€‚</p>

<p>æ“ä½œé˜Ÿåˆ—æ˜¯æœ‰GCDæä¾›çš„ä¸€ä¸ªé˜Ÿåˆ—æ¨¡å‹çš„Cocoå¯¹è±¡ï¼ŒGCDæä¾›äº†æ›´åŠ åº•å±‚çš„æ§åˆ¶ï¼Œè€Œæ“ä½œé˜Ÿåˆ—åˆ™åœ¨GCDä¹‹ä¸Šå®ç°äº†æ›´åŠ æ–¹ä¾¿çš„åŠŸèƒ½ã€‚NSOperationç›¸å¯¹GCDæ¥è¯´æœ‰ä»¥ä¸‹ä¼˜ç‚¹:</p>

<ul>
<li>æä¾›äº†GCDä¸­ä¸é‚£ä¹ˆå®¹æ˜“å¤åˆ¶çš„æœ‰ç”¨ç‰¹æ€§</li>
<li>å¯ä»¥å¾ˆæ–¹ä¾¿çš„å–æ¶ˆä¸€ä¸ªNSOperationçš„æ‰§è¡Œ</li>
<li>å¯ä»¥å®¹æ˜“çš„æ·»åŠ ä»»åŠ¡çš„ä¾èµ–å…³ç³»</li>
<li>æä¾›äº†ä»»åŠ¡çš„çŠ¶æ€:isExecting,isFinished
*</li>
</ul>


<h2>NSOperationQueue</h2>

<p>NSOperationQueueå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹é˜Ÿåˆ—ï¼Œå¯ä»¥å§ <code>NSOperation</code>åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¯ä»¥å–æ¶ˆæˆ–è€…æ‰§è¡Œå®Œé˜Ÿåˆ—ä¸­æ‰€æœ‰çš„ <code>NSOperation</code>,æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>maxConcurrentOperationCount</code>å±æ€§æ¥æ§åˆ¶å¹¶å‘ä»»åŠ¡çš„æ•°é‡ï¼Œå½“è®¾ç½®ä¸º1æ—¶ï¼Œå°±æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚</p>

<h2>NSOperation</h2>

<p>å®ƒæ˜¯åˆ›å»ºçº¿ç¨‹çš„å¯¹è±¡ï¼Œç³»ç»Ÿå·²ç»é»˜è®¤æä¾›äº†<code>NSBlockOperaton</code>å’Œ<code>NSInvocationOperation</code>.ä½ ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„å­ç±»ï¼Œé€šè¿‡é‡å†™
<code>main</code>æˆ–è€…<code>start</code>æ–¹æ³•æ¥è‡ªå®šä¹‰nsoperation</p>

<p>ä½¿ç”¨<code>main</code>æ–¹æ³•éå¸¸ç®€å•ï¼Œä¸éœ€è¦ç®¡ç†ä¸€äº›çŠ¶æ€å±æ€§,å½“mainæ–¹æ³•è¿”å›çš„æ—¶å€™ï¼Œè¿™ä¸ªoperationå°±æ‰§è¡Œç»“æŸäº†ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨æ¥æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ã€‚</p>

<p>å¦‚æœä½ å¸Œæœ›æ‹¥æœ‰æ›´å¤šçš„æ§åˆ¶æƒï¼Œæˆ–è€…æƒ³åœ¨ä¸€ä¸ªæ“ä½œä¸­å¯ä»¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆé‡å†™<code>start</code>æ–¹æ³•ï¼Œä½†æ˜¯æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¿…é¡»æ‰‹åŠ¨çš„ç®¡ç†æ“ä½œçš„çŠ¶æ€ï¼Œåªæœ‰å‘é€isFinishedçš„KVOæ¶ˆæ¯æ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯operaitonç»“æŸã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>@implementation YourOperation
</span><span class='line'>- (void)start
</span><span class='line'>{
</span><span class='line'>    self.isExecuting = YES;
</span><span class='line'>    // ä»»åŠ¡ä»£ç  ...
</span><span class='line'>}
</span><span class='line'>- (void)finish //å¼‚æ­¥å›è°ƒ
</span><span class='line'>{
</span><span class='line'>    self.isExecuting = NO;
</span><span class='line'>    self.isFinished = YES;
</span><span class='line'>}
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<p><em>å½“å®ç°äº†<code>start</code>æ–¹æ³•æ—¶ï¼Œé»˜è®¤å°±ä¼šæ‰§è¡Œstartæ–¹æ³•ï¼Œè€Œä¸æ‰§è¡Œmainæ–¹æ³•</em>ï¼Œä¸ºäº†è®©æ“ä½œé˜Ÿåˆ—æ•è·åˆ°åšçš„æ”¹å˜ï¼Œéœ€è¦å°†çŠ¶æ€çš„å±æ€§é…åˆKVOçš„æ–¹å¼å®ç°ï¼Œå¦‚æœä½ ä¸ä½¿ç”¨å®ƒä»¬é»˜è®¤çš„setteæ¥è¿›è¡Œè®¾ç½®çš„è¯ï¼Œå°±éœ€è¦åœ¨åˆé€‚çš„æ—¶å€™æ‰‹åŠ¨å‘é€KVOæ¶ˆæ¯ã€‚</p>

<p>éœ€è¦æ‰‹åŠ¨ç®¡ç†çš„çŠ¶æ€æœ‰:</p>

<ol>
<li>isExecuting  ä»£è¡¨ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­</li>
<li>isFinished   ä»£è¡¨ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæˆ</li>
<li>isCanceled  ä»£è¡¨ä»»åŠ¡å·²ç»å–æ¶ˆ</li>
</ol>


<p>æ‰‹åŠ¨å‘é€KVoæ¶ˆæ¯ï¼Œé€šçŸ¥çŠ¶æ€:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[self willChangeValueForKey:@"isCancelled"];
</span><span class='line'>_isCancelled = YES;
</span><span class='line'>[self didChangeValueForKey:@"isCancelled"];</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†èƒ½ä½¿ç”¨é˜Ÿåˆ—æ‰€æä¾›çš„å–æ¶ˆåŠŸèƒ½ï¼Œä½ éœ€è¦åœ¨é•¿æ—¶é—´æ“ä½œä¸­ä¸æ—¶åœ°æ£€æŸ¥isCanceledå±æ€§ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªé•¿çš„å¾ªç¯ä¸­:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)main
</span><span class='line'>{
</span><span class='line'>    while (notDone && !self.isCancelled) {
</span><span class='line'>        // ä»»åŠ¡å¤„ç†
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<h2>ç®€å•ä½¿ç”¨</h2>

<p>NSOperaitonå’ŒNSOperationQueueå®ç°å¤šçº¿ç¨‹çš„æ­¥éª¤:</p>

<ol>
<li>å…ˆå°†éœ€è¦æ‰§è¡Œçš„æ“ä½œå°è£…åˆ°ä¸€ä¸ªNSOperationå¯¹è±¡ä¸­</li>
<li>ç„¶åå°†NSOperationå¯¹è±¡æ·»åŠ åˆ°NSOperationQueueä¸­</li>
<li>ç³»ç»Ÿä¼šè‡ªåŠ¨å°†NSOperationQueueä¸­çš„NSOperationå–å‡ºæ¥</li>
<li>å°†å–å‡ºçš„NSOperationå°è£…æ”¾åˆ°ä¸€æ¡æ–°çº¿ç¨‹ä¸­æ‰§è¡Œ</li>
</ol>


<p>NSOperationæ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œå¹¶ä¸å…·å¤‡å°è£…æ“ä½œçš„èƒ½åŠ›ï¼Œå¿…é¡»å®ç°å®ƒçš„å­ç±»ã€‚</p>

<h3>NSInvocationOperationå­ç±»</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//åˆ›å»ºæ“ä½œå¯¹è±¡ï¼Œå°è£…è¦æ‰§è¡Œçš„ä»»åŠ¡
</span><span class='line'>//NSInvocationOperation   å°è£…æ“ä½œ
</span><span class='line'>    NSInvocationOperation *operation=[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(test) object:nil];
</span><span class='line'>    
</span><span class='line'>    //æ‰§è¡Œæ“ä½œ
</span><span class='line'>    [operation start];</span></code></pre></td></tr></table></div></figure>


<p>ä¸€æ—¦æ‰§è¡Œæ“ä½œï¼Œå°±ä¼šè°ƒç”¨targetçš„testæ–¹æ³•</p>

<p>æ“ä½œå¯¹è±¡é»˜è®¤åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œåªæœ‰æ·»åŠ åˆ°åˆ—é˜Ÿä¸­æ‰ä¼šå¼€å¯æ–°çš„çº¿ç¨‹ï¼Œå³é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ“ä½œæ²¡æœ‰æ”¾åˆ°é˜Ÿåˆ—queueä¸­ï¼Œéƒ½æ˜¯åŒæ­¥æ‰§è¡Œï¼Œåªæœ‰å°†NSoperationæ”¾åˆ°ä¸€ä¸ªNSOperationQueueä¸­ï¼Œæ‰ä¼šå¼‚æ­¥æ‰§è¡Œ.</p>

<h2>NSBlockOoperaiton</h2>

<p>åˆ›å»ºå¯¹è±¡å’Œæ·»åŠ æ“ä½œ:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//åˆ›å»ºNSBlockOperationæ“ä½œå¯¹è±¡
</span><span class='line'>    NSBlockOperation *operation=[NSBlockOperation blockOperationWithBlock:^{
</span><span class='line'>        //......
</span><span class='line'>    }];
</span><span class='line'>    
</span><span class='line'>    //æ·»åŠ æ“ä½œ
</span><span class='line'>    [operation addExecutionBlock:^{
</span><span class='line'>        //....
</span><span class='line'>    }];</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//åˆ›å»ºNSBlockOperationæ“ä½œå¯¹è±¡
</span><span class='line'>     NSBlockOperation *operation=[NSBlockOperation blockOperationWithBlock:^{
</span><span class='line'>        NSLog(@"NSBlockOperation------%@",[NSThread currentThread]);
</span><span class='line'>     }];
</span><span class='line'>    
</span><span class='line'>     //æ·»åŠ æ“ä½œ
</span><span class='line'>     [operation addExecutionBlock:^{
</span><span class='line'>        NSLog(@"NSBlockOperation1------%@",[NSThread currentThread]);
</span><span class='line'>     }];
</span><span class='line'>     
</span><span class='line'>     [operation addExecutionBlock:^{
</span><span class='line'>         NSLog(@"NSBlockOperation2------%@",[NSThread currentThread]);
</span><span class='line'>     }];
</span><span class='line'>     
</span><span class='line'>     //å¼€å¯æ‰§è¡Œæ“ä½œ
</span><span class='line'>    [operation start];</span></code></pre></td></tr></table></div></figure>


<p>åªè¦NSBlockOperationå°è£…çš„æ“ä½œæ•°>1ï¼Œå°±ä¼šå¼‚æ­¥æ“ä½œã€‚</p>

<h2>NSOperationQueue</h2>

<p>NSOperationQueueå¯ä»¥è°ƒç”¨startæ–¹æ³•æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä½†é»˜è®¤æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚
å¦‚æœå°†NSOperationæ·»åŠ åˆ°NSOperationQueueä¸­ï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨å¼‚æ­¥æ‰§è¡ŒNSOPerationä¸­çš„æ“ä½œã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>#import "YYViewController.h"
</span><span class='line'>
</span><span class='line'>@interface YYViewController ()
</span><span class='line'>
</span><span class='line'>@end
</span><span class='line'>
</span><span class='line'>@implementation YYViewController
</span><span class='line'>
</span><span class='line'>- (void)viewDidLoad
</span><span class='line'>{
</span><span class='line'>    [super viewDidLoad];
</span><span class='line'>
</span><span class='line'>    //åˆ›å»ºNSInvocationOperationå¯¹è±¡ï¼Œå°è£…æ“ä½œ
</span><span class='line'>    NSInvocationOperation *operation1=[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(test1) object:nil];
</span><span class='line'>    NSInvocationOperation *operation2=[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(test2) object:nil];
</span><span class='line'>    //åˆ›å»ºå¯¹è±¡ï¼Œå°è£…æ“ä½œ
</span><span class='line'>    NSBlockOperation *operation3=[NSBlockOperation blockOperationWithBlock:^{
</span><span class='line'>        NSLog(@"NSBlockOperation3--1----%@",[NSThread currentThread]);
</span><span class='line'>    }];
</span><span class='line'>    [operation3 addExecutionBlock:^{
</span><span class='line'>        NSLog(@"NSBlockOperation3--2----%@",[NSThread currentThread]);
</span><span class='line'>    }];
</span><span class='line'>    
</span><span class='line'>    //åˆ›å»ºNSOperationQueue
</span><span class='line'>    NSOperationQueue * queue=[[NSOperationQueue alloc]init];
</span><span class='line'>    //æŠŠæ“ä½œæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
</span><span class='line'>    [queue addOperation:operation1];
</span><span class='line'>    [queue addOperation:operation2];
</span><span class='line'>    [queue addOperation:operation3];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>-(void)test1
</span><span class='line'>{
</span><span class='line'>    NSLog(@"NSInvocationOperation--test1--%@",[NSThread currentThread]);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>-(void)test2
</span><span class='line'>{
</span><span class='line'>    NSLog(@"NSInvocationOperation--test2--%@",[NSThread currentThread]);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<p>ç³»ç»Ÿè‡ªåŠ¨å°†NSOperationqueueä¸­çš„NSOPerationå¯¹è±¡å–å‡ºï¼Œå°†å…¶å°è£…çš„æ“ä½œæ”¾åˆ°ä¸€æ¡æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œ
ä¸Šé¢çš„ä»£ç ä¸€å…±æœ‰4ä¸ªä»»åŠ¡ï¼Œoperation1å’Œoperation2åˆ†åˆ«æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œoperation3æœ‰ä¸¤ä¸ªä»»åŠ¡ï¼Œä¸€å…±4ä¸ªä»»åŠ¡ï¼Œå¼€å¯äº†4æ¡çº¿ç¨‹ã€‚</p>

<p>è¿™äº›ä»»åŠ¡æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚</p>

<blockquote><p><strong>æç¤º</strong>
é˜Ÿåˆ—çš„å–å‡ºæ—¶æœ‰é¡ºåºçš„ï¼Œä¸æ‰“å°ç»“æœå¹¶ä¸çŸ›ç›¾ï¼Œè¿™å°±å¥½æ¯”èµ›è·‘ï¼Œèµ·è·‘çš„é¡ºåºæ˜¯A,B,Cï¼Œä½†æ˜¯åˆ°è¾¾ç»ˆç‚¹çš„é¡ºåºå°±ä¸ä¸€æ ·æ˜¯ A B  Cäº†ã€‚</p></blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Swift-æ³›å‹]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/24/swift-fan-xing/"/>
    <updated>2016-03-24T10:11:56+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/24/swift-fan-xing</id>
    <content type="html"><![CDATA[<p>æ³›å‹ä»£ç å¯ä»¥è®©ä½ ç¼–å†™ä½¿ç”¨è‡ªå®šä¹‰éœ€æ±‚ä»¥åŠä»»æ„ç±»å‹çš„çµæ´»å¯å†²ä¸­çš„å‡½æ•°å’Œç±»å‹ï¼Œå®ƒå¯ä»¥è®©ä½ é¿å…é‡å¤çš„ä»£ç ï¼Œç”¨ä¸€ç§æ¸…æ™°å’ŒæŠ½è±¡çš„æ–¹å¼æ¥è¡¨è¾¾ä»£ç çš„æ„å›¾ã€‚</p>

<!--more-->


<p>æ³›å‹æ˜¯swiftçš„å¼ºå¤§ç‰¹æ€§ä¹‹ä¸€ï¼Œè®¸å¤šswiftæ ‡å‡†åº“æ˜¯é€šè¿‡æ³›å‹ä»£ç æ„å»ºçš„ã€‚äº‹å®ä¸Šï¼Œæ³›å‹çš„ä½¿ç”¨è´¯ç©¿é¥¿äº†æ­£æœ¬è¯­è¨€æ‰‹å†Œï¼Œåªæ˜¯ä½ å¯èƒ½æ²¡æœ‰å‘ç°è€Œå·²ã€‚ä¾‹å¦‚,swiftçš„<code>Array</code>å’Œ<code>Dictionary</code>éƒ½æ˜¯æ³›å‹é›†åˆã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>Int</code>æ•°ç»„ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ª<code>String</code>æ•°ç»„ï¼Œç”šè‡³å¯ä»¥æ˜¯ä»»æ„å…¶å®ƒSwiftç±»å‹çš„æ•°ç»„ã€‚åŒæ ·çš„ï¼Œä½ ä¹Ÿå¯ä»¥åˆ›å»ºå­˜å‚¨ä»»æ„æŒ‡å®šç±»å‹çš„å­—å…¸ã€‚</p>

<h2>æ³›å‹æ‰€è§£å†³çš„é—®é¢˜</h2>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ ‡å‡†çš„éæ³›å‹å‡½æ•° <code>swapTwoInts(_:_:)</code>ï¼Œç”¨æ¥äº¤æ¢ä¸¤ä¸ª<code>Int</code>å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func swapTwoInts(inout a: Int, inout _ b: Int) {
</span><span class='line'>    let temporaryA = a
</span><span class='line'>    a = b
</span><span class='line'>    b = temporaryA
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªå‡½æ•°ä½¿ç”¨è¾“å…¥è¾“å‡ºå‡½æ•°(<code>inout</code>)æ¥äº¤æ¢<code>a</code>å’Œ<code>b</code>çš„å€¼ã€‚</p>

<p><code>swapTwoInts(_:_:)</code>å‡½æ•°äº¤æ¢<code>b</code>çš„åŸå§‹å€¼åˆ°<code>a</code>,å¹¶äº¤æ¢<code>a</code>çš„åŸå§‹å€¼åˆ°<code>b</code>,ä½ å¯ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°äº¤æ¢ä¸¤ä¸ª<code>Int</code>å˜é‡çš„å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var someInt = 3
</span><span class='line'>var anotherInt = 107
</span><span class='line'>swapTwoInts(&someInt, &anotherInt)
</span><span class='line'>print("someInt is now \(someInt), and anotherInt is now \(anotherInt)")
</span><span class='line'>// æ‰“å° â€œsomeInt is now 107, and anotherInt is now 3â€</span></code></pre></td></tr></table></div></figure>


<p>è¯šç„¶ï¼Œ<code>swapTwoInts(_:_:)</code>å‡½æ•°æŒºæœ‰ç”¨ï¼Œä½†æ˜¯å®ƒåªèƒ½äº¤æ¢<code>Int</code>å€¼ï¼Œå¦‚æœä½ æƒ³è¦äº¤æ¢ä¸¤ä¸ª<code>String</code>å€¼æˆ–è€…<code>Double</code>å€¼ï¼Œå°±ä¸èƒ½ä¸å†™æ›´å¤šçš„å‡½æ•°ï¼Œä¾‹å¦‚<code>swapTwoStrings(_:_:)</code>å’Œ<code>swapTwoDoubles(_:_:)</code>,å¦‚ä¸‹æ‰€ç¤º:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func swapTwoStrings(inout a: String, inout _ b: String) {
</span><span class='line'>    let temporaryA = a
</span><span class='line'>    a = b
</span><span class='line'>    b = temporaryA
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func swapTwoDoubles(inout a: Double, inout _ b: Double) {
</span><span class='line'>    let temporaryA = a
</span><span class='line'>    a = b
</span><span class='line'>    b = temporaryA
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä½ å¯èƒ½æ³¨æ„åˆ°<code>swapTwoInts(_:_:) å’Œ swapTwoDoubles(_:_:)</code>,çš„å‡½æ•°åŠŸèƒ½éƒ½æ˜¯ç›¸åŒçš„ï¼Œå”¯ä¸€ä¸åŒä¹‹å¤„å°±åœ¨äºä¼ å…¥çš„å˜é‡ç±»å‹ä¸åŒï¼Œåˆ†åˆ«æ˜¯ int,String,Double.</p>

<p>åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œé€šå¸¸éœ€è¦ä¸€ä¸ªæ›´å®ç”¨æ›´çµæ´»çš„å‡½æ•°æ¥äº¤æ¢ä¸¤ä¸ªä»»æ„ç±»å‹çš„å€¼ï¼Œå¹¸è¿çš„æ˜¯ï¼Œæ³›å‹ä»£ç å¸®ä½ è§£å†³äº†è¿™ç§é—®é¢˜ã€‚</p>

<blockquote><p><em>æ³¨æ„</em>
åœ¨ä¸Šé¢çš„ä¸‰ä¸ªå‡½æ•°ä¸­ï¼Œ<code>a</code>å’Œ<code>b</code>ç±»å‹ç›¸åŒï¼Œå¦‚æœ<code>a</code>å’Œ<code>b</code>ç±»å‹ä¸åŒï¼Œé‚£ä»–ä»¬ä¿©å°±ä¸èƒ½äº¤æ¢å€¼ã€‚Swiftæ˜¯ç±»å‹å®‰å…¨çš„è¯­è¨€ï¼Œæ‰€ä»¥ä¸ä¼šå…è®¸ä¸€ä¸ª<code>String</code>ç±»å‹çš„å˜é‡å’Œä¸€ä¸ª<code>Double</code>ç±»å‹çš„å˜é‡äº’æ¢å€¼ã€‚è§†å›¾è¿™æ ·åšå°†å¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚</p></blockquote>

<h2>æ³›å‹å‡½æ•°</h2>

<p>æ³›å‹å‡½æ•°å¯ä»¥é€‚ç”¨äºä»»ä½•ç±»å‹ï¼Œä¸‹é¢çš„<code>swapTwoValues(_:_:)</code>å‡½æ•°æ˜¯ä¸Šé¢ä¸‰ä¸ªå‡½æ•°çš„æ³›å‹ç‰ˆæœ¬:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func swapTwoValues&lt;T&gt;(inout a:T,inout _ b:T){
</span><span class='line'> let temporaryA=a;
</span><span class='line'> a=b;
</span><span class='line'> b= temporaryA;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>swapTwoValues(_:_:)</code>çš„å‡½æ•°ä¸»ä½“å’Œ<code>swapTwoInts(_:_:)</code>å‡½æ•°æ˜¯ä¸€æ ·çš„ã€‚ä»–ä»¬åªåœ¨ç¬¬ä¸€è¡Œæœ‰æ‰€ä¸åŒï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func swapTwoInts(inout a: Int, inout _ b: Int)
</span><span class='line'>func swapTwoValues&lt;T&gt;(inout a: T, inout _ b: T)</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªå‡½æ•°çš„æ³›å‹ç‰ˆæœ¬ä½¿ç”¨äº†å ä½ç±»å‹å(åœ¨è¿™é‡Œç”¨å­—æ¯<code>T</code>æ¥è¡¨ç¤º)æ¥ä»£æ›¿å®é™…çš„ç±»å‹å(ä¾‹å¦‚<code>Int</code>,<code>String</code>æˆ–è€…<code>Double</code>).å ä½ç±»å‹åæ²¡æœ‰æŒ‡æ˜<code>T</code>å¿…é¡»æ˜¯ä»€ä¹ˆç±»å‹ï¼Œä½†æ˜¯å®ƒæŒ‡æ˜äº†<code>a</code>å’Œ<code>b</code>å¿…é¡»æ˜¯åŒä¸€ç±»å‹<code>T</code>,è€Œä¸è®º<code>T</code>ä»£è¡¨ä»€ä¹ˆç±»å‹ï¼Œåªæœ‰<code>swapTwoValues(_:_:)</code>å‡½æ•°åœ¨è°ƒç”¨æ—¶ï¼Œæ‰èƒ½æ ¹æ®æ‰€ä¼ å…¥çš„å®é™…ç±»å‹å†³å®š<code>T</code>æ‰€ä»£è¡¨çš„ç±»å‹ã€‚</p>

<p>å¦å¤–ä¸€ä¸ªä¸åŒä¹‹å¤„åœ¨äºè¿™ä¸ªæ³›å‹å‡½æ•°ååé¢è·Ÿç€å ä½ç±»å‹å(T),è€Œä¸”ä½¿ç”¨å°–æ‹¬å·æ‹¬èµ·æ¥çš„(<code>&lt;T&gt;</code>).è¿™ä¸ªå°–æ‹¬å·å‘Šè¯‰Swifté‚£ä¸ª<code>T</code>æ˜¯<code>swapTwoValues(_:_:)</code>å‡½æ•°å®šä¹‰çš„ä¸€ä¸ªå ä½ç±»å‹åï¼Œå› æ­¤swiftä¸ä¼šå»æŸ¥æ‰¾åä¸º<code>T</code>çš„å®é™…ç±»å‹ã€‚</p>

<p>swapTwoValues(<em>:</em>:) å‡½æ•°ç°åœ¨å¯ä»¥åƒ swapTwoInts(<em>:</em>:) é‚£æ ·è°ƒç”¨ï¼Œå¯ä»¥ä¼ å…¥ä»»æ„ç±»å‹çš„å€¼ï¼Œåªè¦ä¸¤ä¸ªå€¼çš„ç±»å‹ç›¸åŒã€‚<code>swapTwoValues(_:_:)</code>å‡½æ•°è°ƒç”¨æ—¶ï¼Œ<code>T</code>æ‰€ä»£è¡¨çš„ç±»å‹éƒ½ä¼šç”±ä¼ å…¥çš„å€¼çš„ç±»å‹åˆ¤æ–­å‡ºæ¥.</p>

<p>åœ¨ä¸‹é¢çš„ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œ<code>T</code>åˆ†åˆ«ä»£è¡¨<code>Int</code>å’Œ<code>String</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var someInt = 3
</span><span class='line'>var anotherInt = 107
</span><span class='line'>swapTwoValues(&someInt, &anotherInt)
</span><span class='line'>// someInt is now 107, and anotherInt is now 3
</span><span class='line'>
</span><span class='line'>var someString = "hello"
</span><span class='line'>var anotherString = "world"
</span><span class='line'>swapTwoValues(&someString, &anotherString)
</span><span class='line'>// someString is now "world", and anotherString is now "hello"</span></code></pre></td></tr></table></div></figure>


<h2>ç±»å‹å‚æ•°</h2>

<p>åœ¨ä¸Šé¢çš„<code>swapTwoValues(_:_:)</code>ä¾‹å­ä¸­ï¼Œå ä½ç±»å‹<code>T</code>æ˜¯ç±»å‹å‚æ•°çš„ä¸€ä¸ªä¾‹å­ã€‚ç±»å‹å‚æ•°æŒ‡å®šå¹¶å‘½åä¸€ä¸ªå ä½ç±»å‹ï¼Œå¹¶ä¸”ç´§éšåœ¨å‡½æ•°ååé¢ï¼Œä½¿ç”¨ä¸€å¯¹å°–æ‹¬å·æ‹¬èµ·æ¥(<T>).</p>

<p>ä¸€æ—¦ä¸€ä¸ªç±»å‹å‚æ•°è¢«æŒ‡å®šï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥å®šä¹‰ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ç±»å‹ï¼Œæˆ–è€…ä½œä¸ºå‡½æ•°çš„è¿”å›ç±»å‹ï¼Œè¿˜å¯ä»¥ç”¨ä½œå‡½æ•°ä¸»é¢˜ä¸­çš„æ³¨é‡Šç±»å‹ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œç±»å‹å‚æ•°åœ¨å‡½æ•°è°ƒç”¨æ—¶è¢«å®é™…ç±»å‹æ‰€ä»£æ›¿ã€‚</p>

<h2>å‘½åç±»å‹å‚æ•°</h2>

<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç±»å‹å‚æ•°å…·æœ‰ä¸€ä¸ªæè¿°æ€§åå­—ï¼Œä¾‹å¦‚<code>Dictionary&lt;Key,Value&gt;</code>ä¸­çš„keyå’Œvalue,ä»¥åŠ<code>Array&lt;Element&gt;</code>ä¸­çš„<code>Element</code>ï¼Œè¿™å¯ä»¥å‘Šè¯‰é˜…è¯»ä»£ç çš„äººè¿™äº›ç±»å‹å‚æ•°å’Œæ³›å‹å‡½æ•°ä¹‹é—´çš„å…³ç³»ã€‚ç„¶è€Œï¼Œå½“ä»–ä»¬ä¹‹é—´çš„å…³ç³»æ²¡æœ‰æ„ä¹‰æ—¶ï¼Œé€šå¸¸ä½¿ç”¨å•ä¸€çš„å­—æ¯æ¥å‘½åï¼Œä¾‹å¦‚<code>T</code>,<code>U</code>,<code>V</code>ï¼Œæ­£å¦‚ä¸Šé¢æ¼”ç¤ºçš„<code>swapTwoValues(_:_:)</code>å‡½æ•°ä¸­çš„<code>T</code>ä¸€æ ·.</p>

<h2>æ³›å‹ç±»å‹</h2>

<p>é™¤äº†æ³›å‹å‡½æ•°ï¼ŒSwiftè¿˜å…è®¸ä½ å®šä¹‰æ³›å‹ç±»å‹ã€‚è¿™äº›è‡ªå®šä¹‰ç±»ï¼Œç»“æ„ä½“å’Œæšä¸¾å¯ä»¥é€‚ç”¨äºä»»ä½•ç±»å‹ï¼Œå¦‚åŒ<code>Array</code>å’Œ<code>Dictionary</code>çš„ç”¨æ³•ã€‚</p>

<p>è¿™éƒ¨åˆ†å†…å®¹å°†å‘ä½ å±•ç¤ºå¦‚ä½•ç¼–å†™ä¸€ä¸ªåä¸º<code>stack</code>ï¼ˆæ ˆï¼‰çš„æ³›å‹é›†åˆç±»å‹ã€‚æ ˆæ˜¯ä¸€ç³»åˆ—å€¼çš„æœ‰åºé›†åˆï¼Œå¦‚<code>Array</code>ç±»å‹ï¼Œä½†å®ƒæ¯”Swiftçš„arrayç±»å‹æœ‰æ›´å¤šçš„æ“ä½œé™åˆ¶ã€‚æ•°ç»„å…è®¸å¯¹å…¶ä¸­ä»»æ„ä½ç½®çš„å…ƒç´ æ‰§è¡Œæ’å…¥æˆ–åˆ é™¤æ“ä½œã€‚è€Œæ ˆï¼Œåªå…è®¸åœ¨é›†åˆçš„æœ«ç«¯æ·»åŠ æ–°çš„å…ƒç´ ï¼Œç§°ä¸ºå…¥æ ˆã€‚åŒæ ·æ»´ï¼Œæ ˆä¹Ÿåªèƒ½ä»æœ«ç«¯ç§»é™¤å…ƒç´ ã€‚</p>

<p>ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªå¦‚ä½•ç¼–å†™ä¸€ä¸ªéæ³›å‹ç‰ˆæœ¬çš„æ ˆï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯<code>Int</code>å‹çš„æ ˆ.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct IntStack {
</span><span class='line'>    var items=[Int]()
</span><span class='line'>    
</span><span class='line'>    mutating func push(item:Int){
</span><span class='line'>        items.append(item);
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    mutating func pop()-&gt;Int{
</span><span class='line'>        return items.removeLast();
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªç»“æ„ä½“åœ¨æ ˆä¸­ä½¿ç”¨ä¸€ä¸ªåä¸º<code>items</code>çš„<code>array</code>å±æ€§æ¥å­˜å‚¨å€¼ã€‚<code>Stack</code>æä¾›äº†ä¸¤ä¸ªæ–¹æ³•:<code>push(_:)</code>å’Œ<code>pop()</code>ï¼Œç”¨æ¥å‘æ ˆä¸­å‹å…¥å€¼ä»¥åŠä»æ ˆä¸­ç§»é™¤å€¼ã€‚è¿™äº›æ–¹æ³•è¢«æ ‡è®°ä¸º<code>mutating</code>ï¼Œå› ä¸ºä»–ä»¬éœ€è¦ä¿®æ”¹ç»“æ„ä½“çš„<code>items</code>æ•°ç»„ã€‚</p>

<p>ä¸Šé¢çš„<code>IntStack</code>ç»“æ„ä½“åªèƒ½ç”¨äºIntç±»å‹ï¼Œä¸è¿‡å¯ä»¥å®šä¹‰ä¸€ä¸ªæ³›å‹çš„<code>Stack</code>ç»“æ„ä½“ï¼Œä»è€Œèƒ½å¤Ÿå¤„ç†ä»»æ„ç±»å‹çš„å€¼ã€‚</p>

<p>ä¸‹é¢æ˜¯ç›¸åŒä»£ç çš„æ³›å‹ç‰ˆæœ¬:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct Stack&lt;Element&gt; {
</span><span class='line'>    var items=[Element]();
</span><span class='line'>    
</span><span class='line'>    mutating func push(item:Element){
</span><span class='line'>        items.append(item);
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    mutating func pop()-&gt;Element{
</span><span class='line'>        return items.removeLast();
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æ³¨æ„ï¼Œ<code>Stack</code>åŸºæœ¬ä¸Šå’Œ<code>IntStack</code>ç›¸åŒï¼Œåªæ˜¯å ä½ç±»å‹å‚æ•°<code>Element</code>ä»£æ›¿äº†å®é™…çš„<code>Int</code>ç±»å‹ã€‚è¿™ç§ç±»å‹å‚æ•°åŒ…è£¹åœ¨ä¸€å¯¹å°–æ‹¬å·é‡Œ(<code>&lt;Element&gt;</code>)ï¼Œç´§è·Ÿåœ¨ç»“æ„ä½“ååé¢ã€</p>

<p><code>Element</code>ä¸ºå°šæœªæä¾›çš„ç±»å‹å®šä¹‰äº†ä¸€ä¸ªå ä½åã€‚è¿™ç§å°šæœªæä¾›çš„ç±»å‹å¯ä»¥åœ¨ç»“æ„ä½“å®šä¹‰ä¸­é€šè¿‡<code>Element</code>æ¥å¼•ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>Element</code>åœ¨å¦‚ä¸‹ä¸‰ä¸ªåœ°æ–¹è¢«ç”¨ä½œå ä½ç¬¦:</p>

<ul>
<li>åˆ›å»º items å±æ€§ï¼Œä½¿ç”¨<code>Element</code>ç±»å‹çš„ç©ºæ•°ç»„è¿›è¡Œåˆå§‹åŒ–</li>
<li>æ‰§è¡Œ<code>psh(_:)</code>æ–¹æ³•çš„å•ä¸€å‚æ•°<code>item</code>çš„ç±»å‹å¿…é¡»æ˜¯<code>Element</code>ç±»å‹</li>
<li>æŒ‡å®š<code>pop()</code>æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å¿…é¡»æ˜¯<code>Element</code>ç±»å‹.</li>
</ul>


<p>ç”±äº<code>stack</code>æ˜¯æ³›å‹ç±»å‹ï¼Œå› æ­¤å¯ä»¥ç”¨æ¥åˆ›å»ºSwiftä¸­ä»»æ„æœ‰æ•ˆç±»å‹çš„æ ˆï¼Œå¦‚åŒ<code>Array</code>å’Œ<code>Dictionary</code>.</p>

<p>ä½ å¯ä»¥é€šè¿‡åœ¨å°–æ‹¬å·ä¸­å†™å‡ºæ ˆä¸­éœ€è¦å­˜å‚¨çš„æ•°æ®ç±»å‹æ¥åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª<code>Stack</code>å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œè¦åˆ›å»ºä¸€ä¸ª<code>String</code>ç±»å‹çš„æ ˆï¼Œå¯ä»¥å†™æˆ<code>Stack&lt;String&gt;</code>ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var stackOfStrings = Stack&lt;String&gt;()
</span><span class='line'>stackOfStrings.push("uno")
</span><span class='line'>stackOfStrings.push("dos")
</span><span class='line'>stackOfStrings.push("tres")
</span><span class='line'>stackOfStrings.push("cuatro")
</span><span class='line'>// æ ˆä¸­ç°åœ¨æœ‰ 4 ä¸ªå­—ç¬¦ä¸²</span></code></pre></td></tr></table></div></figure>


<p>ç§»é™¤å¹¶è¿”å›æ ˆé¡¶éƒ¨çš„å€¼</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let fromTheTop = stackOfStrings.pop()
</span><span class='line'>// fromTheTop çš„å€¼ä¸º "cuatro"ï¼Œç°åœ¨æ ˆä¸­è¿˜æœ‰ 3 ä¸ªå­—ç¬¦ä¸²</span></code></pre></td></tr></table></div></figure>


<h2>æ‰©å±•ä¸€ä¸ªæ³›å‹ç±»å‹</h2>

<p>å½“ä½ æ‰©å±•ä¸€ä¸ªæ³›å‹ç±»å‹çš„æ—¶å€™ï¼Œä½ å¹¶ä¸éœ€è¦åœ¨æ‰©å±•çš„å®šä¹‰ä¸­æä¾›ç±»å‹çš„å‚æ•°åˆ—è¡¨ã€‚æ›´åŠ æ–¹ä¾¿çš„æ˜¯ï¼ŒåŸå§‹ç±»å‹å®šä¹‰ä¸­å£°æ˜çš„ç±»å‹å‚æ•°åˆ—è¡¨åœ¨æ‰©å±•ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå¹¶ä¸”è¿™äº›æ¥è‡ªåŸå§‹ç±»å‹ä¸­çš„å‚æ•°åç§°ä¼šè¢«ç”¨ä½œåŸå§‹å®šä¹‰ä¸­ç±»å‹å‚æ•°çš„å¼•ç”¨ã€‚</p>

<p>ä¸‹é¢çš„ä¾‹å­æ‰©å±•äº†æ³›å‹ç±»å‹<code>Stack</code>ï¼Œä¸ºå…¶æ·»åŠ äº†ä¸€ä¸ªåä¸º<code>topItem</code>çš„åªè¯»è®¡ç®—å‹å±æ€§ï¼Œå®ƒå°†ä¼šè¿”å›å½“å‰æ ˆé¡¶ç«¯çš„å…ƒç´ è€Œä¸ä¼šå°†å…¶ä»æ ˆä¸­ç§»é™¤:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>extension Stack{
</span><span class='line'>    var topItem:Element?{
</span><span class='line'>        return items.isEmpty ? nil:items[items.count];
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>topItem</code>å±æ€§ä¼šè¿”å›ä¸€ä¸ª<code>Element</code>ç±»å‹çš„å¯é€‰å€¼ã€‚å½“æ ˆä¸ºç©ºçš„æ—¶å€™ï¼Œ<code>topItem</code>ä¼šè¿”å›<code>nil</code>;å½“æ ˆä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œ<code>topItem</code>ä¼šè¿”å›<code>nil</code>;å½“æ ˆä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œ<code>topItem</code>ä¼šè¿”å›<code>items</code>æ•°ç»„ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ .</p>

<p>æ³¨æ„ï¼Œè¿™ä¸ªæ‰©å±•å¹¶æ²¡æœ‰å®šä¹‰ä¸€ä¸ªç±»å‹å‚æ•°åˆ—è¡¨ã€‚ç›¸ååœ°ï¼Œ<code>Stack</code>ç±»å‹å·²æœ‰çš„ç±»å‹å‚æ•°å<code>Element</code>ï¼Œè¢«ç”¨åœ¨æ‰©å±•ä¸­è¡¨ç¤ºè®¡ç®—å‹å±æ€§<code>topItem</code>çš„å¯é€‰ç±»å‹ï¼Œ<code>topItem</code>ç°åœ¨å¯ä»¥ç”¨æ¥è®¿é—®ä»»æ„<code>Stack</code>å®ä¾‹çš„é¡¶ç«¯å…ƒç´ è€Œä¸æ˜¯ç§»é™¤å®ƒ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let topItem = stackOfStrings.topItem {
</span><span class='line'>    print("The top item on the stack is \(topItem).")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œThe top item on the stack is tres.â€</span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>ç±»å‹çº¦æŸ</h2>

<p><code>swapTwoValues(_:_:)</code>å‡½æ•°å’Œ<code>Stack</code>ç±»å‹å¯ä»¥ä½œç”¨äºä»»ä½•ç±»å‹ã€‚ä¸è¿‡ï¼Œæœ‰çš„æ—¶å€™å¦‚æœèƒ½å°†ä½¿ç”¨åœ¨æ³›å‹å‡½æ•°å’Œæ³›å‹ç±»å‹ä¸­çš„ç±»å‹ï¼Œå¼ºåˆ¶çº¦æŸä¸ºæŸç§ç‰¹å®šç±»å‹ï¼Œå°†ä¼šæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ç±»å‹çº¦æŸå¯ä»¥æŒ‡å®šä¸€ä¸ªç±»å‹å‚æ•°å¿…é¡»é›†æˆè‡ªç‰¹å®šç±»ï¼Œæˆ–è€…ç¬¦åˆä¸€ä¸ªç‰¹å®šçš„åè®®æˆ–è€…åè®®ç»„åˆã€‚</p>

<p>ä¾‹å¦‚,Swiftçš„<code>Dictionary</code>ç±»å‹å¯¹å­—å…¸çš„é”®çš„ç±»å‹åšäº†é™åˆ¶ï¼Œåœ¨å­—å…¸çš„æè¿°ä¸­ï¼Œå­—å…¸çš„é”®å¿…é¡»æ˜¯å¯å“ˆå¸Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»æœ‰ä¸€ç§æ–¹æ³•èƒ½ä½œä¸ºå…¶å”¯ä¸€çš„è¡¨ç¤ºã€‚<code>Dictionary</code>ä¹‹æ‰€ä»¥éœ€è¦å…¶é”®æ˜¯å¯å“ˆå¸Œçš„ï¼Œæ˜¯ä¸ºäº†ä¾¿äºæ£€æŸ¥å­—å…¸æ˜¯å¦å·²ç»åŒ…å«äº†æŸä¸ªç‰¹å®šé”®çš„å€¼ã€‚å¦‚æ— æ­¤è¦æ±‚ï¼ŒDictionaryå°†æ— æ³•åˆ¤æ–­æ˜¯å¦å¯ä»¥æ’å…¥æˆ–è€…æ›¿æ¢æŸä¸ªæŒ‡å®šé”®çš„å€¼ï¼Œä¹Ÿä¸èƒ½æŸ¥æ‰¾åˆ°å·²ç»å­˜å‚¨åœ¨å­—å…¸ä¸­æŒ‡å®šé”®çš„å€¼ã€‚</p>

<p>è¿™ä¸ªè¦æ±‚å¼ºåˆ¶åŠ ä¸Šäº†ä¸€ä¸ªç±»å‹çº¦æŸä½œç”¨åŸŸ<code>Dictionary</code>çš„é”®ç±»å‹ä¸Šï¼Œå…¶é”®ç±»å‹å¿…é¡»ç¬¦åˆ<code>Hashable</code>åè®®ï¼Œè¿™æ˜¯swiftæ ‡å‡†åº“ä¸­å®šä¹‰çš„ä¸€ä¸ªç‰¹å®šåè®®ã€‚æ‰€æœ‰çš„swfitåŸºæœ¬ç±»å‹(String,Int,Double)é»˜è®¤éƒ½æ˜¯å¯å“ˆå¸Œçš„ã€‚</p>

<p>å½“ä½ åˆ›å»ºè‡ªå®šä¹‰åçœç±»å‹æ—¶ï¼Œä½ å¯ä»¥å®šä¹‰ä½ è‡ªå·±çš„ç±»å‹çº¦æŸï¼Œè¿™äº›çº¦æŸå°†æä¾›æ›´ä¸ºå¼ºå¤§çš„æ³›å‹ç¼–ç¨‹èƒ½åŠ›ã€‚æŠ½è±¡æ¦‚å¿µï¼Œä¾‹å¦‚å¯å“ˆå¸Œçš„ã€‚</p>

<h2>ç±»å‹çº¦æŸè¯­æ³•</h2>

<p>ä½ å¯ä»¥åœ¨ä¸€ä¸ªç±»å‹å‚æ•°ååé¢æ”¾ç½®ä¸€ä¸ªç±»åæˆ–è€…åè®®åï¼Œé€šè¿‡å†’å·åˆ†å‰²ï¼Œä»è€Œå®šä¹‰ç±»å‹çº¦æŸï¼Œå®ƒä»¬å°†ä½œä¸ºç±»å‹å‚æ•°åˆ—è¡¨çš„ä¸€éƒ¨åˆ†ã€‚è¿™ç§åŸºæœ¬çš„ç±»å‹çº¦æŸä½œç”¨äºæ³›å‹å‡½æ•°æ—¶çš„è¯­æ³•å¦‚ä¸‹ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func someFunction&lt;T: SomeClass, U: SomeProtocol&gt;(someT: T, someU: U) {
</span><span class='line'>    // è¿™é‡Œæ˜¯æ³›å‹å‡½æ•°çš„å‡½æ•°ä½“éƒ¨åˆ†
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªç±»å‹å‚æ•°ã€‚ç¬¬ä¸€ä¸ªç±»å‹æ˜¯å‚æ•°<code>T</code>,æœ‰ä¸€ä¸ªè¦æ±‚<code>T</code>å¿…é¡»æ˜¯<code>SomeClass</code>è‡ªé›·çš„ç±»å‹çº¦æŸï¼›ç¬¬äºŒä¸ªç±»å‹å‚æ•°<code>U</code>,æœ‰ä¸€ä¸ªè¦æ±‚<code>U</code>å¿…é¡»ç¬¦åˆ<code>someProtocol</code>åè®®çš„ç±»å‹çº¦æŸ.</p>

<h2>ç±»å‹çº¦æŸå®è·µ</h2>

<p>è¿™é‡Œæœ‰ä¸ªåä¸º<code>findStringIndex</code>çš„éæ³›å‹å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½åœ¨<code>String</code>å€¼çš„æ•°ç»„ä¸­æŸ¥æ‰¾æŒ‡å®š<code>String</code>å€¼çš„ç´¢å¼•ã€‚å¼±æŸ¥æ‰¾åˆ°åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œ<code>findStringIndex(_:_:)</code>å‡½æ•°è¿”å›è¯¥å­—ç¬¦ä¸²åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•å€¼ï¼Œåä¹‹åˆ™è¿”å›<code>nil</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func findStringIndex(array: [String], _ valueToFind: String) -&gt; Int? {
</span><span class='line'>    for (index, value) in array.enumerate() {
</span><span class='line'>        if value == valueToFind {
</span><span class='line'>            return index
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    return nil
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¯¥å‡½æ•°å¯ä»¥ç”¨äºæŸ¥æ‰¾å­—ç¬¦ä¸²æ•°ç»„ä¸­çš„æŸä¸ªå­—ç¬¦ä¸²:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let strings = ["cat", "dog", "llama", "parakeet", "terrapin"]
</span><span class='line'>if let foundIndex = findStringIndex(strings, "llama") {
</span><span class='line'>    print("The index of llama is \(foundIndex)")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œThe index of llama is 2â€</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœåªèƒ½æŸ¥æ‰¾å­—ç¬¦ä¸²åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œç”¨å¤„ä¸æ˜¯å¾ˆå¤§ï¼Œä¸è¿‡ï¼Œä½ å¯ä»¥å†™å‡ºç›¸åŒåŠŸèƒ½çš„æ³›å‹å‡½æ•°<code>findIndex(_:_:)</code>,ç”¨å ä½ç±»å‹<code>T</code>ä»£æ›¿<code>String</code>ç±»å‹ã€‚</p>

<p>ä¸‹é¢å±•ç¤ºäº†<code>findStringIndex(_:_:)</code>å‡½æ•°çš„æ³›å‹ç‰ˆæœ¬<code>findIndex(_:_:)</code>.è¯·æ³¨æ„è¿™ä¸ªå‡½æ•°ä»ç„¶è¿”å›<code>Int?</code>ï¼Œé‚£æ˜¯å› ä¸ºå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå¯é€‰çš„ç´¢å¼•æ•°ï¼Œè€Œä¸æ˜¯ä»æ•°ç»„ä¸­å¾—åˆ°ä¸€ä¸ªå¯é€‰å€¼ã€‚éœ€è¦æé†’çš„æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°æ— æ³•é€šè¿‡ç¼–è¯‘ï¼ŒåŸå› ä¾‹å­åé¢è¯´æ˜:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>func findIndex&lt;T&gt;(array:[T], valueToField:T)-&gt;Int?{
</span><span class='line'>    for (index, value)in array.enumerate(){
</span><span class='line'>        if value == valueToField{
</span><span class='line'>            return index;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    return nil;
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢æ‰€å†™çš„å‡½æ•°æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚è¿™ä¸ªé—®é¢˜å‡ºåœ¨ç›¸ç­‰æ€§æ£€æŸ¥ä¸Šï¼Œå³<code>if vlaue == valueToField</code>ã€‚ä¸æ˜¯æ‰€æœ‰çš„Swiftç±»å‹éƒ½å¯ä»¥ç”¨ç­‰å·(==)è¿›è¡Œæ¯”è¾ƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åˆ›å»ºä¸€ä¸ªä½ è‡ªå·±çš„ç±»æ´»ç»“æ„ä½“è¡¨ç¤ºä¸€ä¸ªå¤æ‚çš„æ•°æ®æ¨¡å‹ï¼Œé‚£ä¹ˆSwiftæ— æ³•çŒœåˆ°å¯¹äºè¿™ä¸ªç±»æˆ–è€…ç»“æ„ä½“è€Œè¨€ â€œç›¸ç­‰â€æ„å‘³ç€ä»€ä¹ˆã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œè¿™éƒ¨åˆ†ä»£ç æ— æ³•ä¿è¯é€‚ç”¨äºæ¯ä¸ªå¯èƒ½çš„ç±»å‹<code>T</code>,å½“ä½ è¯•å›¾ç¼–è¯‘è¿™éƒ¨åˆ†ä»£ç çš„æ—¶å€™ä¼šå‡ºç°ç›¸åº”çš„é”™è¯¯ã€‚</p>

<p>ä¸è¿‡æ‰€æœ‰çš„è¿™äº›å¹¶ä¸ä¼šè®©æˆ‘ä»¬æ— ä»ä¸‹æ‰‹ã€‚Swiftæ ‡å‡†åº“ä¸­å®šä¹‰äº†ä¸€ä¸ª<code>Equatable</code>åè®®ï¼Œè¯¥åè®®è¦æ±‚ä»»ä½•ç¬¦åˆè¯¥åè®®çš„ç±»å‹å¿…é¡»å®ç°ç­‰å¼ç¬¦å·(==),ä»è€Œå¯¹ç¬¦åˆè¯¥åè®®çš„ç±»å‹çš„ä»»æ„ä¸¤ä¸ªå€¼è¿›è¡Œæ¯”è¾ƒã€‚æ‰€æœ‰çš„Swiftæ ‡å‡†ç±»å‹è‡ªåŠ¨æ”¯æŒEquatableåè®®ã€‚</p>

<p>ä»»ä½•<code>Equatable</code>ç±»å‹éƒ½å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨åœ¨<code>findIndex(_:_:)</code>å‡½æ•°ä¸­ï¼Œå› ä¸ºå…¶ä¿è¯æ”¯æŒç­‰å¼æ“ä½œç¬¦ã€‚ä¸ºäº†è¯´æ˜äº‹å®ï¼Œå½“ä½ å®šä¹‰ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œä½ å¯ä»¥å®šä¹‰ä¸€ä¸ª<code>Equatable</code>ç±»å‹çº¦æŸä½œä¸ºç±»å‹å‚æ•°å®šä¹‰çš„ä¸€éƒ¨åˆ†:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func findIndex&lt;T: Equatable&gt;(array: [T], _ valueToFind: T) -&gt; Int? {
</span><span class='line'>    for (index, value) in array.enumerate() {
</span><span class='line'>        if value == valueToFind {
</span><span class='line'>            return index
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    return nil
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>findIndex(_:_:)</code>ä¸­çš„è¿™ä¸ªå•ä¸€ç±»å‹å‚æ•°åä½œ<code>T:Equatable</code>ï¼Œä¹Ÿå°±æ„å‘³ç€<code>ä»»ä½•ç¬¦åˆEquatable</code>åè®®çš„<code>T</code>ç±»å‹ã€‚</p>

<p>findIndexå‡½æ•°ç°åœ¨å¯ä»¥æˆåŠŸç¼–è¯‘äº†ã€‚å¹¶ä¸”å¯ä»¥ä½œç”¨äºä»»ä½•ç¬¦åˆ<code>Equatable</code>çš„ç±»å‹ï¼Œå¦‚<code>Double</code>æˆ–<code>String</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let doubleIndex = findIndex([3.14159, 0.1, 0.25], 9.3)
</span><span class='line'>// doubleIndex ç±»å‹ä¸º Int?ï¼Œå…¶å€¼ä¸º nilï¼Œå› ä¸º 9.3 ä¸åœ¨æ•°ç»„ä¸­
</span><span class='line'>let stringIndex = findIndex(["Mike", "Malcolm", "Andrea"], "Andrea")
</span><span class='line'>// stringIndex ç±»å‹ä¸º Int?ï¼Œå…¶å€¼ä¸º 2</span></code></pre></td></tr></table></div></figure>


<h2>å…³è”ç±»å‹</h2>

<p>ä¸‹é¢ä¾‹å­å®šä¹‰äº†ä¸€ä¸ª<code>Container</code>åè®®ï¼Œè¯¥åè®®å®šä¹‰äº†å…³è”ç±»å‹<code>ItemType</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>protocol Container{
</span><span class='line'>   typealias ItemType
</span><span class='line'>    mutating func append(item:ItemType)
</span><span class='line'>    
</span><span class='line'>    var count:Int{get}
</span><span class='line'>    
</span><span class='line'>    subscript(i:Int)-&gt;ItemType{get}
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p><code>Container</code>åè®®å®šä¹‰äº†ä¸‰ä¸ªä»»ä½•é‡‡çº³åè®®çš„ç±»å‹å¿…é¡»æä¾›çš„åŠŸèƒ½ï¼š</p>

<ul>
<li>å¿…é¡»å¯ä»¥é€šè¿‡<code>append</code>æ–¹æ³•æ·»åŠ ä¸€ä¸ªæ–°å…ƒç´ åˆ°å®¹å™¨é‡Œã€‚</li>
<li>å¿…é¡»å¯ä»¥é€šè¿‡<code>count</code>å±æ€§è·å–å®¹æ˜“ä¸­å…ƒç´ çš„æ•°é‡ï¼Œå¹¶è¿”å›ä¸€ä¸ªInt</li>
<li>å¿…é¡»å¯ä»¥é€šè¿‡æ¥å—<code>Int</code>ç´¢å¼•å€¼çš„ä¸‹æ ‡æ£€ç´¢åˆ°æ¯ä¸€ä¸ªå…ƒç´ </li>
</ul>


<p>è¿™ä¸ªåè®®æ²¡æœ‰æŒ‡å®šå®¹æ˜“ä¸­å…ƒç´ è¯¥å¦‚ä½•å­˜å‚¨ï¼Œä»¥åŠå…ƒç´ å¿…é¡»æ˜¯ä½•ç§ç±»å‹ã€‚è¿™ä¸ªåè®®åªæŒ‡å®šäº†ä¸‰ä¸ªä»»ä½•é‡‡çº³<code>Container</code>åè®®çš„ç±»å‹å¿…é¡»æ˜¯æä¾›çš„åŠŸèƒ½ã€‚é‡‡çº³åè®®çš„ç±»å‹åœ¨æ»¡è¶³è¿™ä¸‰ä¸ªæ¡ä»¶çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥æä¾›å…¶ä»–é¢å¤–çš„åŠŸèƒ½ã€‚</p>

<p>ä»»ä½•é‡‡çº³<code>Container</code>åè®®çš„ç±»å‹å¿…é¡»èƒ½å¤ŸæŒ‡å®šå…¶å­˜å‚¨çš„å…ƒç´ çš„ç±»å‹ï¼Œå¿…é¡»ä¿è¯åªæœ‰æ­£ç¡®ç±»å‹çš„å…ƒç´ å¯ä»¥åŠ è¿›å®¹å™¨ä¸­ï¼Œå¿…é¡»æ˜ç¡®é€šè¿‡å…¶ä¸‹æ ‡è¿”å›çš„å…ƒç´ ç±»å‹ã€‚</p>

<p>ä¸ºäº†å®šä¹‰è¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œ<code>Container</code>åè®®éœ€è¦åœ¨ä¸çŸ¥é“å®¹æ˜“ä¸­å…ƒç´ å…·ä½“ç±»å‹çš„æƒ…å†µä¸‹å¼•ç”¨è¿™ç§ç±»å‹ã€‚</p>

<p><code>Container</code>åè®®å£°æ˜äº†ä¸€ä¸ªå…³è”ç±»å‹<code>ItemType</code>ï¼Œåä½œ<code>typealias Itemtype</code>.è¿™ä¸ªåè®®æ— æ³•å®šä¹‰<code>ItemType</code>æ˜¯ä»€ä¹ˆç±»å‹çš„åˆ«åï¼Œè¿™ä¸ªä¿¡æ¯å°†ç•™ç»™é‡‡çº³åè®®çš„ç±»å‹æ¥æä¾›ã€‚å°½ç®¡å¦‚æ­¤ï¼Œ<code>ItemType</code>åˆ«åæä¾›äº†ä¸€ç§æ–¹å¼æ¥å¼•ç”¨<code>Container</code>ä¸­å…ƒç´ çš„ç±»å‹ï¼Œå¹¶å°†ä¹‹ç”¨äº<code>append</code>æ–¹æ³•å’Œä¸‹æ ‡ï¼Œä»è€Œä¿è¯ä»»ä½•<code>Container</code>çš„é¢„æœŸè¡Œä¸ºéƒ½èƒ½å¤Ÿè¢«æ‰§è¡Œã€‚</p>

<p>ä¸‹é¢é‡‡ç”¨å¤åˆ<code>Container</code>åè®®:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct IntStackContainer:Container {
</span><span class='line'>    var items:[Int]
</span><span class='line'>    
</span><span class='line'>    mutating func push(item:Int){
</span><span class='line'>     items.append(item)
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    mutating func pop()-&gt;Int{
</span><span class='line'>        return items.removeLast();
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    //Containeråè®®çš„å®ç°éƒ¨åˆ†
</span><span class='line'>    typealias ItemType=Int
</span><span class='line'>    
</span><span class='line'>    mutating func append(item: ItemType) {
</span><span class='line'>        self.push(item)
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    var count:Int{
</span><span class='line'>      return items.count
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    subscript(i:Int)-&gt;Int{
</span><span class='line'>        return items[i];
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>IntStackContainer</code>ç»“æ„ä½“å®ç°äº†<code>Container</code>åè®®çš„ä¸‰ä¸ªè¦æ±‚ï¼Œå…¶åŸæœ‰åŠŸèƒ½ä¹Ÿä¸ä¼šå’Œè¿™äº›è¦æ±‚å†²çªã€‚</p>

<p>æ­¤å¤–ï¼Œ<code>IntStackContainer</code>æŒ‡å®š ItemTypeä¸ºIntç±»å‹ï¼Œå³<code>typealias ItemType = Int</code>ï¼Œä»è€Œå°†<code>Container</code>åè®®ä¸­æŠ½è±¡çš„<code>ItemType</code>ç±»å‹è½¬ä¸ºå…·ä½“çš„<code>Int</code>ç±»å‹ã€‚</p>

<h2>é€šè¿‡æ‰©å±•ä¸€ä¸ªå­˜åœ¨çš„ç±»å‹æ¥æŒ‡å®šå…³è”ç±»å‹</h2>

<p>Swiftçš„<code>Array</code>å·²ç»æä¾›äº†<code>append(_:_:)</code>æ–¹æ³•ï¼Œä¸€ä¸ª<code>count</code>å±æ€§ï¼Œä»¥åŠä¸€ä¸ªæ¥å—<code>Int</code>å‹ç´¢å¼•å€¼çš„å¯ç”¨æ¥æ£€ç´¢æ•°ç»„å…ƒç´ çš„ä¸‹æ ‡ã€‚è¿™ä¸‰ä¸ªåŠŸèƒ½éƒ½ç¬¦åˆ<code>Container</code>åè®®çš„è¦æ±‚ï¼Œä¹Ÿå°±æ„å‘³ç€ä½ å¯ä»¥æ‰©å±•<code>Array</code>å»ç¬¦åˆ<code>Container</code>åè®®ï¼Œåªéœ€ç®€å•æ»´å£°æ˜<code>Array</code>é‡‡çº³è¯¥åè®®å³å¯ã€‚ä½ å¯ä»¥é€šè¿‡ä¸€ä¸ªç©ºæ‰©å±•æ¥å®ç°è¿™ç‚¹</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>extension Array:Container{}</span></code></pre></td></tr></table></div></figure>


<p>å¦‚ä½•ä¸Šé¢çš„æ³›å‹<code>Stack</code>ç»“æ„ä¸€æ ·ï¼Œarrayçš„<code>append(_:)</code>æ–¹æ³•å’Œä¸‹æ ‡ç¡®ä¿äº†Swiftå¯ä»¥æ¨æ–­å‡º<code>ItemType</code>çš„ç±»å‹ï¼Œå®šä¹‰äº†è¿™ä¸ªæ‰©å±•åï¼Œä½ å¯ä»¥å°†ä»»æ„<code>Array</code>å½“åš<code>Container</code>æ¥ä½¿ç”¨</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Swift-å¯é€‰é“¾]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/22/swift-ke-xuan-lian/"/>
    <updated>2016-03-22T09:35:29+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/22/swift-ke-xuan-lian</id>
    <content type="html"><![CDATA[<p>å¯é€‰é“¾å¼è°ƒç”¨(Optional Chaining)æ˜¯ä¸€ç§å¯ä»¥åœ¨å½“å‰å€¼å¯èƒ½ä¸º<code>nil</code>çš„å¯é€‰å€¼ä¸Šè¯·æ±‚å’Œè°ƒç”¨å±æ€§ï¼Œæ–¹æ³•åŠä¸‹æ ‡çš„æ–¹æ³•ã€‚å¦‚æœå¯é€‰å€¼æœ‰å€¼ï¼Œé‚£ä¹ˆè°ƒç”¨å°±ä¼šæˆåŠŸï¼›å¦‚æœå¯é€‰å€¼ä¸ºnil,é‚£ä¹ˆè°ƒç”¨å°†è¿”å›<code>nil</code>.å¤šä¸ªè°ƒç”¨å¯ä»¥è¿æ¥åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªé“¾ï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªç‚¹ä¸º<code>nil</code>,æ•´ä¸ªè°ƒç”¨é“¾å°±ä¼šå¤±è´¥ï¼Œå³è¿”å›nil.</p>

<!--more-->


<h2>ä½¿ç”¨å¯é€‰é“¾å¼è°ƒç”¨ä»£æ›¿å¼ºåˆ¶å±•å¼€</h2>

<p>é€šè¿‡åœ¨æƒ³è°ƒç”¨çš„å±æ€§ï¼Œæ–¹æ³•ï¼Œä¸‹æ ‡çš„å¯é€‰å€¼åé¢æ”¾ä¸€ä¸ªé—®å·(?),å¯ä»¥å®šä¹‰ä¸€ä¸ªå¯é€‰é“¾ï¼Œè¿™ä¸€ç‚¹å¾ˆåƒåœ¨å¯é€‰å€¼åé¢åŠ ä¸€ä¸ª(!)æ¥å¼ºåˆ¶å±•å¼€å®ƒçš„å€¼ã€‚å®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºå½“å¯é€‰å€¼ä¸ºç©ºæ—¶ï¼Œå¯é€‰é“¾å¼å°±ä¼šè°ƒç”¨å¤±è´¥ï¼Œç„¶è€Œå¼ºåˆ¶å±•å¼€å°±ä¼šè§¦å‘è¿è¡Œæ—¶é”™è¯¯ã€‚</p>

<p>ä¸ºäº†åæ˜ å¯é€‰é“¾æ—¶è°ƒç”¨å¯ä»¥åœ¨ç©ºå€¼(nil)ä¸Šè°ƒç”¨çš„äº‹å®ï¼Œä¸è®ºè¿™ä¸ªè°ƒç”¨çš„å±æ€§ï¼Œæ–¹æ³•åŠä¸‹æ ‡è¿”å›çš„å€¼æ˜¯ä¸æ˜¯å¯é€‰å€¼ï¼Œå®ƒçš„è¿”å›ç»“æœéƒ½æ˜¯ä¸€ä¸ªå¯é€‰å€¼ã€‚ä½ å¯ä»¥åˆ©ç”¨è¿™ä¸ªè¿”å›å€¼æ¥åˆ¤æ–­ä½ çš„å¯é€‰é“¾æ—¶è°ƒç”¨æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè°ƒç”¨æœ‰è¿”å›å€¼åˆ™è¯´æ˜è°ƒç”¨æˆåŠŸï¼Œè¿”å› <code>nil</code>åˆ™è¯´æ˜è°ƒç”¨å¤±è´¥ã€‚</p>

<p>ç‰¹åˆ«åœ°ï¼Œå¯é€‰é“¾å¼è°ƒç”¨çš„è¿”å›ç»“æœä¸åŸæœ¬çš„è¿”å›ç»“æœå…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œä½†æ˜¯è¢«åŒ…è£…æˆä¸€ä¸ªå¯é€‰å€¼ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨å¯é€‰é“¾å¼è°ƒç”¨è®¿é—®å±æ€§ï¼Œå½“å¯é€‰é“¾å¼è°ƒç”¨æˆåŠŸæ—¶ï¼Œå¦‚æœå±æ€§åŸæœ¬çš„è¿”å›ç»“æœæ˜¯<code>Int</code>ç±»å‹ï¼Œåˆ™ä¼šå˜æˆ<code>Int?</code>ç±»å‹ã€‚</p>

<p>ä¸‹é¢å‡ æ®µä»£ç å°†è§£é‡Šå¯é€‰é“¾å¼è°ƒç”¨å’Œå¼ºåˆ¶å±•å¼€çš„ä¸åŒã€‚</p>

<p>é¦–å…ˆå®šä¹‰ä¸¤ä¸ªç±»<code>Person</code>å’Œ<code>Residence</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Person {
</span><span class='line'>    var residence:Residence?
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>class Residence {
</span><span class='line'>    var numberOfRooms=1
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>Residence</code>æœ‰ä¸€ä¸ª<code>Int</code>ç±»å‹çš„å±æ€§<code>numberOfRooms</code>,å…¶é»˜è®¤æ˜¯å€¼æ˜¯1ï¼Œ<code>Person</code>å…·æœ‰ä¸€ä¸ªå¯é€‰çš„<code>residence</code>å±æ€§ï¼Œå…¶ç±»å‹ä¸º<code>Residence?</code></p>

<p>å¦‚æœåˆ›å»ºä¸€ä¸ªæ–°çš„<code>Person</code>å®ä¾‹ï¼Œå› ä¸ºå®ƒçš„<code>residence</code>å±æ€§æ˜¯å¯é€‰çš„ï¼Œ<code>john</code>å±æ€§å°†åˆå§‹åŒ–ä¸º<code>nil</code>:</p>

<pre><code>let john=Person()
</code></pre>

<p>å¦‚æœä½¿ç”¨å¹å·(!)å¼ºåˆ¶å±•å¼€è·å¾—è¿™ä¸ª<code>john</code>çš„<code>Residence</code>å±æ€§ä¸­çš„<code>numberofRooms</code>å€¼ï¼Œä¼šè§¦å‘è¿è¡Œæ—¶é”™è¯¯ï¼Œå› ä¸ºè¿™æ—¶<code>residence</code>æ²¡æœ‰å¯ä»¥å±•å¼€çš„å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let roomCount = john.residence!.numberOfRooms
</span><span class='line'>// è¿™ä¼šå¼•å‘è¿è¡Œæ—¶é”™è¯¯</span></code></pre></td></tr></table></div></figure>


<p><code>john.residence</code>ä¸ºénilå€¼çš„æ—¶å€™ï¼Œä¸Šé¢çš„è°ƒç”¨ä¼šæˆåŠŸï¼Œå¹¶ä¸”æŠŠ<code>roomCount</code>è®¾ç½®ä¸º<code>Int</code>ç±»å‹çš„æˆ¿é—´æ•°é‡ï¼Œæ­£å¦‚ä¸Šé¢æ‰€æåˆ°çš„ï¼Œå½“<code>residence</code>ä¸º<code>nil</code>çš„æ—¶å€™ä¸Šé¢è¿™æ®µä»£ç ä¼šè§¦å‘è¿è¡Œæ—¶é”™è¯¯ã€‚</p>

<p>å¯é€‰é“¾æ—¶è°ƒç”¨æä¾›äº†å¦ä¸€ç§è®¿é—®<code>numberOfRooms</code>çš„æ–¹å¼ï¼Œä½¿ç”¨é—®å·(?)æ¥ä»£æ›¿åŸæ¥çš„å¹å·(!)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let roomCount = john.residence?.numberOfRooms {
</span><span class='line'>    print("John's residence has \(roomCount) room(s).")
</span><span class='line'>} else {
</span><span class='line'>    print("Unable to retrieve the number of rooms.")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œUnable to retrieve the number of rooms.â€</span></code></pre></td></tr></table></div></figure>


<p>åœ¨<code>residence</code>åé¢æ·»åŠ é—®å·ä¹‹åï¼ŒSwiftå°±ä¼šåœ¨<code>residence</code>ä¸ä¸ºnilçš„æƒ…å†µä¸‹è®¿é—®<code>numberOfRooms</code>.</p>

<p>å› ä¸ºè®¿é—®<code>numberOfRooms</code>åˆçœ‹å‘¢è¿‡å¤±è´¥ï¼Œå¯é€‰é“¾å¼è°ƒç”¨ä¼šè¿”å›<code>Int?</code>ç±»å‹ï¼Œæˆ–ç§°ä¸º'å¯é€‰çš„Int'ã€‚å¦‚ä¸Šä¾‹æ‰€ç¤ºï¼Œå½“<code>residence</code>ä¸º<code>nil</code>çš„æ—¶å€™ï¼Œå¯é€‰çš„<code>Int</code>å°†ä¼šä¸º<code>nil</code>,è¡¨æ˜æ— æ³•è®¿é—®<code>numberOfRooms</code>ã€‚è®¿é—®æˆåŠŸæ—¶ï¼Œå¯é€‰çš„<code>Int</code>å€¼ä¼šé€šè¿‡å¯é€‰ç»‘å®šå±•å¼€ï¼Œå¹¶å¤åˆ¶ç»™éå¯é€‰ç±»å‹çš„<code>roomCount</code>å¸¸é‡ã€‚</p>

<p>è¦æ³¨æ„çš„æ˜¯ï¼ŒåŠæ—¶<code>numberOfRooms</code>æ˜¯éå¯é€‰çš„<code>Int</code>æ—¶ï¼Œè¿™ä¸€ç‚¹ä¹Ÿæˆç«‹ã€‚åªè¦ä½¿ç”¨å¯é€‰é“¾å¼è°ƒç”¨å°±æ„å‘³ç€<code>numberOfRooms</code>ä¼šè¿”å›ä¸€ä¸ª<code>Int?</code>è€Œä¸æ˜¯<code>Int</code>.</p>

<p>å¯ä»¥å°†ä¸€ä¸ª<code>Residence</code>çš„å®ä¾‹èµ‹å€¼ç»™<code>john.residence</code>ï¼Œè¿™æ ·å®ƒå°±ä¸åœ¨æ˜¯<code>nil</code>äº†:</p>

<pre><code>john.residence=Residenc();
</code></pre>

<p>john.residenceç°åœ¨åŒ…å«ä¸€ä¸ªå®é™…çš„<code>Residence</code>å®ä¾‹ï¼Œè€Œä¸å†æ˜¯<code>nil</code>.å¦‚æœä½ è¯•å›¾ä½¿ç”¨å…ˆå‰çš„å¯é€‰é“¾å¼è°ƒç”¨è®¿é—®<code>numberOfRooms</code>ï¼Œå®ƒç°åœ¨å°†è¿”å›å€¼ä¸º1çš„<code>Int?</code>ç±»å‹çš„å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let roomCount = john.residence?.numberOfRooms {
</span><span class='line'>    print("John's residence has \(roomCount) room(s).")
</span><span class='line'>} else {
</span><span class='line'>    print("Unable to retrieve the number of rooms.")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œJohn's residence has 1 room(s).â€</span></code></pre></td></tr></table></div></figure>


<h2>å¯é€‰é“¾å¼è°ƒç”¨å®šä¹‰æ¨¡å‹ç±»</h2>

<p>é€šè¿‡ä½¿ç”¨å¯é€‰é“¾å¼è°ƒç”¨å¯ä»¥è°ƒç”¨å¤šå±‚å±æ€§ï¼Œæ–¹æ³•å’Œä¸‹æ ‡ã€‚è¿™æ ·å¯ä»¥åœ¨å¤æ‚çš„æ¨¡å‹ä¸­å‘ä¸‹è®¿é—®å„ç§å­å±æ€§ï¼Œå¹¶ä¸”åˆ¤æ–­èƒ½å¦è®¿é—®å­å±æ€§çš„å±æ€§ï¼Œæ–¹æ³•å’Œä¸‹æ ‡ã€‚</p>

<p>ä¸‹é¢è¿™æ®µä»£ç å®šä¹‰äº†å››ä¸ªæ¨¡å‹ç±»ï¼Œè¿™äº›ä¾‹å­åŒ…æ‹¬å¤šå±‚å¯é€‰é“¾å¼è°ƒç”¨ã€‚ä¸ºäº†æ–¹ä¾¿è¯´æ˜ï¼Œåœ¨<code>person</code>å’Œ<code>Residence</code>çš„åŸºç¡€ä¸Šå¢åŠ äº†<code>Room</code>ç±»å’Œ<code>Address</code>ç±»ï¼Œä¸€çº§ç›¸å…³çš„å±æ€§ï¼Œæ–¹æ³•å’Œä¸‹æ ‡.</p>

<p><code>Person</code>ç±»çš„å®šä¹‰åŸºæœ¬ä¿æŒä¸å˜:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Person {
</span><span class='line'>    var residence: Residence?
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Residenceç±»æ¯”ä¹‹å‰å¤æ‚äº›ã€‚å¢åŠ äº†ä¸€ä¸ªåä¸º<code>Rooms</code>çš„å˜é‡å±æ€§ï¼Œè¯¥å±æ€§è¢«åˆå§‹åŒ–ä¸º<code>[Room]</code>ç±»å‹çš„ç©ºæ•°ç»„:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Residence {
</span><span class='line'>    var rooms = [Room]()
</span><span class='line'>    var numberOfRooms: Int {
</span><span class='line'>        return rooms.count
</span><span class='line'>    }
</span><span class='line'>    subscript(i: Int) -&gt; Room {
</span><span class='line'>        get {
</span><span class='line'>            return rooms[i]
</span><span class='line'>        }
</span><span class='line'>        set {
</span><span class='line'>            rooms[i] = newValue
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    func printNumberOfRooms() {
</span><span class='line'>        print("The number of rooms is \(numberOfRooms)")
</span><span class='line'>    }
</span><span class='line'>    var address: Address?
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨<code>Residence</code>æœ‰äº†ä¸€ä¸ªå­˜å‚¨<code>Room</code>å®ä¾‹çš„æ•°ç»„ï¼Œ<code>numberOfRooms</code>å±æ€§è¢«å®ç°ä¸ºè®¡ç®—å‹å±æ€§ï¼Œè€Œä¸æ˜¯å­˜å‚¨å‹å±æ€§ã€‚<code>numberOfRooms</code>å±æ€§ç®€å•åœ°è¿”å›<code>Rooms</code>æ•°ç»„çš„countå±æ€§çš„å€¼ã€‚ã€‚</p>

<p>residenceè¿˜æä¾›äº†roomsæ•°ç»„çš„å¿«æ·æ–¹å¼ï¼Œå³æä¾›å¯è¯»å†™çš„ä¸‹æ ‡æ¥è®¿é—®<code>rooms</code>æ•°ç»„ä¸­æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚</p>

<p>æ­¤å¤–ï¼Œ<code>Residence</code>è¿˜æä¾›äº†<code>printNUmberOfRooms()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯æ‰“å°<code>numberOfRooms</code>çš„å€¼ã€‚</p>

<p>æœ€åï¼Œ<code>Residence</code>è¿˜å®šä¹‰äº†ä¸€ä¸ªå¯é€‰å±æ€§<code>address</code>,å…¶ç±»å‹ä¸º<code>Address?</code>.Addressç±»çš„å®šä¹‰åœ¨ä¸‹é¢ä¼šè¯´æ˜ã€‚</p>

<p><code>Room</code>ç±»æ˜¯ä¸€ä¸ªç®€å•ç±»ï¼Œå…¶å®ä¾‹è¢«å­˜å‚¨åœ¨<code>rooms</code>æ•°ç»„ä¸­ã€‚è¯¥ç±»åªåŒ…å«ä¸€ä¸ªå±æ€§<code>name</code>,ä»¥åŠä¸€ä¸ªç”¨äºå°†è¯¥å±æ€§è®¾ç½®ä¸ºé€‚å½“çš„æˆ¿é—´åçš„åˆå§‹åŒ–å‡½æ•°:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Room {
</span><span class='line'>    let name: String
</span><span class='line'>    init(name: String) { self.name = name }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æœ€åä¸€ä¸ªç±»æ˜¯<code>Address</code>,è¿™ä¸ªç±»æœ‰ä¸‰ä¸ª<code>String?</code>ç±»å‹çš„å¯é€‰å±æ€§ï¼Œ<code>buildingName</code>ä»¥åŠ<code>buildingNuber</code>å±æ€§åˆ†åˆ«è¡¨ç¤ºæŸä¸ªå¤§å¦çš„åç§°å’Œå·ç ï¼Œç¬¬ä¸‰ä¸ªå±æ€§<code>street</code>è¡¨ç¤ºå¤§å¦æ‰€åœ¨è¡—é“çš„åç§°:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Address {
</span><span class='line'>    var buildingName: String?
</span><span class='line'>    var buildingNumber: String?
</span><span class='line'>    var street: String?
</span><span class='line'>    func buildingIdentifier() -&gt; String? {
</span><span class='line'>        if buildingName != nil {
</span><span class='line'>            return buildingName
</span><span class='line'>        } else if buildingNumber != nil && street != nil {
</span><span class='line'>            return "\(buildingNumber) \(street)"
</span><span class='line'>        } else {
</span><span class='line'>            return nil
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>Address</code>ç±»æä¾›äº†<code>buildingIdentifier ()</code>æ–¹æ³•ï¼Œè¿”å›å€¼ä¸º<code>String?</code>,å¦‚æœ<code>buildingName</code>æœ‰å€¼åˆ™è¿”å›<code>buildingName</code>.æˆ–è€…ï¼Œå¦‚æœ<code>buildingName</code>å’Œ<code>street</code>å‡æœ‰å€¼åˆ™è¿”å›<code>buildingNumber</code>.å¦åˆ™ï¼Œè¿”å›<code>nil</code>.</p>

<h2>é€šè¿‡å¯é€‰é“¾å¼è®¿é—®å±æ€§</h2>

<p>ä¸‹é¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ª<code>Person</code>å®ä¾‹ï¼Œç„¶ååƒå¿—å¼ºä¸€æ ·ï¼Œå°è¯•è®¿é—®<code>nubmerOfRooms</code>å±æ€§:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let john = Person()
</span><span class='line'>if let roomCount = john.residence?.numberOfRooms {
</span><span class='line'>    print("John's residence has \(roomCount) room(s).")
</span><span class='line'>} else {
</span><span class='line'>    print("Unable to retrieve the number of rooms.")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œUnable to retrieve the number of rooms.â€</span></code></pre></td></tr></table></div></figure>


<p>å› ä¸º<code>john.residence</code>ä¸º<code>nil</code>,æ‰€ä»¥è¿™ä¸ªå¯é€‰é“¾å¼è°ƒç”¨ä¾æ—§ä¼šåƒå…ˆå‰ä¸€æ ·å¤±è´¥.</p>

<p>è¿˜å¯ä»¥é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨æ¥è®¾ç½®å±æ€§çš„å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let someAddress = Address()
</span><span class='line'>someAddress.buildingNumber = "29"
</span><span class='line'>someAddress.street = "Acacia Road"
</span><span class='line'>john.residence?.address = someAddress</span></code></pre></td></tr></table></div></figure>


<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šè¿‡<code>john.residence</code>æ¥è®¾å®š<code>address</code>å±æ€§ä¹Ÿä¼šå¤±è´¥ï¼Œå› ä¸º<code>john.residence</code>å½“å‰ä¸º<code>nil</code>.</p>

<p>ä¸Šé¢ä»£ç ä¸­çš„èµ‹å€¼è¿‡ç¨‹æ˜¯å¯é€‰é“¾å¼è°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ„å‘³ç€å¯é€‰é“¾å¼è°ƒç”¨å¤±è´¥æ—¶ï¼Œç­‰å·å³ä¾§çš„ä»£ç ä¸ä¼šè¢«æ‰§è¡Œã€‚å¯¹äºä¸Šé¢çš„ä»£ç æ¥è¯´ï¼Œå¾ˆéš¾éªŒè¯è¿™ä¸€ç‚¹ï¼Œå› ä¸ºåƒè¿™æ ·èµ‹å€¼ä¸€ä¸ªå¸¸é‡æ²¡æœ‰ä»»ä½•å‰¯ä½œç”¨ã€‚ä¸‹é¢çš„ä»£ç å®Œæˆäº†åŒæ ·çš„é€‚åº”ï¼Œä½†æ˜¯å®ƒä½¿ç”¨ä¸€ä¸ªå‡½æ•°æ¥åˆ›å»º<code>Address</code>å®ä¾‹ï¼Œç„¶åå°†è¯¥å®ä¾‹è¿”å›ç”¨äºèµ‹å€¼ã€‚è¯¥å‡½æ•°ä¼šåœ¨è¿”å›å‰ç­”åº”<code>Funcation was called</code>ï¼Œè¿™ä½¿ä½ èƒ½éªŒè¯ç­‰å·å³ä¾§çš„ä»£ç æ˜¯å¦è¢«æ‰§è¡Œ.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func createAddress() -&gt; Address {
</span><span class='line'>    print("Function was called.")
</span><span class='line'>
</span><span class='line'>    let someAddress = Address()
</span><span class='line'>    someAddress.buildingNumber = "29"
</span><span class='line'>    someAddress.street = "Acacia Road"
</span><span class='line'>
</span><span class='line'>    return someAddress
</span><span class='line'>}
</span><span class='line'>john.residence?.address = createAddress()</span></code></pre></td></tr></table></div></figure>


<p>æ²¡æœ‰ç­”åº”ä»»ä½•æ¶ˆæ¯ï¼Œå¯ä»¥çœ‹å‡º<code>createAddress()</code>å‡½æ•°å¹¶æœªè¢«æ‰§è¡Œã€‚</p>

<h2>é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨æ–¹æ³•</h2>

<p>å¯ä»¥é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨æ¥è°ƒç”¨æ–¹æ³•ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦è°ƒç”¨æˆåŠŸï¼Œå³ä½¿è¿™ä¸ªæ–¹æ³•æ²¡æœ‰è¿”å›å€¼.</p>

<p><code>Residence</code>ç±»ä¸­çš„<code>printNumberOfRooms()</code>æ–¹æ³•æ‰“å°å½“å‰çš„<code>numberOfRooms</code>å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func printNumberOfRooms() {
</span><span class='line'>    print("The number of rooms is \(numberOfRooms)")
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªæ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œç„¶è€Œï¼Œæ²¡æœ‰è¿”å›å€¼çš„æ–¹æ³•å…·æœ‰éšå¼çš„è¿”å›ç±»å‹<code>Void</code>,è¿™æ„å‘³ç€æ²¡æœ‰è¿”å›å€¼çš„æ–¹æ³•ä¹Ÿä¼šè¿”å›<code>()</code>,æˆ–è€…æˆ–ç©ºçš„æ•°ç»„.</p>

<p>é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨å¾—åˆ°çš„è¿”å›å€¼éƒ½æ˜¯å¯é€‰çš„ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>if</code>è¯­å¥æ¥åˆ¤æ–­æ˜¯å¦æˆåŠŸè°ƒç”¨<code>printNumberOfRooms()</code>æ–¹æ³•ï¼Œå°±æ˜¯æ–¹æ³•æœ¬èº«æ²¡æœ‰å®šä¹‰è¿”å›å€¼ï¼Œé€šè¿‡åˆ¤æ–­è¿”å›å€¼æ˜¯å¦ä¸º<code>nil</code>å¯ä»¥åˆ¤æ–­è°ƒç”¨æ˜¯å¦æˆåŠŸ:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if john.residence?.printNumberOfRooms() != nil {
</span><span class='line'>    print("It was possible to print the number of rooms.")
</span><span class='line'>} else {
</span><span class='line'>    print("It was not possible to print the number of rooms.")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œIt was not possible to print the number of rooms.â€</span></code></pre></td></tr></table></div></figure>


<p>åŒæ ·æ»´ï¼Œå¯ä»¥æ®æ­¤åˆ¤æ–­é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨ä¸ºå±æ€§èµ‹å€¼æ˜¯å¦æˆåŠŸï¼Œæˆ‘ä»¬å°è¯•ç»™<code>john.residence</code>ä¸­çš„ address å±æ€§èµ‹å€¼ï¼Œå³ä½¿<code>residence</code>ä¸ºnil,é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨ç»™å±æ€§èµ‹å€¼ä¼šè¿”å›<code>Void?</code>,é€šè¿‡åˆ¤æ–­è¿”å›å€¼æ˜¯å¦ä¸ºnilå°±å¯ä»¥çŸ¥é“èµ‹å€¼æ˜¯å¦æˆåŠŸ:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if (john.residence?.address = someAddress) != nil {
</span><span class='line'>    print("It was possible to set the address.")
</span><span class='line'>} else {
</span><span class='line'>    print("It was not possible to set the address.")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œIt was not possible to set the address.â€</span></code></pre></td></tr></table></div></figure>


<h2>é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨è®¿é—®ä¸‹æ ‡</h2>

<p>é€šè¿‡å¯é€‰é“¾å¼çš„è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªå¯é€‰å€¼ä¸Šè®¿é—®ä¸‹æ ‡ï¼Œå¹¶ä¸”åˆ¤æ–­ä¸‹æ ‡è°ƒç”¨æ˜¯å¦æˆåŠŸã€‚</p>

<blockquote><p><strong>æ³¨æ„</strong>
é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨è®¿é—®å¯é€‰å€¼çš„ä¸‹æ ‡æ—¶ï¼Œåº”è¯¥å°†é—®å·æ”¾åœ¨ä¸‹æ ‡æ–¹æ‹¬å·çš„å‰é¢è€Œä¸æ˜¯åé¢ï¼Œå¯é€‰é“¾å¼è°ƒç”¨çš„é—®å·ä¸€èˆ¬ç›´æ¥è·Ÿåœ¨å¯é€‰è¡¨è¾¾å¼çš„åé¢ã€‚</p></blockquote>

<p>ä¸‹é¢è¿™ä¸ªä¾‹å­ç”¨ä¸‹æ ‡è®¿é—®<code>john.residence</code>å±æ€§å­˜å‚¨çš„<code>Residences</code>å®ä¾‹çš„<code>Rooms</code>æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªæˆ¿é—´çš„åç§°ï¼Œå› ä¸º<code>john.residence</code>ä¸º<code>nil</code>,æ‰€ä»¥ä¸‹æ ‡è°ƒç”¨å¤±è´¥äº†.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let firstRoomName = john.residence?[0].name {
</span><span class='line'>    print("The first room name is \(firstRoomName).")
</span><span class='line'>} else {
</span><span class='line'>    print("Unable to retrieve the first room name.")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œUnable to retrieve the first room name.â€</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé—®å·ç›´æ¥æ”¾åœ¨<code>john.residence</code>çš„åé¢ï¼Œå¹¶ä¸”åœ¨æ–¹æ‹¬å·çš„å‰é¢ï¼Œå› ä¸º<code>john.residence</code>æ˜¯å¯é€‰å€¼.</p>

<p>ç±»ä¼¼çš„ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡ï¼Œç”¨å¯é€‰é“¾å¼è°ƒç”¨æ¥èµ‹å€¼:</p>

<pre><code>john.residence?[0] = Room(name: "Bathroom")
</code></pre>

<p> è¿™æ ·èµ‹å€¼åŒæ ·ä¼šå¤±è´¥ï¼Œå› ä¸º<code>residence</code>ç›®å‰æ˜¯<code>nil</code>.</p>

<p> å¦‚æœä½ åˆ›å»ºä¸€ä¸ª<code>Residence</code>å®ä¾‹ï¼Œå¹¶æœªå…¶<code>rooms</code>æ•°ç»„æ·»åŠ ä¸€äº›<code>Room</code>å®ä¾‹ï¼Œç„¶åå°†<code>Residence</code>å®ä¾‹èµ‹å€¼ç»™<code>john.residence</code>ï¼Œé‚£å°±å¯ä»¥é€šè¿‡å¯é€‰é“¾å’Œä¸‹æ ‡æ¥è®¿é—®æ•°ç»„ä¸­çš„å…ƒç´ :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let johnsHouse = Residence()
</span><span class='line'>johnsHouse.rooms.append(Room(name: "Living Room"))
</span><span class='line'>johnsHouse.rooms.append(Room(name: "Kitchen"))
</span><span class='line'>john.residence = johnsHouse
</span><span class='line'>
</span><span class='line'>if let firstRoomName = john.residence?[0].name {
</span><span class='line'>    print("The first room name is \(firstRoomName).")
</span><span class='line'>} else {
</span><span class='line'>    print("Unable to retrieve the first room name.")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œThe first room name is Living Room.â€</span></code></pre></td></tr></table></div></figure>


<h2>è®¿é—®å¯é€‰ç±»å‹çš„ä¸‹æ ‡</h2>

<p>å¦‚æœä¸‹æ ‡è¿”å›å¯é€‰ç±»å‹çš„å€¼ï¼Œæ¯”å¦‚Swiftä¸­<code>Dictionary</code>ç±»å‹çš„é”®ä¸‹æ ‡ï¼Œå¯ä»¥åœ¨ä¸‹æ ‡çš„ç»“å°¾å¤„æ”¾ä¸€ä¸ªé—®å·æ¥åœ¨å…¶å¯é€‰å€¼ä¸Šè¿›è¡Œå¯é€‰é“¾å¼è°ƒç”¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var testScores = ["Dave": [86, 82, 84], "Bev": [79, 94, 81]]
</span><span class='line'>testScores["Dave"]?[0] = 91
</span><span class='line'>testScores["Bev"]?[0]++
</span><span class='line'>testScores["Brian"]?[0] = 72
</span><span class='line'>// "Dave" æ•°ç»„ç°åœ¨æ˜¯ [91, 82, 84]ï¼Œ"Bev" æ•°ç»„ç°åœ¨æ˜¯ [80, 94, 81]</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä¾‹å­ä¸­å®šä¹‰äº†ä¸€ä¸ª<code>testScores</code>æ•°ç»„ï¼ŒåŒ…å«äº†ä¸¤ä¸ªé”®å€¼å¯¹ï¼ŒæŠŠStringç±»å‹çš„é”®æ˜ å°„åˆ°ä¸€ä¸ª<code>Int</code>å€¼çš„æ•°ç»„ã€‚ç¬¬ä¸‰ä¸ªé”®å€¼ä¸å­˜åœ¨ï¼Œæ•…è°ƒç”¨å¤±è´¥ã€‚</p>

<h2>è¿æ¥å¤šå±‚å¯é€‰é“¾å¼çš„è°ƒç”¨</h2>

<p>å¯ä»¥é€šè¿‡è¿æ¥å¤šä¸ªå¯é€‰é“¾å¼è°ƒç”¨åœ¨æ›´æ·±çš„æ¨¡å‹å±‚çº§ä¸­è®¿é—®å±æ€§ï¼Œæ–¹æ³•åŠä¸‹æ ‡ï¼Œç„¶è€Œï¼Œå¤šå±‚å¯é€‰é“¾å¼è°ƒç”¨ä¸ä¼šå¢åŠ è¿”å›å€¼çš„å¯é€‰å±‚çº§ã€‚</p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p>

<ul>
<li>å¦‚æœä½ è®¿é—®çš„å€¼ä¸æ˜¯å¯é€‰çš„ï¼Œå¯é€‰é“¾å¼è°ƒç”¨å°†ä¼šè¿”å›å¯é€‰å€¼</li>
<li>å¦‚æœä½ è¿”å›çš„å€¼å°±æ˜¯å¯é€‰çš„ï¼Œå¯é€‰é“¾å¼è°ƒç”¨ä¸ä¼šè®©å¯é€‰è¿”å›å€¼å˜å¾—'æ›´å¯é€‰'</li>
</ul>


<p>å› æ­¤:</p>

<ul>
<li>é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨è®¿é—®ä¸€ä¸ª<code>Int</code>å€¼ï¼Œå°†ä¼šè¿”å›<code>Int?</code>,æ— è®ºä½¿ç”¨äº†å¤šå°‘å±‚å¯é€‰é“¾å¼è°ƒç”¨</li>
<li>ç±»ä¼¼çš„ï¼Œé€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨è®¿é—®<code>Int?</code>å€¼ï¼Œä¾æ—§ä¼šè¿”å›<code>Int?</code>å€¼ï¼Œå¹¶ä¸ä¼šè¿”å›<code>Int??</code></li>
</ul>


<p>ä¸‹é¢çš„ä¾‹å­å°è¯•è®¿é—®<code>john</code>ä¸­çš„<code>residence</code>å±æ€§ä¸­çš„<code>address</code>å±æ€§ä¸­çš„street   å±æ€§ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸¤å±‚å¯é€‰é“¾å¼è°ƒç”¨ï¼Œ<code>residence</code>ä»¥åŠadresséƒ½æ˜¯å¯é€‰å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let johnsStreet = john.residence?.address?.street {
</span><span class='line'>    print("John's street name is \(johnsStreet).")
</span><span class='line'>} else {
</span><span class='line'>    print("Unable to retrieve the address.")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œUnable to retrieve the address.â€</span></code></pre></td></tr></table></div></figure>


<p>john.residenceç°åœ¨åŒ…å«ä¸€ä¸ªæœ‰æ•ˆçš„<code>Residence</code>å®ä¾‹ã€‚ç„¶è€Œï¼Œ<code>john.residence.address</code>çš„å€¼å½“å‰ä¸ºnil.å› æ­¤è°ƒç”¨<code>john.residence?.adress?.street</code>ä¼šå¤±è´¥ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­,<code>street</code>çš„å±æ€§ä¸º<code>String?</code>.<code>john.residence?.address?.street</code>çš„è¿”å›å€¼ä¹Ÿä¾ç„¶æ˜¯<code>String?</code>,å³ä½¿å·²ç»ä½¿ç”¨äº†ä¸¤å±‚å¯é€‰é“¾å¼è°ƒç”¨.</p>

<p>å¦‚æœ<code>john.residence.address</code>èµ‹å€¼ä¸€ä¸ª<code>Address</code>å®ä¾‹ï¼Œå¹¶ä¸”ä¸º<code>address</code>ä¸­çš„<code>street</code>å±æ€§è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆå€¼ï¼Œæˆ‘ä»¬å°±èƒ½é€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨æ¥è®¿é—®<code>street</code>å±æ€§:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let johnsAddress = Address()
</span><span class='line'>johnsAddress.buildingName = "The Larches"
</span><span class='line'>johnsAddress.street = "Laurel Street"
</span><span class='line'>john.residence?.address = johnsAddress
</span><span class='line'>
</span><span class='line'>if let johnsStreet = john.residence?.address?.street {
</span><span class='line'>    print("John's street name is \(johnsStreet).")
</span><span class='line'>} else {
</span><span class='line'>    print("Unable to retrieve the address.")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œJohn's street name is Laurel Street.â€</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå› ä¸º<code>john.residence</code>åŒ…å«äº†ä¸€ä¸ªæœ‰æ•ˆçš„<code>Residence</code>å®ä¾‹ï¼Œæ‰€ä»¥å¯¹<code>john.residence</code>çš„Addresså±æ€§èµ‹å€¼å°†ä¼šæˆåŠŸã€‚</p>

<h2>åœ¨æ–¹æ³•çš„å¯é€‰è¿”å›å€¼ä¸Šè¿›è¡Œå¯é€‰é“¾å¼è°ƒç”¨</h2>

<p>ä¸Šé¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ªå¯é€‰å€¼ä¸Šé€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨æ¥è·å–å®ƒçš„å±æ€§å€¼ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨ä¸€ä¸ªå¯é€‰å€¼ä¸Šé€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨æ¥è°ƒç”¨æ–¹æ³•ï¼Œå¹¶ä¸”æ ¹æ®éœ€è¦ç»§ç»­åœ¨æ–¹æ³•çš„å¯é€‰è¿”å›å€¼ä¸Šè¿›è¡Œå¯é€‰é“¾å¼è°ƒç”¨</p>

<p>åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œé€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨<code>Address</code>çš„<code>buildingIdeneity()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›<code>String?</code>ç±»å‹çš„å€¼ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œé€šè¿‡å¯é€‰é“¾å¼è°ƒç”¨æ¥è°ƒç”¨è¯¥æ–¹æ³•ï¼Œæœ€ç»ˆçš„è¿”å›å€¼ä¾æ—§æ˜¯ String?ç±»å‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let buildingIdentifier = john.residence?.address?.buildingIdentifier() {
</span><span class='line'>    print("John's building identifier is \(buildingIdentifier).")
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œJohn's building identifier is The Larches.â€</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœè¦åœ¨è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸Šè¿›è¡Œå¯é€‰é“¾å¼è°ƒç”¨ï¼Œåœ¨æ–¹æ³•çš„åœ†æ‹¬å·åé¢åŠ ä¸Šé—®å·å³å¯:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let beginsWithThe =
</span><span class='line'>    john.residence?.address?.buildingIdentifier()?.hasPrefix("The") {
</span><span class='line'>        if beginsWithThe {
</span><span class='line'>            print("John's building identifier begins with \"The\".")
</span><span class='line'>        } else {
</span><span class='line'>            print("John's building identifier does not begin with \"The\".")
</span><span class='line'>        }
</span><span class='line'>}
</span><span class='line'>// æ‰“å° â€œJohn's building identifier begins with "The".â€</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Swift-è‡ªåŠ¨å¼•ç”¨è®¡æ•°]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/18/swift-zi-dong-yin-yong-ji-shu/"/>
    <updated>2016-03-18T11:17:07+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/18/swift-zi-dong-yin-yong-ji-shu</id>
    <content type="html"><![CDATA[<p>swiftä½¿ç”¨è‡ªåŠ¨å¼•ç”¨è®¡æ•°(ARC)æœºåˆ¶æ¥è·Ÿè¸ªå’Œç®¡ç†ä½ çš„åº”ç”¨ç¨‹åºçš„å†…å­˜ã€‚é€šå¸¸æƒ…å†µï¼ŒSwiftå†…å­˜ç®¡ç†æœºåˆ¶ä¼šä¸€ç›´èµ·ä½œç”¨ï¼Œä½ æ— éœ€è‡ªå·±æ¥è€ƒè™‘å†…å­˜çš„ç®¡ç†ã€‚ARCä¼šåœ¨ç±»çš„å®ä¾‹ä¸å†éœ€è¦æ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ã€‚
ç„¶ååœ¨å°‘æ•°çš„æƒ…å†µä¸‹ï¼Œä¸ºäº†èƒ½å¸®åŠ©ä½ ç®¡ç†å†…å­˜ï¼ŒARCéœ€è¦æ›´å¤šçš„ä»£ç ä¹‹é—´å…³ç³»çš„ä¿¡æ¯ã€‚</p>

<!--more-->


<blockquote><p><strong>æ³¨æ„:</strong>
å¼•ç”¨è®¡æ•°ä»…ä»…åº”ç”¨äºç±»çš„å®ä¾‹ã€‚ç»“æ„ä½“å’Œæšä¸¾ç±»å‹æ˜¯å±äºå€¼ç±»å‹ï¼Œä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œä¹Ÿä¸æ˜¯é€šè¿‡å¼•ç”¨çš„æ–¹å¼å­˜å‚¨å’Œä¼ é€’.</p></blockquote>

<h2>è‡ªåŠ¨å¼•ç”¨è®¡æ•°çš„å·¥ä½œæœºåˆ¶</h2>

<p>å½“ä½ æ¯æ¬¡åˆ›å»ºä¸€ä¸ªç±»çš„æ–°çš„å®ä¾‹çš„æ—¶å€™ï¼Œarcä¼šåˆ†é…ä¸€å—å†…å­˜æ¥å­˜å‚¨è¯¥å®ä¾‹ä¿¡æ¯ã€‚å†…å­˜ä¸­ä¼šåŒ…å«å®ä¾‹çš„ç±»å‹ä¿¡æ¯ï¼Œä»¥åŠè¿™ä¸ªå®ä¾‹æ‰€æœ‰ç›¸å…³çš„å±æ€§çš„å€¼ã€‚
æ­¤å¤–ï¼Œå½“å®ä¾‹ä¸åœ¨è¢«ä½¿ç”¨æ—¶ï¼ŒARCé‡Šæ”¾å®ä¾‹æ‰€å ç”¨çš„å†…å­˜ã€‚è¿™ç¡®ä¿äº†ä¸å†è¢«ä½¿ç”¨çš„å®ä¾‹ï¼Œä¸ä¼šä¸€ç›´å ç”¨å†…å­˜ç©ºé—´ã€‚</p>

<p>ç„¶è€Œï¼Œå½“ARCå›æ”¶å’Œé‡Šæ”¾äº†æ­£åœ¨è¢«ä½¿ç”¨ä¸­çš„å®ä¾‹ï¼Œè¯¥å®ä¾‹çš„å±æ€§å’Œæ–¹æ³•å°†ä¸å†è¢«è®¿é—®å’Œè°ƒç”¨ã€‚å®é™…ä¸Šï¼Œå¦‚æœä½ è¿˜è¯•å›¾è®¿é—®è¿™ä¸ªå®ä¾‹ï¼Œä½ çš„åº”ç”¨ç¨‹åºå¾ˆå¯èƒ½ä¼šå´©æºƒã€‚</p>

<p>ä¸ºäº†ç¡®ä¿ä½¿ç”¨ä¸­çš„å®ä¾‹ä¸ä¼šè¢«é”€æ¯ï¼ŒARCä¼šè·Ÿè¸ªå’Œè®¡ç®—æ¯ä¸€ä¸ªå®ä¾‹æ­£åœ¨è¢«å¤šå°‘å±æ€§ï¼Œå¸¸é‡å’Œå˜é‡æ‰€å¼•ç”¨ã€‚å“ªæ€•å®ä¾‹çš„å¼•ç”¨æ•°ä¸º1ï¼ŒARCéƒ½ä¸ä¼šé”€æ¯è¿™ä¸ªå®ä¾‹ã€‚</p>

<p>ä¸ºäº†ä½¿ä¸Šè¿°æˆä¸ºå¯èƒ½ï¼Œæ— è®ºä½ å°†å®ä¾‹èµ‹å€¼ç»™å±æ€§ï¼Œå¸¸é‡æˆ–è€…å˜é‡ï¼Œä»–ä»¬éƒ½ä¼š
åˆ›å»ºæ­¤å®ä¾‹çš„<code>å¼º</code>å¼•ç”¨,ä¹‹æ‰€ä»¥ç§°ä¸ºå¼ºå¼•ç”¨ï¼Œæ˜¯å› ä¸ºå®ƒä¼šå°†å®ä¾‹ç‰¢ç‰¢åœ°åŒ…åƒä½ï¼Œåªè¦å¼ºå¼•ç”¨è¿˜åœ¨ï¼Œå®ä¾‹æ˜¯ä¸å…è®¸è¢«é”€æ¯çš„ã€‚</p>

<h2>è‡ªåŠ¨å¼•ç”¨è®¡æ•°å®è·µ</h2>

<p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†è‡ªåŠ¨å¼•ç”¨è®¡æ•°çš„å·¥ä½œæœºåˆ¶ã€‚ä¾‹å­ä»¥ä¸€ä¸ªç®€å•çš„<code>Person</code>ç±»å¼€å§‹ï¼Œå¹¶å®šä¹‰äº†ä¸€ä¸ªå«<code>name</code>çš„å¸¸é‡å±æ€§:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Person {
</span><span class='line'>    let name: String
</span><span class='line'>    init(name: String) {
</span><span class='line'>        self.name = name
</span><span class='line'>        print("\(name) is being initialized")
</span><span class='line'>    }
</span><span class='line'>    deinit {
</span><span class='line'>        print("\(name) is being deinitialized")
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Personç±»æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæ­¤æ„é€ å‡½æ•°ä¸ºå®ä¾‹çš„<code>name</code>å±æ€§èµ‹å€¼ï¼Œå¹¶æ‰“å°ä¸€ä¸ªæ¶ˆæ¯è¡¨æ˜åˆå§‹åŒ–è¿‡ç¨‹ç”Ÿæ•ˆã€‚<code>Person</code>ç±»ä¹Ÿæ‹¥æœ‰ä¸€ä¸ªææ„å‡½æ•°ï¼Œè¿™ä¸ªææ„å‡½æ•°åœ¨å®ä¾‹è¢«é”€æ¯æ—¶æ‰“å°ä¸€æ¡æ¶ˆæ¯ã€‚</p>

<p>æ¥ä¸‹æ¥çš„ä»£ç ç‰‡æ®µå®šä¹‰äº†ä¸‰ä¸ªç±»å‹ä¸º<code>Person?</code>çš„å˜é‡ï¼Œä¸ºæ–°çš„<code>Person</code>å®ä¾‹å»ºç«‹äº†å¤šä¸ªå¼•ç”¨ã€‚ç”±äºè¿™äº›å˜é‡æ˜¯è¢«å®šä¹‰ä¸ºå¯é€‰ç±»å‹ï¼Œå®ƒä»¬çš„å€¼ä¼šè¢«è‡ªåŠ¨åˆå§‹åŒ–ä¸ºnil,ç›®å‰è¿˜ä¸ä¼šå¼•ç”¨åˆ°<code>Person</code>ç±»çš„å®ä¾‹ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var reference1: Person?
</span><span class='line'>var reference2: Person?
</span><span class='line'>var reference3: Person?</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨åˆ›å»ºPersonç±»çš„å®ä¾‹</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>reference1 = Person(name: "John Appleseed")
</span><span class='line'>// prints "John Appleseed is being initializedâ€</span></code></pre></td></tr></table></div></figure>


<p>åº”å½“æ³¨æ„åˆ°å½“ä½ è°ƒç”¨<code>Person</code>ç±»çš„æ„é€ å‡½æ•°çš„æ—¶å€™ï¼Œåˆå§‹åŒ–çš„ä¿¡æ¯è¢«æ‰“å°å‡ºæ¥ã€‚ç”±æ­¤å¯ä»¥ç¡®å®šæ„é€ å‡½æ•°è¢«æ‰§è¡Œã€‚</p>

<p>ç”±äº<code>Person</code>ç±»çš„æ–°å®ä¾‹è¢«èµ‹å€¼ç»™äº†<code>reference1</code>å˜é‡ï¼Œæ‰€ä»¥<code>reference1</code>åˆ°<code>Person</code>ç±»çš„æ–°å®ä¾‹ä¹‹é—´å»ºç«‹ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚æ­£æ˜¯å› ä¸ºè¿™ä¸€ä¸ªå¼ºå¼•ç”¨ï¼ŒARCä¼šä¿è¯<code>Person</code>å®ä¾‹è¢«ä¿æŒåœ¨å†…å­˜ä¸­ä¸è¢«é”€æ¯ã€‚</p>

<p>å¦‚æœä½ å°†åŒä¸€ä¸ª<code>Person</code>å®ä¾‹ä¹Ÿèµ‹å€¼ç»™å…¶å®ƒä¸¤ä¸ªå˜é‡ï¼Œè¯¥å®ä¾‹åˆä¼šå¤šå‡ºä¸¤ä¸ªå¼ºå¼•ç”¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>reference2 = reference1
</span><span class='line'>reference3 = reference1</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨è¿™ä¸ª <code>Person</code>å®ä¾‹æœ‰ä¸‰ä¸ªå¼ºå¼•ç”¨äº†ã€‚</p>

<p>å¦‚æœä½ é€šè¿‡ç»™å…¶ä¸­ä¸¤ä¸ªå˜é‡èµ‹å€¼<code>nil</code>çš„æ–¹å¼æ–­å¼€ä¸¤ä¸ªå¼ºå¼•ç”¨ï¼Œåªç•™ä¸‹ä¸€ä¸ªå¼ºå¼•ç”¨ï¼Œ<code>Person</code>å®ä¾‹ä¹Ÿä¸ä¼šè¢«é”€æ¯ã€‚</p>

<pre><code>reference1 = nil
reference2 = nil
</code></pre>

<p> åœ¨ä½ æ¸…æ¥šåœ°è¡¨æ˜ä¸å†ä½¿ç”¨è¿™ä¸ªPersonå®ä¾‹æ—¶ï¼Œç¬¬ä¸‰ä¸ªä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªå¼ºå¼•ç”¨è¢«æ–­å¼€æ—¶ï¼ŒARCä¼šé”€æ¯å®ƒ:</p>

<pre><code> reference3 = nil
// æ‰“å° â€œJohn Appleseed is being deinitializedâ€
</code></pre>

<h2>ç±»å®ä¾‹ä¹‹é—´çš„å¾ªç¯å¼ºå¼•ç”¨</h2>

<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒARCä¼šè·Ÿè¸ªä½ æ‰€æ–°åˆ›å»ºçš„<code>Person</code>å®ä¾‹çš„å¼•ç”¨æ•°é‡ï¼Œå¹¶ä¸”ä¼šåœ¨<code>Person</code>å®ä¾‹ä¸å†è¢«éœ€è¦æ—¶é”€æ¯å®ƒã€‚</p>

<p>ç„¶è€Œï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™å‡ºä¸€ä¸ªç±»å®ä¾‹çš„å¼ºå¼•ç”¨æ°¸è¿œä¸èƒ½å˜æˆ0çš„ä»£ç ã€‚å¦‚æœä¸¤ä¸ªç±»å®ä¾‹äº’ç›¸æ‹¥æœ‰å¯¹æ–¹çš„å¼ºå¼•ç”¨ï¼Œå› è€Œæ¯ä¸ªå®ä¾‹éƒ½è®©å¯¹æ–¹ä¸€ç›´å­˜åœ¨ï¼Œå°±æ˜¯è¿™ç§æƒ…å†µã€‚è¿™å°±æ˜¯æ‰€è°“çš„å¼ºå¼•ç”¨ã€‚</p>

<p>ä½ å¯ä»¥é€šè¿‡å®šä¹‰ç±»ä¹‹é—´çš„å…³ç³»ä¸ºå¼±å¼•ç”¨æˆ–è€…æ— ä¸»å¼•ç”¨ï¼Œæ¥é¿å…å¼ºå¼•ç”¨ã€‚ä¸ç®¡æ€æ ·ï¼Œè®©æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹å®ƒæ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚</p>

<p>ä¸‹é¢å±•ç¤ºä¸€ä¸ªä¸ç»æ„äº§ç”Ÿå¾ªç¯å¼ºå¼•ç”¨çš„ä¾‹å­ã€‚ä¾‹å­å®šä¹‰äº†ä¸¤ä¸ªç±»:<code>person</code>å’Œ<code>Apartment</code>,ç”¨æ¥å»ºæ¨¡å…¬å¯“å’Œå®ƒå…¶ä¸­çš„å±…æ°‘:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Person {
</span><span class='line'>    let name: String
</span><span class='line'>    init(name: String) { self.name = name }
</span><span class='line'>    var apartment: Apartment?
</span><span class='line'>    deinit { print("\(name) is being deinitialized") }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Apartment {
</span><span class='line'>    let unit: String
</span><span class='line'>    init(unit: String) { self.unit = unit }
</span><span class='line'>    var tenant: Person?
</span><span class='line'>    deinit { print("Apartment \(unit) is being deinitialized") }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æ¯ä¸€ä¸ª<code>Person</code>å®ä¾‹æœ‰ä¸€ä¸ªç±»å‹ä¸º<code>String</code>,åå­—ä¸º<code>name</code>çš„å±æ€§ï¼Œå¹¶æœ‰ä¸€ä¸ªå¯é€‰çš„åˆå§‹åŒ–ä¸ºnilçš„<code>apartment</code>å±æ€§ã€‚<code>apartment</code>å±æ€§æ˜¯å¯é€‰çš„ï¼Œå› ä¸ºä¸€ä¸ªäººå¹¶ä¸æ€»æ˜¯æ‹¥æœ‰å…¬å¯“ã€‚</p>

<p>ç±»ä¼¼çš„ï¼Œæ¯ä¸ª<code>Apartment</code>å®ä¾‹æœ‰ä¸ªå«<code>unit</code>,ç±»å‹ä¸ºStringçš„å±æ€§ï¼Œå¹¶æœ‰ä¸€ä¸ªå¯é€‰çš„åˆå§‹åŒ–ä¸ºnilçš„<code>tenant</code>å±æ€§ã€‚<code>tenant</code>å±æ€§æ˜¯å¯é€‰çš„ï¼Œå› ä¸ºä¸€æ ‹å…¬å¯“å¹¶ä¸æ€»æ˜¯æœ‰å±…æ°‘ã€‚</p>

<p>è¿™ä¸¤ä¸ªç±»éƒ½å®šä¹‰äº†ææ„å‡½æ•°ï¼Œç”¨ä»¥åœ¨ç±»å®ä¾‹è¢«ææ„çš„æ—¶å€™è¾“å‡ºä¿¡æ¯ã€‚è¿™èƒ½è®©ä½ çŸ¥é“<code>Person</code>å’Œ<code>Apartment</code>çš„å®ä¾‹æ˜¯å¦åƒé¢„æœŸé‚£æ ·è¢«é”€æ¯ã€‚</p>

<p>æ¥ä¸‹æ¥çš„ä»£ç ç‰‡æ®µä¸­å®šä¹‰äº†ä¸¤ä¸ªå¯é€‰ç±»å‹çš„å˜é‡<code>john</code>å’Œ<code>unit4A</code>,å¹¶åˆ†åˆ«è¢«è®¾å®šä¸ºä¸‹é¢çš„çš„<code>Apartment</code>å’Œ<code>Person</code>çš„å®ä¾‹ã€‚è¿™ä¸¤ä¸ªå˜é‡éƒ½è¢«åˆå§‹åŒ–ä¸ºnil:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var john: Person?
</span><span class='line'>var unit4A: Apartment?
</span><span class='line'>
</span><span class='line'>john = Person(name: "John Appleseed")
</span><span class='line'>unit4A = Apartment(unit: "4A")</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ä¸¤ä¸ªå®ä¾‹è¢«åˆ›å»ºå’Œèµ‹å€¼åï¼Œä¸‹é¢è¡¨ç°äº†å¼ºå¼•ç”¨çš„å…³ç³»ã€‚å˜é‡<code>john</code>ç°åœ¨æœ‰ä¸ªæŒ‡å‘<code>Person</code>å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œè€Œå˜é‡<code>unit4A</code>æœ‰ä¸€ä¸ªæŒ‡å‘<code>Apartment</code>å®ä¾‹çš„å¼ºå¼•ç”¨:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/referenceCycle01_2x.png" alt="logo" />
ç°åœ¨ï¼Œä½ èƒ½å¤Ÿå°†ä¸¤ä¸ªå®ä¾‹å…³è”åœ¨ä¸€èµ·äº†ï¼Œè¿™æ ·äººå°±èƒ½æœ‰å…¬å¯“ä½äº†ï¼Œè€Œå·¥å…·ä¹Ÿæœ‰äº†æˆ¿å®¢ã€‚æ³¨æ„æ„Ÿå¹å·æ˜¯ç”¨æ¥å±•å¼€å’Œè®¿é—®å¯é€‰å˜é‡<code>john</code>å’Œ<code>unit4A</code>ä¸­çš„å®ä¾‹ï¼Œè¿™æ ·å®ä¾‹çš„å±æ€§æ‰èƒ½è¢«èµ‹å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>john!.apartment = unit4A
</span><span class='line'>unit4A!.tenant = john</span></code></pre></td></tr></table></div></figure>


<p>åœ¨å°†ä¸¤ä¸ªå®ä¾‹è”ç³»åœ¨ä¸€èµ·åï¼Œå¼ºå¼•ç”¨çš„å…³ç³»å¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/referenceCycle02_2x.png" alt="logo" /></p>

<p>ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªå®ä¾‹å…³è”åä¼šäº§ç”Ÿä¸€ä¸ªå¾ªç¯å¼ºå¼•ç”¨ï¼Œ<code>Person</code>ç±»ç°åœ¨æœ‰äº†ä¸€ä¸ªæŒ‡å‘<code>Apartment</code>å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œè€Œ<code>Apartment</code>å®ä¾‹ä¹Ÿæœ‰äº†ä¸€ä¸ªæŒ‡å‘<code>Person</code>çš„å¼ºå¼•ç”¨ï¼Œå› æ­¤ï¼Œå½“ä½ æ–­å¼€<code>john</code>å’Œ<code>uni4A</code>å˜é‡æ‰€æŒæœ‰çš„å¼ºå¼•ç”¨æ—¶ï¼Œå¼•ç”¨è®¡æ•°å¹¶ä¸ä¼šé™åˆ°0.å®ä¾‹ä¹Ÿä¸ä¼šè¢«é”€æ¯ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>john = nil
</span><span class='line'>unit4A = nil</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>æ³¨æ„:</strong>å½“ä½ æŠŠè¿™ä¸¤ä¸ªå˜é‡è®¾ç½®ä¸ºnilæ—¶ï¼Œæ²¡æœ‰ä»»ä½•ä¸€ä¸ªææ„å‡½æ•°è¢«è°ƒç”¨ï¼Œå¾ªç¯å¼ºå¼•ç”¨ä¼šä¸€ç›´é˜»æ­¢<code>Person</code>å’Œ<code>Apartment</code>ç±»å®ä¾‹è¢«é”€æ¯ï¼Œè¿™æ—¢æ˜¯ä½ åº”ç”¨ç¨‹åºä¸­é€ æˆçš„å†…å­˜æ³„éœ²ã€‚</p></blockquote>

<p>åœ¨ä½ å°†<code>john</code>å’Œ<code>unit4A</code>è®¾ç½®ä¸ºnilåï¼Œå¼ºåº”ç”¨å…³ç³»å¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/referenceCycle03_2x.png" alt="logo" /></p>

<p>Personå’ŒApartmentå®ä¾‹ä¹‹é—´çš„å¼ºå¼•ç”¨å…³ç³»ä¿ç•™äº†ä¸‹æ¥å¹¶ä¸”ä¸ä¼šè¢«æ–­å¼€ã€‚</p>

<h2>è§£å†³å®ä¾‹ä¹‹é—´çš„å¾ªç¯å¼ºå¼•ç”¨</h2>

<p>swiftæä¾›äº†ä¸¤ç§æ–¹æ³•ç”¨æ¥è§£å†³åœ¨ä½ ä½¿ç”¨ç±»çš„å±æ€§æ—¶é‡åˆ°çš„å¾ªç¯å¼ºå¼•ç”¨çš„é—®é¢˜ï¼šå¼±å¼•ç”¨(weak refrence)å’Œæ— ä¸»å¼•ç”¨(unowned refrecnce).</p>

<p>å¼±å¼•ç”¨å’Œæ— ä¸»å¼•ç”¨å…è®¸å¾ªç¯å¼•ç”¨ä¸­çš„ä¸€ä¸ªå®ä¾‹å¼•ç”¨å¦å¤–ä¸€ä¸ªå®ä¾‹è€Œä¸åŒ…åƒå¼ºå¼•ç”¨ã€‚è¿™æ ·å®ä¾‹èƒ½å¤Ÿäº’ç›¸å¼•ç”¨è€Œä¸äº§ç”Ÿå¾ªç¯å¼ºå¼•ç”¨ã€‚</p>

<p>å¯¹äºç”Ÿå‘½å‘¨æœŸä¸­ä¼šå˜æˆnilçš„å®ä¾‹ä½¿ç”¨å¼±å¼•ç”¨ã€‚ç›¸ååœ°ï¼Œå¯¹äºåˆå§‹åŒ–èµ‹å€¼åå†ä¹Ÿä¸ä¼šç»™èµ‹å€¼ä¸ºnilçš„å®ä¾‹ï¼Œä½¿ç”¨æ— ä¸»å¼•ç”¨ã€‚</p>

<h3>å¼±å¼•ç”¨</h3>

<p>å¼±å¼•ç”¨ä¸ä¼šå¯¹å…¶å¼•ç”¨çš„å®ä¾‹ä¿æŒå¼ºå¼•ç”¨ï¼Œå› è€Œä¸ä¼šé˜»æ­¢ARCé”€æ¯è¢«å¼•ç”¨çš„å®ä¾‹ã€‚è¿™ä¸ªç‰¹æ€§é˜»æ­¢äº†å¼•ç”¨å˜ä¸ºå¾ªç¯å¼ºå¼•ç”¨ã€‚å£°æ˜å±æ€§æˆ–è€…å˜é‡æ—¶ï¼Œåœ¨å‰é¢åŠ ä¸Š<code>weak</code>å…³é”®å­—è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ã€‚</p>

<p>åœ¨å®ä¾‹çš„å£°æ˜å‘¨æœŸä¸­ï¼Œå¦‚æœæŸäº›æ—¶å€™å¼•ç”¨æ²¡æœ‰å€¼ï¼Œé‚£ä¹ˆå¼±å¼•ç”¨å¯ä»¥é¿å…å¾ªç¯å¼ºå¼•ç”¨ã€‚å¦‚æœå¼•ç”¨æ€»æ˜¯æœ‰å€¼ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ— ä¸»æ˜“ç”¨ã€‚åœ¨ä¸Šé¢<code>Apartment</code>çš„ä¾‹å­ä¸­ï¼Œä¸€ä¸ªå…¬å¯“çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæœ‰æ—¶æ˜¯æ²¡æœ‰â€˜å±…æ°‘â€™çš„ï¼Œå› æ­¤é€‚åˆä½¿ç”¨å¼±å¼•ç”¨æ¥è§£å†³å¾ªç¯å¼ºå¼•ç”¨ã€‚</p>

<blockquote><blockquote><p><em>æ³¨æ„</em>
å¼±å¼•ç”¨å¿…é¡»è¢«å£°æ˜ä¸ºå˜é‡ï¼Œè¡¨æ˜å…¶å€¼åœ¨è¿è¡Œæ—¶ä¼šè¢«ä¿®æ”¹ï¼Œè‹¥å¼•ç”¨
ä¸èƒ½è¢«å£°æ˜ä¸ºå¸¸é‡ã€‚</p>

<p>å› ä¸ºå¼±å¼•ç”¨å¯ä»¥æ²¡æœ‰å€¼ï¼Œä½ å¿…é¡»å°†æ¯ä¸€ä¸ªå¼±å¼•ç”¨å£°æ˜ä¸ºå¯é€‰ç±»å‹ã€‚åœ¨Swiftä¸­ï¼Œæ¨èä½¿ç”¨å¯é€‰ç±»å‹æè¿°å¯èƒ½æ²¡æœ‰å€¼çš„ç±»å‹ã€‚</p></blockquote></blockquote>

<p>å› ä¸ºå¼±å¼•ç”¨ä¸ä¼šæ›¹æ¤æ‰€å¼•ç”¨çš„å®ä¾‹ï¼Œå³ä½¿å¼•ç”¨å­˜åœ¨ï¼Œå®ä¾‹ä¹Ÿæœ‰å¯èƒ½è¢«é”€æ¯ã€‚å› æ­¤ï¼ŒARCä¼šåœ¨å¼•ç”¨çš„å®ä¾‹è¢«é”€æ¯åè‡ªåŠ¨å°†å…¶èµ‹å€¼ä¸ºnil.ä½ å¯ä»¥åƒå…¶ä»–å¯é€‰å€¼ä¸€æ ·ï¼Œæ£€æŸ¥å¼±å¼•ç”¨çš„å€¼æ˜¯å¦å­˜åœ¨ï¼Œä½ è®²æ°¸è¿œä¸ä¼šè®¿é—®å·²é”€æ¯çš„å®ä¾‹çš„å¼•ç”¨ã€‚</p>

<p>ä¸‹é¢çš„ä¾‹å­è·Ÿä¸Šé¢ <code>person</code>å’Œ<code>Apartment</code>çš„ä¾‹å­ä¸€è‡´ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ã€‚è¿™ä¸€æ¬¡ï¼Œ<code>Apartment</code>çš„<code>tenant</code>    å±æ€§è¢«å£°æ˜ä¸ºå¼±å¼•ç”¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Person {
</span><span class='line'>    let name: String
</span><span class='line'>    init(name: String) { self.name = name }
</span><span class='line'>    var apartment: Apartment?
</span><span class='line'>    deinit { print("\(name) is being deinitialized") }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Apartment {
</span><span class='line'>    let unit: String
</span><span class='line'>    init(unit: String) { self.unit = unit }
</span><span class='line'>    weak var tenant: Person?
</span><span class='line'>    deinit { print("Apartment \(unit) is being deinitialized") }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åè·Ÿä¹‹å‰ä¸€æ ·ï¼Œå»ºç«‹ä¸¤ä¸ªå˜é‡(johnå’Œunit4A)ä¹‹é—´çš„å¼ºå¼•ç”¨ï¼Œå¹¶å…³è”ä¸¤ä¸ªå®ä¾‹ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var john: Person?
</span><span class='line'>var unit4A: Apartment?
</span><span class='line'>
</span><span class='line'>john = Person(name: "John Appleseed")
</span><span class='line'>unit4A = Apartment(unit: "4A")
</span><span class='line'>
</span><span class='line'>john!.apartment = unit4A
</span><span class='line'>unit4A!.tenant = john</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œä¸¤ä¸ªå…³è”åœ¨ä¸€èµ·çš„å®ä¾‹çš„å¼•ç”¨å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/weakReference01_2x.png" alt="logo" /></p>

<p><code>Person</code>å®ä¾‹ä¾ç„¶ä¿æŒå¯¹<code>Apartment</code>å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œä½†æ˜¯<code>Apartment</code>å®ä¾‹åªæŒæœ‰å¯¹<code>Person</code>å®ä¾‹çš„å¼±å¼•ç”¨ã€‚è¿™æ„å‘³ç€å½“ä½ æ–­å¼€<code>john</code>å˜é‡æ‰€ä¿æŒçš„å¼ºå¼•ç”¨æ—¶ï¼Œå†ä¹Ÿæ²¡æœ‰æŒ‡å‘<code>Person</code>å®ä¾‹çš„å¼ºå¼•ç”¨äº†ï¼š
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/weakReference02_2x.png" alt="logo" /></p>

<p>ç”±äºå†ä¹Ÿæ²¡æœ‰æŒ‡å‘<code>Person</code>å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œè¯¥å®ä¾‹ä¼šè¢«é”€æ¯:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>john = nil
</span><span class='line'>// æ‰“å° â€œJohn Appleseed is being deinitializedâ€</span></code></pre></td></tr></table></div></figure>


<p>å”¯ä¸€å‰©ä¸‹æŒ‡å‘<code>Apartment</code>å®ä¾‹çš„å¼ºå¼•ç”¨æ¥è‡ªå˜é‡<code>unit4A</code>ã€‚å¦‚æœä½ æ–­å¼€è¿™ä¸ªå¼ºå¼•ç”¨ï¼Œå†ä¹Ÿæ²¡æœ‰æŒ‡å‘<code>Apartment</code>å®ä¾‹çš„å¼ºå¼•ç”¨äº†:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/weakReference03_2x.png" alt="logo" />
ç”±äºå†ä¹Ÿæ²¡æœ‰æŒ‡å‘<code>Apartment</code>å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œè¯¥å®ä¾‹ä¹Ÿä¼šè¢«é”€æ¯:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>unit4A = nil
</span><span class='line'>// æ‰“å° â€œApartment 4A is being deinitializedâ€</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä¸¤æ®µä»£ç å±•ç¤ºäº†å˜é‡<code>john</code>å’Œ<code>unit4A</code>åœ¨è¢«èµ‹å€¼ä¸º<code>nil</code>åï¼Œ<code>Person</code>å®ä¾‹å’Œ<code>Apartment</code>å®ä¾‹çš„ææ„å‡½æ•°éƒ½æ‰“å°å‡ºäº†â€œé”€æ¯â€çš„ä¿¡æ¯ã€‚
è¿™è¯æ˜äº†å¼•ç”¨å¾ªç¯è¢«æ‰“ç ´äº†ã€‚</p>

<h3>æ— ä¸»å¼•ç”¨</h3>

<p>å’Œå¼±å¼•ç”¨ç±»ä¼¼ï¼Œæ— ä¸»å¼•ç”¨ä¸ä¼šç‰¢ç‰¢ä¿æŒä½å¼•ç”¨çš„å®ä¾‹ã€‚å’Œå¼±å¼•ç”¨ä¸åŒçš„æ˜¯ï¼Œæ— ä¸»å¼•ç”¨æ˜¯æ°¸è¿œæœ‰å€¼çš„ã€‚å› æ­¤ï¼Œæ— ä¸»å¼•ç”¨æ€»æ˜¯è¢«å®šä¹‰ä¸ºéå¯é€‰ç±»å‹.ä½ å¯ä»¥åœ¨å£°æ˜å±æ€§æˆ–è€…å˜é‡æ—¶ï¼Œåœ¨å‰é¢åŠ ä¸Šå…³é”®å­— <code>unowned</code>è¡¨ç¤ºè¿™ä¸ªä¸€ä¸ªæ— ä¸»å¼•ç”¨ã€‚</p>

<p>ç”±äºæ— ä¸»å¼•ç”¨æ˜¯éå¯é€‰ç±»å‹ï¼Œä½ ä¸éœ€è¦å†ä½¿ç”¨å®ƒçš„æ—¶å€™å°†å®ƒå±•å¼€ã€‚æ— ä¸»å¼•ç”¨æ€»æ˜¯å¯ä»¥è¢«ç›´æ¥è®¿é—®ã€‚ä¸è¿‡ARCæ— æ³•å†å®ä¾‹è¢«é”€æ¯åå°†æ— ä¸»å¼•ç”¨è®¾ä¸º<code>nil</code>,å› ä¸ºéå¯é€‰ç±»å‹çš„å˜é‡ä¸å…è®¸è¢«èµ‹å€¼ä¸º<code>nil</code>.</p>

<blockquote><p><strong>æ³¨æ„:</strong>å¦‚æœä½ è¯•å›¾åœ¨å®ä¾‹è¢«é”€æ¯åï¼Œè®¿é—®è¯¥å®ä¾‹çš„æ— ä¸»å¼•ç”¨ï¼Œä¼šå‡ºå‘è¿è¡Œæ—¶é”™è¯¯ã€‚ä½¿ç”¨æ— ä¸»å¼•ç”¨ï¼Œä½ å¿…é¡»ç¡®ä¿å¼•ç”¨å§‹ç»ˆæŒ‡å‘ä¸€ä¸ªæœªé”€æ¯çš„å®ä¾‹ã€‚
è¿˜éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä½ è¯•å›¾è®¿é—®å®ä¾‹å·²ç»è¢«é”€æ¯çš„æ— ä¸»å¼•ç”¨ï¼ŒSwiftç¡®ä¿ç¨‹åºä¼šç›´æ¥å´©æºƒï¼Œè€Œä¸ä¼šå‘ç”Ÿæ— æ³•é¢„æœŸçš„è¡Œä¸ºã€‚æ‰€ä»¥ä½ åº”å½“é¿å…è¿™æ ·çš„äº‹æƒ…å‘ç”Ÿã€‚</p>

<p>ä¸‹é¢çš„ä¾‹å­å®šä¹‰ä¸¤ä¸ªç±»ï¼Œ<code>Customer</code>å’Œ<code>CrediCard</code>ï¼Œæ¨¡æ‹Ÿäº†é“¶è¡Œå®¢æˆ·å’Œå®¢æˆ·çš„ä¿¡ç”¨å¡ã€‚è¿™ä¸¤ä¸ªç±»ä¸­ï¼Œæ¯ä¸€ä¸ªéƒ½å°†å¦å¤–ä¸€ä¸ªç±»çš„å®ä¾‹ä½œä¸ºè‡ªèº«çš„å±æ€§ã€‚è¿™ç§å…³ç³»å¯èƒ½ä¼šé€ æˆå¾ªç¯å¼ºå¼•ç”¨ã€‚</p></blockquote>

<p><code>Customer</code>å’Œ<code>CrediCard</code>ä¹‹é—´çš„å…³ç³»ä¸å‰é¢è‹¥å¼•ç”¨ä¾‹å­ä¸­<code>Apartment</code>å’Œ<code>Person</code>çš„å…³ç³»ç•¥ä¸ºä¸åŒã€‚åœ¨è¿™ä¸ªæ•°æ®æ¨¡å‹ä¸­ï¼Œä¸€ä¸ªå®¢æˆ·å¯èƒ½æœ‰æˆ–è€…æ²¡æœ‰ä¿¡ç”¨å¡ï¼Œä½†æ˜¯ä¸€å¼ ä¿¡ç”¨å¡æ€»æ˜¯å…³è”ç€ä¸€ä¸ªå®¢æˆ·ã€‚ä¸ºäº†è¡¨ç¤ºè¿™ç§å…³ç³»ï¼Œ<code>Customer</code>ç±»æœ‰ä¸€ä¸ªå¯é€‰ç±»å‹çš„<code>Card</code>å±æ€§ï¼Œä½†æ˜¯<code>CreditCard</code>ç±»æœ‰ä¸ªä¸€éå¯é€‰ç±»å‹çš„<code>Customer</code>å±æ€§ã€‚</p>

<p>æ­¤å¤–ï¼Œåªèƒ½é€šè¿‡å°†ä¸€ä¸ª<code>number</code>å€¼å’Œ<code>customer</code>å®ä¾‹ä¼ é€’ç»™<code>CreditCard</code>æ„é€ å‡½æ•°çš„æ–¹å¼æ¥åˆ›å»º<code>CreditCard</code>å®ä¾‹ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿å½“åˆ›å»º<code>CreditCard</code>å®ä¾‹æ—¶æ€»æ˜¯æœ‰ä¸€ä¸ª<code>customer</code>å®ä¾‹ä¸ä¹‹å…³è”.</p>

<p>ç”±äºä¿¡ç”¨å¡æ€»æ˜¯å…³è”ç€ä¸€ä¸ªå®¢æˆ·ï¼Œå› æ­¤å°†<code>customer</code>å±æ€§å®šä¹‰ä¸ºæ— ä¸»å¼•ç”¨ï¼Œç”¨ä»¥é¿å…å¾ªç¯å¼ºå¼•ç”¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Customer {
</span><span class='line'>    let name: String
</span><span class='line'>    var card: CreditCard?
</span><span class='line'>    init(name: String) {
</span><span class='line'>        self.name = name
</span><span class='line'>    }
</span><span class='line'>    deinit { print("\(name) is being deinitialized") }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CreditCard {
</span><span class='line'>    let number: UInt64
</span><span class='line'>    unowned let customer: Customer
</span><span class='line'>    init(number: UInt64, customer: Customer) {
</span><span class='line'>        self.number = number
</span><span class='line'>        self.customer = customer
</span><span class='line'>    }
</span><span class='line'>    deinit { print("Card #\(number) is being deinitialized") }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸‹é¢çš„ä»£ç æ®µå®šä¹‰äº†ä¸€ä¸ªå«<code>john</code>çš„å¯é€‰ç±»å‹<code>Customer</code>å˜é‡ï¼Œç”¨æ¥ä¿å­˜æŸä¸ªç‰¹å®šå®¢æˆ·çš„å¼•ç”¨ã€‚ç”±äºæ˜¯å¯é€‰ç±»å‹ï¼Œæ‰€ä»¥å˜é‡è¢«åˆå§‹åŒ–ä¸º<code>nil</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var john: Customer?</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ä½ å¯ä»¥åˆ›å»º<code>Customer</code>ç±»çš„å®ä¾‹ï¼Œç”¨å®ƒåˆå§‹åŒ–<code>CreditCard</code>å®ä¾‹ï¼Œå¹¶å°†æ–°åˆ›å»ºçš„<code>CreditCard</code>å®ä¾‹èµ‹å€¼ä¸ºå®¢æˆ·çš„<code>card</code>å±æ€§:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>john = Customer(name: "John Appleseed")
</span><span class='line'>john!.card = CreditCard(number: 1234_5678_9012_3456, customer: john!)</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ä½ å…³è”ä¸¤ä¸ªå®ä¾‹åï¼Œå®ƒä»¬çš„å¼•ç”¨å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/unownedReference01_2x.png" alt="logo" /></p>

<p><code>Customer</code>å®ä¾‹æŒæœ‰å¯¹<code>CreditCard</code>å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œè€Œ<code>CreditCard</code>å®ä¾‹æŒæœ‰å¯¹<code>Customer</code>å®ä¾‹çš„æ— ä¸»å¼•ç”¨ã€‚
ç”±äº<code>Customer</code>çš„æ— ä¸»å¼•ç”¨ï¼Œå½“ä½ æ–­å¼€<code>john</code>å˜é‡æŒæœ‰çš„å¼ºå¼•ç”¨æ—¶ï¼Œå†ä¹Ÿæ²¡æœ‰æŒ‡å‘<code>Customer</code>å®ä¾‹çš„å¼ºå¼•ç”¨äº†ï¼š
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/unownedReference02_2x.png" alt="logo" /></p>

<p>ç”±äºå†ä¹Ÿæ²¡æœ‰æŒ‡å‘<code>Customer</code>å®ä¾‹çš„å¼ºå¼•ç”¨äº†ï¼Œè¯¥å®ä¾‹è¢«é”€æ¯äº†ï¼Œå…¶åï¼Œå†ä¹Ÿæ²¡æœ‰æŒ‡å‘<code>CreditCard</code>å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œè¯¥å®ä¾‹ä¹Ÿéšä¹‹è¢«é”€æ¯äº†ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>john = nil
</span><span class='line'>// æ‰“å° â€œJohn Appleseed is being deinitializedâ€
</span><span class='line'>// æ‰“å° â€Card #1234567890123456 is being deinitializedâ€</span></code></pre></td></tr></table></div></figure>


<p>æœ€åçš„ä»£ç å±•ç¤ºäº†åœ¨<code>john</code>å˜é‡è¢«è®¾ä¸º<code>nil</code>å<code>Customer</code>å®ä¾‹å’Œ<code>CreditCard</code>å®ä¾‹çš„æ„é€ å‡½æ•°éƒ½æ‰“å°å‡ºäº†"é”€æ¯"çš„ä¿¡æ¯.</p>

<h3>æ— ä¸»å¼•ç”¨ä»¥åŠéšå¼è§£æå¯é€‰å±æ€§</h3>

<p>ä¸Šé¢å¼±å¼•ç”¨å’Œæ— ä¸»å¼•ç”¨çš„ä¾‹å­æ¶µç›–äº†ä¸¤ç§å¸¸ç”¨çš„éœ€è¦æ‰“ç ´å¾ªç¯å¼ºå¼•ç”¨çš„åœºæ™¯ã€‚
<code>Person</code>å’Œ<code>Apartment</code>çš„ä¾‹å­å±•ç¤ºäº†ä¸¤ä¸ªå±æ€§çš„å€¼éƒ½å…è®¸ä¸º<code>nil</code>,å¹¶ä¼šæ½œåœ¨çš„äº§ç”Ÿå¾ªç¯å¼ºå¼•ç”¨ã€‚è¿™ç§åœºæ™¯æœ€é€‚åˆç”¨å¼±å¼•ç”¨æ¥è§£å†³ã€‚</p>

<p><code>Customer</code>å’Œ<code>CreditCard</code>çš„ä¾‹å­å±•ç¤ºäº†ä¸€ä¸ªå±æ€§çš„å€¼å…è®¸ä¸º<code>nil</code>,è€Œå¦ä¸€ä¸ªå±æ€§çš„å€¼ä¸å…è®¸ä¸º<code>nil</code>,è¿™ä¹Ÿå¯èƒ½ä¼šäº§ç”Ÿå¾ªç¯å¼ºå¼•ç”¨ã€‚è¿™ç§åœºæ™¯æœ€é€‚åˆé€šè¿‡æ— ä¸»å¼•ç”¨æ¥è§£å†³ã€‚</p>

<p>ç„¶è€Œï¼Œå­˜åœ¨ç€ç¬¬ä¸‰ç§åœºæ™¯ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä¸¤ä¸ªå±æ€§éƒ½å¿…é¡»æœ‰å€¼ï¼Œå¹¶ä¸”åˆå§‹åŒ–å®Œæˆæ°¸è¿œä¸ä¼šä¸º<code>nil</code>.åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œéœ€è¦ä¸€ä¸ªç±»ä½¿ç”¨æ— ä¸»å±æ€§ï¼Œè€Œå¦å¤–ä¸€ä¸ªç±»ä½¿ç”¨éšå¼è§£æå¯é€‰å±æ€§ã€‚</p>

<p>è¿™ä½¿ä¸¤ä¸ªå±æ€§åœ¨åˆå§‹åŒ–å®Œæˆåèƒ½è¢«ç›´æ¥è®¿é—®,åŒæ—¶é¿å…äº†å¾ªç¯äº†å¼•ç”¨ã€‚</p>

<p>ä¸‹é¢çš„ä¾‹å­å®šä¹‰äº†ä¸¤ä¸ªç±»ï¼Œ<code>Country</code>å’Œ<code>City</code>ï¼Œæ¯ä¸ªç±»å°†å¦å¤–ä¸€ä¸ªç±»çš„å®ä¾‹ä¿å­˜ä¸ºå±æ€§ã€‚åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œæ¯ä¸ªå›½å®¶å¿…é¡»æœ‰é¦–éƒ½ï¼Œæ¯ä¸ªåŸå¸‚å¿…é¡»å±äºä¸€ä¸ªå›½å®¶ã€‚ä¸ºäº†å®ç°è¿™ç§å…³ç³»ï¼Œ<code>Country</code>ç±»æ‹¥æœ‰ä¸€ä¸ª<code>capitalCity</code>å±æ€§ï¼Œè€Œ<code>City</code>ç±»æœ‰ä¸€ä¸ª<code>Country</code>å±æ€§:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Country {
</span><span class='line'>    let name: String
</span><span class='line'>    var capitalCity: City!
</span><span class='line'>    init(name: String, capitalName: String) {
</span><span class='line'>        self.name = name
</span><span class='line'>        self.capitalCity = City(name: capitalName, country: self)
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class City {
</span><span class='line'>    let name: String
</span><span class='line'>    unowned let country: Country
</span><span class='line'>    init(name: String, country: Country) {
</span><span class='line'>        self.name = name
</span><span class='line'>        self.country = country
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†å»ºäº†ä¸¤ä¸ªç±»çš„ä¾èµ–å…³ç³»ï¼Œ<code>City</code>çš„æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ª<code>Country</code>å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”å°†å®ä¾‹ä¿å­˜åˆ°<code>country</code>å±æ€§ã€‚</p>

<p><code>Country</code>çš„æ„é€ å‡½æ•°è°ƒç”¨äº†<code>City</code>çš„æ„é€ å‡½æ•°ã€‚ç„¶è€Œï¼Œåªæœ‰<code>Country</code>çš„å®ä¾‹å®Œå…¨åˆå§‹åŒ–åï¼Œ<code>Country</code>çš„æ„é€ å‡½æ•°æ‰èƒ½æŠŠ<code>self</code>ä¼ ç»™<code>City</code>çš„æ„é€ å‡½æ•°ã€‚</p>

<p>ä¸ºäº†æ»¡è¶³è¿™ç§éœ€æ±‚ï¼Œé€šè¿‡åœ¨ç±»å‹ç»“å°¾å¤„åŠ ä¸Šæ„Ÿå¹å· ï¼ˆCity!ï¼‰ çš„æ–¹å¼ï¼Œå°†<code>Country</code>çš„<code>capitalCity</code>å±æ€§å£°æ˜ä¸ºéšå¼è§£æå¯é€‰ç±»å‹çš„å±æ€§ã€‚è¿™æ„å‘³ç€åƒå…¶ä»–å¯é€‰ç±»å‹ä¸€æ ·ï¼Œ<code>capitalCity</code>å±æ€§çš„é»˜è®¤å€¼ä¸º<code>nil</code>,ä½†æ˜¯ä¸éœ€è¦å±•å¼€å®ƒçš„å€¼å°±èƒ½è®¿é—®å®ƒ.</p>

<p>ç”±äº<code>capitalCity</code>é»˜è®¤å€¼æ˜¯nil,ä¸€æ—¦<code>Country</code>çš„å®ä¾‹åœ¨æ„é€ å‡½æ•°ä¸­ç»™<code>name</code>å±æ€§èµ‹å€¼åï¼Œæ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹å°±å®Œæˆäº†ã€‚è¿™æ„å‘³ç€ä¸€æ—¦<code>name</code>å±æ€§è¢«èµ‹å€¼åï¼Œ<code>Country</code>çš„æ„é€ å‡½æ•°å°±èƒ½å¼•ç”¨å¹¶ä¼ é€’éšå¼çš„<code>self</code>ã€‚<code>Country</code>çš„æ„é€ å‡½æ•°åœ¨èµ‹å€¼<code>capitalCity</code>æ—¶ï¼Œå°±èƒ½å°†<code>self</code>ä½œä¸ºå‚æ•°ä¼ é€’ç»™<code>City</code>çš„æ„é€ å‡½æ•°ã€‚</p>

<p>ä»¥ä¸Šçš„æ„ä¹‰åœ¨äºä½ å¯ä»¥é€šè¿‡ä¸€æ¡è¯­å¥åŒæ—¶åˆ›å»º<code>Country</code>å’Œ<code>City</code>çš„å®ä¾‹ï¼Œè€Œä¸äº§ç”Ÿå¾ªç¯å¼ºå¼•ç”¨ï¼Œå¹¶ä¸”<code>capitalCity</code>çš„å±æ€§èƒ½è¢«ç›´æ¥è®¿é—®ï¼Œè€Œä¸éœ€è¦é€šè¿‡æ„Ÿå¹å·æ¥å±•å¼€å®ƒçš„å¯é€‰å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var country = Country(name: "Canada", capitalName: "Ottawa")
</span><span class='line'>print("\(country.name)'s capital city is called \(country.capitalCity.name)")
</span><span class='line'>// æ‰“å° â€œCanada's capital city is called Ottawaâ€</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨éšå¼å¯é€‰å€¼æ„å‘³ç€æ»¡è¶³äº†ç±»çš„æ„é€ å‡½æ•°çš„ä¸¤ä¸ªæ„é€ é˜¶æ®µçš„è¦æ±‚ã€‚<code>capitalCity</code>å±æ€§åœ¨åˆå§‹åŒ–å®Œæˆåï¼Œèƒ½åƒéå¯é€‰å€¼ä¸€æ ·ä½¿ç”¨å’Œå­˜å–ï¼ŒåŒæ—¶è¿˜é¿å…äº†å¾ªç¯å¼ºå¼•ç”¨ã€‚</p>

<h2>é—­åŒ…å¼•èµ·çš„å¾ªç¯å¼ºå¼•ç”¨</h2>

<p>å‰é¢æˆ‘ä»¬çœ‹åˆ°äº†å¾ªç¯å¼ºå¼•ç”¨æ˜¯åœ¨ä¸¤ä¸ªç±»å®ä¾‹å±æ€§äº’ç›¸ä¿æŒå¯¹æ–¹çš„å¼ºå¼•ç”¨æ—¶äº§ç”Ÿçš„ï¼Œè¿˜çŸ¥é“äº†å¦‚ä½•ç”¨å¼±å¼•ç”¨å’Œæ— ä¸»å¼•ç”¨æ¥æ‰“ç ´è¿™äº›å¼ºå¼•ç”¨ã€‚</p>

<p>å¾ªç¯å¼ºå¼•ç”¨è¿˜ä¼šå‘ç”Ÿåœ¨ä½ å°†ä¸€ä¸ªé—­åŒ…èµ‹å€¼ç»™ç±»å®ä¾‹çš„æŸä¸ªå±æ€§ï¼Œå¹¶ä¸”è¿™ä¸ªé—­åŒ…ä½“ä¸­åˆä½¿ç”¨äº†è¿™ä¸ªç±»å®ä¾‹æ—¶ã€‚è¿™ä¸ªé—­åŒ…ä½“ä¸­å¯èƒ½è®¿é—®äº†å®ä¾‹çš„æŸä¸ªå±æ€§ï¼Œä¾‹å¦‚<code>self.someProperty</code>,æˆ–è€…é—­åŒ…ä¸­è°ƒç”¨äº†å®ä¾‹çš„æŸä¸ªæ–¹æ³•ï¼Œä¾‹å¦‚ï¼š<code>self.someMethod()</code>,è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šå¯¼è‡´é—­åŒ…'æ•è·'self,ä»è€Œäº§ç”Ÿå¾ªç¯å¼ºå¼•ç”¨ã€‚</p>

<p>å¾ªç¯å¼ºå¼•ç”¨çš„äº§ç”Ÿï¼Œæ˜¯é—­åŒ…å’Œç±»ç›¸ä¼¼ï¼Œéƒ½æ˜¯å¼•ç”¨ç±»å‹ã€‚å½“ä½ æŠŠä¸€ä¸ªé—­åŒ…èµ‹å€¼ç»™æŸä¸ªå±æ€§æ—¶ï¼Œä½ æ˜¯å°†è¿™ä¸ªé—­åŒ…çš„å¼•ç”¨èµ‹å€¼ç»™äº†å±æ€§ï¼Œå®è´¨ä¸Šï¼Œè¿™è·Ÿä¹‹å‰çš„é—®é¢˜æ˜¯ä¸€æ ·çš„ï¼Œä¸¤ä¸ªå¼ºå¼•ç”¨è®©å½¼æ­¤ä¸€ç›´æœ‰æ•ˆã€‚ä½†æ˜¯ï¼Œå’Œä¸¤ä¸ªç±»å®ä¾‹ä¸åŒï¼Œè¿™æ¬¡ä¸€ä¸ªæ˜¯ç±»å®ä¾‹ï¼Œå¦ä¸€ä¸ªæ˜¯é—­åŒ…ã€‚</p>

<p>Swiftæä¾›äº†ä¸€ç§ä¼˜é›…çš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç§°ä¹‹ä¸º<code>é—­åŒ…æ•è·åˆ—è¡¨</code>.åŒæ ·åœ°ï¼Œåœ¨å­¦ä¹ å¦‚ä½•ç”¨é—­åŒ…æ•è·åˆ—è¡¨æ‰“ç ´å¾ªç¯å¼ºå¼•ç”¨ä¹‹å‰ï¼Œå…ˆæ¥äº†è§£ä¸€ä¸‹è¿™é‡Œçš„å¾ªç¯å¼ºå¼•ç”¨æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚</p>

<p>ä¸‹é¢çš„ä¾‹å­ä¸ºä½ å±•ç¤ºäº†å½“ä¸€ä¸ªé—­åŒ…å¼•ç”¨äº†<code>self</code>åæ˜¯å¦‚ä½•äº§ç”Ÿä¸€ä¸ªå¾ªç¯å¼ºå¼•ç”¨çš„ã€‚ä¾‹å­ä¸­å®šä¹‰äº†ä¸€ä¸ª<code>HtmlElement</code>çš„ç±»ï¼Œç”¨ä¸€ç§ç®€å•çš„æ¨¡å‹è¡¨ç¤ºHTMLæ–‡æ¡£ä¸­ä¸€ä¸ªå•ç‹¬çš„å…ƒç´ :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class HTMLElement {
</span><span class='line'>
</span><span class='line'>    let name: String
</span><span class='line'>    let text: String?
</span><span class='line'>
</span><span class='line'>    lazy var asHTML: Void -&gt; String = {
</span><span class='line'>        if let text = self.text {
</span><span class='line'>            return "&lt;\(self.name)&gt;\(text)&lt;/\(self.name)&gt;"
</span><span class='line'>        } else {
</span><span class='line'>            return "&lt;\(self.name) /&gt;"
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    init(name: String, text: String? = nil) {
</span><span class='line'>        self.name = name
</span><span class='line'>        self.text = text
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    deinit {
</span><span class='line'>        print("\(name) is being deinitialized")
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>HTMLElement</code>ç±»å®šä¹‰äº†ä¸€ä¸ª<code>name</code>å±æ€§æ¥è¡¨ç¤ºè¿™ä¸ªå…ƒç´ çš„åå­—ï¼Œä¾‹å¦‚ä»£è¡¨æ®µè½çš„<code>p</code>,æˆ–è€…ä»£è¡¨æ¢è¡Œçš„<code>br</code>,<code>HTMLElement</code>è¿˜å®šä¹‰äº†ä¸€ä¸ªå¯é€‰å±æ€§<code>text</code>,ç”¨æ¥è®¾ç½®HTMLå…ƒç´ å‘ˆç°çš„æ–‡æœ¬ã€‚</p>

<p>é™¤äº†ä¸Šé¢çš„ä¸¤ä¸ªå±æ€§ï¼Œ<code>HTMLElement</code>è¿˜å®šä¹‰äº†ä¸€ä¸ªlazyå±æ€§<code>asHtml</code>,è¿™ä¸ªå±æ€§å¼•ç”¨äº†ä¸€ä¸ªå°†<code>name</code>å’Œ<code>text</code>ç»„åˆæˆhtmlå­—ç¬¦ä¸²ç‰‡æ®µçš„é—­åŒ…ã€‚è¯¥å±æ€§æ˜¯<code>Void-&gt;String</code>ç±»å‹ï¼Œæˆ–è€…ç†è§£ä¸º'ä¸€ä¸ªæ²¡æœ‰å‚æ•°ï¼Œè¿”å›<code>String</code>çš„å‡½æ•°'ã€‚</p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œé—­åŒ…èµ‹å€¼ç»™äº†<code>asHtml</code>å±æ€§ï¼Œè¿™ä¸ªé—­åŒ…è¿”å›ä¸€ä¸ªä»£è¡¨HTmlæ ‡ç­¾çš„å­—ç¬¦ä¸²ã€‚å¦‚æœ<code>text</code>å€¼å­˜åœ¨ï¼Œè¯¥æ ‡ç­¾å°±åŒ…å«<code>text</code>;å¦‚æœä¸åŒ…å«<code>text</code>,è¯¥æ ‡ç­¾å°±ä¸åŒ…å«æ–‡æœ¬ï¼Œå¯¹äºæ®µè½å…ƒç´ ï¼Œæ ¹æ®<code>text</code>æ˜¯å¦æœ‰å€¼ï¼Œé—­åŒ…ä¼šè¿”å›<code>"&lt;p&gt;some text&lt;/p&gt;"</code>æˆ–è€…<code>"&lt;p /&gt;"</code></p>

<p>å¯ä»¥åƒå®ä¾‹æ–¹æ³•é‚£æ ·å»å‘½åï¼Œä½¿ç”¨<code>asHtml</code>å±æ€§ã€‚ç„¶è€Œï¼Œç”±äº<code>asHtml</code>æ˜¯é—­åŒ…è€Œä¸æ˜¯å®ä¾‹æ–¹æ³•ï¼Œå¦‚æœä½ æƒ³æ”¹å˜ç‰¹å®šhtmlå…ƒç´ å¤„ç†æ–¹å¼çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é—­åŒ…æ¥å–ä»£é»˜è®¤å€¼ã€‚</p>

<p>ä¾‹å¦‚ï¼Œå¯ä»¥å°†ä¸€ä¸ªé—­åŒ…èµ‹å€¼ç»™<code>asHtml</code> å±æ€§ï¼Œè¿™ä¸ªé—­åŒ…èƒ½åœ¨<code>text</code>å±æ€§æ˜¯<code>nil</code>æ—¶ä½¿ç”¨é»˜è®¤æ–‡æœ¬ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…è¿”å›ä¸€ä¸ªç©ºçš„HTMLæ ‡ç­¾:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let heading = HTMLElement(name: "h1")
</span><span class='line'>let defaultText = "some default text"
</span><span class='line'>heading.asHTML = {
</span><span class='line'>    return "&lt;\(heading.name)&gt;\(heading.text ?? defaultText)&lt;/\(heading.name)&gt;"
</span><span class='line'>}
</span><span class='line'>print(heading.asHTML())
</span><span class='line'>// æ‰“å° â€œ&lt;h1&gt;some default text&lt;/h1&gt;â€</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>æ³¨æ„</strong>
asHtmlå£°æ˜ä¸ºlazyå±æ€§ï¼Œå› ä¸ºåªæœ‰å½“å…ƒç´ ç¡®å®éœ€è¦è¢«å¤„ç†ä¸ºHTMLè¾“å‡ºçš„å­—ç¬¦ä¸²æ—¶ï¼Œæ‰éœ€è¦ä½¿ç”¨<code>asHTML</code>.ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨é»˜è®¤çš„é—­åŒ…ä¸­å¯ä»¥ä½¿ç”¨<code>self</code>,
å› ä¸ºåªæœ‰åˆå§‹åŒ–å®Œæˆä»¥åŠ<code>self</code>ç¡®å®å­˜åœ¨åï¼Œæ‰èƒ½è®¿é—®lazyå±æ€§ã€‚</p></blockquote>

<p>HTMLElementç±»åªæä¾›äº†æ„é€ å‡½æ•°ï¼Œé€šè¿‡<code>name</code>å’Œ<code>text</code>å‚æ•°æ¥åˆå§‹åŒ–ä¸€ä¸ªæ–°å…ƒç´ ï¼Œè¯¥ç±»ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªææ„å‡½æ•°ï¼Œå½“ <code>HTMLElement</code>è¢«é”€æ¯æ—¶ï¼Œæ‰“å°ä¸€æ¡æ¶ˆæ¯</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var paragraph: HTMLElement? = HTMLElement(name: "p", text: "hello, world")
</span><span class='line'>print(paragraph!.asHTML())
</span><span class='line'>// æ‰“å° â€œ&lt;p&gt;hello, world&lt;/p&gt;â€</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>æ³¨æ„</strong>
ä¸Šé¢çš„paragraphæ˜¯å¯é€‰ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥èµ‹å€¼<code>nil</code>æ¥æ¼”ç¤ºå¾ªç¯å¼ºå¼•ç”¨</p></blockquote>

<p>ä¸å¹¸çš„æ˜¯ï¼Œä¸Šé¢å†™çš„ <code>HTMLElement</code>ç±»äº§ç”Ÿäº†ç±»å®ä¾‹å’Œä½œä¸º<code>asHtml</code>é»˜è®¤æ˜¯å’Œé—­åŒ…ä¹‹é—´äº§ç”Ÿäº†å¾ªç¯å¼ºå¼•ç”¨ï¼Œå¾ªç¯å¼ºå¼•ç”¨å¦‚ä¸‹å›¾æ‰€ç¤º:</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/closureReferenceCycle01_2x.png" alt="lgoo" /></p>

<p>å®ä¾‹çš„<code>asHTML</code>å±æ€§æŒæœ‰é—­åŒ…çš„å¼ºå¼•ç”¨ã€‚ä½†æ˜¯ï¼Œé—­åŒ…åœ¨å…¶ä½“å†…ä½¿ç”¨äº†<code>self</code>(å¼•ç”¨äº†<code>self.name</code>å’Œ<code>self.text</code>),å› æ­¤æ•è·äº†<code>self</code>,è¿™æ„å‘³ç€é—­åŒ…åˆåè¿‡æ¥æŒæœ‰äº†<code>HtmlElement</code>å®ä¾‹çš„å¼ºå¼•ç”¨ã€‚è¿™æ ·ä¸¤ä¸ªå¯¹è±¡å°±äº§ç”Ÿäº†å¾ªç¯å¼ºå¼•ç”¨ã€‚</p>

<blockquote><p><strong>æ³¨æ„</strong>
éšè®©é—­åŒ…å¤šæ¬¡ä½¿ç”¨äº†<code>self</code>,å®ƒåªæ•è·<code>HTMLElemnt</code>å®ä¾‹çš„ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚</p></blockquote>

<p>å¦‚æœè®¾ç½®<code>paragraph</code>å˜é‡ä¸º<code>nil</code>,æ‰“ç ´å®ƒæŒæœ‰çš„<code>HTMLElement</code>å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œ<code>HTMlElement</code>å®ä¾‹å’Œå®ƒçš„é—­åŒ…éƒ½ä¸ä¼šè¢«é”€æ¯ï¼Œä¹Ÿæ˜¯å› ä¸ºå¾ªç¯å¼ºå¼•ç”¨ï¼š</p>

<pre><code>paragraph = nil
</code></pre>

<p>æ³¨æ„,<code>HTMLElement</code>çš„ææ„å‡½æ•°å¹¶æ²¡æœ‰è¢«æ‰“å°ï¼Œè¯æ˜äº† <code>HTMLElement</code>å®ä¾‹å¹¶æ²¡æœ‰è¢«é”€æ¯.</p>

<h2>è§£å†³é—­åŒ…å¼•èµ·çš„å¾ªç¯å¼ºå¼•ç”¨</h2>

<p>åœ¨å®šä¹‰é—­åŒ…æ—¶åŒäº‹å®šä¹‰æ•è·åˆ—è¡¨ä½œä¸ºé—­åŒ…çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥è§£å†³é—­åŒ…å’Œç±»ä¹‹é—´çš„å¾ªç¯å¼ºå¼•ç”¨ã€‚æ•è·åˆ—è¡¨å®šä¹‰äº†é—­åŒ…ä½“å†…æ•è·äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªå¼•ç”¨ç±»å‹çš„è§„åˆ™ã€‚è·Ÿè§£å†³ä¸¤ä¸ªç±»å®ä¾‹é—´çš„å¾ªç¯å¼ºå¼•ç”¨ä¸€æ ·ï¼Œå£°æ˜æ¯ä¸ªæ•è·çš„å¼•ç”¨ä¸ºå¼±å¼•ç”¨æˆ–æ— ä¸»å¼•ç”¨ï¼Œè€Œä¸æ˜¯å¼ºå¼•ç”¨ã€‚åº”å½“æ ¹æ®ä»£ç å…³ç³»æ¥å†³å®šä½¿ç”¨å¼±å¼•ç”¨è¿˜æ˜¯æ— ä¸»å¼•ç”¨ã€‚</p>

<blockquote><p><strong>æ³¨æ„</strong>
Swiftæœ‰å¦‚ä¸‹è¦æ±‚:åªè¦åœ¨é—­åŒ…å†…ä½¿ç”¨<code>self</code>çš„æˆå‘˜ï¼Œå°±è¦ç”¨<code>self.someProperty</code>æˆ–è€…<code>self.someMethod()</code>,ï¼ˆè€Œä¸åªæ˜¯<code>someProperty,someMethod()</code>ï¼‰,è¿™æé†’ä½ å¯èƒ½ä¼šä¸€ä¸å°å¿ƒå°±æ•è·äº†<code>self</code></p></blockquote>

<h3>å®šä¹‰æ•è·åˆ—è¡¨</h3>

<p>æ•è·åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½ç”±ä¸€å¯¹å…ƒç´ ç»„æˆï¼Œä¸€ä¸ªå…ƒç´ æ˜¯<code>weak</code>æˆ–è€…<code>unowned</code>å…³é”®å­—ï¼Œå¦ä¸€ä¸ªå…ƒç´ æ˜¯ç±»å®ä¾‹çš„å¼•ç”¨(ä¾‹å¦‚self)æˆ–åˆå§‹åŒ–è¿‡çš„å˜é‡(å¦‚ delegate=self.delegate!)</p>

<p>å¦‚æœé—­åŒ…æœ‰å‚æ•°åˆ—è¡¨å’Œè¿”å›ç±»å‹ï¼ŒæŠŠæ•è·åˆ—è¡¨æ”¾åœ¨å®ƒä»¬å‰é¢:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lazy var someClosure: (Int, String) -&gt; String = {
</span><span class='line'>    [unowned self, weak delegate = self.delegate!] (index: Int, stringToProcess: String) -&gt; String in
</span><span class='line'>    // è¿™é‡Œæ˜¯é—­åŒ…çš„å‡½æ•°ä½“
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœé—­åŒ…æ²¡æœ‰æŒ‡æ˜å‚æ•°åˆ—è¡¨æˆ–è€…è¿”å›ç±»å‹ï¼Œå³å®ƒä»¬ä¼šé€šè¿‡ä¸Šä¸‹æ–‡åˆ¤æ–­ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠæ•è·åˆ—è¡¨å’Œå…³é”®å­— <code>in</code>æ”¾åœ¨é—­åŒ…æœ€å¼€å§‹çš„åœ°æ–¹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lazy var someClosure: Void -&gt; String = {
</span><span class='line'>    [unowned self, weak delegate = self.delegate!] in
</span><span class='line'>    // è¿™é‡Œæ˜¯é—­åŒ…çš„å‡½æ•°ä½“
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>å¼±å¼•ç”¨å’Œæ— ä¸»å¼•ç”¨</h3>

<p>åœ¨é—­åŒ…å’Œæ•è·çš„å®ä¾‹æ€»æ˜¯äº’ç›¸å¼•ç”¨å¹¶ä¸”æ€»æ˜¯åŒæ—¶é”€æ¯æ—¶ï¼Œå°†é—­åŒ…å†…çš„æ•è·å®šä¹‰ä¸º<code>æ— ä¸»å¼•ç”¨</code>.</p>

<p>ç›¸åçš„ï¼Œåœ¨è¢«æ•è·çš„å¼•ç”¨å¯èƒ½ä¼šå˜æˆ<code>nil</code>æ—¶ï¼Œå°†é—­åŒ…å†…çš„æ•è·å®šä¹‰ä¸º<code>å¼±å¼•ç”¨</code>.å¼±å¼•ç”¨æ€»æ˜¯å¯é€‰ç±»å‹ï¼Œå¹¶ä¸”å½“å¼•ç”¨çš„ç±»å‹è¢«é”€æ¯åï¼Œå¼±å¼•ç”¨çš„å€¼ä¼šè‡ªåŠ¨è®¾ç½®ä¸º<code>nil</code>.è¿™ä½¿æˆ‘ä»¬å¯ä»¥åœ¨é—­åŒ…ä½“å†…ç®€å•å®ƒä»¬æ˜¯å¦å­˜åœ¨.</p>

<blockquote><p><strong>æ³¨æ„</strong>
å¦‚æœè¢«æ•è·çš„å¼•ç”¨ç»å¯¹ä¸ä¼šå˜æˆ<code>nil</code>,åº”è¯¥ç”¨æ— ä¸»å¼•ç”¨ï¼Œè€Œä¸æ˜¯å¼±å¼•ç”¨</p></blockquote>

<p>å‰é¢çš„<code>HTMLElement</code>ä¾‹å­ä¸­ï¼Œæ— ä¸»å¼•ç”¨æ˜¯æ­£ç¡®çš„è§£å†³å¾ªç¯å¼ºå¼•ç”¨çš„æ–¹æ³•ï¼Œè¿™æ ·ç¼–å†™<code>HTMlElement</code>æ¥é¿å…å¾ªç¯å¼ºå¼•ç”¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class HTMLElement {
</span><span class='line'>
</span><span class='line'>    let name: String
</span><span class='line'>    let text: String?
</span><span class='line'>
</span><span class='line'>    lazy var asHTML: Void -&gt; String = {
</span><span class='line'>        [unowned self] in
</span><span class='line'>        if let text = self.text {
</span><span class='line'>            return "&lt;\(self.name)&gt;\(text)&lt;/\(self.name)&gt;"
</span><span class='line'>        } else {
</span><span class='line'>            return "&lt;\(self.name) /&gt;"
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    init(name: String, text: String? = nil) {
</span><span class='line'>        self.name = name
</span><span class='line'>        self.text = text
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    deinit {
</span><span class='line'>        print("\(name) is being deinitialized")
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„<code>HTMLElement</code>å®ç°å’Œä¹‹å‰çš„å®ç°ä¸€è‡´ï¼Œé™¤äº†åœ¨<code>asHTML</code>é—­åŒ…ä¸­å¤šäº†ä¸€ä¸ªæ•è·åˆ—è¡¨ã€‚è¿™é‡Œæ•è·åˆ—è¡¨æ˜¯<code>[unowded self]</code>,è¡¨ç¤ºå°†<code>self</code>æ•è·ä¸ºæ— ä¸»å¼•ç”¨è€Œä¸æ˜¯å¼ºå¼•ç”¨.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var paragraph: HTMLElement? = HTMLElement(name: "p", text: "hello, world")
</span><span class='line'>print(paragraph!.asHTML())
</span><span class='line'>// æ‰“å° â€œ&lt;p&gt;hello, world&lt;/p&gt;â€</span></code></pre></td></tr></table></div></figure>


<p>ä½¿ç”¨æ•è·åˆ—è¡¨åå¼•ç”¨å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/closureReferenceCycle02_2x.png" alt="logo" /></p>

<p>è¿™ä¸€æ¬¡ï¼Œé—­åŒ…ä»¥æ— ä¸»å¼•ç”¨çš„å½¢å¼æ•è·<code>self</code>,å¹¶ä¸ä¼šæŒæœ‰<code>HTMLElement</code>å®ä¾‹çš„å¼ºå¼•ç”¨ã€‚å¦‚æœå°†<code>paragraph</code>èµ‹å€¼ä¸ºnil,<code>HTMLElement</code>å®ä¾‹å°†ä¼šè¢«é”€æ¯ï¼Œå¹¶èƒ½çœ‹åˆ°ææ„å‡½æ•°æ‰“å°å‡ºæ¶ˆæ¯;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>paragraph = nil
</span><span class='line'>// æ‰“å° â€œp is being deinitializedâ€</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å¦‚ä½•ç”¨cocoaPodå‘å¸ƒæ¡†æ¶]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/15/ru-he-yong-cocoapodfa-bu-kuang-jia/"/>
    <updated>2016-03-15T14:54:27+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/15/ru-he-yong-cocoapodfa-bu-kuang-jia</id>
    <content type="html"><![CDATA[<h2>å‰è¨€</h2>

<p><a href="https://cocoapods.org/">cocoapods</a>æ˜¯ä¸€æ¬¾å¼ºå¤§çš„æ¡†æ¶ä¾èµ–æ„å»ºçš„å·¥å…·ï¼Œç±»ä¼¼äºjavaä¸­çš„maven,å¯ä»¥å¿«é€Ÿæ­å»ºä½ é¡¹ç›®ä¸­éœ€è¦çš„æ¡†æ¶ï¼Œå¹¶ä¸”å®ƒå¯ä»¥è‡ªåŠ¨å¸®ä½ å…³è”å¥½ç¬¬ä¸‰æ–¹åº“ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œ è¿™ä¸ªå¾ˆåƒubuntuä¸‹çš„aptå®‰è£…è½¯ä»¶ï¼Œè‡ªåŠ¨å¸®ä½ ä¸‹è½½éœ€è¦çš„ä¾èµ–ã€‚</p>

<!--more-->


<p>ä½¿ç”¨cocoapodå¯ä»¥è½»æ¾çš„åˆ›å»ºæ¡†æ¶ï¼Œå‘å¸ƒåˆ°githubä¸Šï¼Œå¯ä»¥è®©å…¨ä¸–ç•Œçš„å¼€å‘è€…ä¸‹è½½åˆ°ä½ çš„æ¡†æ¶ï¼Œå¹¶ä¸”ä½¿ç”¨ï¼Œå¦‚æœèƒ½ä¸ºå…¨ä¸–ç•Œçš„å¼€æºç¤¾åŒºåšç‚¹è´¡çŒ®ï¼Œä¹Ÿæ˜¯ä¸€ä»¶éå¸¸å…´å¥‹çš„äº‹æƒ…ã€‚</p>

<p>å¼€å‘é™æ€åº“æœ‰ä¸¤ç§æ–¹æ³•:</p>

<h2>æ‰‹åŠ¨åˆ›å»ºæ¡†æ¶</h2>

<p>æ‰‹åŠ¨åˆ›å»ºæ¯”è¾ƒç¹çï¼Œè€Œä¸”å®¹æ˜“å‡ºç°é—®é¢˜ï¼Œå¤§è‡´æ­¥éª¤å¦‚ä¸‹:</p>

<ol>
<li>åœ¨xcodeä¸­åˆ›å»ºä¸€ä¸ª <code>Cocoa Touch Static Library</code></li>
<li>åˆ›å»º <code>Podfile</code>æ–‡ä»¶</li>
<li>æ‰§è¡Œ <code>pod install</code>å®Œæˆæ•´ä¸ªé¡¹ç›®çš„æ„å»º</li>
<li>å¦‚æœéœ€è¦demo,æ‰‹åŠ¨åˆ›å»ºç¤ºä¾‹ç¨‹åºï¼Œä½¿ç”¨podæ·»åŠ å¯¹ç§æœ‰é™æ€åº“çš„ä¾èµ–ï¼Œé‡å¤æ‰§è¡Œ <code>pod install</code>æ¥å®Œæˆæ¡†æ¶çš„æ„å»º</li>
</ol>


<h2>ä½¿ç”¨Podåˆ›å»ºæ¡†æ¶</h2>

<p><code>è¦æ±‚ä½ ç³»ç»Ÿä¸­å®‰è£…çš„cocoapodçš„ç‰ˆæœ¬&gt;0.3</code>
ç”µè„‘ç¯å¢ƒ:</p>

<ol>
<li>OS X ElCapitan 10.11.1</li>
<li>cocoapod 0.39</li>
<li>xcode 7.2</li>
<li>ruby 2.0.0p645 (2015-04-13 revision 50299) [universal.x86_64-darwin15]</li>
<li>Homebrew 0.9.5 (no git repository)</li>
</ol>


<p>å¯ä»¥é€šè¿‡podå®˜ç½‘æä¾›çš„å‘½ä»¤æ¥åˆ›å»ºï¼Œè®©æˆ‘ä»¬å¿«é€Ÿå¼€å§‹:</p>

<pre><code>pod lib create podLib-Andrew
</code></pre>

<p>è¿™è¡Œå‘½ä»¤ä¼šè‡ªåŠ¨ä»podå®˜ç½‘çš„ä»“åº“ä¸­ä¸‹è½½æ¨¡æ¿
ç„¶åå®ƒä¼šé—®ä½ å‡ ä¸ªé—®é¢˜</p>

<ol>
<li>What language do you want to use?? [ ObjC / Swift ] =>çœ‹ä½ éœ€è¦</li>
<li>Would you like to include a demo application with your library? [ Yes / No ]=>æ˜¯å¦åŒ…å«ä¸€ä¸ªdemoï¼Œæˆ‘ä¸€èˆ¬Yes</li>
<li>Which testing frameworks will you use? [ Specta / Kiwi / None ] =>æ˜¯å¦éœ€è¦åŒ…å«ä¸€ä¸ªæµ‹è¯•æ¡†æ¶</li>
<li>Would you like to do view based testing? [ Yes / No ]</li>
<li>What is your class prefix? =>ç±»çš„å‰ç¼€æ˜¯ä»€ä¹ˆ</li>
</ol>


<p>æ‰§è¡ŒæˆåŠŸä¹‹åï¼Œä¼šè‡ªåŠ¨ç”¨xcodeæ‰“å¼€å·¥ç¨‹ï¼Œå¦‚æœä½ çš„podç‰ˆæœ¬å¤ªæ–°ï¼Œæ¯”å¦‚1.0betaç‰ˆæœ¬ï¼Œå¯èƒ½ä¸ä¼šè‡ªåŠ¨åˆ›å»ºworkspaceå·¥ä½œç›®å½•ï¼Œè¿™æ˜¯ç”±äºpod1.0æœ‰äº›è¯­æ³•å˜äº†ï¼Œä½ è¦ç›¸åº”çš„æ›´æ”¹Podfileæ–‡ä»¶ä¸­çš„è¯­æ³•ï¼Œå…·ä½“å‚è€ƒå®˜æ–¹æœ€æ–°çš„è¯­æ³•ã€‚</p>

<p>æœ€ç»ˆç”Ÿæˆçš„ç›®å½•ç»“æ„å¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160315-0.png" alt="logo" /></p>

<ol>
<li>Example ä½ çš„å®ä¾‹ä»£ç æ–‡ä»¶å¤¹</li>
<li>.travis.yml -æŒç»­é›†æˆçš„é…ç½®æ–‡ä»¶ <a href="https://travis-ci.org/">travis-ci</a></li>
<li>_Pods.xcproject å·¥ç¨‹çš„ä¸€ä¸ªè¿æ¥ï¼Œç±»ä¼¼å¿«æ·æ–¹å¼</li>
<li>LICENSE é»˜è®¤æ˜¯ <a href="http://en.wikipedia.org/wiki/MIT_License">MIT License</a></li>
<li>README.md æè¿°æ–‡ä»¶</li>
<li>pod ä½ å­˜å‚¨æºä»£ç çš„åœ°æ–¹</li>
</ol>


<h2>è®¾ç½®ä½ çš„æ¡†æ¶</h2>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/xcode.png" alt="logo" /></p>

<p>è®©æˆ‘ä»¬çœ‹æ‰“å¼€åçš„å·¥ç¨‹ç›®å½•</p>

<ol>
<li>ä½ å¯ä»¥ç¼–è¾‘Podspec metadataï¼ŒåŒ…æ‹¬é‡Œé¢çš„ç‰ˆæœ¬å·å’Œä»‹ç»ç­‰</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#
</span><span class='line'># Be sure to run `pod lib lint podLib-Andrew.podspec' to ensure this is a
</span><span class='line'># valid spec before submitting.
</span><span class='line'>#
</span><span class='line'># Any lines starting with a # are optional, but their use is encouraged
</span><span class='line'># To learn more about a Podspec see http://guides.cocoapods.org/syntax/podspec.html
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>Pod::Spec.new do |s|
</span><span class='line'>  s.name             = "podLib-Andrew"
</span><span class='line'>  s.version          = "0.0.1"
</span><span class='line'>  s.summary          = "è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªæ¡†æ¶ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åˆ°ä½ "
</span><span class='line'>
</span><span class='line'># This description is used to generate tags and improve search results.
</span><span class='line'>#   * Think: What does it do? Why did you write it? What is the focus?
</span><span class='line'>#   * Try to keep it short, snappy and to the point.
</span><span class='line'>#   * Write the description between the DESC delimiters below.
</span><span class='line'>#   * Finally, don't worry about the indent, CocoaPods strips it!  
</span><span class='line'>  s.description      = &lt;&lt;-DESC
</span><span class='line'>                        "è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªæ¡†æ¶ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åˆ°ä½ "
</span><span class='line'>                       DESC
</span><span class='line'>
</span><span class='line'>  s.homepage         = "https://github.com/andrew-anlu/podLib-Andrew"
</span><span class='line'>  # s.screenshots     = "www.example.com/screenshots_1", "www.example.com/screenshots_2"
</span><span class='line'>  s.license          = 'MIT'
</span><span class='line'>  s.author           = { "Andrew" =&gt; "anluanlu123@163.com" }
</span><span class='line'>  s.source           = { :git =&gt; "https://github.com/andrew-anlu/podLib-Andrew.git", :tag =&gt; s.version.to_s }
</span><span class='line'>  # s.social_media_url = 'https://twitter.com/&lt;TWITTER_USERNAME&gt;'
</span><span class='line'>
</span><span class='line'>  s.platform     = :ios, '7.0'
</span><span class='line'>  s.requires_arc = true
</span><span class='line'>
</span><span class='line'>  s.source_files = 'Pod/Classes/**/*'
</span><span class='line'>  s.resource_bundles = {
</span><span class='line'>    'podLib-Andrew' =&gt; ['Pod/Assets/*.png']
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  # s.public_header_files = 'Pod/Classes/**/*.h'
</span><span class='line'>  # s.frameworks = 'UIKit', 'MapKit'
</span><span class='line'>  # s.dependency 'AFNetworking', '~&gt; 2.3'
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>s.nameæ˜¯æˆ‘ä»¬åº“çš„åç§°</li>
<li>s.versionæ˜¯åº“åŸä»£ç ç‰ˆæœ¬å·</li>
<li>s.summaryæ˜¯å¯¹æˆ‘ä»¬åº“çš„ä¸€ä¸ªç®€å•çš„ä»‹ç»</li>
<li>s.homepageå£°æ˜åº“çš„ä¸»é¡µ</li>
<li>s.licenseæ˜¯æ‰€é‡‡ç”¨çš„æˆæƒç‰ˆæœ¬</li>
<li>s.authoræ˜¯åº“çš„ä½œè€…</li>
<li>s.platformæ˜¯æˆ‘ä»¬åº“æ‰€æ”¯æŒçš„è½¯ä»¶å¹³å°ï¼Œè¿™åœ¨æˆ‘ä»¬æœ€åæäº¤è¿›è¡Œç¼–è¯‘ æ—¶æœ‰ç”¨</li>
<li>s.sourceå£°æ˜åŸä»£ç çš„åœ°å€.</li>
</ul>


<p>æŒ‰ç…§é»˜è®¤é…ç½®ï¼Œç±»åº“çš„æºæ–‡ä»¶å°†ä½äºPod/Classesæ–‡ä»¶å¤¹ä¸‹ï¼Œèµ„æºæ–‡ä»¶ä½äºPod/Assetsæ–‡ä»¶å¤¹ä¸‹ï¼Œå¯ä»¥ä¿®æ”¹s.source_fileså’Œs.resource_bundlesæ¥æ›´æ¢å­˜æ”¾ç›®å½•ã€‚s.public_header_filesç”¨æ¥æŒ‡å®šå¤´æ–‡ä»¶çš„æœç´¢ä½ç½®ã€‚
s.frameworkså’Œs.librariesæŒ‡å®šä¾èµ–çš„SDKä¸­çš„frameworkå’Œç±»åº“ï¼Œéœ€è¦æ³¨æ„ï¼Œä¾èµ–é¡¹ä¸ä»…è¦åŒ…å«ä½ è‡ªå·±ç±»åº“çš„ä¾èµ–ï¼Œè¿˜è¦åŒ…æ‹¬æ‰€æœ‰ç¬¬ä¸‰æ–¹ç±»åº“çš„ä¾èµ–ï¼Œåªæœ‰è¿™æ ·å½“ä½ çš„ç±»åº“æ‰“åŒ…æˆ.aæˆ–.frameworkæ—¶æ‰èƒ½è®©å…¶ä»–é¡¹ç›®æ­£å¸¸ä½¿ç”¨.</p>

<h2>å»ºç«‹è¿œç¨‹ç‰ˆæœ¬åº“</h2>

<p>ç°åœ¨è®©æˆ‘ä»¬å»githubä¸Šå»ºç«‹ä¸€ä¸ªä»“åº“ï¼Œåå­—å’Œå·¥ç¨‹çš„åå­—ä¿æŒä¸€è‡´<code>podLib-Andrew</code>
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160315-1.png" alt="pic" /></p>

<p>åˆ‡æ¢åˆ°ç»ˆç«¯ï¼Œè¿›å…¥åˆšæ‰çš„å·¥ç¨‹çš„æ ¹ç›®å½•</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//æ·»åŠ åˆ°æœ¬åœ°
</span><span class='line'>git add . 
</span><span class='line'>
</span><span class='line'>//æäº¤åˆ°æœ¬åœ°ä»“åº“
</span><span class='line'>git commit -m "initial commit"
</span><span class='line'>
</span><span class='line'>//å’Œè¿œç¨‹ä»“åº“å»ºç«‹å…³è”å…³ç³»
</span><span class='line'>git remote add origin git@github.com:andrew-anlu/podLib-Andrew.git
</span><span class='line'>
</span><span class='line'>//æ‰§è¡Œæ›´ç»†è¿œç¨‹ä»“åº“çš„æ•°æ®
</span><span class='line'>git pull origin master
</span><span class='line'>
</span><span class='line'>//é‡æ–°æ‰§è¡Œæ·»åŠ 
</span><span class='line'>git add .
</span><span class='line'>
</span><span class='line'>git commit -m "commit"
</span><span class='line'>
</span><span class='line'>//æäº¤ä»£ç åˆ°è¿œç¨‹ä»“åº“
</span><span class='line'>git push origin master
</span></code></pre></td></tr></table></div></figure>


<h2>ç¼–å†™æºä»£ç </h2>

<p>åœ¨Podçš„classesæ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªç±» <code>StringUtils</code>
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160315-2.png" alt="logo" /></p>

<p>StringUtils.h</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#import &lt;Foundation/Foundation.h&gt;
</span><span class='line'>
</span><span class='line'>@interface StringUtils : NSObject
</span><span class='line'>+(void)sayHello;
</span><span class='line'>@end
</span></code></pre></td></tr></table></div></figure>


<p>StringUtils.m</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#import "StringUtils.h"
</span><span class='line'>
</span><span class='line'>@implementation StringUtils
</span><span class='line'>+(void)sayHello{
</span><span class='line'>    NSLog(@"Hello world");
</span><span class='line'>}
</span><span class='line'>@end
</span></code></pre></td></tr></table></div></figure>


<p>æ³¨æ„æºä»£ç çš„å­˜æ”¾ä½ç½®ä¸€å®šè¦å’Œ .podspecä¸­çš„ s.source è·¯å¾„è¦ä¸€è‡´ï¼Œä¸ç„¶ä¸ä¼šèµ·ä½œç”¨çš„ã€‚
è¿è¡Œ <code>pod install</code>,ä¹Ÿè®¸ä½ ä¹Ÿæ³¨æ„åˆ°äº†ï¼Œæ¯æ¬¡æ·»åŠ æˆ–è€…ä¿®æ”¹ç±»ï¼Œæˆ–è€…æ·»åŠ å›¾ç‰‡ç­‰æ“ä½œï¼Œéƒ½è¦æ‰§è¡Œ <code>pod install</code>æˆ–è€…<code>pod update</code>æ¥æ›´æ–°åº”ç”¨ã€‚</p>

<blockquote><p><em>æ³¨æ„</em>
å¦‚æœæ˜¯ç”ŸæˆswiftåŠŸèƒ½ï¼Œåœ¨Podfileæ–‡ä»¶ä¸­ä¸€å®šè¦æœ‰ <code>use_frameworks!</code> ï¼Œè¿™è¡Œå‘½ä»¤æ˜¯æŒ‡å®šæ¡†æ¡†æ˜¯åŠ¨æ€æ¡†æ¶ï¼Œå› ä¸ºswiftè¦æ±‚è¦ä¹ˆä¾èµ–å…¨éƒ¨æ˜¯åŠ¨æ€æ¡†æ¶ï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ˜¯ï¼Œæ‰€ä»¥å¦‚æœæ³¨é‡Šæ‰ï¼Œä¼šæŠ¥ç¼–è¯‘æŠ¥é”™ï¼›</p>

<p>å¦å¤–ï¼Œswiftå·¥ç¨‹ä¸­çš„æºæ–‡ä»¶ï¼Œå¦‚æœæƒ³è®©å¤–éƒ¨è°ƒç”¨çš„è¯ï¼Œä¸€å®šè¦å£°æ˜æˆ<strong><code>public</code></strong>,
è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚</p></blockquote>

<h3>Note</h3>

<p>æ·»åŠ å®Œæºä»£ç ä¹‹åï¼Œå¦‚æœè¦åœ¨demoå·¥ç¨‹ä¸­å¼•ç”¨ï¼Œå‘ç°æ˜¯å¼•ç”¨ä¸åˆ°çš„ï¼ŒåŸå› å°±æ˜¯ä½ å¿…é¡»è¦æŠŠç±»åº“åŠ å…¥åˆ°demoå·¥ç¨‹ä¸­æ‰è¡Œï¼Œé»˜è®¤åœ¨Podfileæ–‡ä»¶ä¸­ç”Ÿæˆçš„ç±»åº“æ˜¯åŠ¨æ€ç±»åº“ï¼Œå³ .frameworkçš„ã€‚
æˆ‘å°è¯•äº†å¥½ä¹…ï¼Œä¸€ç›´å¼•ç”¨ä¸äº†ï¼Œäºæ˜¯å°±æ”¹æˆç”Ÿæˆ.aé™æ€åº“çš„æ–¹å¼ï¼Œå®Œç¾å¼•ç”¨ã€‚</p>

<p>ä¿®æ”¹æˆ.aç±»åº“çš„æ–¹æ³•å°±æ˜¯åœ¨ Podfileä¸­ï¼ŒæŠŠ<code>#use_frameworks!</code> æ³¨é‡Šæ‰å°±è¡Œäº†ï¼Œè¿™è¡Œä»£ç é»˜è®¤å°±æ˜¯ç”ŸæˆåŠ¨æ€ç±»åº“çš„ã€‚
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160317-0.png" alt="logo" /></p>

<h3>åŠ å…¥æŒç»­é›†æˆ(Travis CI)</h3>

<p>è¿™ä¸ªæ¨¡æ¿åŒ…å«äº†ä¸€ä¸ª <code>.travis.yml</code>æ–‡ä»¶ï¼ŒåŠ å…¥ä½ åœ¨Githubä¸Šå¼€å…³äº†ä½ çš„æ¡†æ¶ï¼Œæ‰“å¼€ <a href="https://travis-ci.org/">travis-ciå®˜ç½‘</a>ï¼Œå¹¶ä¸”ç”¨githubè´¦å·ç™»å½•å¹¶ä¸”åŒæ­¥ï¼Œæ‰“å¼€ä½ è¦å¼€æºçš„é¡¹ç›®ï¼Œè®¾ç½® on</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/travi.png" alt="lgogo" /></p>

<h3>æäº¤æœ¬åœ°ä»£ç åº“</h3>

<p>ä¿®æ”¹podLib-Andrew.podspec ä¸­çš„ <code>s.source</code>,</p>

<pre><code>  s.source           = { :git =&gt; "https://github.com/andrew-anlu/podLib-Andrew.git", :tag =&gt; s.version.to_s }
</code></pre>

<p>æäº¤ä»£ç ï¼Œå¹¶è¦æ‰“ä¸Štag</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git add .
</span><span class='line'>git commit -m "commit v0.0.1"
</span><span class='line'>git tag 0.0.1
</span><span class='line'>git tag -a 0.0.1 -m "v0.0.1"</span></code></pre></td></tr></table></div></figure>


<h3>éªŒè¯ç±»åº“</h3>

<p>å¼€å‘å®Œé™æ€ç±»åº“ä¹‹åï¼Œéœ€è¦è¿è¡Œ <code>pod lib lint</code>éªŒè¯ä¸€ä¸‹ç±»åº“æ˜¯å¦ç¬¦åˆ podçš„è¦æ±‚ã€‚<code>pod spec lint</code>ä¹Ÿæ˜¯ç”¨æ¥éªŒè¯æ˜¯å¦æœ‰æ•ˆï¼ŒåŒºåˆ«åœ¨äº</p>

<ol>
<li>pod lib lint  ä¸è®¿é—®ç½‘ç»œï¼Œåªåœ¨æœ¬åœ°éªŒè¯</li>
<li>pod spec lint æ£€æŸ¥è¿œç¨‹ä»“åº“å’Œè¿œç¨‹çš„tag</li>
</ol>


<p>podå®˜æ–¹æ¨èç”¨<a href="https://guides.cocoapods.org/making/getting-setup-with-trunk">trunk</a>æ¥å‘å¸ƒæ¡†æ¶ï¼Œ<a href="https://guides.cocoapods.org/making/getting-setup-with-trunk">trunkå…¥é—¨</a></p>

<p>å‡å¦‚ä½ åªæƒ³å‘å¸ƒä¸€ä¸ªç§äººçš„æ¡†æ¶ï¼Œè¯·çœ‹è¿™ä¸ªæ•™ç¨‹ <a href="https://guides.cocoapods.org/making/private-cocoapods">Private Specs Repos</a>,å¦‚æœä½ æƒ³å‘å¸ƒä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç§æœ‰æ¡†æ¶ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤</p>

<pre><code>pod repo push SPEC_REPO *.podspec --verbose
</code></pre>

<h2>å‘å¸ƒæ¡†æ¶</h2>

<pre><code>pod trunk push podLib-Andrew.podspec
</code></pre>

<p>å¦‚æœå‘å¸ƒæˆåŠŸï¼Œæ‰§è¡Œ <code>pod search podLib</code>
å°±ä¼šæœåˆ°ä½ çš„æ¡†æ¶</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160315-4.png" alt="logo" /></p>

<h1>Done</h1>

<p>ğŸ‘</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[é—­åŒ…-swift]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/11/bi-bao-swift/"/>
    <updated>2016-03-11T16:48:06+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/11/bi-bao-swift</id>
    <content type="html"><![CDATA[<h2>å‰è¨€</h2>

<p>é—­åŒ…æ˜¯è‡ªåŒ…å«çš„å‡½æ•°ä»£ç å—ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­è¢«ä¼ é€’å’Œä½¿ç”¨ã€‚swiftä¸­çš„é—­åŒ…ä¸ocä¸­çš„ä»£ç å—(block)æ¯”è¾ƒç›¸ä¼¼</p>

<p>é—­åŒ…å¯ä»¥æ•è·å’Œå­˜å‚¨å…¶æ‰€åœ¨ä¸Šä¸‹æ–‡ä¸­ä»»æ„å¸¸é‡å’Œå˜é‡çš„å¼•ç”¨ã€‚è¿™å°±æ˜¯æ‰€è°“çš„é—­åŒ…å¹¶åŒ…æ‹¬ç€ç€è¿™äº›å¸¸é‡å’Œå˜é‡ï¼Œä¿—ç§°é—­åŒ…ã€‚
swiftä¼šä¸ºæ‚¨ç®¡ç†åœ¨æ•è·è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°æ‰€æœ‰å†…å­˜æ“ä½œã€‚</p>

<!--more-->


<p>é—­åŒ…é‡‡ç”¨å¦‚ä¸‹ä¸‰ç§å½¢å¼ä¹‹ä¸€</p>

<ol>
<li>å…¨å±€å‡½æ•°æ˜¯ä¸€ä¸ªæœ‰åå­—ä½†ä¸ä¼šæ•è·ä»»ä½•å€¼çš„é—­åŒ…</li>
<li>åµŒå¥—å‡½æ•°æ˜¯ä¸€ä¸ªæœ‰åå­—å¹¶å¯ä»¥æ•è·å…¶å°é—­å‡½æ•°åŸŸå†…å€¼çš„é—­åŒ…</li>
<li>é—­åŒ…è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªåˆ©ç”¨è½»é‡çº§è¯­æ³•æ‰€å†™çš„å¯ä»¥æ•è·å…¶ä¸Šä¸‹æ–‡ä¸­å¸¸é‡æˆ–å˜é‡å€¼çš„åŒ¿åé—­åŒ…</li>
</ol>


<p>swiftçš„é—­åŒ…è¡¨è¾¾å¼æ‹¥æœ‰ç®€ä»‹çš„é£æ ¼ï¼Œå¹¶é¼“åŠ±åœ¨å¸¸è§åœºæ™¯ä¸‹è¿›è¡Œè¯­æ³•ä¼˜åŒ–ï¼Œä¸»è¦ä¼˜åŒ–å¦‚ä¸‹:</p>

<ol>
<li>åˆ©ç”¨ä¸Šä¸‹æ–‡æ¨æ–­å‚æ•°å’Œè¿”å›å€¼ç±»å‹</li>
<li>éšå¼è¿”å›å•è¡¨è¾¾å¼é—­åŒ…ï¼Œå³å•è¡¨è¾¾å¼é—­åŒ…å¯ä»¥çœç•¥ return å…³é”®å­—</li>
<li>å‚æ•°åç§°ç¼©å†™</li>
<li>å°¾éš(Trailing)é—­åŒ…è¯­æ³•</li>
</ol>


<h2>é—­åŒ…è¡¨è¾¾å¼(Closure Expressions)</h2>

<p>åµŒå¥—å‡½æ•°æ˜¯ä¸€ä¸ªåœ¨è¾ƒå¤æ‚å‡½æ•°ä¸­æ–¹ä¾¿è¿›è¡Œå‘½åå’Œå®šä¹‰å­—åŒ…å«ä»£ç æ¨¡å—çš„æ–¹å¼ã€‚å½“ç„¶ï¼Œæœ‰æ—¶å€™æ’°å†™å°å·§çš„æ²¡æœ‰å®Œæ•´å®šä¹‰å’Œå‘½åçš„ç±»å‡½æ•°ç»“æ„ä¹Ÿæ˜¯å¾ˆæœ‰ç”¨å¤„çš„ï¼Œå°¤å…¶æ˜¯åœ¨æ‚¨å¤„ç†ä¸€äº›å‡½æ•°å¹¶éœ€è¦å°†å¦å¤–ä¸€äº›å‡½æ•°ä½œä¸ºè¯¥å‡½æ•°çš„å‚æ•°æ—¶ã€‚</p>

<p>é—­åŒ…è¡¨è¾¾å¼æ˜¯ä¸€ç§åˆ©ç”¨ç®€ä»‹è¯­æ³•æ„å»ºå†…è”é—­åŒ…çš„æ–¹å¼ã€‚é—­åŒ…è¡¨è¾¾å¼æä¾›ä¸€äº›è¯­æ³•ä¼˜åŒ–ï¼Œä½¿å¾—æ’°å†™é—­åŒ…å˜å¾—ç®€å•æ˜äº†ã€‚ä¸‹é¢çš„é—­åŒ…è¡¨è¾¾å¼çš„ä¾‹å­é€šè¿‡ä½¿ç”¨å‡ æ¬¡è¿­ä»£å±•ç¤ºäº† <code>sort(_:)</code>æ–¹æ³•å®šä¹‰å’Œè¯­æ³•ä¼˜åŒ–çš„æ–¹å¼ã€‚
æ¯ä¸€æ¬¡è¿­ä»£éƒ½ç”¨æ›´ç®€æ´çš„æ–¹å¼æè¿°äº†ç›¸åŒçš„åŠŸèƒ½ã€‚</p>

<h3>sortæ–¹æ³•(The Sort Method)</h3>

<p>Swiftæ ‡å‡†åº“æä¾›äº†åä¸º<code>sort</code>çš„æ–¹æ³•ï¼Œä¼šæ ¹æ®æ‚¨æä¾›çš„ç”¨äºæ’åºçš„é—­åŒ…å‡½æ•°å°†å·²çŸ¥ç±»å‹æ•°ç»„ä¸­çš„å€¼è¿›è¡Œæ’åºã€‚ä¸€æ—¦æ’åºæ’åºå®Œæˆï¼Œ<code>sort(_:)</code>æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªä¸åŸæ•°ç»„å¤§å°ç›¸åŒï¼ŒåŒ…å«åŒç±»å‹å…ƒç´ ä¸”å…ƒç´ å·²æ­£ç¡®æ’åºçš„æ–°æ•°ç»„ã€‚åŸæ•°ç»„ä¸ä¼šè¢«<code>sort(_:)</code>æ–¹æ³•ä¿®æ”¹ã€‚</p>

<p>ä¸‹é¢çš„é—­åŒ…è¡¨è¾¾å¼ç¤ºä¾‹ä½¿ç”¨<code>sort(_:)</code>æ–¹æ³•å¯¹ä¸€ä¸ª<code>String</code>ç±»å‹æ•°ç»„è¿›è¡Œå­—æ¯é€†åºæ’åºï¼Œä»¥ä¸‹æ˜¯åˆå§‹æ•°ç»„å€¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let names = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]</span></code></pre></td></tr></table></div></figure>


<p><code>sort(_:)</code>æ–¹æ³•æ¥å—ä¸€ä¸ªé—­åŒ…ï¼Œè¯¥é—­åŒ…å‡½æ•°éœ€è¦ä¼ å…¥ä¸æ•°ç»„å…ƒç´ ç±»å‹ç›¸åŒçš„ä¸¤ä¸ªå€¼ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„å€¼è¡¨æ˜å½“æ’åºç»“æŸåä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ’åœ¨ç¬¬äºŒä¸ªå‚æ•°å‰é¢è¿˜æ˜¯åé¢ã€‚å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°å€¼å‡ºç°åœ¨ç¬¬äºŒä¸ªå‚æ•°å€¼å‰é¢ï¼Œæ’åºé—­åŒ…å‡½æ•°éœ€è¦è¿”å› true,åä¹‹è¿”å›falseã€‚</p>

<p>è¯¥ä¾‹å­å¯¹ä¸€ä¸ª <code>String</code>ç±»å‹çš„æ•°ç»„è¿›è¡Œæ’åºï¼Œå› æ­¤æ’åºé—­åŒ…å‡½æ•°ç±»å‹éœ€ä¸º(String,String)->Bool.
æä¾›æ’åºé—­åŒ…å‡½æ•°çš„ä¸€ç§æ–¹å¼æ˜¯æ’°å†™ä¸€ä¸ªç¬¦åˆå…¶ç±»å‹è¦æ±‚çš„æ™®é€šå‡½æ•°ï¼Œå¹¶å°†å…¶ä½œä¸º<code>sort(_:)</code>æ–¹æ³•çš„å‚æ•°ä¼ å…¥:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func backwards(s1: String, s2: String) -&gt; Bool {
</span><span class='line'>    return s1 &gt; s2
</span><span class='line'>}
</span><span class='line'>var reversed = names.sort(backwards)
</span><span class='line'>// reversed ä¸º ["Ewa", "Daniella", "Chris", "Barry", "Alex"]</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²(s1)å¤§äºç¬¬äºŒä¸ªå­—ç¬¦ä¸²(s2)ï¼Œ<code>backwards(_:_:)</code>å‡½æ•°è¿”å›<code>true</code>,è¡¨ç¤ºåœ¨æ–°çš„æ•°ç»„ä¸­<code>s1</code>åº”è¯¥å‡ºç°åœ¨<code>s2</code>å‰ã€‚</p>

<h3>é—­åŒ…è¡¨è¾¾å¼è¯­æ³•(Closure Expression Syntax)</h3>

<p>é—­åŒ…è¡¨è¾¾å¼è¯­æ³•æœ‰å¦‚ä¸‹ä¸€èˆ¬å½¢å¼:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{(parameters) -&gt; return type in
</span><span class='line'>  statements
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>é—­åŒ…è¡¨è¾¾å¼è¯­æ³•å¯ä»¥ä½¿ç”¨å¸¸é‡ï¼Œå˜é‡å’Œ<code>inout</code>ç±»å‹ä½œä¸ºå‚æ•°ï¼Œä¸èƒ½æä¾›é»˜è®¤å€¼ã€‚ä¹Ÿå¯ä»¥åœ¨å‚æ•°åˆ—è¡¨çš„æœ€åä½¿ç”¨å¯å˜å‚æ•°ã€‚
å…ƒç»„ä¹Ÿå¯ä»¥ä½œä¸ºå‚æ•°å’Œè¿”å›å€¼.</p>

<p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†ä¹‹å‰ <code>backwards(_:_:)</code>å‡½æ•°å¯¹åº”çš„é—­åŒ…è¡¨è¾¾å¼ç‰ˆæœ¬çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>reversed = names.sort({ (s1:String , s2:String) -&gt; Bool in 
</span><span class='line'>  return s1 &gt; s2
</span><span class='line'>})</span></code></pre></td></tr></table></div></figure>


<p>éœ€è¦æ³¨æ„çš„æ˜¯å†…è”é—­åŒ…å‚æ•°å’Œè¿”å›å€¼ç±»å‹å£°æ˜ä¸<code>backwards(_:_:)</code>å‡½æ•°ç±»å‹å£°æ˜ç›¸åŒã€‚åœ¨è¿™ä¸¤ç§æ–¹å¼ä¸­ï¼Œéƒ½å†™æˆäº†(s1:String,s2:String) - >Bool.ç„¶è€Œåœ¨å†…è”é—­åŒ…è¡¨è¾¾å¼ä¸­ï¼Œå‡½æ•°å’Œè¿”å›å€¼ç±»å‹éƒ½å¸è½½å¤§æ‹¬å·å†…ï¼Œè€Œä¸æ˜¯å¤§æ‹¬å·å¤–ã€‚</p>

<p>é—­åŒ…çš„å‡½æ•°ä½“éƒ¨åˆ†ç”±å…³é”®å­—  in å¼•å…¥ã€‚è¯¥å…³é”®å­—è¡¨ç¤ºé—­åŒ…çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹å®šä¹‰å·²ç»å®Œæˆï¼Œé—­åŒ…å‡½æ•°ä½“å³å°†å¼€å§‹ã€‚</p>

<p>ç”±äºè¿™ä¸ªé—­åŒ…å‡½æ•°ä½“éƒ¨åˆ†å¦‚æ­¤çŸ­ï¼Œä»¥è‡³äºå¯ä»¥å°†å…¶æ”¹å†™æˆä¸€è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>reversed = names.sort({(s1:String,s2:String)-&gt;Bool in 
</span><span class='line'>  return s1&gt;s2
</span><span class='line'>  })</span></code></pre></td></tr></table></div></figure>


<p>è¯¥ä¾‹ä¸­<code>sort(_:)</code>æ–¹æ³•çš„æ•´ä½“è°ƒç”¨ä¿æŒä¸å˜ï¼Œä¸€å¯¹åœ†æ‹¬å·ä»ç„¶åŒ…è£¹ä½äº†æ–¹æ³•çš„æ•´ä¸ªå‚æ•°ã€‚ç„¶åï¼Œå‚æ•°ç°åœ¨å˜æˆäº†å†…è”é—­åŒ…ã€‚</p>

<h3>æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­ç±»å‹(Inferring Type from Context)</h3>

<p>å› ä¸ºæ’åºé—­åŒ…å‡½æ•°æ˜¯ä½œä¸º<code>sort(_:)</code>æ–¹æ³•çš„å‚æ•°ä¼ å…¥çš„ï¼Œswiftå¯ä»¥æ¨æ–­å…¶å‚æ•°å’Œè¿”å›å€¼ç±»å‹ã€‚<code>sort(_:)</code>æ–¹æ³•è¢«ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„è°ƒç”¨ï¼Œå› æ­¤å…¶å‚æ•°å¿…é¡»æ˜¯(String,String)->Boolç±»å‹çš„å‡½æ•°ã€‚è¿™æ„å‘³ç€(String,String)å’ŒBoolç±»å‹å¹¶ä¸éœ€è¦ä½œä¸ºé—­åŒ…è¡¨è¾¾å¼å®šä¹‰çš„ä¸€éƒ¨åˆ†ã€‚å› ä¸ºæ‰€æœ‰çš„ç±»å‹éƒ½å¯ä»¥è¢«æ­£ç¡®æ¨æ–­ï¼Œè¿”å›ç®­å¤´(->)å’Œå›´ç»•åœ¨å‚æ•°å‘¨å›´çš„æ‹¬å·ä¹Ÿå¯ä»¥è¢«çœç•¥:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>reversed = names.sort({s1,s2 in return s1 &gt; s2})</span></code></pre></td></tr></table></div></figure>


<p>å®é™…ä¸Šä»»ä½•æƒ…å†µä¸‹ï¼Œé€šè¿‡å†…è”é—­åŒ…è¡¨è¾¾å¼æ„é€ çš„é—­åŒ…ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°æ´»æ–¹æ³•æ—¶ï¼Œéƒ½å¯ä»¥æ¨æ–­å‡ºé—­åŒ…çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ã€‚è¿™æ„å‘³ç€é—­åŒ…ä½œä¸ºå‡½æ•°æˆ–è€…æ–¹æ³•çš„å‚æ•°æ—¶ï¼Œæ‚¨å‡ ä¹ä¸éœ€è¦åˆ©ç”¨å®Œæ•´æ ¼å¼æ„é€ å†…è”é—­åŒ…ã€‚</p>

<p>å°½ç®¡å¦‚æ­¤ï¼Œæ‚¨ä»ç„¶å¯ä»¥æ˜ç¡®å†™å‡ºæœ‰ç€å®Œæ•´æ ¼å¼çš„é—­åŒ…ã€‚å¦‚æœå®Œæ•´æ ¼å¼çš„é—­åŒ…èƒ½æé«˜ä»£ç çš„å¯è¯»æ€§ï¼Œåˆ™å¯ä»¥é‡‡ç”¨å®Œæ•´æ ¼å¼çš„é—­åŒ…ã€‚è€Œåœ¨<code>sort(_:)</code>æ–¹æ³•è¿™ä¸ªä¾‹å­é‡Œï¼Œé—­åŒ…çš„ç›®çš„å°±æ˜¯æ’åºã€‚ç”±äºè¿™ä¸ªé—­åŒ…æ˜¯ä¸ºäº†å¤„ç†å­—ç¬¦ä¸²æ•°ç»„çš„æ’åºï¼Œå› æ­¤è¯»è€…èƒ½å¤Ÿæ¨æµ‹å‡ºè¿™ä¸ªé—­åŒ…æ˜¯ç”¨äºå­—ç¬¦ä¸²å¤„ç†çš„ã€‚</p>

<h3>å•è¡¨è¾¾å¼é—­åŒ…éšå¼è¿”å›</h3>

<p>å•è¡Œè¡¨è¾¾å¼é—­åŒ…å¯ä»¥é€šè¿‡çœç•¥<code>return</code>å…³é”®å­—æ¥éšå¼è¿”å›å•è¡Œè¡¨è¾¾å¼çš„ç»“æœï¼Œå¦‚ä¸Šç‰ˆæœ¬çš„ä¾‹å­å¯ä»¥æ”¹å†™æˆ:</p>

<pre><code>reversed=names.sort({s1,s2 in s1 &gt; s2})
</code></pre>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>sort(_:)</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°å‡½æ•°ç±»å‹æ˜ç¡®äº†é—­åŒ…å¿…é¡»è¿”å›ä¸€ä¸ª<code>Bool</code>ç±»å‹ä¹‹ã€‚å› ä¸ºé—­åŒ…å‡½æ•°ä½“åªåŒ…å«äº†ä¸€ä¸ªå•ä¸€è¡¨è¾¾å¼(<code>s1&gt;s2</code>),æ”¹è¡¨è¾¾å¼è¿”å›<code>Bool</code>ç±»å‹å€¼ï¼Œå› æ­¤è¿™é‡Œæ²¡æœ‰æ­§ä¹‰ï¼Œ<code>return</code>å…³é”®å­—å¯ä»¥çœç•¥</p>

<h3>å‡½æ•°åç§°ç¼©å†™</h3>

<p>swiftè‡ªåŠ¨ä¸ºå†…è”é—­åŒ…æä¾›äº†å‚æ•°åç§°ç¼©å†™åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥é¢ç›´æ¥é€šè¿‡<code>$0,$1,$2</code>æ¥é¡ºåºè°ƒç”¨é—­åŒ…å‚æ•°ï¼Œä»¥æ­¤ç±»æ¨ã€‚
å¦‚æœæ‚¨åœ¨é—­åŒ…è¡¨è¾¾å¼ä¸­ä½¿ç”¨å‚æ•°åç§°ç¼©å†™ï¼Œæ‚¨å¯ä»¥åœ¨é—­åŒ…å‚æ•°åˆ—è¡¨ä¸­çœç•¥å¯¹å…¶çš„å®šä¹‰ï¼Œå¹¶ä¸”å¯¹åº”å‚æ•°åç§°ç¼©å†™çš„ç±»å‹ä¼šé€šè¿‡å‡½æ•°ç±»å‹è¿›è¡Œåˆ¤æ–­ã€‚<code>in</code>å…³é”®å­—åŒæ ·å¯ä»¥è¢«çœç•¥é¢ï¼Œå› ä¸ºæ­¤æ—¶é—­åŒ…è¡¨è¾¾å¼å®Œå…¨æœ‰é—­åŒ…å‡½æ•°ä½“æ„æˆï¼š</p>

<pre><code>reveserd = names.sort({$0 &gt; $1})
</code></pre>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ$0å’Œ$1è¡¨ç¤ºé—­åŒ…ä¸­ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ª<code>String</code>ç±»å‹çš„å‚æ•°ã€‚</p>

<h3>è¿ç®—ç¬¦å‡½æ•°(OPerator Functions)</h3>

<p>å®é™…ä¸Šè¿˜æœ‰ä¸€ç§æ›´ç®€çŸ­çš„æ–¹å¼æ¥æ’°å†™ä¸Šé¢ä¾‹å­ä¸­çš„é—­åŒ…è¡¨è¾¾å¼ã€‚Swiftçš„<code>String</code>ç±»å‹å®šäº†å…³äºå¤§äºå·(>)çš„å­—ç¬¦ä¸²å®ç°ï¼Œå…¶ä½œä¸ºä¸€ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ª<code>String</code>ç±»å‹çš„å‚æ•°å¹¶è¿”å›<code>Bool</code>ç±»å‹çš„å€¼ã€‚è€Œè¿™æ­£å¥½ä¸<code>sort(_:)</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°éœ€è¦çš„å‡½æ•°ç±»å‹ç›¸ç¬¦åˆã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥ç®€å•ä¼ é€’ä¸€ä¸ªå¤§äºå·ï¼ŒSwiftå¯ä»¥è‡ªåŠ¨æ¨æ–­å‡ºæ‚¨æƒ³ä½¿ç”¨å¤§äºå·çš„å­—ç¬¦ä¸²å‡½æ•°å®ç°ï¼š</p>

<pre><code>reversed = names.sort(&gt;)
</code></pre>

<h2>å°¾éšé—­åŒ…(Trailing Closures)</h2>

<p>å¦‚æœæ‚¨éœ€è¦å°†ä¸€ä¸ªå¾ˆé•¿çš„é—­åŒ…è¡¨è¾¾å¼ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨å°¾éšé—­åŒ…æ¥å¢å¼ºå‡½æ•°çš„å¯è¯»æ€§ã€‚å°¾éšé—­åŒ…æ˜¯ä¸€ä¸ªä¹¦å†™åœ¨å‡½æ•°æ‹¬å·ä¹‹åçš„å½¼è¡¨è¡¨è¾¾å¼ï¼Œå‡½æ•°æ”¯æŒå°†å…¶ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°è°ƒç”¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func someFunctionThatTakesAClosure(closure: () -&gt; Void){
</span><span class='line'>     //å‡½æ•°ä½“éƒ¨åˆ†
</span><span class='line'>  }
</span><span class='line'>  // ä»¥ä¸‹æ˜¯ä¸ä½¿ç”¨å°¾éšé—­åŒ…è¿›è¡Œå‡½æ•°è°ƒç”¨
</span><span class='line'>  someFunctionThatTakesAClosure({
</span><span class='line'>    // é—­åŒ…ä¸»ä½“éƒ¨åˆ†
</span><span class='line'>  })
</span><span class='line'>
</span><span class='line'>  // ä»¥ä¸‹æ˜¯ä½¿ç”¨å°¾éšé—­åŒ…è¿›è¡Œå‡½æ•°è°ƒç”¨
</span><span class='line'> someFunctionThatTakesAClosure() {
</span><span class='line'>     // é—­åŒ…ä¸»ä½“éƒ¨åˆ†
</span><span class='line'> }</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„sortæ’åºå¯ä»¥æ”¹ä¸º:</p>

<pre><code>reversed = names.sort(){$0 &gt; $1}
</code></pre>

<p>å¦‚æœå‡½æ•°åªéœ€è¦é—­åŒ…è¡¨è¾¾å¼ä¸€ä¸ªå‚æ•°ï¼Œå½“æ‚¨ä½¿ç”¨å°¾éšé—­åŒ…æ—¶ï¼Œæ‚¨ç”šè‡³å¯ä»¥å§()çœç•¥æ‰</p>

<pre><code>reversed = names.sort { $0 &gt; $1}
</code></pre>

<p>å½“é—­åŒ…éå¸¸é•¿ä»¥è‡³äºä¸èƒ½å†ä¸€è¡Œä¸­è¿›è¡Œä¹¦å†™æ—¶ï¼Œå°¾éšé—­åŒ…å˜å¾—éå¸¸æœ‰ç”¨ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œswiftçš„<code>array</code>ç±»å‹æœ‰ä¸€ä¸ª<code>map(_:)</code>æ–¹æ³•ï¼Œå…¶è·å–ä¸€ä¸ªé—­åŒ…è¡¨è¾¾å¼ä½œä¸ºå…¶å”¯ä¸€å‚æ•°ã€‚è¯¥é—­åŒ…å‡½æ•°ä¼šä¸ºæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ è°ƒç”¨ï¼Œå¹¶è¿”å›è¯¥å…ƒç´ æ‰€æ˜ å°„çš„å€¼ã€‚å…·ä½“çš„æ˜ å°„æ–¹å¼å’Œè¿”å›å€¼ç±»å‹ç”±é—­åŒ…æ¥æŒ‡å®šã€‚</p>

<p>å½“æä¾›ç»™æ•°ç»„çš„é—­åŒ…åº”ç”¨äºæ¯ä¸ªæ•°ç»„å…ƒç´ åï¼Œ<code>map(_:)</code>æ–¹æ³•å°†è¿”å›ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å«äº†åŸæ•°ç»„ä¸­çš„å…ƒç´ -å¯¹åº”çš„æ˜ å°„åçš„å€¼</p>

<p>ä¸‹ä¾‹ä»‹ç»äº†å¦‚ä½•åœ¨<code>map(_:)</code>æ–¹æ³•ä¸­ä½¿ç”¨å°¾éšé—­åŒ…å°†<code>Int</code>ç±»å‹æ•°ç»„<code>[16,58,510]</code>è½¬æ¢ä¸ºåŒ…å«å¯¹åº”<code>String</code>ç±»å‹çš„å€¼çš„æ•°ç»„<code>["OneSix", "FiveEight", "FiveOneZero"]</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let digitNames = [
</span><span class='line'>    0: "Zero", 1: "One", 2: "Two",   3: "Three", 4: "Four",
</span><span class='line'>    5: "Five", 6: "Six", 7: "Seven", 8: "Eight", 9: "Nine"
</span><span class='line'>]
</span><span class='line'>let numbers = [16, 58, 510]</span></code></pre></td></tr></table></div></figure>


<p>å¦‚ä¸Šä»£ç åˆ›å»ºäº†ä¸€ä¸ªæ•°å­—ä½å’Œå®ƒä»¬è‹±æ–‡ç‰ˆåå­—æƒ³æ˜ å°„çš„å­—å…¸ã€‚åŒæ—¶è¿˜å®šä¹‰äº†ä¸€ä¸ªå‡†å¤‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ•°ç»„çš„æ•´å½¢æ•°ç»„ã€‚
æ‚¨ç°åœ¨å¯ä»¥é€šè¿‡ä¼ é€’ä¸€ä¸ªå°¾éšé—­åŒ…ç»™<code>numbers</code>çš„<code>map(_:)</code>æ–¹æ³•æ¥åˆ›å»ºå¯¹åº”çš„å­—ç¬¦ä¸²ç‰ˆæœ¬æ•°ç»„:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let strings = numbers.map {
</span><span class='line'>    (var number) -&gt; String in
</span><span class='line'>    var output = ""
</span><span class='line'>    while number &gt; 0 {
</span><span class='line'>        output = digitNames[number % 10]! + output
</span><span class='line'>        number /= 10
</span><span class='line'>    }
</span><span class='line'>    return output
</span><span class='line'>}
</span><span class='line'>// strings å¸¸é‡è¢«æ¨æ–­ä¸ºå­—ç¬¦ä¸²ç±»å‹æ•°ç»„ï¼Œå³ [String]
</span><span class='line'>// å…¶å€¼ä¸º ["OneSix", "FiveEight", "FiveOneZero"]</span></code></pre></td></tr></table></div></figure>


<p><code>map(_:)</code>ä¸ºæ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ è°ƒç”¨äº†é—­åŒ…è¡¨è¾¾å¼ã€‚æ‚¨ä¸éœ€è¦æŒ‡å®šé—­åŒ…çš„è¾“å…¥å‚æ•°<code>number</code>çš„ç±»å‹ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡è¦æ˜ å°„çš„æ•°ç»„ç±»å‹è¿›è¡Œåˆ¤æ–­ã€‚</p>

<p>åœ¨è¯¥ä¾‹å­ä¸­ï¼Œé—­åŒ…<code>number</code>å‚æ•°è¢«å£°æ˜ä¸ºä¸€ä¸ªå˜é‡å‚æ•°ï¼Œå› æ­¤å¯ä»¥åœ¨é—­åŒ…å‡½æ•°ä½“å†…å¯¹é½è¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸ç”¨å†å®šä¹‰ä¸€ä¸ªæ–°çš„å±€éƒ¨å˜é‡å¹¶å°†<code>number</code>çš„å€¼èµ‹å€¼ç»™å®ƒã€‚é—­åŒ…è¡¨è¾¾å¼æŒ‡å®šäº†è¿”å›ç±»å‹ä¸ºString,ä»¥è¡¨æ˜å­˜å‚¨æ˜ å°„å€¼çš„æ–°æ•°ç»„ç±»å‹ä¸º<code>String</code>.</p>

<p>é—­åŒ…è¡¨è¾¾å¼åœ¨æ¯æ¬¡è¢«è°ƒç”¨çš„æ—¶å€™åˆ›å»ºäº†ä¸€ä¸ªå«åš<code>output</code>çš„å­—ç¬¦ä¸²å¹¶è¿”å›ã€‚</p>

<h3>æ•è·å€¼(Capturing Values)</h3>

<p>é—­åŒ…å¯ä»¥åœ¨å…¶è¢«å®šä¹‰çš„ä¸Šä¸‹æ–‡ä¸­æ•è·å¸¸é‡æˆ–å˜é‡ã€‚åŠæ—¶å®šä¹‰è¿™äº›å¸¸é‡å’Œå˜é‡çš„åŸä½œç”¨åŸŸå·²ç»ä¸å­˜åœ¨ï¼Œé—­åŒ…ä»ç„¶å¯ä»¥åœ¨é—­åŒ…å‡½æ•°ä½“å†…å¼•ç”¨å’Œä¿®æ”¹è¿™äº›å€¼ã€‚</p>

<p>Swiftä¸­ï¼Œå¯ä»¥æ•è·å€¼çš„å½¼è¡¨çš„æœ€ç®€å•å½¢å¼æ˜¯åµŒå¥—å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å®šä¹‰åœ¨å…¶ä»–å‡½æ•°çš„å‡½æ•°ä½“å†…çš„å‡½æ•°ã€‚åµŒå¥—å‡½æ•°å¯ä»¥æ•è·å…¶å¤–éƒ¨å‡½æ•°æ‰€æœ‰çš„å‚æ•°ä¸€çº§å®šä¹‰çš„å¸¸é‡å’Œå˜é‡ã€‚</p>

<p>ä¸¾ä¸ªä¾‹å­ï¼Œè¿™æœ‰ä¸€ä¸ªå«åš<code>makeIncrementor</code>çš„å‡½æ•°ï¼Œå…¶åŒ…å«äº†ä¸€ä¸ªå«åš<code>incrementor</code>çš„åµŒå¥—å‡½æ•°ã€‚åµŒå¥—å‡½æ•°<code>incrementor()</code>ä»ä¸Šä¸‹æ–‡ä¸­æ•è·äº†ä¸¤ä¸ªå€¼ï¼Œ<code>reunningTotal</code>å’Œ<code>amount</code>ã€‚æ•è·è¿™äº›å€¼ä¹‹åï¼Œ<code>makeIncrementor</code>å°†<code>incrementor</code>ä½œä¸ºé—­åŒ…è¿”å›ã€‚æ¯æ¬¡è°ƒç”¨<code>incrementor</code>æ—¶ï¼Œå…¶ä¼šä»¥<code>amout</code>ä½œä¸ºå¢é‡å¢åŠ <code>runningTotal</code>çš„å€¼</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func makeIncrementor(forIncrement amount: Int) -&gt; () -&gt; Int {
</span><span class='line'>    var runningTotal = 0
</span><span class='line'>    func incrementor() -&gt; Int {
</span><span class='line'>        runningTotal += amount
</span><span class='line'>        return runningTotal
</span><span class='line'>    }
</span><span class='line'>    return incrementor
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>makeIncrementor</code>è¿”å›ç±»å‹ä¸º<code>()-&gt;Int</code>.è¿™æ„å‘³ç€å…¶è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç®€å•ç±»å‹çš„å€¼ã€‚è¯¥å‡½æ•°åœ¨æ¯æ¬¡è°ƒç”¨æ—¶ä¸æ¥å—å‚æ•°ï¼Œå€¼è¿”å›ä¸€ä¸ª<code>Int</code>ç±»å‹çš„å€¼ã€‚
<code>makeIncrementer(forIncrement:)</code>å‡½æ•°å®šä¹‰äº†ä¸€ä¸ªåˆå§‹å€¼ä¸º0çš„æ•´å½¢å˜é‡<code>runningTotal</code>ï¼Œç”¨æ¥å­˜å‚¨å½“å‰è·‘æ­¥æ€»æ•°ã€‚è¯¥å€¼é€šè¿‡<code>incrementor</code>è¿”å›ã€‚</p>

<p><code>makeIncrementor(forIncrement:)</code>æœ‰ä¸€ä¸ª<code>Int</code>ç±»å‹çš„å‚æ•°ï¼Œå…¶å¤–éƒ¨å‚æ•°åä¸º<code>forIncrement</code>,å†…éƒ¨å‚æ•°åä¸º<code>amount</code>,è¯¥å‚æ•°è¡¨ç¤ºæ¯æ¬¡<code>incrementor</code>è¢«è°ƒç”¨æ—¶<code>runingTotal</code>å°†è¦å¢åŠ çš„é‡ã€‚</p>

<p>åµŒå¥—å‡½æ•°<code>increment</code>ç”¨æ¥æ‰§è¡Œå®é™…çš„å¢åŠ æ“ä½œã€‚è¯¥å‡½æ•°ç®€å•æ»´ä½¿ç”¨<code>runningTotal</code>å¢åŠ <code>amount</code>ï¼Œå¹¶å°†å…¶è¿”å›ã€‚
å¦‚æœæˆ‘ä»¬å•ç‹¬çœ‹è¿™ä¸ªå‡½æ•°ï¼Œä¼šå‘ç°çœ‹ä¸Šå»ä¸åŒå¯»å¸¸:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func incrementor() -&gt; Int {
</span><span class='line'>    runningTotal += amount
</span><span class='line'>    return runningTotal
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p><code>incrementer()</code>å‡½æ•°å¹¶æ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œä½†æ˜¯åœ¨å‡½æ•°ä½“è®¿é—®äº†<code>runningTotal</code>å’Œ<code>amount</code>å˜é‡ã€‚è¿™æ˜¯å› ä¸ºå®ƒä»å¤–å›´å‡½æ•°æ•è·äº†<code>runninTotal</code>å’Œ<code>amount</code>å˜é‡çš„å¼•ç”¨ã€‚æ•è·å¼•ç”¨ä¿è¯äº†<code>runningTotal</code>å’Œ<code>amount</code>å˜é‡åœ¨è°ƒç”¨å®Œ<code>makeIncrementer</code>åä¸ä¼šæ¶ˆå¤±ï¼Œå¹¶ä¸”ä¿è¯äº†ä¸‹ä¸€æ¬¡æ‰§è¡Œ<code>incrementer</code>å‡½æ•°æ—¶ï¼Œ<code>runningTotal</code>ä¾æ—§å­˜åœ¨ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨<code>makeIncrementor</code>çš„ä¾‹å­:</p>

<pre><code>let incrementByTen = makeIncrementor(forIncrement: 10)
</code></pre>

<p>è¯¥ä¾‹å­å®šä¹‰äº†ä¸€ä¸ªå«åš <code>incrementByTen</code>çš„å¸¸é‡ï¼Œè¯¥å¸¸é‡æŒ‡å‘ä¸€ä¸ªæ¯æ¬¡è°ƒç”¨ä¼šå°†<code>runningTotal</code>å˜é‡å¢åŠ 10çš„ <code>incrementor</code>å‡½æ•°ã€‚è°ƒç”¨è¿™ä¸ªå‡½æ•°å¤šæ¬¡å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœ:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>incrementByTen()
</span><span class='line'>// è¿”å›çš„å€¼ä¸º10
</span><span class='line'>incrementByTen()
</span><span class='line'>// è¿”å›çš„å€¼ä¸º20
</span><span class='line'>incrementByTen()
</span><span class='line'>// è¿”å›çš„å€¼ä¸º30</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœæ‚¨è’‹æ¬¢äº†å¦ä¸€ä¸ª<code>incrementor</code>ï¼Œå®ƒä¼šæœ‰å±äºå®ƒè‡ªå·±çš„ä¸€ä¸ªå…¨æ–°çš„ï¼Œç‹¬ç«‹çš„<code>runnintTotal</code>å˜é‡çš„å¼•ç”¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let incrementBySeven = makeIncrementor(forIncrement: 7)
</span><span class='line'>incrementBySeven()
</span><span class='line'>// è¿”å›çš„å€¼ä¸º7</span></code></pre></td></tr></table></div></figure>


<p>å†æ¬¡è°ƒç”¨åŸæ¥çš„<code>incrementByTen</code>ä¼šåœ¨åŸæ¥çš„å˜é‡<code>runningTotal</code>ä¸Šç»§ç»­å¢åŠ å€¼,è¯¥å˜é‡å’Œ<code>incrementBySeven</code>ä¸­æ•è·çš„å˜é‡æ²¡æœ‰ä»»ä½•è”ç³»:</p>

<pre><code>incrementByTen()
// è¿”å›çš„å€¼ä¸º40  
</code></pre>

<h2>é—­åŒ…æ˜¯å¼•ç”¨ç±»å‹</h2>

<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>incrementBySeven</code>å’Œ<code>incrementByTen</code>æ˜¯å¸¸é‡ï¼Œä½†æ˜¯è¿™äº›å¸¸é‡æŒ‡å‘çš„é—­åŒ…ä»ç„¶å¯ä»¥å¢åŠ å…¶æ•è·çš„å˜é‡çš„å€¼ã€‚è¿™æ˜¯å› ä¸ºå‡½æ•°å’Œé—­åŒ…éƒ½æ˜¯å¼•ç”¨ç±»å‹ã€‚</p>

<p>æ— è®ºæ‚¨å°†å‡½æ•°æˆ–é—­åŒ…èµ‹å€¼ä¸€ä¸ªå¸¸é‡è¿˜æ˜¯å˜é‡ï¼Œæ‚¨å®é™…ä¸Šéƒ½æ˜¯å°†å¸¸é‡æˆ–è€…å˜é‡çš„å€¼è®¾ç½®ä¸ºå¯¹åº”å‡½æ•°æˆ–é—­åŒ…çš„å¼•ç”¨ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒæŒ‡å‘é—­åŒ…çš„å¼•ç”¨<code>incrementByTen</code>æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œè€Œå¹¶éé—­åŒ…å†…å®¹æœ¬èº«ã€‚</p>

<p>è¿™ä¹Ÿæ„å‘³ç€å¦‚æœæ‚¨å°†é—­åŒ…èµ‹å€¼ç»™ä¸¤ä¸ªä¸åŒçš„å¸¸é‡æˆ–å˜é‡ï¼Œä¸¤ä¸ªå€¼éƒ½ä¼šæŒ‡å‘åŒä¸€ä¸ªé—­åŒ…:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let alsoIncrementByTen = incrementByTen
</span><span class='line'>alsoIncrementByTen()
</span><span class='line'>// è¿”å›çš„å€¼ä¸º50</span></code></pre></td></tr></table></div></figure>


<h2>éé€ƒé€¸é—­åŒ…(Nonescaping Closures)</h2>

<p>å½“ä¸€ä¸ªé—­åŒ…ä½œä¸ºå‚æ•°ä¼ åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œä½†æ˜¯è¿™ä¸ªé—­åŒ…åœ¨å‡½æ•°è¿”å›ä¹‹åæ‰è¢«æ‰§è¡Œï¼Œæˆ‘ä»¬ç§°è¯¥é—­åŒ…ä»å‡½æ•°ä¸­é€ƒé€¸ã€‚å½“ä½ å®šä¹‰æ¥å—é—­åŒ…ä½œä¸ºå‚æ•°çš„å‡½æ•°æ—¶ï¼Œä½ å¯ä»¥åœ¨å‚æ•°åä¹‹å‰æ ‡æ³¨<code>@noescape</code>,ç”¨æ¥æŒ‡æ˜è¿™ä¸ªé—­åŒ…æ˜¯ä¸å…è®¸"é€ƒé€¸"å‡ºè¿™ä¸ªå‡½æ•°çš„ã€‚å°†é—­åŒ…æ ‡æ³¨<code>@noescape</code>èƒ½ä½¿ç¼–è¯‘å™¨çŸ¥é“è¿™ä¸ªé—­åŒ…çš„ç”Ÿå‘½å‘¨æœŸ,ä»è€Œå¯ä»¥è¿›è¡Œä¸€äº›æ¯”è¾ƒæ¿€è¿›çš„ä¼˜åŒ–ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func someFunctionWithNoescapeClosure(@noescape closure: () -&gt; Void) {
</span><span class='line'>    closure()
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸¾ä¸ªä¾‹å­,<code>sort(_:)</code>æ–¹æ³•æ¥å—ä¸€ä¸ªç”¨æ¥è¿›è¡Œå…ƒç´ æ¯”è¾ƒçš„é—­åŒ…ä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªå‚æ•°è¢«æ ‡æ³¨äº†<code>@noescape</code>ï¼Œå› ä¸ºå®ƒç¡®ä¿è‡ªå·±åœ¨æ’åºç»“æŸä¹‹åå°±æ²¡ç”¨äº†ã€‚</p>

<p>ä¸€ç§èƒ½ä½¿é—­åŒ…'é€ƒé€¸'
å‡ºå‡½æ•°çš„æ–¹æ³•æ˜¯ï¼Œå°†è¿™ä¸ªé—­åŒ…ä¿å­˜åœ¨ä¸€ä¸ªå‡½æ•°å¤–éƒ¨å®šä¹‰çš„å˜é‡ä¸­ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¾ˆå¤šå¼‚æ­¥æ“ä½œçš„å‡½æ•°æ¥å—ä¸€ä¸ªé—­åŒ…å‚æ•°ä½œä¸º completion handler.è¿™ç±»å‡½æ•°ä¼šåœ¨å¼‚æ­¥æ“ä½œå¼€å§‹ä¹‹åç«‹åˆ»è¿”å›ï¼Œä½†æ˜¯é—­åŒ…ç›´åˆ°å¼‚æ­¥æ“ä½œç»“æŸåæ‰ä¼šè¢«è°ƒç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé—­åŒ…éœ€è¦â€œé€ƒé€¸â€å‡ºå‡½æ•°ï¼Œå› ä¸ºé—­åŒ…éœ€è¦åœ¨å‡½æ•°è¿”å›ä¹‹åè¢«è°ƒç”¨ã€‚ä¾‹å¦‚:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var completionHandlers: [() -&gt; Void] = []
</span><span class='line'>func someFunctionWithEscapingClosure(completionHandler: () -&gt; Void) {
</span><span class='line'>    completionHandlers.append(completionHandler)
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>someFunctionWithEscapingClosure(_:)</code>å‡½æ•°æ¥å—ä¸€ä¸ªé—­åŒ…ä½œä¸ºå‚æ•°ï¼Œè¯¥é—­åŒ…è¢«æ·»åŠ åˆ°ä¸€ä¸ªå‡½æ•°å¤–å®šä¹‰çš„æ•°ç»„ä¸­ã€‚å¦‚æœä½ è§†å›¾å°†è¿™ä¸ªå‚æ•°æ ‡æ³¨ä¸º<code>@noescape</code>ï¼Œä½ å°†ä¼šå¾—åˆ°ä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚</p>

<p>å°†é—­åŒ…æ ‡æ³¨ä¸º<code>@noescape</code>ä½¿ä½ èƒ½åœ¨é—­åŒ…ä¸­éšå¼åœ°å¼•ç”¨<code>self</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class SomeClass {
</span><span class='line'>    var x = 10
</span><span class='line'>    func doSomething() {
</span><span class='line'>        someFunctionWithEscapingClosure { self.x = 100 }
</span><span class='line'>        someFunctionWithNoescapeClosure { x = 200 }
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>let instance = SomeClass()
</span><span class='line'>instance.doSomething()
</span><span class='line'>print(instance.x)
</span><span class='line'>// prints "200"
</span><span class='line'>
</span><span class='line'>completionHandlers.first?()
</span><span class='line'>print(instance.x)
</span><span class='line'>// prints "100</span></code></pre></td></tr></table></div></figure>


<h2>è‡ªåŠ¨é—­åŒ…(Autoclosures)</h2>

<p>è‡ªåŠ¨é—­åŒ…æ˜¯ä¸€ç§è‡ªåŠ¨åˆ›å»ºçš„é—­åŒ…ï¼Œç”¨äºåŒ…è£…ä¼ é€’ç»™å‡½æ•°ä½œä¸ºå‚æ•°çš„è¡¨è¾¾å¼ã€‚è¿™ç§é—­åŒ…ä¸æ¥å—ä»»ä½•å‚æ•°ï¼Œå½“å®ƒè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šè¿”å›è¢«åŒ…è£…åœ¨å…¶ä¸­çš„è¡¨è¾¾å¼çš„å€¼ã€‚è¿™ç§ä¾¿åˆ©è¯­æ³•è®©ä½ èƒ½å¤Ÿç”¨ä¸€ä¸ªæ™®é€šçš„è¡¨è¾¾å¼æ¥ä»£æ›¿æ˜¾å¼çš„é—­åŒ…ï¼Œä»è€Œçœç•¥é—­åŒ…çš„èŠ±æ‹¬å·ã€‚</p>

<p>è‡ªåŠ¨é—­åŒ…è®©ä½ èƒ½å¤Ÿå»¶æ—¶æ±‚å€¼ï¼Œå› ä¸ºä»£ç æ®µä¸ä¼šè¢«æ‰§è¡Œç›´åˆ°ä½ æ˜¾å¼çš„è°ƒç”¨è¿™ä¸ªé—­åŒ…ã€‚å»¶è¿Ÿæ±‚å€¼å¯¹äºé‚£äº›æœ‰å‰¯ä½œç”¨å’Œä»£ä»·æ˜‚è´µçš„ä»£ç æ¥è¯´æ˜¯å¾ˆæœ‰ç›Šå¤„çš„ï¼Œå› ä¸ºä½ èƒ½æ§åˆ¶ä»£ç ä»€ä¹ˆæ—¶å€™æ‰§è¡Œã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†é—­åŒ…å¦‚ä½•å»¶æ—¶æ±‚å€¼ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var customersInLine = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]
</span><span class='line'>print(customersInLine.count)
</span><span class='line'>// prints "5"
</span><span class='line'>
</span><span class='line'>let customerProvider = { customersInLine.removeAtIndex(0) }
</span><span class='line'>print(customersInLine.count)
</span><span class='line'>// prints "5"
</span><span class='line'>
</span><span class='line'>print("Now serving \(customerProvider())!")
</span><span class='line'>// prints "Now serving Chris!"
</span><span class='line'>print(customersInLine.count)
</span><span class='line'>// prints "4"</span></code></pre></td></tr></table></div></figure>


<p>å°½ç®¡åœ¨é—­åŒ…çš„ä»£ç ä¸­ï¼Œ<code>customersInLine</code>çš„ç¬¬ä¸€ä¸ªå…ƒç´ è¢«ç§»é™¤äº†ï¼Œä¸è¿‡åœ¨é—­åŒ…è°ƒç”¨ä¹‹å‰ï¼Œè¿™ä¸ªå…ƒç´ ä¸ä¼šè¢«ç§»é™¤çš„ã€‚å¦‚æœè¿™ä¸ªé—­åŒ…æ°¸è¿œä¸è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆé—­åŒ…é‡Œå–å¼„çš„è¡¨è¾¾å¼å°†æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œé‚£æ„å‘³ç€åˆ—è¡¨ä¸­çš„å…ƒç´ æ°¸è¿œä¸ä¼šè¢«åˆ é™¤ã€‚è¯·æ³¨æ„ï¼Œ<code>customeerProvider</code>çš„ç±»å‹ä¸æ˜¯<code>String</code>,è€Œæ˜¯<code>() -&gt; String</code>,ä¸€ä¸ªæ²¡æœ‰å‚æ•°ä¸”è¿”å›å€¼ä¸º<code>String</code>çš„å‡½æ•°ã€‚
å°†é—­åŒ…ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°æ—¶ï¼Œä½ èƒ½è·çš„åŒæ ·çš„å»¶æ—¶æ±‚å€¼è¡Œä¸º.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// customersInLine is ["Alex", "Ewa", "Barry", "Daniella"]
</span><span class='line'>func serveCustomer(customerProvider: () -&gt; String) {
</span><span class='line'>    print("Now serving \(customerProvider())!")
</span><span class='line'>}
</span><span class='line'>serveCustomer( { customersInLine.removeAtIndex(0) } )
</span><span class='line'>// prints "Now serving Alex!"</span></code></pre></td></tr></table></div></figure>


<p><code>serveCustomer(_:)</code>æ¥å—ä¸€ä¸ªè¿”å›é¡¾å®¢åå­—çš„æ˜¾å¼çš„é—­åŒ…ã€‚ä¸‹é¢çš„è¿™ä¸ªç‰ˆæœ¬çš„ serveCustomer(_:)å®Œæˆäº†ç›¸åŒçš„æ“ä½œï¼Œä¸è¿‡å®ƒå¹¶æ²¡æœ‰æ¥å—ä¸€ä¸ªæ˜¾ç¤ºçš„é—­åŒ…ï¼Œè€Œæ˜¯é€šè¿‡è¯¥å°†å‚æ•°æ ‡è®°ä¸º<code>@autoclosure</code>æ¥æ¥æ”¶ä¸€ä¸ªè‡ªåŠ¨é—­åŒ…ã€‚ç°åœ¨ä½ å¯ä»¥å°†è¯¥å‡½æ•°å½“åšæ¥å—<code>String</code>ç±»å‹å‚æ•°çš„å‡½æ•°æ¥è°ƒç”¨ã€‚<code>customerProvider</code>å‚æ•°å°†è‡ªåŠ¨è½¬åŒ–ä¸ºä¸€ä¸ªé—­åŒ…ï¼Œå› ä¸ºè¯¥å‚æ•°æ ‡è®°äº†<code>@autoclosure</code>ç‰¹æ€§ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// customersInLine is ["Ewa", "Barry", "Daniella"]
</span><span class='line'>func serveCustomer(@autoclosure customerProvider: () -&gt; String) {
</span><span class='line'>    print("Now serving \(customerProvider())!")
</span><span class='line'>}
</span><span class='line'>serveCustomer(customersInLine.removeAtIndex(0))
</span><span class='line'>// prints "Now serving Ewa!"</span></code></pre></td></tr></table></div></figure>


<p><code>@autoclosure</code>ç‰¹æ€§æš—å«äº†<code>@noescape</code>ç‰¹æ€§ã€‚å¦‚æœä½ æƒ³è®©è¿™ä¸ªé—­åŒ…å¯ä»¥"é€ƒé€¸"ï¼Œåˆ™åº”è¯¥ä½¿ç”¨<code>@autoclosure(escaping)</code>ç‰¹æ€§ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// customersInLine is ["Barry", "Daniella"]
</span><span class='line'>var customerProviders: [() -&gt; String] = []
</span><span class='line'>func collectCustomerProviders(@autoclosure(escaping) customerProvider: () -&gt; String) {
</span><span class='line'>    customerProviders.append(customerProvider)
</span><span class='line'>}
</span><span class='line'>collectCustomerProviders(customersInLine.removeAtIndex(0))
</span><span class='line'>collectCustomerProviders(customersInLine.removeAtIndex(0))
</span><span class='line'>
</span><span class='line'>print("Collected \(customerProviders.count) closures.")
</span><span class='line'>// prints "Collected 2 closures."
</span><span class='line'>for customerProvider in customerProviders {
</span><span class='line'>    print("Now serving \(customerProvider())!")
</span><span class='line'>}
</span><span class='line'>// prints "Now serving Barry!"
</span><span class='line'>// prints "Now serving Daniella!"</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>collectCustomerProviders(_:)</code>å‡½æ•°å¹¶æ²¡æœ‰è°ƒç”¨ä¼ å…¥çš„<code>cusomerProvider</code>é—­åŒ…ï¼Œè€Œæ˜¯å°†é—­åŒ…è¿½åŠ åˆ°äº†<code>customerProviders</code>æ•°ç»„ä¸­ã€‚è¿™ä¸ªæ•°ç»„å®šä¹‰åœ¨å‡½æ•°ä½œç”¨åŸŸèŒƒå›´å¤–ï¼Œè¿™æ„å‘³ç€æ•°ç»„å†…çš„é—­åŒ…å°†ä¼šåœ¨å‡½æ•°è¿”å›ä¹‹åè¢«è°ƒç”¨ï¼Œå› æ­¤ï¼Œ<code>customerProvider</code>å‚æ•°å¿…é¡»å…è®¸â€œé€ƒé€¸â€å‡ºå‡½æ•°ä½œç”¨åŸŸ.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å­¦ä¹ CAShapeLayer]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/04/xue-xi-cashapelayer/"/>
    <updated>2016-03-04T14:20:24+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/04/xue-xi-cashapelayer</id>
    <content type="html"><![CDATA[<h2>å‰è¨€</h2>

<p>CAShapeLayerç»§æ‰¿è‡ªCALayer,å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨CaLayerçš„æ‰€æœ‰å±æ€§ã€‚ä½†æ˜¯ï¼ŒCAShapeLayeréœ€è¦å’Œè´å¡å°”æ›²çº¿é…åˆä½¿ç”¨æ‰æœ‰æ„ä¹‰.</p>

<p>CAShapeLayeræ˜¯åœ¨å…¶åæ ‡ç³»ç»Ÿå†…ç»˜åˆ¶è´å¡å°”æ›²çº¿çš„ã€‚å› æ­¤ä½¿ç”¨CAShapeLayeréœ€è¦ä¸ <code>UIbezierPath</code>ä¸€èµ·ä½¿ç”¨ã€‚</p>

<p>å®ƒæœ‰ä¸€ä¸ª <code>path</code>å±æ€§ï¼Œè€Œ<code>UIBezierPath</code>å°±æ˜¯å¯¹ <code>CGPathRef</code>ç±»å‹çš„å°è£…ï¼Œå› æ­¤è¿™ä¸¤è€…æ˜¯ç»é…</p>

<!--more-->


<h2>CASHapeLayerå’ŒdrawRectçš„æ¯”è¾ƒ</h2>

<ol>
<li>drawRect : å±äºCoreGraphicsæ¡†æ¶ï¼Œå ç”¨cpu,æ€§èƒ½æ¶ˆè€—å¤§</li>
<li>CAShapeLayer:å±äºCoreAnimationæ¡†æ¶ï¼Œé€šè¿‡GPUæ¥æ¸²æŸ“å›¾å½¢ï¼ŒèŠ‚çœæ€§èƒ½ã€‚åŠ¨ç”»æ¸²æŸ“ç›´æ¥æäº¤ç»™æ‰‹æœºçš„GPU,ä¸æ¶ˆè€—å†…å­˜ã€‚</li>
</ol>


<p>è¿™ä¸¤è€…å„æœ‰å„çš„ç”¨é€”ï¼Œè€Œä¸æ˜¯è¯´æœ‰ä¸ªCAShapeLayerå°±ä¸éœ€è¦drawRectäº†ã€‚</p>

<h2>CAShapeLayeræœˆUIBezierPathçš„å…³ç³»</h2>

<ol>
<li>CAShapeLayerä¸­çš„shapeä»£è¡¨å½¢çŠ¶çš„æ„æ€ï¼Œæ‰€ä»¥éœ€è¦å½¢çŠ¶æ‰èƒ½ç”Ÿæ•ˆ</li>
<li>è´å¡å°”æ›²çº¿å¯ä»¥åˆ›å»ºçŸ¢é‡çš„è·¯å¾„ï¼Œè€Œ<code>UIBezierPath</code>ç±»æ˜¯å¯¹ <code>CGPathRef</code>çš„å°è£…</li>
<li>è´å¡å°”æ›²çº¿ç»™ <code>CAShapeLayer</code>æä¾›è·¯å¾„ï¼ŒCAShapelayeråœ¨æä¾›çš„è·¯å¾„ä¸­è¿›è¡Œæ¸²æŸ“ã€‚è·¯å¾„ä¼šé—­ç¯ï¼Œæ‰€ä»¥ç»˜åˆ¶å‡ºäº† <code>Shape</code></li>
<li>ç”¨äº<code>CAShapeLayer</code>çš„è´å¡å°”æ›²çº¿ä½œä¸ºpath,å…¶pathæ˜¯ä¸€ä¸ªé¦–å°¾ç›¸æ¥çš„é—­ç¯çš„æ›²çº¿ï¼Œå³ä½¿è¯¥è´å¡å°”æ›²çº¿ä¸æ˜¯ä¸€ä¸ªé—­ç¯çš„æ›²çº¿ã€‚</li>
</ol>


<h2>CAShapeLayerä¸UIBezierPathç”»åœ†</h2>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160304-2.png" alt="logo" /></p>

<p>ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-(CAShapeLayer*)drawCircle{
</span><span class='line'>    CAShapeLayer *circleLayer=[CAShapeLayer layer];
</span><span class='line'>    
</span><span class='line'>    circleLayer.frame=CGRectMake(100, 10, 200, 200);
</span><span class='line'>    //è®¾ç½®å±…ä¸­æ˜¾ç¤º
</span><span class='line'>   // circleLayer.position=self.view.center;
</span><span class='line'>    //è®¾ç½®å¡«å……é¢œè‰²
</span><span class='line'>    circleLayer.fillColor=[UIColor clearColor].CGColor;
</span><span class='line'>    //è®¾ç½®çº¿å®½
</span><span class='line'>    circleLayer.lineWidth=2;
</span><span class='line'>    //è®¾ç½®çº¿çš„é¢œè‰²
</span><span class='line'>    circleLayer.strokeColor=[UIColor redColor].CGColor;
</span><span class='line'>    
</span><span class='line'>    //ä½¿ç”¨UIBezierPathåˆ›å»ºè·¯å¾„
</span><span class='line'>    CGRect frame=CGRectMake(0, 0, 200, 200);
</span><span class='line'>    UIBezierPath *circlePath=[UIBezierPath bezierPathWithOvalInRect:frame];
</span><span class='line'>    //è®¾ç½®CAShapeLayerä¸UIBezierPathå…³è”
</span><span class='line'>    circleLayer.path=circlePath.CGPath;
</span><span class='line'>    
</span><span class='line'>    [self.view.layer addSublayer:circleLayer];
</span><span class='line'>    
</span><span class='line'>    return circleLayer;
</span><span class='line'>    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œä¸æ˜¯æ”¾åœ¨-drawRect:æ–¹æ³•ä¸­è°ƒç”¨çš„ã€‚æˆ‘ä»¬ç›´æ¥å°†è¿™ä¸ªCAShapeLayeræ”¾åˆ°self.view.layerä¸Šï¼Œç›´æ¥å‘ˆç°å‡ºæ¥ã€‚</p>

<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>CAShapeLayer</code>ï¼Œç„¶åé…ç½®ç›¸å…³å±æ€§ï¼Œç„¶åå†é€šè¿‡ <code>UIBezierPath</code>çš„ç±»æ–¹æ³•åˆ›å»ºä¸€ä¸ªå†…åˆ‡åœ†è·¯å¾„ï¼Œç„¶åå°†è·¯å¾„æŒ‡å®šç»™<code>CAShapeLayer.path</code>,è¿™å°±å°†ä¸¤è€…å…³è”èµ·æ¥äº†ï¼Œæœ€åï¼Œå°†è¿™ä¸ªå±‚æ”¾åˆ°äº†self.view.layerä¸Šå‘ˆç°å‡ºæ¥ã€‚</p>

<h2>CAShapeLayerä¸UIBezierPathçš„ç®€å•Loadingæ•ˆæœ</h2>

<p>ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)drawHalfCircle {
</span><span class='line'>  self.loadingLayer = [self drawCircle];
</span><span class='line'>
</span><span class='line'>  // è¿™ä¸ªæ˜¯ç”¨äºæŒ‡å®šç”»ç¬”çš„å¼€å§‹ä¸ç»“æŸç‚¹
</span><span class='line'>  self.loadingLayer.strokeStart = 0.0;
</span><span class='line'>  self.loadingLayer.strokeEnd = 0.75;
</span><span class='line'>
</span><span class='line'>  self.timer = [NSTimer scheduledTimerWithTimeInterval:0.1
</span><span class='line'>                                                target:self
</span><span class='line'>                                              selector:@selector(updateCircle)
</span><span class='line'>                                              userInfo:nil
</span><span class='line'>                                               repeats:YES];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>- (void)updateCircle {
</span><span class='line'>  if (self.loadingLayer.strokeEnd &gt; 1 && self.loadingLayer.strokeStart &lt; 1) {
</span><span class='line'>    self.loadingLayer.strokeStart += 0.1;
</span><span class='line'>  } else if (self.loadingLayer.strokeStart == 0) {
</span><span class='line'>    self.loadingLayer.strokeEnd += 0.1;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  if (self.loadingLayer.strokeEnd == 0) {
</span><span class='line'>    self.loadingLayer.strokeStart = 0;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  if (self.loadingLayer.strokeStart &gt;= 1 && self.loadingLayer.strokeEnd &gt;= 1) {
</span><span class='line'>    self.loadingLayer.strokeStart = 0;
</span><span class='line'>    [self.timer invalidate];
</span><span class='line'>    self.timer = nil;
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>
æˆ‘ä»¬è¦å®ç°è¿™ä¸ªæ•ˆæœï¼Œæ˜¯é€šè¿‡ <code>stokeStart</code>å’Œ<code>stokeEnd</code>è¿™ä¸¤ä¸ªå±æ€§å¥½å®ç°çš„ï¼Œè¿™ä¸¤ä¸ªçš„å–å€¼èŒƒå›´æ˜¯[0-1],å½“stokeStartçš„å€¼æ…¢æ…¢å˜æˆ1æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°è·¯å¾„æ˜¯æ…¢æ…¢æ¶ˆå¤±çš„ã€‚è¿™é‡Œå®ç°çš„æ•ˆæœå¹¶ä¸å¥½ï¼Œå› ä¸ºä¸èƒ½ä¸€ç›´å¾ªç¯ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iosçš„Blockå¾ªç¯å¼•ç”¨]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/04/iosde-blockxun-huan-yin-yong/"/>
    <updated>2016-03-04T13:22:36+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/04/iosde-blockxun-huan-yin-yong</id>
    <content type="html"><![CDATA[<p>iosåœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå®¹æ˜“å¼•å‘å†…å­˜æ³„éœ²é—®é¢˜ã€‚ä¹Ÿå¾ˆå®¹æ˜“é€ æˆå¾ªç¯å¼•ç”¨ï¼Œä¹‹å‰ä½¿ç”¨blockçš„æ—¶å€™ä¹Ÿæ²¡æœ‰è¿‡å¤šæ³¨æ„ï¼Œå…¶å®å‘å¾ˆå¤šã€‚
å¯¹äºæ–°æ‰‹æ¥è¯´ï¼Œå‡ºç°å¾ªç¯å¼•ç”¨çš„æ—¶å€™ï¼Œå¾ˆéš¾å»æ’æŸ¥ã€‚</p>

<!--more-->


<h2>Controllerä¹‹é—´çš„blockå¾ªç¯å¼•ç”¨</h2>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å£°æ˜ä¸¤ä¸ªç±»ï¼Œä¸€ä¸ªæ˜¯ViewController,å¦ä¸€ä¸ªæ˜¯TLController,åœ¨ViewControllerä¸­æœ‰ä¸ªæŒ‰é’®ï¼Œç‚¹å‡» pushåˆ°TlControllerä¸­ã€‚
å…ˆçœ‹TLControllerä¸­ç±»çš„å£°æ˜ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef void(^CallbackBlock)();
</span><span class='line'>
</span><span class='line'>@interface TLController : UIViewController
</span><span class='line'>- (instancetype)initWithCallback:(CallbackBlock)callback;
</span><span class='line'>
</span><span class='line'>@property (nonatomic, copy) CallbackBlock callbackBlock;</span></code></pre></td></tr></table></div></figure>


<p>TlController.m</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (instancetype)initWithCallback:(CallbackBlock)callback{
</span><span class='line'>    self=[super init];
</span><span class='line'>    if(self){
</span><span class='line'>        _callbackBlock=callback;
</span><span class='line'>    }
</span><span class='line'>    return self;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†éªŒè¯è¯¥ç±»æ˜¯ä¸æ˜¯è¢«é‡Šæ”¾æ‰äº†ï¼Œæˆ‘ä»¬é‡å†™ä¸¤ä¸ªæ–¹æ³•æ¥æ£€æµ‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-(void)viewDidAppear:(BOOL)animated{
</span><span class='line'>    [super viewDidAppear:animated];
</span><span class='line'>    NSLog(@"è¿›å…¥æ§åˆ¶å™¨ï¼š%@", [[self class] description]);
</span><span class='line'>}
</span><span class='line'>- (void)dealloc {
</span><span class='line'>    NSLog(@"æ§åˆ¶å™¨è¢«dealloc: %@", [[self class] description]);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ ViewControllerä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæŒ‰é’®ï¼ŒæŒ‰é’®çš„å•å‡»äº‹ä»¶å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// ç‚¹å‡»buttonæ—¶
</span><span class='line'>- (void)goToNext {
</span><span class='line'>    //__weak __typeof(self) weakSelf=self;
</span><span class='line'>    
</span><span class='line'>    TLController *vc = [[TLController alloc] initWithCallback:^{
</span><span class='line'>        [self.button setTitleColor:[UIColor greenColor] forState:UIControlStateNormal];
</span><span class='line'>    }];
</span><span class='line'>    self.vc = vc;
</span><span class='line'>    [self.navigationController pushViewController:vc animated:YES];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨çœ‹Viewcontrollerï¼Œè¿™é‡Œå°±å½¢æˆäº†ä¸¤ä¸ªå¾ªç¯ï¼Œå› æ­¤vcå±æ€§å¾—ä¸åˆ°é‡Šæ”¾ï¼Œå¦‚å›¾:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160304-0.png" alt="logo" /></p>

<p>è¿™é‡Œå½¢æˆäº†ä¸¤ä¸ªå¾ªç¯</p>

<ol>
<li><p>ViewContrller->å¼ºå¼•ç”¨äº†vc->å¼ºå¼•ç”¨äº†callback->å¼ºå¼•ç”¨äº†Viewcontroller</p></li>
<li><p>Viewcontroler->å¼ºå¼•ç”¨äº†å±æ€§vc->å¼ºå¼•ç”¨äº†callback->å¼ºå¼•ç”¨äº†Viewcontrollerçš„å±æ€§button</p></li>
</ol>


<p>æˆ‘ä»¬è¦è§£å†³è¿™ä¸¤ä¸ªå¾ªç¯å¼•ç”¨ï¼Œå¯ä»¥å¦‚ä¸‹æ“ä½œ:</p>

<p>ä¸å£°æ˜vcå±æ€§ï¼Œæˆ–è€…å°†vcå±æ€§å£°æ˜ä¸ºweakå¼±å¼•ç”¨ç±»å‹ï¼Œåœ¨callbackå›è°ƒå¤„ï¼Œå°†self.buttonæ”¹ä¸º weakSelf.button,ä¹Ÿå°±æ˜¯è®©callbackçš„è¿™ä¸ªblockå¯¹viewcontrollerå¼±å¼•ç”¨ï¼Œè¿™æ ·å†…å­˜å°±å¯ä»¥é¡ºåˆ©é‡Šæ”¾äº†ã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// ç‚¹å‡»buttonæ—¶
</span><span class='line'>- (void)goToNext {
</span><span class='line'>    __weak __typeof(self) weakSelf=self;
</span><span class='line'>    
</span><span class='line'>    TLController *vc = [[TLController alloc] initWithCallback:^{
</span><span class='line'>        [weakSelf.button setTitleColor:[UIColor greenColor] forState:UIControlStateNormal];
</span><span class='line'>    }];
</span><span class='line'>   // self.vc = vc;
</span><span class='line'>    [self.navigationController pushViewController:vc animated:YES];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Controllerå’ŒViewä¹‹é—´çš„blockå¼•ç”¨</h2>

<p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªview,ç”¨äºå’ŒContrlleräº¤äº’ï¼Œå½“ç‚¹å‡»viewä¸Šçš„æŒ‰é’®æ—¶ï¼Œå°±æŠŠç»“æœå›è°ƒç»™controller;</p>

<p>TLViewå®šä¹‰å¦‚ä¸‹:
TlView.h</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typedef void(^FeedbackBlock)(id model);
</span><span class='line'>@interface TLView : UIView
</span><span class='line'>@property (nonatomic, copy) FeedbackBlock block;
</span><span class='line'>- (instancetype)initWithBlock:(FeedbackBlock)block;
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<p>TlView.m</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-(instancetype)initWithBlock:(FeedbackBlock)block{
</span><span class='line'>    self=[super init];
</span><span class='line'>    if(self){
</span><span class='line'>        self.block=block;
</span><span class='line'>        UIButton *button = [UIButton buttonWithType:UIButtonTypeCustom];
</span><span class='line'>        [button setTitle:@"åé¦ˆç»™controller" forState:UIControlStateNormal];
</span><span class='line'>        button.frame = CGRectMake(50, 200, 200, 45);
</span><span class='line'>        button.backgroundColor = [UIColor redColor];
</span><span class='line'>        [button setTitleColor:[UIColor yellowColor] forState:UIControlStateNormal];
</span><span class='line'>        [button addTarget:self action:@selector(feedback) forControlEvents:UIControlEventTouchUpInside];
</span><span class='line'>        [self addSubview:button];
</span><span class='line'>    }
</span><span class='line'>    return self;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>- (void)feedback {
</span><span class='line'>    if (self.block) {
</span><span class='line'>        // ä¼ æ¨¡å‹å›å»ï¼Œè¿™é‡Œæ²¡æœ‰æ•°æ®ï¼Œå‡è®¾ä¼ nil
</span><span class='line'>        self.block(nil);
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>/*
</span><span class='line'>// Only override drawRect: if you perform custom drawing.
</span><span class='line'>// An empty implementation adversely affects performance during animation.
</span><span class='line'>- (void)drawRect:(CGRect)rect {
</span><span class='line'>    // Drawing code
</span><span class='line'>}
</span><span class='line'>*/
</span><span class='line'>
</span><span class='line'>- (void)dealloc {
</span><span class='line'>    NSLog(@"dealloc: %@", [[self class] description]);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œåœ¨TlControllerä¸­å¢åŠ ä¸¤ä¸ªå±æ€§</p>

<pre><code>@property (nonatomic, strong) TLView *aView;
@property (nonatomic, strong) id currentModel;
</code></pre>

<p>  è°ƒç”¨å¦‚ä¸‹:</p>

<pre><code class="``">  -(void)testView{

   // __weak __typeof(self) weakSelf=self;

    self.aView = [[TLView alloc] initWithBlock:^(id model) {
        // å‡è®¾è¦æ›´æ–°model
        self.currentModel = model;
        //weakSelf.currentModel=model;
    }];
    // å‡è®¾å æ»¡å…¨å±
    self.aView.frame = self.view.bounds;
    [self.view addSubview:self.aView];
    self.aView.backgroundColor = [UIColor whiteColor];
}
</code></pre>

<p>  åœ¨viewDidLoadæ–¹æ³•ä¸­ï¼Œè°ƒç”¨<code>[self testView]</code></p>

<p>  è¿™æ ·Controllerå’Œviewä¹‹é—´å°±å½¢æˆäº†å¾ªç¯å¼•ç”¨ï¼Œå¦‚å›¾:
  <img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160304-1.png" alt="logo" /></p>

<ol>
<li>TlViewController->å¼ºå¼•ç”¨aView->block->tlViewcontrollerå±æ€§çš„currentModel</li>
</ol>


<p>  è§£å†³çš„åŠæ³•æ˜¯:åœ¨åˆ›å»ºaViewçš„æ—¶å€™ï¼Œblockå†…å¯¹currentModelçš„å¼•ç”¨æ”¹æˆå¼±å¼•ç”¨</p>

<pre><code class="``">  __weak __typeof(self) weakSelf=self;

    self.aView = [[TLView alloc] initWithBlock:^(id model) {
        // å‡è®¾è¦æ›´æ–°model
        weakSelf.currentModel=model;
    }];
</code></pre>

<p>  å¾ˆå¤šç¨‹åºå‘˜ç›´æ¥ä½¿ç”¨<em>currentModel,å…¶å®è¿™æ ·ä¹Ÿä¼šé€ æˆå¾ªç¯å¼•ç”¨ï¼Œå› ä¸º</em>currentModelä¹Ÿæ˜¯å±äºç±»çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿä¼šè¢«å¼ºå¼•ç”¨çš„ã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼Œä¹Ÿè¦æ”¹æˆå¼±å¼•ç”¨</p>

<pre><code class="``">  __block __weak __typeof(_currentModel) weakModel = _currentModel;
self.aView = [[TLView alloc] initWithBlock:^(id model) {
  // å‡è®¾è¦æ›´æ–°model
  weakModel = model;
}];
</code></pre>

<h2>æ¨¡æ‹Ÿå¾ªç¯å¼•ç”¨</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@autoreleasepool {
</span><span class='line'>  A *aVC = [[A alloc] init];
</span><span class='line'>  B *bVC = [[B allcok] init];
</span><span class='line'>  aVC.controller = bVC;
</span><span class='line'>  bVC.controller = aVC;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>aVC->å¼ºå¼•ç”¨äº†bVC</p>

<p>bVC->å¼ºå¼•ç”¨äº†aVC</p>

<p>å¦‚æœæ˜¯è¿™æ ·å¼•ç”¨ï¼Œå°±å½¢æˆç¯äº†ã€‚aVC->bVC->aVCï¼Œè¿™å°±å½¢æˆäº†ç¯ã€‚</p>

<h3>å¦‚æœä¸€ä¸ªControllerä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œæ˜¯å¦å¾ªç¯å¼•ç”¨å‘¢?</h3>

<p>åœ¨Viewcontrollerä¸­å£°æ˜ä¸€ä¸ªå˜é‡
<code>@property (nonatomic,strong)NSMutableArray *array;</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-(void)test1{
</span><span class='line'>    self.array = [NSMutableArray arrayWithObjects:@"a",@"b",@"abc",nil];
</span><span class='line'>    TLController *vc = [[TLController alloc] initWithCallback:^{
</span><span class='line'>        [self.array removeObjectAtIndex:0];
</span><span class='line'>    }];
</span><span class='line'>    [self.navigationController pushViewController:vc animated:YES];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ç‚¹å‡»è·³è½¬æŒ‰é’®ï¼Œæ§åˆ¶å°æ‰“å°</p>

<pre><code>BlockDemo1[5511:1169090] è¿›å…¥æ§åˆ¶å™¨ï¼šTLController
2016-03-04 14:08:45.612 
</code></pre>

<p>ç‚¹å‡»å›é€€,æ§åˆ¶å°æ‰“å°</p>

<pre><code>BlockDemo1[5511:1169090] æ§åˆ¶å™¨è¢«dealloc: TLController
</code></pre>

<p>  è¯´æ˜æˆå‘˜å˜é‡NSMutableArrayä¸ä¼šå½¢æˆå¾ªç¯å¼•ç”¨ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å­¦ä¹ UIBezierPath]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/03/xue-xi-uibezierpath/"/>
    <updated>2016-03-03T14:05:08+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/03/xue-xi-uibezierpath</id>
    <content type="html"><![CDATA[<h2>å‰è¨€</h2>

<p>ä¹‹å‰å°±çœ‹åˆ°å¾ˆå¤šå…³äº<code>UIBezierPath</code>çš„ä»‹ç»ï¼Œä½†æ˜¯å¹³å¸¸å¼€å‘çš„æ—¶å€™ä¸€ç›´æ²¡æ€ä¹ˆç”¨è¿‡ï¼Œä½†æ˜¯è¿™ä¸ª<code>UIBezierPath</code>å¯¹äºå¼€å‘ç”»å›¾æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚æ•…åœ¨æ­¤æ•´ç†å‡ºæ¥ï¼Œæ–¹ä¾¿ä»¥åä½¿ç”¨å’ŒæŸ¥é˜…ã€‚</p>

<!--more-->


<p>ä½¿ç”¨<code>UIBezierPath</code>å¯ä»¥åˆ›å»ºåŸºäºçŸ¢é‡çš„è·¯å¾„ï¼Œæ­¤ç±»æ˜¯Core Graphicsæ¡†æ¶å…³äºè·¯å¾„çš„ç–¯è½¬ã€‚ä½¿ç”¨<code>UIBezierPath</code>å¯ä»¥å®šä¹‰ç®€å•çš„å½¢çŠ¶ï¼Œå¦‚ä¸‰è§’å½¢ï¼ŒçŸ©å½¢æˆ–æœ‰å¤šä¸ªç›´çº¿å’Œæ›²çº¿ç»„æˆçš„å½¢çŠ¶ç­‰ã€‚</p>

<p><code>UIBezierPath</code>æ˜¯CGPathRefæ•°æ®ç±»å‹çš„å°è£…ã€‚</p>

<p>ä½¿ç”¨<code>UIBezierPath</code>ç”»å›¾çš„æ­¥éª¤</p>

<ol>
<li>åˆ›å»ºä¸€ä¸ª<code>UIBezierPath</code>å¯¹è±¡</li>
<li>è°ƒç”¨ -moveToPoint:è®¾ç½®åˆå§‹çº¿æ®µçš„èµ·ç‚¹</li>
<li>æ·»åŠ çº¿æˆ–è€…æ›²çº¿å»å®šä¹‰æˆ–è€…å¤šä¸ªå­è·¯å¾„</li>
<li>æ”¹å˜<code>UIBezierPath</code>å¯¹è±¡è·Ÿç»˜å›¾å±æ€§ã€‚æˆ‘ä»¬å¯ä»¥è®¾ç½®ç”»ç¬”çš„é¢œè‰²ï¼Œsizeå¤§å°ç­‰ç­‰</li>
</ol>


<h2>UIBezierPathåˆ›å»ºæ–¹æ³•</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>+ (instancetype)bezierPath;
</span><span class='line'>+ (instancetype)bezierPathWithRect:(CGRect)rect;
</span><span class='line'>+ (instancetype)bezierPathWithOvalInRect:(CGRect)rect;
</span><span class='line'>+ (instancetype)bezierPathWithRoundedRect:(CGRect)rect
</span><span class='line'>                            cornerRadius:(CGFloat)cornerRadius;
</span><span class='line'>+ (instancetype)bezierPathWithRoundedRect:(CGRect)rect
</span><span class='line'>                        byRoundingCorners:(UIRectCorner)corners 
</span><span class='line'>                              cornerRadii:(CGSize)cornerRadii;
</span><span class='line'>+ (instancetype)bezierPathWithArcCenter:(CGPoint)center 
</span><span class='line'>                                 radius:(CGFloat)radius 
</span><span class='line'>                             startAngle:(CGFloat)startAngle 
</span><span class='line'>                               endAngle:(CGFloat)endAngle 
</span><span class='line'>                              clockwise:(BOOL)clockwise;
</span><span class='line'>+ (instancetype)bezierPathWithCGPath:(CGPathRef)CGPath;</span></code></pre></td></tr></table></div></figure>


<pre><code>  + (instancetype)bezierPath;
</code></pre>

<p>   è¿™ä¸ªä½¿ç”¨æ¯”è¾ƒå¤šï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬çš„éœ€è¦ä»»æ„å®šåˆ¶æ ·å¼ï¼Œå¯ä»¥ç”»å‡ºæˆ‘ä»¬æƒ³è¦çš„å›¾å½¢</p>

<pre><code>+ (instancetype)bezierPathWithRect:(CGRect)rect;
</code></pre>

<p>è¿™ä¸ªå·¥å‚æ–¹æ³•æ ¹æ®ä¸€ä¸ªçŸ©å½¢ç”»è´å¡å°”æ›²çº¿</p>

<pre><code>+ (instancetype)bezierPathWithOvalInRect:(CGRect)rect;
</code></pre>

<p> è¿™ä¸ªå·¥å‚æ–¹æ³•æ ¹æ®ä¸€ä¸ªçŸ©å½¢ç”»å†…åˆ‡çš„è´å¡å°”æ›²çº¿ï¼Œé€šå¸¸ç”¨å®ƒæ¥ç”»åœ†å’Œæ¤­åœ†</p>

<pre><code> + (instancetype)bezierPathWithRoundedRect:(CGRect)rect
                              cornerRadius:(CGFloat)cornerRadius;
</code></pre>

<p> è¿™ä¸ªå·¥å‚æ–¹æ³•ç”»çŸ©å½¢ï¼Œä½†æ˜¯è¿™ä¸ªçŸ©å½¢æ˜¯å¯ä»¥ç”»åœ†è§’çš„ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯çŸ©å½¢ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯åœ†è§’å¤§å°</p>

<pre><code>+ (instancetype)bezierPathWithRoundedRect:(CGRect)rect
                        byRoundingCorners:(UIRectCorner)corners 
                              cornerRadii:(CGSize)cornerRadii;
</code></pre>

<p> è¿™ä¸ªå·¥å‚æ–¹æ³•ä¹Ÿæ˜¯ç”»çŸ©å½¢ï¼Œä½†æ˜¯å¯ä»¥æŒ‡å®šæŸä¸€ä¸ªè§’æˆåœ†è§’ï¼Œåƒè¿™ç§æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„ç»™UIviewæ‰©å±•æˆåœ†è§’äº†</p>

<pre><code>+ (instancetype)bezierPathWithArcCenter:(CGPoint)center 
                                 radius:(CGFloat)radius 
                             startAngle:(CGFloat)startAngle 
                               endAngle:(CGFloat)endAngle 
                              clockwise:(BOOL)clockwise;
</code></pre>

<p> è¿™ä¸ªå·¥å‚æ–¹æ³•ç”¨äºç”»åœ†å¼§ï¼Œå‚æ•°å¦‚ä¸‹:
 Center:å¼§çº¿ä¸­å¿ƒç‚¹çš„åæ ‡
 radius:å¼§çº¿æ‰€åœ¨åœ†çš„åŠå¾„
 startAngle:å¼§çº¿å¼€å§‹çš„è§’åº¦å€¼
 endAngle:å¼§çº¿ç»“æŸæ—¶çš„è§’åº¦å€¼
 clockwise:æ˜¯å¦é¡ºæ—¶é’ˆç”»å¼§çº¿</p>

<h3>ç”»ä¸‰è§’å½¢</h3>

<p>å¦‚å›¾:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160303-0.png" alt="ä¸‰è§’å½¢" /></p>

<p>ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//ç”»ä¸‰è§’å½¢
</span><span class='line'>-(void)drawTriangle{
</span><span class='line'>    UIBezierPath *path=[UIBezierPath bezierPath];
</span><span class='line'>    [path moveToPoint:CGPointMake(20, 20)];
</span><span class='line'>    [path addLineToPoint:CGPointMake(self.frame.size.width-40, 20)];
</span><span class='line'>    [path addLineToPoint:CGPointMake(self.frame.size.width/2, self.frame.size.height-20)];
</span><span class='line'>    //æœ€åçš„é—­åˆçº¿å¯ä»¥é€šè¿‡closePathæ–¹æ³•æ¥è‡ªåŠ¨ç”Ÿæˆã€‚ä¹Ÿå¯ä»¥è°ƒç”¨addLineToPointæ¥æ·»åŠ 
</span><span class='line'>    
</span><span class='line'>    [path closePath];
</span><span class='line'>    
</span><span class='line'>    //è®¾ç½®çº¿å®½
</span><span class='line'>    path.lineWidth=4;
</span><span class='line'>    //è®¾ç½®å¡«å……é¢œè‰²
</span><span class='line'>    UIColor *fillColor=[UIColor yellowColor];
</span><span class='line'>    [fillColor set];
</span><span class='line'>    
</span><span class='line'>    [path fill];
</span><span class='line'>    
</span><span class='line'>    //è®¾ç½®ç”»ç¬”çš„é¢œè‰²
</span><span class='line'>    UIColor *stokeColor=[UIColor blueColor];
</span><span class='line'>    [stokeColor set];
</span><span class='line'>    //æ ¹æ®æˆ‘ä»¬è®¾ç½®çš„å„ä¸ªç‚¹ï¼Œè¿›è¡Œè¿çº¿
</span><span class='line'>    [path stroke];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>ç”»çŸ©å½¢</h3>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160303-1.png" alt="çŸ©å½¢" /></p>

<p>ä»£ç </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//ç”»çŸ©å½¢
</span><span class='line'>-(void)drawMyRectPath{
</span><span class='line'>    UIBezierPath *path=[UIBezierPath bezierPathWithRect:CGRectMake(100, 100, self.frame.size.width-120, self.frame.size.height-120)];
</span><span class='line'>    path.lineWidth=2;
</span><span class='line'>    path.lineCapStyle=kCGLineCapRound;
</span><span class='line'>    
</span><span class='line'>    //è®¾ç½®å¡«å……é¢œè‰²
</span><span class='line'>    UIColor *fillColor=[UIColor yellowColor];
</span><span class='line'>    [fillColor set];
</span><span class='line'>    [path fill];
</span><span class='line'>    
</span><span class='line'>    //è®¾ç½®ç”»ç¬”é¢œè‰²
</span><span class='line'>    UIColor *stokeColor=[UIColor blueColor];
</span><span class='line'>    [stokeColor set];
</span><span class='line'>    //æ ¹æ®æˆ‘ä»¬è®¾ç½®çš„å„ä¸ªç‚¹è¿çº¿
</span><span class='line'>    
</span><span class='line'>    [path stroke];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>ç”»åœ†</h3>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160303-2.png" alt=" circle" /></p>

<p>ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//ç”»åœ†å½¢æˆ–è€…æ¤­åœ†
</span><span class='line'>-(void)drawCirlcePath{
</span><span class='line'>    UIBezierPath *path=[UIBezierPath bezierPathWithOvalInRect:CGRectMake(10, 10, self.frame.size.width-20, self.frame.size.height-20)];
</span><span class='line'>    //è®¾ç½®çº¿å®½
</span><span class='line'>    path.lineWidth=4;
</span><span class='line'>    //è®¾ç½®å¡«å……é¢œè‰²
</span><span class='line'>    UIColor *fillColor=[UIColor yellowColor];
</span><span class='line'>    [fillColor set];
</span><span class='line'>    
</span><span class='line'>    [path fill];
</span><span class='line'>    
</span><span class='line'>    //è®¾ç½®ç”»ç¬”çš„é¢œè‰²
</span><span class='line'>    UIColor *stokeColor=[UIColor blueColor];
</span><span class='line'>    [stokeColor set];
</span><span class='line'>    //æ ¹æ®æˆ‘ä»¬è®¾ç½®çš„å„ä¸ªç‚¹ï¼Œè¿›è¡Œè¿çº¿
</span><span class='line'>    [path stroke];
</span><span class='line'>    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>ç”»å¸¦åœ†è§’çš„çŸ©å½¢</h3>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160303-3.png" alt="åœ†è§’çŸ©å½¢" /></p>

<p>ä»£ç </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//ç”»å¸¦åœ†è§’çš„çŸ©å½¢
</span><span class='line'>-(void)drawRoundedRectPath{
</span><span class='line'>    UIBezierPath *path=[UIBezierPath bezierPathWithRoundedRect:CGRectMake(20, 20, self.frame.size.width-40, self.frame.size.height-40) cornerRadius:10];
</span><span class='line'>    
</span><span class='line'>    //è®¾ç½®å¡«å……é¢œè‰²
</span><span class='line'>    UIColor *fillColor=[UIColor yellowColor];
</span><span class='line'>    [fillColor set];
</span><span class='line'>    [path fill];
</span><span class='line'>    
</span><span class='line'>    //è®¾ç½®ç”»ç¬”é¢œè‰²
</span><span class='line'>    UIColor *stokeColor=[UIColor blueColor];
</span><span class='line'>    [stokeColor set];
</span><span class='line'>    
</span><span class='line'>    //æ ¹æ®æˆ‘ä»¬è®¾ç½®çš„å„ä¸ªç‚¹è¿çº¿
</span><span class='line'>    [path stroke];
</span><span class='line'>    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>éƒ¨åˆ†è§’æ˜¯åœ†å½¢çš„</h3>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160303-4.png" alt="circle" /></p>

<p>åªéœ€æŠŠä¸Šé¢çš„ä»£ç ç¨åŠ ä¿®æ”¹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>UIBezierPath *path=nil;
</span><span class='line'>    //[UIBezierPath bezierPathWithRoundedRect:CGRectMake(20, 20, self.frame.size.width-40, self.frame.size.height-40) cornerRadius:10];
</span><span class='line'>    
</span><span class='line'>CGRect rect=CGRectMake(20, 20, self.frame.size.width-40, self.frame.size.height-40);
</span><span class='line'>    
</span><span class='line'>path=[UIBezierPath bezierPathWithRoundedRect:rect byRoundingCorners:UIRectCornerTopLeft cornerRadii:CGSizeMake(20, 20)];</span></code></pre></td></tr></table></div></figure>


<h3>ç”»å¼§åº¦</h3>

<p>ç”»å¼§å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£å‚è€ƒç³»
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160303-5.png" alt="sdf" /></p>

<p>æ•ˆæœå›¾:</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160303-6.png" alt="logo" /></p>

<p>ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-(void)drawARCPath{
</span><span class='line'>    const CGFloat pi=3.14159;
</span><span class='line'>    CGPoint center=CGPointMake(self.frame.size.width/2, self.frame.size.height/2);
</span><span class='line'>    UIBezierPath *path=[UIBezierPath bezierPathWithArcCenter:center radius:100 startAngle:0 endAngle:kDegreesToRadians(135) clockwise:YES];
</span><span class='line'>    
</span><span class='line'>    path.lineCapStyle=kCGLineCapRound;
</span><span class='line'>    path.lineJoinStyle=kCGLineJoinRound;
</span><span class='line'>    path.lineWidth=5;
</span><span class='line'>    
</span><span class='line'>    UIColor *stokeColor=[UIColor redColor];
</span><span class='line'>    [stokeColor set];
</span><span class='line'>    
</span><span class='line'>    [path stroke];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Xcodeå¸¸è§é—®é¢˜è§£æ]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/01/xcodechang-jian-wen-ti-jie-xi/"/>
    <updated>2016-03-01T16:05:46+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/01/xcodechang-jian-wen-ti-jie-xi</id>
    <content type="html"><![CDATA[<p>å¯åŠ¨é¡¹ç›®æˆ–è€…ç¼–è¯‘çš„æ—¶å€™ï¼Œxcodeæ€»æ˜¯æœ‰ä¸€äº›è«åçš„é”™è¯¯ï¼Œç°åœ¨æˆ‘æŠŠé‡åˆ°çš„é—®é¢˜å’Œå¼‚å¸¸ä¿¡æ¯éƒ½è®°å½•ä¸‹æ¥ï¼Œä»¥æ­¤å…±å‹‰</p>

<h3>CodeSign error: code signing is required for product type &lsquo;Application&rsquo; in SDK &lsquo;iOS 9.2&rsquo;</h3>

<!--more-->


<p>è§£å†³æ–¹æ³•:</p>

<ul>
<li>å»è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹ <code>/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/ç›®æ ‡æ–‡ä»¶ä¸‹</code> æ¯”å¦‚æˆ‘è¿™ä¸ªå°±æ˜¯iPhoneOS9.2.sdkï¼Œ</li>
<li>ä½ éœ€è¦æ‹·è´è¿™ä¸ªæ–‡ä»¶ SDKSettings.plist  åˆ°æ¡Œé¢ä¸Š</li>
<li>æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰¾åˆ°DefaultPropertiesè¿™ä¸ªé€‰é¡¹ï¼Œè®¾ç½®é‡Œé¢çš„å±æ€§CODE_SIGNING_REQUIRED ä¸º NO</li>
<li>ä¿å­˜è¿™ä¸ªæ–‡ä»¶ï¼Œå†æŠŠè¿™ä¸ªæ–‡ä»¶æ‹·è´åˆ°åŸå§‹çš„è·¯å¾„ä¸‹</li>
</ul>


<p>æå®šï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Swiftä¸­çš„æ•°æ®å­˜å‚¨]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/01/swiftzhong-de-shu-ju-cun-chu/"/>
    <updated>2016-03-01T10:52:34+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/01/swiftzhong-de-shu-ju-cun-chu</id>
    <content type="html"><![CDATA[<p>ç¨‹åºå°±æ˜¯å¯¹æ•°æ®è¿›è¡Œå¤„ç†çš„ï¼Œå­˜å‚¨æ•°æ®åœ¨appç«¯ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚æœ¬ç« å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿåœ¨ç£ç›˜ä¸Šå­˜å‚¨ä¿¡æ¯ï¼Œå¦‚ä½•åœ¨å†…ç½®çš„ç”¨æˆ·åå¥½è®¾ç½®æ•°æ®åº“ä¸­å­˜å‚¨ç®€å•æ•°æ®ã€‚</p>

<!--more-->


<h2>NSuserDefaults</h2>

<p>NSUserDefaultsç±»å…è®¸ä»¥"é”®å€¼"å½¢å¼ä¿å­˜è®¾ç½®ä¿¡æ¯ã€‚æˆ‘ä»¬ä¸éœ€è¦åŠ è½½å’Œè¯»å–è®¾ç½®æ–‡ä»¶ï¼Œåå¥½è®¾ç½®ä¼šè¢«è‡ªåŠ¨ä¿å­˜ã€‚</p>

<p>è¦è®¿é—®å­˜å‚¨åœ¨NSuserDefaultsä¸­çš„åå¥½è®¾ç½®ï¼Œéœ€è¦NSuserDefaultsç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚ä¸ºå¾—åˆ°è¿™æ ·çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¿…é¡»ä½¿ç”¨NSUserdefaultsç±»é¢standardUserDefaults:</p>

<pre><code>let defaults=NSUserDefaults.standardUserDefaults()
</code></pre>

<p>è¦åœ¨é»˜è®¤å¯¹è±¡ä¸­æ³¨å†Œé»˜è®¤å€¼ï¼Œé¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªå­—å…¸ã€‚è¿™ä¸ªå­—å…¸çš„é”®ä¸åå¥½è®¾ç½®çš„åå­—ç›¸åŒï¼Œä¸è¿™äº›é”®å…³è”çš„å€¼å°±æ˜¯è¿™äº›è®¾ç½®çš„é»˜è®¤å€¼ã€‚ä¸€æ—¦æœ‰ä¸ªè¿™ä¸ªå­—å…¸ï¼Œå°±ç”¨registerDefaultsæ–¹æ³•å°†å®ƒæä¾›ç»™é»˜è®¤å¯¹è±¡</p>

<pre><code>let meDefaults=["greeting":"hello",
            "numberOfItems":1]
defaults.registerDefaults(meDefaults)
</code></pre>

<p>å®Œæˆè¿™ä¸€å·¥ä½œåï¼Œå°±å¯ä»¥ä½¿ç”¨é»˜è®¤å¯¹è±¡çš„å€¼äº†</p>

<p>ç”¨reigisterDefaultsæ–¹æ³•æ³¨å†Œçš„"é»˜è®¤è®¾ç½®"å¹¶ä¸æ˜¯æ‘æ‘åœ¨ç£ç›˜ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åº”ç”¨ç¨‹åºæ¯æ¬¡å¯åŠ¨æ—¶éƒ½éœ€è¦è°ƒç”¨å®ƒã€‚ä½†åœ¨åº”ç”¨ç¨‹åºä¸­è®¾å®šçš„â€œé»˜è®¤è®¾ç½®â€ä¼šè¢«ä¿å­˜ã€‚</p>

<p>æœ‰äº†å¯¹ä¸€ä¸ªNSuserdefaultså¯¹è±¡çš„å¼•ç”¨ï¼Œå°±å¯ä»¥å‘å¯¹å¾…å­—å…¸ä¸€æ ·å¯¹å¾…NSUserdaultså¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ObjectForkeyæ–¹æ³•ä»é»˜è®¤å¯¹è±¡ä¸­æå–ä¸€ä¸ªå€¼</p>

<pre><code>let greeting=defaults.objectForKey("greeting") as? String
</code></pre>

<p>åªæœ‰å°‘æ•°å¯¹è±¡å¯ä»¥æ‘æ‘åœ¨é»˜è®¤å¯¹è±¡ä¸­ã€‚å¯ä»¥å­˜å‚¨åœ¨é»˜è®¤å¯¹è±¡ä¸­çš„å¯¹è±¡åªæœ‰å±æ€§åˆ—è¡¨å¯¹è±¡ã€‚</p>

<ul>
<li>å­—ç¬¦ä¸²</li>
<li>æ•°å­—</li>
<li>NSData</li>
<li>NSdate</li>
<li>æ•°ç»„å’Œå­—å…¸</li>
</ul>


<p> å¦‚æœéœ€è¦åœ¨é»˜è®¤å¯¹è±¡ä¸­å­˜å‚¨ä»»ä½•å…¶ä»–ç±»å‹çš„å¯¹è±¡ï¼Œåº”å½“é¦–å…ˆå¯¹å…¶å­˜æ¡£(archive),è½¬æ¢ä¸ºNSData</p>

<p>é™¤äº†ä»é»˜è®¤å¯¹è±¡ä¸­æå–å€¼ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è®¾å®šå€¼ã€‚åœ¨NSUserDefaultså¯¹è±¡ä¸­è®¾å®šå€¼æ—¶ï¼Œè¿™ä¸ªå€¼å°†è¢«æ°¸è¿œä¿å­˜
è¦åœ¨NSUserDefaultså¯¹è±¡ä¸­è®¾å®šä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨SetObject(_,forKey)</p>

<pre><code>let newGreeting="hi ,there";
defaults.setObject(newGreeting, forKey: "greeting")  
</code></pre>

<h2>ä½¿ç”¨NSFileManager</h2>

<p>åº”ç”¨ç¨‹åºä¸æ–‡ä»¶ç³»ç»Ÿçš„ç•Œé¢æ˜¯NSFileManagerå¯¹è±¡ï¼Œåˆ©ç”¨å®ƒå¯ä»¥åˆ—å‡ºæ–‡ä»¶å¤¹çš„å†…å®¹ï¼Œåˆ›å»ºå’Œé‡å‘½åå’Œåˆ é™¤æ–‡ä»¶ï¼Œè¦è®¿é—®NSFilemanagerç±»ï¼Œå¯ä»¥ä½¿ç”¨å…±äº«ç®¡ç†å™¨å¯¹è±¡</p>

<pre><code>let fileManager=NSFileManager.defaultManager()
</code></pre>

<h3>æ³¨æ„</h3>

<p>NSFileManagerå…è®¸æˆ‘ä»¬å¯¹å…¶è®¾å®šä¸€ä¸ªå§”æ‰˜ï¼Œåœ¨æ–‡ä»¶ç®¡ç†å™¨å®Œæˆè¯¸å¦‚å¤åˆ¶æˆ–ç§»åŠ¨æ–‡ä»¶ä¹‹ç±»çš„æ“ä½œæ—¶ï¼Œå®ƒä¼šå—åˆ°æ¶ˆæ¯ã€‚åœ¨ä½¿ç”¨è¿™ä¸€åŠŸèƒ½æ—¶ï¼Œåº”å½“åˆ›å»ºä½ è‡ªå·±çš„NSFileManagerå®ä¾‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å…±äº«å¯¹è±¡</p>

<pre><code>let fileManager=NSFileManager()
fileManager.delegate=self;
</code></pre>

<ul>
<li><p>è·å–ä¸€ä¸ªä¸´æ—¶ç›®å½•</p>

<p>  //è·å–ä¸´æ—¶ç›®å½•
  let tempraryDirectoryPath=NSTemporaryDirectory()
è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒåŒ…å«äº†å¯ä»¥åœ¨å…¶ä¸­å­˜å‚¨æ–‡ä»¶çš„ç›®å½•è·¯å¾„ã€‚å¦‚æœå¸Œæœ›ä»¥NSURLå½¢å¼ä½¿ç”¨å®ƒï¼Œå°±éœ€è¦ç”¨fileURLWithPathæ–¹æ³•è¿›è¡Œè½¬æ¢ã€‚</p></li>
<li><p>åˆ›å»ºç›®å½•</p></li>
</ul>


<p>åˆ©ç”¨NSFileManagerï¼Œå¯ä»¥åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šåˆ›å»ºå’Œåˆ é™¤é¡¹ç›®ã€‚æ¯”å¦‚ï¼Œè¦åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•ï¼Œå¯ä»¥åˆ©ç”¨:</p>

<ul>
<li>åˆ›å»ºæ–‡ä»¶
åˆ›å»ºæ–‡ä»¶çš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åœ¨NSStringä¸­æä¾›ä¸€ä¸ªè·¯å¾„ï¼Œæ–‡ä»¶åº”å½“åŒ…å«çš„NSData,ä»¥åŠä¸€ä¸ªå¯é€‰çš„å­—å…¸ï¼Œå…¶ä¸­åˆ—å‡ºæ­¤æ–‡ä»¶åº”å½“æ‹¥æœ‰çš„å±æ€§ï¼š</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fileManager.createFileAtPath(newFilePath!,
</span><span class='line'>      contents:NewFileData,
</span><span class='line'>      attributes:nil)</span></code></pre></td></tr></table></div></figure>


<ul>
<li>åˆ é™¤æ–‡ä»¶</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fileManager.reomveItemAtURL(newFileURL!,error:&error)</span></code></pre></td></tr></table></div></figure>


<ul>
<li>ç§»åŠ¨å’Œå¤åˆ¶æ–‡ä»¶</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fileManager.moveItemAtURL(sourceURL!,toURL:destinationURL,error:nil)</span></code></pre></td></tr></table></div></figure>


<p>è¦å¤åˆ¶ä¸€ä¸ªé¡¹ç›®ï¼Œå¯ä»¥è¿™æ ·åš</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>fileManager.copyItemAtURL(sourceURL!,toURL:destinationURL,error:nil)</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>
