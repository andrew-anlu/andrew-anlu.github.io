
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>NSUrlSessionè¯¦è§£ - å®‰è·¯çš„æŠ€æœ¯åšå®¢</title>
  <meta name="author" content="å®‰è·¯">

  
  <meta name="description" content="NSUrlSessionæ˜¯NSUrlConnectionçš„æ›¿ä»£å“ã€‚ NSUrlConennectionæŒ‡çš„æ˜¯ä¸€ç»„æ„æˆ Foundationæ¡†æ¶ä¸­URLåŠ è½½ç³»ç»Ÿçš„ç›¸äº’å…³è”çš„ç»„ä»¶:NSURLRequest,NSUrlResponse,NSURlProtocolç­‰,åœ¨åå•†å‘é€ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨çš„è¿‡ç¨‹ä¸­ï¼Œ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://andrew-anlu.github.io/blog/2016/03/27/nsurlsessionxiang-jie/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="å®‰è·¯çš„æŠ€æœ¯åšå®¢" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//libs.baidu.com/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">å®‰è·¯çš„æŠ€æœ¯åšå®¢</a></h1>
  
    <h2>Nothing in life is to be feared. It is only to be understood</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://andrew-anlu.github.io" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="andrew-anlu.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/">About me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">NSUrlSessionè¯¦è§£</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-27T18:48:28+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:48 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://andrew-anlu.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>NSUrlSessionæ˜¯NSUrlConnectionçš„æ›¿ä»£å“ã€‚</p>

<p>NSUrlConennectionæŒ‡çš„æ˜¯ä¸€ç»„æ„æˆ Foundationæ¡†æ¶ä¸­URLåŠ è½½ç³»ç»Ÿçš„ç›¸äº’å…³è”çš„ç»„ä»¶:NSURLRequest,NSUrlResponse,NSURlProtocolç­‰,åœ¨åå•†å‘é€ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥æœåŠ¡å™¨å¯å‘å‡ºéªŒè¯è´¨è¯¢ï¼Œè¿™å¯ä»¥ç”±å…±äº«çš„cookieï¼Œè¯ä¹¦å­˜å‚¨ï¼ˆcredential storageï¼‰æˆ–é€šè¿‡è¿æ¥å§”æ‰˜è‡ªåŠ¨å¤„ç†ã€‚å¿…è¦çš„æ—¶å€™ï¼Œä¸ºäº†æ— ç¼åœ°æ”¹å˜è£…è½½è¡Œä¸ºï¼Œä¼ å‡ºè¯·æ±‚ä¹Ÿå¯ä»¥è¢«æ³¨å†Œçš„NSURLProtocolå¯¹è±¡æˆªè·.</p>

<!--more-->


<p>ä¸ç®¡æ€æ ·ï¼Œè€ƒè™‘åˆ°NSURLConnectionä½œä¸ºä¸€ä¸ªç½‘ç»œåŸºç¡€æ¶æ„ï¼Œæˆåƒä¸Šä¸‡çš„Cocoaå’ŒCocoa Touchåº”ç”¨ç¨‹åºä»ä¸­è·ç›Šï¼Œå®ƒå·²ç»è¡¨ç°å¾—ç›¸å½“å¥½ã€‚ä½†æ˜¯ï¼Œè¿™äº›å¹´æ¥ï¼ŒiPhoneå’ŒiPadæ–°å…´çš„ç”¨ä¾‹ï¼Œç‰¹åˆ«æ˜¯æœ‰ä¸€äº›å·²ç»å‘NSURLConnectionçš„å‡ ä¸ªæ ¸å¿ƒè®¾æƒ³æå‡ºäº†æŒ‘æˆ˜ï¼Œå¯¹å…¶é‡æ„å·²ç»è¿«åœ¨çœ‰ç«ã€‚</p>

<p>åœ¨2013å¹´çš„WWDCä¸Šï¼ŒAppleæ­å¼€äº†NSURLConnectionç»§ä»»è€…çš„é¢çº±ï¼šNSURLSession.</p>

<p>ä¸NSUrlConnectionç±»ä¼¼ï¼Œé™¤äº†åŒåç±» NSUrlsession,NSUrlSessionæŒ‡çš„æ˜¯ä¸€ç»„ç›¸äº’ä¾èµ–çš„ç±»ï¼ŒNSURlSessionåŒ…æ‹¬ä¸ä¹‹å‰ç›¸åŒçš„ç»„ä»¶ï¼Œä¾‹å¦‚NSUrlRequest,NSURLCatchç­‰ç­‰ã€‚
ã€€ã€€</p>

<h2>NSURlconenction ä¸ NSSessionçš„ä¸åŒ</h2>

<p>ã€€ã€€ä¸NSUrlConnectionç›¸æ¯”ï¼ŒNSUrlSessionæœ€ç›´æ¥çš„æ”¹å–„å°±æ˜¯æä¾›äº†é…ç½®æ¯ä¸ªå›è¯çš„ç¼“å­˜ï¼Œåè®®ï¼Œcookieå’Œè¯ä¹¦ç­–ç•¥(credential policies),ç”šè‡³è·¨åº”ç”¨ç¨‹åºå…±äº«å®ƒä»¬çš„èƒ½åŠ›ã€‚è¿™ä½¿å¾—æ¡†æ¶çš„ç½‘ç»œåŸºç¡€æ¶æ„å’Œéƒ¨åˆ†åº”ç”¨ç¨‹åºç‹¬ç«‹å·¥ä½œï¼Œè€Œä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œæ¯ä¸€ä¸ªNSUrlSessionå¯¹è±¡éƒ½æ˜¯æ ¹æ®ä¸€ä¸ªNSURlSessionConfigurationåˆå§‹åŒ–çš„ï¼Œ
ã€€ã€€
ã€€ã€€</p>

<p>è¯¥NSURlSessionConfigurationæŒ‡å®šäº†ä¸Šé¢æåˆ°çš„ç­–ç•¥ï¼Œä¸€çº§ä¸€ç³»åˆ—ä¸ºäº†æé«˜ç§»åŠ¨è®¾å¤‡æ€§èƒ½è€Œä¸“é—¨æ·»åŠ çš„æ–°é€‰é¡¹ã€‚</p>

<p>NSUrlSessionçš„å¦ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†å°±æ˜¯ä¼šè¯ä»»åŠ¡ï¼Œå®ƒè´Ÿè´£å¤„ç†æ•°æ®çš„åŠ è½½ï¼Œä»¥åŠå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„æ–‡ä»¶å’Œæ•°æ®çš„ä¸Šä¼ å’Œä¸‹è½½ã€‚</p>

<h2>NSURLSessionç®€ä»‹</h2>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Screen-Shot-2015-08-20-at-12.27.21-am.png" alt="logo" /></p>

<p>NSURLsessionå…³é”®å¯¹è±¡è´Ÿè´£æ¥æ”¶å’Œå‘é€httpè¯·æ±‚ï¼Œåˆ›å»ºNSURlSessionConfiguration,è¿™é‡Œæœ‰ä¸‰ç§æ–¹å¼:</p>

<ul>
<li><code>defaultSessionConfiguration</code>åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥å­˜å‚¨ç¼“å­˜ï¼Œåˆ›å»ºè¯ä¹¦å’Œç¼“å­˜cookieç­‰</li>
<li><code>ephemeralSessionConfiguration</code>å’Œé»˜è®¤é…ç½®æ–‡ä»¶å¾ˆç›¸ä¼¼ï¼Œé™¤äº†å®ƒå¯ä»¥åœ¨å†…å­˜ä¸­å­˜å‚¨ä¹‹å¤–ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ªç§æœ‰çš„session</li>
<li><code>backgroundSessionConfiguration</code>è¿™ä¸ªé…ç½®æ–‡ä»¶æ”¯æŒä¸Šä¼ å’Œä¸‹è½½ä»»åŠ¡åœ¨åå°ã€‚å½“ç¨‹åºæŒ‚èµ·æˆ–è€…è¢«ç»ˆæ­¢ä¹‹åä»»åŠ¡å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</li>
</ul>


<p><code>NSURLSessionConfiguration</code>ä¾ç„¶å¯ä»¥è®©ä½ é…ç½®sessionçš„å±æ€§ï¼Œæ¯”å¦‚è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œç¼“å­˜ç­–ç•¥å’Œhttpè¯·æ±‚å¤´ç­‰ã€‚<a href="https://developer.apple.com/library/mac/documentation/Foundation/Reference/NSURLSessionConfiguration_class/index.html#//apple_ref/occ/cl/NSURLSessionConfiguration">è¿™é‡Œ</a>æœ‰å®Œæ•´çš„é…ç½®æ–‡æ¡£ã€‚</p>

<p><code>NSURLSessionTask</code>æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ä»»åŠ¡ç¬¦å·,ä¸€ä¸ªsessionåˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œå®ƒä¸ä»…å¯ä»¥è¯·æ±‚æ•°æ®ï¼Œè¿˜å¯ä»¥ä¸Šä¼ å’Œä¸‹è½½ã€‚</p>

<p>è¿™é‡Œæœ‰ä¸‰ç§ç±»å‹çš„ä»»åŠ¡ï¼š</p>

<ul>
<li><code>NSURLSessionDataTask</code>ï¼šç”¨è¿™ä¸ªä»»åŠ¡å¯ä»¥å‘é€httpè¯·æ±‚ï¼Œä»è€Œä»æœåŠ¡å™¨å¾—åˆ°è¿”å›çš„æ•°æ®</li>
<li><code>NSURLSessionUploadTask</code>ï¼šç”¨è¿™ä¸ªä»»åŠ¡å¯ä»¥ä»æœ¬åœ°ç¡¬ç›˜ä¸Šå¾€æœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯HTTP postè¯·æ±‚æˆ–è€…PUTè¯·æ±‚.</li>
<li><code>NSURLSessionDownloadTask</code>:ç”¨è¿™ä¸ªä»»åŠ¡å¯ä»¥ä»è¿œç¨‹æœåŠ¡å™¨ä¸Šä¸‹è½½æ–‡ä»¶</li>
</ul>


<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Screen-Shot-2015-08-20-at-12.27.27-am.png" alt="logo" /></p>

<p>ä½ å¯ä»¥æŒ‚èµ·ï¼Œå›æ»šå’Œå–æ¶ˆä»»åŠ¡ï¼Œ<code>NSURLSessionDownloadTask</code>è¿˜æœ‰ä¸€ä¸ªç‰¹æ€§å°±æ˜¯æ”¯æŒæ–­ç‚¹ä¸‹è½½ã€‚</p>

<p>ä¸€èˆ¬æ¥è®², NSURLSession æœ‰ä¸¤ç§æ–¹å¼è¿”å›æ•°æ®ï¼š</p>

<ol>
<li>åˆ©ç”¨completion handler,å½“ä»»åŠ¡å®Œæˆä¹‹åï¼Œä¸ç®¡æ˜¯æˆåŠŸè¿”å›è¿˜æ˜¯äº§ç”Ÿé”™è¯¯ï¼›</li>
<li>è¿˜æœ‰ä¸€ç§å°±æ˜¯åˆ©ç”¨NSSessionçš„ä»£ç†ï¼Œä¾ç„¶å¯ä»¥æ•è·åˆ°è¿”å›çš„æ•°æ®;</li>
</ol>


<h2>ç¼–å†™å®ä¾‹Demo</h2>

<p><a href="http://www.raywenderlich.com/wp-content/uploads/2016/01/HalfTunes-Starter.zip">å¯åŠ¨å·¥ç¨‹åœ¨è¿™é‡Œä¸‹è½½</a>,</p>

<p>å¼€å§‹åšä¸€ä¸ª åœ¨Itunesæœç´¢æ­Œæ›²ï¼Œé€šè¿‡<a href="https://www.apple.com/itunes/affiliates/resources/documentation/itunes-store-web-service-search-api.html">Itunes API</a>ä¸‹è½½æ­Œæ›²çš„è¿™ä¹ˆä¸ªå°å·¥ç¨‹ï¼Œæ”¯æŒæš‚åœï¼Œä¸‹è½½åŠŸèƒ½ã€‚</p>

<p>ä¸‹å®Œå·¥ç¨‹ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/Simulator-Screen-Shot-12-Aug-2015-11.10.57-pm-281x500.png" alt="itunes" /></p>

<h3>å¼€å§‹ç¼–å†™ä»£ç </h3>

<p>ä½ å¯ä»¥æ·»åŠ ä»£ç å»æŸ¥è¯¢itunesä¸­çš„æ­Œæ›²ï¼Œé€šè¿‡æŸ¥æ‰¾ Itunes search Api.</p>

<p>åœ¨<code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 1
</span><span class='line'>let defaultSession = NSURLSession(configuration: NSURLSessionConfiguration.defaultSessionConfiguration())
</span><span class='line'>// 2
</span><span class='line'>var dataTask: NSURLSessionDataTask?</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä»£ç åšäº†å¦‚ä¸‹å·¥ä½œ:</p>

<ol>
<li>ç”¨é»˜è®¤çš„é…ç½®æ–‡ä»¶åˆ›å»ºNSURLSession</li>
<li>ä½ å®šä¹‰äº†ä¸€ä¸ª<code>NSURLSessionDataTask</code>å˜é‡ï¼Œç”¨å®ƒå‘é€httpè¯·æ±‚ï¼Œè¿™ä¸ªä»»åŠ¡å°†ä¼šè¢«é‡å¤åˆå§‹åŒ–å’Œé‡å¤åˆ©ç”¨åœ¨ç”¨æˆ·åˆ›å»ºä¸€ä¸ªæ–°æŸ¥è¯¢çš„æ—¶å€™</li>
</ol>


<p>ç°åœ¨ï¼Œæ›¿æ¢<code>searchBarSearchButtonClicked(_:)</code>é‡Œé¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func searchBarSearchButtonClicked(searchBar: UISearchBar) {
</span><span class='line'>  dismissKeyboard()
</span><span class='line'> 
</span><span class='line'>  if !searchBar.text!.isEmpty {
</span><span class='line'>    // 1
</span><span class='line'>    if dataTask != nil {
</span><span class='line'>      dataTask?.cancel()
</span><span class='line'>    }
</span><span class='line'>    // 2
</span><span class='line'>    UIApplication.sharedApplication().networkActivityIndicatorVisible = true
</span><span class='line'>    // 3
</span><span class='line'>    let expectedCharSet = NSCharacterSet.URLQueryAllowedCharacterSet()
</span><span class='line'>    let searchTerm = searchBar.text!.stringByAddingPercentEncodingWithAllowedCharacters(expectedCharSet)!
</span><span class='line'>    // 4
</span><span class='line'>    let url = NSURL(string: "https://itunes.apple.com/search?media=music&entity=song&term=\(searchTerm)")
</span><span class='line'>    // 5
</span><span class='line'>    dataTask = defaultSession.dataTaskWithURL(url!) {
</span><span class='line'>      data, response, error in
</span><span class='line'>      // 6
</span><span class='line'>      dispatch_async(dispatch_get_main_queue()) {
</span><span class='line'>        UIApplication.sharedApplication().networkActivityIndicatorVisible = false
</span><span class='line'>      }
</span><span class='line'>      // 7
</span><span class='line'>      if let error = error {
</span><span class='line'>        print(error.localizedDescription)
</span><span class='line'>      } else if let httpResponse = response as? NSHTTPURLResponse {
</span><span class='line'>        if httpResponse.statusCode == 200 {
</span><span class='line'>          self.updateSearchResults(data)
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>    // 8
</span><span class='line'>    dataTask?.resume()
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿è¡Œåä»£ç å¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160401-1.png" alt="logo" /></p>

<p>å¦‚æœå‡ºç°é”™è¯¯<code>An SSL error has occurred and a secure connection to the server cannot be made.</code></p>

<p>è¯·åœ¨info.plistä¸­é…ç½®ï¼Œåœ¨Info.plistä¸­æ·»åŠ NSAppTransportSecurityç±»å‹Dictionaryã€‚ åœ¨NSAppTransportSecurityä¸‹æ·»åŠ NSAllowsArbitraryLoadsç±»å‹Boolean,å€¼è®¾ä¸º YES</p>

<p>ä¸Šé¢çš„ä»£ç æ­¥éª¤æ„ä¹‰å¦‚ä¸‹:</p>

<ol>
<li>æ£€æŸ¥ç”¨æˆ·æ¯ä¸€æ¬¡æŸ¥è¯¢ï¼ŒdataTaskæ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å–æ¶ˆè¯¥ä»»åŠ¡</li>
<li>è®¾ç½®çš„çŠ¶æ€æ ä¸Šçš„è½¬å­è¿è¡Œèµ·æ¥ï¼Œè¯æ˜æ•°æ®æ­£åœ¨è¯·æ±‚å½“ä¸­</li>
<li>å½“ç”¨æˆ·è¾“å…¥æŸ¥è¯¢å‚æ•°ä¹‹å‰ï¼Œè°ƒç”¨ è¯·æ±‚å­—ç¬¦ä¸²çš„<code>stringByAddingPercentEncodingWithAllowedCharacters(_:)</code>,ç¡®ä¿æ˜¯ä¸€ä¸ªæ­£ç¡®çš„URL.ã€€(è¿™ä¸ª text çš„ç±»å‹æ˜¯ String ï¼Œå¸¸ç”¨äºæœç´¢åŠŸèƒ½ï¼Œåœ¨  URL ä¸­åŒ…å«è¢«æœçš„å…³é”®å­—ï¼Œå¦‚æœä¸å¤„ç†æœä¸­æ–‡æˆ–è€…å¸¦ç©ºæ ¼çš„è‹±æ–‡ä¼šç›´æ¥å´©æºƒ);</li>
<li>ä¸‹ä¸€æ­¥åˆ›å»ºä¸€ä¸ªNSURLç”¨ä¸Šé¢çš„ï¼ˆå®‰å…¨çš„ï¼‰å­—ç¬¦ä¸²ï¼Œä½¿ç”¨GETè¯·æ±‚å»è°ƒç”¨Itunes Search API</li>
<li>ä»åˆ›å»ºçš„Sessionä¸­ï¼Œä½ åˆå§‹åŒ–<code>NSURLSessionDataTask</code>å»å¤„ç†httpè¯·æ±‚ï¼Œè¿™ä¸ª<code>NSURLSessionDataTask</code>ä»»åŠ¡ä½¿ç”¨completion handler ï¼ˆå›è°ƒå‡½æ•°ï¼‰å»å“åº”æœåŠ¡å™¨è¿”å›çš„æ•°æ®</li>
<li>å¼‚æ­¥è°ƒç”¨ä¸»çº¿ç¨‹ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸Šéšè—ç½‘ç»œè¯·æ±‚çš„è½¬å­</li>
<li>å¦‚æœhttpè¯·æ±‚æ˜¯æˆåŠŸçš„ï¼Œä½ å¯ä»¥è°ƒç”¨<code>updateSearchResults(_:)</code>æ¥åˆ·æ–°è¡¨æ ¼æ•°æ®ï¼Œè¿”å›æ•°æ®æ˜¯NSDataç±»å‹çš„ï¼Œéœ€è¦åœ¨updateSearchResultsæ–¹æ³•ä¸­è¿›è¡Œå¤„ç†</li>
<li>æ‰€æœ‰ä»»åŠ¡é»˜è®¤æ˜¯æŒ‚èµ·çŠ¶æ€ï¼Œéœ€è¦ä½ è°ƒç”¨ <code>resume()</code>å»å¯åŠ¨ä»»åŠ¡</li>
</ol>


<h2>ä¸‹è½½</h2>

<p>çœ‹ç€æœç´¢åˆ°çš„æ­Œæ›²ï¼Œæ„Ÿè§‰é¡µé¢ä¸é”™ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡ç‚¹å‡» download,ç„¶åæŠŠæ­Œæ›²ä¸‹è½½åˆ°æœ¬åœ°æ˜¯ä¸æ˜¯æ›´çˆ½å‘¢?ä¸‹ä¸€æ­¥è®©æˆ‘å®ç°è¿™ä¸ªåŠŸèƒ½ç‚¹.</p>

<p>ç”¨å¤šçº¿ç¨‹å®ç°ä¸‹è½½æ˜¯å®¹æ˜“çš„ã€‚é¦–å…ˆä½ è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶å‘½åä¸º <code>Download.swift</code>. æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Download: NSObject {
</span><span class='line'> 
</span><span class='line'>  var url: String
</span><span class='line'>  var isDownloading = false
</span><span class='line'>  var progress: Float = 0.0
</span><span class='line'> 
</span><span class='line'>  var downloadTask: NSURLSessionDownloadTask?
</span><span class='line'>  var resumeData: NSData?
</span><span class='line'> 
</span><span class='line'>  init(url: String) {
</span><span class='line'>    self.url = url
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å±æ€§è¯´æ˜å¦‚ä¸‹:</p>

<ul>
<li>URL:ä¸‹è½½æ–‡ä»¶çš„urlåœ°å€ï¼Œå®ƒä¹Ÿæ‰®æ¼”ç€å”¯ä¸€çš„æ ‡è¯†ç¬¦åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­</li>
<li>isDownloading:æ˜¯å¦æ­£åœ¨ä¸‹è½½æˆ–æš‚åœ</li>
<li>progress : ä¸‹è½½çš„è¿›åº¦,[0-1]</li>
<li>downloadTask: NSURLSessionDownloadTaskä¸‹è½½ä»»åŠ¡</li>
<li>resumeData:å½“ä½ æš‚åœä¸€ä¸ªä¸‹è½½ä»»åŠ¡æ—¶ï¼Œå®ƒè´Ÿè´£å­˜å‚¨æ­¤æ—¶çš„æ•°æ®é‡ï¼›å¦‚æœåå°æœåŠ¡å™¨æ”¯æŒçš„è¯ï¼Œå½“ç”¨æˆ·å†æ¬¡ç‚¹å‡»ç»§ç»­ä¸‹è½½ï¼Œå®ƒä¼šä»è¿™é‡Œå¼€å§‹ç»§ç»­ä¸‹è½½è¿™ä¸ªæ–‡ä»¶ï¼Œä¿—ç§° æ–­ç‚¹ä¸‹è½½</li>
</ul>


<p>åˆ‡æ¢åˆ° <code>SearchViewController.swift</code>ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var activeDownloads = [String: Download]()</span></code></pre></td></tr></table></div></figure>


<h2>åˆ›å»ºä¸‹è½½ä»»åŠ¡</h2>

<p>å‡†å¤‡å·¥ä½œåšå¾—å·®ä¸å¤šäº†ï¼Œç°åœ¨ä½ åªéœ€å®ç°ä¸‹è½½ï¼Œé¦–å…ˆä½ è¦åˆ›å»ºä¸€ä¸ªsessionå»å®ç°ä¸‹è½½ä»»åŠ¡.</p>

<p>åœ¨ <code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œåœ¨<code>viewDidLoad():</code>ä¹‹å‰æ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lazy var downloadsSession: NSURLSession = {
</span><span class='line'>  let configuration = NSURLSessionConfiguration.defaultSessionConfiguration()
</span><span class='line'>  let session = NSURLSession(configuration: configuration, delegate: self, delegateQueue: nil)
</span><span class='line'>  return session
</span><span class='line'>}()</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œåˆå§‹åŒ–äº†ä¸€ä¸ªsession,ç”¨é»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œå»å¤„ç†æ‰€æœ‰çš„ä¸‹è½½ä»»åŠ¡ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šdelegate,è¿™å°†ä¼šä½¿ä½ æ”¶åˆ° <code>NSURLSession</code>çš„ä»£ç†è°ƒç”¨ï¼Œè¿™ä¸ªæ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå®ƒèƒ½æœ‰æ•ˆçš„è·Ÿè¸ªä¸‹è½½ä»»åŠ¡ä¸‹è½½çš„è¿›åº¦å’Œæ˜¯å¦ä¸‹è½½å®Œæˆç­‰ã€‚</p>

<p>è®¾ç½®ä»£ç†çš„é˜Ÿåˆ—æ˜¯nil,ä¼šä¿ƒä½¿sessionåˆ›å»ºä¸€ä¸ªæ“ä½œé˜Ÿåˆ—ï¼Œé»˜è®¤çš„å»è°ƒç”¨ä»£ç†æ–¹æ³•å’Œå›è°ƒæ–¹æ³•.</p>

<p>åœ¨åˆ›å»º<code>downloadsSession</code>å±æ€§çš„æ—¶å€™ï¼Œæˆ‘ä»¬åŠ äº†<code>lazy</code>ç‰¹æ€§ï¼Œè¿™ä¼šè®©ä½ å»¶è¿ŸåŠ è½½è¿™ä¸ªsessionç›´åˆ°ä½ éœ€è¦å®ƒçš„æ—¶å€™ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä¼šé€šè¿‡<code>self</code>ä½œä¸ºä»£ç†å‚æ•°å»åˆå§‹åŒ–ï¼Œå‡å¦‚<code>self</code>è¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚</p>

<p>åœ¨<code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°ç©ºçš„<code>NSURLSessionDownloadDelegate</code>å¹¶ä¸”æ‰©å±•å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>extension SearchViewController: NSURLSessionDownloadDelegate {
</span><span class='line'>  func URLSession(session: NSURLSession, downloadTask: NSURLSessionDownloadTask, didFinishDownloadingToURL location: NSURL) {
</span><span class='line'>    print("Finished downloading.")
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>NSURLSessionDownloadDelegate</code>å®šä¹‰äº†ä»£ç†æ–¹æ³•ä½ éœ€è¦å»å®ç°ï¼Œåœ¨ä½ ä½¿ç”¨ NSURLSession ä¸‹è½½ä»»åŠ¡çš„æ—¶å€™ï¼Œè¿™ä¸ªå”¯ä¸€çš„ä¸æ˜¯å¯é€‰çš„ä»£ç†æ–¹æ³•æ˜¯ <code>URLSession(_:downloadTask:didFinishDownloadingToURL:),</code>,å½“ä¸‹è½½å®Œæˆçš„æ—¶å€™ï¼Œå°†ä¼šæ‰§è¡Œè¿™ä¸ªä»£ç†æ–¹æ³•ï¼Œæ‰“å°ç®€ç­”çš„ä¸€å¥è¯.</p>

<p>åœ¨<code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œæ›¿æ¢<code>startDownload(_:)</code>è¿™ä¸ªæ–¹æ³•çš„ä»£ç å¦‚ä¸‹:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func startDownload(track: Track) {
</span><span class='line'>  if let urlString = track.previewUrl, url =  NSURL(string: urlString) {
</span><span class='line'>    // 1
</span><span class='line'>    let download = Download(url: urlString)
</span><span class='line'>    // 2
</span><span class='line'>    download.downloadTask = downloadsSession.downloadTaskWithURL(url)
</span><span class='line'>    // 3
</span><span class='line'>    download.downloadTask!.resume()
</span><span class='line'>    // 4
</span><span class='line'>    download.isDownloading = true
</span><span class='line'>    // 5
</span><span class='line'>    activeDownloads[download.url] = download
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å½“ä½ ç‚¹å‡» <code>Download</code>æŒ‰é’®çš„æ—¶å€™ï¼Œä½ å°†ä¼šè°ƒç”¨<code>startDownload(_:)</code>å‡½æ•°å»æ‰§è¡Œä¸‹è½½å‘½ä»¤ï¼Œä¸Šé¢çš„ä»£ç æ‰§è¡Œçš„æ­¥éª¤å¦‚ä¸‹:</p>

<ol>
<li>ä½ ç”¨URLå»åˆå§‹åŒ–ä¸€ä¸ªDownLoadå¯¹è±¡</li>
<li>ä½¿ç”¨ä¸Šé¢çš„NSURLå’ŒdownloadsSessionå»åˆå§‹åŒ–<code>NSURLSessionDownloadTask</code></li>
<li>è°ƒç”¨resume()å»å¯åŠ¨ä¸€ä¸ªä¸‹è½½ä»»åŠ¡</li>
<li>è®¾ç½®ä¸‹è½½æ ‡è¯† ä¸ºtrue</li>
<li>æœ€åï¼Œä½ æŠŠä¸‹è½½çš„URLä½œä¸ºkey,downloadå¯¹è±¡ä½œä¸ºå€¼æ”¾åˆ°ä¸€ä¸ªå­—å…¸ä¸­</li>
</ol>


<p>ç¼–è¯‘è¿è¡Œä½ çš„é¡¹ç›®ï¼ŒæŸ¥è¯¢å‡ºæ¥çš„æ­Œæ›²ä¸­ï¼Œç‚¹å‡» DownloadæŒ‰é’®ï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸€ä¸ªæ¶ˆæ¯æ‰“å°åœ¨æ§åˆ¶å°ã€‚
<code>Finished downloading.</code></p>

<h2>ä¿å­˜&amp;æ’­æ”¾</h2>

<p>å½“ä¸‹è½½ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œ<code>URLSession(_:downloadTask:didFinishDownloadingToURL:)</code>æä¾›äº†ä¸€ä¸ªURLå­˜å‚¨ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼Œä½ çš„å·¥ä½œå°±æ˜¯ç§»åŠ¨å®ƒåˆ°ä½ ç¨‹åºçš„æ²™ç›’å½“ä¸­ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•è¿”å›ä¹‹å‰ã€‚å½“ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å½“ä¸­ä½ éœ€è¦åˆ é™¤å…¨å±€å­—å…¸ä¸­æ­£åœ¨ä¸‹è½½çš„downloadå¯¹è±¡ï¼Œå¹¶ä¸”æ›´æ–°è¡¨æ ¼.</p>

<p>ä½ éœ€è¦æ·»åŠ ä¸€ä¸ªHelperæ–¹æ³•ç®€åŒ–è¿™ä¸ªæ“ä½œï¼Œåœ¨<code>SearchViewController.swift</code>ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹æ–¹æ³•:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func trackIndexForDownloadTask(downloadTask: NSURLSessionDownloadTask) -&gt; Int? {
</span><span class='line'>  if let url = downloadTask.originalRequest?.URL?.absoluteString {
</span><span class='line'>    for (index, track) in searchResults.enumerate() {
</span><span class='line'>      if url == track.previewUrl! {
</span><span class='line'>        return index
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>  return nil
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªæ–¹æ³•ä»…ä»…è¿”å› å½“å‰çš„URLåœ¨ searchResultsé›†åˆä¸­çš„ç´¢å¼•ï¼Œä¸‹ä¸€æ­¥ï¼Œæ›¿æ¢ URLSession(_:downloadTask:didFinishDownloadingToURL:) ä¸­çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func URLSession(session: NSURLSession, downloadTask: NSURLSessionDownloadTask, didFinishDownloadingToURL location: NSURL) {
</span><span class='line'>  // 1
</span><span class='line'>  if let originalURL = downloadTask.originalRequest?.URL?.absoluteString,
</span><span class='line'>    destinationURL = localFilePathForUrl(originalURL) {
</span><span class='line'> 
</span><span class='line'>    print(destinationURL)
</span><span class='line'> 
</span><span class='line'>    // 2
</span><span class='line'>    let fileManager = NSFileManager.defaultManager()
</span><span class='line'>    do {
</span><span class='line'>      try fileManager.removeItemAtURL(destinationURL)
</span><span class='line'>    } catch {
</span><span class='line'>      // Non-fatal: file probably doesn't exist
</span><span class='line'>    }
</span><span class='line'>    do {
</span><span class='line'>      try fileManager.copyItemAtURL(location, toURL: destinationURL)
</span><span class='line'>    } catch let error as NSError {
</span><span class='line'>      print("Could not copy file to disk: \(error.localizedDescription)")
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'> 
</span><span class='line'>  // 3
</span><span class='line'>  if let url = downloadTask.originalRequest?.URL?.absoluteString {
</span><span class='line'>    activeDownloads[url] = nil
</span><span class='line'>    // 4
</span><span class='line'>    if let trackIndex = trackIndexForDownloadTask(downloadTask) {
</span><span class='line'>      dispatch_async(dispatch_get_main_queue(), {
</span><span class='line'>        self.tableView.reloadRowsAtIndexPaths([NSIndexPath(forRow: trackIndex, inSection: 0)], withRowAnimation: .None)
</span><span class='line'>      })
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä»£ç åšçš„äº‹æƒ…å¦‚ä¸‹:</p>

<ol>
<li>å®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼Œ<code>originalURL</code>è¯·æ±‚è·¯å¾„çš„url,<code>destinationURL</code>å˜é‡åˆ™æ˜¯é€šè¿‡<code>localFilePathForUrl(_:)</code>æ–¹æ³•ç”Ÿæˆçš„ï¼Œè¯¥æ–¹æ³•ä¼šè·å–å½“å‰ç¨‹åºçš„æ²™ç›’è·¯å¾„å†è¿½åŠ  ä¼ é€’çš„URLçš„æœ€åä¸€ä¸ªåç¼€(/)çš„è·¯å¾„ä½œä¸ºè¿”å›çš„å‚æ•°ã€‚ä½œä¸ºç›®æ ‡æ–‡ä»¶å¤¹çš„è·¯å¾„</li>
<li>ä½¿ç”¨NSFileManager,åœ¨å¼€å§‹æ‹·è´æ–‡ä»¶ä¹‹å‰ï¼Œå…ˆåˆ é™¤ç›®æ ‡æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨çš„è¯ã€‚ç„¶åè¿›è¡Œæ‹·è´ä»æœ¬åœ°æ‹·è´åˆ°ç›®æ ‡æ–‡ä»¶å¤¹</li>
<li>åˆ é™¤downloadä»å…¨å±€çš„downloadå­—å…¸ä¸­</li>
<li>æœ€ååˆ·æ–°è¡¨æ ¼å¯¹åº”çš„å“ªä¸€è¡Œ</li>
</ol>


<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œç‚¹å‡»æœç´¢ç„¶åé€‰ä¸­ä¸€è¡Œè¿›è¡Œä¸‹è½½ï¼Œå½“ä¸‹è½½å®Œæˆæ—¶å€™ï¼Œåœ¨æ§åˆ¶å°ä¼šæ‰“å°ä¸€è¡Œä¿¡æ¯,ä¸‹è½½çš„ç›®æ ‡è·¯å¾„</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>file:///Users/Andrew/Library/Developer/CoreSimulator/Devices/875165C2-FA55-4884-96AE-A7C8E3223C12/data/Containers/Data/Application/52B47648-04A2-4C26-8BCF-F41D2C76CA21/Documents/mzm.gyadmzom.aac.p.m4a</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ—¶ä¸‹è½½æŒ‰é’®å°†ä¼šæ¶ˆå¤±ï¼Œå†æ¬¡ç‚¹å‡»è¡¨æ ¼çš„å¯¹åº”çš„é‚£è¡Œï¼Œå°†ä¼šå¼¹å‡ºä¸€ä¸ª MPMoviePlayerViewController,å¼€å§‹æ’­æ”¾éŸ³é¢‘.</p>

<h2>ç›‘è§†ä¸‹è½½è¿›åº¦</h2>

<p>å½“ç„¶ï¼Œç°åœ¨ä½ è¿˜æ²¡æœ‰ç›‘è§†ä¸‹è½½çš„è¿›åº¦æ¡ï¼Œä¸ºäº†æé«˜ç”¨æˆ·ä½“éªŒï¼Œä½ å°†è¦æ”¹å˜ä½ çš„Appå»ç›‘å¬ä¸‹è½½çš„è¿›åº¦åœ¨æ¯ä¸ªcellä¸­ã€‚</p>

<p>åœ¨SearchViewController.swiftæ–‡ä»¶ä¸­,æ‰¾åˆ° <code>NSURLSessionDownloadDelegate</code>çš„æ‰©å±•ï¼Œç„¶åæ·»åŠ å¦‚ä¸‹çš„ä»£ç†æ–¹æ³•:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func URLSession(session: NSURLSession, downloadTask: NSURLSessionDownloadTask, didWriteData bytesWritten: Int64, totalBytesWritten: Int64, totalBytesExpectedToWrite: Int64) {
</span><span class='line'> 
</span><span class='line'>    // 1
</span><span class='line'>    if let downloadUrl = downloadTask.originalRequest?.URL?.absoluteString,
</span><span class='line'>      download = activeDownloads[downloadUrl] {
</span><span class='line'>      // 2
</span><span class='line'>      download.progress = Float(totalBytesWritten)/Float(totalBytesExpectedToWrite)
</span><span class='line'>      // 3
</span><span class='line'>      let totalSize = NSByteCountFormatter.stringFromByteCount(totalBytesExpectedToWrite, countStyle: NSByteCountFormatterCountStyle.Binary)
</span><span class='line'>      // 4
</span><span class='line'>      if let trackIndex = trackIndexForDownloadTask(downloadTask), let trackCell = tableView.cellForRowAtIndexPath(NSIndexPath(forRow: trackIndex, inSection: 0)) as? TrackCell {
</span><span class='line'>        dispatch_async(dispatch_get_main_queue(), {
</span><span class='line'>          trackCell.progressView.progress = download.progress
</span><span class='line'>          trackCell.progressLabel.text =  String(format: "%.1f%% of %@",  download.progress * 100, totalSize)
</span><span class='line'>        })
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>é€šè¿‡è¿™ä¸ªä»£ç†æ–¹æ³•åšçš„å·¥ä½œå¦‚ä¸‹:</p>

<ol>
<li>ä½¿ç”¨æä¾›çš„ downloadTask æ‰¾åˆ°URLå±æ€§ï¼Œç„¶åä»å…¨å±€æ¿€æ´»çš„ä¸‹è½½å­—å…¸ä¸­æŸ¥æ‰¾ DownLoadå¯¹è±¡</li>
<li>è¿™ä¸ªæ–¹æ³•å°†ä¼šè¿”å›æ€»çš„å­—èŠ‚æ•°å’Œå·²ç»å†™å…¥çš„å­—èŠ‚æ•°ï¼Œä½ å¯ä»¥åˆ©ç”¨è¿™ä¸ªä¸¤ä¸ªå€¼ç®—å‡ºå½“å‰çš„ä¸‹è½½è¿›åº¦å¹¶ä¸”å®æ—¶æ›´æ–°è¿›åº¦æ¡ã€‚</li>
<li>NSByteCountFormatter å°†ä¼šæŠŠå­—èŠ‚æ•°è½¬åŒ–æˆäººç±»èƒ½å¤Ÿçœ‹æ‡‚çš„æ–‡ä»¶å¤§å°ï¼Œæœ‰å°†ä¼šä½¿ç”¨è¿™ä¸ªå­—ç¬¦ä¸²å»æ˜¾ç¤ºä¸‹è½½çš„æ–‡ä»¶å¤§å°å’Œç™¾åˆ†æ¯”</li>
<li>æœ€åï¼Œä½ å°†è¦å®šä½åˆ°è¿™ä¸ªCell,åœ¨ä¸»çº¿ç¨‹ä¸­æ›´æ–°è¿›åº¦æ¡å’Œæ˜¾ç¤ºçš„ç™¾åˆ†æ¯”</li>
</ol>


<p>ä¸‹ä¸€æ­¥ï¼Œä½ å°†è¦é…ç½®è¿™ä¸ªcellå±æ€§å»æ˜¾ç¤ºè¿›åº¦æ¡</p>

<p>æ‰¾åˆ°ä¸‹é¢çš„ä»£ç åœ¨ <code>tableView(_:cellForRowAtIndexPath:):</code>ä¸­</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let downloaded = localFileExistsForTrack(track)</span></code></pre></td></tr></table></div></figure>


<p>æ·»åŠ å¦‚ä¸‹ä»£ç åœ¨è¿™è¡Œçš„ä¸Šé¢:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var showDownloadControls = false
</span><span class='line'>if let download = activeDownloads[track.previewUrl!] {
</span><span class='line'>  showDownloadControls = true
</span><span class='line'> 
</span><span class='line'>  cell.progressView.progress = download.progress
</span><span class='line'>  cell.progressLabel.text = (download.isDownloading) ? "Downloading..." : "Paused"
</span><span class='line'>}
</span><span class='line'>cell.progressView.hidden = !showDownloadControls
</span><span class='line'>cell.progressLabel.hidden = !showDownloadControls</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†è·Ÿè¸ªæ­£åœ¨ä¸‹è½½çš„æ­Œæ›²ï¼Œä½ å°†è¦è®¾ç½® showDownloadControlsä¸ºtrue,å¦åˆ™ï¼Œä½ å°†è¦è®¾ç½®ä¸ºfalse.ä½ å°†è¦æ˜¾ç¤ºè¿™è¿›åº¦æ¡å’Œæ–‡å­—ã€‚</p>

<p>ä¸ºäº†æš‚åœä»»åŠ¡ï¼Œæ˜¾ç¤º"Paused"çŠ¶æ€ï¼Œå¦åˆ™ï¼Œæ˜¾ç¤º â€œDownloading&hellip;.â€
æœ€åï¼Œæ›¿æ¢è¿™è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cell.downloadButton.hidden = downloaded</span></code></pre></td></tr></table></div></figure>


<p>ä½¿ç”¨ä¸‹é¢è¿™è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cell.downloadButton.hidden = downloaded || showDownloadControls</span></code></pre></td></tr></table></div></figure>


<p>åˆ°è¿™ï¼Œä½ å¯ä»¥å‘Šè¯‰è¡¨æ ¼æ˜¯å¦éšè—ä¸‹è½½æŒ‰é’®ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼Œä½ å°†è¦çœ‹åˆ°ä¸€ä¸ªè¿›åº¦æ¡å’Œä¸‹è½½çš„è¿›åº¦ï¼Œä»¥åŠä¸‹è½½çš„ç™¾åˆ†æ¯”ã€‚
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/Screen-Shot-2015-08-17-at-11.02.03-pm-480x78.png" alt="logo" /></p>

<p>OK,ä½ åšåˆ°äº†!ğŸ˜€</p>

<h2>æš‚åœ æ¢å¤  å–æ¶ˆä¸‹è½½ä»»åŠ¡</h2>

<p>å‡å¦‚æˆ‘éœ€è¦æš‚åœä¸€ä¸ªä»»åŠ¡ï¼Œæˆ–è€…å–æ¶ˆä»»åŠ¡ï¼Ÿæ­¤æ—¶è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>

<p>åœ¨è¿™ä¸ªç« èŠ‚ï¼Œä½ å°†è¦å®ç°æš‚åœï¼Œæ¢å¤ï¼Œå–æ¶ˆä»»åŠ¡æ“ä½œã€‚</p>

<p>ä½ å°†è¦å¼€å§‹ç¼–å†™ä»£ç ï¼Œé€šè¿‡å…è®¸ç”¨æˆ·å»å–æ¶ˆä¸€ä¸ªæ­£åœ¨æ¿€æ´»çš„ä»»åŠ¡
æ›¿æ¢ <code>cancelDownload(_:)</code> ä½¿ç”¨ä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func cancelDownload(track: Track) {
</span><span class='line'>  if let urlString = track.previewUrl,
</span><span class='line'>    download = activeDownloads[urlString] {
</span><span class='line'>      download.downloadTask?.cancel()
</span><span class='line'>      activeDownloads[urlString] = nil
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†å–æ¶ˆä»»åŠ¡ï¼Œä½ å¯ä»¥ä»å…¨å±€æ¿€æ´»çš„å­—å…¸ä¸­å–å‡ºDownloadå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„ cancel() æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆå‘½ä»¤ï¼Œç„¶ååœ¨å…¨å±€å­—å…¸ä¸­ç§»é™¤å®ƒ</p>

<p>æš‚åœä»»åŠ¡å’Œå–æ¶ˆä»»åŠ¡éå¸¸ç±»ä¼¼ï¼Œä¸åŒç‚¹åœ¨äºå½“ä½ æš‚åœä¸€ä¸ªä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿæ¢å¤æ•°æ®ï¼Œå®ƒåŒ…å«äº†è¶³å¤Ÿå¤šçš„ä¿¡æ¯å»æ¢å¤ä¸‹è½½æ•°æ®ï¼Œå½“ç„¶åå°æœåŠ¡å™¨å¿…é¡»è¦æ”¯æŒè¿™ä¸ªç‰¹æ€§æ‰èƒ½å®Œå…¨å®ç°æ–­ç‚¹ä¸‹è½½åŠŸèƒ½.</p>

<blockquote><p><strong>æ³¨æ„</strong>
ä½ èƒ½æ¢å¤ä¸€ä¸ªä¸‹è½½ä»»åŠ¡åœ¨ä¸€å®šçš„æ§åˆ¶æ¡ä»¶ä¸‹ï¼Œä¾‹å¦‚ï¼Œä»ä½ ç¬¬ä¸€ä¸‹è¯·æ±‚ä¸‹è½½å¼€å§‹ï¼Œè¿™ä¸ªä¸‹è½½èµ„æºå°±ä¸èƒ½å†æ”¹å˜äº†ã€‚æƒ³è¦æ›´è¯¦ç»†çš„æ§åˆ¶æ¡ä»¶ï¼Œè¯·å‚è€ƒè‹¹æœçš„ <a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSessionDownloadTask_class/index.html#//apple_ref/occ/instm/NSURLSessionDownloadTask/cancelByProducingResumeData:">å®˜æ–¹æ–‡æ¡£</a></p></blockquote>

<p>ç°åœ¨ï¼Œæ›¿æ¢ <code>pauseDownload(_:)</code>ä½¿ç”¨ä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func pauseDownload(track: Track) {
</span><span class='line'>  if let urlString = track.previewUrl,
</span><span class='line'>    download = activeDownloads[urlString] {
</span><span class='line'>      if(download.isDownloading) {
</span><span class='line'>        download.downloadTask?.cancelByProducingResumeData { data in
</span><span class='line'>          if data != nil {
</span><span class='line'>            download.resumeData = data
</span><span class='line'>          }
</span><span class='line'>        }
</span><span class='line'>        download.isDownloading = false
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªå…³é”®å­—æ˜¯ä¸åŒçš„ cancelByProducingResumeData(_:) æ›¿ä»£äº† cancel(),ä½ æ£€ç´¢è¿™ä¸ªæ¢å¤çš„æ•°æ®ä»è¿™ä¸ªæ–¹æ³•cancelByProducingResumeDataæä¾›çš„å›è°ƒå‡½æ•°ä¸­ï¼Œå¹¶ä¸”æŠŠæ¢å¤çš„æ•°æ®ä¿å­˜åˆ°Downloadçš„resumeDataå±æ€§ä¸­ã€‚å¹¶ä¸”è®¾ç½®isDownloading=false</p>

<p>ä¸‹é¢æ›¿æ¢<code>resumeDownload(_:)</code>ç”¨ä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func resumeDownload(track: Track) {
</span><span class='line'>  if let urlString = track.previewUrl,
</span><span class='line'>    download = activeDownloads[urlString] {
</span><span class='line'>      if let resumeData = download.resumeData {
</span><span class='line'>        download.downloadTask = downloadsSession.downloadTaskWithResumeData(resumeData)
</span><span class='line'>        download.downloadTask!.resume()
</span><span class='line'>        download.isDownloading = true
</span><span class='line'>      } else if let url = NSURL(string: download.url) {
</span><span class='line'>        download.downloadTask = downloadsSession.downloadTaskWithURL(url)
</span><span class='line'>        download.downloadTask!.resume()
</span><span class='line'>        download.isDownloading = true
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>å½“ç”¨æˆ·æ¢å¤ä¸€ä¸ªä¸‹è½½ä»»åŠ¡æ—¶ï¼Œä½ æ£€æŸ¥ä¸‹å½“å‰çš„Downloadå¯¹è±¡ æ¢å¤æ•°æ®çš„å±æ€§æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼ï¼Œä½ å°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‹è½½ä»»åŠ¡é€šè¿‡ <code>downloadTaskWithResumeData(_:)</code>å’Œä¸€ä¸ªæ¢å¤æ•°æ®çš„å‚æ•°ï¼Œå¯åŠ¨<code>resume()</code>æ¢å¤æ•°æ®çš„å‘½ä»¤;å¦‚æœè¿™ä¸ª æ¢å¤æ•°æ®çš„å±æ€§æ˜¯ç©ºçš„æˆ–è€…å…¶ä»–ä¸€äº›åŸå› ï¼Œä½ å°†è¦ç”¨URLåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‹è½½ä»»åŠ¡ï¼Œå¯åŠ¨å®ƒ.</p>

<p>åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œä½ è®¾ç½®è¿™ä¸ªisDownloadingä¸ºtrue,è¡¨æ˜ä»»åŠ¡æ­£åœ¨è¿›è¡Œ.</p>

<p>è¿˜æœ‰ä¸€ä»¶äº‹ä»¶è¦åšå°±æ˜¯è®¾ç½®è¿™ä¸‰ä¸ªå‡½æ•°çš„å·¥ä½œå±æ€§ï¼Œä½ éœ€è¦åœ¨cellä¸­æ˜¾ç¤º æˆ–è€…éšè— <code>æš‚åœ</code>ï¼Œ<code>å–æ¶ˆ</code>å’Œ<code>ç»§ç»­ä¸‹è½½</code>æŒ‰é’®ã€‚</p>

<p>æ‰¾åˆ° <code>tableView(_:cellForRowAtIndexPath:)</code>ç„¶åæ‰¾åˆ°ä¸‹é¢è¿™è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if let download = activeDownloads[track.previewUrl!] {</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åæ·»åŠ ä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let title = (download.isDownloading) ? "Pause" : "Resume"
</span><span class='line'>cell.pauseButton.setTitle(title, forState: UIControlState.Normal)</span></code></pre></td></tr></table></div></figure>


<p>æš‚åœå’Œç»§ç»­ä¸‹è½½æŒ‰é’®å…±ç”¨ä¸€ä¸ªæŒ‰é’®ã€‚</p>

<p>ä¸‹ä¸€æ­¥ï¼Œæ·»åŠ ä¸‹é¢çš„ä»£ç åœ¨ <code>tableView(_:cellForRowAtIndexPath:)</code>ç»“å°¾:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cell.pauseButton.hidden = !showDownloadControls
</span><span class='line'>cell.cancelButton.hidden = !showDownloadControls</span></code></pre></td></tr></table></div></figure>


<p>å½“ä¸‹è½½ä»»åŠ¡æ¿€æ´»çš„æ—¶å€™ï¼Œè¿™é‡Œä»…ä»…æŠŠæŒ‰é’®æ˜¾ç¤ºå‡ºæ¥ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œä¸‹è½½å‡ ä¸ªæ­Œæ›²è¯•è¯•ï¼Œä½ å¯ä»¥æš‚åœï¼Œç»§ç»­ä¸‹è½½ï¼Œå–æ¶ˆ ä¸‹è½½ä»»åŠ¡ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Simulator-Screen-Shot-18-Aug-2015-10.14.38-pm-281x500.png" alt="logo" /></p>

<h2>æ”¯æŒåå°ä¸‹è½½</h2>

<p>ä½ çš„Appç°åœ¨çœ‹æ¥å·²ç»å¾ˆä¸é”™äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å¦æ”¯æŒåå°ä»»åŠ¡ä¸‹è½½:å½“ä½ çš„ç¨‹åºè¿›å…¥åå°æ¨¡å¼æˆ–è€…å› ä¸ºåˆ«çš„åŸå› æ„å¤–ç»ˆæ­¢äº†ï¼Œåå°ä»»åŠ¡æ˜¯å¦èƒ½ç»§ç»­ä¸‹è½½?</p>

<p>å‡å¦‚ä½ çš„Appä¸å†è¿è¡Œäº†ï¼Œé‚£å®ƒæ€ä¹ˆèƒ½ç»§ç»­å·¥ä½œå‘¢ï¼Ÿè¿™å„¿æœ‰ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹åœ¨Appè¿è¡Œä¹‹å¤–ï¼Œå»ç®¡ç†åå°ä»»åŠ¡ä¸‹è½½ï¼›å®ƒå‘é€ä¸€ä¸ªé€‚å½“çš„ä»£ç†æ–¹æ³•é€šçŸ¥ç»™appè®©å…¶ä»»åŠ¡ä¸‹è½½ç»§ç»­ï¼Œå½“è¿™ä¸ªappæ­£åœ¨ä¸‹è½½çš„æ—¶å€™çªç„¶é€€å‡ºï¼Œè¿™ä¸ªä»»åŠ¡å°†è¦ç»§ç»­ä¸‹è½½ã€‚</p>

<p>å½“ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œè¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹å°†è¦é‡æ–°åŠ è½½åœ¨åå°æ¨¡å¼ä¸­ï¼Œè¿™ä¸ªé‡æ–°åŠ è½½appå°†è¦é‡æ–°è¿æ¥è¿™åŒæ ·çš„session.æ”¶åˆ°ç›¸å…³çš„å®Œæˆçš„ä»£ç†æ¶ˆæ¯å¹¶ä¸”æ‰§è¡Œä¸€äº›è¦æ±‚çš„åŠ¨ä½œï¼Œæ¯”å¦‚æŒä¹…åŒ–ä¸‹è½½çš„æ–‡ä»¶åˆ°ç¡¬ç›˜ä¸Šç­‰ã€‚</p>

<blockquote><p><em>æ³¨æ„</em>
å¦‚æœä½ å¼ºåˆ¶é€€å‡ºappé€šè¿‡app switcheï¼Œè¿™ä¸ªç³»ç»Ÿå°†è¦å–æ¶ˆæ‰€æœ‰åå°ä¸‹è½½çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¸ä¼šå†è§†å›¾é‡å¯è¿™ä¸ªapp</p></blockquote>

<p>ä»ç„¶åœ¨SearchViewController.swiftè¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œåœ¨åˆå§‹åŒ– <code>downloadsSession</code>çš„åœ°æ–¹ï¼Œæ‰¾åˆ°ä¸‹é¢è¿™è¡Œä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let configuration = NSURLSessionConfiguration.defaultSessionConfiguration()
</span></code></pre></td></tr></table></div></figure>


<p>æ›¿æ¢æˆä¸‹é¢çš„ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let configuration = NSURLSessionConfiguration.backgroundSessionConfigurationWithIdentifier("bgSessionConfiguration")</span></code></pre></td></tr></table></div></figure>


<p>æ›¿æ¢é»˜è®¤çš„sessioné…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šä¸€ä¸ªç‰¹æ®Šçš„åå°sessioné…ç½®æ–‡ä»¶ï¼Œæ³¨æ„ä½ è®¾ç½®äº†å”¯ä¸€çš„IDä¸ºè¿™ä¸ªsession,è¿™ä¼šå…è®¸ä½ å¼•ç”¨å¹¶ä¸”é‡æ–°è¿æ¥åŒæ ·çš„åå°session.</p>

<p>ä¸‹ä¸€æ­¥ï¼Œåœ¨ viewDidLoad()ä¸­ï¼Œå¢åŠ å¦‚ä¸‹ä»£ç :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_ = self.downloadsSession</span></code></pre></td></tr></table></div></figure>


<p>è°ƒç”¨æ‡’åŠ è½½å±æ€§<code>downloadsSession</code>,ç¡®ä¿åº”ç”¨ç¨‹åºç¡®å®åˆ›å»ºäº†ä¸€ä¸ªåå°session çš„SearchViewControllerçš„å®ä¾‹ã€‚</p>

<p>å½“ä¸€ä¸ªåå°ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œè¿™ä¸ªAppä¸å†è¿è¡Œï¼Œè¿™ä¸ªappå°†ä¼šé‡æ–°è¿è¡Œåˆ°åå°è¿›ç¨‹ä¸­ï¼Œä½ éœ€è¦å»å¤„ç†ä½ çš„appçš„ä¸€äº›ä»£ç†æ–¹æ³•.</p>

<p>åˆ‡æ¢åˆ° AppDelegate.swift,æ·»åŠ ä¸‹é¢çš„ä»£ç åœ¨ç±»çš„é¡¶éƒ¨:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var backgroundSessionCompletionHandler: (() -&gt; Void)?</span></code></pre></td></tr></table></div></figure>


<p>ä¸‹ä¸€æ­¥ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç åœ¨AppDelegate.swift:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func application(application: UIApplication, handleEventsForBackgroundURLSession identifier: String, completionHandler: () -&gt; Void) {
</span><span class='line'>  backgroundSessionCompletionHandler = completionHandler
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>æä¾›ä¸€ä¸ªcompletionHandlerä½œä¸ºä¸€ä¸ªå˜é‡åœ¨ä½ çš„Appä»£ç†æ–¹æ³•ä¸­ï¼Œç­‰ä¼šä¼šç”¨åˆ°ã€‚</p>

<p>application(_:handleEventsForBackgroundURLSession:)ä¼šå”¤é†’è¿™ä¸ªAppå¤„ç†å®Œæˆè¿™ä¸ªåå°ä»»åŠ¡ï¼Œä½ éœ€è¦å»å¤„ç†ä¸¤ä¸ªäº‹æƒ…ï¼š</p>

<ul>
<li>é¦–å…ˆï¼Œé€šè¿‡ä»£ç†æ–¹æ³•ç”¨è¿™ä¸ªAppå»é‡æ–°è¿æ¥è¿™ä¸ªåå°session,ä¸€æ—¦ä½ åˆ›å»ºå¹¶ä¸”æ¯æ¬¡ä½¿ç”¨åå°sessionæ—¶ï¼ŒSearchViewControllerå°±ä¼šè¢«å®ä¾‹åŒ–ï¼Œä½ å·²ç»é‡æ–°è¿æ¥äº†.</li>
<li>ç¬¬äºŒï¼Œä½ éœ€è¦å»æ•è·å®Œæˆçš„å›è°ƒæ–¹æ³•ï¼Œåœ¨å®Œæˆçš„å›è°ƒå‡½æ•°ä¸­ï¼Œæ›´æ–°ä½ çš„UI,ç„¶åå‘Šè¯‰ç³»ç»Ÿä½ çš„Appå·²ç»å·¥ä½œå®Œæ¯•ä½¿ç”¨åå°ä»»åŠ¡çš„session.</li>
</ul>


<p>ä½†æ˜¯ä»€ä¹ˆæ—¶å€™ä½ å°†ä¼šè°ƒç”¨å®Œæˆçš„å›è°ƒå‡½æ•°å‘¢ï¼Ÿ
<code>URLSessionDidFinishEventsForBackgroundURLSession(_:)</code>å°†ä¼šæ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œå®ƒæ˜¯NSURLSessionDelegateçš„ä¸€ä¸ªä»£ç†æ–¹æ³•ï¼Œå½“æ‰€æœ‰çš„ä»»åŠ¡åœ¨åå°sessionä¸­å®Œæˆçš„æ—¶å€™ã€‚</p>

<p>å®ç°ä¸‹é¢çš„æ‰©å±•åœ¨<code>SearchViewController.swift</code>ä¸­</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>extension SearchViewController: NSURLSessionDelegate {
</span><span class='line'> 
</span><span class='line'>  func URLSessionDidFinishEventsForBackgroundURLSession(session: NSURLSession) {
</span><span class='line'>    if let appDelegate = UIApplication.sharedApplication().delegate as? AppDelegate {
</span><span class='line'>      if let completionHandler = appDelegate.backgroundSessionCompletionHandler {
</span><span class='line'>        appDelegate.backgroundSessionCompletionHandler = nil
</span><span class='line'>        dispatch_async(dispatch_get_main_queue(), {
</span><span class='line'>          completionHandler()
</span><span class='line'>        })
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä»£ç ä»…ä»…æŠ“å–äº†åœ¨APPDelegateä¸­å­˜å‚¨çš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”åœ¨ä¸»çº¿ä¸­è°ƒç”¨å®ƒ.</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œå¼€å§‹å‡ ä¸ªä¸‹è½½ä¹‹åè¿…é€ŸæŒ‰åœ¨homeé”®ï¼Œä½¿å¾—ä¸‹è½½ä»»åŠ¡è¿›å…¥åå°ï¼Œç­‰å‡ åç§’ä½ çš„ä¸‹è½½ä»»åŠ¡å°†ä¼šå®Œæˆï¼Œç„¶ååŒå‡»home,å…³é—­å½“å‰ç¨‹åºã€‚</p>

<p>ä¸‹è½½ä»»åŠ¡å°†ä¼šå®Œæˆå¹¶ä¸”ä»–ä»¬å°†ä¼šæ›´æ–°æ˜¾ç¤ºçŠ¶æ€ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Simulator-Screen-Shot-19-Aug-2015-1.06.24-am-281x500.png" alt="logo" /></p>

<p>OKï¼Œè¿™ä¸ªdemoå·²ç»å®Œå¤‡äº†ã€‚</p>

<h2>å®Œæ•´å·¥ç¨‹ä¸‹è½½</h2>

<p>ä½ å¯ä»¥ä¸‹è½½å®Œæ•´çš„å·¥ç¨‹ä» <a href="http://www.raywenderlich.com/wp-content/uploads/2016/01/HalfTunes-Final.zip">è¿™é‡Œ</a></p>

<p>æ›´å¤šèµ„æº</p>

<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSession_class/">è‹¹æœçš„å®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="https://github.com/Alamofire/Alamofire">AlamoFire</a>æ˜¯Swiftä¸­éå¸¸æµè¡Œçš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œå¯ä»¥å­¦ä¹ ä¸€ä¸‹.</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">å®‰è·¯</span></span>

      




<time class='entry-date' datetime='2016-03-27T18:48:28+08:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>6:48 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ios/'>ios</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  

<!-- JiaThis Button BEGIN -->
<div class="jiathis_style_32x32">
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_tqq"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->
<br><br>
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2052593"></script>
<!-- UY END -->

</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/03/26/nsoperationqueuejian-dan-jie-shao/" title="Previous Post: NSOperationQueueç®€å•ä»‹ç»">&laquo; NSOperationQueueç®€å•ä»‹ç»</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/03/29/shen-ru-li-jie-runloop/" title="Next Post: æ·±å…¥ç†è§£RunLoop">æ·±å…¥ç†è§£RunLoop &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
<h1>
	QQç¾¤
</h1>
   <br/>
	<p>æ¬¢è¿åŠ å…¥swiftå­¦ä¹ äº¤æµç¾¤:252710124</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/05/04/catransform3d/">CATransform3D</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/04/runtimeyun-xing-shi-ru-men/">Runtimeè¿è¡Œæ—¶å…¥é—¨</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/29/macshang-ru-he-ba-shi-pin-zhuan-cheng-dot-gif/">Macä¸Šå¦‚ä½•æŠŠè§†é¢‘è½¬æˆ.Gif</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/28/viewcontrollerzhuan-chang-dong-hua/">ViewControllerè½¬åœºåŠ¨ç”»</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/26/zi-ding-yi-asyncdisplaykit-node/">è‡ªå®šä¹‰AsyncDisplayKit-Node</a>
      </li>
    
  </ul>
</section>
<section>
	<h1>æ–‡ç« åˆ†ç±»</h1>
	<ul id="categories">
		<li class='category'><a href='/blog/categories/cocoapods/'>cocoapods (1)</a></li>
<li class='category'><a href='/blog/categories/git/'>git (3)</a></li>
<li class='category'><a href='/blog/categories/ios/'>ios (19)</a></li>
<li class='category'><a href='/blog/categories/life/'>life (1)</a></li>
<li class='category'><a href='/blog/categories/mac/'>mac (2)</a></li>
<li class='category'><a href='/blog/categories/octopress/'>octopress (2)</a></li>
<li class='category'><a href='/blog/categories/swift/'>swift (10)</a></li>
<li class='category'><a href='/blog/categories/xcode/'>xcode (1)</a></li>

	</ul>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/andrew-anlu">@andrew-anlu</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'andrew-anlu',
            count: 3,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>On Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/Andrewswift1987?count=3&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
  <p><a href="http://delicious.com/Andrewswift1987">My Delicious Bookmarks &raquo;</a></p>
</section>

 <section>
      <h1>è®¿å®¢ç»Ÿè®¡</h1>
      <br/>
    <a href="http://info.flagcounter.com/Bkif"><img src="http://s01.flagcounter.com/count2/Bkif/bg_ffffff/txt_000000/border_CCCCCC/columns_3/maxflags_10/viewers_0/labels_1/pageviews_1/flags_1/percent_0/" alt="Free counters!" border="0"></a>
    </section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><!--è¿”å›é¡¶éƒ¨å¼€å§‹-->
<div id="full" style="width:0px; height:0px; position:fixed; right:180px; bottom:150px; z-index:100; text-align:center; background-color:transparent; cursor:pointer;">
  <a href="#" onclick="goTop();return false;"><img src="http://7xsn4e.com2.z0.glb.clouddn.com/top.png" border=0 alt="è¿”å›é¡¶éƒ¨" width="50" height="50"></a>
</div>
<script src="/javascripts/top.js" type="text/javascript"></script>
<!--è¿”å›é¡¶éƒ¨ç»“æŸ-->


<p>
  Copyright &copy; 2016 - å®‰è·¯ -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'Andrewswift1987';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://andrew-anlu.github.io/blog/2016/03/27/nsurlsessionxiang-jie/';
        var disqus_url = 'http://andrew-anlu.github.io/blog/2016/03/27/nsurlsessionxiang-jie/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
