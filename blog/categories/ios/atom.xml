<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Ios | å®‰è·¯çš„æŠ€æœ¯åšå®¢]]></title>
  <link href="http://andrew-anlu.github.io/blog/categories/ios/atom.xml" rel="self"/>
  <link href="http://andrew-anlu.github.io/"/>
  <updated>2016-04-29T13:09:51+08:00</updated>
  <id>http://andrew-anlu.github.io/</id>
  <author>
    <name><![CDATA[å®‰è·¯]]></name>
    <email><![CDATA[andrewswift1987@gamil.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ViewControllerè½¬åœºåŠ¨ç”»]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/28/viewcontrollerzhuan-chang-dong-hua/"/>
    <updated>2016-04-28T15:54:40+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/28/viewcontrollerzhuan-chang-dong-hua</id>
    <content type="html"><![CDATA[<h2>è‡ªå®šä¹‰è½¬åœºåŠ¨ç”»</h2>

<p>ios7ä¸­æœ€è®©æˆ‘æ¿€åŠ¨çš„ç‰¹æ€§ä¹‹ä¸€å°±æ˜¯æä¾›äº†æ–°çš„APIæ¥æ”¯æŒè‡ªå®šä¹‰ViewControllerä¹‹é—´çš„è½¬åœºåŠ¨ç”»ã€‚</p>

<!--more-->


<p>åœ¨å¼€å§‹ç ”ç©¶æ–°çš„APIä¹‹é—´ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ios7ä¸­ navigation controllerä¹‹é—´é»˜è®¤çš„è¡Œä¸ºå‘ç”Ÿäº†é‚£äº›æ”¹å˜:åœ¨navigation controllerä¸­ï¼Œåˆ‡æ¢ä¸¤ä¸ªview controllerçš„åŠ¨ç”»å˜å¾—æ›´æœ‰äº¤äº’æ€§ã€‚æ¯”æ–¹è¯´ä½ æƒ³è¦popä¸€ä¸ªview controllerå‡ºå»ï¼Œä½ å¯ä»¥ç”¨æ‰‹æŒ‡ä»å±å¹•çš„å·¦è¾¹ç¼˜å¼€å§‹æ‹–åŠ¨ï¼Œæ…¢æ…¢åœ°æŠŠå½“å‰çš„viewcontrollerå‘å³æ‹–å‡ºå±å¹•å».</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ–°APIã€‚å¾ˆæœ‰è¶£ï¼Œè¿™éƒ¨åˆ†APIå¤§é‡çš„ä½¿ç”¨äº†åè®®è€Œä¸æ˜¯å…·ä½“çš„å¯¹è±¡ã€‚è¿™åˆçœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªï¼Œä½†æ˜¯æˆ‘æ›´å–œæ¬¢è¿™æ ·çš„è®¾è®¡ï¼Œå› ä¸ºè¿™ç§è®¾è®¡ç»™æˆ‘ä»¬è¿™äº›å¼€å‘è€…æ›´å¤§çš„çµæ´»æ€§ã€‚ä¸‹é¢ï¼Œè®©æˆ‘ä»¬æ¥åšä»¶ç®€å•çš„äº‹æƒ…:åœ¨Navigation Controllerä¸­ï¼Œå®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„pushåŠ¨ç”»æ•ˆæœï¼Œä¸ºäº†å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œéœ€è¦å®ç°UINavigationControllerDelegateä¸­çš„æ–°æ–¹æ³•:</p>

<pre><code>- (id&lt;UIViewControllerAnimatedTransitioning&gt;)
                   navigationController:(UINavigationController *)navigationController
        animationControllerForOperation:(UINavigationControllerOperation)operation
                     fromViewController:(UIViewController*)fromVC
                       toViewController:(UIViewController*)toVC
{
    if (operation == UINavigationControllerOperationPush) {
        return self.animator;
    }
    return nil;
}
</code></pre>

<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸åŒçš„æ“ä½œ(pushæˆ–pop)è¿”å›ä¸åŒçš„animator.æˆ‘ä»¬å¯ä»¥æŠŠanmitorå­˜åˆ°ä¸€ä¸ªå±æ€§ä¸­ï¼Œä»è€Œåœ¨å¤šä¸ªæ“ä½œä¹‹é—´å®ç°å…±äº«ï¼Œæˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºæ¯ä¸ªæ“ä½œéƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„animatorå¯¹è±¡ï¼Œè¿™é‡Œçš„çµæ´»æ€§å¾ˆå¤šã€‚</p>

<p>ä¸ºäº†è®©åŠ¨ç”»è¿è¡Œèµ·æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ç±»ï¼Œå¹¶ä¸”å®ç°<code>UIViewControllerAnimatedTransitioning</code>è¿™ä¸ªåè®®:</p>

<pre><code>@interface Animator : NSObject &lt;UIViewControllerAnimatedTransitioning&gt;

@end
</code></pre>

<p>è¿™ä¸ªåè®®è¦æ±‚æˆ‘ä»¬å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­ä¸€ä¸ªå®šä¹‰äº†åŠ¨ç”»çš„æŒç»­æ—¶é—´:</p>

<pre><code>- (NSTimeInterval)transitionDuration:(id &lt;UIViewControllerContextTransitioning&gt;)transitionContext
{
    return 0.25;
}
</code></pre>

<p>å¦ä¸€ä¸ªæ–¹æ³•æè¿°æ•´ä¸ªåŠ¨ç”»çš„æ‰§è¡Œæ•ˆæœ ï¼š</p>

<pre><code>- (void)animateTransition:(id&lt;UIViewControllerContextTransitioning&gt;)transitionContext
{
    UIViewController* toViewController = [transitionContext viewControllerForKey:UITransitionContextToViewControllerKey];
    UIViewController* fromViewController = [transitionContext viewControllerForKey:UITransitionContextFromViewControllerKey];
    [[transitionContext containerView] addSubview:toViewController.view];
    toViewController.view.alpha = 0;

    [UIView animateWithDuration:[self transitionDuration:transitionContext] animations:^{
        fromViewController.view.transform = CGAffineTransformMakeScale(0.1, 0.1);
        toViewController.view.alpha = 1;
    } completion:^(BOOL finished) {
        fromViewController.view.transform = CGAffineTransformIdentity;
        [transitionContext completeTransition:![transitionContext transitionWasCancelled]];

    }];

}
</code></pre>

<p>ä»ä¸Šé¢çš„ä¾‹å­æ±‡æ€»ï¼Œä½ å¯ä»¥çœ‹åˆ°å¦‚ä½•è¿ç”¨æ´—è¡£çš„ï¼šè¿™ä¸ªæ–¹æ³•ä¸­é€šè¿‡æ¥å—ä¸€ä¸ªç±»å‹ä¸º<code>id&lt;UIViewControllerContextTransitioning&gt;</code>çš„å‚æ•°ï¼Œæ¥è·å–transition context.å€¼çš„æ³¨æ„çš„æ˜¯ï¼Œæ‰§è¡Œå®ŒåŠ¨ç”»ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨transitionContextçš„<code>completeTransition :</code>è¿™ä¸ªæ–¹æ³•æ¥æ›´æ–°ViewControllerçš„çŠ¶æ€ã€‚å‰©ä¸‹çš„ä»£ç å’Œios7ä¹‹å‰çš„ä¸€æ ·äº†ï¼Œæˆ‘ä»¬ä»transition context ä¸­å¾—åˆ°äº†éœ€è¦åšè½¬åœºçš„ä¸¤ä¸ªView controller,ç„¶åä½¿ç”¨æœ€ç®€å•çš„Uiview animationæ¥å®ç°è½¬åœºåŠ¨ç”»ã€‚è¿™å°±æ˜¯å…¨éƒ¨ä»£ç äº†ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ç¼©æ”¾æ•ˆæœçš„è½¬åœºåŠ¨ç”»äº†ã€‚</p>

<p>æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯ä¸ºpushæ“ä½œå®ç°äº†è‡ªå®šä¹‰æ•ˆæœçš„è½¬åœºåŠ¨ç”»ï¼Œå¯¹äºpopæ“ä½œï¼Œè¿˜æ˜¯ä¼šä½¿ç”¨é»˜è®¤çš„æ»‘åŠ¨æ•ˆæœï¼Œå¦å¤–ï¼Œä¸Šé¢æˆ‘ä»¬å®ç°çš„è½¬åœºåŠ¨ç”»æ— æ³•äº¤äº’ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>

<h2>äº¤äº’å¼çš„è½¬åœºåŠ¨ç”»</h2>

<p>æƒ³è¦åŠ¨ç”»å˜åœ°äº¤äº’éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦è¦†ç›–å¦ä¸€ä¸ªUINavigationControllerDelegateçš„æ–¹æ³•:</p>

<pre><code>- (id &lt;UIViewControllerInteractiveTransitioning&gt;)navigationController:(UINavigationController*)navigationController
                          interactionControllerForAnimationController:(id &lt;UIViewControllerAnimatedTransitioning&gt;)animationController
{
    return self.interactionController;
}
</code></pre>

<p>æ³¨æ„ï¼Œåœ¨éäº¤äº’å¼åŠ¨ç”»æ•ˆæœä¸­ï¼Œè¯¥æ–¹æ³•è¿”å›nil.</p>

<p>è¿™é‡Œè¿”å›çš„interaction controlleræ˜¯<code>UIPercentDrivenInteractionTransition</code>ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¼€å‘è€…ä¸éœ€è¦ä»»ä½•é…ç½®å°±å¯ä»¥å·¥ä½œã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ‹–åŠ¨æ”¶æ‹¾(Pan REcognizer),ä¸‹é¢æ˜¯å¤„ç†è¯¥æ‰‹åŠ¿çš„ä»£ç :</p>

<pre><code>if (panGestureRecognizer.state == UIGestureRecognizerStateBegan) {
    if (location.x &gt;  CGRectGetMidX(view.bounds)) {
        navigationControllerDelegate.interactionController = [[UIPercentDrivenInteractiveTransition alloc] init];
        [self performSegueWithIdentifier:PushSegueIdentifier sender:self];
    }
} 
</code></pre>

<p>åªæœ‰å½“ç”¨æˆ·ä»å±å¹•çš„å³åŠéƒ¨åˆ†å¼€å§‹è§¦æ‘¸çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰æŠŠä¸‹ä¸€æ¬¡åŠ¨ç”»æ•ˆæœè®¾ç½®ä¸ºäº¤äº’çš„ï¼ˆé€šè¿‡è®¾ç½®interactionControllerè¿™ä¸ªå±æ€§æ¥å®ç°ï¼‰ï¼Œç„¶åæ‰§è¡Œæ–¹æ³•performSegueWithIdentifier:ï¼ˆå¦‚æœä½ ä¸æ˜¯ä½¿ç”¨çš„storyboards,é‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨pushViewController&hellip;è¿™ç±»æ–¹æ³•ï¼‰ã€‚ä¸ºäº†è®©è½¬åœºåŠ¨ç”»æŒç»­è¿›è¡Œï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ interaction controllerçš„ä¸€ä¸ªæ–¹æ³•:</p>

<pre><code>else if (panGestureRecognizer.state == UIGestureRecognizerStateChanged) {
    CGFloat d = (translation.x / CGRectGetWidth(view.bounds)) * -1;
    [interactionController updateInteractiveTransition:d];
} 
</code></pre>

<p>è¯¥æ–¹æ³•ä¼šæ ¹æ®ç”¨æˆ·æ‰‹æŒ‡æ‹–åŠ¨çš„è·ç¦»è®¡ç®—ä¸€ä¸ªç™¾åˆ†æ¯”ï¼Œåˆ‡æ¢çš„åŠ¨ç”»æ•ˆæœä¹Ÿéšç€è¿™ä¸ªç™¾åˆ†æ¯”æ¥èµ°ï¼Œæœ€é…·çš„æ˜¯ï¼Œinteraction controllerä¼šå’Œanimation controllerä¸€èµ·åä½œï¼Œæˆ‘ä»¬åªä½¿ç”¨äº†ç®€å•çš„UIView animationçš„åŠ¨ç”»æ•ˆæœï¼Œä½†æ˜¯interaction controllerå´æ§åˆ¶äº†åŠ¨ç”»çš„æ‰§è¡Œè¿›åº¦ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å§interaction controllerå’ŒAnimation controllerå…³è”èµ·æ¥ï¼Œå› ä¸ºæ‰€æœ‰è¿™äº›ç³»ç»Ÿéƒ½ä»¥ä¸€ç§è§£è€¦çš„æ–¹å¼è‡ªåŠ¨åœ°æ›¿æˆ‘ä»¬å®Œæˆäº†ã€‚</p>

<p>æœ€å</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[è‡ªå®šä¹‰ColletionViewå¸ƒå±€]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/24/zi-ding-yi-colletionviewbu-ju/"/>
    <updated>2016-04-24T21:05:32+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/24/zi-ding-yi-colletionviewbu-ju</id>
    <content type="html"><![CDATA[<p>UICollectionViewåœ¨ios6ä¸­ç¬¬ä¸€æ¬¡è¢«å¼•å…¥ï¼Œä¹Ÿæ˜¯UIKit <a href="http://oleb.net/blog/2012/09/uicollectionview/">è§†å›¾ç±»ä¸­çš„ä¸€é¢—æ–°æ˜Ÿ</a>
ã€‚å®ƒå’ŒUITableviewå…±äº«ä¸€å¥—APIè®¾è®¡ï¼Œä½†ä¹Ÿåœ¨UItableViewä¸Šåšäº†ä¸€äº›æ‰©å±•ã€‚UICOllectionViewæœ€å¼ºå¤§ï¼ŒåŒæ—¶æ˜¾è‘—è¶…å‡ºUITableViewçš„ç‰¹è‰²å°±æ˜¯å…¶å®Œå…¨çµæ´»çš„å¸ƒå±€ç»“æ„ã€‚è¿™è¿™ç¯‡æ–‡ç« ä¸­ï¼Œ<!--more--> æˆ‘ä»¬å°†ä¼šå®ç°ä¸€ä¸ªç›¸å½“å¤æ‚çš„è‡ªå®šä¹‰Collection viewå¸ƒå±€ï¼Œå¹¶ä¸”é¡ºä¾¿è®¨è®ºä¸€ä¸‹è¿™ä¸ªç±»è®¾è®¡çš„é‡è¦éƒ¨åˆ†ï¼Œé¡¹ç›®çš„å®ä¾‹ä»£ç åœ¨ <a href="https://github.com/objcio/issue-3-collection-view-layouts">GitHub</a>ä¸Šã€‚</p>

<h2>å¸ƒå±€å¯¹è±¡(Layout Objects)</h2>

<p>UITableViewå’ŒUICollectionViewéƒ½æ˜¯ data-sourceå’Œdelegateé©±åŠ¨çš„ã€‚ä»–ä»¬åœ¨æ˜¾ç¤ºå…¶å­è§†å›¾é›†çš„è¿‡ç¨‹ä¸­ä»…æ‰®æ¼”å®¹å™¨è§’è‰²,ä¸”å¯¹å­è§†å›¾é›†çœŸæ­£çš„å†…å®¹æ¯«ä¸çŸ¥æƒ…ã€‚</p>

<p>UICollectioNViewåœ¨æ­¤ä¹‹ä¸Šè¿›è¡Œäº†è¿›ä¸€æ­¥æŠ½è±¡ã€‚å®ƒå°†å­è§†å›¾çš„ä½ç½®ï¼Œå¤§å°å’Œå¤–è§‚çš„æ§åˆ¶æƒæ‹–è¿‡ç»™ä¸€ä¸ªå•ç‹¬çš„å¸ƒå±€å¯¹è±¡ã€‚é€šè¿‡æä¾›ä¸€ä¸ªè‡ªå®šä¹‰å¸ƒå±€å¯¹è±¡ï¼Œä½ æŠ€æœ¯å¯ä»¥å®ç°ä»»ä½•ä½ èƒ½æƒ³è±¡åˆ°çš„å¸ƒå±€ã€‚å¸ƒå±€ç»§æ‰¿è‡ªUICollectionVieLayoutæŠ½è±¡åŸºç±».IOS6ä¸­ä»¥UICollectionViewFloyLayoutç±»çš„å½¢å¼æå‡ºäº†ä¸€ä¸ªå…·ä½“çš„å¸ƒå±€å®ç°ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨flow layoutå®ç°ä¸€ä¸ªæ ‡å‡†çš„gridview,è¿™å¯èƒ½æ˜¯colle tion viewä¸­æœ€å¸¸è§çš„ä½¿ç”¨æ¡ˆä¾‹äº†ã€‚å°½ç®¡å¤§å¤šæ•°äººéƒ½è¿™ä¹ˆæƒ³ï¼Œä½†æ˜¯Appleå¾ˆèªæ˜ï¼Œæ²¡æœ‰æ˜ç¡®çš„å‘½åè¿™ä¸ªç±»ä¸ºUIColletionViewGridLayout,è€Œä½¿ç”¨äº†æ›´ä¸ºé€šç”¨çš„æœ¯è¯­ flow layout,æ›´å¥½çš„æè¿°äº†è¯¥ç±»çš„åŠŸèƒ½ï¼šå®ƒé€šè¿‡ä¸€ä¸ªæ¥ä¸€ä¸ªçš„æ”¾ç½®cellæ¥å»ºç«‹è‡ªå·±çš„å¸ƒå±€ï¼Œå½“éœ€è¦çš„æ—¶å€™ï¼Œæ’å…¥æ¨ªæ’æˆ–ç«–æ’çš„åˆ†æ ç¬¦ã€‚é€šè¿‡è‡ªå®šä¹‰æ»šåŠ¨æ–¹å‘ï¼Œå¤§å°å’Œcellä¹‹é—´çš„é—´è·ï¼Œflow layout ä¹Ÿå¯ä»¥åœ¨å•è¡Œæˆ–å•åˆ—ä¸­å¸ƒå±€cellã€‚å®é™…ä¸Šï¼ŒUITableViewçš„å¸ƒå±€å¯ä»¥æƒ³è±¡æˆflow layoutçš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</p>

<p>åœ¨ä½ å‡†å¤‡è‡ªå·±å†™ä¸€ä¸ªUICollectionViewLayoutçš„å­ç±»ä¹‹å‰ï¼Œä½ éœ€è¦é—®ä½ è‡ªå·±ï¼Œä½ æ˜¯å¦èƒ½å¤Ÿä½¿ç”¨UICollectionViewFlowlayoutå®ç°ä½ å¿ƒé‡Œçš„å¸ƒå±€ã€‚è¿™ä¸ªç±»æ˜¯<a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UICollectionViewFlowLayout_class/Reference/Reference.html#//apple_ref/occ/cl/UICollectionViewFlowLayout">å¾ˆå®¹æ˜“å®šåˆ¶çš„</a>,å¹¶ä¸”å¯ä»¥ç»§æ‰¿æœ¬èº«è¿›è¡Œè¿›ä¸€æ­¥çš„å®šåˆ¶ï¼Œæ„Ÿå…´è¶£çš„çœ‹<a href="https://developer.apple.com/library/ios/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/UsingtheFlowLayout/UsingtheFlowLayout.html#//apple_ref/doc/uid/TP40012334-CH3-SW4">è¿™ç¯‡æ–‡ç« </a></p>

<h2>Cellså’Œå…¶ä»–Views</h2>

<p>ä¸ºäº†é€‚åº”ä»»æ„å¸ƒå±€,collection viewç®€å†äº†ä¸€ä¸ªç±»ä¼¼ï¼Œä½†æ¯” table viewæ›´çµæ´»çš„è§†å›¾å±‚çº§ï¼Œåƒå¾€å¸¸ä¸€æ ·ï¼Œä½ çš„ä¸»è¦å†…å®¹æ˜¾ç¤ºåœ¨cellä¸­ï¼Œcellå¯ä»¥è¢«ä»»æ„åˆ†ç»„åˆ°sectionä¸­ã€‚CollectionViewçš„cellå¿…é¡»æ˜¯UICollectionViewCellçš„å­ç±»ã€‚é™¤äº†cellï¼Œcollection viewé¢å¤–ç®¡ç†ç€ä¸¤ç§è§†å›¾:supplementary viewså’Œdecoration views.</p>

<p>collection viewä¸­çš„Supplemnetary viewsç›¸å½“äºtable viewçš„section headerå’Œfooter views.åƒcellsä¸€æ ·ï¼Œä»–ä»¬çš„å†…å®¹éƒ½æœ‰æ•°æ®æºå¯¹è±¡é©±åŠ¨ï¼Œç„¶è€Œå’Œtableview ä¸­ç”¨æ³•ä¸ä¸€æ ·ï¼Œsupplementary viewå¹¶ä¸ä¸€å®šä¼šä½œä¸ºheaderæˆ–footer view;ä»–ä»¬çš„æ•°é‡å’Œä½ç½®å®Œå…¨ç”±å¸ƒå±€æ§åˆ¶.</p>

<p>Decoration viewsçº¯ç²¹ä¸ºä¸€ä¸ªè£…é¥°å“ã€‚ä»–ä»¬å®Œå…¨å±äºå¸ƒå±€å¯¹è±¡ï¼Œå¹¶è¢«å¸ƒå±€å¯¹è±¡ç®¡ç†ï¼Œä»–ä»¬å¹¶ä¸ä»dataSource è·å–çš„contents.å½“å¸ƒå±€å¯¹è±¡æŒ‡å®šéœ€è¦ä¸€ä¸ªdecoration viewçš„æ—¶å€™ï¼Œcollection viewä¼šè‡ªåŠ¨åˆ›å»ºï¼Œå¹¶å°†å¸ƒå±€å¯¹è±¡æä¾›çš„å¸ƒå±€å‚æ•°åº”ç”¨åˆ°ä¸Šé¢å»ã€‚å¹¶ä¸éœ€è¦ä¸ºè‡ªå®šä¹‰è§†å›¾å‡†å¤‡ä»»ä½•å†…å®¹ã€‚</p>

<p>Supplementary viewså’Œdecoration viewså¿…é¡»æ˜¯UICollectionReusableViewçš„å­ç±»ã€‚å¸ƒå±€ä½¿ç”¨çš„æ¯ä¸ªè§†å›¾ç±»éƒ½éœ€è¦åœ¨collection viewä¸­æ³¨å†Œï¼Œè¿™æ ·å½“data Sourceè®©å®ƒä»¬ä»reuse poolä¸­å‡ºåˆ—æ—¶ï¼Œå®ƒä»¬æ‰èƒ½å¤Ÿåˆ›å»ºæ–°çš„å®ä¾‹ã€‚å¦‚æœä½ æ˜¯ä½¿ç”¨çš„interface Builderï¼Œåˆ™å¯ä»¥é€šè¿‡åœ¨å¯è§†åŒ–ç¼–è¾‘å™¨ä¸­æ‹–æ‹½ä¸€ä¸ªcellåˆ°collection viewä¸Šå®Œæˆcellåœ¨collection viewä¸­çš„æ³¨å†Œã€‚åŒæ ·çš„æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨åœ¨supplementary viewä¸Šï¼Œå‰ææ˜¯ä½ ä½¿ç”¨äº†UIcollectionviewFlowLayout.å¦‚æœæ²¡æœ‰ï¼Œä½ åªèƒ½é€šè¿‡è°ƒç”¨ <code>registerClass:</code>æˆ–è€…<code>registerNib:</code>æ–¹æ³•æ‰‹åŠ¨æ³¨å†Œè§†å›¾ç±»äº†ã€‚ä½ éœ€è¦åœ¨<code>viewDidload</code>ä¸­åšè¿™äº›æ“ä½œ.</p>

<h2>è‡ªå®šä¹‰å¸ƒå±€</h2>

<p>ä½œä¸ºä¸€ä¸ªéå¸¸æœ‰æ„ä¹‰çš„è‡ªå®šä¹‰collection viewå¸ƒå±€çš„ä¾‹å­ï¼Œæˆ‘ä»¬ä¸å¦¨æƒ³ä¸€ä¸ªå…¸å‹çš„æ—¥å†åº”ç”¨ç¨‹åºä¸­çš„å‘¨è§†å›¾ã€‚æ—¥å†ä¸€æ¬¡æ˜¾ç¤ºä¸€å‘¨ï¼Œæ˜ŸæœŸä¸­çš„æ¯ä¸€å¤©ç°åœ¨åˆ—ä¸­ï¼Œæ¯ä¸€ä¸ªæ—¥å†äº‹ä»¶å°†ä¼šåœ¨æˆ‘ä»¬çš„colleectio viewä¸­ä»¥ä¸€ä¸ªcellæ˜¾ç¤ºï¼Œä½ç½®å’Œå¤§å°ä»£è¡¨äº‹ä»¶èµ·å§‹æ—¥æœŸäº‹ä»¶å’ŒæŒç»­æ—¶é—´ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/calendar-collection-view-layout.png" alt="test" />
ä¸€èˆ¬æœ‰ä¸¤ç§ç±»å‹çš„ collection viewå¸ƒå±€:</p>

<ol>
<li>ç‹¬ç«‹äºå†…å®¹çš„å¸ƒå±€è®¡ç®—.è¿™æ­£æ˜¯ä½ æ‰€çŸ¥é“çš„åƒUITableviewå’ŒUIcollectionViewFlowLayoutè¿™äº›æƒ…å†µã€‚æ¯ä¸ªcellçš„ä½ç½®å’Œå¤–è§‚ä¸æ˜¯åŸºäºå…¶æ˜¾ç¤ºçš„å†…å®¹ï¼Œä½†æ‰€æœ‰cellçš„æ˜¾ç¤ºé¡ºåºæ˜¯åŸºäºå†…å®¹çš„é¡ºåºã€‚å¯ä»¥æŠŠé»˜è®¤çš„flow layoutä½œä¸ºä¾‹å­ã€‚æ¯ä¸ªcelléƒ½æ˜¯åŸºäºå‰ä¸€ä¸ªcellçš„æ”¾ç½®(æˆ–è€…å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ™ä»ä¸‹ä¸€è¡Œå¼€å§‹).å¸ƒå±€å¯¹è±¡ä¸å¿…è®¿é—®å®é™…æ•°æ®æ¥è®¡ç®—å¸ƒå±€.</li>
<li>åŸºäºå†…å®¹çš„å¸ƒå±€è®¡ç®—ã€‚æˆ‘ä»¬çš„æ—¥å†è§†å›¾æ­£å¼è¿™æ ·ç±»å‹çš„ä¾‹å­ã€‚ä¸ºäº†è®¡ç®—æ˜¾ç¤ºäº‹ä»¶çš„æ°”åŠ¿å’Œè¡—äºŒå”äº‹ä»¶ï¼Œå¸ƒå±€å¯¹è±¡éœ€è¦ç›´æ¥è®¿é—® collection viewçš„æ•°æ®æºã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå¸ƒå±€å¯¹è±¡ä¸ä»…éœ€è¦å–å‡ºå½“å‰å¯è§cellçš„æ•°æ®ï¼Œè¿˜éœ€è¦ä»æ‰€æœ‰è®°å½•ä¸­å–å‡ºä¸€äº›å†³å®šå½“å‰é‚£äº›cellå¯è§çš„æ•°æ®ã€‚</li>
</ol>


<p>åœ¨æˆ‘ä»¬çš„æ—¥å†ç¤ºä¾‹ä¸­ï¼Œå¸ƒå±€å¯¹è±¡å¦‚æœè®¿é—®æŸä¸€ä¸ªçŸ©å½¢å†…çš„cellsçš„å±æ€§ï¼Œé‚£å°±å¿…é¡»è¿­ä»£æ•°æ®æºæä¾›çš„æ‰€æœ‰äº‹ä»¶æ¥å†³å®šé‚£äº›ä½äºè¦æ±‚çš„æ—¶é—´çª—å£ä¸ªä¸­ã€‚ä¸ä¸€äº›ç›¸å¯¹ç®€å•ï¼Œæ•°æ®æºç‹¬ç«‹è®¡ç®—çš„flow layoutæ¯”èµ·æ¥ï¼Œè¿™è¶³å¤Ÿè®¡ç®—å‡ºcellåœ¨ä¸€ä¸ªçŸ©å½¢å†…çš„index pathsäº†ï¼ˆå‡è®¾ç½‘æ ¼ä¸­æ‰€æœ‰çš„cellsçš„å¤§å°éƒ½ä¸€æ ·ï¼‰.</p>

<p>å¦‚æœæœ‰ä¸€ä¸ªä¾èµ–å†…å®¹çš„å¸ƒå±€ï¼Œé‚£å°±æ˜¯æš—ç¤ºä½ éœ€è¦äº›è‡ªå®šä¹‰çš„å¸ƒå±€ç±»äº†ï¼ŒåŒæ—¶ä¸èƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„UICOllectionViewFlowLayoutï¼Œæ‰€ä»¥è¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…ã€‚</p>

<p><a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UICollectionViewLayout_class/Reference/Reference.html">UICollectionViewLayoutæ–‡æ¡£</a>åˆ—å‡ºäº†å­ç±»éœ€è¦é‡å†™çš„æ–¹æ³•.</p>

<h2>collectionViewContentSize</h2>

<p>ç”±äº collection viewå¯¹å®ƒçš„contentå¹¶ä¸çŸ¥æƒ…ï¼Œæ‰€ä»¥å¸ƒå±€é¦–å…ˆè¦æä¾›çš„ä¿¡æ¯å°±æ˜¯æ»šåŠ¨åŒºåŸŸçš„å¤§å°ï¼Œè¿™æ ·collection viewæ‰èƒ½æ­£ç¡®çš„ç®¡ç†æ»šåŠ¨ã€‚å¸ƒå±€å¯¹è±¡å¿…é¡»åœ¨æ­¤æ—¶è®¡ç®—å®ƒå†…å®¹çš„æ€»å¤§å°ï¼ŒåŒ…æ‹¬supplementary viewså’Œdecoration viewsã€‚æ³¨æ„ï¼Œå°½ç®¡å¤§å¤šæ•°ç»å…¸çš„collection viewé™åˆ¶åœ¨ä¸€ä¸ªè½´æ–¹å‘ä¸Šæ»šåŠ¨(æ­£å¦‚UIcollectionviewFlowLayoutä¸€æ ·)ï¼Œä½†æ˜¯è¿™ä¸æ˜¯å¿…é¡»çš„ã€‚</p>

<p>åœ¨æˆ‘ä»¬çš„æ—¥å†ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦è§†å›¾å‚ç›´çš„æ»šåŠ¨ã€‚æ¯”å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨å‚ç›´ç©ºé—´ä¸Šä¸€ä¸ªå°æ—¶å å»100ç‚¹ï¼Œè¿™æ ·æ˜¾ç¤ºä¸€æ•´å¤©çš„å†…å®¹é«˜åº¦å°±æ˜¯2400ç‚¹ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬ä¸èƒ½å¤Ÿæ°´å¹³æ»šåŠ¨ï¼Œè¿™å°±æ„å‘³è¿™æˆ‘ä»¬collectionviewåªèƒ½æ˜¾ç¤ºä¸€å‘¨ã€‚ä¸ºäº†èƒ½å¤Ÿåœ¨æ—¥å†ä¸­çš„å¤šä¸ªæ˜ŸæœŸé—´åˆ†é¡µï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªç‹¬ç«‹çš„scroll viewä¸­ï¼ˆå¯ä»¥ä½¿ç”¨U<a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UIPageViewControllerClassReferenceClassRef/UIPageViewControllerClassReference.html">IPageViewController</a>ï¼‰ä¸­ä½¿ç”¨å¤šä¸ª collection viewï¼ˆä¸€å‘¨ä¸€ä¸ªï¼‰,æˆ–è€…åšæŒä½¿ç”¨ä¸€ä¸ªcollection viewå¹¶ä¸”è¿”å›è¶³å¤Ÿå¤§çš„å†…å®¹å®½åº¦ï¼Œè¿™å›ä½¿å¾—ç”¨æˆ·æ„Ÿè§‰åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šæ»‘åŠ¨è‡ªç”±ã€‚</p>

<pre><code>- (CGSize)collectionViewContentSize
{
    // Don't scroll horizontally
    CGFloat contentWidth = self.collectionView.bounds.size.width;

    // Scroll vertically to display a full day
    CGFloat contentHeight = DayHeaderHeight + (HeightPerHour * HoursPerDay);

    CGSize contentSize = CGSizeMake(contentWidth, contentHeight);
    return contentSize;
}
</code></pre>

<p>ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘é€‰æ‹©å¸ƒå±€åœ¨ä¸€ä¸ªéå¸¸ç®€å•çš„æ¨¡å‹ä¸Šï¼šå‡å®šæ¯å‘¨å¤©æ•°ç›¸åŒï¼Œæ¯å¤©æ—¶é•¿ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´å¤©æ•°ç”¨0-6è¡¨ç¤ºã€‚åœ¨ä¸€ä¸ªçœŸå®çš„æ—¥å†ç¨‹åºä¸­ï¼Œå¸ƒå±€å°†ä¼šä¸ºè‡ªå·±çš„å‡ æ®µå¤§é‡ä½¿ç”¨åŸºäº <code>NSCalendaar</code>çš„æ—¥æœŸ</p>

<h2>layoutAttributesForElementsInRectï¼š</h2>

<p>è¿™æ˜¯ä»»ä½•å¸ƒå±€ç±»ä¸­æœ€é‡è¦çš„æ–¹æ³•äº†ï¼ŒåŒæ—¶å¯èƒ½ä¹Ÿæ˜¯æœ€å®¹æ˜“è®©äººè¿·æƒ‘çš„æ–¹æ³•ã€‚collection viewè°ƒç”¨è¿™ä¸ªæ–¹æ³•å¹¶ä¼ é€’ä¸€ä¸ªè‡ªèº«åæ ‡ç³»ç»Ÿä¸­çš„çŸ©å½¢è¿‡å»ã€‚è¿™ä¸ªçŸ©å½¢ä»£è¡¨äº†è¿™ä¸ªè§†å›¾çš„å¯è§çŸ©å½¢åŒºåŸŸ(ä¹Ÿå³æ˜¯å®ƒçš„bounds)ï¼Œä½ éœ€è¦å‡†å¤‡å¥½å¤„ç†ä¼ ç»™ä½ çš„ä»»ä½•çŸ©å½¢ã€‚</p>

<p>ä½ çš„è§†çº¿å¿…é¡»è¿”å›ä¸€ä¸ªåŒ…å« UICollectionviewLayoutAttributeså¯¹è±¡çš„æ•°ç»„ï¼Œä¸ºæ¯ä¸€ä¸ªcellåŒ…å«ä¸€ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼Œsupplementary Viewæˆ–decoration viewåœ¨çŸ©å½¢åŒºåŸŸå†…æ˜¯å¯è§çš„ã€‚UICollectionViewLayoutAttributesç±»åŒ…å«äº†colletion viewå†…itemçš„æ‰€æœ‰ç›¸å…³çš„å¸ƒå±€å±æ€§ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªç±»åŒ…å« frame,center,size,transform3D,alpha,Zindexå’Œhiddenå±æ€§ã€‚å¦‚æœä½ çš„å¸ƒå±€æƒ³è¦æ§åˆ¶å…¶ä»–è§†å›¾çš„å±æ€§(æ¯”å¦‚èƒŒæ™¯é¢œè‰²)ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªUICollectionViewLayoutAttributesçš„å­ç±»ï¼Œç„¶ååŠ ä¸Šä½ è‡ªå·±çš„å±æ€§ã€‚</p>

<p>å¸ƒå±€å±æ€§å¯¹è±¡(Layout attributes objects)é€šè¿‡indexPathå±æ€§å’Œä»–ä»¬å¯¹åº”çš„cell,supplementary viewæˆ–è€…decoration viewå…³è”åœ¨ä¸€èµ·ã€‚collection viewä¸ºæ‰€æœ‰itemsä»å¸ƒå±€å¯¹è±¡ä¸­è¯·æ±‚åˆ°å¸ƒå±€å±æ€§åï¼Œå®ƒå°†ä¼šå®ä¾‹åŒ–æ‰€æœ‰è§†å›¾ï¼Œå¹¶å°†å¯¹åº”çš„å±æ€§åº”ç”¨åˆ°æ¯ä¸ªè§†å›¾ä¸Šå»ã€‚</p>

<p>æ³¨æ„!è¿™ä¸ªæ–¹æ³•æ¶‰åŠåˆ°æ‰€æœ‰ç±»å‹çš„è§†å›¾ï¼Œä¹Ÿå°±æ˜¯cell,supplementary viewså’Œdecoration views.ä¸€ä¸ªå¹¼ç¨šçš„å®ç°å¯èƒ½ä¼šé€‰æ‹©å¿½ç•¥ä¼ å…¥çš„çŸ©å½¢ï¼Œå¹¶ä¸”ä¸ºcollection viewä¸­æ‰€æœ‰çš„è§†å›¾è¿”å›å¸ƒå±€å±æ€§ã€‚åœ¨åŸå‹è®¾è®¡å’Œå¼€å‘å¸ƒå±€é˜¶æ®µï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œè¿™å°†ä¼šæ€§èƒ½äº§ç”Ÿéå¸¸åçš„å½±å“ï¼Œç‰¹åˆ«æ˜¯å¯è§cellè¿œå°‘äºæ‰€æœ‰cellæ•°é‡çš„æ—¶å€™ï¼Œcollection viewå’Œå¸ƒå±€å¯¹è±¡å°†ä¼šä¸ºé‚£äº›ä¸å¯è§çš„è€Œè¯•å›¾åšé¢å¤–ä¸å¿…è¦çš„å·¥ä½œã€‚</p>

<p>ä½ çš„è§†çº¿éœ€è¦åšè¿™å‡ æ­¥:</p>

<ol>
<li>åˆ›å»ºä¸€ä¸ªç©ºçš„å¯å˜æ•°ç»„æ¥å­˜æ”¾æ‰€æœ‰çš„å¸ƒå±€å±æ€§</li>
<li>ç¡®å®šindex pathsä¸­é‚£äº›cellsçš„frameå®Œå…¨æˆ–éƒ¨åˆ†ä½äºçŸ©å½¢ä¸­ã€‚è¿™ä¸ªè®¡ç®—éœ€è¦ä½ ä»collection viewçš„æ•°æ®æºä¸­å–å‡ºä½ éœ€è¦æ˜¾ç¤ºçš„æ•°æ®ã€‚ç„¶ååœ¨å¾ªç¯ä¸­è°ƒç”¨ä½ è§†çº¿çš„<code>layoutattributesForItemIndexPath:</code>æ–¹æ³•ä¸ºæ¯ä¸ªindex pathåˆ›å»ºå¹¶é…ç½®ä¸€ä¸ªåˆé€‚çš„å¸ƒå±€å±æ€§å¯¹è±¡ï¼Œå¹¶å°†æ¯ä¸ªå¯¹è±¡æ·»åŠ åˆ°æ•°ç»„ä¸­ã€‚</li>
<li>å¦‚æœä½ çš„å¸ƒå±€åŒ…å«supplementary views,è®¡ç®—çŸ©å½¢å†…å¯è§supplementary viewçš„index paths.åœ¨å¾ªç¯ä¸­è°ƒç”¨ä½ å®ç°çš„<code>layoutAttributesForSupplementaryViewOfKind:atIndexPath:</code>,å¹¶ä¸”å°†è¿™äº›å¯¹è±¡åŠ åˆ°æ•°ç»„ä¸­ã€‚é€šè¿‡ä¸ºkindå‚æ•°ä¼ é€’ä½ é€‰æ‹©çš„ä¸åŒå­—ç¬¦ï¼Œä½ å¯ä»¥å´åˆ†å‡ºä¸åŒç§ç±»çš„supplementary views(æ¯”å¦‚headerså’Œfooters)ã€‚å½“éœ€è¦åˆ›å»ºè§†å›¾æ—¶ï¼Œcollectionviewä¼šå°†kindå­—ç¬¦ä¼ å›åˆ°ä½ çš„æ•°æ®æºã€‚è®°ä½supplermentary å’Œdecoration viewsçš„æ•°é‡å’Œç§ç±»å®Œå…¨æœ‰å¸ƒå±€æ§åˆ¶ã€‚ä½ ä¸ä¼šå—åˆ°headerså’Œfootersçš„é™åˆ¶.</li>
<li>å¦‚æœå¸ƒå±€åŒ…å«decoration viewsï¼Œè®¡ç®—çŸ©å½¢å†…å¯è§decoration viewsçš„index paths.åœ¨å¾ªç¯ä¸­è°ƒç”¨ä½ å®ç°çš„<code>layoutAttributesForDecorationViewOfKind:atIndexPath:</code>
ï¼Œå¹¶ä¸”å°†è¿™äº›å¯¹è±¡åŠ åˆ°æ•°ç»„ä¸­</li>
<li>è¿”å›æ•°ç»„</li>
</ol>


<p>æˆ‘ä»¬è‡ªå®šä¹‰çš„å¸ƒå±€æ²¡æœ‰ä½¿ç”¨ decoration views,ä½†æ˜¯ä½¿ç”¨äº†ä¸¤ç§supplermentary views(column headerså’Œrow headers):</p>

<pre><code>- (NSArray *)layoutAttributesForElementsInRect:(CGRect)rect
{
    NSMutableArray *layoutAttributes = [NSMutableArray array];
    // Cells
    // We call a custom helper method -indexPathsOfItemsInRect: here
    // which computes the index paths of the cells that should be included
    // in rect.
    NSArray *visibleIndexPaths = [self indexPathsOfItemsInRect:rect];
    for (NSIndexPath *indexPath in visibleIndexPaths) {
        UICollectionViewLayoutAttributes *attributes =
        [self layoutAttributesForItemAtIndexPath:indexPath];
        [layoutAttributes addObject:attributes];
    }

    // Supplementary views
    NSArray *dayHeaderViewIndexPaths = [self indexPathsOfDayHeaderViewsInRect:rect];
    for (NSIndexPath *indexPath in dayHeaderViewIndexPaths) {
        UICollectionViewLayoutAttributes *attributes =
        [self layoutAttributesForSupplementaryViewOfKind:@"DayHeaderView"
                               atIndexPath:indexPath];
        [layoutAttributes addObject:attributes];
    }

    NSArray *hourHeaderViewIndexPaths = [self indexPathsOfHourHeaderViewsInRect:rect];
    for (NSIndexPath *indexPath in hourHeaderViewIndexPaths) {
        UICollectionViewLayoutAttributes *attributes =
        [self layoutAttributesForSupplementaryViewOfKind:@"HourHeaderView"
                               atIndexPath:indexPath];
        [layoutAttributes addObject:attributes];
    }
    return layoutAttributes;
}
</code></pre>

<h2>layoutAttributesForâ€¦IndexPath</h2>

<p>æœ‰æ—¶ï¼Œcollection viewä¼šä¸ºæŸä¸ªç‰¹æ®Šçš„cell,supplementary æˆ–è€…decoration viewå‘å¸ƒå±€å¯¹è±¡è¯·æ±‚å¸ƒå±€å±æ€§ï¼Œè€Œéæ‰€æœ‰å¯è§çš„å¯¹è±¡ã€‚è¿™å°±æ˜¯å½“å…¶ä»–ä¸‰ä¸ªæ–¹æ³•å¼€å§‹èµ·ä½œç”¨æ—¶ï¼Œä½ å®ç°çš„<code>layoutAttributesForItemAtIndexPath:</code>éœ€è¦åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªå•ç‹¬çš„å¸ƒå±€å±æ€§å¯¹è±¡ï¼Œè¿™æ ·æ‰èƒ½æ­£ç¡®çš„æ ¼å¼åŒ–ä¼ ç»™ä½ çš„index path æ‰€å¯¹åº”çš„cell.</p>

<p>ä½ å¯ä»¥é€šè¿‡è°ƒç”¨<code>+[UICollectionViewLayoutAttributes layoutAttributesForCellWithIndexPath:]</code>è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åæ ¹æ®index pathä¿®æ”¹å±æ€§ã€‚ä¸ºäº†å¾—åˆ°éœ€è¦æ˜¾ç¤ºåœ¨è¿™ä¸ªindex pathå†…çš„æ•°æ®ï¼Œä½ å¯èƒ½éœ€è¦è®¿é—®collection viewçš„æ•°æ®æºã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè‡³å°‘ç¡®ä¿è®¾ç½®äº†frameå°šéœ€ç»ï¼Œé™¤éä½ æ‰€æœ‰çš„celléƒ½ä½äºå½¼æ­¤ä¸Šæ–¹ã€‚</p>

<pre><code>- (UICollectionViewLayoutAttributes *)layoutAttributesForItemAtIndexPath:(NSIndexPath *)indexPath
{
    CalendarDataSource *dataSource = self.collectionView.dataSource;
    id event = [dataSource eventAtIndexPath:indexPath];
    UICollectionViewLayoutAttributes *attributes =
    [UICollectionViewLayoutAttributes layoutAttributesForCellWithIndexPath:indexPath];
    attributes.frame = [self frameForEvent:event];
    return attributes;
}
</code></pre>

<p>å¦‚æœä½ æ­£åœ¨ä½¿ç”¨è‡ªåŠ¨å¸ƒå±€ï¼Œä½ å¯èƒ½ä¼šèµ¶åˆ°æƒŠè®¶ï¼Œæˆ‘ä»¬æ­£åœ¨ç›´æ¥ä¿®æ”¹å¸ƒå±€å‚æ•°çš„frameå±æ€§ï¼Œè€Œä¸æ˜¯å’Œçº¦æŸå…±äº‹ï¼Œä½†è¿™æ­£æ˜¯UIcollectionViewLayoutçš„å·¥ä½œã€‚å°½ç®¡ä½ å‘ä½ ä½¿ç”¨è‡ªåŠ¨å¸ƒå±€æ¥å®šä¹‰collection viewçš„frameå’Œå®ƒå†…éƒ¨æ¯ä¸ªcelçš„å¸ƒå±€ï¼Œä½†cellsçš„framesè¿˜æ˜¯éœ€è¦é€šè¿‡è€å¼çš„æ–¹æ³•è®¡ç®—å‡ºæ¥ã€‚</p>

<p>ç±»ä¼¼çš„ï¼Œ<code>layoutAttributesForSupplementaryViewOfKind:atIndexPath:</code>å’Œ<code>layoutAttributesForDecorationViewOfKind:atIndexPath:</code>æ–¹æ³•åˆ†åˆ«éœ€è¦ä¸ºsupplementary å’Œdecoration viewsåšç›¸åŒçš„äº‹ã€‚åªæœ‰ä½ çš„å¸ƒå±€åŒ…å«è¿™æ ·çš„è§†å›¾ä½ æ‰éœ€è¦å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚UICollectionViewlayoutAttributesåŒ…å«å¦å¤–ä¸¤ä¸ªå·¥å‚æ–¹æ³•ï¼Œ</p>

<p><code>+layoutAttributesForSupplementaryViewOfKind:withIndexPath:</code> å’Œ <code>+layoutAttributesForDecorationViewOfKind:withIndexPath:</code>ï¼Œç”¨ä»–ä»¬æ¥åˆ›å»ºæ­£ç¡®çš„å¸ƒå±€å±æ€§å¯¹è±¡</p>

<h2>shouldInvalidateLayoutForBoundsChange:</h2>

<p>æœ€åï¼Œå½“collection viewçš„boundsæ”¹å˜æ—¶ï¼Œå¸ƒå±€éœ€è¦å‘Šè¯‰collection viewæ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å¸ƒå±€ã€‚æˆ‘çš„çŒœæƒ³æ˜¯ï¼šå½“collectionviewæ”¹å˜å¤§å°æ—¶ï¼Œå¤§å¤šæ•°å¸ƒå±€ä¼šè¢«ä½œåºŸï¼Œæ¯”å¦‚è®¾å¤‡æ—‹è½¬çš„æ—¶å€™ã€‚å› æ­¤ï¼Œä¸€ä¸ªä¼˜è´¨çš„å®ç°å¯èƒ½åªä¼šç®€å•çš„è¿”å›YESã€‚èŠ®ç„¶å®ç°åŠŸèƒ½å¾ˆé‡è¦ï¼Œä½†æ˜¯scrollviewçš„boundsåœ¨æ»šåŠ¨æ—¶ä¹Ÿä¼šæ”¹å˜ï¼Œè¿™æ„å‘³ç€ä½ çš„å¸ƒå±€ç¾å¦™ä¼šè¢«ä¸¢å¼ƒå¤šæ¬¡ã€‚æ ¹æ®è®¡ç®—çš„å¤æ‚æ€§åˆ¤æ–­ï¼Œè¿™å°†ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚</p>

<p>å½“collection viewçš„å®½åº¦æ”¹å˜æ—¶ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„å¸ƒå±€å¿…é¡»è¢«ä¸¢å¼ƒï¼Œä½†è¿™æ»šåŠ¨å¹¶ä¸ä¼šå½±å“åˆ°å¸ƒå±€ã€‚å¹¸è¿çš„æ˜¯ï¼Œcollection viewå°†å®ƒçš„boundsä¼ ç»™<code>shouldInvalidateLayoutForBoundsChange:</code>æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬ä¾¿èƒ½æ¯”è¾ƒè§†å›¾å½“å‰çš„boundså’Œæ–°çš„boundsæ¥ç¡®å®šè¿”å›å€¼</p>

<pre><code>- (BOOL)shouldInvalidateLayoutForBoundsChange:(CGRect)newBounds
{
    CGRect oldBounds = self.collectionView.bounds;
    if (CGRectGetWidth(newBounds) != CGRectGetWidth(oldBounds)) {
        return YES;
    }
        return NO;
}
</code></pre>

<h2>åŠ¨ç”»</h2>

<h3>æ’å…¥å’Œåˆ é™¤</h3>

<p>UITableviewä¸­çš„cellè‡ªå¸¦äº†ä¸€å¥—éå¸¸æ¼‚äº®çš„æ’å…¥å’Œåˆ é™¤çš„åŠ¨ç”»ã€‚ä½†æ˜¯å½“ä¸ºUIcollectionViewå¢åŠ å’Œåˆ é™¤cellå®šä¹‰åŠ¨ç”»åŠŸèƒ½æ—¶ï¼ŒUIKitå·¥ç¨‹å¸ˆä»¬é‡åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœCollection viewçš„å¸ƒå±€æ˜¯å®Œå…¨å¯å˜çš„ï¼Œé‚£ä¹ˆé¢„å…ˆå®šä¹‰å¥½çš„åŠ¨ç”»å°±æ²¡åŠæ³•å’Œå¼€å‘è€…è‡ªå®šä¹‰çš„å¸ƒå±€å¾ˆå¥½çš„èåˆã€‚ä»–ä»¬æå‡ºäº†ä¸€ä¸ªä¼˜é›…çš„æ–¹æ³•ï¼šå½“ä¸€ä¸ªcell(æˆ–è€…supplementary æˆ–è€… decoration View)è¢«æ’å…¥åˆ°collection viewä¸­æ—¶ï¼Œcollection Viewä¸ä»…å‘å…¶å¸ƒå±€è¯·æ±‚cellæ­£å¸¸æ­£å¸¸çŠ¶æ€ä¸‹çš„å¸ƒå±€å°šéœ€ç»ï¼ŒåŒæ—¶è¿˜è¯·æ±‚å…¶åˆå§‹çš„å¸ƒå±€å°šéœ€ç»ï¼Œæ¯”å¦‚ï¼Œéœ€è¦åœ¨å¼€å§‹æœ‰æ’å…¥åŠ¨ç”»çš„cellã€‚CollectionViewä¼šç®€å•çš„åˆ›å»ºä¸€ä¸ªanmiation block,å¹¶åœ¨è¿™ä¸ªblockä¸­ï¼Œå°†æ‰€æœ‰cellçš„å±æ€§ä»åˆå§‹çŠ¶æ€æ”¹å˜åˆ°å¸¸æ€</p>

<p>é€šè¿‡æä¾›ä¸åŒçš„åˆå§‹å¸ƒå±€å±æ€§ï¼Œä½ å¯ä»¥å®Œå…¨è‡ªå®šä¹‰æ’å…¥åŠ¨ç”»ã€‚æ¯”å¦‚è®¾ç½®åˆå§‹çš„alphaä¸º0å°†ä¼šäº§ç”Ÿä¸€ä¸ªæ·¡å…¥çš„åŠ¨ç”»ã€‚åŒæ—¶è®¾ç½®ä¸€ä¸ªå¹³ç§»æˆ–è€…ç¼©æ”¾å°†ä¼šäº§ç”Ÿç§»åŠ¨ç¼©æ”¾çš„æ•ˆæœã€‚</p>

<p>åŒæ ·çš„åŸç†åº”ç”¨åˆ°åˆ é™¤ä¸Šï¼Œè¿™æ¬¡åŠ¨ç”»æ˜¯ä»å¸¸æ€åˆ°ä¸€äº›åˆ—ä½ è®¾ç½®çš„æœ€ç»ˆå¸ƒå±€å±æ€§ã€‚è¿™äº›é€—ä½ éœ€è¦åœ¨å¸ƒå±€ç±»ä¸­ä¸ºinitialæˆ–finalå¸ƒå±€å‚æ•°å®ç°çš„æ–¹æ³•:</p>

<pre><code>initialLayoutAttributesForAppearingItemAtIndexPath:

initialLayoutAttributesForAppearingSupplementaryElementOfKind:atIndexPath:

initialLayoutAttributesForAppearingDecorationElementOfKind:atIndexPath:

finalLayoutAttributesForDisappearingItemAtIndexPath:

finalLayoutAttributesForDisappearingSupplementaryElementOfKind:atIndexPath:

finalLayoutAttributesForDisappearingDecorationElementOfKind:atIndexPath:
</code></pre>

<h2>å¸ƒå±€é—´åˆ‡æ¢</h2>

<p>å¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ–¹å¼å°†ä¸€ä¸ªcollection viewå¸ƒå±€åŠ¨æ€çš„åˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªå¸ƒå±€ã€‚å½“å‘é€ä¸€ä¸ª<code>setCollectionViewLayout:animated:</code>æ¶ˆæ¯æ—¶ï¼Œcollection viewä¼šä¸ºcellsåœ¨æ–°çš„å¸ƒå±€ä¸­æŸ¥è¯¢æ–°çš„å¸ƒå±€å‚æ•°ï¼Œç„¶ååŠ¨æ€çš„å°†æ¯ä¸ªcellä»æ—§å‚æ•°å˜æ¢åˆ°æ–°çš„å¸ƒå±€å‚æ•°ã€‚ä½ ä¸éœ€è¦åšä»»ä½•äº‹æƒ…ã€‚</p>

<h2>ç»“è®º</h2>

<p>æ ¹æ®è‡ªå®šä¹‰collection viewå¸ƒå±€çš„å¤æ‚æ€§ï¼Œå†™ä¸€ä¸ªé€šå¸¸å¾ˆä¸å®¹æ˜“ã€‚ç¡®åˆ‡çš„è¯´ï¼Œæœ¬è´¨ä¸Šè¿™å’Œä»å¤´å†™ä¸€ä¸ªå®Œæ•´çš„å®ç°ç›¸åŒå¸ƒå±€è‡ªå®šä¹‰è§†å›¾ç±»ä¸€æ ·å›°éš¾äº†ã€‚å› ä¸ºæ‰€æ¶‰åŠçš„è®¡ç®—éœ€è¦ç¡®å®šå»é‚£äº›å­è§†å›¾æ˜¯å½“å‰å¯è§çš„ï¼Œä»¥åŠä»–ä»¬çš„ä½ç½®ã€‚å°½ç®¡å¦‚æ­¤ï¼Œä½¿ç”¨UIcollectionviewè¿˜æ˜¯ç»™ä½ å¸¦æ¥äº†ä¸€äº›å¾ˆå¥½çš„æ•ˆæœï¼Œæ¯”å¦‚cellé‡ç”¨ï¼Œè‡ªåŠ¨æ”¯æŒåŠ¨ç”»ï¼Œæ›´ä¸è¦ææ•´æ´çš„ç‹¬ç«‹å¸ƒå±€ï¼Œå­è§†å›¾ç®¡ç†ã€‚</p>

<p>è‡ªå®šä¹‰collection viewå¸ƒå±€ä¹Ÿæ˜¯å‘<a href="http://objccn.io/issue-1-1/">è½»é‡çº§view Controller</a>è¿ˆå‡ºäº†å¾ˆå¥½çš„å¼‚æ­¥ï¼Œæ­£å¦‚ä½ çš„view controllerä¸è¦åŒ…å«ä»»ä½•å¸ƒå±€ä»£ç ã€‚åº”è¯¥å’Œä¸€äºŒä¸ªç‹¬ç«‹çš„dataSourceç±»ç»“åˆåœ¨ä¸€èµ·ï¼Œcollection viewçš„è§†å›¾æ§åˆ¶å™¨å°†å¾ˆéš¾å†åŒ…å«ä»»ä½•ä»£ç </p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[OHHTTPStubsä»‹ç»]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/22/ohhttpstubsjie-shao/"/>
    <updated>2016-04-22T17:18:29+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/22/ohhttpstubsjie-shao</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/AliSoftware/OHHTTPStubs">OHHTTPStubs</a>æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚çš„ä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿å’Œå¼ºå¤§ï¼Œå®ƒèƒ½å¸®ä½ </p>

<ol>
<li>æµ‹è¯•ä½ çš„appä»¿çœŸä¸€ä¸ªæœåŠ¡å™¨ï¼ˆæ¯”å¦‚åŠ è½½ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ï¼‰,æ¨¡æ‹Ÿç½‘ç»œæ…¢çš„æƒ…å†µç­‰</li>
<li>ä½¿ç”¨ä¼ªé€ çš„ç½‘ç»œæ•°æ®ç¼–å†™å•å…ƒæµ‹è¯•</li>
</ol>


<!--more-->


<h2>ç®€å•ç”¨æ³•</h2>

<h2>åœ¨Objcä¸­</h2>

<pre><code>[OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest *request) {
  return [request.URL.host isEqualToString:@"mywebservice.com"];
} withStubResponse:^OHHTTPStubsResponse*(NSURLRequest *request) {
  // Stub it with our "wsresponse.json" stub file (which is in same bundle as self)
  NSString* fixture = OHPathForFile(@"wsresponse.json", self.class);
  return [OHHTTPStubsResponse responseWithFileAtPath:fixture
            statusCode:200 headers:@{@"Content-Type":@"application/json"}];
}];
</code></pre>

<h2>åœ¨swiftä¸­</h2>

<pre><code>stub(isHost("mywebservice.com")) { _ in
  // Stub it with our "wsresponse.json" stub file (which is in same bundle as self)
  let stubPath = OHPathForFile("wsresponse.json", self.dynamicType)
  return fixture(stubPath!, headers: ["Content-Type":"application/json"])
}
</code></pre>

<h2>è¯­æ³•è®²è§£</h2>

<p><code>OHHTTPStubs stubRequestsPassingTest:</code>æ–¹æ³•åˆ›å»ºäº†æ¨¡æ‹ŸæœåŠ¡å™¨ï¼Œ<code>request</code>æ˜¯è¯·æ±‚çš„æ ‡å‡†åˆ¤æ–­ï¼Œæ¯”å¦‚</p>

<pre><code>[request.URL.host isEqualToString:@"mywebservice.com"]
</code></pre>

<p>æ„æ€å°±æ˜¯å¦‚æœè¯·æ±‚çš„urlæ˜¯<code>mywebservice.com</code>ï¼Œæˆ‘ä»¬å°±è¿”å›response,è¦ä¸ç„¶ä¸æ‰§è¡Œ</p>

<pre><code> NSString* fixture = OHPathForFile(@"wsresponse.json", self.class);
  return [OHHTTPStubsResponse responseWithFileAtPath:fixture
            statusCode:200 headers:@{@"Content-Type":@"application/json"}];
</code></pre>

<p>è¿”å›ä¸€ä¸ªrespoinse,å…¶ä¸­åŒ…å«äº†è¿”å›çš„æ•°æ®ï¼Œ</p>

<ol>
<li>è·å–çš„ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶</li>
<li>è¿”å›çš„çŠ¶æ€ç  200  (200è¡¨ç¤ºæ­£ç¡®è¿”å›)</li>
<li>headersï¼šè¿”å›çš„å¤´,å¦‚æœæ˜¯jsonä¸€èˆ¬æ˜¯:@{@&ldquo;Content-Type&rdquo;:@&ldquo;application/json&rdquo;}</li>
</ol>


<h1>å¿«é€Ÿå¼€å§‹ä¸€ä¸ªDemo</h1>

<h2>åˆ›å»ºä¸€ä¸ªç©ºå·¥ç¨‹</h2>

<p>ç”¨xcodeåˆ›å»ºä¸€ä¸ªå·¥ç¨‹ï¼Œç”¨podsåˆ›å»ºä¸€ä¸ªPodfile</p>

<p>å†…å®¹å¦‚ä¸‹:</p>

<pre><code>pod 'OHHTTPStubs', '~&gt; 5.0.0'

target :OHHTTPStubsDemoTests, :exclusive =&gt; true do
    link_with 'OHHTTPStubsDemoTests'

    pod 'OHHTTPStubs'
end
</code></pre>

<p>æ‰§è¡Œ <code>pod install</code></p>

<p>æˆåŠŸå®‰è£…OHHTTPStubsåï¼Œåœ¨OHHTTPStubsDemoTestsç›®å½•ä¸­ç¼–å†™æµ‹è¯•ç±»:</p>

<h3>åˆ›å»ºsession</h3>

<p>åœ¨é¡¶éƒ¨å£°æ˜ä¸€ä¸ªå˜é‡session</p>

<pre><code>@property (nonatomic,strong) NSURLSession *session;
</code></pre>

<p>åœ¨setUpæ–¹æ³•ä¸­ï¼Œåˆ›å»ºè¯¥å˜é‡å®ä¾‹:</p>

<pre><code>self.session=[NSURLSession sharedSession];
</code></pre>

<p>åœ¨ testExample()æ–¹æ³•ä¸­ï¼š</p>

<pre><code>/**
 *  è¿”å›è‡ªå®šä¹‰çš„æ™®é€šæ–‡æœ¬
 */
- (void)testExample {

    //å¼€å§‹æ¨¡æ‹ŸæœåŠ¡å™¨
    [OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest * _Nonnull request) {
        //å‘é€è¯·æ±‚çš„urlåç¼€å¿…é¡»æ˜¯.comç»“å°¾çš„
        return [request.URL.pathExtension isEqualToString:@"com"];
    } withStubResponse:^OHHTTPStubsResponse * _Nonnull(NSURLRequest * _Nonnull request) {
        //åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²
        NSData * stubData = [@"hello world" dataUsingEncoding:NSUTF8StringEncoding];
        //å“åº”æ•°æ®
        /**
         *  responseWithData:è¿”å›çš„æ•°æ®
            statusCode:çŠ¶æ€ç ,200è¡¨ç¤ºæˆåŠŸ
            headers:httpçš„header
         */
        return [OHHTTPStubsResponse responseWithData:stubData statusCode:200 headers:@{@"Content-Type":@"text/plain"}];
    }];


    //åœ¨XCTæµ‹è¯•æ¡†æ¶ä¸­ï¼Œè¿™ä¸ªè¡¨ç¤ºæœŸæœ›å€¼ï¼Œå› ä¸ºè¿™ä¸ªæœŸæœ›å€¼æ˜¯æ”¯æŒå¼‚æ­¥æµ‹è¯•çš„ï¼Œæˆ‘ä»¬æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæ‰€ä»¥ä¸€å®šè¦æ˜¯ä½¿ç”¨XCTestExpectationè¿™ä¸ªç‰¹æ€§
     XCTestExpectation *expectation=[self expectationWithDescription:@"sessionDataTask expectation"];

    //åˆ›å»ºsessionä»»åŠ¡
    NSURLSessionDataTask *dataTask=[self.session dataTaskWithURL:[NSURL URLWithString:@"hello.com"] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {

        //è§£æè¿”å›çš„å­—ç¬¦ä¸²
        NSString *resultStr=[[NSString alloc]initWithData:data encoding:NSUTF8StringEncoding];

        NSLog(@"è¿”å›çš„æ•°æ®:%@",resultStr);

        XCTAssert(resultStr!=nil);

        //æ–­è¨€è¿”å›çš„å­—ç¬¦ä¸²æ˜¯hello world,å¦‚æœä¸æ˜¯ï¼Œåˆ™æ–­è¨€å¤±è´¥
        XCTAssertTrue([resultStr isEqualToString:@"hello world"]);

        //åœ¨æƒ³å¼‚æ­¥æµ‹è¯•çš„åœ°æ–¹åŠ ä¸Šä¸‹é¢è¿™è¡Œä»£ç 
        [expectation fulfill];
    }];
    //å¯åŠ¨ä»»åŠ¡
    [dataTask resume];


    //ä½¿ç”¨XCTestExpectation,å¿…é¡»è®¾ç½®å¦‚ä¸‹çš„waitForExpectationsWithTimeoutæ–¹æ³•ï¼Œå¦‚æœè¶…æ—¶åˆ™å¤±è´¥
    [self waitForExpectationsWithTimeout:4 handler:^(NSError * _Nullable error) {
        if(error){
            NSLog(@"å‡ºé”™äº†:%s",__FUNCTION__);
        }
    }];


}
</code></pre>

<p>è¿™é‡Œé¢ä½¿ç”¨åˆ°äº† <code>XCTestExpectation</code>ï¼Œè¿™æ˜¯ç‰¹æ€§æ˜¯ç”¨æ¥æµ‹è¯•å¼‚æ­¥ç¨‹åºä»£ç çš„ã€‚åœ¨æƒ³æµ‹è¯•å¼‚æ­¥ä»£ç çš„åœ°æ–¹åŠ ä¸Š<code>[expectation fulfill];</code>,
æœ€åï¼Œè¦åŠ ä¸Š<code>waitForExpectationsWithTimeout</code>æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯é…å¯¹å‡ºç°çš„ã€‚</p>

<p>OHHTTPStubsåˆ›å»ºäº†æ¨¡æ‹ŸæœåŠ¡å™¨åï¼Œä¸‹é¢å‘çš„ä»»ä½•ç½‘ç»œè¯·æ±‚éƒ½ä¼šè¢«æ¨¡æ‹ŸæœåŠ¡å™¨è¿”å›ï¼Œæ­£å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œæµ‹è¯•ç»“æœ:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160422-3.png" alt="test" />
æ–­è¨€æˆåŠŸï¼</p>

<h2>æ·»åŠ æœ¬åœ°æ–‡ä»¶</h2>

<ol>
<li>åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªstub.txtçš„æ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹è‡ªå®š</li>
<li>åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªstub.jpgçš„å›¾ç‰‡ï¼Œå›¾ç‰‡è‡ªå®š</li>
</ol>


<p>å›¾ç‰‡
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160422-5.png" alt="1" /></p>

<p>æ–‡æœ¬
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160422-4.png" alt="2" /></p>

<h3>åˆ›å»ºæ–‡æœ¬çš„TextStub</h3>

<pre><code>/**
 *  åˆ›å»ºæ–‡æœ¬çš„TextStub
 */
-(void)createTextStub{
    // #1
    static id&lt;OHHTTPStubsDescriptor&gt; textStub = nil;

    // #2
    textStub= [OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest * _Nonnull request) {
        return [request.URL.pathExtension isEqualToString:@"txt"];
    } withStubResponse:^OHHTTPStubsResponse * _Nonnull(NSURLRequest * _Nonnull request) {

        NSString *path = OHPathForFile(@"stub.txt",self.class);

       //#3
        return [[OHHTTPStubsResponse responseWithFileAtPath:path
                                                 statusCode:200 headers:@{@"Content-Type":@"text/plain"}]
                requestTime:1.0f
                responseTime:OHHTTPStubsDownloadSpeedWifi];

    }];
    //#4
    textStub.name = @"text stub";
}
</code></pre>

<p>ä¸Šé¢ä»£ç æ„ä¹‰å¦‚ä¸‹:</p>

<ol>
<li>å£°æ˜ä¸€ä¸ªè¿”å›çš„OHHTTPStubsDescriptor,è¿™æ˜¯åˆ›å»ºæ¨¡æ‹ŸæœåŠ¡å™¨çš„è¿”å›ç»“æœæè¿°</li>
<li>å¼€å§‹åˆ›å»ºæ¨¡æ‹ŸæœåŠ¡å™¨</li>
<li>è¿”å›responseï¼Œå…¶ä¸­è®¾ç½®äº†è¿”å›æ•°æ®ï¼ŒçŠ¶æ€ç ï¼Œè¯·æ±‚æ—¶é—´ç­‰</li>
<li>ç»™textStubèµ·ä¸ªåå­—</li>
</ol>


<h2>æµ‹è¯•æ–‡æœ¬çš„æ¨¡æ‹ŸæœåŠ¡å™¨</h2>

<p>åˆ›å»ºä¸€ä¸ªtestStubTextTaskæ–¹æ³•:</p>

<pre><code>/**
 *  æµ‹è¯•æ–‡æœ¬çš„Stubä»»åŠ¡
 */
-(void)testStubTextTask{
    //åˆ›å»ºæ–‡æœ¬çš„æ¨¡æ‹ŸæœåŠ¡å™¨
    [self createTextStub];
    //åˆ›å»ºä¸€ä¸ªæœŸæœ›å€¼
    XCTestExpectation *expection=[self expectationWithDescription:@"high expection"];

    NSURLSession *session=[NSURLSession sharedSession];

    NSString *urlString=@"stub.txt";
    NSURLSessionDataTask *dataTask = [session dataTaskWithURL:[NSURL URLWithString:urlString] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {

        NSString* receivedText = [[NSString alloc] initWithData:data encoding:NSASCIIStringEncoding];
        NSLog(@"è¿”å›çš„ç»“æœ:%@",receivedText);

        XCTAssert(receivedText!=nil);

        [expection fulfill];
    }];

    [dataTask resume];

    [self waitForExpectationsWithTimeout:5 handler:^(NSError * _Nullable error) {
        if(error){
            NSLog(@"å‡ºé”™äº†:%@",error.description);
        }
    }];
}
</code></pre>

<h2>åˆ›å»ºå›¾ç‰‡çš„stub</h2>

<pre><code>/**
 *  åˆ›å»ºImageçš„stub
 */
-(void)createImageStub{
    static id&lt;OHHTTPStubsDescriptor&gt; imageStub = nil;

    imageStub=[OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest * _Nonnull request) {
        return [request.URL.pathExtension isEqualToString:@"png"];
    } withStubResponse:^OHHTTPStubsResponse * _Nonnull(NSURLRequest * _Nonnull request) {
        return [OHHTTPStubsResponse responseWithFileAtPath:OHPathForFile(@"stub.jpg", self.class) statusCode:200 headers:@{@"Content-Type":@"image/jpeg"}];
    }];

    imageStub.name=@"Image stub";
}
</code></pre>

<h2>æµ‹è¯•Imageçš„æ¨¡æ‹ŸæœåŠ¡å™¨</h2>

<pre><code>/**
 *  æµ‹è¯•Imageçš„æ¨¡æ‹ŸæœåŠ¡å™¨
 */
- (void)testImageStubTask{

    [self createImageStub];

    XCTestExpectation *expection=[self expectationWithDescription:@"Image Expection"];

    NSURLSessionDataTask *dataStask=[self.session dataTaskWithURL:[NSURL URLWithString:@"test.png" relativeToURL:nil] completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {

        UIImage *image=[UIImage imageWithData:data];

        NSLog(@"è¿”å›çš„image:%@",image.description);

        XCTAssert(image!=nil);

        [expection fulfill];

    }];

    [dataStask resume];

    [self waitForExpectationsWithTimeout:3 handler:^(NSError * _Nullable error) {
        if(error){
            NSLog(@"å‡ºé”™äº†:%@",error.description);
        }
    }];

}
</code></pre>

<h2>å®Œæ•´å·¥ç¨‹</h2>

<p><a href="https://github.com/TLOpenSpring/OHHTTPStubsDemo/archive/master.zip">å®Œæ•´å·¥ç¨‹åœ¨è¿™é‡Œä¸‹è½½</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æµ‹è¯•å¹¶å‘ç¨‹åº]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/21/ce-shi-bing-fa-cheng-xu/"/>
    <updated>2016-04-21T17:38:05+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/21/ce-shi-bing-fa-cheng-xu</id>
    <content type="html"><![CDATA[<p>åœ¨å¼€å‘é«˜è´¨é‡åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œæµ‹è¯•æ—¶ä¸€ä¸ªå¾ˆé‡è¦çš„å·¥å…·ã€‚åœ¨è¿‡å»ï¼Œå½“å¹¶å‘ä¸æ˜¯åº”ç”¨ç¨‹åºæ¶æ„ä¸­é‡è¦ç»„æˆéƒ¨åˆ†çš„æ—¶å€™ï¼Œæµ‹è¯•å°±æƒ³å•ç®€å•ã€‚éšç€è¿™å‡ å¹´çš„å‘å±•ï¼Œä½¿ç”¨å¹¶å‘è®¾è®¡æ¨¡å¼å˜å¾—è¶Šæ¥è¶Šé‡è¦äº†ï¼Œæƒ³è¦æµ‹è¯•å¥½å¹¶å‘åº”ç”¨ç¨‹åºï¼Œå·²æˆäº†ä¸€ä¸ªä¸å°çš„æŒ‘æˆ˜.</p>

<!--more-->


<p>æµ‹è¯•å¹¶å‘ä»£ç æœ€ä¸»è¦çš„å›°éš¾åœ¨äºç¨‹åºæˆ–ä¿¡æ¯æµä¸æ˜¯ååº”åœ¨è°ƒç”¨å †æ ˆä¸Šã€‚å‡½æ•°å¹¶ä¸ä¼šç«‹å³è¿”å›ç»™è°ƒç”¨è€…ï¼Œè€Œæ˜¯é€šè¿‡å›è°ƒå‡½æ•°blockï¼Œé€šçŸ¥æˆ–è€…ä¸€äº›ç±»ä¼¼çš„æœºåˆ¶ï¼Œè¿™äº›ä½¿å¾—æµ‹è¯•å˜å¾—æ›´åŠ å›°éš¾ã€‚</p>

<p>ç„¶åï¼Œæµ‹è¯•å¼‚æ­¥ä»£ç ä¹Ÿä¼šå¸¦æ¥ä¸€äº›å¥½å¤„ï¼Œæ¯”å¦‚å¯ä»¥æ­éœ²è¾ƒå·®çš„ç¨‹åºè®¾è®¡ï¼Œè®©æœ€ç»ˆçš„å®ç°å˜å¾—æ›´åŠ æ¸…æ™°ã€‚</p>

<h1>å¼‚æ­¥æµ‹è¯•çš„é—®é¢˜</h1>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•åœ°åŒæ­¥å•å…ƒæµ‹è¯•çš„ä¾‹å­ï¼Œä¸¤ä¸ªæ•°æ±‚å’Œçš„æ–¹æ³•.</p>

<pre><code>+ (int)add:(int)a to:(int)b {
    return a + b;
}
</code></pre>

<p>æµ‹è¯•è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦æ¯”è¾ƒè¯¥æ–¹æ³•è¿”å›å€¼æ˜¯å¦å’ŒæœŸæœ›å€¼ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒï¼Œåˆ™æµ‹è¯•å¤±è´¥ã€‚</p>

<pre><code>- (void)testAddition {
    int result = [Calculator add:2 to:2];
    STAssertEquals(result, 4, nil);
}
</code></pre>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ©ç”¨blockå°†è¯¥æ–¹æ³•æ”¹æˆå¼‚æ­¥è¿”å›ç»“æœï¼Œä¸ºäº†æ¨¡æ‹Ÿæµ‹è¯•å¤±è´¥ï¼Œæˆ‘ä»¬ä¼šåœ¨æ–¹æ³•å®ç°ä¸­æ•…æ„æ·»åŠ ä¸€ä¸ªbug.</p>

<pre><code>+ (int)add:(int)a to:(int)b block:(void(^)(int))block {
    [[NSOperationQueue mainQueue] addOperationWithBlock:^{
        block(a - b); // å¸¦æœ‰bugçš„å®ç°
    }];
}
</code></pre>

<p>è™½ç„¶è¿™æ˜¯ä¸€ä¸ªäººä¸ºçš„ä¾‹å­ï¼Œä½†æ˜¯å®ƒå´çœŸå®çš„åæ˜ äº†ç¼–ç¨‹ä¸­å¯èƒ½ç»å¸¸é‡åˆ°çš„é—®é¢˜ï¼Œåªä¸è¿‡å®é™…è¿‡ç¨‹æ›´åŠ å¤æ‚ç½¢äº†ã€‚</p>

<p>æµ‹è¯•ä¸Šé¢çš„æ–¹æ³•æœ€ç®€å•çš„åšæ³•å°±æ˜¯æŠŠæ–­è¨€æ”¾åˆ°Blockä¸­ã€‚å°½ç®¡æˆ‘ä»¬çš„æ–¹æ³•å®ç°ä¸­å­˜åœ¨bug,ä½†æ˜¯è¿™ç§æµ‹è¯•æ°¸è¿œä¸æ˜¯å¤±è´¥çš„ï¼›</p>

<pre><code>// åƒä¸‡ä¸è¦ä½¿ç”¨è¿™äº›ä»£ç ï¼
- (void)testAdditionAsync {
    [Calculator add:2 to:2 block:^(int result) {
        STAssertEquals(result, 4, nil); // æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨åˆ°
    }];
}
</code></pre>

<p>è¿™é‡Œçš„æ–­è¨€ä¸ºä»€ä¹ˆæ²¡å¤±è´¥å‘¢ï¼Ÿ</p>

<h1>å…³äºSenTestingKit</h1>

<p>åœ¨è€ç‰ˆæœ¬çš„xcodeä¸­æ‰€ä½¿ç”¨çš„æµ‹è¯•æ¡†æ¶æ˜¯åŸºäº <a href="http://www.sente.ch/software/ocunit/">OCUnit</a>ã€‚ä¸ºäº†ç†è§£ä¹‹å‰æ‰€æåˆ°çš„å¼‚æ­¥æµ‹è¯•é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹æµ‹è¯•åŒ…ä¸­çš„å„ä¸ªéƒ¨åˆ†ä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªç®€åŒ–çš„æµç¨‹ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/SenTestingKit-call-stack.png" alt="test" /></p>

<p>åœ¨æµ‹è¯•æ¡†æ¶åœ¨ä¸»run loopå¼€å§‹è¿è¡Œä¹‹åï¼Œä¸»è¦æ‰§è¡Œäº†ä¸€ä¸‹å‡ ä¸ªæ­¥éª¤:</p>

<ol>
<li>é…ç½®ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³æµ‹è¯•çš„æµ‹è¯•åŒ…</li>
<li>è¿è¡Œæµ‹è¯•åŒ…ï¼Œå†…éƒ¨ä¼šè°ƒç”¨æ‰€æœ‰ä»¥testå¼€å¤´æµ‹è¯•ç”¨ä¾‹çš„æ–¹æ³•ã€‚è¿è¡Œç»“æŸåä¼šè¿”å›ä¸€ä¸ªåŒ…å«å•ä¸ªæµ‹è¯•ç»“æœçš„å¯¹è±¡ã€‚</li>
<li>è°ƒç”¨exit()é€€å‡ºæµ‹è¯•</li>
</ol>


<p>è¿™å…¶ä¸­æˆ‘ä»¬æœ€æ„Ÿå…´è¶£çš„æ˜¯å•ä¸ªæµ‹è¯•æ—¶å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚åœ¨å¼‚æ­¥æµ‹è¯•ä¸­ï¼ŒåŒ…å«æ–­è¨€çš„Blockä¼šè¢«åŠ åˆ°run loopã€‚å½“æ‰€æœ‰çš„æµ‹è¯•æ‰§è¡Œå®Œæ¯•åï¼Œæµ‹è¯•æ¡†æ¶å°±ä¼šé€€å‡ºï¼Œè€Œblockå´ä»æ¥æ²¡æœ‰è¢«æ‰§è¡Œï¼Œå› æ­¤ä¸ä¼šå¼•èµ·æµ‹è¯•å¤±è´¥ã€‚</p>

<p>å½“ç„¶æˆ‘ä»¬æœ‰å¾ˆå¤šç§æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½†æ˜¯ç´ æœ‰çš„æ–¹æ³•éƒ½å¿…é¡»åœ¨ä½run loopä¸­è¿è¡Œï¼Œè€Œä¸”åœ¨æµ‹è¯•æ–¹æ³•è¿”å›å’Œæ¯”è¾ƒç»“æœä¹‹å‰éœ€è¦å¤„ç†å·²å…¥é˜Ÿçš„æ‰€æœ‰æ“ä½œã€‚</p>

<p><a href="https://github.com/allending/Kiwi">kiwi</a>ä½¿ç”¨æµ‹è¯•è½®è¯¢ï¼Œå®ƒå¯ä»¥åœ¨æµ‹è¯•æ–¹æ³•ä¸­è¢«æ»´å•Šç”¨ã€‚<a href="https://github.com/gabriel/gh-unit/">GHUnit</a>ç¼–å†™äº†ä¸€ä¸ªå•ç‹¬çš„æµ‹è¯•ç±»ï¼Œå®ƒå¿…é¡»åœ¨æµ‹è¯•çš„æ–¹æ³•å†…åˆå§‹åŒ–ï¼Œå¹¶åœ¨ç»“æŸæ—¶æ¥å—ä¸€ä¸ªé€šçŸ¥ã€‚ä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ½æ˜¯é€šè¿‡ç¼–å†™ç›¸åº”çš„ä»£ç æ¥ç¡®ä¿å¼‚æ­¥å¼‚æ­¥æµ‹è¯•æ–¹æ³•åœ¨æµ‹è¯•ç»“æŸä¹‹å‰éƒ½ä¸ä¼šè¿”å›ã€‚</p>

<h1>SenTesgingKitçš„å¼‚æ­¥æ‰©å±•</h1>

<p>æˆ‘ä»¬å¯¹è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯å¯¹SenTestingKitæ·»åŠ ä¸€ä¸ªæ‰©å±•ï¼Œå®ƒåœ¨æ ˆä¸Šä½¿ç”¨åŒæ­¥æ‰§è¡Œï¼Œå¹¶æŠŠæ¯ä¸ªéƒ¨åˆ†åŠ å…¥åˆ°ä¸»é˜Ÿåˆ—ä¸­ã€‚æ­£å¦‚ä¸‹å›¾æ‰€è§ï¼Œåœ¨éªŒè¯æ•´ä¸ªæµ‹è¯•æ¡†æ¶ç»“æœä¹‹å‰ï¼ŒæŠ¥å‘Šå¼‚æ­¥æµ‹è¯•æˆåŠŸæˆ–å¤±è´¥çš„Blockå°±è¢«åŠ å…¥åˆ°é˜Ÿåˆ—ã€‚è¿™ç§æ‰§è¡Œé¡ºåºå…è®¸æˆ‘ä»¬å¼€å¯ä¸€ä¸ªæµ‹è¯•å¹¶ç­‰å¾…å®ƒçš„æµ‹è¯•ç»“æœã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/SenTestingKitAsync-call-stack.png" alt="test" /></p>

<p>å¦‚æœæµ‹è¯•æ–¹æ³•ä»¥Asyncç»“å°¾ï¼Œæ¡†æ¶å°±ç¡è®¤ä¸ºè¯¥æ–¹æ³•æ˜¯å¼‚æ­¥æµ‹è¯•ã€‚æ­¤å¤–ï¼Œåœ¨å¼‚æ­¥æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨çš„æŠ¥å‘Šæµ‹è¯•æˆåŠŸï¼ŒåŒæ—¶ä¸ºäº†é˜²æ­¢Blockæ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ·»åŠ äº†ä¸€ä¸ªè¶…æ—¶æ–¹æ³•ï¼Œä¹‹å‰çš„é”™è¯¯çš„æµ‹è¯•æ–¹æ³•ä¿®æ”¹å¦‚ä¸‹:</p>

<pre><code>- (void)testAdditionAsync {
    [Calculator add:2 to:2 block^(int result) {
        STAssertEquals(result, 4, nil);
        STSuccess(); // é€šè¿‡è°ƒç”¨è¿™ä¸ªå®æ¥åˆ¤æ–­æ˜¯å¦æµ‹è¯•æˆåŠŸ
    }];
    STFailAfter(2.0, @"Timeout");
}
</code></pre>

<h1>è®¾è®¡å¼‚æ­¥æµ‹è¯•</h1>

<p>å°±åƒåŒæ­¥æµ‹è¯•ä¸€æ ·ï¼Œå¼‚æ­¥æµ‹è¯•ä¹Ÿåº”è¯¥æ¯”è¢«æµ‹è¯•çš„åŠŸèƒ½ç®€å•è®¸å¤šã€‚å¤æ‚çš„æµ‹è¯•å¹¶ä¸ä¼šæ”¹è¿›ä»£ç çš„è´¨é‡ï¼Œåè€Œä¼šç»™æµ‹è¯•æœ¬èº«å¸¦æ¥æ›´å¤šçš„Bug,åœ¨ä»¥æµ‹è¯•é©±åŠ¨å¼€å‘çš„æƒ…å†µä¸‹ï¼Œç®€å•çš„æµ‹è¯•ä¼šè®©æˆ‘ä»¬å¯¹ç»„ä»¶ï¼Œæ¥å£ä»¥åŠæ¶æ„çš„è¡Œä¸ºæœ‰æ›´æ¸…é†’çš„è®¤è¯†.</p>

<p>ä¸ºäº†è¿è¡Œåˆ°å®é™…ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹æ¡†æ¶: <a href="sd">AsyncTestDemo</a>,å®ƒä»ä¸€ä¸ªè™šæ‹Ÿçš„æœåŠ¡å™¨è·å–å›¾åƒä¿¡æ¯ï¼Œæ¡†æ¶ä¸­åŒ…å«äº†ä¸€ä¸ªèµ„æºç®¡ç†å™¨ï¼Œå®ƒå¯¹å¤–æä¾›äº†ä¸€ä¸ªå¯ä»¥æ ¹æ®å›¾åƒIdè·å–å›¾åƒå¯¹è±¡çš„æ¥å£ã€‚è¯¥æ¥å£çš„å·¥ä½œåŸç†æ˜¯èµ„æºç®¡ç†å™¨ä»è™šæ‹ŸæœåŠ¡å™¨è·å–å›¾ç‰‡å¯¹è±¡ä¿¡æ¯ï¼Œå¹¶æ›´æ–°åˆ°æ•°æ®åº“ã€‚</p>

<p>è™½ç„¶è¿™ä¸ªç¤ºä¾‹æ¡†æ¶åªæ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œä½†åœ¨æˆ‘ä»¬è‡ªå·±å¼€å‘çš„è®¸å¤šåº”ç”¨ä¸­ä¹Ÿä½¿ç”¨äº†è¿™ç§æ¨¡å¼ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/PinacotecaCore.png" alt="test" /></p>

<p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œç¤ºä¾‹æ¡†æ¶æœ‰ä¸‰ä¸ªç»„ä»¶æˆ‘ä»¬éœ€è¦æµ‹è¯•:</p>

<ol>
<li>æ¨¡å‹å±‚</li>
<li>æ¨¡æ‹ŸæœåŠ¡å™¨è¯·æ±‚çš„æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨(API Controller)</li>
<li>ç®¡ç†Core dataå †æ ˆä»¥åŠè¿æ¥æ¨¡å‹å±‚å’ŒæœåŠ¡æ¥å£æ§åˆ¶å™¨çš„èµ„æºç®¡ç†å™¨</li>
</ol>


<h2>æ¨¡å‹å±‚</h2>

<p>æµ‹è¯•åº”è¯¥å°½é‡ä½¿ç”¨åŒæ­¥çš„æ–¹å¼è¿›è¡Œï¼Œè€Œæ¨¡å‹å±‚å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®ä¾‹ã€‚åªè¦ä¸åŒçš„è¢«æ‰˜ç®¡å¯¹è±¡ä¸Šä¸‹æ–‡ä¹‹é—´æ²¡æœ‰å¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œæµ‹è¯•ç”¨ä¾‹éƒ½åº”è¯¥æ ¹æ®ä¸Šä¸‹æ–‡åœ¨ä¸»çº¿ç¨‹ä¸Šè®¾ç½®å®ƒè‡ªå·±çš„core dataå †æ ˆï¼Œå¹¶åœ¨å…¶ä¸­æ‰§è¡Œå„è‡ªçš„æ“ä½œã€‚</p>

<p>åœ¨è¿™ä¸ªæµ‹è¯•å®ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°±æ˜¯åœ¨ setup æ–¹æ³•ä¸­è®¾ç½®core dataå †æ ˆï¼Œç„¶åæ£€æŸ¥ PCImageå®ä½“çš„æè¿°æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±æ„é€ ä¸€ä¸ªï¼Œå¹¶æ›´æ–°å®ƒçš„å€¼ï¼Œå½“ç„¶è¿™å’Œå¼‚æ­¥æµ‹è¯•æ²¡æœ‰å…³ç³»ï¼Œæˆ‘ä»¬å°±ä¸æ·±å…¥ç»†è¯´äº†ã€‚</p>

<h2>æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨</h2>

<p>æ¡†æ¶ä¸­çš„ç¬¬äºŒä¸ªç»„ä»¶å°±æ˜¯æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨ï¼Œå®ƒä¸»è¦å¤„ç†æœåŠ¡å™¨è¯·æ±‚ä»¥åŠæœåŠ¡å™¨APIåˆ°æ¨¡å‹çš„æ˜ å°„å…³ç³»ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªæ–¹æ³•:</p>

<pre><code>- [PCServerAPIController fetchImageWithId:queue:completionHandler:]
</code></pre>

<p>è°ƒç”¨å®ƒéœ€è¦ä¸‰ä¸ªå½¢å‚ï¼šä¸€ä¸ªå›¾ç‰‡å¯¹è±¡Idï¼Œæ‰€åœ¨çš„æ‰§è¡Œé˜Ÿåˆ—ï¼Œä»¥åŠä¸€ä¸ªå®Œæˆåçš„å›è°ƒæ–¹æ³•ã€‚</p>

<p>å› ä¸ºæœåŠ¡å™¨æ ¹æœ¬ä¸å­˜åœ¨ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„åšæ³•å°±æ˜¯ä¼ªé€ ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œæ­£å¥½<a href="https://github.com/AliSoftware/OHHTTPStubs">OHHTTPStubs</a>å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åœ¨å®ƒçš„æœ€æ–°ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥åœ¨ç¤ºä¾‹çš„è¯·æ±‚å“åº”ä¸­åŒ…å«ä¸€ä¸ªbundle,å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>

<p>ä¸ºäº†èƒ½stubè¯·æ±‚ï¼ŒOHHTTPStubséœ€è¦åœ¨æµ‹è¯•ç±»åˆå§‹åŒ–æ—¶æˆ–è€… setupæ–¹æ³•ä¸­è¿›è¡Œé…ç½®ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦åŠ è½½ä¸€ä¸ªåŒ…å«è¯·æ±‚å“åº”å¯¹è±¡(response)çš„bundle:</p>

<pre><code>NSURL *url = [[NSBundle bundleForClass:[self class]]
                        URLForResource:@"ServerAPIResponses"
                         withExtension:@"bundle"];

NSBundle *bundle = [NSBundle url];
</code></pre>

<p>ç„¶åæˆ‘ä»¬ä»bundleåŠ è½½responseå¯¹è±¡ï¼Œä½œä¸ºè¯·æ±‚çš„å“åº”å€¼:</p>

<pre><code>OHHTTPStubsResponse *response;
response = [OHHTTPStubsResponse responseNamed:@"images/123"
                                   fromBundle:responsesBundle
                                 responseTime:0.1];

[OHHTTPStubs stubRequestsPassingTest:^BOOL(NSURLRequest *request) {
    return YES /* å¦‚æœæ‰€è¿”å›çš„requestæ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ï¼Œå°±è¿”å›YES */;
} withStubResponse:^OHHTTPStubsResponse *(NSURLRequest *request) {
    return response;
}];
</code></pre>

<p>é€šè¿‡å¦‚ä¸Šçš„è®¾ç½®ä¹‹åï¼Œç®€åŒ–ç‰ˆçš„<a href="https://github.com/objcio/issue-2-async-testing/blob/master/PinacotecaCore/PinacotecaCoreTests/PCServerAPIControllerTests.m">æµ‹è¯•æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨</a>å¦‚ä¸‹:</p>

<pre><code>- (void)testFetchImageAsync
{
    [self.server
        fetchImageWithId:@"123"
                   queue:[NSOperationQueue mainQueue]
       completionHandler:^(id imageData, NSError *error) {
          STAssertEqualObjects([NSOperationQueue currentQueue], queue, nil);
          STAssertNil(error, [error localizedDescription]);
          STAssertTrue([imageData isKindOfClass:[NSDictionary class]], nil);

          // æ£€æŸ¥è¿”å›çš„å­—å…¸ä¸­çš„å€¼.

          STSuccess();
       }];
    STFailAfter(2.0, nil);    
}
</code></pre>

<h2>èµ„æºç®¡ç†å™¨</h2>

<p>æœ€åä¸€ä¸ªéƒ¨åˆ†æ˜¯èµ„æºç®¡ç†å™¨ï¼Œå®ƒä¸ä½†æŠŠæœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨å’Œè†œå½¢æˆå‘¢ä¸ªè”ç³»èµ·æ¥ï¼Œè¿˜ç®¡ç†ç€core dataå †æ ˆã€‚ä¸‹é¢æˆ‘ä»¬æƒ³æµ‹è¯•è·å–ä¸€ä¸ªå›¾ç‰‡å¯¹è±¡çš„æ–¹æ³•:</p>

<pre><code>-[PCResourceManager imageWithId:usingManagedObjectContext:queue:updateHandler:]
</code></pre>

<p>è¯¥æ–¹æ³•æ ¹æ®Idè¿”å›ä¸€ä¸ªå›¾ç‰‡å¯¹è±¡ã€‚å¦‚æœå›¾ç‰‡åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«Idçš„æ–°å¯¹è±¡ï¼Œç„¶åé€šè¿‡æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨è·å–å›¾ç‰‡å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>

<p>ç”±äºèµ„æºç®¡ç†å™¨çš„æµ‹è¯•ä¸åº”è¯¥ä¾èµ–äºæœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨<a href="http://ocmock.org/">OCMock</a>æ¥æ¨¡æ‹Ÿï¼Œå¦‚æœè¦åšæ–¹æ³•çš„éƒ¨åˆ†stub,å®ƒæ˜¯ä¸€ä¸ªç†æƒ³çš„æ¡†æ¶.å¦‚ä»¥ä¸‹çš„ <a href="https://github.com/objcio/issue-2-async-testing/blob/master/PinacotecaCore/PinacotecaCoreTests/PCResourceManagerTests.m">èµ„æºç®¡ç†å™¨æµ‹è¯•</a>:</p>

<pre><code>OCMockObject *mo;
mo = [OCMockObject partialMockForObject:self.resourceManager.server];

id exp = [[serverMock expect] 
             andCall:@selector(fetchImageWithId:queue:completionHandler:)
            onObject:self];
[exp fetchImageWithId:OCMOCK_ANY queue:OCMOCK_ANY completionHandler:OCMOCK_ANY];
</code></pre>

<p>ä¸Šé¢çš„ä»£ç å®é™…ä¸Šå®ƒå¹¶æ²¡æœ‰çœŸæ­£è°ƒç”¨æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨çš„æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨æˆ‘ä»¬å¸è½½æµ‹è¯•ç±»ä¸­çš„æ–¹æ³•ã€‚</p>

<p>ç”¨ä¸Šé¢çš„ä½œåŠï¼Œå¯¹èµ„æºç®¡ç†çš„æµ‹è¯•å°±å˜å¾—å¾ˆç›´è§‚ã€‚å½“æˆ‘ä»¬è°ƒç”¨èµ„æºç®¡ç†å™¨è·å–èµ„æºæ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„ä½¿æˆ‘ä»¬æ¨¡æ‹Ÿçš„æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨çš„æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬ä¹Ÿèƒ½æ£€æŸ¥è°ƒç”¨æœåŠ¡å™¨æ¥å£æ§åˆ¶å™¨æ—¶å‚æ•°æ˜¯å¦æ­£ç¡®ã€‚åœ¨è°ƒç”¨äº†è·å–å›¾åƒå¯¹è±¡çš„æ–¹æ³•åï¼Œèµ„æºç®¡ç†å™¨ä¼šæ›´æ–°æ¨¡å‹ï¼Œç„¶åè°ƒç”¨éªŒè¯æµ‹è¯•æˆåŠŸä¸å¦çš„å®ã€‚</p>

<pre><code>- (void)testGetImageAsync
{
    NSManagedObjectContext *ctx = self.resourceManager.mainManagedObjectContext;
    __block PCImage *img;
    img = [self.resourceManager imageWithId:@"123"
                  usingManagedObjectContext:ctx
                                      queue:[NSOperationQueue mainQueue]
                              updateHandler:^(NSError *error) {
                                       // æ£€æŸ¥erroræ˜¯å¦ä¸ºç©ºä»¥åŠimageæ˜¯å¦å·²ç»è¢«æ›´æ–° 
                                       STSuccess();
                                   }];    
    STAssertNotNil(img, nil);
    STFailAfter(2.0, @"Timeout");
}
</code></pre>

<h1>æ€»ç»“</h1>

<p>åˆšå¼€å§‹çš„æ—¶å€™ï¼Œä½¿ç”¨å¹¶å‘è®¾è®¡æ¨¡å¼æµ‹è¯•åº”ç”¨ç¨‹åºæ˜¯å…·æœ‰ä¸€å®šçš„æŒ‘æˆ˜æ€§ï¼Œä½†æ˜¯ä¸€æ—¦ä½ ç†è§£äº†ä»–ä»¬çš„ä¸åŒï¼Œå¹¶å»ºç«‹æœ€ä½³å®è·µï¼Œä¸€åˆ‡éƒ½ä¼šå˜å¾—ç®€å•è€Œæœ‰è¶£ã€‚</p>

<p>ğŸ˜€fun~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Iosä¸­çš„å¤šä»»åŠ¡]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/04/19/ioszhong-de-duo-ren-wu/"/>
    <updated>2016-04-19T10:17:49+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/04/19/ioszhong-de-duo-ren-wu</id>
    <content type="html"><![CDATA[<p>åœ¨ios7ä¹‹å‰ï¼Œå½“ç¨‹åºç½®äºåå°ä¹‹åå¼€å‘è€…ä»¬å¯¹ä»–ä»¬ç¨‹åºæ‰€èƒ½åšçš„äº‹æƒ…éå¸¸æœ‰é™ï¼Œé™¤äº†VOIPå’ŒåŸºäºåœ°ç†ä½ç½®ç‰¹æ€§ä¹‹å¤–ï¼Œå”¯ä¸€èƒ½åšçš„åœ°æ–¹å°±æ˜¯åå°ä»»åŠ¡(background tasks)è®©ä»£ç å¯ä»¥æ‰§è¡Œå‡ åˆ†é’Ÿã€‚å¦‚æœä½ æƒ³ä¸‹è½½æ¯”è¾ƒå¤§çš„è§†é¢‘æ–‡ä»¶ä»¥ä¾¿ç¦»çº¿æµè§ˆï¼Œæˆ–è€…å¤‡ä»½ç”¨æˆ·çš„ç…§ç‰‡åˆ°ä½ çš„æœåŠ¡å™¨ä¸Šï¼Œä½ éƒ½ä»…èƒ½å®Œæˆä¸€éƒ¨åˆ†å·¥ä½œ.</p>

<p> <!--more--></p>

<p>ios7æ·»åŠ äº†ä¸¤ä¸ªæ–°çš„APIä»¥ä¾¿ä½ çš„ç¨‹åºå¯ä»¥åœ¨åå°æ›´æ–°ç•Œé¢ä»¥åŠå†…å®¹ã€‚é¦–å…ˆæ˜¯åå°è·å–(background Fetch)ï¼Œå®ƒå…è®¸ä½ å®šä¹‰åœ°ä»ç½‘ç»œè·å–æ–°çš„å†…å®¹ã€‚ç¬¬äºŒä¸ªAPIå°±æ˜¯è¿œç¨‹é€šçŸ¥(Remote Notifications)ï¼Œè¿™æ˜¯ä¸€ä¸ªå½“äº‹ä»¶å‘ç”Ÿæ—¶å¯ä»¥è®©æ¨é€é€šçŸ¥ä¸»åŠ¨æé†’åº”ç”¨çš„æ–°ç‰¹æ€§ï¼Œè¿™ä¸¤è€…éƒ½ä¸ºä½ çš„åº”ç”¨ç•Œé¢ä¿æŒæœ€æ–°æä¾›äº†æå¤§çš„å¸®åŠ©ã€‚åœ¨æ–°çš„åå°ä¼ è¾“æœåŠ¡(Background Trasnfer service)ä¸­æ‰§è¡Œå®šæœŸçš„ä»»åŠ¡ï¼Œä¹Ÿå…è®¸ä½ åœ¨è¿›ç¨‹ä¹‹å¤–å¯ä»¥æ‰§è¡Œç½‘ç»œä¼ è¾“(ä¸‹è½½å’Œä¸Šä¼ )å·¥ä½œ</p>

<p>åå°è·å–(Background Fetch)å’Œè¿œç¨‹é€šçŸ¥(Remote notification)åŸºäºç®€å•çš„ ApplicationDelegateé’©å­ï¼Œåœ¨åº”ç”¨ç¨‹åºæŒ‚èµ·ä¹‹å‰çš„30ç§’æ—¶é—´æ‰§è¡Œå·¥ä½œã€‚å®ƒä»¬ä¸æ˜¯ç”¨äºCPUé¢‘ç¹å·¥ä½œæˆ–è€…é•¿æ—¶é—´è¿è¡Œä»»åŠ¡ï¼Œè€Œæ˜¯ç”¨æ¥å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„ç½‘ç»œè¯·æ±‚é˜Ÿåˆ—ï¼Œä¾‹å¦‚ä¸‹è½½ä¸€éƒ¨å¾ˆå¤§çš„ç”µå½±ï¼Œæˆ–è€…æ‰§è¡Œå¿«é€Ÿçš„å†…å®¹æ›´æ–°ã€‚</p>

<p>å¯¹äºç”¨æˆ·æ¥è¯´,å¤šä»»åŠ¡å¤„ç†æœ‰ç‚¹æ˜¾è€Œæ˜“è§çš„æ”¹å˜å°±æ˜¯æ–°çš„åº”ç”¨åˆ‡æ¢ç¨‹åºï¼Œå®ƒç”¨æ¥å‘ˆç°åº”ç”¨åˆ°åå°æ—¶çš„ç•Œé¢å¿«ç…§ã€‚è¿™äº›å¿«ç…§çš„å­˜åœ¨æ˜¯æœ‰ä¸€å®šç†ç”±çš„&ndash;ç°åœ¨ä½ å¯ä»¥åœ¨åå°å®Œæˆå·¥ä½œåæ›´æ–°ç¨‹åºå¿«ç…§ï¼Œä»¥ç”¨æ¥å‘ˆç°æ–°çš„å†…å®¹ã€‚ç¤¾äº¤ç½‘ç»œï¼Œæ–°é—»æˆ–è€…å¤©æ°”ç­‰åº”ç”¨ç°åœ¨éƒ½å¯ä»¥ç›´æ¥å‘ˆç°æœ€æ–°çš„å†…å®¹è€Œä¸éœ€è¦ç”¨æˆ·é‡æ–°æ‰“å¼€åº”ç”¨ã€‚æˆ‘ä»¬ç¨åä¼šä»‹ç»å¦‚ä½•æ›´æ–°å±å¹•å¿«ç…§ã€‚</p>

<h2>åå°è·å–</h2>

<p>åå°è·å–æ˜¯ä¸€ç§æ™ºèƒ½çš„è½®è¯¢æœºåˆ¶ï¼Œå®ƒå¾ˆé€‚åˆéœ€è¦ç»å¸¸æ›´æ–°å†…å®¹çš„ç¨‹åºï¼Œåƒç¤¾äº¤ç½‘ç»œï¼Œæ–°é—»æˆ–å¤©æ°”çš„ç¨‹åºã€‚ä¸ºäº†åœ¨ç”¨æˆ·å¯åŠ¨ç¨‹åºå‰æå‰å‡ºå‘åå°è·å–ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºå”¤é†’åº”ç”¨ç¨‹åºã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœç”¨æˆ·ç»å¸¸åœ¨ä¸‹åˆä¸€ç‚¹ä½¿ç”¨æŸä¸ªåº”ç”¨ç¨‹åºï¼Œç³»ç»Ÿä¼šå­¦ä¹ ï¼Œé€‚åº”å¹¶åœ¨ä½¿ç”¨å‘¨æœŸå‰æ‰§è¡Œåå°è·å–ã€‚ä¸ºäº†å‡å°‘ç”µæ± ä½¿ç”¨ï¼Œä½¿ç”¨è®¾å¤‡æ— çº¿é€šä¿¡çš„æ‰€æœ‰åº”ç”¨çš„åå°è·å–ä¼šè¢«åˆå¹¶ï¼Œå¦‚æœä½ æƒ³ç³»ç»ŸæŠ¥å‘Šæ–°æ•°æ®æ— æ³•è·å–ï¼Œiosä¼šé€‚åº”å¹¶ä½¿ç”¨æ­¤ä¿¡æ¯é¿å…ä¼šç»§ç»­è·å–ã€‚</p>

<p>å¼€å¯åå°è·å–çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨info plistæ–‡ä»¶ä¸­å¯¹UIBackgroundModesé”®æŒ‡å®šç‰¹å®šçš„å€¼ã€‚æœ€ç®€å•çš„é€”å¾„æ˜¯åœ¨Xcodeçš„project editorä¸­æ–°çš„Capabilitiesæ ‡ç­¾é¡µè®¾ç½®ï¼Œè¿™ä¸ªæ ‡ç­¾é¡µåŒ…å«äº†åå°æ¨¡å¼éƒ¨åˆ†ï¼Œå¯ä»¥æ–¹ä¾¿é…ç½®å¤šä»»åŠ¡é€‰é¡¹ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/capabilities-on-bgfetch.jpg" alt="logo" /></p>

<p>æˆ–è€…ä½ å¯ä»¥æ‰‹åŠ¨é…ç½®è¿™ä¸ªå€¼</p>

<pre><code>&lt;key&gt;UIBackgroundModes&lt;/key&gt;
&lt;array&gt;
    &lt;string&gt;fetch&lt;/string&gt;
&lt;/array&gt;  
</code></pre>

<p>æ¥ä¸‹æ¥ï¼Œå‘Šè¯‰IOSå¤šä¹…è¿›è¡Œä¸€æ¬¡æ•°æ®è·å–</p>

<pre><code>- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{
    [application setMinimumBackgroundFetchInterval:UIApplicationBackgroundFetchIntervalMinimum];

    return YES;
}
</code></pre>

<p>iosé»˜è®¤ä¸è¿›è¡Œåå°è·å–ï¼Œæ‰€ä»¥ä½ éœ€è¦è®¾ç½®ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œå¦åˆ™ï¼Œä½ çš„åº”ç”¨ç¨‹åºæ°¸è¿œä¸èƒ½åœ¨åå°è¢«å”¤é†’ã€‚UIApplicationBackgroundFetchIntervalMinimumè¿™ä¸ªå€¼è¦æ±‚ç³»ç»Ÿå°½å¯èƒ½é¢‘ç¹åœ°å»ç®¡ç†ä½ çš„ç¨‹åºåˆ°åº•ä»€ä¹ˆæ—¶å€™åº”è¯¥è¢«å”¤é†’ï¼Œä½†å¦‚æœä½ ä¸éœ€è¦è¿™æ ·çš„è¯ï¼Œä½ ä¹Ÿåº”è¯¥åˆ¶å®šä¸€ä¸ªä½ æƒ³è¦çš„æ—¶é—´é—´éš”ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤©æ°”çš„åº”ç”¨ç¨‹åºï¼Œå¯èƒ½åªéœ€è¦å‡ ä¸ªå°æ—¶æ›´æ–°ä¸€æ¬¡ï¼ŒIOSå°†ä¼šåœ¨åå°è·å–ä¹‹é—´è‡³å°‘ç­‰å¾…ä½ æŒ‡å®šçš„æ—¶é—´é—´éš”ã€‚</p>

<p>å¦‚æœä½ çš„åº”ç”¨å…è®¸ç”¨æˆ·é€€å‡ºç™»å½•ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰è·å–æ–°æ•°æ®çš„éœ€è¦äº†ï¼Œä½ åº”è¯¥æŠŠminimumBackgroundFetchIntervalè®¾ç½®ä¸ºUIApplicationBackgroundFetchIntervalNever,ä¸“ä¸šé‚£ä¸ªå¯ä»¥èŠ‚çœèµ„æºã€‚</p>

<p>æœ€åä¸€æ­¥æ˜¯åœ¨åº”ç”¨ç¨‹åºå§”æ‰˜ä¸­å®ç°ä¸‹åˆ—æ–¹æ³•:</p>

<pre><code>- (void)                application:(UIApplication *)application 
  performFetchWithCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler
{
    NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];
    NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration];

    NSURL *url = [[NSURL alloc] initWithString:@"http://yourserver.com/data.json"];
    NSURLSessionDataTask *task = [session dataTaskWithURL:url 
                                        completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {

        if (error) {
            completionHandler(UIBackgroundFetchResultFailed);
            return;
        }

        // è§£æå“åº”/æ•°æ®ä»¥å†³å®šæ–°å†…å®¹æ˜¯å¦å¯ç”¨
        BOOL hasNewData = ...
        if (hasNewData) {
            completionHandler(UIBackgroundFetchResultNewData);
        } else {
            completionHandler(UIBackgroundFetchResultNoData);
        }
    }];

    // å¼€å§‹ä»»åŠ¡
    [task resume];
}
</code></pre>

<p>ç³»ç»Ÿå”¤é†’åº”ç”¨ç¨‹åºåå°†ä¼šæ‰§è¡Œè¿™ä¸ªå§”æ‰˜æ–¹æ³•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ åªæœ‰30ç§’çš„æ—¶é—´æ¥ç¡®å®šè·å–çš„æ–°å†…å®¹æ˜¯å¦å¯ç”¨ï¼Œç„¶åå¤„ç†æ–°å†…å®¹å¹¶æ›´æ–°ç•Œé¢ï¼Œ30ç§’æ—¶é—´åº”è¯¥è¶³å¤Ÿå»ç½‘ç»œè·å–æ•°æ®å’Œè·å–ç•Œé¢çš„ç¼©ç•¥å›¾ï¼Œä½†æ˜¯æœ€å¤šåªæœ‰30ç§’ï¼Œå½“å®Œæˆäº†ç½‘ç»œè¯·æ±‚å’Œæ›´æ–°ç•Œé¢åï¼Œä½ åº”è¯¥æ‰§è¡Œå®Œæˆçš„å›è°ƒã€‚</p>

<p>å®Œæˆå›è°ƒçš„æ‰§è¡Œæœ‰ä¸¤ä¸ªç›®çš„ï¼Œé¦–å…ˆï¼Œç³»ç»Ÿä¼šä¼°é‡ä½ çš„è¿›ç¨‹æ¶ˆè€—çš„ç”µé‡ï¼Œå¹¶æ ¹æ®ä½ ä¼ é€’çš„UIBackgroundFetchResultå‚æ•°è®°å½•æ–°æ•°æ®æ˜¯å¦å¯ç”¨ï¼Œå…¶æ¬¡ï¼Œå½“ä½ è°ƒç”¨å®Œæˆçš„å¤„ç†ä»£ç æ—¶ï¼Œåº”ç”¨çš„ç•Œé¢ç¼©ç•¥å›¾ä¼šè¢«é‡‡ç”¨ï¼Œå¹¶æ›´æ–°åº”ç”¨ç¨‹åºåˆ‡æ¢å™¨ï¼Œå½“ç”¨æˆ·åœ¨åº”ç”¨é—´åˆ‡æ¢æ—¶ï¼Œç”¨æˆ·å°†ä¼šçœ‹åˆ°æ–°å†…å®¹ï¼Œè¿™ç§é€šè¿‡completion handleræ¥æŠ¥å‘Šå¹¶ä¸”ç”Ÿæˆæˆªå›¾çš„æ–¹æ³•ï¼Œåœ¨æ–°çš„å¤šä»»åŠ¡å¤„ç†APIä¸­æ˜¯å¾ˆå¸¸è§çš„ã€‚</p>

<p>åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œä½ åº”è¯¥å°†completionHandlerä¼ é€’åˆ°åº”ç”¨ç¨‹åºçš„å­ç»„ä»¶ï¼Œç„¶ååœ¨å¤„ç†å®Œæ•°æ®å’Œæ›´æ–°ç•Œé¢åè°ƒç”¨ã€‚</p>

<p>åœ¨è¿™é‡Œï¼Œä½ å¯èƒ½æƒ³çŸ¥é“iosæ˜¯å¦‚ä½•åœ¨åº”ç”¨ç¨‹åºåå°è¿è¡Œæ—¶è·å¾—ç•Œé¢æˆªå›¾çš„ï¼Œå¹¶ä¸”æƒ³çŸ¥é“åº”ç”¨ç¨‹åºçš„å£°æ˜å‘¨æœŸä¸åå°è·å–ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»ã€‚å¦‚æœåº”ç”¨ç¨‹åºå¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œç³»ç»Ÿä¼šå…ˆå”¤é†’åº”ç”¨ï¼Œç„¶åå†è°ƒç”¨application: performFetchWithCompletionHandler:ã€‚å¦‚æœåº”ç”¨ç¨‹åºè¿˜æ²¡æœ‰å¯åŠ¨ï¼Œç³»ç»Ÿå°†ä¼šå¯åŠ¨å®ƒï¼Œç„¶åè°ƒç”¨å¸¸è§çš„å§”æ‰˜æ–¹æ³•ï¼ŒåŒ…æ‹¬application: didFinishLaunchingWithOptions:ã€‚ä½ å¯ä»¥æŠŠè¿™ç§åº”ç”¨ç¨‹åºè¿è¡Œçš„æ–¹å¼æƒ³è±¡ä¸ºç”¨æˆ·ä»Springboardå¯åŠ¨è¿™ä¸ªç¨‹åºï¼ŒåŒºåˆ«ä»…ä»…åœ¨äºç•Œé¢æ˜¯çœ‹ä¸è§çš„ï¼Œåœ¨å±å¹•å¤–æ¸²æŸ“çš„ã€‚</p>

<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ— è®ºåº”ç”¨åœ¨åå°å¯åŠ¨æˆ–è€…åœ¨å‰å°ï¼Œä½ ä¼šæ‰§è¡Œç›¸åŒçš„å·¥ä½œï¼Œä½†ä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹UIAppcationçš„applicationStateå±æ€§æ¥åˆ¤æ–­åº”ç”¨æ˜¯ä¸æ˜¯ä»åå°å¯åŠ¨ã€‚</p>

<pre><code>- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{
    NSLog(@"Launched in background %d", UIApplicationStateBackground == application.applicationState);

    return YES;
}
</code></pre>

<h2>æµ‹è¯•åå°æ•°æ®è·å–</h2>

<p>æœ‰ä¸¤ç§å¯ä»¥æ¨¡æ‹Ÿåå°è·å–çš„é€”å¾„ã€‚æœ€ç®€å•æ˜¯ä»Xcodeè¿è¡Œä½ çš„åº”ç”¨ï¼Œå½“åº”ç”¨è¿è¡Œæ—¶ï¼Œåœ¨Xcodeçš„Debugèœå•é€‰æ‹©Simulate Background Fetch.</p>

<p>ç¬¬äºŒç§æ–¹æ³•ï¼Œä½¿ç”¨schemeæ›´æ”¹Xcodeè¿è¡Œç¨‹åºçš„æ–¹å¼ã€‚åœ¨Xcodeèœå•çš„Producté€‰é¡¹ï¼Œé€‰æ‹©Schemeç„¶åé€‰æ‹©Manager Schemes.åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥ç¼–è¾‘æˆ–è€…æ·»åŠ ä¸€ä¸ªæ–°çš„scheme,ç„¶åé€‰ä¸­Launch due to a background fetch event ,å¦‚ä¸‹å›¾:</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/edit-scheme-simulate-background-fetch.png" alt="logo" /></p>

<h2>è¿œç¨‹é€šçŸ¥</h2>

<p>è¿œç¨‹é€šçŸ¥å…è®¸ä½ åœ¨é‡è¦äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå‘ŠçŸ¥ä½ çš„åº”ç”¨ã€‚ä½ å¯èƒ½éœ€è¦å‘é€æ–°çš„å³æ—¶æ¶ˆæ¯ï¼Œçªå‘æ–°é—»çš„æé†’ï¼Œæˆ–è€…ç”¨æˆ·å–œçˆ±ç”µè§†çš„æœ€æ–°å‰§é›†å·²ç»å¯ä»¥ä¸‹è½½ä¸€éç¦»çº¿è§‚çœ‹çš„æ¶ˆæ¯ã€‚è¿œç¨‹é€šçŸ¥å¾ˆé€‚åˆç”¨äºé‚£äº›å¶å°”å‡ºç°ï¼Œä½†å´å¾ˆé‡è¦çš„å†…å®¹ï¼Œå¦‚æœä½¿ç”¨åå°è·å–æ¨¡å¼ä¸­æœ‰ä¸¤æ¬¡è·å–é—´éœ€è¦ç­‰å¾…çš„æ—¶é—´æ˜¯ä¸å¯æ¥å—çš„è¯ï¼Œè¿œç¨‹é€šçŸ¥ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚è¿œç¨‹é€šçŸ¥ä¼šæ¯”åå°è·å–æ›´æœ‰æ•ˆç‡ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºåªæœ‰åœ¨éœ€è¦çš„æ—¶å€™çš„æ‰ä¼šå¯åŠ¨ã€‚</p>

<p>ä¸€æ¡è¿œç¨‹é€šçŸ¥å®é™…ä¸Šåªæ˜¯ä¸€æ¡æ™®é€šçš„å¸¦æœ‰content-available æ ‡å¿—çš„æ¨é€é€šçŸ¥ã€‚ä½ å¯ä»¥å‘é€ä¸€æ¡å¸¦æœ‰æé†’æ¶ˆæ¯çš„æ¨é€å»å‘Šè¯‰ç”¨æˆ·æœ‰äº‹æƒ…å‘ç”Ÿäº†ï¼ŒåŒæ—¶åœ¨åå°å¯¹ç•Œé¢è¿›è¡Œæ›´æ–°ã€‚ä½†è¿œç¨‹é€šçŸ¥ä¹Ÿå¯ä»¥åšåˆ°å®‰é™çš„ï¼Œæ²¡æœ‰æé†’æ¶ˆæ¯æˆ–è€…ä»»ä½•å£°éŸ³ çš„æƒ…å†µä¸‹ï¼Œåªå»æ›´æ–°åº”ç”¨ç•Œé¢æˆ–è€…è§¦å‘åå°å·¥ä½œã€‚ç„¶åä½ å¯ä»¥åœ¨å®Œæˆä¸‹è½½æˆ–è€…å¤„ç†å®Œæ–°å†…å®¹åï¼Œå‘é€ä¸€æ¡æœ¬åœ°é€šçŸ¥ã€‚</p>

<p>é™é»˜çš„æ¨é€é€šçŸ¥æœ‰é€Ÿåº¦é™åˆ¶ï¼Œæ‰€ä»¥ä½ å¯ä»¥å¤§èƒ†åœ°æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€è¦å‘é€å°½å¯èƒ½å¤šçš„é€šçŸ¥ã€‚ioså’Œè‹¹æœæ¨é€æœåŠ¡ä¼šæ§åˆ¶æ¨é€é€šçŸ¥å¤šä¹…è¢«é€’é€ï¼Œå‘é€å¾ˆå¤šæ¨é€é€šçŸ¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚å¦‚æœä½ çš„æ¨é€é€šçŸ¥è¾¾åˆ°äº†é™åˆ¶ï¼Œæ¨é€é€šçŸ¥å¯èƒ½ä¼šè¢«å»¶è¿Ÿï¼ŒçŸ¥é“è®¾å¤‡ä¸‹æ¬¡å‘é€ä¿æŒæ´»åŠ¨çŠ¶æ€çš„æ•°æ®åŒ…ï¼Œæˆ–è€…å—åˆ°å¦å¤–ä¸€ä¸ªé€šçŸ¥ã€‚</p>

<h2>å‘é€è¿œç¨‹é€šçŸ¥</h2>

<p>è¦å‘é€ä¸€æ¡è¿œç¨‹é€šçŸ¥ï¼Œéœ€è¦åœ¨æ¨é€é€šçŸ¥çš„æœ‰æ•ˆè´Ÿè½½è®¾ç½®contentï¼available æ ‡å¿—ã€‚contentï¼available æ ‡å¿—å’Œç”¨æ¥é€šçŸ¥æŠ¥åˆŠåº”ç”¨çš„é”®å€¼æ˜¯ä¸€æ ·çš„ã€‚å› æ­¤ï¼Œå¤§å¤šæ•°æ¨é€è„šæœ¬å’Œåº“éƒ½å·²ç»æ”¯æŒè¿œç¨‹é€šçŸ¥ã€‚å½“ä½ å‘é€ä¸€æ¡è¿œç¨‹é€šçŸ¥æ—¶ï¼Œä½ å¯èƒ½è¿˜æƒ³è¦åŒ…å«ä¸€äº›é€šçŸ¥æœ‰æ•ˆè´Ÿè½½ä¸­çš„æ•°æ®ï¼Œè®©ä½ åº”ç”¨ç¨‹åºå¯ä»¥å¼•ç”¨äº‹ä»¶ã€‚è¿™å¯ä»¥ä¸ºä½ èŠ‚çœä¸€äº›ç½‘ç»œè¯·æ±‚ï¼Œå¹¶æé«˜åº”ç”¨ç¨‹åºçš„å“åº”åº¦ã€‚</p>

<p>æˆ‘å»ºè®®åœ¨å¼€å‘çš„æ—¶å€™ï¼Œä½¿ç”¨<a href="http://nomad-cli.com/#houston">Nomand CLI&rsquo;s Houston</a>å·¥å…·å‘é€æ¨é€æ¶ˆæ¯ï¼Œå½“ç„¶ä½ å¯ä»¥ä½¿ç”¨ä½ å–œæ¬¢çš„åº“æˆ–è€…è„šæœ¬ã€‚</p>

<p>ä½ å¯ä»¥é€šè¿‡nomad-cli ruby gemæ¥å®‰è£…Houston</p>

<pre><code>gem install nomad-cli
</code></pre>

<p>ç„¶åé€šè¿‡åŒ…å«åœ¨Nomançš„apnå®ç”¨å·¥å…·å‘é€ä¸€æ¡é€šçŸ¥:</p>

<pre><code># Send a Push Notification to your Device
apn push &lt;device token&gt; -c /path/to/key-cert.pem -n -d content-id=42
</code></pre>

<p>åœ¨è¿™é‡Œï¼Œ-næ ‡å¿—æŒ‡å®šåº”è¯¥åŒ…å«content-available å¥å€¼,-dæ ‡å¿—å…è®¸æ·»åŠ æˆ‘ä»¬è‡ªå®šä¹‰çš„æ•°æ®é”®å€¼åˆ°æœ‰æ•ˆè´Ÿè·.
é€šçŸ¥çš„æœ‰æ•ˆè´Ÿè·(payload)ç»“æœå’Œä¸‹é¢ç±»ä¼¼:</p>

<pre><code>{
    "aps" : {
        "content-available" : 1
    },
    "content-id" : 42
}
</code></pre>

<p>ios7ä¸­æ·»åŠ äº†æ–°çš„åº”ç”¨ç¨‹åºå§”æ‰˜æ–¹æ³•ï¼Œå½“æ¥æ”¶åˆ°ä¸€æ¡å¸¦æœ‰ contentï¼availableçš„æ¨é€é€šçŸ¥æ—¶ï¼Œä¸‹é¢çš„æ–¹æ³•ä¼šè¢«è°ƒç”¨:</p>

<pre><code>- (void)application:(UIApplication *)application 
  didReceiveRemoteNotification:(NSDictionary *)userInfo 
        fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler
{
    NSLog(@"Remote Notification userInfo is %@", userInfo);

    NSNumber *contentID = userInfo[@"content-id"];
    // æ ¹æ® content ID è¿›è¡Œæ“ä½œ
    completionHandler(UIBackgroundFetchResultNewData);
}
</code></pre>

<p>å’Œåå°æŠ“å–ä¸€æ ·ï¼Œåº”ç”¨ç¨‹åºè¿›å…¥åå°å¯åŠ¨ï¼Œä¹Ÿæœ‰30ç§’æ—¶é—´å»è·å–æ–°å†…å®¹å¹¶æ›´æ–°ç•Œé¢ï¼Œæœ€åè°ƒç”¨å®Œæˆçš„å¤„ç†ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥åƒåå°è·å–é‚£æ ·ï¼Œæ‰§è¡Œå¿«é€Ÿçš„ç½‘ç»œè¯·æ±‚ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–°çš„å¼ºå¤§çš„åå°ä¼ è¾“æœåŠ¡ï¼Œå¤„ç†ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸‹é¢çœ‹çœ‹æˆ‘ä»¬å¦‚ä½•åœ¨ä»»åŠ¡å®Œæˆåæ›´æ–°ç•Œé¢ã€‚</p>

<h2>NSurlSessionå’Œåå°ä¼ è¾“æœåŠ¡(Background Transfer Service)</h2>

<p>NSURLSessionæ˜¯ios7æ·»åŠ çš„ä¸€ä¸ªæ–°ç±»ï¼Œå®ƒä¹Ÿæ˜¯Foundation Networkingä¸­çš„æ–°æŠ€æœ¯ã€‚ä½œä¸ºNSURLConnectionçš„æ›¿ä»£å“ï¼Œä¸€äº›ç†Ÿæ‚‰çš„æ¦‚å¿µå’Œç±»éƒ½ä¿ç•™ä¸‹æ¥äº†ï¼Œä¾‹å¦‚NSURL,NSURLRequest,NSURLResponse.æ‰€ä»¥ï¼Œä½ å¯ä»¥ä½¿ç”¨NSURLSessionTaskè¿™ä¸€NSURLConnnectionçš„æ›¿ä»£å“ï¼Œæ¥å¤„ç†ç½‘ç»œè¯·æ±‚åŠå“åº”ã€‚ä¸€å…±æœ‰3ç§å›è¯ä»»åŠ¡ï¼šæ•°æ®ï¼Œä¸‹è½½å’Œä¸Šä¼ ã€‚æ¯ä¸€ç§éƒ½å‘NSURLSessionTaskæ·»åŠ äº†è¯­æ³•ç³–ï¼Œæ ¹æ®ä½ çš„éœ€è¦ï¼Œé€‚å½“é€‰æ‹©ä¸€ç§ã€‚</p>

<p>ä¸€ä¸ªNSURLSessionå¯¹è±¡åè°ƒä¸€ä¸ªæˆ–å¤šä¸ªNSURLSessionTaskå¯¹è±¡ï¼Œå¹¶æ ¹æ®NSURLSessionTaskåˆ›å»ºçš„NSURLSessionConfigurationå®ç°ä¸åŒçš„åŠŸèƒ½ã€‚ä½¿ç”¨ç›¸åŒçš„é…ç½®ï¼Œä½ ä¹Ÿå¯ä»¥åˆ›å»ºå¤šç»„å…·æœ‰ç›¸å…³ä»»åŠ¡çš„NSURLSessionTaskå¯¹è±¡ã€‚è¦åˆ©ç”¨åå°ä¼ è¾“æœåŠ¡ï¼Œä½ å°†ä¼šä½¿ç”¨<code>[NSURLSessionConfiguration backgroundSessionConfiguration]</code>æ¥åˆ›å»ºä¸€ä¸ªä¼šè¯é…ç½®ã€‚æ·»åŠ åˆ°åå°ä¼šè¯çš„ä»»åŠ¡åœ¨å¤–éƒ¨è¿›ç¨‹è¿è¡Œï¼Œå³ä½¿åº”ç”¨ç¨‹åºè¢«æŒ‚èµ·ï¼Œå´©æºƒï¼Œæˆ–è€…è¢«æ€æ­»ï¼Œå®ƒä¾ç„¶ä¼šè¿è¡Œã€‚</p>

<p>NSURLSessionConfigurationå…è®¸ä½ è®¾ç½®é»˜è®¤çš„HTTPå¤´ï¼Œé…ç½®ç¼“å­˜ç­–ç•¥ï¼Œé™åˆ¶ä½¿ç”¨èœ‚çªç…¤æ•°æ®ç­‰ç­‰ã€‚å…¶ä¸­ä¸€ä¸ªé€‰é¡¹æ˜¯discretionaryæ ‡å¿—ï¼Œè¿™ä¸ªæ ‡å¿—å…è®¸ç³»ç»Ÿä¸ºåˆ†é…ä»»åŠ¡è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚è¿™æ„å‘³ç€åªæœ‰å½“è®¾å¤‡è¶³å¤Ÿç”µé‡æ—¶ï¼Œè®¾å¤‡æ‰é€šè¿‡wifiè¿›è¡Œæ•°æ®ä¼ è¾“ã€‚å¦‚æœç”µé‡ä½ï¼Œæˆ–è€…åªä»…æœ‰ä¸€ä¸ªèœ‚çªè¿æ¥ï¼Œä¼ è¾“ä»»åŠ¡æ˜¯ä¸ä¼šè¿è¡Œçš„ã€‚åå°ä¼ è¾“æ€»æ˜¯åœ¨discretionaryæ¨¡å¼ä¸‹è¿è¡Œã€‚</p>

<p>ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¤§æ¦‚äº†è§£äº†NSURLSessionï¼Œä»¥åŠä¸€ä¸ªåå°å›è¯å¦‚ä½•è¿›è¡Œï¼Œæ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å›åˆ°è¿œç¨‹é€šçŸ¥çš„ä¾‹å­ï¼Œæ·»åŠ ä¸€äº›ä»£ç æ¥å¤„ç†åå°ä¼ å…¥æœåŠ¡çš„ä¸‹è½½é˜Ÿåˆ—ã€‚å½“ä¸‹è½½å®Œæˆåï¼Œæˆ‘ä»¬ä¼šé€šçŸ¥ç”¨æˆ·è¯¥æ–‡ä»¶å·²ç»å¯ä»¥ç”¨äº†ã€‚</p>

<h2>NSURLSessionDownloadTask</h2>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆå¤„ç†ä¸€æ¡è¿œç¨‹é€šçŸ¥ï¼Œå¹¶æŠŠä¸€ä¸ªNSURLSessionDownloadTaskæ·»åŠ åˆ°åå°ä¼ è¾“æœåŠ¡çš„é˜Ÿåˆ—ã€‚åœ¨backgroundURLSessionæ–¹æ³•å¼ ï¼Œæˆ‘ä»¬æ ¹æ®åå°å›è¯é…ç½®ï¼Œåˆ›å»ºä¸€ä¸ªNSURLSessionå¯¹è±¡ï¼Œå¹¶æŠŠapplication delegateä½œä¸ºå›è¯çš„å§”æ‰˜å¯¹è±¡ã€‚æ–‡æ¡£ä¸å»ºè®®å¯¹äºç›¸åŒçš„æ ‡è¯†ç¬¦(identifier)åˆ›å»ºå¤šä¸ªå›è¯å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨dispatch_onceæ¥é¿å…æ½œåœ¨çš„é—®é¢˜ï¼š</p>

<pre><code>- (NSURLSession *)backgroundURLSession
{
    static NSURLSession *session = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        NSString *identifier = @"io.objc.backgroundTransferExample";
        NSURLSessionConfiguration* sessionConfig = [NSURLSessionConfiguration backgroundSessionConfiguration:identifier];
        session = [NSURLSession sessionWithConfiguration:sessionConfig 
                                                delegate:self 
                                           delegateQueue:[NSOperationQueue mainQueue]];
    });

    return session;
}

- (void)           application:(UIApplication *)application 
  didReceiveRemoteNotification:(NSDictionary *)userInfo 
        fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler
{
    NSLog(@"Received remote notification with userInfo %@", userInfo);

    NSNumber *contentID = userInfo[@"content-id"];
    NSString *downloadURLString = [NSString stringWithFormat:@"http://yourserver.com/downloads/%d.mp3", [contentID intValue]];
    NSURL* downloadURL = [NSURL URLWithString:downloadURLString];

    NSURLRequest *request = [NSURLRequest requestWithURL:downloadURL];
    NSURLSessionDownloadTask *task = [[self backgroundURLSession] downloadTaskWithRequest:request];
    task.taskDescription = [NSString stringWithFormat:@"Podcast Episode %d", [contentID intValue]];
    [task resume];

    completionHandler(UIBackgroundFetchResultNewData);
}
</code></pre>

<p>æˆ‘ä»¬ä½¿ç”¨NSURLSessionç±»æ–¹æ³•åˆ›å»ºçˆ±ä½ ä¸€ä¸ªä¸‹è½½ä»»åŠ¡ï¼Œé…ç½®è¯·æ±‚ï¼Œå¹¶æä¾›è¯´æ˜ä¾›ä»¥åä½¿ç”¨ã€‚å› ä¸ºæ‰€æœ‰å›è¯ä»»åŠ¡ä¸€å¼€å§‹å¤„äºæŒ‚èµ·çŠ¶æ€ï¼Œä½ å¿…é¡»è°¨è®°è¦è°ƒç”¨[task resume]ä¿è¯å¼€å§‹äº†ä»»åŠ¡ã€‚</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å®ç° NSURLSessionDownloadDelegate çš„å§”æ‰˜æ–¹æ³•ï¼Œå½“ä¸‹è½½å®Œæˆæ—¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°ã€‚å¦‚æœä½ éœ€è¦å¤„ç†è®¤è¯æˆ–ä¼šè¯ç”Ÿå‘½å‘¨æœŸçš„å…¶ä»–äº‹ä»¶ï¼Œä½ å¯èƒ½è¿˜éœ€è¦å®ç°NSURLSessionDelegateæˆ–NSURLSessionTaskDelegateçš„æ–¹æ³•ï¼Œä½ åº”è¯¥é˜…è¯»Appleçš„<a href="https://developer.apple.com/library/ios/documentation/cocoa/Conceptual/URLLoadingSystem/NSURLSessionConcepts/NSURLSessionConcepts.html#//apple_ref/doc/uid/10000165i-CH2-SW42">Life Cycle of a URL Session with Custom Delegates</a>æ–‡æ¡£ï¼Œå®ƒè®²è§£äº†æ‰€æœ‰ç±»å‹å›è¯ä»»åŠ¡çš„å®Œæˆç”Ÿå‘½å‘¨æœŸã€‚</p>

<p>NSURLSessionDownloadDelegateä¸­çš„å§”æ‰˜æ–¹æ³•å…¨éƒ¨æ˜¯å¿…é¡»å®ç°çš„ï¼Œå°½ç®¡åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬åªéœ€è¦ç”¨åˆ° [NSURLSession downloadTask:didFinishDownloadingToURL:]ã€‚ä»»åŠ¡å®Œæˆä¸‹è½½æ—¶ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªç£ç›˜ä¸Šè¯¥æ–‡ä»¶çš„ä¸´æ—¶URL.ä½ å¿…é¡»æŠŠè¿™ä¸ªæ–‡ä»¶ç§»åŠ¨æˆ–å¤åˆ¶ä½ çš„åº”ç”¨ç¨‹åºç©ºé—´ï¼Œå› ä¸ºå½“ä½ ä»è¿™ä¸ªå§”æ‰˜æ–¹æ³•è¿”å›æ—¶ï¼Œè¯¥æ–‡ä»¶å°†ä»ä¸´æ—¶å­˜å‚¨ä¸­åˆ é™¤ã€‚</p>

<pre><code>#Pragma Mark - NSURLSessionDownloadDelegate

- (void)         URLSession:(NSURLSession *)session 
               downloadTask:(NSURLSessionDownloadTask *)downloadTask
  didFinishDownloadingToURL:(NSURL *)location
{
    NSLog(@"downloadTask:%@ didFinishDownloadingToURL:%@", downloadTask.taskDescription, location);

    // ç”¨ NSFileManager å°†æ–‡ä»¶å¤åˆ¶åˆ°åº”ç”¨çš„å­˜å‚¨ä¸­
    // ...

    // é€šçŸ¥ UI åˆ·æ–°
}

- (void)  URLSession:(NSURLSession *)session 
        downloadTask:(NSURLSessionDownloadTask *)downloadTask 
   didResumeAtOffset:(int64_t)fileOffset 
  expectedTotalBytes:(int64_t)expectedTotalBytes
{
}

- (void)         URLSession:(NSURLSession *)session 
               downloadTask:(NSURLSessionDownloadTask *)downloadTask 
               didWriteData:(int64_t)bytesWritten totalBytesWritten:(int64_t)totalBytesWritten 
  totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite
{
}
</code></pre>

<p>å½“åå°ä¼šè¯ä»»åŠ¡å®Œæˆæ—¶ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºä»ç„¶åœ¨å‰å°è¿è¡Œï¼Œä¸Šé¢çš„ä»£ç å·²ç»è¶³å¤Ÿäº†ã€‚ç„¶è€Œï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ çš„åº”ç”¨ç¨‹åºå¯èƒ½æ˜¯æ²¡æœ‰è¿è¡Œçš„ï¼Œæˆ–è€…åœ¨åå°è¢«æŒ‚èµ·ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½ å¿…é¡»å®ç°åº”ç”¨ç¨‹åºå§”æ‰˜çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™æ ·ç³»ç»Ÿå°±å¯ä»¥å”¤é†’ä½ çš„åº”ç”¨ç¨‹åºã€‚ä¸åŒäºä»¥å¾€çš„å§”æ‰˜å›è°ƒï¼Œè¯¥åº”ç”¨ç¨‹åºå§”æ‰˜ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œå› ä¸ºæ‚¨çš„ä¼šè¯å’Œä»»åŠ¡å§”æ‰˜å¯èƒ½ä¼šå—åˆ°ä¸€ç³»åˆ—æ¶ˆæ¯ã€‚App delegateçš„: handleEventsForBackgroundURLSessionï¼šæ–¹æ³•ä¼šåœ¨è¿™äº›NSURLSessionå§”æ‰˜çš„æ¶ˆæ¯å‘é€å‰è¢«è°ƒç”¨ï¼Œç„¶åURLSessionDidFinishEventsForBackgroundURLSessionåœ¨éšåè¢«è°ƒç”¨ã€‚åœ¨å‰é¢çš„æ–¹æ³•ä¸­ï¼ŒåŒ…å«äº†ä¸€ä¸ªåå°å®Œæˆçš„å›è°ƒï¼ˆcompletionHandlerï¼‰,å¹¶åœ¨åé¢çš„æ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒä»¥ä¾¿æ›´æ–°ç•Œé¢:</p>

<pre><code>- (void)                  application:(UIApplication *)application 
  handleEventsForBackgroundURLSession:(NSString *)identifier completionHandler:(void (^)())completionHandler
{
    // ä½ å¿…é¡»é‡æ–°å»ºç«‹ä¸€ä¸ªåå° seesiong çš„å‚ç…§
    // å¦åˆ™ NSURLSessionDownloadDelegate å’Œ NSURLSessionDelegate æ–¹æ³•ä¼šå› ä¸º
    // æ²¡æœ‰ å¯¹ session çš„ delegate è®¾å®šè€Œä¸ä¼šè¢«è°ƒç”¨ã€‚å‚è§ä¸Šé¢çš„ backgroundURLSession
    NSURLSession *backgroundSession = [self backgroundURLSession];

    NSLog(@"Rejoining session with identifier %@ %@", identifier, backgroundSession);

    // ä¿å­˜ completion handler ä»¥åœ¨å¤„ç† session äº‹ä»¶åæ›´æ–° UI
    [self addCompletionHandler:completionHandler forSession:identifier];
}

- (void)URLSessionDidFinishEventsForBackgroundURLSession:(NSURLSession *)session
{
    NSLog(@"Background URL session %@ finished events.\n", session);

    if (session.configuration.identifier) {
        // è°ƒç”¨åœ¨ -application:handleEventsForBackgroundURLSession: ä¸­ä¿å­˜çš„ handler
        [self callCompletionHandlerForSession:session.configuration.identifier];
    }
}

- (void)addCompletionHandler:(CompletionHandlerType)handler forSession:(NSString *)identifier
{
    if ([self.completionHandlerDictionary objectForKey:identifier]) {
        NSLog(@"Error: Got multiple handlers for a single session identifier.  This should not happen.\n");
    }

    [self.completionHandlerDictionary setObject:handler forKey:identifier];
}

- (void)callCompletionHandlerForSession: (NSString *)identifier
{
    CompletionHandlerType handler = [self.completionHandlerDictionary objectForKey: identifier];

    if (handler) {
        [self.completionHandlerDictionary removeObjectForKey: identifier];
        NSLog(@"Calling completion handler for session %@", identifier);

        handler();
    }
}
</code></pre>

<p>å¦‚æœå½“åå°ä¼ è¾“å®Œæˆæ—¶ï¼Œåº”ç”¨ç¨‹åºä¸å†åœç•™åœ¨å‰å°ï¼Œé‚£ä¹ˆå¯¹äºæ›´æ–°ç¨‹åºç•Œé¢æ¥è¯´ï¼Œè¿™ä¸ªä¸¤æ­¥å¤„ç†è¿‡ç¨‹æ˜¯å¿…è¦çš„ã€‚æ­¤å¤–ï¼Œå¦‚æœå½“åå°ä¼ è¾“å®Œæˆæ—¶ï¼Œåº”ç”¨é™ˆè°·æ ¹æœ¬æ²¡æœ‰åœ¨è¿è¡Œï¼Œioså°†ä¼šåœ¨åå°å¯åŠ¨è¯¥åº”ç”¨ç¨‹åºï¼Œç„¶åå‰é¢çš„åº”ç”¨ç¨‹åºå’Œä¼šè¯çš„å§”æ‰˜æ–¹æ³•ä¼šåœ¨application:didFinishLaunchingWithOptions: æ–¹æ³•è¢«è°ƒç”¨ä¹‹åè¢«è°ƒç”¨.</p>

<h2>é…ç½®å’Œé™åˆ¶</h2>

<p>æˆ‘ä»¬ç®€å•åœ°ä½“éªŒäº†åå°ä¼ è¾“çš„å¼ºå¤§ä¹‹å¤„ï¼Œä½†ä½ åº”è¯¥æ·±å…¥æ–‡æ¡£ï¼Œé˜…è¯»NSURLSessionConfigurationéƒ¨åˆ†ï¼Œä»¥ä¾¿æœ€å¥½æ»´æ»¡è¶³ä½ çš„ä½¿ç”¨åœºæ™¯ã€‚ä¾‹å¦‚:NSURLSessionTasksé€šè¿‡NSURLSessionConfigurationçš„timeoutIntervalForResourceå±æ€§ï¼Œæ”¯æŒèµ„æºè¶…æ—¶ç‰¹æ€§ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§æŒ‡å®šä½ å…è®¸å®Œæˆä¸€ä¸ªä¼ è¾“æ‰€éœ€çš„æœ€é•¿æ—¶é—´ã€‚å†…å®¹åªåœ¨æœ‰é™çš„æ—¶é—´å¯ç”¨ï¼Œæˆ–è€…åœ¨ç”¨æˆ·åªæœ‰æœ‰é™wifiå®½å¸¦çš„æ—¶é—´å†…æ— æ³•ä¸‹è½½æˆ–ä¸Šä¼ èµ„æºçš„æƒ…å†µä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ã€‚</p>

<p>é™¤äº†ä¸‹è½½ä»»åŠ¡ï¼ŒNSURLSessionä¹Ÿå…¨é¢æ”¯æŒä¸Šä¼ ä»»åŠ¡ï¼Œå› æ­¤ï¼Œä½ å¯èƒ½ä¼šåœ¨åå°å°†è§†é¢‘ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œè¿™ä¿è¯ç”¨æˆ·ä¸éœ€è¦å†åƒios6é‚£æ ·ä¿æŒåº”ç”¨ç¨‹åºå‰å°è¿è¡Œã€‚å¦‚æœå½“ä¼ è¾“å®Œæˆæ—¶ä½ çš„åº”ç”¨ç¨‹åºä¸éœ€è¦å†åå°è¿è¡Œï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„åšæ³•æ˜¯,æŠŠNSURLSessionConfigurationçš„sessionSendsLaunchEventså±æ€§è®¾ç½®ä¸ºNOã€‚é«˜æ•ˆåˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œæ˜¯ä¸€ä»¶è®©Ioså’Œç”¨æˆ·éƒ½é«˜å…´çš„äº‹ã€‚</p>

<p>æœ€åï¼Œæˆ‘ä»¬æ¥è¯´ä¸€è¯´ä½¿ç”¨åå°ä¼šè¯çš„å‡ ä¸ªé™åˆ¶ã€‚ä½œä¸ºä¸€ä¸ªå¿…é¡»å®ç°çš„å§”æ‰˜ï¼Œæ‚¨ä¸èƒ½å¯¹NSURLSessionçš„ä½¿ç”¨ç®€å•çš„åŸºäºblockçš„å›è°ƒæ–¹æ³•ã€‚åå°å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œæ˜¯ç›¸å¯¹è€—è´¹è¾ƒå¤šèµ„æºçš„ï¼Œæ‰€ä»¥æ€»æ˜¯é‡‡ç”¨Httpé‡å®šå‘ã€‚åå°ä¼ è¾“æœåŠ¡åªæ”¯æŒHTTPå’ŒHTTPSï¼Œä½ ä¸èƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„åè®®ã€‚ç³»ç»Ÿä¼šæ ¹æ®å¯ç”¨çš„èµ„æºè¿›è¡Œä¼˜åŒ–ï¼Œåœ¨ä»»ä½•æ—¶å€™ä½ éƒ½ä¸èƒ½å¼ºåˆ¶ä¼ è¾“ä»»åŠ¡åœ¨åå°è¿›è¡Œã€‚</p>

<p>å¦å¤–ï¼Œè¦æ³¨æ„çš„æ˜¯åœ¨åå°å›è¯ä¸­ï¼ŒNSURLSessionDataTasksæ˜¯å®Œå…¨ä¸æ”¯æŒçš„ï¼Œä½ åº”è¯¥åªå¤„äºçŸ­æœŸçš„ï¼Œå°è¯·æ±‚ä¸ºç›®çš„çš„ä½¿ç”¨è¿™äº›ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç”¨æ¥ä¸‹è½½æˆ–ä¸Šä¼ ã€‚</p>

<h2>æ€»ç»“</h2>

<p>åœ¨ios7ä¸­å¼ºå¤§çš„å¤šä»»åŠ¡å’Œç½‘ç»œAPIä¸ºç°æœ‰åº”ç”¨å’Œæ–°åº”ç”¨å¼€å¯äº†ä¸€ç³»åˆ—å…¨æ–°çš„å¯èƒ½æ€§ã€‚å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå¯ä»¥ä»è¿›ç¨‹å¤–çš„ç½‘ç»œä¼ è¾“å’Œæ•°æ®ä¸­è·ç›Šï¼Œé‚£ä¹ˆå°½æƒ…åœ°ä½¿ç”¨è¿™äº›ç¾å¦™çš„APIï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥å°±åƒä½ çš„åº”ç”¨æ­£åœ¨å‰å°è¿è¡Œé‚£æ ·å»å®ç°åå°ä¼ è¾“ï¼Œå¹¶è¿›è¡Œé€‚å½“çš„ç•Œé¢æ›´æ–°ï¼Œè€Œè¿™é‡Œç»å¤§å¤šæ•°çš„å·¥ä½œéƒ½å·²ç»ä¸ºä½ å®Œæˆäº†ã€‚</p>

<ul>
<li>ä½¿ç”¨é€‚å½“çš„æ–°çš„APIæ¥ä¸ºä½ çš„åº”ç”¨ç¨‹åºæä¾›å†…å®¹</li>
<li>å°½å¯èƒ½æ—©åœ°è°ƒç”¨completion handlerä»¥æé«˜æ•ˆç‡</li>
<li>è®©completion handerä¸ºåº”ç”¨ç¨‹åºæ›´æ–°ç•Œé¢å¿«ç…§</li>
</ul>

]]></content>
  </entry>
  
</feed>
