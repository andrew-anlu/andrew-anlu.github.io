<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Ios | å®‰è·¯çš„æŠ€æœ¯åšå®¢]]></title>
  <link href="http://andrew-anlu.github.io/blog/categories/ios/atom.xml" rel="self"/>
  <link href="http://andrew-anlu.github.io/"/>
  <updated>2016-04-19T21:53:36+08:00</updated>
  <id>http://andrew-anlu.github.io/</id>
  <author>
    <name><![CDATA[å®‰è·¯]]></name>
    <email><![CDATA[andrewswift1987@gamil.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[æ·±å…¥ç†è§£RunLoop]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/29/shen-ru-li-jie-runloop/"/>
    <updated>2016-03-29T17:29:43+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/29/shen-ru-li-jie-runloop</id>
    <content type="html"><![CDATA[<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/1432799466416554.jpeg" alt="runloop" /></p>

<p>RunLoopæ˜¯ioså’ŒOSXå¼€å‘ä¸­éå¸¸åŸºç¡€çš„ä¸€ä¸ªæ¦‚å¿µï¼Œæœ¬ç« å°†ä¼šä»‹ç»ä¸€ä¸‹åœ¨iosä¸­ï¼Œè‹¹æœæ˜¯åˆ©ç”¨RunLoopå®ç°è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå»¶è¿Ÿå›è°ƒï¼Œè§¦æ‘¸äº‹ä»¶ï¼Œå±å¹•åˆ·æ–°ç­‰.</p>

<h2>RunLoopçš„æ¦‚å¿µ</h2>

<p>ä¸€èˆ¬æ¥è®²ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆä¹‹åçº¿ç¨‹å°±ä¼šé€€å‡ºã€‚å¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœºåˆ¶ï¼Œè®©çº¿ç¨‹èƒ½éšæ—¶å¤„ç†äº‹ä»¶ä½†å¹¶ä¸é€€å‡ºï¼Œé€šå¸¸çš„ä»£ç é€»è¾‘æ˜¯è¿™æ ·çš„:</p>

<pre><code>function loop() {
    initialize();
    do {
        var message = get_next_message();
        process_message(message);
    } while (message != quit);
}
</code></pre>

<!--more-->


<p> è¿™ç§æ¨¡å‹é€šå¸¸è¢«ç§°ä¸º <code>Event Loop</code>,Event Loopåœ¨å¾ˆå¤šç³»ç»Ÿå’Œæ¡†æ¶ä¸­éƒ½æœ‰å®ç°ï¼Œæ¯”å¦‚ Node.jsçš„äº‹ä»¶å¤„ç†ï¼Œæ¯”å¦‚windowç¨‹åºçš„æ¶ˆæ¯å¾ªç¯ï¼Œå†æ¯”å¦‚OS X/IOSé‡Œçš„RunLoop.å®ç°è¿™ç§æ¨¡å‹çš„å…³é”®ç‚¹åœ¨äº:å¦‚ä½•ç®¡ç†äº‹ä»¶/æ¶ˆæ¯,å¦‚ä½•è®©çº¿ç¨‹åœ¨æ²¡æœ‰å¤„ç†æ¶ˆæ¯æ—¶ä¼‘çœ ä»¥é¿å…èµ„æºå ç”¨ï¼Œåœ¨æœ‰æ¶ˆæ¯åˆ°æ¥æ—¶è¢«å”¤é†’ã€‚</p>

<p> æ‰€ä»¥ï¼ŒRunLoopå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç®¡ç†äº†å…¶éœ€è¦å¤„ç†çš„äº‹ä»¶å’Œæ¶ˆæ¯ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªå…¥å£å‡½æ•°æ¥æ‰§è¡Œä¸Šé¢çš„EventLoopé€»è¾‘ã€‚çº¿ç¨‹æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°åï¼Œå°±ä¼šä¸€ç›´å¤„ç†è¿™ä¸ªå‡½æ•°å†…éƒ¨"æ¥å—æ¶ˆæ¯->ç­‰å¾…->å¤„ç†"çš„å¾ªç¯ä¸­ï¼ŒçŸ¥é“è¿™ä¸ªå¾ªç¯ç»“æŸ(æ¯”å¦‚ä¼ å…¥quitçš„æ¶ˆæ¯)ï¼Œå‡½æ•°è¿”å›.</p>

<p> åœ¨OSX/IOSç³»ç»Ÿä¸­ï¼Œæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡:NSRunLoopå’ŒCFRunLoopref.</p>

<p> CFRunLoopRefæ˜¯åœ¨CoreFoundationæ¡†æ¶å†…ï¼Œå®ƒæä¾›äº†çº¯Cå‡½æ•°çš„API,æ‰€æœ‰è¿™äº›APIéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>

<p> NSRunLoopæ˜¯åŸºäºCFRunLoopRefçš„å°è£…ï¼Œæä¾›äº†é¢å‘å¯¹è±¡çš„API,ä½†æ˜¯è¿™äº›APIä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>

<h2>RunLoopä¸çº¿ç¨‹çš„å…³ç³»</h2>

<p>é¦–å…ˆï¼ŒiOSå¼€å‘ä¸­èƒ½é‡åˆ°ä¸¤ä¸ªçº¿ç¨‹å¯¹è±¡:pthread_t å’Œ NSThread.è¿‡å»è‹¹æœæœ‰ä»½æ–‡æ¡£è¡¨æ˜äº†NSThreadåªæ˜¯pthread_t çš„å°è£…ï¼Œä½†é‚£ä»½æ–‡æ¡£å·²ç»å¤±æ•ˆäº†ï¼Œç°åœ¨å®ƒä»¬ä¹Ÿæœ‰è‚¯å®šéƒ½æ˜¯ç›´æ¥åŒ…è£…è‡ªæœ€åº•å±‚çš„mach threadã€‚</p>

<p>ä½ å¯ä»¥é€šè¿‡pthread_main_np() æˆ– [NSThread mainThread] æ¥è·å–ä¸»çº¿ç¨‹,ä¹Ÿå¯ä»¥é€šè¿‡pthread_self()æˆ–è€…[NSThread currentThread]æ¥è·å–å½“å‰çº¿ç¨‹ã€‚CFRunLoopæ˜¯åŸºäºpthreadæ¥ç®¡ç†çš„ã€‚</p>

<p>è‹¹æœä¸å…è®¸ç›´æ¥åˆ›å»ºRunLoop,å®ƒåªæä¾›äº†ä¸¤ä¸ªè‡ªåŠ¨è·å–çš„å‡½æ•°:CFRunLoopGetMain()å’ŒCFRUnLoopGetCurrent().è¿™ä¸¤ä¸ªå‡½æ•°å†…éƒ¨çš„é€»è¾‘å¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ ·:</p>

<pre><code>/// å…¨å±€çš„Dictionaryï¼Œkey æ˜¯ pthread_tï¼Œ value æ˜¯ CFRunLoopRef
static CFMutableDictionaryRef loopsDic;
/// è®¿é—® loopsDic æ—¶çš„é”
static CFSpinLock_t loopsLock;

/// è·å–ä¸€ä¸ª pthread å¯¹åº”çš„ RunLoopã€‚
CFRunLoopRef _CFRunLoopGet(pthread_t thread) {
    OSSpinLockLock(&amp;loopsLock);

    if (!loopsDic) {
        // ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶ï¼Œåˆå§‹åŒ–å…¨å±€Dicï¼Œå¹¶å…ˆä¸ºä¸»çº¿ç¨‹åˆ›å»ºä¸€ä¸ª RunLoopã€‚
        loopsDic = CFDictionaryCreateMutable();
        CFRunLoopRef mainLoop = _CFRunLoopCreate();
        CFDictionarySetValue(loopsDic, pthread_main_thread_np(), mainLoop);
    }

    /// ç›´æ¥ä» Dictionary é‡Œè·å–ã€‚
    CFRunLoopRef loop = CFDictionaryGetValue(loopsDic, thread));

    if (!loop) {
        /// å–ä¸åˆ°æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª
        loop = _CFRunLoopCreate();
        CFDictionarySetValue(loopsDic, thread, loop);
        /// æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“çº¿ç¨‹é”€æ¯æ—¶ï¼Œé¡ºä¾¿ä¹Ÿé”€æ¯å…¶å¯¹åº”çš„ RunLoopã€‚
        _CFSetTSD(..., thread, loop, __CFFinalizeRunLoop);
    }

    OSSpinLockUnLock(&amp;loopsLock);
    return loop;
}

CFRunLoopRef CFRunLoopGetMain() {
    return _CFRunLoopGet(pthread_main_thread_np());
}

CFRunLoopRef CFRunLoopGetCurrent() {
    return _CFRunLoopGet(pthread_self());
}
</code></pre>

<p>ä»ä¸Šé¢çš„ä»£ç æ¥çœ‹ï¼Œçº¿ç¨‹å’ŒRunLoopä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„Dictionaryé‡Œï¼Œçº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰RunLoop,å¦‚æœä½ ä¸ä¸»åŠ¨è·å–ï¼Œé‚£å®ƒä¸€ç›´ä¸ä¼šæœ‰ã€‚RunLoopçš„åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶ï¼ŒRunLoopçš„é”€æ¯æ—¶å‘ç”Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶ï¼Œä½ åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨è·å–å…¶RunLoop(ä¸»çº¿ç¨‹é™¤å¤–)</p>

<h2>RunLoopå¯¹å¤–çš„æ¥å£</h2>

<ul>
<li>CFRunLoopRef</li>
<li>CFRunLoopModelRef</li>
<li>CFRunLoopSourceRef</li>
<li>CFRunLoopTimerRef</li>
<li>CFRunLoopObserverRef</li>
</ul>


<p>å…¶ä¸­ï¼ŒCFRunLoopModelRefç±»å¹¶æ²¡æœ‰å¯¹å¤–æš´éœ²ï¼Œåªæ˜¯é€šè¿‡CFRunLoopRefçš„æ¥å£è¿›è¡Œäº†å°è£…ï¼Œä»–ä»¬çš„å…³ç³»å¦‚ä¸‹:</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/1432798883604537.png" alt="runloop" /></p>

<p>ä¸€ä¸ªRunLoopåŒ…å«è‹¥å¹²ä¸ªModel,æ¯ä¸ªmodelåˆåŒ…å«è‹¥å¹²ä¸ªSource/Timer/Observerã€‚æ¯æ¬¡è°ƒç”¨RunLoopçš„ä¸»å‡½æ•°æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ªmodel,è¿™ä¸ªModelè¢«ç§°ä½œä¸ºCurrentMode.å¦‚æœéœ€è¦åˆ‡æ¢Mode,åªèƒ½é€€å‡ºLoop,å†é‡æ–°æŒ‡å®šä¸€ä¸ªModeè¿›å…¥ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„ Source/Timer/Observer,è®©å…¶äº’ä¸å½±å“.</p>

<p>CFRunLoopSourceREfæ˜¯äº‹ä»¶äº§ç”Ÿçš„åœ°æ–¹ã€‚Sourceæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼ŒSource0å’ŒSource1.</p>

<ul>
<li>Source0åªåŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå®ƒå¹¶ä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶ã€‚ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦å…ˆè°ƒç”¨CFRunLoopSourceSignal(source)ï¼Œå°†è¿™ä¸ªSourceæ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨CFRunLoopwakeUp(runloop)æ¥å”¤é†’RunLoop,è®©å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶</li>
<li>Source1åŒ…å«ä¹ä¸šä¸€ä¸ªmatch_portå’Œä¸€ä¸ªå›è°ƒ(å‡½æ•°æŒ‡é’ˆ),è¢«ç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶å®ƒçº¿ç¨‹ç›¸åå‘é€æ¶ˆæ¯ã€‚è¿™ç§Sourceèƒ½ä¸»åŠ¨å”¤é†’Runloopçš„çº¿ç¨‹</li>
</ul>


<p><em>CFRUnLoopTimerRef</em>æ˜¯åŸºäºæ—¶é—´çš„è§¦å‘å™¨ï¼Œå®ƒå’ŒNStimerå¯ä»¥æ··ç”¨ï¼Œå…¶åŒ…å«ä¸€ä¸ªæ—¶é—´é•¿åº¦å’Œä¸€ä¸ªå›è°ƒ(å‡½æ•°æŒ‡é’ˆ).å½“å…¶åŠ å…¥åˆ°RUnLoopæ—¶ï¼ŒRunLoopä¼šæ³¨å†Œå¯¹åº”çš„æ—¶é—´ç‚¹ï¼Œå½“æ—¶é—´ç‚¹åˆ°æ—¶ï¼ŒRunLoopä¼šè¢«å”¤é†’ä»¥æ‰§è¡Œé‚£ä¸ªå›è°ƒ.</p>

<p><em>CFRunLoopObserverRef</em>æ˜¯è§‚å¯Ÿè€…ï¼Œæ¯ä¸ªObserveréƒ½åŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼Œå½“Runloopçš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§‚å¯Ÿè€…å°±èƒ½é€šè¿‡å›è°ƒæ¥æ”¶åˆ°è¿™ä¸ªå˜åŒ–ã€‚å¯ä»¥è§‚æµ‹çš„æ—¶é—´ç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ª:</p>

<pre><code>typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {
    kCFRunLoopEntry         = (1UL &lt;&lt; 0), // å³å°†è¿›å…¥Loop
    kCFRunLoopBeforeTimers  = (1UL &lt;&lt; 1), // å³å°†å¤„ç† Timer
    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2), // å³å°†å¤„ç† Source
    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5), // å³å°†è¿›å…¥ä¼‘çœ 
    kCFRunLoopAfterWaiting  = (1UL &lt;&lt; 6), // åˆšä»ä¼‘çœ ä¸­å”¤é†’
    kCFRunLoopExit          = (1UL &lt;&lt; 7), // å³å°†é€€å‡ºLoop
};
</code></pre>

<p>ä¸Šé¢çš„ Source/Timers/Observer è¢«ç»Ÿç§°ä¸ºMode item,ä¸€ä¸ªItemå¯ä»¥è¢«åŒäº‹åŠ å…¥å¤šä¸ªMode,ä½†ä¸€ä¸ªItemè¢«é‡å¤åŠ å…¥åŒä¸€ä¸ªmodeæ—¶æ˜¯ä¸ä¼šæœ‰æ•ˆæœçš„ã€‚å¦‚æœä¸€ä¸ªModeä¸­ä¸€ä¸ªiteméƒ½æ²¡æœ‰ï¼Œåˆ™RunLoopä¼šç›´æ¥é€€å‡ºï¼Œä¸è¿›å…¥å¾ªç¯ã€‚</p>

<h2>Runloopçš„Mode</h2>

<p>CFRunLoopModeå’ŒCFRunLoopçš„ç»“æ„å¤§è‡´å¦‚ä¸‹:</p>

<pre><code>struct __CFRunLoopMode {
    CFStringRef _name;            // Mode Name, ä¾‹å¦‚ @"kCFRunLoopDefaultMode"
    CFMutableSetRef _sources0;    // Set
    CFMutableSetRef _sources1;    // Set
    CFMutableArrayRef _observers; // Array
    CFMutableArrayRef _timers;    // Array
    ...
};

struct __CFRunLoop {
    CFMutableSetRef _commonModes;     // Set
    CFMutableSetRef _commonModeItems; // Set
    CFRunLoopModeRef _currentMode;    // Current Runloop Mode
    CFMutableSetRef _modes;           // Set
    ...
};
</code></pre>

<p>è¿™é‡Œæœ‰ä¸ªæ¦‚å¿µå«<code>CommonModes</code>ï¼šä¸€ä¸ªModeå¯ä»¥å°†è‡ªå·±æ ‡è®°ä¸º<code>Common</code>å±æ€§ï¼ˆé€šè¿‡å°†å…¶ModeNameæ·»åŠ åˆ°RunLoopçš„ &ldquo;CommmonModes"ä¸­ï¼‰ã€‚æ¯å½“RunLoopçš„å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒRunLoopéƒ½ä¼šè‡ªåŠ¨å°†_CommonModeItemsé‡Œçš„ Source/Observer/TimeråŒæ­¥åˆ°å…·æœ‰'Common'æ ‡è®°çš„æ‰€æœ‰Modeé‡Œã€‚</p>

<p>åº”ç”¨åœºæ™¯:ä¸»çº¿ç¨‹çš„RunLoopé‡Œæœ‰ä¸¤ä¸ªé¢„ç½®çš„Mode:KCFRunLoopDefaultModeå’ŒUITrackingRunLoopModeã€‚è¿™ä¸¤ä¸ªModeéƒ½å·²ç»è¢«æ ‡è®°ä¸º"Common"å±æ€§ã€‚DefaultModeæ˜¯Appå¹³æ—¶æ‰€å¤„çš„çŠ¶æ€ï¼ŒTrackingRunLoopModeæ˜¯è¿½è¸ªScrollViewæ»‘åŠ¨æ—¶çš„çŠ¶æ€ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ªTimerå¹¶åŠ åˆ°DefaultModeæ—¶ï¼ŒTImerä¼šå¾—åˆ°é‡å¤å›è°ƒï¼Œä½†æ­¤æ—¶æ»‘åŠ¨ä¸€ä¸ªTableViewæ—¶ï¼ŒRunLoopä¼šå°†modeåˆ‡æ¢åˆ° TrackingRunLoopMode,è¿™æ—¶Timerå°±ä¸ä¼šè¢«å›è°ƒï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šå½±å“åˆ°æ»‘åŠ¨æ“ä½œ.</p>

<p>æœ‰æ—¶ä½ éœ€è¦ä¸€ä¸ªTimer,åœ¨ä¸¤ä¸ªModeä¸­éƒ½èƒ½å¾—åˆ°å›è°ƒï¼Œä¸€ç§åŠæ³•å°±æ˜¯å°†è¿™ä¸ªTimeråˆ†åˆ«åŠ å…¥è¿™ä¸¤ä¸ªMode.è¿˜æœ‰ä¸€ç§æ–¹å¼ï¼Œå°±æ˜¯å°†TImeråŠ å…¥åˆ°é¡¶å±‚RunLoopçš„"commonModeItems"ä¸­ï¼Œâ€œcommonMOdeItemsâ€è¢«RunLoopè‡ªåŠ¨æ›´æ–°åˆ°æ‰€æœ‰å…·æœ‰"Common"å±æ€§çš„Modeé‡Œå».</p>

<p>CFRunLoopå¯¹å¤–æš´éœ²çš„ç®¡ç†Modeæ¥å£åªæœ‰ä¸‹é¢2ä¸ª:</p>

<pre><code>CFRunLoopAddCommonMode(CFRunLoopRef runloop, CFStringRef modeName);
CFRunLoopRunInMode(CFStringRef modeName, ...);
</code></pre>

<p>Modeæš´éœ²çš„ç®¡ç†Mode Itemçš„æœ‰ä¸‹é¢å‡ ä¸ª:</p>

<pre><code>CFRunLoopAddSource(CFRunLoopRef rl, CFRunLoopSourceRef source, CFStringRef modeName);
CFRunLoopAddObserver(CFRunLoopRef rl, CFRunLoopObserverRef observer, CFStringRef modeName);
CFRunLoopAddTimer(CFRunLoopRef rl, CFRunLoopTimerRef timer, CFStringRef mode);
CFRunLoopRemoveSource(CFRunLoopRef rl, CFRunLoopSourceRef source, CFStringRef modeName);
CFRunLoopRemoveObserver(CFRunLoopRef rl, CFRunLoopObserverRef observer, CFStringRef modeName);
CFRunLoopRemoveTimer(CFRunLoopRef rl, CFRunLoopTimerRef timer, CFStringRef mode);
</code></pre>

<h2>RunLoopçš„å†…éƒ¨é€»è¾‘</h2>

<p>æ ¹æ®è‹¹æœå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼ŒRunLoopå†…éƒ¨é€»è¾‘å¤§è‡´å¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/1432798974517485.png" alt="logo" /></p>

<p>å®é™…ä¸Šï¼ŒRunLoopå°±æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ª do-whileå¾ªç¯ï¼Œå½“ä½ è°ƒç”¨ CFRunLoopRun()æ—¶ï¼Œçº¿ç¨‹å°±ä¼šä¸€ç›´åœç•™åœ¨è¿™ä¸ªå¾ªç¯é‡Œï¼ŒçŸ¥é“è¶…æ—¶æˆ–è¢«æ‰‹åŠ¨åœæ­¢ï¼Œè¯¥å‡½æ•°æ‰ä¼šè¿”å›.</p>

<h2>è‹¹æœç”¨RunLoopå®ç°çš„åŠŸèƒ½</h2>

<p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥å…ˆçœ‹ä¸€ä¸‹Appå¯åŠ¨åRunLoopçš„çŠ¶æ€:</p>

<pre><code>CFRunLoop {
    current mode = kCFRunLoopDefaultMode
    common modes = {
        UITrackingRunLoopMode
        kCFRunLoopDefaultMode
    }

    common mode items = {

        // source0 (manual)
        CFRunLoopSource {order =-1, {
            callout = _UIApplicationHandleEventQueue}}
        CFRunLoopSource {order =-1, {
            callout = PurpleEventSignalCallback }}
        CFRunLoopSource {order = 0, {
            callout = FBSSerialQueueRunLoopSourceHandler}}

        // source1 (mach port)
        CFRunLoopSource {order = 0,  {port = 17923}}
        CFRunLoopSource {order = 0,  {port = 12039}}
        CFRunLoopSource {order = 0,  {port = 16647}}
        CFRunLoopSource {order =-1, {
            callout = PurpleEventCallback}}
        CFRunLoopSource {order = 0, {port = 2407,
            callout = _ZL20notify_port_callbackP12__CFMachPortPvlS1_}}
        CFRunLoopSource {order = 0, {port = 1c03,
            callout = __IOHIDEventSystemClientAvailabilityCallback}}
        CFRunLoopSource {order = 0, {port = 1b03,
            callout = __IOHIDEventSystemClientQueueCallback}}
        CFRunLoopSource {order = 1, {port = 1903,
            callout = __IOMIGMachPortPortCallback}}

        // Ovserver
        CFRunLoopObserver {order = -2147483647, activities = 0x1, // Entry
            callout = _wrapRunLoopWithAutoreleasePoolHandler}
        CFRunLoopObserver {order = 0, activities = 0x20,          // BeforeWaiting
            callout = _UIGestureRecognizerUpdateObserver}
        CFRunLoopObserver {order = 1999000, activities = 0xa0,    // BeforeWaiting | Exit
            callout = _afterCACommitHandler}
        CFRunLoopObserver {order = 2000000, activities = 0xa0,    // BeforeWaiting | Exit
            callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv}
        CFRunLoopObserver {order = 2147483647, activities = 0xa0, // BeforeWaiting | Exit
            callout = _wrapRunLoopWithAutoreleasePoolHandler}

        // Timer
        CFRunLoopTimer {firing = No, interval = 3.1536e+09, tolerance = 0,
            next fire date = 453098071 (-4421.76019 @ 96223387169499),
            callout = _ZN2CAL14timer_callbackEP16__CFRunLoopTimerPv (QuartzCore.framework)}
    },

    modes ï¼ {
        CFRunLoopMode  {
            sources0 =  { /* same as 'common mode items' */ },
            sources1 =  { /* same as 'common mode items' */ },
            observers = { /* same as 'common mode items' */ },
            timers =    { /* same as 'common mode items' */ },
        },

        CFRunLoopMode  {
            sources0 =  { /* same as 'common mode items' */ },
            sources1 =  { /* same as 'common mode items' */ },
            observers = { /* same as 'common mode items' */ },
            timers =    { /* same as 'common mode items' */ },
        },

        CFRunLoopMode  {
            sources0 = {
                CFRunLoopSource {order = 0, {
                    callout = FBSSerialQueueRunLoopSourceHandler}}
            },
            sources1 = (null),
            observers = {
                CFRunLoopObserver &gt;{activities = 0xa0, order = 2000000,
                    callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv}
            )},
            timers = (null),
        },

        CFRunLoopMode  {
            sources0 = {
                CFRunLoopSource {order = -1, {
                    callout = PurpleEventSignalCallback}}
            },
            sources1 = {
                CFRunLoopSource {order = -1, {
                    callout = PurpleEventCallback}}
            },
            observers = (null),
            timers = (null),
        },

        CFRunLoopMode  {
            sources0 = (null),
            sources1 = (null),
            observers = (null),
            timers = (null),
        }
    }
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿé»˜è®¤æ³¨å†Œäº†5ä¸ªMode;</p>

<ol>
<li>kcfRunLoopDefaultMode:Appé»˜è®¤çš„Mode,é€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªModeä¸‹è¿è¡Œçš„</li>
<li>UITrackingRunLoopMode:ç•Œé¢è·Ÿè¸ªMode,ç”¨äºScrollViewè¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–Modeå½±å“</li>
<li>UIInitializationRunLoopMode:åœ¨åˆšå¯åŠ¨Appæ—¶è¿›å…¥çš„ç¬¬ä¸€ä¸ªMode,å¯åŠ¨å®Œæˆåä¸å†ä½¿ç”¨</li>
<li>CGEventReceiveRunLoopMode:æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨Mode,é€šå¸¸ç”¨ä¸åˆ°</li>
<li>KcfRunLoopCommonModes:è¿™æ˜¯ä¸€ä¸ªå ä½çš„Mode,æ²¡æœ‰å®é™…ä½œç”¨</li>
</ol>


<p>å½“RunLoopè¿›è¡Œå›è°ƒæ—¶ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°è°ƒç”¨å‡ºå»(call out),å½“ä½ åœ¨ä½ çš„ä»£ç ä¸­æ–­ç‚¹è°ƒè¯•æ—¶ï¼Œé€šå¸¸èƒ½åœ¨è°ƒç”¨æ ˆä¸Šçœ‹åˆ°è¿™äº›å‡½æ•°ã€‚ä¸‹é¢å°±æ˜¯è¿™å‡ ä¸ªå‡½æ•°çš„æ•´ç†ç‰ˆæœ¬ï¼Œå¦‚æœä½ åœ¨ä½ çš„è°ƒç”¨æ ˆä¸­çœ‹åˆ°è¿™äº›é•¿å‡½æ•°åï¼Œåœ¨è¿™é‡ŒæŸ¥æ‰¾ä¸€ä¸‹å°±èƒ½å®šä½åˆ°å…·ä½“çš„è°ƒç”¨åœ°ç‚¹äº†:</p>

<pre><code>{
    /// 1. é€šçŸ¥Observersï¼Œå³å°†è¿›å…¥RunLoop
    /// æ­¤å¤„æœ‰Observerä¼šåˆ›å»ºAutoreleasePool: _objc_autoreleasePoolPush();
    __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopEntry);
    do {

        /// 2. é€šçŸ¥ Observers: å³å°†è§¦å‘ Timer å›è°ƒã€‚
        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeTimers);
        /// 3. é€šçŸ¥ Observers: å³å°†è§¦å‘ Source (éåŸºäºportçš„,Source0) å›è°ƒã€‚
        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeSources);
        __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);

        /// 4. è§¦å‘ Source0 (éåŸºäºportçš„) å›è°ƒã€‚
        __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__(source0);
        __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);

        /// 6. é€šçŸ¥Observersï¼Œå³å°†è¿›å…¥ä¼‘çœ 
        /// æ­¤å¤„æœ‰Observeré‡Šæ”¾å¹¶æ–°å»ºAutoreleasePool: _objc_autoreleasePoolPop(); _objc_autoreleasePoolPush();
        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeWaiting);

        /// 7. sleep to wait msg.
        mach_msg() -&gt; mach_msg_trap();


        /// 8. é€šçŸ¥Observersï¼Œçº¿ç¨‹è¢«å”¤é†’
        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopAfterWaiting);

        /// 9. å¦‚æœæ˜¯è¢«Timerå”¤é†’çš„ï¼Œå›è°ƒTimer
        __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__(timer);

        /// 9. å¦‚æœæ˜¯è¢«dispatchå”¤é†’çš„ï¼Œæ‰§è¡Œæ‰€æœ‰è°ƒç”¨ dispatch_async ç­‰æ–¹æ³•æ”¾å…¥main queue çš„ block
        __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(dispatched_block);

        /// 9. å¦‚æœå¦‚æœRunloopæ˜¯è¢« Source1 (åŸºäºportçš„) çš„äº‹ä»¶å”¤é†’äº†ï¼Œå¤„ç†è¿™ä¸ªäº‹ä»¶
        __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__(source1);


    } while (...);

    /// 10. é€šçŸ¥Observersï¼Œå³å°†é€€å‡ºRunLoop
    /// æ­¤å¤„æœ‰Observeré‡Šæ”¾AutoreleasePool: _objc_autoreleasePoolPop();
    __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopExit);
}
</code></pre>

<h3>AutoReleasePool</h3>

<p>Appå¯åŠ¨åï¼Œè‹¹æœåœ¨ä¸»çº¿ç¨‹RunLoopé‡Œæ³¨å†Œäº†ä¸¤ä¸ªObserver,å…¶å›è°ƒéƒ½æ˜¯
<code>_wrapRunLoopWithAutoreleasePoolHandler()ã€‚</code></p>

<p>ç¬¬ä¸€ä¸ªObserverç›‘è§†çš„äº‹ä»¶æ˜¯è¿›å…¥Loop,å…¶å›è°ƒå†…éƒ½ä¼šè°ƒç”¨<code>_objc_autoreleasePoolPush()</code>,åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>

<p>ç¬¬äºŒä¸ªObserverç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶ï¼šBeforeWaitingæ—¶è°ƒç”¨
<em>objc_autoreleasePoolPop() å’Œ </em>objc_autoreleasePoolPush()é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›Exit(å³å°†æ¨å‡ºLoop)æ—¶è°ƒç”¨<code>_objc_autoreleasePoolPop()</code>æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>

<p>åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œé€šå¸¸éƒ½æ˜¯å†™åœ¨äº‹ä»¶å›è°ƒï¼ŒTimerå›è°ƒå†…çš„ï¼Œè¿™äº›å›è°ƒä¼šè¢«RunLoopåˆ›å»ºå¥½çš„AutoreleasePoolç¯ç»•ç€ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜æ³„éœ²ï¼Œå¼€å‘è€…ä¹Ÿä¸å¿…æ˜¾ç¤ºåˆ›å»ºPooläº†ã€‚</p>

<h3>æ‰‹åŠ¿è¯†åˆ«</h3>

<p>å½“ä¸Šé¢çš„<code>_UIApplicationHandleEventQueue()</code>è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨Cancelå°†å½“å‰çš„ <code>touchesBegin/Move/End</code>ç³»åˆ—å›è°ƒæ‰“æ–­.éšåç³»ç»Ÿå°†å¯¹åº”çš„<code>UIGestureRecognizer</code>æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚</p>

<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ªObserveræ£€æµ‹BeforeWaiting (Loopå³å°†è¿›å…¥ä¼‘çœ ) äº‹ä»¶,è¿™ä¸ªObserverçš„å›è°ƒå‡½æ•°æ˜¯ <code>_UIGestureRecognizerUpdateObserver()</code>,å…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„ GestureRecognizer,å¹¶æ‰§è¡ŒGestureRecognizerçš„å›è°ƒ</p>

<h3>ç•Œé¢æ›´æ–°</h3>

<p>å½“åœ¨æ“ä½œUIæ—¶ï¼Œæ¯”å¦‚æ”¹å˜äº†Frame,æ›´æ–°äº†UIview/CaLayerçš„å±‚æ¬¡æ—¶ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨äº† UIView/CALayer çš„ setNeedsLayout/setNeedsDisplayæ–¹æ³•å,è¿™ä¸ªUIview/CALayerå°±ä¼šæ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œå¹¶è¢«æäº¤åˆ°ä¸€ä¸ªå…¨å±€çš„å®¹å™¨ä¸­ã€‚</p>

<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ªObserverç›‘å¬BeforeWaiting(å³å°†è¿›å…¥ç¡çœ )å’ŒExit(å³å°†é€€å‡ºLoop)äº‹ä»¶ï¼Œå›è°ƒå»æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„å‡½æ•°:</p>

<h3>å®šæ—¶å™¨</h3>

<p>NStimerå…¶å®å°±æ˜¯<code>CFRunLoopTimerRef</code>,ä»–ä»¬ä¹‹é—´æ˜¯toll-free bridgedçš„ï¼Œä¸€ä¸ªNStimeræ³¨å†Œåˆ°RunLoopåï¼ŒRunLoopä¼šä¸ºå…¶é‡å¤çš„æ—¶é—´ç‚¹æ³¨å†Œå·é€šçŸ¥ï¼Œä¾‹å¦‚10:00,11:00,12:00,è¿™å‡ ä¸ªæ—¶é—´ç‚¹ï¼Œ</p>

<p>å¦‚æœæŸä¸ªæ—¶é—´ç‚¹è¢«é”™è¿‡äº†ï¼Œä¾‹å¦‚æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œåˆ™é‚£ä¸ªæ—¶é—´ç‚¹çš„å›è°ƒä¹Ÿä¼šè·³è¿‡å»ï¼Œä¸ä¼šå»¶åæ‰§è¡Œï¼Œå°±å¥½æ¯”ç­‰å…¬äº¤ï¼Œå¦‚æœ10:10æ—¶ï¼Œæˆ‘å¿™ç€ç©æ‰‹æœºé”™è¿‡äº†ï¼Œé‚£æˆ‘åªèƒ½ç­‰10ï¼š20çš„é‚£è¶Ÿå…¬äº¤äº†ã€‚</p>

<p>CADisplayLinkæ˜¯ä¸€ä¸ªå’Œå±å¹•åˆ·æ–°ç‡ä¸€è‡´çš„å®šæ—¶å™¨ï¼Œå¦‚æœåœ¨ä¸¤æ¬¡å±å¹•åˆ·æ–°ä¹‹é—´æ‰§è¡Œäº†ä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œé‚£å…¶ä¸­å°±ä¼šæœ‰ä¸€å¸§è¢«è·³è¿‡å»ï¼Œé€ æˆç•Œé¢å¡é¡¿çš„æ„Ÿè§‰ï¼Œåœ¨å¿«é€Ÿæ»šåŠ¨TableViewæ—¶ï¼Œå³ä½¿ä¸€å¸§çš„å¡é¡¿ä¹Ÿä¼šè®©ç”¨æˆ·æœ‰æ‰€æ„Ÿè§‰.FaceBookå¼€æºçš„ <a href="https://github.com/facebook/AsyncDisplayKit.git">AsyncDisplayKit</a>å°±æ˜¯ä¸ºäº†è§£å†³ç•Œé¢å¡é¡¿çš„é—®é¢˜ï¼Œå…¶å†…éƒ¨ä¹Ÿç”¨åˆ°äº†RunLoopã€‚</p>

<h3>performSelecter</h3>

<p>å½“è°ƒç”¨NSobjectçš„<code>performSelecter:afterDelay:</code>åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ªTimerå¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„RunLoopä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰RunLoop,åˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆ.</p>

<p>å½“è°ƒç”¨ <code>performSelector:onThread:</code>æ—¶ï¼Œå®é™…ä¸Šå…¶ä¼šåˆ›å»ºä¸€ä¸ªTImeråŠ åˆ°å¯¹åº”çš„çº¿ç¨‹ä¸­ï¼ŒåŒæ ·æ»´ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰RunLoopè¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆ.</p>

<h3>å…³äºGCD</h3>

<p>å®é™…ä¸ŠRunLoopåº•å±‚ä¹Ÿä¼šç”¨åˆ°GCDçš„ä¸œè¥¿ï¼Œæ¯”å¦‚RUnLoopæ˜¯ç”¨dispatch_source_t å®ç°çš„Timer.ä½†åŒæ—¶GCDæä¾›çš„æŸäº›æ¥å£ä¹Ÿç”¨äº†RUnLoopï¼Œæ¯”å¦‚dispatch_async().</p>

<p>å½“è°ƒç”¨<code>dispatch_async(dispatch_get_main_queue(), block)</code>æ—¶ï¼ŒlibDispatchä¼šæƒ³ä¸»çº¿ç¨‹çš„RunLoopå‘é€æ¶ˆæ¯ï¼ŒRunLoopä¼šè¢«å”¤é†’ï¼Œå¹¶ä»æ¶ˆæ¯ä¸­å»çš„è¿™ä¸ªblock,å¹¶åœ¨å›è°ƒ.</p>

<h3>å…³äºç½‘ç»œè¯·æ±‚</h3>

<p>iosä¸­ï¼Œå…³äºç½‘ç»œè¯·æ±‚çš„æ¥å£è‡ªä¸‹è€Œä¸Šå¦‚ä¸‹å‡ å±‚:</p>

<pre><code>CFSocket
CFNetwork       -&gt;ASIHttpRequest
NSURLConnection -&gt;AFNetworking
NSURLSession    -&gt;AFNetworking2, Alamofire
</code></pre>

<ul>
<li>CFSocketæ˜¯æœ€åº•å±‚çš„æ¥å£ï¼Œå€¼è´Ÿè´£socketé€šä¿¡</li>
<li>CGNetworkæ˜¯åŸºäºcfSocketç­‰æ¥å£çš„ä¸Šå±‚å°è£…</li>
<li>NSUrlConnectionæ˜¯åŸºäºCFNetworkçš„æ›´é«˜å±‚çš„å°è£…ï¼Œæä¾›é¢å‘å¯¹è±¡çš„æ¥å£ï¼ŒAFNetworkingå·¥ä½œäºè¿™ä¸€å±‚</li>
<li>NSURlSessionæ˜¯ios7ä¸­æ–°å¢çš„æ¥å£ï¼Œè¡¨é¢å’ŒNSUrlConnectionå¹¶åˆ—çš„ï¼Œä½†åº•å±‚ä»ç„¶ç”¨åˆ°äº†NSURLConnection çš„éƒ¨åˆ†åŠŸèƒ½ï¼ŒAFNetworking2 å’Œ Alamofire å·¥ä½œäºè¿™ä¸€å±‚ã€‚
*</li>
</ul>


<p>ä¸‹é¢ä¸»è¦ä»‹ç»NSURlConnectionçš„å·¥ä½œè¿‡ç¨‹.</p>

<p>é€šå¸¸ä½¿ç”¨NSURLconnectionæ—¶ï¼Œä½ ä¼šä¼ å…¥ä¸€ä¸ªDelegate,å½“ä½ è°ƒç”¨ [connection start] åï¼Œè¿™ä¸ªdelegateå°±ä¼šä¸åœçš„æ”¶åˆ°äº‹ä»¶å›è°ƒã€‚å®é™…ä¸Šï¼Œstartè¿™ä¸ªå‡½æ•°çš„å†…éƒ¨ä¼šè·å– CurrentRunLoop,ç„¶ååœ¨å…¶ä¸­çš„DefaultModeæ·»åŠ äº†4ä¸ªSource0, CFMultiplexerSourceæ˜¯è´Ÿè´£å„ç§Delegateå›è°ƒçš„, CFHTTPCookieStorageæ˜¯å¤„ç†å„ç§Cookieçš„ã€‚</p>

<p>å½“å¼€å§‹ç½‘ç»œä¼ è¾“æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°NSURLCOnnenctionåˆ›å»ºäº†ä¸¤ä¸ªæ–°çº¿ç¨‹:
com.apple.NSURLConnectionLoader å’Œ com.apple.CFSocket.private.å…¶ä¸­ï¼ŒCFSocketçº¿ç¨‹æ˜¯å¤„ç†åº•å±‚socketè¿æ¥çš„ã€‚NSUrlConnnectionLoaderè¿™ä¸ªçº¿ç¨‹å†…éƒ¨ä¼šä½¿ç”¨RunLoopæ¥æ¥æ”¶åº•å±‚socketçš„äº‹ä»¶ï¼Œå¹¶é€šè¿‡è¯¥ä¹‹å‰æ·»åŠ çš„Source0é€šçŸ¥ä¸Šå±‚çš„delegateã€‚
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/1432799200369980.png" alt="logo" /></p>

<p>NSURLConnectionLoader ä¸­çš„ RunLoop é€šè¿‡ä¸€äº›åŸºäº mach port çš„ Source æ¥æ”¶æ¥è‡ªåº•å±‚ CFSocket çš„é€šçŸ¥ã€‚å½“æ”¶åˆ°é€šçŸ¥åï¼Œå…¶ä¼šåœ¨åˆé€‚çš„æ—¶æœºå‘ CFMultiplexerSource ç­‰ Source0 å‘é€é€šçŸ¥ï¼ŒåŒæ—¶å”¤é†’ Delegate çº¿ç¨‹çš„ RunLoop æ¥è®©å…¶å¤„ç†è¿™äº›é€šçŸ¥ã€‚CFMultiplexerSource ä¼šåœ¨ Delegate çº¿ç¨‹çš„ RunLoop å¯¹ Delegate æ‰§è¡Œå®é™…çš„å›è°ƒ</p>

<h2>RunLoopçš„å®é™…åº”ç”¨ä¸¾ä¾‹</h2>

<p>AFURLConnectionOperation è¿™ä¸ªç±»æ˜¯åŸºäº<code>NSURLConnection</code>æ„å»ºçš„ï¼Œå…¶å¸Œæœ›èƒ½åœ¨åå°çº¿ç¨‹æ¥æ”¶Delegateå›è°ƒã€‚ä¸ºæ­¤ï¼ŒAFNetworkingå•ç‹¬åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­å¯åŠ¨äº†ä¸€ä¸ªRunLoop:</p>

<pre><code>+ (void)networkRequestThreadEntryPoint:(id)__unused object {
    @autoreleasepool {
        [[NSThread currentThread] setName:@"AFNetworking"];
        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
        [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
        [runLoop run];
    }
}

+ (NSThread *)networkRequestThread {
    static NSThread *_networkRequestThread = nil;
    static dispatch_once_t oncePredicate;
    dispatch_once(&amp;oncePredicate, ^{
        _networkRequestThread = [[NSThread alloc] initWithTarget:self selector:@selector(networkRequestThreadEntryPoint:) object:nil];
        [_networkRequestThread start];
    });
    return _networkRequestThread;
}
</code></pre>

<p>RunLoopå¯åŠ¨å‰å†…éƒ¨å¿…é¡»è¦æœ‰è‡³å°‘ä¸€ä¸ª Timer/Observer/Source,æ‰€ä»¥AFNetworkingåœ¨[run start]ä¹‹å‰æ”¾å…¥äº†ä¸€ä¸ªæ–°çš„NSmachPortæ·»åŠ è¿›å…¥äº†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè°ƒç”¨è€…éœ€è¦æŒæœ‰NSMachPort (mach_port),å¹¶åœ¨å¤–éƒ¨çº¿ç¨‹é€šè¿‡è¿™ä¸ªPortå‘é€æ¶ˆæ¯åˆ°loopå†…ï¼›ä½†æ­¤å¤„æ·»åŠ portåªæ˜¯ä¸ºäº†è®©RunLoopä¸è‡³äºé€€å‡ºï¼Œå¹¶æ²¡æœ‰å®é™…çš„å‘é€æ¶ˆæ¯.</p>

<pre><code>- (void)start {
    [self.lock lock];
    if ([self isCancelled]) {
        [self performSelector:@selector(cancelConnection) onThread:[[self class] networkRequestThread] withObject:nil waitUntilDone:NO modes:[self.runLoopModes allObjects]];
    } else if ([self isReady]) {
        self.state = AFOperationExecutingState;
        [self performSelector:@selector(operationDidStart) onThread:[[self class] networkRequestThread] withObject:nil waitUntilDone:NO modes:[self.runLoopModes allObjects]];
    }
    [self.lock unlock];
}
</code></pre>

<p>å½“éœ€è¦åœ¨è¿™ä¸ªåå°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼ŒAFNetworkingé€šè¿‡è°ƒç”¨[NSObject performSelector:onThread:..] å°†è¿™ä¸ªä»»åŠ¡æ‰”åˆ°äº†åå°çº¿ç¨‹çš„RunLoopä¸­ã€‚</p>

<h2>AsyncDisplayKit</h2>

<p>AsyncDisplayKit æ˜¯ Facebook æ¨å‡ºçš„ç”¨äºä¿æŒç•Œé¢æµç•…æ€§çš„æ¡†æ¶ï¼Œå…¶åŸç†å¤§è‡´å¦‚ä¸‹:
UIçº¿ç¨‹ä¸­ä¸€æ—¦å‡ºç°ç¹é‡çš„ä»»åŠ¡å°±ä¼šå¯¼è‡´ç•Œé¢å¡é¡¿ï¼Œè¿™ç±»ä»»åŠ¡é€šå¸¸åˆ†ä¸º3ç±»ï¼šæ’ç‰ˆï¼Œç»˜åˆ¶ï¼ŒUiå¯¹è±¡æ“ä½œ.</p>

<p>æ’ç‰ˆé€šå¸¸åŒ…æ‹¬è®¡ç®—è§†å›¾çš„å¤§å°ï¼Œè®¡ç®—æ–‡æœ¬çš„é«˜åº¦ï¼Œç­‰æ“ä½œã€‚</p>

<p>ç»˜åˆ¶ä¸€èˆ¬æœ‰æ–‡æœ¬ç»˜åˆ¶ï¼Œä¾‹å¦‚CoreText,å›¾ç‰‡ç»˜åˆ¶ï¼Œä¾‹å¦‚é¢„å…ˆè§£å‹ï¼Œå…ƒç´ å›¾å½¢ç»˜åˆ¶ç­‰.</p>

<p>UIå¯¹è±¡æ“ä½œé€šå¸¸åŒ…æ‹¬UIView/CaLayerç­‰ui å¯¹è±¡çš„åˆ›å»ºï¼Œè®¾ç½®å±æ€§å’Œé”€æ¯.</p>

<p>å…¶ä¸­å‰ä¸¤ç±»æ“ä½œå¯ä»¥é€šè¿‡å„ç§æ–¹æ³•æ‰”åˆ°åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè€Œæœ€åä¸€ç±»æ“ä½œåªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­å®Œæˆï¼Œå¹¶ä¸”æœ‰æ—¶åé¢çš„æ“ä½œéœ€è¦ä¸€æ å‰é¢æ“ä½œçš„ç»“æœã€‚ï¼ˆä¾‹å¦‚UITextViewåˆ›å»ºæ—¶å¯èƒ½éœ€è¦æå‰è®¡ç®—å‡ºæ–‡æœ¬çš„å¤§å°ï¼‰.ASDKæ‰€åšçš„ï¼Œå°±æ˜¯å°½é‡å°†èƒ½æ”¾å…¥åˆ°åå°çš„ä»»åŠ¡æ”¾å…¥åˆ°åå°ï¼Œä¸èƒ½åˆ™å°½é‡æ¨è¿Ÿ(ä¾‹å¦‚è§†å›¾çš„åˆ›å»ºï¼Œå±æ€§çš„è°ƒæ•´)</p>

<p>ä¸ºæ­¤ï¼ŒASDKåˆ›å»ºäº†ä¸€ä¸ªåä¸º <code>ASDisplayNode</code>çš„å¯¹è±¡ï¼Œå¹¶åœ¨å†…éƒ¨å°è£…äº†UiView/CaLayerï¼Œå®ƒå…·æœ‰å’ŒUIView/CALayerç›¸ä¼¼çš„å±æ€§ï¼Œä¾‹å¦‚ frame,backgroundColorç­‰ã€‚æ‰€æœ‰è¿™äº›å°šéœ€ç»éƒ½å¯ä»¥æ”¾åˆ°åå°çº¿ç¨‹æ›´æ”¹ï¼Œå¼€å‘è€…å¯ä»¥åªé€šè¿‡Nodeæ¥æ“ä½œå™¨å†…éƒ¨çš„UIVidw/CaLayerï¼Œè¿™æ ·å°±å¯ä»¥å°†æ’ç‰ˆå’Œç»˜åˆ¶æ”¾å…¥åˆ°äº†åå°çº¿ç¨‹ï¼Œä½†æ˜¯æ— è®ºæ€ä¹ˆæ“ä½œï¼Œè¿™äº›å±æ€§æ€»æ˜¯éœ€è¦åœ¨æŸä¸ªæ—¶åˆ»åŒæ­¥åˆ°ä¸»çº¿ç¨‹çš„ UIview/CaLayerä¸­ã€‚</p>

<p>ASDKä»¿ç…§ QuartzCore/UIKitæ¡†æ¶çš„æ¨¡å¼ï¼Œå®ç°äº†ä¸€å¥—ç±»ä¼¼çš„ç•Œé¢æ›´æ–°æœºåˆ¶:å³åœ¨ä¸»çº¿ç¨‹çš„RunLoopä¸­æ·»åŠ ä¸€ä¸ªObserver,ç›‘å¬äº† kCFRunLoopBeforeWaiting å’Œ kCFRunLoopExit äº‹ä»¶,åœ¨æ”¶åˆ°å›è°ƒæ—¶ï¼Œéå†æ‰€æœ‰ä¹‹å‰æ”¾å…¥é˜Ÿåˆ—ç­‰å¾…å¤„ç†çš„ä»»åŠ¡ï¼Œç„¶åä¸€ä¸€æ‰§è¡Œã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[NSUrlSessionè¯¦è§£]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/27/nsurlsessionxiang-jie/"/>
    <updated>2016-03-27T18:48:28+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/27/nsurlsessionxiang-jie</id>
    <content type="html"><![CDATA[<p>NSUrlSessionæ˜¯NSUrlConnectionçš„æ›¿ä»£å“ã€‚</p>

<p>NSUrlConennectionæŒ‡çš„æ˜¯ä¸€ç»„æ„æˆ Foundationæ¡†æ¶ä¸­URLåŠ è½½ç³»ç»Ÿçš„ç›¸äº’å…³è”çš„ç»„ä»¶:NSURLRequest,NSUrlResponse,NSURlProtocolç­‰,åœ¨åå•†å‘é€ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥æœåŠ¡å™¨å¯å‘å‡ºéªŒè¯è´¨è¯¢ï¼Œè¿™å¯ä»¥ç”±å…±äº«çš„cookieï¼Œè¯ä¹¦å­˜å‚¨ï¼ˆcredential storageï¼‰æˆ–é€šè¿‡è¿æ¥å§”æ‰˜è‡ªåŠ¨å¤„ç†ã€‚å¿…è¦çš„æ—¶å€™ï¼Œä¸ºäº†æ— ç¼åœ°æ”¹å˜è£…è½½è¡Œä¸ºï¼Œä¼ å‡ºè¯·æ±‚ä¹Ÿå¯ä»¥è¢«æ³¨å†Œçš„NSURLProtocolå¯¹è±¡æˆªè·.</p>

<!--more-->


<p>ä¸ç®¡æ€æ ·ï¼Œè€ƒè™‘åˆ°NSURLConnectionä½œä¸ºä¸€ä¸ªç½‘ç»œåŸºç¡€æ¶æ„ï¼Œæˆåƒä¸Šä¸‡çš„Cocoaå’ŒCocoa Touchåº”ç”¨ç¨‹åºä»ä¸­è·ç›Šï¼Œå®ƒå·²ç»è¡¨ç°å¾—ç›¸å½“å¥½ã€‚ä½†æ˜¯ï¼Œè¿™äº›å¹´æ¥ï¼ŒiPhoneå’ŒiPadæ–°å…´çš„ç”¨ä¾‹ï¼Œç‰¹åˆ«æ˜¯æœ‰ä¸€äº›å·²ç»å‘NSURLConnectionçš„å‡ ä¸ªæ ¸å¿ƒè®¾æƒ³æå‡ºäº†æŒ‘æˆ˜ï¼Œå¯¹å…¶é‡æ„å·²ç»è¿«åœ¨çœ‰ç«ã€‚</p>

<p>åœ¨2013å¹´çš„WWDCä¸Šï¼ŒAppleæ­å¼€äº†NSURLConnectionç»§ä»»è€…çš„é¢çº±ï¼šNSURLSession.</p>

<p>ä¸NSUrlConnectionç±»ä¼¼ï¼Œé™¤äº†åŒåç±» NSUrlsession,NSUrlSessionæŒ‡çš„æ˜¯ä¸€ç»„ç›¸äº’ä¾èµ–çš„ç±»ï¼ŒNSURlSessionåŒ…æ‹¬ä¸ä¹‹å‰ç›¸åŒçš„ç»„ä»¶ï¼Œä¾‹å¦‚NSUrlRequest,NSURLCatchç­‰ç­‰ã€‚
ã€€ã€€</p>

<h2>NSURlconenction ä¸ NSSessionçš„ä¸åŒ</h2>

<p>ã€€ã€€ä¸NSUrlConnectionç›¸æ¯”ï¼ŒNSUrlSessionæœ€ç›´æ¥çš„æ”¹å–„å°±æ˜¯æä¾›äº†é…ç½®æ¯ä¸ªå›è¯çš„ç¼“å­˜ï¼Œåè®®ï¼Œcookieå’Œè¯ä¹¦ç­–ç•¥(credential policies),ç”šè‡³è·¨åº”ç”¨ç¨‹åºå…±äº«å®ƒä»¬çš„èƒ½åŠ›ã€‚è¿™ä½¿å¾—æ¡†æ¶çš„ç½‘ç»œåŸºç¡€æ¶æ„å’Œéƒ¨åˆ†åº”ç”¨ç¨‹åºç‹¬ç«‹å·¥ä½œï¼Œè€Œä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œæ¯ä¸€ä¸ªNSUrlSessionå¯¹è±¡éƒ½æ˜¯æ ¹æ®ä¸€ä¸ªNSURlSessionConfigurationåˆå§‹åŒ–çš„ï¼Œ
ã€€ã€€
ã€€ã€€</p>

<p>è¯¥NSURlSessionConfigurationæŒ‡å®šäº†ä¸Šé¢æåˆ°çš„ç­–ç•¥ï¼Œä¸€çº§ä¸€ç³»åˆ—ä¸ºäº†æé«˜ç§»åŠ¨è®¾å¤‡æ€§èƒ½è€Œä¸“é—¨æ·»åŠ çš„æ–°é€‰é¡¹ã€‚</p>

<p>NSUrlSessionçš„å¦ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†å°±æ˜¯ä¼šè¯ä»»åŠ¡ï¼Œå®ƒè´Ÿè´£å¤„ç†æ•°æ®çš„åŠ è½½ï¼Œä»¥åŠå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„æ–‡ä»¶å’Œæ•°æ®çš„ä¸Šä¼ å’Œä¸‹è½½ã€‚</p>

<h2>NSURLSessionç®€ä»‹</h2>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Screen-Shot-2015-08-20-at-12.27.21-am.png" alt="logo" /></p>

<p>NSURLsessionå…³é”®å¯¹è±¡è´Ÿè´£æ¥æ”¶å’Œå‘é€httpè¯·æ±‚ï¼Œåˆ›å»ºNSURlSessionConfiguration,è¿™é‡Œæœ‰ä¸‰ç§æ–¹å¼:</p>

<ul>
<li><code>defaultSessionConfiguration</code>åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥å­˜å‚¨ç¼“å­˜ï¼Œåˆ›å»ºè¯ä¹¦å’Œç¼“å­˜cookieç­‰</li>
<li><code>ephemeralSessionConfiguration</code>å’Œé»˜è®¤é…ç½®æ–‡ä»¶å¾ˆç›¸ä¼¼ï¼Œé™¤äº†å®ƒå¯ä»¥åœ¨å†…å­˜ä¸­å­˜å‚¨ä¹‹å¤–ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ªç§æœ‰çš„session</li>
<li><code>backgroundSessionConfiguration</code>è¿™ä¸ªé…ç½®æ–‡ä»¶æ”¯æŒä¸Šä¼ å’Œä¸‹è½½ä»»åŠ¡åœ¨åå°ã€‚å½“ç¨‹åºæŒ‚èµ·æˆ–è€…è¢«ç»ˆæ­¢ä¹‹åä»»åŠ¡å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</li>
</ul>


<p><code>NSURLSessionConfiguration</code>ä¾ç„¶å¯ä»¥è®©ä½ é…ç½®sessionçš„å±æ€§ï¼Œæ¯”å¦‚è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œç¼“å­˜ç­–ç•¥å’Œhttpè¯·æ±‚å¤´ç­‰ã€‚<a href="https://developer.apple.com/library/mac/documentation/Foundation/Reference/NSURLSessionConfiguration_class/index.html#//apple_ref/occ/cl/NSURLSessionConfiguration">è¿™é‡Œ</a>æœ‰å®Œæ•´çš„é…ç½®æ–‡æ¡£ã€‚</p>

<p><code>NSURLSessionTask</code>æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ä»»åŠ¡ç¬¦å·,ä¸€ä¸ªsessionåˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œå®ƒä¸ä»…å¯ä»¥è¯·æ±‚æ•°æ®ï¼Œè¿˜å¯ä»¥ä¸Šä¼ å’Œä¸‹è½½ã€‚</p>

<p>è¿™é‡Œæœ‰ä¸‰ç§ç±»å‹çš„ä»»åŠ¡ï¼š</p>

<ul>
<li><code>NSURLSessionDataTask</code>ï¼šç”¨è¿™ä¸ªä»»åŠ¡å¯ä»¥å‘é€httpè¯·æ±‚ï¼Œä»è€Œä»æœåŠ¡å™¨å¾—åˆ°è¿”å›çš„æ•°æ®</li>
<li><code>NSURLSessionUploadTask</code>ï¼šç”¨è¿™ä¸ªä»»åŠ¡å¯ä»¥ä»æœ¬åœ°ç¡¬ç›˜ä¸Šå¾€æœåŠ¡å™¨ä¸Šä¼ æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯HTTP postè¯·æ±‚æˆ–è€…PUTè¯·æ±‚.</li>
<li><code>NSURLSessionDownloadTask</code>:ç”¨è¿™ä¸ªä»»åŠ¡å¯ä»¥ä»è¿œç¨‹æœåŠ¡å™¨ä¸Šä¸‹è½½æ–‡ä»¶</li>
</ul>


<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Screen-Shot-2015-08-20-at-12.27.27-am.png" alt="logo" /></p>

<p>ä½ å¯ä»¥æŒ‚èµ·ï¼Œå›æ»šå’Œå–æ¶ˆä»»åŠ¡ï¼Œ<code>NSURLSessionDownloadTask</code>è¿˜æœ‰ä¸€ä¸ªç‰¹æ€§å°±æ˜¯æ”¯æŒæ–­ç‚¹ä¸‹è½½ã€‚</p>

<p>ä¸€èˆ¬æ¥è®², NSURLSession æœ‰ä¸¤ç§æ–¹å¼è¿”å›æ•°æ®ï¼š</p>

<ol>
<li>åˆ©ç”¨completion handler,å½“ä»»åŠ¡å®Œæˆä¹‹åï¼Œä¸ç®¡æ˜¯æˆåŠŸè¿”å›è¿˜æ˜¯äº§ç”Ÿé”™è¯¯ï¼›</li>
<li>è¿˜æœ‰ä¸€ç§å°±æ˜¯åˆ©ç”¨NSSessionçš„ä»£ç†ï¼Œä¾ç„¶å¯ä»¥æ•è·åˆ°è¿”å›çš„æ•°æ®;</li>
</ol>


<h2>ç¼–å†™å®ä¾‹Demo</h2>

<p><a href="http://www.raywenderlich.com/wp-content/uploads/2016/01/HalfTunes-Starter.zip">å¯åŠ¨å·¥ç¨‹åœ¨è¿™é‡Œä¸‹è½½</a>,</p>

<p>å¼€å§‹åšä¸€ä¸ª åœ¨Itunesæœç´¢æ­Œæ›²ï¼Œé€šè¿‡<a href="https://www.apple.com/itunes/affiliates/resources/documentation/itunes-store-web-service-search-api.html">Itunes API</a>ä¸‹è½½æ­Œæ›²çš„è¿™ä¹ˆä¸ªå°å·¥ç¨‹ï¼Œæ”¯æŒæš‚åœï¼Œä¸‹è½½åŠŸèƒ½ã€‚</p>

<p>ä¸‹å®Œå·¥ç¨‹ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/Simulator-Screen-Shot-12-Aug-2015-11.10.57-pm-281x500.png" alt="itunes" /></p>

<h3>å¼€å§‹ç¼–å†™ä»£ç </h3>

<p>ä½ å¯ä»¥æ·»åŠ ä»£ç å»æŸ¥è¯¢itunesä¸­çš„æ­Œæ›²ï¼Œé€šè¿‡æŸ¥æ‰¾ Itunes search Api.</p>

<p>åœ¨<code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<pre><code>// 1
let defaultSession = NSURLSession(configuration: NSURLSessionConfiguration.defaultSessionConfiguration())
// 2
var dataTask: NSURLSessionDataTask?
</code></pre>

<p>ä¸Šé¢çš„ä»£ç åšäº†å¦‚ä¸‹å·¥ä½œ:</p>

<ol>
<li>ç”¨é»˜è®¤çš„é…ç½®æ–‡ä»¶åˆ›å»ºNSURLSession</li>
<li>ä½ å®šä¹‰äº†ä¸€ä¸ª<code>NSURLSessionDataTask</code>å˜é‡ï¼Œç”¨å®ƒå‘é€httpè¯·æ±‚ï¼Œè¿™ä¸ªä»»åŠ¡å°†ä¼šè¢«é‡å¤åˆå§‹åŒ–å’Œé‡å¤åˆ©ç”¨åœ¨ç”¨æˆ·åˆ›å»ºä¸€ä¸ªæ–°æŸ¥è¯¢çš„æ—¶å€™</li>
</ol>


<p>ç°åœ¨ï¼Œæ›¿æ¢<code>searchBarSearchButtonClicked(_:)</code>é‡Œé¢çš„ä»£ç :</p>

<pre><code>func searchBarSearchButtonClicked(searchBar: UISearchBar) {
  dismissKeyboard()

  if !searchBar.text!.isEmpty {
    // 1
    if dataTask != nil {
      dataTask?.cancel()
    }
    // 2
    UIApplication.sharedApplication().networkActivityIndicatorVisible = true
    // 3
    let expectedCharSet = NSCharacterSet.URLQueryAllowedCharacterSet()
    let searchTerm = searchBar.text!.stringByAddingPercentEncodingWithAllowedCharacters(expectedCharSet)!
    // 4
    let url = NSURL(string: "https://itunes.apple.com/search?media=music&amp;entity=song&amp;term=\(searchTerm)")
    // 5
    dataTask = defaultSession.dataTaskWithURL(url!) {
      data, response, error in
      // 6
      dispatch_async(dispatch_get_main_queue()) {
        UIApplication.sharedApplication().networkActivityIndicatorVisible = false
      }
      // 7
      if let error = error {
        print(error.localizedDescription)
      } else if let httpResponse = response as? NSHTTPURLResponse {
        if httpResponse.statusCode == 200 {
          self.updateSearchResults(data)
        }
      }
    }
    // 8
    dataTask?.resume()
  }
}
</code></pre>

<p>è¿è¡Œåä»£ç å¦‚ä¸‹:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160401-1.png" alt="logo" /></p>

<p>å¦‚æœå‡ºç°é”™è¯¯<code>An SSL error has occurred and a secure connection to the server cannot be made.</code></p>

<p>è¯·åœ¨info.plistä¸­é…ç½®ï¼Œåœ¨Info.plistä¸­æ·»åŠ NSAppTransportSecurityç±»å‹Dictionaryã€‚ åœ¨NSAppTransportSecurityä¸‹æ·»åŠ NSAllowsArbitraryLoadsç±»å‹Boolean,å€¼è®¾ä¸º YES</p>

<p>ä¸Šé¢çš„ä»£ç æ­¥éª¤æ„ä¹‰å¦‚ä¸‹:</p>

<ol>
<li>æ£€æŸ¥ç”¨æˆ·æ¯ä¸€æ¬¡æŸ¥è¯¢ï¼ŒdataTaskæ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å–æ¶ˆè¯¥ä»»åŠ¡</li>
<li>è®¾ç½®çš„çŠ¶æ€æ ä¸Šçš„è½¬å­è¿è¡Œèµ·æ¥ï¼Œè¯æ˜æ•°æ®æ­£åœ¨è¯·æ±‚å½“ä¸­</li>
<li>å½“ç”¨æˆ·è¾“å…¥æŸ¥è¯¢å‚æ•°ä¹‹å‰ï¼Œè°ƒç”¨ è¯·æ±‚å­—ç¬¦ä¸²çš„<code>stringByAddingPercentEncodingWithAllowedCharacters(_:)</code>,ç¡®ä¿æ˜¯ä¸€ä¸ªæ­£ç¡®çš„URL.ã€€(è¿™ä¸ª text çš„ç±»å‹æ˜¯ String ï¼Œå¸¸ç”¨äºæœç´¢åŠŸèƒ½ï¼Œåœ¨  URL ä¸­åŒ…å«è¢«æœçš„å…³é”®å­—ï¼Œå¦‚æœä¸å¤„ç†æœä¸­æ–‡æˆ–è€…å¸¦ç©ºæ ¼çš„è‹±æ–‡ä¼šç›´æ¥å´©æºƒ);</li>
<li>ä¸‹ä¸€æ­¥åˆ›å»ºä¸€ä¸ªNSURLç”¨ä¸Šé¢çš„ï¼ˆå®‰å…¨çš„ï¼‰å­—ç¬¦ä¸²ï¼Œä½¿ç”¨GETè¯·æ±‚å»è°ƒç”¨Itunes Search API</li>
<li>ä»åˆ›å»ºçš„Sessionä¸­ï¼Œä½ åˆå§‹åŒ–<code>NSURLSessionDataTask</code>å»å¤„ç†httpè¯·æ±‚ï¼Œè¿™ä¸ª<code>NSURLSessionDataTask</code>ä»»åŠ¡ä½¿ç”¨completion handler ï¼ˆå›è°ƒå‡½æ•°ï¼‰å»å“åº”æœåŠ¡å™¨è¿”å›çš„æ•°æ®</li>
<li>å¼‚æ­¥è°ƒç”¨ä¸»çº¿ç¨‹ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸Šéšè—ç½‘ç»œè¯·æ±‚çš„è½¬å­</li>
<li>å¦‚æœhttpè¯·æ±‚æ˜¯æˆåŠŸçš„ï¼Œä½ å¯ä»¥è°ƒç”¨<code>updateSearchResults(_:)</code>æ¥åˆ·æ–°è¡¨æ ¼æ•°æ®ï¼Œè¿”å›æ•°æ®æ˜¯NSDataç±»å‹çš„ï¼Œéœ€è¦åœ¨updateSearchResultsæ–¹æ³•ä¸­è¿›è¡Œå¤„ç†</li>
<li>æ‰€æœ‰ä»»åŠ¡é»˜è®¤æ˜¯æŒ‚èµ·çŠ¶æ€ï¼Œéœ€è¦ä½ è°ƒç”¨ <code>resume()</code>å»å¯åŠ¨ä»»åŠ¡</li>
</ol>


<h2>ä¸‹è½½</h2>

<p>çœ‹ç€æœç´¢åˆ°çš„æ­Œæ›²ï¼Œæ„Ÿè§‰é¡µé¢ä¸é”™ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡ç‚¹å‡» download,ç„¶åæŠŠæ­Œæ›²ä¸‹è½½åˆ°æœ¬åœ°æ˜¯ä¸æ˜¯æ›´çˆ½å‘¢?ä¸‹ä¸€æ­¥è®©æˆ‘å®ç°è¿™ä¸ªåŠŸèƒ½ç‚¹.</p>

<p>ç”¨å¤šçº¿ç¨‹å®ç°ä¸‹è½½æ˜¯å®¹æ˜“çš„ã€‚é¦–å…ˆä½ è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶å‘½åä¸º <code>Download.swift</code>. æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<pre><code>class Download: NSObject {

  var url: String
  var isDownloading = false
  var progress: Float = 0.0

  var downloadTask: NSURLSessionDownloadTask?
  var resumeData: NSData?

  init(url: String) {
    self.url = url
  }
}
</code></pre>

<p>å±æ€§è¯´æ˜å¦‚ä¸‹:</p>

<ul>
<li>URL:ä¸‹è½½æ–‡ä»¶çš„urlåœ°å€ï¼Œå®ƒä¹Ÿæ‰®æ¼”ç€å”¯ä¸€çš„æ ‡è¯†ç¬¦åœ¨ä¸‹è½½è¿‡ç¨‹ä¸­</li>
<li>isDownloading:æ˜¯å¦æ­£åœ¨ä¸‹è½½æˆ–æš‚åœ</li>
<li>progress : ä¸‹è½½çš„è¿›åº¦,[0-1]</li>
<li>downloadTask: NSURLSessionDownloadTaskä¸‹è½½ä»»åŠ¡</li>
<li>resumeData:å½“ä½ æš‚åœä¸€ä¸ªä¸‹è½½ä»»åŠ¡æ—¶ï¼Œå®ƒè´Ÿè´£å­˜å‚¨æ­¤æ—¶çš„æ•°æ®é‡ï¼›å¦‚æœåå°æœåŠ¡å™¨æ”¯æŒçš„è¯ï¼Œå½“ç”¨æˆ·å†æ¬¡ç‚¹å‡»ç»§ç»­ä¸‹è½½ï¼Œå®ƒä¼šä»è¿™é‡Œå¼€å§‹ç»§ç»­ä¸‹è½½è¿™ä¸ªæ–‡ä»¶ï¼Œä¿—ç§° æ–­ç‚¹ä¸‹è½½</li>
</ul>


<p>åˆ‡æ¢åˆ° <code>SearchViewController.swift</code>ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<pre><code>var activeDownloads = [String: Download]()
</code></pre>

<h2>åˆ›å»ºä¸‹è½½ä»»åŠ¡</h2>

<p>å‡†å¤‡å·¥ä½œåšå¾—å·®ä¸å¤šäº†ï¼Œç°åœ¨ä½ åªéœ€å®ç°ä¸‹è½½ï¼Œé¦–å…ˆä½ è¦åˆ›å»ºä¸€ä¸ªsessionå»å®ç°ä¸‹è½½ä»»åŠ¡.</p>

<p>åœ¨ <code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œåœ¨<code>viewDidLoad():</code>ä¹‹å‰æ·»åŠ å¦‚ä¸‹ä»£ç :</p>

<pre><code>lazy var downloadsSession: NSURLSession = {
  let configuration = NSURLSessionConfiguration.defaultSessionConfiguration()
  let session = NSURLSession(configuration: configuration, delegate: self, delegateQueue: nil)
  return session
}()
</code></pre>

<p>è¿™é‡Œåˆå§‹åŒ–äº†ä¸€ä¸ªsession,ç”¨é»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œå»å¤„ç†æ‰€æœ‰çš„ä¸‹è½½ä»»åŠ¡ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šdelegate,è¿™å°†ä¼šä½¿ä½ æ”¶åˆ° <code>NSURLSession</code>çš„ä»£ç†è°ƒç”¨ï¼Œè¿™ä¸ªæ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå®ƒèƒ½æœ‰æ•ˆçš„è·Ÿè¸ªä¸‹è½½ä»»åŠ¡ä¸‹è½½çš„è¿›åº¦å’Œæ˜¯å¦ä¸‹è½½å®Œæˆç­‰ã€‚</p>

<p>è®¾ç½®ä»£ç†çš„é˜Ÿåˆ—æ˜¯nil,ä¼šä¿ƒä½¿sessionåˆ›å»ºä¸€ä¸ªæ“ä½œé˜Ÿåˆ—ï¼Œé»˜è®¤çš„å»è°ƒç”¨ä»£ç†æ–¹æ³•å’Œå›è°ƒæ–¹æ³•.</p>

<p>åœ¨åˆ›å»º<code>downloadsSession</code>å±æ€§çš„æ—¶å€™ï¼Œæˆ‘ä»¬åŠ äº†<code>lazy</code>ç‰¹æ€§ï¼Œè¿™ä¼šè®©ä½ å»¶è¿ŸåŠ è½½è¿™ä¸ªsessionç›´åˆ°ä½ éœ€è¦å®ƒçš„æ—¶å€™ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä¼šé€šè¿‡<code>self</code>ä½œä¸ºä»£ç†å‚æ•°å»åˆå§‹åŒ–ï¼Œå‡å¦‚<code>self</code>è¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚</p>

<p>åœ¨<code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°ç©ºçš„<code>NSURLSessionDownloadDelegate</code>å¹¶ä¸”æ‰©å±•å¦‚ä¸‹:</p>

<pre><code>extension SearchViewController: NSURLSessionDownloadDelegate {
  func URLSession(session: NSURLSession, downloadTask: NSURLSessionDownloadTask, didFinishDownloadingToURL location: NSURL) {
    print("Finished downloading.")
  }
}
</code></pre>

<p><code>NSURLSessionDownloadDelegate</code>å®šä¹‰äº†ä»£ç†æ–¹æ³•ä½ éœ€è¦å»å®ç°ï¼Œåœ¨ä½ ä½¿ç”¨ NSURLSession ä¸‹è½½ä»»åŠ¡çš„æ—¶å€™ï¼Œè¿™ä¸ªå”¯ä¸€çš„ä¸æ˜¯å¯é€‰çš„ä»£ç†æ–¹æ³•æ˜¯ <code>URLSession(_:downloadTask:didFinishDownloadingToURL:),</code>,å½“ä¸‹è½½å®Œæˆçš„æ—¶å€™ï¼Œå°†ä¼šæ‰§è¡Œè¿™ä¸ªä»£ç†æ–¹æ³•ï¼Œæ‰“å°ç®€ç­”çš„ä¸€å¥è¯.</p>

<p>åœ¨<code>SearchViewController.swift</code>æ–‡ä»¶ä¸­ï¼Œæ›¿æ¢<code>startDownload(_:)</code>è¿™ä¸ªæ–¹æ³•çš„ä»£ç å¦‚ä¸‹:</p>

<pre><code>func startDownload(track: Track) {
  if let urlString = track.previewUrl, url =  NSURL(string: urlString) {
    // 1
    let download = Download(url: urlString)
    // 2
    download.downloadTask = downloadsSession.downloadTaskWithURL(url)
    // 3
    download.downloadTask!.resume()
    // 4
    download.isDownloading = true
    // 5
    activeDownloads[download.url] = download
  }
}
</code></pre>

<p>å½“ä½ ç‚¹å‡» <code>Download</code>æŒ‰é’®çš„æ—¶å€™ï¼Œä½ å°†ä¼šè°ƒç”¨<code>startDownload(_:)</code>å‡½æ•°å»æ‰§è¡Œä¸‹è½½å‘½ä»¤ï¼Œä¸Šé¢çš„ä»£ç æ‰§è¡Œçš„æ­¥éª¤å¦‚ä¸‹:</p>

<ol>
<li>ä½ ç”¨URLå»åˆå§‹åŒ–ä¸€ä¸ªDownLoadå¯¹è±¡</li>
<li>ä½¿ç”¨ä¸Šé¢çš„NSURLå’ŒdownloadsSessionå»åˆå§‹åŒ–<code>NSURLSessionDownloadTask</code></li>
<li>è°ƒç”¨resume()å»å¯åŠ¨ä¸€ä¸ªä¸‹è½½ä»»åŠ¡</li>
<li>è®¾ç½®ä¸‹è½½æ ‡è¯† ä¸ºtrue</li>
<li>æœ€åï¼Œä½ æŠŠä¸‹è½½çš„URLä½œä¸ºkey,downloadå¯¹è±¡ä½œä¸ºå€¼æ”¾åˆ°ä¸€ä¸ªå­—å…¸ä¸­</li>
</ol>


<p>ç¼–è¯‘è¿è¡Œä½ çš„é¡¹ç›®ï¼ŒæŸ¥è¯¢å‡ºæ¥çš„æ­Œæ›²ä¸­ï¼Œç‚¹å‡» DownloadæŒ‰é’®ï¼Œä½ å°†ä¼šçœ‹åˆ°ä¸€ä¸ªæ¶ˆæ¯æ‰“å°åœ¨æ§åˆ¶å°ã€‚
<code>Finished downloading.</code></p>

<h2>ä¿å­˜&amp;æ’­æ”¾</h2>

<p>å½“ä¸‹è½½ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œ<code>URLSession(_:downloadTask:didFinishDownloadingToURL:)</code>æä¾›äº†ä¸€ä¸ªURLå­˜å‚¨ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼Œä½ çš„å·¥ä½œå°±æ˜¯ç§»åŠ¨å®ƒåˆ°ä½ ç¨‹åºçš„æ²™ç›’å½“ä¸­ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•è¿”å›ä¹‹å‰ã€‚å½“ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å½“ä¸­ä½ éœ€è¦åˆ é™¤å…¨å±€å­—å…¸ä¸­æ­£åœ¨ä¸‹è½½çš„downloadå¯¹è±¡ï¼Œå¹¶ä¸”æ›´æ–°è¡¨æ ¼.</p>

<p>ä½ éœ€è¦æ·»åŠ ä¸€ä¸ªHelperæ–¹æ³•ç®€åŒ–è¿™ä¸ªæ“ä½œï¼Œåœ¨<code>SearchViewController.swift</code>ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹æ–¹æ³•:</p>

<pre><code>func trackIndexForDownloadTask(downloadTask: NSURLSessionDownloadTask) -&gt; Int? {
  if let url = downloadTask.originalRequest?.URL?.absoluteString {
    for (index, track) in searchResults.enumerate() {
      if url == track.previewUrl! {
        return index
      }
    }
  }
  return nil
}
</code></pre>

<p>è¿™ä¸ªæ–¹æ³•ä»…ä»…è¿”å› å½“å‰çš„URLåœ¨ searchResultsé›†åˆä¸­çš„ç´¢å¼•ï¼Œä¸‹ä¸€æ­¥ï¼Œæ›¿æ¢ URLSession(_:downloadTask:didFinishDownloadingToURL:) ä¸­çš„ä»£ç :</p>

<pre><code>func URLSession(session: NSURLSession, downloadTask: NSURLSessionDownloadTask, didFinishDownloadingToURL location: NSURL) {
  // 1
  if let originalURL = downloadTask.originalRequest?.URL?.absoluteString,
    destinationURL = localFilePathForUrl(originalURL) {

    print(destinationURL)

    // 2
    let fileManager = NSFileManager.defaultManager()
    do {
      try fileManager.removeItemAtURL(destinationURL)
    } catch {
      // Non-fatal: file probably doesn't exist
    }
    do {
      try fileManager.copyItemAtURL(location, toURL: destinationURL)
    } catch let error as NSError {
      print("Could not copy file to disk: \(error.localizedDescription)")
    }
  }

  // 3
  if let url = downloadTask.originalRequest?.URL?.absoluteString {
    activeDownloads[url] = nil
    // 4
    if let trackIndex = trackIndexForDownloadTask(downloadTask) {
      dispatch_async(dispatch_get_main_queue(), {
        self.tableView.reloadRowsAtIndexPaths([NSIndexPath(forRow: trackIndex, inSection: 0)], withRowAnimation: .None)
      })
    }
  }
}
</code></pre>

<p>ä¸Šé¢çš„ä»£ç åšçš„äº‹æƒ…å¦‚ä¸‹:</p>

<ol>
<li>å®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼Œ<code>originalURL</code>è¯·æ±‚è·¯å¾„çš„url,<code>destinationURL</code>å˜é‡åˆ™æ˜¯é€šè¿‡<code>localFilePathForUrl(_:)</code>æ–¹æ³•ç”Ÿæˆçš„ï¼Œè¯¥æ–¹æ³•ä¼šè·å–å½“å‰ç¨‹åºçš„æ²™ç›’è·¯å¾„å†è¿½åŠ  ä¼ é€’çš„URLçš„æœ€åä¸€ä¸ªåç¼€(/)çš„è·¯å¾„ä½œä¸ºè¿”å›çš„å‚æ•°ã€‚ä½œä¸ºç›®æ ‡æ–‡ä»¶å¤¹çš„è·¯å¾„</li>
<li>ä½¿ç”¨NSFileManager,åœ¨å¼€å§‹æ‹·è´æ–‡ä»¶ä¹‹å‰ï¼Œå…ˆåˆ é™¤ç›®æ ‡æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨çš„è¯ã€‚ç„¶åè¿›è¡Œæ‹·è´ä»æœ¬åœ°æ‹·è´åˆ°ç›®æ ‡æ–‡ä»¶å¤¹</li>
<li>åˆ é™¤downloadä»å…¨å±€çš„downloadå­—å…¸ä¸­</li>
<li>æœ€ååˆ·æ–°è¡¨æ ¼å¯¹åº”çš„å“ªä¸€è¡Œ</li>
</ol>


<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œç‚¹å‡»æœç´¢ç„¶åé€‰ä¸­ä¸€è¡Œè¿›è¡Œä¸‹è½½ï¼Œå½“ä¸‹è½½å®Œæˆæ—¶å€™ï¼Œåœ¨æ§åˆ¶å°ä¼šæ‰“å°ä¸€è¡Œä¿¡æ¯,ä¸‹è½½çš„ç›®æ ‡è·¯å¾„</p>

<pre><code>file:///Users/Andrew/Library/Developer/CoreSimulator/Devices/875165C2-FA55-4884-96AE-A7C8E3223C12/data/Containers/Data/Application/52B47648-04A2-4C26-8BCF-F41D2C76CA21/Documents/mzm.gyadmzom.aac.p.m4a
</code></pre>

<p>è¿™æ—¶ä¸‹è½½æŒ‰é’®å°†ä¼šæ¶ˆå¤±ï¼Œå†æ¬¡ç‚¹å‡»è¡¨æ ¼çš„å¯¹åº”çš„é‚£è¡Œï¼Œå°†ä¼šå¼¹å‡ºä¸€ä¸ª MPMoviePlayerViewController,å¼€å§‹æ’­æ”¾éŸ³é¢‘.</p>

<h2>ç›‘è§†ä¸‹è½½è¿›åº¦</h2>

<p>å½“ç„¶ï¼Œç°åœ¨ä½ è¿˜æ²¡æœ‰ç›‘è§†ä¸‹è½½çš„è¿›åº¦æ¡ï¼Œä¸ºäº†æé«˜ç”¨æˆ·ä½“éªŒï¼Œä½ å°†è¦æ”¹å˜ä½ çš„Appå»ç›‘å¬ä¸‹è½½çš„è¿›åº¦åœ¨æ¯ä¸ªcellä¸­ã€‚</p>

<p>åœ¨SearchViewController.swiftæ–‡ä»¶ä¸­,æ‰¾åˆ° <code>NSURLSessionDownloadDelegate</code>çš„æ‰©å±•ï¼Œç„¶åæ·»åŠ å¦‚ä¸‹çš„ä»£ç†æ–¹æ³•:</p>

<pre><code>func URLSession(session: NSURLSession, downloadTask: NSURLSessionDownloadTask, didWriteData bytesWritten: Int64, totalBytesWritten: Int64, totalBytesExpectedToWrite: Int64) {

    // 1
    if let downloadUrl = downloadTask.originalRequest?.URL?.absoluteString,
      download = activeDownloads[downloadUrl] {
      // 2
      download.progress = Float(totalBytesWritten)/Float(totalBytesExpectedToWrite)
      // 3
      let totalSize = NSByteCountFormatter.stringFromByteCount(totalBytesExpectedToWrite, countStyle: NSByteCountFormatterCountStyle.Binary)
      // 4
      if let trackIndex = trackIndexForDownloadTask(downloadTask), let trackCell = tableView.cellForRowAtIndexPath(NSIndexPath(forRow: trackIndex, inSection: 0)) as? TrackCell {
        dispatch_async(dispatch_get_main_queue(), {
          trackCell.progressView.progress = download.progress
          trackCell.progressLabel.text =  String(format: "%.1f%% of %@",  download.progress * 100, totalSize)
        })
    }
  }
}
</code></pre>

<p>é€šè¿‡è¿™ä¸ªä»£ç†æ–¹æ³•åšçš„å·¥ä½œå¦‚ä¸‹:</p>

<ol>
<li>ä½¿ç”¨æä¾›çš„ downloadTask æ‰¾åˆ°URLå±æ€§ï¼Œç„¶åä»å…¨å±€æ¿€æ´»çš„ä¸‹è½½å­—å…¸ä¸­æŸ¥æ‰¾ DownLoadå¯¹è±¡</li>
<li>è¿™ä¸ªæ–¹æ³•å°†ä¼šè¿”å›æ€»çš„å­—èŠ‚æ•°å’Œå·²ç»å†™å…¥çš„å­—èŠ‚æ•°ï¼Œä½ å¯ä»¥åˆ©ç”¨è¿™ä¸ªä¸¤ä¸ªå€¼ç®—å‡ºå½“å‰çš„ä¸‹è½½è¿›åº¦å¹¶ä¸”å®æ—¶æ›´æ–°è¿›åº¦æ¡ã€‚</li>
<li>NSByteCountFormatter å°†ä¼šæŠŠå­—èŠ‚æ•°è½¬åŒ–æˆäººç±»èƒ½å¤Ÿçœ‹æ‡‚çš„æ–‡ä»¶å¤§å°ï¼Œæœ‰å°†ä¼šä½¿ç”¨è¿™ä¸ªå­—ç¬¦ä¸²å»æ˜¾ç¤ºä¸‹è½½çš„æ–‡ä»¶å¤§å°å’Œç™¾åˆ†æ¯”</li>
<li>æœ€åï¼Œä½ å°†è¦å®šä½åˆ°è¿™ä¸ªCell,åœ¨ä¸»çº¿ç¨‹ä¸­æ›´æ–°è¿›åº¦æ¡å’Œæ˜¾ç¤ºçš„ç™¾åˆ†æ¯”</li>
</ol>


<p>ä¸‹ä¸€æ­¥ï¼Œä½ å°†è¦é…ç½®è¿™ä¸ªcellå±æ€§å»æ˜¾ç¤ºè¿›åº¦æ¡</p>

<p>æ‰¾åˆ°ä¸‹é¢çš„ä»£ç åœ¨ <code>tableView(_:cellForRowAtIndexPath:):</code>ä¸­</p>

<pre><code>let downloaded = localFileExistsForTrack(track)
</code></pre>

<p>æ·»åŠ å¦‚ä¸‹ä»£ç åœ¨è¿™è¡Œçš„ä¸Šé¢:</p>

<pre><code>var showDownloadControls = false
if let download = activeDownloads[track.previewUrl!] {
  showDownloadControls = true

  cell.progressView.progress = download.progress
  cell.progressLabel.text = (download.isDownloading) ? "Downloading..." : "Paused"
}
cell.progressView.hidden = !showDownloadControls
cell.progressLabel.hidden = !showDownloadControls
</code></pre>

<p>ä¸ºäº†è·Ÿè¸ªæ­£åœ¨ä¸‹è½½çš„æ­Œæ›²ï¼Œä½ å°†è¦è®¾ç½® showDownloadControlsä¸ºtrue,å¦åˆ™ï¼Œä½ å°†è¦è®¾ç½®ä¸ºfalse.ä½ å°†è¦æ˜¾ç¤ºè¿™è¿›åº¦æ¡å’Œæ–‡å­—ã€‚</p>

<p>ä¸ºäº†æš‚åœä»»åŠ¡ï¼Œæ˜¾ç¤º"Paused"çŠ¶æ€ï¼Œå¦åˆ™ï¼Œæ˜¾ç¤º â€œDownloading&hellip;.â€
æœ€åï¼Œæ›¿æ¢è¿™è¡Œä»£ç :</p>

<pre><code>cell.downloadButton.hidden = downloaded
</code></pre>

<p>ä½¿ç”¨ä¸‹é¢è¿™è¡Œä»£ç :</p>

<pre><code>cell.downloadButton.hidden = downloaded || showDownloadControls
</code></pre>

<p>åˆ°è¿™ï¼Œä½ å¯ä»¥å‘Šè¯‰è¡¨æ ¼æ˜¯å¦éšè—ä¸‹è½½æŒ‰é’®ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼Œä½ å°†è¦çœ‹åˆ°ä¸€ä¸ªè¿›åº¦æ¡å’Œä¸‹è½½çš„è¿›åº¦ï¼Œä»¥åŠä¸‹è½½çš„ç™¾åˆ†æ¯”ã€‚
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/Screen-Shot-2015-08-17-at-11.02.03-pm-480x78.png" alt="logo" /></p>

<p>OK,ä½ åšåˆ°äº†!ğŸ˜€</p>

<h2>æš‚åœ æ¢å¤  å–æ¶ˆä¸‹è½½ä»»åŠ¡</h2>

<p>å‡å¦‚æˆ‘éœ€è¦æš‚åœä¸€ä¸ªä»»åŠ¡ï¼Œæˆ–è€…å–æ¶ˆä»»åŠ¡ï¼Ÿæ­¤æ—¶è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>

<p>åœ¨è¿™ä¸ªç« èŠ‚ï¼Œä½ å°†è¦å®ç°æš‚åœï¼Œæ¢å¤ï¼Œå–æ¶ˆä»»åŠ¡æ“ä½œã€‚</p>

<p>ä½ å°†è¦å¼€å§‹ç¼–å†™ä»£ç ï¼Œé€šè¿‡å…è®¸ç”¨æˆ·å»å–æ¶ˆä¸€ä¸ªæ­£åœ¨æ¿€æ´»çš„ä»»åŠ¡
æ›¿æ¢ <code>cancelDownload(_:)</code> ä½¿ç”¨ä¸‹é¢çš„ä»£ç :</p>

<pre><code>func cancelDownload(track: Track) {
  if let urlString = track.previewUrl,
    download = activeDownloads[urlString] {
      download.downloadTask?.cancel()
      activeDownloads[urlString] = nil
  }
}
</code></pre>

<p>ä¸ºäº†å–æ¶ˆä»»åŠ¡ï¼Œä½ å¯ä»¥ä»å…¨å±€æ¿€æ´»çš„å­—å…¸ä¸­å–å‡ºDownloadå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„ cancel() æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆå‘½ä»¤ï¼Œç„¶ååœ¨å…¨å±€å­—å…¸ä¸­ç§»é™¤å®ƒ</p>

<p>æš‚åœä»»åŠ¡å’Œå–æ¶ˆä»»åŠ¡éå¸¸ç±»ä¼¼ï¼Œä¸åŒç‚¹åœ¨äºå½“ä½ æš‚åœä¸€ä¸ªä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿæ¢å¤æ•°æ®ï¼Œå®ƒåŒ…å«äº†è¶³å¤Ÿå¤šçš„ä¿¡æ¯å»æ¢å¤ä¸‹è½½æ•°æ®ï¼Œå½“ç„¶åå°æœåŠ¡å™¨å¿…é¡»è¦æ”¯æŒè¿™ä¸ªç‰¹æ€§æ‰èƒ½å®Œå…¨å®ç°æ–­ç‚¹ä¸‹è½½åŠŸèƒ½.</p>

<blockquote><p><strong>æ³¨æ„</strong>
ä½ èƒ½æ¢å¤ä¸€ä¸ªä¸‹è½½ä»»åŠ¡åœ¨ä¸€å®šçš„æ§åˆ¶æ¡ä»¶ä¸‹ï¼Œä¾‹å¦‚ï¼Œä»ä½ ç¬¬ä¸€ä¸‹è¯·æ±‚ä¸‹è½½å¼€å§‹ï¼Œè¿™ä¸ªä¸‹è½½èµ„æºå°±ä¸èƒ½å†æ”¹å˜äº†ã€‚æƒ³è¦æ›´è¯¦ç»†çš„æ§åˆ¶æ¡ä»¶ï¼Œè¯·å‚è€ƒè‹¹æœçš„ <a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSessionDownloadTask_class/index.html#//apple_ref/occ/instm/NSURLSessionDownloadTask/cancelByProducingResumeData:">å®˜æ–¹æ–‡æ¡£</a></p></blockquote>

<p>ç°åœ¨ï¼Œæ›¿æ¢ <code>pauseDownload(_:)</code>ä½¿ç”¨ä¸‹é¢çš„ä»£ç :</p>

<pre><code>func pauseDownload(track: Track) {
  if let urlString = track.previewUrl,
    download = activeDownloads[urlString] {
      if(download.isDownloading) {
        download.downloadTask?.cancelByProducingResumeData { data in
          if data != nil {
            download.resumeData = data
          }
        }
        download.isDownloading = false
      }
  }
}
</code></pre>

<p>è¿™ä¸ªå…³é”®å­—æ˜¯ä¸åŒçš„ cancelByProducingResumeData(_:) æ›¿ä»£äº† cancel(),ä½ æ£€ç´¢è¿™ä¸ªæ¢å¤çš„æ•°æ®ä»è¿™ä¸ªæ–¹æ³•cancelByProducingResumeDataæä¾›çš„å›è°ƒå‡½æ•°ä¸­ï¼Œå¹¶ä¸”æŠŠæ¢å¤çš„æ•°æ®ä¿å­˜åˆ°Downloadçš„resumeDataå±æ€§ä¸­ã€‚å¹¶ä¸”è®¾ç½®isDownloading=false</p>

<p>ä¸‹é¢æ›¿æ¢<code>resumeDownload(_:)</code>ç”¨ä¸‹é¢çš„ä»£ç :</p>

<pre><code>func resumeDownload(track: Track) {
  if let urlString = track.previewUrl,
    download = activeDownloads[urlString] {
      if let resumeData = download.resumeData {
        download.downloadTask = downloadsSession.downloadTaskWithResumeData(resumeData)
        download.downloadTask!.resume()
        download.isDownloading = true
      } else if let url = NSURL(string: download.url) {
        download.downloadTask = downloadsSession.downloadTaskWithURL(url)
        download.downloadTask!.resume()
        download.isDownloading = true
      }
  }
}
</code></pre>

<p>å½“ç”¨æˆ·æ¢å¤ä¸€ä¸ªä¸‹è½½ä»»åŠ¡æ—¶ï¼Œä½ æ£€æŸ¥ä¸‹å½“å‰çš„Downloadå¯¹è±¡ æ¢å¤æ•°æ®çš„å±æ€§æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼ï¼Œä½ å°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‹è½½ä»»åŠ¡é€šè¿‡ <code>downloadTaskWithResumeData(_:)</code>å’Œä¸€ä¸ªæ¢å¤æ•°æ®çš„å‚æ•°ï¼Œå¯åŠ¨<code>resume()</code>æ¢å¤æ•°æ®çš„å‘½ä»¤;å¦‚æœè¿™ä¸ª æ¢å¤æ•°æ®çš„å±æ€§æ˜¯ç©ºçš„æˆ–è€…å…¶ä»–ä¸€äº›åŸå› ï¼Œä½ å°†è¦ç”¨URLåˆ›å»ºä¸€ä¸ªæ–°çš„ä¸‹è½½ä»»åŠ¡ï¼Œå¯åŠ¨å®ƒ.</p>

<p>åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œä½ è®¾ç½®è¿™ä¸ªisDownloadingä¸ºtrue,è¡¨æ˜ä»»åŠ¡æ­£åœ¨è¿›è¡Œ.</p>

<p>è¿˜æœ‰ä¸€ä»¶äº‹ä»¶è¦åšå°±æ˜¯è®¾ç½®è¿™ä¸‰ä¸ªå‡½æ•°çš„å·¥ä½œå±æ€§ï¼Œä½ éœ€è¦åœ¨cellä¸­æ˜¾ç¤º æˆ–è€…éšè— <code>æš‚åœ</code>ï¼Œ<code>å–æ¶ˆ</code>å’Œ<code>ç»§ç»­ä¸‹è½½</code>æŒ‰é’®ã€‚</p>

<p>æ‰¾åˆ° <code>tableView(_:cellForRowAtIndexPath:)</code>ç„¶åæ‰¾åˆ°ä¸‹é¢è¿™è¡Œä»£ç :</p>

<pre><code>if let download = activeDownloads[track.previewUrl!] {
</code></pre>

<p>ç„¶åæ·»åŠ ä¸‹é¢çš„ä»£ç :</p>

<pre><code>let title = (download.isDownloading) ? "Pause" : "Resume"
cell.pauseButton.setTitle(title, forState: UIControlState.Normal)
</code></pre>

<p>æš‚åœå’Œç»§ç»­ä¸‹è½½æŒ‰é’®å…±ç”¨ä¸€ä¸ªæŒ‰é’®ã€‚</p>

<p>ä¸‹ä¸€æ­¥ï¼Œæ·»åŠ ä¸‹é¢çš„ä»£ç åœ¨ <code>tableView(_:cellForRowAtIndexPath:)</code>ç»“å°¾:</p>

<pre><code>cell.pauseButton.hidden = !showDownloadControls
cell.cancelButton.hidden = !showDownloadControls
</code></pre>

<p>å½“ä¸‹è½½ä»»åŠ¡æ¿€æ´»çš„æ—¶å€™ï¼Œè¿™é‡Œä»…ä»…æŠŠæŒ‰é’®æ˜¾ç¤ºå‡ºæ¥ã€‚</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œä¸‹è½½å‡ ä¸ªæ­Œæ›²è¯•è¯•ï¼Œä½ å¯ä»¥æš‚åœï¼Œç»§ç»­ä¸‹è½½ï¼Œå–æ¶ˆ ä¸‹è½½ä»»åŠ¡ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Simulator-Screen-Shot-18-Aug-2015-10.14.38-pm-281x500.png" alt="logo" /></p>

<h2>æ”¯æŒåå°ä¸‹è½½</h2>

<p>ä½ çš„Appç°åœ¨çœ‹æ¥å·²ç»å¾ˆä¸é”™äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å¦æ”¯æŒåå°ä»»åŠ¡ä¸‹è½½:å½“ä½ çš„ç¨‹åºè¿›å…¥åå°æ¨¡å¼æˆ–è€…å› ä¸ºåˆ«çš„åŸå› æ„å¤–ç»ˆæ­¢äº†ï¼Œåå°ä»»åŠ¡æ˜¯å¦èƒ½ç»§ç»­ä¸‹è½½?</p>

<p>å‡å¦‚ä½ çš„Appä¸å†è¿è¡Œäº†ï¼Œé‚£å®ƒæ€ä¹ˆèƒ½ç»§ç»­å·¥ä½œå‘¢ï¼Ÿè¿™å„¿æœ‰ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹åœ¨Appè¿è¡Œä¹‹å¤–ï¼Œå»ç®¡ç†åå°ä»»åŠ¡ä¸‹è½½ï¼›å®ƒå‘é€ä¸€ä¸ªé€‚å½“çš„ä»£ç†æ–¹æ³•é€šçŸ¥ç»™appè®©å…¶ä»»åŠ¡ä¸‹è½½ç»§ç»­ï¼Œå½“è¿™ä¸ªappæ­£åœ¨ä¸‹è½½çš„æ—¶å€™çªç„¶é€€å‡ºï¼Œè¿™ä¸ªä»»åŠ¡å°†è¦ç»§ç»­ä¸‹è½½ã€‚</p>

<p>å½“ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œè¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹å°†è¦é‡æ–°åŠ è½½åœ¨åå°æ¨¡å¼ä¸­ï¼Œè¿™ä¸ªé‡æ–°åŠ è½½appå°†è¦é‡æ–°è¿æ¥è¿™åŒæ ·çš„session.æ”¶åˆ°ç›¸å…³çš„å®Œæˆçš„ä»£ç†æ¶ˆæ¯å¹¶ä¸”æ‰§è¡Œä¸€äº›è¦æ±‚çš„åŠ¨ä½œï¼Œæ¯”å¦‚æŒä¹…åŒ–ä¸‹è½½çš„æ–‡ä»¶åˆ°ç¡¬ç›˜ä¸Šç­‰ã€‚</p>

<blockquote><p><em>æ³¨æ„</em>
å¦‚æœä½ å¼ºåˆ¶é€€å‡ºappé€šè¿‡app switcheï¼Œè¿™ä¸ªç³»ç»Ÿå°†è¦å–æ¶ˆæ‰€æœ‰åå°ä¸‹è½½çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¸ä¼šå†è§†å›¾é‡å¯è¿™ä¸ªapp</p></blockquote>

<p>ä»ç„¶åœ¨SearchViewController.swiftè¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œåœ¨åˆå§‹åŒ– <code>downloadsSession</code>çš„åœ°æ–¹ï¼Œæ‰¾åˆ°ä¸‹é¢è¿™è¡Œä»£ç :</p>

<pre><code>let configuration = NSURLSessionConfiguration.defaultSessionConfiguration()
</code></pre>

<p>æ›¿æ¢æˆä¸‹é¢çš„ä»£ç :</p>

<pre><code>let configuration = NSURLSessionConfiguration.backgroundSessionConfigurationWithIdentifier("bgSessionConfiguration")
</code></pre>

<p>æ›¿æ¢é»˜è®¤çš„sessioné…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šä¸€ä¸ªç‰¹æ®Šçš„åå°sessioné…ç½®æ–‡ä»¶ï¼Œæ³¨æ„ä½ è®¾ç½®äº†å”¯ä¸€çš„IDä¸ºè¿™ä¸ªsession,è¿™ä¼šå…è®¸ä½ å¼•ç”¨å¹¶ä¸”é‡æ–°è¿æ¥åŒæ ·çš„åå°session.</p>

<p>ä¸‹ä¸€æ­¥ï¼Œåœ¨ viewDidLoad()ä¸­ï¼Œå¢åŠ å¦‚ä¸‹ä»£ç :</p>

<pre><code>_ = self.downloadsSession
</code></pre>

<p>è°ƒç”¨æ‡’åŠ è½½å±æ€§<code>downloadsSession</code>,ç¡®ä¿åº”ç”¨ç¨‹åºç¡®å®åˆ›å»ºäº†ä¸€ä¸ªåå°session çš„SearchViewControllerçš„å®ä¾‹ã€‚</p>

<p>å½“ä¸€ä¸ªåå°ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œè¿™ä¸ªAppä¸å†è¿è¡Œï¼Œè¿™ä¸ªappå°†ä¼šé‡æ–°è¿è¡Œåˆ°åå°è¿›ç¨‹ä¸­ï¼Œä½ éœ€è¦å»å¤„ç†ä½ çš„appçš„ä¸€äº›ä»£ç†æ–¹æ³•.</p>

<p>åˆ‡æ¢åˆ° AppDelegate.swift,æ·»åŠ ä¸‹é¢çš„ä»£ç åœ¨ç±»çš„é¡¶éƒ¨:</p>

<pre><code>var backgroundSessionCompletionHandler: (() -&gt; Void)?
</code></pre>

<p>ä¸‹ä¸€æ­¥ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç åœ¨AppDelegate.swift:</p>

<pre><code>func application(application: UIApplication, handleEventsForBackgroundURLSession identifier: String, completionHandler: () -&gt; Void) {
  backgroundSessionCompletionHandler = completionHandler
}
</code></pre>

<p>æä¾›ä¸€ä¸ªcompletionHandlerä½œä¸ºä¸€ä¸ªå˜é‡åœ¨ä½ çš„Appä»£ç†æ–¹æ³•ä¸­ï¼Œç­‰ä¼šä¼šç”¨åˆ°ã€‚</p>

<p>application(_:handleEventsForBackgroundURLSession:)ä¼šå”¤é†’è¿™ä¸ªAppå¤„ç†å®Œæˆè¿™ä¸ªåå°ä»»åŠ¡ï¼Œä½ éœ€è¦å»å¤„ç†ä¸¤ä¸ªäº‹æƒ…ï¼š</p>

<ul>
<li>é¦–å…ˆï¼Œé€šè¿‡ä»£ç†æ–¹æ³•ç”¨è¿™ä¸ªAppå»é‡æ–°è¿æ¥è¿™ä¸ªåå°session,ä¸€æ—¦ä½ åˆ›å»ºå¹¶ä¸”æ¯æ¬¡ä½¿ç”¨åå°sessionæ—¶ï¼ŒSearchViewControllerå°±ä¼šè¢«å®ä¾‹åŒ–ï¼Œä½ å·²ç»é‡æ–°è¿æ¥äº†.</li>
<li>ç¬¬äºŒï¼Œä½ éœ€è¦å»æ•è·å®Œæˆçš„å›è°ƒæ–¹æ³•ï¼Œåœ¨å®Œæˆçš„å›è°ƒå‡½æ•°ä¸­ï¼Œæ›´æ–°ä½ çš„UI,ç„¶åå‘Šè¯‰ç³»ç»Ÿä½ çš„Appå·²ç»å·¥ä½œå®Œæ¯•ä½¿ç”¨åå°ä»»åŠ¡çš„session.</li>
</ul>


<p>ä½†æ˜¯ä»€ä¹ˆæ—¶å€™ä½ å°†ä¼šè°ƒç”¨å®Œæˆçš„å›è°ƒå‡½æ•°å‘¢ï¼Ÿ
<code>URLSessionDidFinishEventsForBackgroundURLSession(_:)</code>å°†ä¼šæ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œå®ƒæ˜¯NSURLSessionDelegateçš„ä¸€ä¸ªä»£ç†æ–¹æ³•ï¼Œå½“æ‰€æœ‰çš„ä»»åŠ¡åœ¨åå°sessionä¸­å®Œæˆçš„æ—¶å€™ã€‚</p>

<p>å®ç°ä¸‹é¢çš„æ‰©å±•åœ¨<code>SearchViewController.swift</code>ä¸­</p>

<pre><code>extension SearchViewController: NSURLSessionDelegate {

  func URLSessionDidFinishEventsForBackgroundURLSession(session: NSURLSession) {
    if let appDelegate = UIApplication.sharedApplication().delegate as? AppDelegate {
      if let completionHandler = appDelegate.backgroundSessionCompletionHandler {
        appDelegate.backgroundSessionCompletionHandler = nil
        dispatch_async(dispatch_get_main_queue(), {
          completionHandler()
        })
      }
    }
  }
}
</code></pre>

<p>ä¸Šé¢çš„ä»£ç ä»…ä»…æŠ“å–äº†åœ¨APPDelegateä¸­å­˜å‚¨çš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”åœ¨ä¸»çº¿ä¸­è°ƒç”¨å®ƒ.</p>

<p>ç¼–è¯‘è¿è¡Œä½ çš„å·¥ç¨‹ï¼Œå¼€å§‹å‡ ä¸ªä¸‹è½½ä¹‹åè¿…é€ŸæŒ‰åœ¨homeé”®ï¼Œä½¿å¾—ä¸‹è½½ä»»åŠ¡è¿›å…¥åå°ï¼Œç­‰å‡ åç§’ä½ çš„ä¸‹è½½ä»»åŠ¡å°†ä¼šå®Œæˆï¼Œç„¶ååŒå‡»home,å…³é—­å½“å‰ç¨‹åºã€‚</p>

<p>ä¸‹è½½ä»»åŠ¡å°†ä¼šå®Œæˆå¹¶ä¸”ä»–ä»¬å°†ä¼šæ›´æ–°æ˜¾ç¤ºçŠ¶æ€ã€‚</p>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/Simulator-Screen-Shot-19-Aug-2015-1.06.24-am-281x500.png" alt="logo" /></p>

<p>OKï¼Œè¿™ä¸ªdemoå·²ç»å®Œå¤‡äº†ã€‚</p>

<h2>å®Œæ•´å·¥ç¨‹ä¸‹è½½</h2>

<p>ä½ å¯ä»¥ä¸‹è½½å®Œæ•´çš„å·¥ç¨‹ä» <a href="http://www.raywenderlich.com/wp-content/uploads/2016/01/HalfTunes-Final.zip">è¿™é‡Œ</a></p>

<p>æ›´å¤šèµ„æº</p>

<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSession_class/">è‹¹æœçš„å®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="https://github.com/Alamofire/Alamofire">AlamoFire</a>æ˜¯Swiftä¸­éå¸¸æµè¡Œçš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œå¯ä»¥å­¦ä¹ ä¸€ä¸‹.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[NSOperationQueueç®€å•ä»‹ç»]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/26/nsoperationqueuejian-dan-jie-shao/"/>
    <updated>2016-03-26T08:11:55+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/26/nsoperationqueuejian-dan-jie-shao</id>
    <content type="html"><![CDATA[<p>åœ¨iOSä¸­æœ‰ä¸¤ç§æ–¹å¼æ¥å®ç°å¤šçº¿ç¨‹:NSOperationå’ŒGCD.
å…¶ä¸­GCDæ˜¯åŸºäºCçš„åº•å±‚çš„API,è€ŒNSOperationåˆ™æ˜¯GCDå®ç°çš„Object-cçš„API,éšè®©NSOPerationæ˜¯åŸºäºGCDå®ç°çš„ï¼Œä½†æ˜¯å¹¶ä¸æ„å‘³ç€å®ƒæ˜¯ä¸€ä¸ªGCDçš„é‡å¤ç‰ˆæœ¬ï¼Œç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨NSOperationè½»æ˜“çš„å®ç°ä¸€äº›GCDè¦å†™å¤§é‡ä»£ç çš„äº‹æƒ…ï¼Œå› æ­¤ï¼ŒNSOperationæ˜¯è¢«æ¨èä½¿ç”¨çš„.</p>

<!--more-->


<h2>ä¸ºä»€ä¹ˆä¼˜å…ˆä½¿ç”¨NSOperationQuere,è€Œä¸æ˜¯GCD</h2>

<p>ä½ å¯èƒ½å†™è¿‡è¿™æ ·çš„ç½‘ç»œè¯·æ±‚çš„ä»£ç :</p>

<pre><code>dispatch_async(_Queue, ^{  
    //è¯·æ±‚æ•°æ® 
    NSData *data = [NSData dataWithContentURL:[NSURL URLWithString:@"http://domain.com/a.png"]]; 
    dispatch_async(dispatch_get_main_queue(), ^{ 
        [self refreshViews:data];
     });
});
</code></pre>

<p>è¿™æ®µä»£ç æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºç‚¹ï¼Œå°±æ˜¯<em>è¿™ä¸ªä»»åŠ¡æ˜¯æ— æ³•å–æ¶ˆçš„</em></p>

<p><code>dataWithContentURL:</code>æ˜¯åŒæ­¥æ‹‰å–æ•°æ®ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡ä¸»çº¿ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰çš„æ•°æ®è¿”å›ä¹‹åï¼›è¿™ä¸ªæœŸé—´ï¼Œå¹¶å‘é˜Ÿåˆ—å°±éœ€è¦ä¸ºå…¶å®ƒä»»åŠ¡æ–°å»ºçº¿ç¨‹ï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™é—®é¢˜ã€‚å› æ­¤æˆ‘ä»¬ä¸æ¨èè¿™ç§å†™æ³•æ¥ä»ç½‘ç»œä¸Šæ‹‰å–æ•°æ®ã€‚</p>

<p>æ“ä½œé˜Ÿåˆ—æ˜¯æœ‰GCDæä¾›çš„ä¸€ä¸ªé˜Ÿåˆ—æ¨¡å‹çš„Cocoå¯¹è±¡ï¼ŒGCDæä¾›äº†æ›´åŠ åº•å±‚çš„æ§åˆ¶ï¼Œè€Œæ“ä½œé˜Ÿåˆ—åˆ™åœ¨GCDä¹‹ä¸Šå®ç°äº†æ›´åŠ æ–¹ä¾¿çš„åŠŸèƒ½ã€‚NSOperationç›¸å¯¹GCDæ¥è¯´æœ‰ä»¥ä¸‹ä¼˜ç‚¹:</p>

<ul>
<li>æä¾›äº†GCDä¸­ä¸é‚£ä¹ˆå®¹æ˜“å¤åˆ¶çš„æœ‰ç”¨ç‰¹æ€§</li>
<li>å¯ä»¥å¾ˆæ–¹ä¾¿çš„å–æ¶ˆä¸€ä¸ªNSOperationçš„æ‰§è¡Œ</li>
<li>å¯ä»¥å®¹æ˜“çš„æ·»åŠ ä»»åŠ¡çš„ä¾èµ–å…³ç³»</li>
<li>æä¾›äº†ä»»åŠ¡çš„çŠ¶æ€:isExecting,isFinished
*</li>
</ul>


<h2>NSOperationQueue</h2>

<p>NSOperationQueueå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹é˜Ÿåˆ—ï¼Œå¯ä»¥å§ <code>NSOperation</code>åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¯ä»¥å–æ¶ˆæˆ–è€…æ‰§è¡Œå®Œé˜Ÿåˆ—ä¸­æ‰€æœ‰çš„ <code>NSOperation</code>,æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>maxConcurrentOperationCount</code>å±æ€§æ¥æ§åˆ¶å¹¶å‘ä»»åŠ¡çš„æ•°é‡ï¼Œå½“è®¾ç½®ä¸º1æ—¶ï¼Œå°±æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚</p>

<h2>NSOperation</h2>

<p>å®ƒæ˜¯åˆ›å»ºçº¿ç¨‹çš„å¯¹è±¡ï¼Œç³»ç»Ÿå·²ç»é»˜è®¤æä¾›äº†<code>NSBlockOperaton</code>å’Œ<code>NSInvocationOperation</code>.ä½ ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„å­ç±»ï¼Œé€šè¿‡é‡å†™
<code>main</code>æˆ–è€…<code>start</code>æ–¹æ³•æ¥è‡ªå®šä¹‰nsoperation</p>

<p>ä½¿ç”¨<code>main</code>æ–¹æ³•éå¸¸ç®€å•ï¼Œä¸éœ€è¦ç®¡ç†ä¸€äº›çŠ¶æ€å±æ€§,å½“mainæ–¹æ³•è¿”å›çš„æ—¶å€™ï¼Œè¿™ä¸ªoperationå°±æ‰§è¡Œç»“æŸäº†ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨æ¥æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ã€‚</p>

<p>å¦‚æœä½ å¸Œæœ›æ‹¥æœ‰æ›´å¤šçš„æ§åˆ¶æƒï¼Œæˆ–è€…æƒ³åœ¨ä¸€ä¸ªæ“ä½œä¸­å¯ä»¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆé‡å†™<code>start</code>æ–¹æ³•ï¼Œä½†æ˜¯æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¿…é¡»æ‰‹åŠ¨çš„ç®¡ç†æ“ä½œçš„çŠ¶æ€ï¼Œåªæœ‰å‘é€isFinishedçš„KVOæ¶ˆæ¯æ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯operaitonç»“æŸã€‚</p>

<pre><code>
@implementation YourOperation
- (void)start
{
    self.isExecuting = YES;
    // ä»»åŠ¡ä»£ç  ...
}
- (void)finish //å¼‚æ­¥å›è°ƒ
{
    self.isExecuting = NO;
    self.isFinished = YES;
}
@end
</code></pre>

<p><em>å½“å®ç°äº†<code>start</code>æ–¹æ³•æ—¶ï¼Œé»˜è®¤å°±ä¼šæ‰§è¡Œstartæ–¹æ³•ï¼Œè€Œä¸æ‰§è¡Œmainæ–¹æ³•</em>ï¼Œä¸ºäº†è®©æ“ä½œé˜Ÿåˆ—æ•è·åˆ°åšçš„æ”¹å˜ï¼Œéœ€è¦å°†çŠ¶æ€çš„å±æ€§é…åˆKVOçš„æ–¹å¼å®ç°ï¼Œå¦‚æœä½ ä¸ä½¿ç”¨å®ƒä»¬é»˜è®¤çš„setteæ¥è¿›è¡Œè®¾ç½®çš„è¯ï¼Œå°±éœ€è¦åœ¨åˆé€‚çš„æ—¶å€™æ‰‹åŠ¨å‘é€KVOæ¶ˆæ¯ã€‚</p>

<p>éœ€è¦æ‰‹åŠ¨ç®¡ç†çš„çŠ¶æ€æœ‰:</p>

<ol>
<li>isExecuting  ä»£è¡¨ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­</li>
<li>isFinished   ä»£è¡¨ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæˆ</li>
<li>isCanceled  ä»£è¡¨ä»»åŠ¡å·²ç»å–æ¶ˆ</li>
</ol>


<p>æ‰‹åŠ¨å‘é€KVoæ¶ˆæ¯ï¼Œé€šçŸ¥çŠ¶æ€:</p>

<pre><code>[self willChangeValueForKey:@"isCancelled"];
_isCancelled = YES;
[self didChangeValueForKey:@"isCancelled"];
</code></pre>

<p>ä¸ºäº†èƒ½ä½¿ç”¨é˜Ÿåˆ—æ‰€æä¾›çš„å–æ¶ˆåŠŸèƒ½ï¼Œä½ éœ€è¦åœ¨é•¿æ—¶é—´æ“ä½œä¸­ä¸æ—¶åœ°æ£€æŸ¥isCanceledå±æ€§ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªé•¿çš„å¾ªç¯ä¸­:</p>

<pre><code>- (void)main
{
    while (notDone &amp;&amp; !self.isCancelled) {
        // ä»»åŠ¡å¤„ç†
    }
}
@end
</code></pre>

<h2>ç®€å•ä½¿ç”¨</h2>

<p>NSOperaitonå’ŒNSOperationQueueå®ç°å¤šçº¿ç¨‹çš„æ­¥éª¤:</p>

<ol>
<li>å…ˆå°†éœ€è¦æ‰§è¡Œçš„æ“ä½œå°è£…åˆ°ä¸€ä¸ªNSOperationå¯¹è±¡ä¸­</li>
<li>ç„¶åå°†NSOperationå¯¹è±¡æ·»åŠ åˆ°NSOperationQueueä¸­</li>
<li>ç³»ç»Ÿä¼šè‡ªåŠ¨å°†NSOperationQueueä¸­çš„NSOperationå–å‡ºæ¥</li>
<li>å°†å–å‡ºçš„NSOperationå°è£…æ”¾åˆ°ä¸€æ¡æ–°çº¿ç¨‹ä¸­æ‰§è¡Œ</li>
</ol>


<p>NSOperationæ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œå¹¶ä¸å…·å¤‡å°è£…æ“ä½œçš„èƒ½åŠ›ï¼Œå¿…é¡»å®ç°å®ƒçš„å­ç±»ã€‚</p>

<h3>NSInvocationOperationå­ç±»</h3>

<pre><code>//åˆ›å»ºæ“ä½œå¯¹è±¡ï¼Œå°è£…è¦æ‰§è¡Œçš„ä»»åŠ¡
//NSInvocationOperation   å°è£…æ“ä½œ
    NSInvocationOperation *operation=[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(test) object:nil];

    //æ‰§è¡Œæ“ä½œ
    [operation start];
</code></pre>

<p>ä¸€æ—¦æ‰§è¡Œæ“ä½œï¼Œå°±ä¼šè°ƒç”¨targetçš„testæ–¹æ³•</p>

<p>æ“ä½œå¯¹è±¡é»˜è®¤åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œåªæœ‰æ·»åŠ åˆ°åˆ—é˜Ÿä¸­æ‰ä¼šå¼€å¯æ–°çš„çº¿ç¨‹ï¼Œå³é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ“ä½œæ²¡æœ‰æ”¾åˆ°é˜Ÿåˆ—queueä¸­ï¼Œéƒ½æ˜¯åŒæ­¥æ‰§è¡Œï¼Œåªæœ‰å°†NSoperationæ”¾åˆ°ä¸€ä¸ªNSOperationQueueä¸­ï¼Œæ‰ä¼šå¼‚æ­¥æ‰§è¡Œ.</p>

<h2>NSBlockOoperaiton</h2>

<p>åˆ›å»ºå¯¹è±¡å’Œæ·»åŠ æ“ä½œ:</p>

<pre><code>//åˆ›å»ºNSBlockOperationæ“ä½œå¯¹è±¡
    NSBlockOperation *operation=[NSBlockOperation blockOperationWithBlock:^{
        //......
    }];

    //æ·»åŠ æ“ä½œ
    [operation addExecutionBlock:^{
        //....
    }];
</code></pre>

<pre><code>//åˆ›å»ºNSBlockOperationæ“ä½œå¯¹è±¡
     NSBlockOperation *operation=[NSBlockOperation blockOperationWithBlock:^{
        NSLog(@"NSBlockOperation------%@",[NSThread currentThread]);
     }];

     //æ·»åŠ æ“ä½œ
     [operation addExecutionBlock:^{
        NSLog(@"NSBlockOperation1------%@",[NSThread currentThread]);
     }];

     [operation addExecutionBlock:^{
         NSLog(@"NSBlockOperation2------%@",[NSThread currentThread]);
     }];

     //å¼€å¯æ‰§è¡Œæ“ä½œ
    [operation start];
</code></pre>

<p>åªè¦NSBlockOperationå°è£…çš„æ“ä½œæ•°>1ï¼Œå°±ä¼šå¼‚æ­¥æ“ä½œã€‚</p>

<h2>NSOperationQueue</h2>

<p>NSOperationQueueå¯ä»¥è°ƒç”¨startæ–¹æ³•æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä½†é»˜è®¤æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚
å¦‚æœå°†NSOperationæ·»åŠ åˆ°NSOperationQueueä¸­ï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨å¼‚æ­¥æ‰§è¡ŒNSOPerationä¸­çš„æ“ä½œã€‚</p>

<pre><code>
#import "YYViewController.h"

@interface YYViewController ()

@end

@implementation YYViewController

- (void)viewDidLoad
{
    [super viewDidLoad];

    //åˆ›å»ºNSInvocationOperationå¯¹è±¡ï¼Œå°è£…æ“ä½œ
    NSInvocationOperation *operation1=[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(test1) object:nil];
    NSInvocationOperation *operation2=[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(test2) object:nil];
    //åˆ›å»ºå¯¹è±¡ï¼Œå°è£…æ“ä½œ
    NSBlockOperation *operation3=[NSBlockOperation blockOperationWithBlock:^{
        NSLog(@"NSBlockOperation3--1----%@",[NSThread currentThread]);
    }];
    [operation3 addExecutionBlock:^{
        NSLog(@"NSBlockOperation3--2----%@",[NSThread currentThread]);
    }];

    //åˆ›å»ºNSOperationQueue
    NSOperationQueue * queue=[[NSOperationQueue alloc]init];
    //æŠŠæ“ä½œæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
    [queue addOperation:operation1];
    [queue addOperation:operation2];
    [queue addOperation:operation3];
}

-(void)test1
{
    NSLog(@"NSInvocationOperation--test1--%@",[NSThread currentThread]);
}

-(void)test2
{
    NSLog(@"NSInvocationOperation--test2--%@",[NSThread currentThread]);
}

@end
</code></pre>

<p>ç³»ç»Ÿè‡ªåŠ¨å°†NSOperationqueueä¸­çš„NSOPerationå¯¹è±¡å–å‡ºï¼Œå°†å…¶å°è£…çš„æ“ä½œæ”¾åˆ°ä¸€æ¡æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œ
ä¸Šé¢çš„ä»£ç ä¸€å…±æœ‰4ä¸ªä»»åŠ¡ï¼Œoperation1å’Œoperation2åˆ†åˆ«æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œoperation3æœ‰ä¸¤ä¸ªä»»åŠ¡ï¼Œä¸€å…±4ä¸ªä»»åŠ¡ï¼Œå¼€å¯äº†4æ¡çº¿ç¨‹ã€‚</p>

<p>è¿™äº›ä»»åŠ¡æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚</p>

<blockquote><p><strong>æç¤º</strong>
é˜Ÿåˆ—çš„å–å‡ºæ—¶æœ‰é¡ºåºçš„ï¼Œä¸æ‰“å°ç»“æœå¹¶ä¸çŸ›ç›¾ï¼Œè¿™å°±å¥½æ¯”èµ›è·‘ï¼Œèµ·è·‘çš„é¡ºåºæ˜¯A,B,Cï¼Œä½†æ˜¯åˆ°è¾¾ç»ˆç‚¹çš„é¡ºåºå°±ä¸ä¸€æ ·æ˜¯ A B  Cäº†ã€‚</p></blockquote>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å­¦ä¹ CAShapeLayer]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/04/xue-xi-cashapelayer/"/>
    <updated>2016-03-04T14:20:24+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/04/xue-xi-cashapelayer</id>
    <content type="html"><![CDATA[<h2>å‰è¨€</h2>

<p>CAShapeLayerç»§æ‰¿è‡ªCALayer,å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨CaLayerçš„æ‰€æœ‰å±æ€§ã€‚ä½†æ˜¯ï¼ŒCAShapeLayeréœ€è¦å’Œè´å¡å°”æ›²çº¿é…åˆä½¿ç”¨æ‰æœ‰æ„ä¹‰.</p>

<p>CAShapeLayeræ˜¯åœ¨å…¶åæ ‡ç³»ç»Ÿå†…ç»˜åˆ¶è´å¡å°”æ›²çº¿çš„ã€‚å› æ­¤ä½¿ç”¨CAShapeLayeréœ€è¦ä¸ <code>UIbezierPath</code>ä¸€èµ·ä½¿ç”¨ã€‚</p>

<p>å®ƒæœ‰ä¸€ä¸ª <code>path</code>å±æ€§ï¼Œè€Œ<code>UIBezierPath</code>å°±æ˜¯å¯¹ <code>CGPathRef</code>ç±»å‹çš„å°è£…ï¼Œå› æ­¤è¿™ä¸¤è€…æ˜¯ç»é…</p>

<!--more-->


<h2>CASHapeLayerå’ŒdrawRectçš„æ¯”è¾ƒ</h2>

<ol>
<li>drawRect : å±äºCoreGraphicsæ¡†æ¶ï¼Œå ç”¨cpu,æ€§èƒ½æ¶ˆè€—å¤§</li>
<li>CAShapeLayer:å±äºCoreAnimationæ¡†æ¶ï¼Œé€šè¿‡GPUæ¥æ¸²æŸ“å›¾å½¢ï¼ŒèŠ‚çœæ€§èƒ½ã€‚åŠ¨ç”»æ¸²æŸ“ç›´æ¥æäº¤ç»™æ‰‹æœºçš„GPU,ä¸æ¶ˆè€—å†…å­˜ã€‚</li>
</ol>


<p>è¿™ä¸¤è€…å„æœ‰å„çš„ç”¨é€”ï¼Œè€Œä¸æ˜¯è¯´æœ‰ä¸ªCAShapeLayerå°±ä¸éœ€è¦drawRectäº†ã€‚</p>

<h2>CAShapeLayeræœˆUIBezierPathçš„å…³ç³»</h2>

<ol>
<li>CAShapeLayerä¸­çš„shapeä»£è¡¨å½¢çŠ¶çš„æ„æ€ï¼Œæ‰€ä»¥éœ€è¦å½¢çŠ¶æ‰èƒ½ç”Ÿæ•ˆ</li>
<li>è´å¡å°”æ›²çº¿å¯ä»¥åˆ›å»ºçŸ¢é‡çš„è·¯å¾„ï¼Œè€Œ<code>UIBezierPath</code>ç±»æ˜¯å¯¹ <code>CGPathRef</code>çš„å°è£…</li>
<li>è´å¡å°”æ›²çº¿ç»™ <code>CAShapeLayer</code>æä¾›è·¯å¾„ï¼ŒCAShapelayeråœ¨æä¾›çš„è·¯å¾„ä¸­è¿›è¡Œæ¸²æŸ“ã€‚è·¯å¾„ä¼šé—­ç¯ï¼Œæ‰€ä»¥ç»˜åˆ¶å‡ºäº† <code>Shape</code></li>
<li>ç”¨äº<code>CAShapeLayer</code>çš„è´å¡å°”æ›²çº¿ä½œä¸ºpath,å…¶pathæ˜¯ä¸€ä¸ªé¦–å°¾ç›¸æ¥çš„é—­ç¯çš„æ›²çº¿ï¼Œå³ä½¿è¯¥è´å¡å°”æ›²çº¿ä¸æ˜¯ä¸€ä¸ªé—­ç¯çš„æ›²çº¿ã€‚</li>
</ol>


<h2>CAShapeLayerä¸UIBezierPathç”»åœ†</h2>

<p><img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160304-2.png" alt="logo" /></p>

<p>ä»£ç :</p>

<pre><code>-(CAShapeLayer*)drawCircle{
    CAShapeLayer *circleLayer=[CAShapeLayer layer];

    circleLayer.frame=CGRectMake(100, 10, 200, 200);
    //è®¾ç½®å±…ä¸­æ˜¾ç¤º
   // circleLayer.position=self.view.center;
    //è®¾ç½®å¡«å……é¢œè‰²
    circleLayer.fillColor=[UIColor clearColor].CGColor;
    //è®¾ç½®çº¿å®½
    circleLayer.lineWidth=2;
    //è®¾ç½®çº¿çš„é¢œè‰²
    circleLayer.strokeColor=[UIColor redColor].CGColor;

    //ä½¿ç”¨UIBezierPathåˆ›å»ºè·¯å¾„
    CGRect frame=CGRectMake(0, 0, 200, 200);
    UIBezierPath *circlePath=[UIBezierPath bezierPathWithOvalInRect:frame];
    //è®¾ç½®CAShapeLayerä¸UIBezierPathå…³è”
    circleLayer.path=circlePath.CGPath;

    [self.view.layer addSublayer:circleLayer];

    return circleLayer;

}
</code></pre>

<p>æ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œä¸æ˜¯æ”¾åœ¨-drawRect:æ–¹æ³•ä¸­è°ƒç”¨çš„ã€‚æˆ‘ä»¬ç›´æ¥å°†è¿™ä¸ªCAShapeLayeræ”¾åˆ°self.view.layerä¸Šï¼Œç›´æ¥å‘ˆç°å‡ºæ¥ã€‚</p>

<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>CAShapeLayer</code>ï¼Œç„¶åé…ç½®ç›¸å…³å±æ€§ï¼Œç„¶åå†é€šè¿‡ <code>UIBezierPath</code>çš„ç±»æ–¹æ³•åˆ›å»ºä¸€ä¸ªå†…åˆ‡åœ†è·¯å¾„ï¼Œç„¶åå°†è·¯å¾„æŒ‡å®šç»™<code>CAShapeLayer.path</code>,è¿™å°±å°†ä¸¤è€…å…³è”èµ·æ¥äº†ï¼Œæœ€åï¼Œå°†è¿™ä¸ªå±‚æ”¾åˆ°äº†self.view.layerä¸Šå‘ˆç°å‡ºæ¥ã€‚</p>

<h2>CAShapeLayerä¸UIBezierPathçš„ç®€å•Loadingæ•ˆæœ</h2>

<p>ä»£ç :</p>

<pre><code>- (void)drawHalfCircle {
  self.loadingLayer = [self drawCircle];

  // è¿™ä¸ªæ˜¯ç”¨äºæŒ‡å®šç”»ç¬”çš„å¼€å§‹ä¸ç»“æŸç‚¹
  self.loadingLayer.strokeStart = 0.0;
  self.loadingLayer.strokeEnd = 0.75;

  self.timer = [NSTimer scheduledTimerWithTimeInterval:0.1
                                                target:self
                                              selector:@selector(updateCircle)
                                              userInfo:nil
                                               repeats:YES];
}

- (void)updateCircle {
  if (self.loadingLayer.strokeEnd &gt; 1 &amp;&amp; self.loadingLayer.strokeStart &lt; 1) {
    self.loadingLayer.strokeStart += 0.1;
  } else if (self.loadingLayer.strokeStart == 0) {
    self.loadingLayer.strokeEnd += 0.1;
  }

  if (self.loadingLayer.strokeEnd == 0) {
    self.loadingLayer.strokeStart = 0;
  }

  if (self.loadingLayer.strokeStart &gt;= 1 &amp;&amp; self.loadingLayer.strokeEnd &gt;= 1) {
    self.loadingLayer.strokeStart = 0;
    [self.timer invalidate];
    self.timer = nil;
  }
}
</code></pre>

<p>æˆ‘ä»¬è¦å®ç°è¿™ä¸ªæ•ˆæœï¼Œæ˜¯é€šè¿‡ <code>stokeStart</code>å’Œ<code>stokeEnd</code>è¿™ä¸¤ä¸ªå±æ€§å¥½å®ç°çš„ï¼Œè¿™ä¸¤ä¸ªçš„å–å€¼èŒƒå›´æ˜¯[0-1],å½“stokeStartçš„å€¼æ…¢æ…¢å˜æˆ1æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°è·¯å¾„æ˜¯æ…¢æ…¢æ¶ˆå¤±çš„ã€‚è¿™é‡Œå®ç°çš„æ•ˆæœå¹¶ä¸å¥½ï¼Œå› ä¸ºä¸èƒ½ä¸€ç›´å¾ªç¯ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iosçš„Blockå¾ªç¯å¼•ç”¨]]></title>
    <link href="http://andrew-anlu.github.io/blog/2016/03/04/iosde-blockxun-huan-yin-yong/"/>
    <updated>2016-03-04T13:22:36+08:00</updated>
    <id>http://andrew-anlu.github.io/blog/2016/03/04/iosde-blockxun-huan-yin-yong</id>
    <content type="html"><![CDATA[<p>iosåœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå®¹æ˜“å¼•å‘å†…å­˜æ³„éœ²é—®é¢˜ã€‚ä¹Ÿå¾ˆå®¹æ˜“é€ æˆå¾ªç¯å¼•ç”¨ï¼Œä¹‹å‰ä½¿ç”¨blockçš„æ—¶å€™ä¹Ÿæ²¡æœ‰è¿‡å¤šæ³¨æ„ï¼Œå…¶å®å‘å¾ˆå¤šã€‚
å¯¹äºæ–°æ‰‹æ¥è¯´ï¼Œå‡ºç°å¾ªç¯å¼•ç”¨çš„æ—¶å€™ï¼Œå¾ˆéš¾å»æ’æŸ¥ã€‚</p>

<!--more-->


<h2>Controllerä¹‹é—´çš„blockå¾ªç¯å¼•ç”¨</h2>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å£°æ˜ä¸¤ä¸ªç±»ï¼Œä¸€ä¸ªæ˜¯ViewController,å¦ä¸€ä¸ªæ˜¯TLController,åœ¨ViewControllerä¸­æœ‰ä¸ªæŒ‰é’®ï¼Œç‚¹å‡» pushåˆ°TlControllerä¸­ã€‚
å…ˆçœ‹TLControllerä¸­ç±»çš„å£°æ˜ï¼š</p>

<pre><code>typedef void(^CallbackBlock)();

@interface TLController : UIViewController
- (instancetype)initWithCallback:(CallbackBlock)callback;

@property (nonatomic, copy) CallbackBlock callbackBlock;
</code></pre>

<p>TlController.m</p>

<pre><code>- (instancetype)initWithCallback:(CallbackBlock)callback{
    self=[super init];
    if(self){
        _callbackBlock=callback;
    }
    return self;
}
</code></pre>

<p>ä¸ºäº†éªŒè¯è¯¥ç±»æ˜¯ä¸æ˜¯è¢«é‡Šæ”¾æ‰äº†ï¼Œæˆ‘ä»¬é‡å†™ä¸¤ä¸ªæ–¹æ³•æ¥æ£€æµ‹:</p>

<pre><code>-(void)viewDidAppear:(BOOL)animated{
    [super viewDidAppear:animated];
    NSLog(@"è¿›å…¥æ§åˆ¶å™¨ï¼š%@", [[self class] description]);
}
- (void)dealloc {
    NSLog(@"æ§åˆ¶å™¨è¢«dealloc: %@", [[self class] description]);
}
</code></pre>

<p>åœ¨ ViewControllerä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæŒ‰é’®ï¼ŒæŒ‰é’®çš„å•å‡»äº‹ä»¶å¦‚ä¸‹:</p>

<pre><code>// ç‚¹å‡»buttonæ—¶
- (void)goToNext {
    //__weak __typeof(self) weakSelf=self;

    TLController *vc = [[TLController alloc] initWithCallback:^{
        [self.button setTitleColor:[UIColor greenColor] forState:UIControlStateNormal];
    }];
    self.vc = vc;
    [self.navigationController pushViewController:vc animated:YES];
}
</code></pre>

<p>ç°åœ¨çœ‹Viewcontrollerï¼Œè¿™é‡Œå°±å½¢æˆäº†ä¸¤ä¸ªå¾ªç¯ï¼Œå› æ­¤vcå±æ€§å¾—ä¸åˆ°é‡Šæ”¾ï¼Œå¦‚å›¾:
<img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160304-0.png" alt="logo" /></p>

<p>è¿™é‡Œå½¢æˆäº†ä¸¤ä¸ªå¾ªç¯</p>

<ol>
<li><p>ViewContrller->å¼ºå¼•ç”¨äº†vc->å¼ºå¼•ç”¨äº†callback->å¼ºå¼•ç”¨äº†Viewcontroller</p></li>
<li><p>Viewcontroler->å¼ºå¼•ç”¨äº†å±æ€§vc->å¼ºå¼•ç”¨äº†callback->å¼ºå¼•ç”¨äº†Viewcontrollerçš„å±æ€§button</p></li>
</ol>


<p>æˆ‘ä»¬è¦è§£å†³è¿™ä¸¤ä¸ªå¾ªç¯å¼•ç”¨ï¼Œå¯ä»¥å¦‚ä¸‹æ“ä½œ:</p>

<p>ä¸å£°æ˜vcå±æ€§ï¼Œæˆ–è€…å°†vcå±æ€§å£°æ˜ä¸ºweakå¼±å¼•ç”¨ç±»å‹ï¼Œåœ¨callbackå›è°ƒå¤„ï¼Œå°†self.buttonæ”¹ä¸º weakSelf.button,ä¹Ÿå°±æ˜¯è®©callbackçš„è¿™ä¸ªblockå¯¹viewcontrollerå¼±å¼•ç”¨ï¼Œè¿™æ ·å†…å­˜å°±å¯ä»¥é¡ºåˆ©é‡Šæ”¾äº†ã€‚</p>

<pre><code>// ç‚¹å‡»buttonæ—¶
- (void)goToNext {
    __weak __typeof(self) weakSelf=self;

    TLController *vc = [[TLController alloc] initWithCallback:^{
        [weakSelf.button setTitleColor:[UIColor greenColor] forState:UIControlStateNormal];
    }];
   // self.vc = vc;
    [self.navigationController pushViewController:vc animated:YES];
}
</code></pre>

<h2>Controllerå’ŒViewä¹‹é—´çš„blockå¼•ç”¨</h2>

<p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªview,ç”¨äºå’ŒContrlleräº¤äº’ï¼Œå½“ç‚¹å‡»viewä¸Šçš„æŒ‰é’®æ—¶ï¼Œå°±æŠŠç»“æœå›è°ƒç»™controller;</p>

<p>TLViewå®šä¹‰å¦‚ä¸‹:
TlView.h</p>

<pre><code>typedef void(^FeedbackBlock)(id model);
@interface TLView : UIView
@property (nonatomic, copy) FeedbackBlock block;
- (instancetype)initWithBlock:(FeedbackBlock)block;
@end
</code></pre>

<p>TlView.m</p>

<pre><code>-(instancetype)initWithBlock:(FeedbackBlock)block{
    self=[super init];
    if(self){
        self.block=block;
        UIButton *button = [UIButton buttonWithType:UIButtonTypeCustom];
        [button setTitle:@"åé¦ˆç»™controller" forState:UIControlStateNormal];
        button.frame = CGRectMake(50, 200, 200, 45);
        button.backgroundColor = [UIColor redColor];
        [button setTitleColor:[UIColor yellowColor] forState:UIControlStateNormal];
        [button addTarget:self action:@selector(feedback) forControlEvents:UIControlEventTouchUpInside];
        [self addSubview:button];
    }
    return self;
}


- (void)feedback {
    if (self.block) {
        // ä¼ æ¨¡å‹å›å»ï¼Œè¿™é‡Œæ²¡æœ‰æ•°æ®ï¼Œå‡è®¾ä¼ nil
        self.block(nil);
    }
}

/*
// Only override drawRect: if you perform custom drawing.
// An empty implementation adversely affects performance during animation.
- (void)drawRect:(CGRect)rect {
    // Drawing code
}
*/

- (void)dealloc {
    NSLog(@"dealloc: %@", [[self class] description]);
}
</code></pre>

<p>æ¥ä¸‹æ¥ï¼Œåœ¨TlControllerä¸­å¢åŠ ä¸¤ä¸ªå±æ€§</p>

<pre><code>@property (nonatomic, strong) TLView *aView;
@property (nonatomic, strong) id currentModel;
</code></pre>

<p>  è°ƒç”¨å¦‚ä¸‹:</p>

<pre><code class="``">  -(void)testView{

   // __weak __typeof(self) weakSelf=self;

    self.aView = [[TLView alloc] initWithBlock:^(id model) {
        // å‡è®¾è¦æ›´æ–°model
        self.currentModel = model;
        //weakSelf.currentModel=model;
    }];
    // å‡è®¾å æ»¡å…¨å±
    self.aView.frame = self.view.bounds;
    [self.view addSubview:self.aView];
    self.aView.backgroundColor = [UIColor whiteColor];
}
</code></pre>

<p>  åœ¨viewDidLoadæ–¹æ³•ä¸­ï¼Œè°ƒç”¨<code>[self testView]</code></p>

<p>  è¿™æ ·Controllerå’Œviewä¹‹é—´å°±å½¢æˆäº†å¾ªç¯å¼•ç”¨ï¼Œå¦‚å›¾:
  <img src="http://7xkxhx.com1.z0.glb.clouddn.com/QQ20160304-1.png" alt="logo" /></p>

<ol>
<li>TlViewController->å¼ºå¼•ç”¨aView->block->tlViewcontrollerå±æ€§çš„currentModel</li>
</ol>


<p>  è§£å†³çš„åŠæ³•æ˜¯:åœ¨åˆ›å»ºaViewçš„æ—¶å€™ï¼Œblockå†…å¯¹currentModelçš„å¼•ç”¨æ”¹æˆå¼±å¼•ç”¨</p>

<pre><code class="``">  __weak __typeof(self) weakSelf=self;

    self.aView = [[TLView alloc] initWithBlock:^(id model) {
        // å‡è®¾è¦æ›´æ–°model
        weakSelf.currentModel=model;
    }];
</code></pre>

<p>  å¾ˆå¤šç¨‹åºå‘˜ç›´æ¥ä½¿ç”¨<em>currentModel,å…¶å®è¿™æ ·ä¹Ÿä¼šé€ æˆå¾ªç¯å¼•ç”¨ï¼Œå› ä¸º</em>currentModelä¹Ÿæ˜¯å±äºç±»çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿä¼šè¢«å¼ºå¼•ç”¨çš„ã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼Œä¹Ÿè¦æ”¹æˆå¼±å¼•ç”¨</p>

<pre><code class="``">  __block __weak __typeof(_currentModel) weakModel = _currentModel;
self.aView = [[TLView alloc] initWithBlock:^(id model) {
  // å‡è®¾è¦æ›´æ–°model
  weakModel = model;
}];
</code></pre>

<h2>æ¨¡æ‹Ÿå¾ªç¯å¼•ç”¨</h2>

<pre><code>@autoreleasepool {
  A *aVC = [[A alloc] init];
  B *bVC = [[B allcok] init];
  aVC.controller = bVC;
  bVC.controller = aVC;
}
</code></pre>

<p>aVC->å¼ºå¼•ç”¨äº†bVC</p>

<p>bVC->å¼ºå¼•ç”¨äº†aVC</p>

<p>å¦‚æœæ˜¯è¿™æ ·å¼•ç”¨ï¼Œå°±å½¢æˆç¯äº†ã€‚aVC->bVC->aVCï¼Œè¿™å°±å½¢æˆäº†ç¯ã€‚</p>

<h3>å¦‚æœä¸€ä¸ªControllerä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œæ˜¯å¦å¾ªç¯å¼•ç”¨å‘¢?</h3>

<p>åœ¨Viewcontrollerä¸­å£°æ˜ä¸€ä¸ªå˜é‡
<code>@property (nonatomic,strong)NSMutableArray *array;</code></p>

<pre><code>-(void)test1{
    self.array = [NSMutableArray arrayWithObjects:@"a",@"b",@"abc",nil];
    TLController *vc = [[TLController alloc] initWithCallback:^{
        [self.array removeObjectAtIndex:0];
    }];
    [self.navigationController pushViewController:vc animated:YES];
}
</code></pre>

<p>ç‚¹å‡»è·³è½¬æŒ‰é’®ï¼Œæ§åˆ¶å°æ‰“å°</p>

<pre><code>BlockDemo1[5511:1169090] è¿›å…¥æ§åˆ¶å™¨ï¼šTLController
2016-03-04 14:08:45.612 
</code></pre>

<p>ç‚¹å‡»å›é€€,æ§åˆ¶å°æ‰“å°</p>

<pre><code>BlockDemo1[5511:1169090] æ§åˆ¶å™¨è¢«dealloc: TLController
</code></pre>

<p>  è¯´æ˜æˆå‘˜å˜é‡NSMutableArrayä¸ä¼šå½¢æˆå¾ªç¯å¼•ç”¨ã€‚</p>
]]></content>
  </entry>
  
</feed>
